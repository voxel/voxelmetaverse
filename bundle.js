(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var artpacks,fuel,main;require("voxel-engine");require("voxel-registry");require("voxel-carry");require("voxel-bucket");require("voxel-fluid");require("voxel-recipes");require("voxel-webview");require("voxel-workbench");require("voxel-furnace");require("voxel-chest");require("voxel-inventory-hotbar");require("voxel-inventory-crafting");require("voxel-oculus");require("voxel-highlight");require("voxel-voila");require("voxel-player");require("voxel-health");require("voxel-health-bar");require("voxel-health-fall");require("voxel-food");require("voxel-sfx");require("voxel-fly");require("voxel-gamemode");require("voxel-walk");require("voxel-sprint");require("voxel-mine");require("voxel-harvest");require("voxel-use");require("voxel-reach");require("voxel-pickaxe");require("voxel-blockdata");require("voxel-daylight");require("voxel-land");require("voxel-clientmc");require("voxel-console");require("voxel-commands");require("voxel-drop");require("voxel-start");require("voxel-zen");require("voxel-debug");require("voxel-plugins-ui");require("kb-bindings-ui");artpacks=require("artpacks");fuel=require("voxel-fuel");main=function(){var loadingTime;console.log("voxpopuli starting");if(typeof window!=="undefined"&&window!==null&&window.performance&&window.performance.timing){loadingTime=Date.now()-window.performance.timing.navigationStart;console.log("User-perceived page loading time: "+loadingTime/1e3+"s")}return fuel({require:require,exposeGlobal:true,pluginOpts:{"voxel-engine":{appendDocument:true,exposeGlobal:true,texture_modules:[require("voxel-texture-shader"),require("voxel-texture")],lightsDisabled:true,arrayTypeSize:2,useAtlas:true,generateChunks:false,chunkDistance:2,materials:[],texturePath:"ArtPacks/ProgrammerArt/textures/blocks/",artPacks:artpacks(["ProgrammerArt-ResourcePack.zip"]),worldOrigin:[0,0,0],controls:{discreteFire:false,fireRate:100,jumpTimer:25},keybindings:{W:"forward",A:"left",S:"backward",D:"right","<up>":"forward","<left>":"left","<down>":"backward","<right>":"right","<mouse 1>":"fire","<mouse 3>":"firealt","<space>":"jump","<shift>":"crouch","<control>":"alt","<tab>":"sprint",R:"pov",Y:"vr",O:"home",E:"inventory",C:"gamemode",T:"console","/":"console2",".":"console3",F1:"zen"}},"voxel-registry":{},"voxel-recipes":{},"voxel-webview":{onDemand:true},"voxel-carry":{inventoryWidth:10,inventoryRows:5},"voxel-bucket":{fluids:["water","lava"]},"voxel-fluid":{},"voxel-blockdata":{},"voxel-chest":{},"voxel-workbench":{},"voxel-furnace":{},"voxel-pickaxe":{},"voxel-daylight":{ambientColor:8947848,directionalColor:16777215},"voxel-land":{populateTrees:true},"voxel-clientmc":{url:"ws://localhost:1234",onDemand:true},"voxel-console":{},"voxel-commands":{},"voxel-drop":{},"voxel-start":{},"voxel-zen":{},"voxel-oculus":{distortion:.2,separation:.5,onDemand:true},"voxel-player":{image:"player.png",homePosition:[2,14,4],homeRotation:[0,0,0]},"voxel-health":{},"voxel-health-bar":{},"voxel-health-fall":{},"voxel-food":{},"voxel-sfx":{},"voxel-fly":{flySpeed:.8,onDemand:true},"voxel-gamemode":{},"voxel-walk":{},"voxel-sprint":{},"voxel-inventory-hotbar":{inventorySize:10},"voxel-inventory-crafting":{},"voxel-reach":{reachDistance:8},"voxel-mine":{instaMine:false,progressTexturesPrefix:"destroy_stage_",progressTexturesCount:9},"voxel-use":{},"voxel-harvest":{},"voxel-highlight":{color:16711680,distance:8,adjacentActive:function(){return false}},"voxel-voila":{},"voxel-debug":{},"voxel-plugins-ui":{},"kb-bindings-ui":{}}})};main()},{artpacks:2,"kb-bindings-ui":24,"voxel-blockdata":26,"voxel-bucket":27,"voxel-carry":31,"voxel-chest":37,"voxel-clientmc":72,"voxel-commands":88,"voxel-console":95,"voxel-daylight":102,"voxel-debug":103,"voxel-drop":115,"voxel-engine":129,"voxel-fluid":177,"voxel-fly":178,"voxel-food":179,"voxel-fuel":180,"voxel-furnace":309,"voxel-gamemode":344,"voxel-harvest":353,"voxel-health":359,"voxel-health-bar":357,"voxel-health-fall":358,"voxel-highlight":361,"voxel-inventory-crafting":364,"voxel-inventory-hotbar":399,"voxel-land":409,"voxel-mine":420,"voxel-oculus":421,"voxel-pickaxe":422,"voxel-player":427,"voxel-plugins-ui":429,"voxel-reach":430,"voxel-recipes":435,"voxel-registry":442,"voxel-sfx":444,"voxel-sprint":454,"voxel-start":455,"voxel-texture":462,"voxel-texture-shader":456,"voxel-use":467,"voxel-voila":468,"voxel-walk":469,"voxel-webview":471,"voxel-workbench":472,"voxel-zen":504}],2:[function(require,module,exports){(function(){var ArtPackArchive,ArtPacks,Buffer,EventEmitter,ZIP,binaryXHR,fs,path,splitNamespace,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};ZIP=require("zip");path=require("path");fs=require("fs");binaryXHR=require("binary-xhr");EventEmitter=require("events").EventEmitter;Buffer=require("native-buffer-browserify").Buffer;ArtPacks=function(_super){__extends(ArtPacks,_super);function ArtPacks(packs){var pack,_i,_len;this.packs=[];this.pending={};this.blobURLs={};this.setMaxListeners(0);for(_i=0,_len=packs.length;_i<_len;_i++){pack=packs[_i];this.addPack(pack)}}ArtPacks.prototype.addPack=function(x,name){var pack,packIndex,rawZipArchiveData,url;if(name==null){name=void 0}if(x instanceof ArrayBuffer){rawZipArchiveData=x;this.packs.push(new ArtPackArchive(rawZipArchiveData,name!=null?name:"("+rawZipArchiveData.byteLength+" raw bytes)"));this.emit("loadedRaw",rawZipArchiveData);return this.emit("loadedAll")}else if(typeof x==="string"){url=x;if(typeof XMLHttpRequest==="undefined"||XMLHttpRequest===null){throw new Error("artpacks unsupported addPack url "+x+" without XMLHttpRequest")}this.pending[url]=true;packIndex=this.packs.length;this.packs[packIndex]=null;this.emit("loadingURL",url);return binaryXHR(url,function(_this){return function(err,packData){var e;if(_this.packs[packIndex]!==null){console.log("artpacks warning: index "+packIndex+" occupied, expected to be empty while loading "+url)}if(err||!packData){console.log("artpack failed to load #"+packIndex+" - "+url+": "+err);_this.emit("failedURL",url,err);delete _this.pending[url];return}try{_this.packs[packIndex]=new ArtPackArchive(packData,url)}catch(_error){e=_error;console.log("artpack failed to parse #"+packIndex+" - "+url+": "+e);_this.emit("failedURL",url,e)}delete _this.pending[url];console.log("artpacks loaded pack:",url);_this.emit("loadedURL",url);if(Object.keys(_this.pending).length===0){return _this.emit("loadedAll")}}}(this))}else{pack=x;this.emit("loadedPack",pack);this.emit("loadedAll");return this.packs.push(pack)}};ArtPacks.prototype.getTextureImage=function(name,onload,onerror){var img,load;img=new Image;load=function(_this){return function(){var url;url=_this.getTexture(name);if(url==null){return onerror("no such texture in artpacks: "+name,img)}img.src=url;img.onload=function(){return onload(img)};return img.onerror=function(err){return onerror(err,img)}}}(this);if(this.isQuiescent()){return load()}else{return this.on("loadedAll",load)}};ArtPacks.prototype.getTexture=function(name){return this.getURL(name,"textures")};ArtPacks.prototype.getSound=function(name){return this.getURL(name,"sounds")};ArtPacks.prototype.getURL=function(name,type){var blob,url;url=this.blobURLs[type+" "+name];if(url!=null){return url}blob=this.getBlob(name,type);if(blob==null){return void 0}url=URL.createObjectURL(blob);this.blobURLs[type+" "+name]=url;return url};ArtPacks.prototype.getBlob=function(name,type){var blob,pack,_i,_len,_ref;_ref=this.packs;for(_i=0,_len=_ref.length;_i<_len;_i++){pack=_ref[_i];if(!pack){continue}blob=pack.getBlob(name,type);if(blob!=null){return blob}}return void 0};ArtPacks.prototype.refresh=function(){var url,_i,_len,_ref;_ref=this.blobURLs;for(_i=0,_len=_ref.length;_i<_len;_i++){url=_ref[_i];URL.revokeObjectURL(url)}return this.blobURLs=[]};ArtPacks.prototype.clear=function(){this.packs=[];return this.refresh()};ArtPacks.prototype.getLoadedPacks=function(){var pack,ret,_i,_len,_ref;ret=[];_ref=this.packs;for(_i=0,_len=_ref.length;_i<_len;_i++){pack=_ref[_i];if(pack!=null){ret.push(pack)}}return ret};ArtPacks.prototype.isQuiescent=function(){return this.getLoadedPacks().length>0&&Object.keys(this.pending).length===0};return ArtPacks}(EventEmitter);splitNamespace=function(name){var a,namespace;a=name.split(":");if(a.length>1){namespace=a[0],name=a[1]}if(namespace==null){namespace="*"}return[namespace,name]};ArtPackArchive=function(){function ArtPackArchive(packData,name){this.name=name!=null?name:void 0;if(packData instanceof ArrayBuffer){packData=new Uint8Array(packData)}this.zip=new ZIP.Reader(packData);this.zipEntries={};this.zip.forEach(function(_this){return function(entry){return _this.zipEntries[entry.getName()]=entry}}(this));this.namespaces=this.scanNamespaces();this.namespaces.push("foo")}ArtPackArchive.prototype.toString=function(){var _ref;return(_ref=this.name)!=null?_ref:"ArtPack"};ArtPackArchive.prototype.scanNamespaces=function(){var namespaces,parts,zipEntryName,_i,_len,_ref;namespaces={};_ref=Object.keys(this.zipEntries);for(_i=0,_len=_ref.length;_i<_len;_i++){zipEntryName=_ref[_i];parts=zipEntryName.split(path.sep);if(parts.length<2){continue}if(parts[0]!=="assets"){continue}if(parts[1].length===0){continue}namespaces[parts[1]]=true}return Object.keys(namespaces)};ArtPackArchive.prototype.nameToPath={textures:function(fullname){var a,basename,category,namespace,partname,pathRP,_ref,_ref1;a=fullname.split("/");if(a.length>1){category=a[0],partname=a[1]}category=(_ref={undefined:"blocks",i:"items"}[category])!=null?_ref:category;if(partname==null){partname=fullname}_ref1=splitNamespace(partname),namespace=_ref1[0],basename=_ref1[1];pathRP="assets/"+namespace+"/textures/"+category+"/"+basename+".png";console.log("artpacks texture:",fullname,[category,namespace,basename]);return pathRP},sounds:function(fullname){var name,namespace,pathRP,_ref;_ref=splitNamespace(fullname),namespace=_ref[0],name=_ref[1];return pathRP="assets/"+namespace+"/sounds/"+name+".ogg"}};ArtPackArchive.prototype.mimeTypes={textures:"image/png",sounds:"audio/ogg"};ArtPackArchive.prototype.getArrayBuffer=function(name,type){var found,namespace,pathRP,tryPath,tryPaths,zipEntry,_i,_len;pathRP=this.nameToPath[type](name);found=false;if(pathRP.indexOf("*")===-1){tryPaths=[pathRP]}else{tryPaths=function(){var _i,_len,_ref,_results;_ref=this.namespaces;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){namespace=_ref[_i];_results.push(pathRP.replace("*",namespace))}return _results}.call(this)}for(_i=0,_len=tryPaths.length;_i<_len;_i++){tryPath=tryPaths[_i];zipEntry=this.zipEntries[tryPath];if(zipEntry!=null){return zipEntry.getData()}}return void 0};ArtPackArchive.prototype.getBlob=function(name,type){var arrayBuffer;arrayBuffer=this.getArrayBuffer(name,type);if(arrayBuffer==null){return void 0}return new Blob([arrayBuffer],{type:this.mimeTypes[type]})};return ArtPackArchive}();module.exports=function(opts){return new ArtPacks(opts)}}).call(this)},{"binary-xhr":3,events:507,fs:505,"native-buffer-browserify":5,path:514,zip:23}],3:[function(require,module,exports){var inherits=require("inherits");module.exports=function(url,cb){return new BinaryXHR(url,cb)};function BinaryXHR(url,cb){var self=this;var xhr=new XMLHttpRequest;this.xhr=xhr;xhr.open("GET",url,true);xhr.responseType="arraybuffer";xhr.onreadystatechange=function(){if(self.xhr.readyState===4){if(self.xhr.status!==200){cb(self.xhr.status,self.xhr.response)}else if(self.xhr.response&&self.xhr.response.byteLength>0){cb(false,self.xhr.response)}else{if(self.xhr.response&&self.xhr.response.byteLength===0)return cb("response length 0");cb("no response")}}};xhr.send(null)}},{inherits:4}],4:[function(require,module,exports){module.exports=inherits;function inherits(c,p,proto){proto=proto||{};var e={};[c.prototype,proto].forEach(function(s){Object.getOwnPropertyNames(s).forEach(function(k){e[k]=Object.getOwnPropertyDescriptor(s,k)})});c.prototype=Object.create(p.prototype,e);c.super=p}},{}],5:[function(require,module,exports){var base64=require("base64-js");var ieee754=require("ieee754");exports.Buffer=Buffer;exports.SlowBuffer=Buffer;exports.INSPECT_MAX_BYTES=50;Buffer.poolSize=8192;Buffer._useTypedArrays=function(){if(typeof Uint8Array==="undefined"||typeof ArrayBuffer==="undefined")return false;try{var arr=new Uint8Array(0);arr.foo=function(){return 42};return 42===arr.foo()&&typeof arr.subarray==="function"}catch(e){return false}}();function Buffer(subject,encoding,noZero){if(!(this instanceof Buffer))return new Buffer(subject,encoding,noZero);var type=typeof subject;if(encoding==="base64"&&type==="string"){subject=stringtrim(subject);while(subject.length%4!==0){subject=subject+"="}}var length;if(type==="number")length=coerce(subject);else if(type==="string")length=Buffer.byteLength(subject,encoding);else if(type==="object")length=coerce(subject.length);else throw new Error("First argument needs to be a number, array or string.");var buf;if(Buffer._useTypedArrays){buf=augment(new Uint8Array(length))}else{buf=this;buf.length=length;buf._isBuffer=true}var i;if(Buffer._useTypedArrays&&typeof Uint8Array==="function"&&subject instanceof Uint8Array){buf.set(subject)}else if(isArrayish(subject)){for(i=0;i<length;i++){if(Buffer.isBuffer(subject))buf[i]=subject.readUInt8(i);else buf[i]=subject[i]}}else if(type==="string"){buf.write(subject,0,encoding)}else if(type==="number"&&!Buffer._useTypedArrays&&!noZero){for(i=0;i<length;i++){buf[i]=0}}return buf}Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":return true;default:return false}};Buffer.isBuffer=function(b){return b!=null&&b._isBuffer||false};Buffer.byteLength=function(str,encoding){switch(encoding||"utf8"){case"hex":return str.length/2;case"utf8":case"utf-8":return utf8ToBytes(str).length;case"ascii":case"binary":return str.length;case"base64":return base64ToBytes(str).length;default:throw new Error("Unknown encoding")}};Buffer.concat=function(list,totalLength){assert(isArray(list),"Usage: Buffer.concat(list, [totalLength])\n"+"list should be an Array.");if(list.length===0){return new Buffer(0)}else if(list.length===1){return list[0]}var i;if(typeof totalLength!=="number"){totalLength=0;for(i=0;i<list.length;i++){totalLength+=list[i].length}}var buf=new Buffer(totalLength);var pos=0;for(i=0;i<list.length;i++){var item=list[i];item.copy(buf,pos);pos+=item.length}return buf};function _hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}var strLen=string.length;assert(strLen%2===0,"Invalid hex string");if(length>strLen/2){length=strLen/2}for(var i=0;i<length;i++){var byte=parseInt(string.substr(i*2,2),16);assert(!isNaN(byte),"Invalid hex string");buf[offset+i]=byte}Buffer._charsWritten=i*2;return i}function _utf8Write(buf,string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(utf8ToBytes(string),buf,offset,length)}function _asciiWrite(buf,string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(asciiToBytes(string),buf,offset,length)}function _binaryWrite(buf,string,offset,length){return _asciiWrite(buf,string,offset,length)}function _base64Write(buf,string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(base64ToBytes(string),buf,offset,length)}Buffer.prototype.write=function(string,offset,length,encoding){if(isFinite(offset)){if(!isFinite(length)){encoding=length;length=undefined}}else{var swap=encoding;encoding=offset;offset=length;length=swap}offset=Number(offset)||0;var remaining=this.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}encoding=String(encoding||"utf8").toLowerCase();switch(encoding){case"hex":return _hexWrite(this,string,offset,length);case"utf8":case"utf-8":return _utf8Write(this,string,offset,length);case"ascii":return _asciiWrite(this,string,offset,length);case"binary":return _binaryWrite(this,string,offset,length);case"base64":return _base64Write(this,string,offset,length);default:throw new Error("Unknown encoding")}};Buffer.prototype.toString=function(encoding,start,end){var self=this;encoding=String(encoding||"utf8").toLowerCase();start=Number(start)||0;end=end!==undefined?Number(end):end=self.length;if(end===start)return"";switch(encoding){case"hex":return _hexSlice(self,start,end);case"utf8":case"utf-8":return _utf8Slice(self,start,end);case"ascii":return _asciiSlice(self,start,end);case"binary":return _binarySlice(self,start,end);case"base64":return _base64Slice(self,start,end);default:throw new Error("Unknown encoding")}};Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};Buffer.prototype.copy=function(target,target_start,start,end){var source=this;if(!start)start=0;if(!end&&end!==0)end=this.length;if(!target_start)target_start=0;if(end===start)return;if(target.length===0||source.length===0)return;assert(end>=start,"sourceEnd < sourceStart");assert(target_start>=0&&target_start<target.length,"targetStart out of bounds");assert(start>=0&&start<source.length,"sourceStart out of bounds");assert(end>=0&&end<=source.length,"sourceEnd out of bounds");if(end>this.length)end=this.length;if(target.length-target_start<end-start)end=target.length-target_start+start;for(var i=0;i<end-start;i++)target[i+target_start]=this[i+start]};function _base64Slice(buf,start,end){if(start===0&&end===buf.length){return base64.fromByteArray(buf)}else{return base64.fromByteArray(buf.slice(start,end))}}function _utf8Slice(buf,start,end){var res="";var tmp="";end=Math.min(buf.length,end);for(var i=start;i<end;i++){if(buf[i]<=127){res+=decodeUtf8Char(tmp)+String.fromCharCode(buf[i]);tmp=""}else{tmp+="%"+buf[i].toString(16)}}return res+decodeUtf8Char(tmp)}function _asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;i++)ret+=String.fromCharCode(buf[i]);return ret}function _binarySlice(buf,start,end){return _asciiSlice(buf,start,end)}function _hexSlice(buf,start,end){var len=buf.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out="";for(var i=start;i<end;i++){out+=toHex(buf[i])}return out}Buffer.prototype.slice=function(start,end){var len=this.length;start=clamp(start,len,0);end=clamp(end,len,len);if(Buffer._useTypedArrays){return augment(this.subarray(start,end))}else{var sliceLen=end-start;var newBuf=new Buffer(sliceLen,undefined,true);for(var i=0;i<sliceLen;i++){newBuf[i]=this[i+start]}return newBuf}};Buffer.prototype.readUInt8=function(offset,noAssert){var buf=this;if(!noAssert){assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"Trying to read beyond buffer length")}if(offset>=buf.length)return;return buf[offset]};function _readUInt16(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val;if(littleEndian){val=buf[offset];if(offset+1<len)val|=buf[offset+1]<<8}else{val=buf[offset]<<8;if(offset+1<len)val|=buf[offset+1]}return val}Buffer.prototype.readUInt16LE=function(offset,noAssert){return _readUInt16(this,offset,true,noAssert)};Buffer.prototype.readUInt16BE=function(offset,noAssert){return _readUInt16(this,offset,false,noAssert)};function _readUInt32(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val;if(littleEndian){if(offset+2<len)val=buf[offset+2]<<16;if(offset+1<len)val|=buf[offset+1]<<8;val|=buf[offset];if(offset+3<len)val=val+(buf[offset+3]<<24>>>0)}else{if(offset+1<len)val=buf[offset+1]<<16;if(offset+2<len)val|=buf[offset+2]<<8;if(offset+3<len)val|=buf[offset+3];val=val+(buf[offset]<<24>>>0)}return val}Buffer.prototype.readUInt32LE=function(offset,noAssert){return _readUInt32(this,offset,true,noAssert)};Buffer.prototype.readUInt32BE=function(offset,noAssert){return _readUInt32(this,offset,false,noAssert)};Buffer.prototype.readInt8=function(offset,noAssert){var buf=this;if(!noAssert){assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"Trying to read beyond buffer length")}if(offset>=buf.length)return;var neg=buf[offset]&128;if(neg)return(255-buf[offset]+1)*-1;else return buf[offset]};function _readInt16(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val=_readUInt16(buf,offset,littleEndian,true);var neg=val&32768;if(neg)return(65535-val+1)*-1;else return val}Buffer.prototype.readInt16LE=function(offset,noAssert){return _readInt16(this,offset,true,noAssert)};Buffer.prototype.readInt16BE=function(offset,noAssert){return _readInt16(this,offset,false,noAssert)};function _readInt32(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val=_readUInt32(buf,offset,littleEndian,true);var neg=val&2147483648;if(neg)return(4294967295-val+1)*-1;else return val}Buffer.prototype.readInt32LE=function(offset,noAssert){return _readInt32(this,offset,true,noAssert)};Buffer.prototype.readInt32BE=function(offset,noAssert){return _readInt32(this,offset,false,noAssert)};function _readFloat(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset+3<buf.length,"Trying to read beyond buffer length")}return ieee754.read(buf,offset,littleEndian,23,4)}Buffer.prototype.readFloatLE=function(offset,noAssert){return _readFloat(this,offset,true,noAssert)};Buffer.prototype.readFloatBE=function(offset,noAssert){return _readFloat(this,offset,false,noAssert)};function _readDouble(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset+7<buf.length,"Trying to read beyond buffer length")}return ieee754.read(buf,offset,littleEndian,52,8)}Buffer.prototype.readDoubleLE=function(offset,noAssert){return _readDouble(this,offset,true,noAssert)};Buffer.prototype.readDoubleBE=function(offset,noAssert){return _readDouble(this,offset,false,noAssert)};Buffer.prototype.writeUInt8=function(value,offset,noAssert){var buf=this;if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"trying to write beyond buffer length");verifuint(value,255)}if(offset>=buf.length)return;buf[offset]=value};function _writeUInt16(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"trying to write beyond buffer length");verifuint(value,65535)}var len=buf.length;if(offset>=len)return;for(var i=0,j=Math.min(len-offset,2);i<j;i++){buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>(littleEndian?i:1-i)*8}}Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){_writeUInt16(this,value,offset,true,noAssert)};Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){_writeUInt16(this,value,offset,false,noAssert)};function _writeUInt32(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"trying to write beyond buffer length");verifuint(value,4294967295)}var len=buf.length;if(offset>=len)return;for(var i=0,j=Math.min(len-offset,4);i<j;i++){buf[offset+i]=value>>>(littleEndian?i:3-i)*8&255}}Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){_writeUInt32(this,value,offset,true,noAssert)};Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){_writeUInt32(this,value,offset,false,noAssert)};Buffer.prototype.writeInt8=function(value,offset,noAssert){var buf=this;if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"Trying to write beyond buffer length");verifsint(value,127,-128)}if(offset>=buf.length)return;if(value>=0)buf.writeUInt8(value,offset,noAssert);else buf.writeUInt8(255+value+1,offset,noAssert)};function _writeInt16(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to write beyond buffer length");verifsint(value,32767,-32768)}var len=buf.length;if(offset>=len)return;if(value>=0)_writeUInt16(buf,value,offset,littleEndian,noAssert);else _writeUInt16(buf,65535+value+1,offset,littleEndian,noAssert)}Buffer.prototype.writeInt16LE=function(value,offset,noAssert){_writeInt16(this,value,offset,true,noAssert)};Buffer.prototype.writeInt16BE=function(value,offset,noAssert){_writeInt16(this,value,offset,false,noAssert)};function _writeInt32(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to write beyond buffer length");verifsint(value,2147483647,-2147483648)}var len=buf.length;if(offset>=len)return;if(value>=0)_writeUInt32(buf,value,offset,littleEndian,noAssert);else _writeUInt32(buf,4294967295+value+1,offset,littleEndian,noAssert)}Buffer.prototype.writeInt32LE=function(value,offset,noAssert){_writeInt32(this,value,offset,true,noAssert)};Buffer.prototype.writeInt32BE=function(value,offset,noAssert){_writeInt32(this,value,offset,false,noAssert)};function _writeFloat(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to write beyond buffer length");verifIEEE754(value,3.4028234663852886e38,-3.4028234663852886e38)}var len=buf.length;if(offset>=len)return;ieee754.write(buf,value,offset,littleEndian,23,4)}Buffer.prototype.writeFloatLE=function(value,offset,noAssert){_writeFloat(this,value,offset,true,noAssert)};Buffer.prototype.writeFloatBE=function(value,offset,noAssert){_writeFloat(this,value,offset,false,noAssert)};function _writeDouble(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+7<buf.length,"Trying to write beyond buffer length");verifIEEE754(value,1.7976931348623157e308,-1.7976931348623157e308)}var len=buf.length;if(offset>=len)return;ieee754.write(buf,value,offset,littleEndian,52,8)}Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){_writeDouble(this,value,offset,true,noAssert)};Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){_writeDouble(this,value,offset,false,noAssert)};Buffer.prototype.fill=function(value,start,end){if(!value)value=0;if(!start)start=0;if(!end)end=this.length;if(typeof value==="string"){value=value.charCodeAt(0)}assert(typeof value==="number"&&!isNaN(value),"value is not a number");assert(end>=start,"end < start");if(end===start)return;if(this.length===0)return;assert(start>=0&&start<this.length,"start out of bounds");assert(end>=0&&end<=this.length,"end out of bounds");for(var i=start;i<end;i++){this[i]=value}};Buffer.prototype.inspect=function(){var out=[];var len=this.length;for(var i=0;i<len;i++){out[i]=toHex(this[i]);if(i===exports.INSPECT_MAX_BYTES){out[i+1]="...";break}}return"<Buffer "+out.join(" ")+">"};function BufferToArrayBuffer(){return new Buffer(this).buffer}function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")}var BP=Buffer.prototype;function augment(arr){arr._isBuffer=true;arr.write=BP.write;arr.toString=BP.toString;arr.toLocaleString=BP.toString;arr.toJSON=BP.toJSON;arr.copy=BP.copy;arr.slice=BP.slice;arr.readUInt8=BP.readUInt8;arr.readUInt16LE=BP.readUInt16LE;arr.readUInt16BE=BP.readUInt16BE;arr.readUInt32LE=BP.readUInt32LE;arr.readUInt32BE=BP.readUInt32BE;arr.readInt8=BP.readInt8;arr.readInt16LE=BP.readInt16LE;arr.readInt16BE=BP.readInt16BE;arr.readInt32LE=BP.readInt32LE;arr.readInt32BE=BP.readInt32BE;arr.readFloatLE=BP.readFloatLE;arr.readFloatBE=BP.readFloatBE;arr.readDoubleLE=BP.readDoubleLE;arr.readDoubleBE=BP.readDoubleBE;arr.writeUInt8=BP.writeUInt8;arr.writeUInt16LE=BP.writeUInt16LE;arr.writeUInt16BE=BP.writeUInt16BE;arr.writeUInt32LE=BP.writeUInt32LE;arr.writeUInt32BE=BP.writeUInt32BE;arr.writeInt8=BP.writeInt8;arr.writeInt16LE=BP.writeInt16LE;arr.writeInt16BE=BP.writeInt16BE;arr.writeInt32LE=BP.writeInt32LE;arr.writeInt32BE=BP.writeInt32BE;arr.writeFloatLE=BP.writeFloatLE;arr.writeFloatBE=BP.writeFloatBE;arr.writeDoubleLE=BP.writeDoubleLE;arr.writeDoubleBE=BP.writeDoubleBE;arr.fill=BP.fill;arr.inspect=BP.inspect;arr.toArrayBuffer=BufferToArrayBuffer;return arr}function clamp(index,len,defaultValue){if(typeof index!=="number")return defaultValue;index=~~index;if(index>=len)return len;if(index>=0)return index;index+=len;if(index>=0)return index;return 0}function coerce(length){length=~~Math.ceil(+length);return length<0?0:length}function isArray(subject){return(Array.isArray||function(subject){return Object.prototype.toString.call(subject)==="[object Array]"})(subject)}function isArrayish(subject){return isArray(subject)||Buffer.isBuffer(subject)||subject&&typeof subject==="object"&&typeof subject.length==="number"}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++){var b=str.charCodeAt(i);if(b<=127)byteArray.push(str.charCodeAt(i));else{var start=i;if(b>=55296&&b<=57343)i++;var h=encodeURIComponent(str.slice(start,i+1)).substr(1).split("%");for(var j=0;j<h.length;j++)byteArray.push(parseInt(h[j],16))}}return byteArray}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++){byteArray.push(str.charCodeAt(i)&255)}return byteArray}function base64ToBytes(str){return base64.toByteArray(str)}function blitBuffer(src,dst,offset,length){var pos;for(var i=0;i<length;i++){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i]}return i}function decodeUtf8Char(str){try{return decodeURIComponent(str)}catch(err){return String.fromCharCode(65533)}}function verifuint(value,max){assert(typeof value=="number","cannot write a non-number as a number");
assert(value>=0,"specified a negative value for writing an unsigned value");assert(value<=max,"value is larger than maximum value for type");assert(Math.floor(value)===value,"value has a fractional component")}function verifsint(value,max,min){assert(typeof value=="number","cannot write a non-number as a number");assert(value<=max,"value larger than maximum allowed value");assert(value>=min,"value smaller than minimum allowed value");assert(Math.floor(value)===value,"value has a fractional component")}function verifIEEE754(value,max,min){assert(typeof value=="number","cannot write a non-number as a number");assert(value<=max,"value larger than maximum allowed value");assert(value>=min,"value smaller than minimum allowed value")}function assert(test,message){if(!test)throw new Error(message||"Failed assertion")}},{"base64-js":6,ieee754:7}],6:[function(require,module,exports){var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";(function(exports){"use strict";var Arr=typeof Uint8Array!=="undefined"?Uint8Array:Array;var ZERO="0".charCodeAt(0);var PLUS="+".charCodeAt(0);var SLASH="/".charCodeAt(0);var NUMBER="0".charCodeAt(0);var LOWER="a".charCodeAt(0);var UPPER="A".charCodeAt(0);function decode(elt){var code=elt.charCodeAt(0);if(code===PLUS)return 62;if(code===SLASH)return 63;if(code<NUMBER)return-1;if(code<NUMBER+10)return code-NUMBER+26+26;if(code<UPPER+26)return code-UPPER;if(code<LOWER+26)return code-LOWER+26}function b64ToByteArray(b64){var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0){throw new Error("Invalid string. Length must be a multiple of 4")}var len=b64.length;placeHolders="="===b64.charAt(len-2)?2:"="===b64.charAt(len-1)?1:0;arr=new Arr(b64.length*3/4-placeHolders);l=placeHolders>0?b64.length-4:b64.length;var L=0;function push(v){arr[L++]=v}for(i=0,j=0;i<l;i+=4,j+=3){tmp=decode(b64.charAt(i))<<18|decode(b64.charAt(i+1))<<12|decode(b64.charAt(i+2))<<6|decode(b64.charAt(i+3));push((tmp&16711680)>>16);push((tmp&65280)>>8);push(tmp&255)}if(placeHolders===2){tmp=decode(b64.charAt(i))<<2|decode(b64.charAt(i+1))>>4;push(tmp&255)}else if(placeHolders===1){tmp=decode(b64.charAt(i))<<10|decode(b64.charAt(i+1))<<4|decode(b64.charAt(i+2))>>2;push(tmp>>8&255);push(tmp&255)}return arr}function uint8ToBase64(uint8){var i,extraBytes=uint8.length%3,output="",temp,length;function encode(num){return lookup.charAt(num)}function tripletToBase64(num){return encode(num>>18&63)+encode(num>>12&63)+encode(num>>6&63)+encode(num&63)}for(i=0,length=uint8.length-extraBytes;i<length;i+=3){temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2];output+=tripletToBase64(temp)}switch(extraBytes){case 1:temp=uint8[uint8.length-1];output+=encode(temp>>2);output+=encode(temp<<4&63);output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1];output+=encode(temp>>10);output+=encode(temp>>4&63);output+=encode(temp<<2&63);output+="=";break}return output}module.exports.toByteArray=b64ToByteArray;module.exports.fromByteArray=uint8ToBase64})()},{}],7:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8);m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8);if(e===0){e=1-eBias}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity}else{m=m+Math.pow(2,mLen);e=e-eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)};exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2}if(e+eBias>=1){value+=rt/c}else{value+=rt*Math.pow(2,1-eBias)}if(value*c>=2){e++;c/=2}if(e+eBias>=eMax){m=0;e=eMax}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0}}for(;mLen>=8;buffer[offset+i]=m&255,i+=d,m/=256,mLen-=8);e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&255,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=s*128}},{}],8:[function(require,module,exports){var bops=require("bops");exports.BufferIO=function(){var self={};var buffers=[];self.read=function(){consolidate(buffers);return buffers.shift()};self.write=function(buffer){buffers.push(bops.from(buffer))};self.close=function(){};self.destroy=function(){};self.toBuffer=function(){consolidate(buffers);var buffer=bops.create(buffers[0].length);bops.copy(buffers[0],buffer,0,0,buffers[0].length);return buffer};return self};exports.consolidate=consolidate;function consolidate(buffers){var length=0;var at;var i;var ii=buffers.length;var buffer;var result;for(i=0;i<ii;i++){buffer=buffers[i];length+=buffer.length}result=bops.create(length);at=0;for(i=0;i<ii;i++){buffer=buffers[i];bops.copy(buffer,result,at,0,buffer.length);at+=buffer.length}buffers.splice(0,ii,result)}},{bops:10}],9:[function(require,module,exports){var BufferIO=require("./buffer-io").BufferIO;var bops=require("bops");exports.inflate=function(input){var WSIZE=32768;var STORED_BLOCK=0;var STATIC_TREES=1;var DYN_TREES=2;var lbits=9;var dbits=6;var INBUFSIZ=32768;var INBUF_EXTRA=64;var slide;var wp;var fixed_tl=null;var fixed_td;var fixed_bl,fixed_bd;var bit_buf;var bit_len;var method;var eof;var copy_leng;var copy_dist;var tl,td;var bl,bd;var inflate_data;var inflate_pos;var MASK_BITS=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];var cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0];var cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99];var cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577];var cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];var border=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function HuftList(){this.next=null;this.list=null}function HuftNode(){this.e=0;this.b=0;this.n=0;this.t=null}function HuftBuild(b,n,s,d,e,mm){this.BMAX=16;this.N_MAX=288;this.status=0;this.root=null;this.m=0;{var a;var c=new Array(this.BMAX+1);var el;var f;var g;var h;var i;var j;var k;var lx=new Array(this.BMAX+1);var p;var pidx;var q;var r=new HuftNode;var u=new Array(this.BMAX);var v=new Array(this.N_MAX);var w;var x=new Array(this.BMAX+1);var xp;var y;var z;var o;var tail;tail=this.root=null;for(i=0;i<c.length;i++)c[i]=0;for(i=0;i<lx.length;i++)lx[i]=0;for(i=0;i<u.length;i++)u[i]=null;for(i=0;i<v.length;i++)v[i]=0;for(i=0;i<x.length;i++)x[i]=0;el=n>256?b[256]:this.BMAX;p=b;pidx=0;i=n;do{c[p[pidx]]++;pidx++}while(--i>0);if(c[0]==n){this.root=null;this.m=0;this.status=0;return}for(j=1;j<=this.BMAX;j++)if(c[j]!=0)break;k=j;if(mm<j)mm=j;for(i=this.BMAX;i!=0;i--)if(c[i]!=0)break;g=i;if(mm>i)mm=i;for(y=1<<j;j<i;j++,y<<=1)if((y-=c[j])<0){this.status=2;this.m=mm;return}if((y-=c[i])<0){this.status=2;this.m=mm;return}c[i]+=y;x[1]=j=0;p=c;pidx=1;xp=2;while(--i>0)x[xp++]=j+=p[pidx++];p=b;pidx=0;i=0;do{if((j=p[pidx++])!=0)v[x[j]++]=i}while(++i<n);n=x[g];x[0]=i=0;p=v;pidx=0;h=-1;w=lx[0]=0;q=null;z=0;for(;k<=g;k++){a=c[k];while(a-->0){while(k>w+lx[1+h]){w+=lx[1+h];h++;z=(z=g-w)>mm?mm:z;if((f=1<<(j=k-w))>a+1){f-=a+1;xp=k;while(++j<z){if((f<<=1)<=c[++xp])break;f-=c[xp]}}if(w+j>el&&w<el)j=el-w;z=1<<j;lx[1+h]=j;q=new Array(z);for(o=0;o<z;o++){q[o]=new HuftNode}if(tail==null)tail=this.root=new HuftList;else tail=tail.next=new HuftList;tail.next=null;tail.list=q;u[h]=q;if(h>0){x[h]=i;r.b=lx[h];r.e=16+j;r.t=q;j=(i&(1<<w)-1)>>w-lx[h];u[h-1][j].e=r.e;u[h-1][j].b=r.b;u[h-1][j].n=r.n;u[h-1][j].t=r.t}}r.b=k-w;if(pidx>=n)r.e=99;else if(p[pidx]<s){r.e=p[pidx]<256?16:15;r.n=p[pidx++]}else{r.e=e[p[pidx]-s];r.n=d[p[pidx++]-s]}f=1<<k-w;for(j=i>>w;j<z;j+=f){q[j].e=r.e;q[j].b=r.b;q[j].n=r.n;q[j].t=r.t}for(j=1<<k-1;(i&j)!=0;j>>=1)i^=j;i^=j;while((i&(1<<w)-1)!=x[h]){w-=lx[h];h--}}}this.m=lx[1];this.status=y!=0&&g!=1?1:0}}function GET_BYTE(){if(inflate_data.length==inflate_pos)return-1;return bops.readUInt8(inflate_data,inflate_pos++)}function NEEDBITS(n){while(bit_len<n){bit_buf|=GET_BYTE()<<bit_len;bit_len+=8}}function GETBITS(n){return bit_buf&MASK_BITS[n]}function DUMPBITS(n){bit_buf>>=n;bit_len-=n}function inflate_codes(buff,off,size){var e;var t;var n;if(size==0)return 0;n=0;for(;;){NEEDBITS(bl);t=tl.list[GETBITS(bl)];e=t.e;while(e>16){if(e==99)return-1;DUMPBITS(t.b);e-=16;NEEDBITS(e);t=t.t[GETBITS(e)];e=t.e}DUMPBITS(t.b);if(e==16){wp&=WSIZE-1;buff[off+n++]=slide[wp++]=t.n;if(n==size)return size;continue}if(e==15)break;NEEDBITS(e);copy_leng=t.n+GETBITS(e);DUMPBITS(e);NEEDBITS(bd);t=td.list[GETBITS(bd)];e=t.e;while(e>16){if(e==99)return-1;DUMPBITS(t.b);e-=16;NEEDBITS(e);t=t.t[GETBITS(e)];e=t.e}DUMPBITS(t.b);NEEDBITS(e);copy_dist=wp-t.n-GETBITS(e);DUMPBITS(e);while(copy_leng>0&&n<size){copy_leng--;copy_dist&=WSIZE-1;wp&=WSIZE-1;buff[off+n++]=slide[wp++]=slide[copy_dist++]}if(n==size)return size}method=-1;return n}function inflate_stored(buff,off,size){var n;n=bit_len&7;DUMPBITS(n);NEEDBITS(16);n=GETBITS(16);DUMPBITS(16);NEEDBITS(16);if(n!=(~bit_buf&65535))return-1;DUMPBITS(16);copy_leng=n;n=0;while(copy_leng>0&&n<size){copy_leng--;wp&=WSIZE-1;NEEDBITS(8);buff[off+n++]=slide[wp++]=GETBITS(8);DUMPBITS(8)}if(copy_leng==0)method=-1;return n}function inflate_fixed(buff,off,size){if(fixed_tl==null){var i;var l=new Array(288);var h;for(i=0;i<144;i++)l[i]=8;for(;i<256;i++)l[i]=9;for(;i<280;i++)l[i]=7;for(;i<288;i++)l[i]=8;fixed_bl=7;h=new HuftBuild(l,288,257,cplens,cplext,fixed_bl);if(h.status!=0){alert("HufBuild error: "+h.status);return-1}fixed_tl=h.root;fixed_bl=h.m;for(i=0;i<30;i++)l[i]=5;var fixed_bd=5;h=new HuftBuild(l,30,0,cpdist,cpdext,fixed_bd);if(h.status>1){fixed_tl=null;alert("HufBuild error: "+h.status);return-1}fixed_td=h.root;fixed_bd=h.m}tl=fixed_tl;td=fixed_td;bl=fixed_bl;bd=fixed_bd;return inflate_codes(buff,off,size)}function inflate_dynamic(buff,off,size){var i;var j;var l;var n;var t;var nb;var nl;var nd;var ll=new Array(286+30);var h;for(i=0;i<ll.length;i++)ll[i]=0;NEEDBITS(5);nl=257+GETBITS(5);DUMPBITS(5);NEEDBITS(5);nd=1+GETBITS(5);DUMPBITS(5);NEEDBITS(4);nb=4+GETBITS(4);DUMPBITS(4);if(nl>286||nd>30)return-1;for(j=0;j<nb;j++){NEEDBITS(3);ll[border[j]]=GETBITS(3);DUMPBITS(3)}for(;j<19;j++)ll[border[j]]=0;bl=7;h=new HuftBuild(ll,19,19,null,null,bl);if(h.status!=0)return-1;tl=h.root;bl=h.m;n=nl+nd;i=l=0;while(i<n){NEEDBITS(bl);t=tl.list[GETBITS(bl)];j=t.b;DUMPBITS(j);j=t.n;if(j<16)ll[i++]=l=j;else if(j==16){NEEDBITS(2);j=3+GETBITS(2);DUMPBITS(2);if(i+j>n)return-1;while(j-->0)ll[i++]=l}else if(j==17){NEEDBITS(3);j=3+GETBITS(3);DUMPBITS(3);if(i+j>n)return-1;while(j-->0)ll[i++]=0;l=0}else{NEEDBITS(7);j=11+GETBITS(7);DUMPBITS(7);if(i+j>n)return-1;while(j-->0)ll[i++]=0;l=0}}bl=lbits;h=new HuftBuild(ll,nl,257,cplens,cplext,bl);if(bl==0)h.status=1;if(h.status!=0){if(h.status==1);return-1}tl=h.root;bl=h.m;for(i=0;i<nd;i++)ll[i]=ll[i+nl];bd=dbits;h=new HuftBuild(ll,nd,0,cpdist,cpdext,bd);td=h.root;bd=h.m;if(bd==0&&nl>257){return-1}if(h.status==1){}if(h.status!=0)return-1;return inflate_codes(buff,off,size)}function inflate_start(){var i;if(slide==null)slide=new Array(2*WSIZE);wp=0;bit_buf=0;bit_len=0;method=-1;eof=false;copy_leng=copy_dist=0;tl=null}function inflate_internal(buff,off,size){var n,i;n=0;while(n<size){if(eof&&method==-1)return n;if(copy_leng>0){if(method!=STORED_BLOCK){while(copy_leng>0&&n<size){copy_leng--;copy_dist&=WSIZE-1;wp&=WSIZE-1;buff[off+n++]=slide[wp++]=slide[copy_dist++]}}else{while(copy_leng>0&&n<size){copy_leng--;wp&=WSIZE-1;NEEDBITS(8);buff[off+n++]=slide[wp++]=GETBITS(8);DUMPBITS(8)}if(copy_leng==0)method=-1}if(n==size)return n}if(method==-1){if(eof)break;NEEDBITS(1);if(GETBITS(1)!=0)eof=true;DUMPBITS(1);NEEDBITS(2);method=GETBITS(2);DUMPBITS(2);tl=null;copy_leng=0}switch(method){case 0:i=inflate_stored(buff,off+n,size-n);break;case 1:if(tl!=null)i=inflate_codes(buff,off+n,size-n);else i=inflate_fixed(buff,off+n,size-n);break;case 2:if(tl!=null)i=inflate_codes(buff,off+n,size-n);else i=inflate_dynamic(buff,off+n,size-n);break;default:i=-1;break}if(i==-1){if(eof)return 0;return-1}n+=i}return n}var inflate=function(bytes){var out,buff;var i,j;inflate_start();inflate_data=bytes;inflate_pos=0;buff=new Array(1024);out=new BufferIO;while((i=inflate_internal(buff,0,buff.length))>0){out.write(buff.slice(0,i))}inflate_data=undefined;return out.toBuffer()};return inflate(input)}},{"./buffer-io":8,bops:10}],10:[function(require,module,exports){var proto={};module.exports=proto;proto.from=require("./from.js");proto.to=require("./to.js");proto.is=require("./is.js");proto.subarray=require("./subarray.js");proto.join=require("./join.js");proto.copy=require("./copy.js");proto.create=require("./create.js");mix(require("./read.js"),proto);mix(require("./write.js"),proto);function mix(from,into){for(var key in from){into[key]=from[key]}}},{"./copy.js":13,"./create.js":14,"./from.js":15,"./is.js":16,"./join.js":17,"./read.js":19,"./subarray.js":20,"./to.js":21,"./write.js":22}],11:[function(require,module,exports){(function(exports){"use strict";var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function b64ToByteArray(b64){var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0){throw"Invalid string. Length must be a multiple of 4"}placeHolders=b64.indexOf("=");placeHolders=placeHolders>0?b64.length-placeHolders:0;arr=[];l=placeHolders>0?b64.length-4:b64.length;for(i=0,j=0;i<l;i+=4,j+=3){tmp=lookup.indexOf(b64[i])<<18|lookup.indexOf(b64[i+1])<<12|lookup.indexOf(b64[i+2])<<6|lookup.indexOf(b64[i+3]);arr.push((tmp&16711680)>>16);arr.push((tmp&65280)>>8);arr.push(tmp&255)}if(placeHolders===2){tmp=lookup.indexOf(b64[i])<<2|lookup.indexOf(b64[i+1])>>4;arr.push(tmp&255)}else if(placeHolders===1){tmp=lookup.indexOf(b64[i])<<10|lookup.indexOf(b64[i+1])<<4|lookup.indexOf(b64[i+2])>>2;arr.push(tmp>>8&255);arr.push(tmp&255)}return arr}function uint8ToBase64(uint8){var i,extraBytes=uint8.length%3,output="",temp,length;function tripletToBase64(num){return lookup[num>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[num&63]}for(i=0,length=uint8.length-extraBytes;i<length;i+=3){temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2];output+=tripletToBase64(temp)}switch(extraBytes){case 1:temp=uint8[uint8.length-1];output+=lookup[temp>>2];output+=lookup[temp<<4&63];output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1];output+=lookup[temp>>10];output+=lookup[temp>>4&63];output+=lookup[temp<<2&63];output+="=";break}return output}module.exports.toByteArray=b64ToByteArray;module.exports.fromByteArray=uint8ToBase64})()},{}],12:[function(require,module,exports){module.exports=to_utf8;var out=[],col=[],fcc=String.fromCharCode,mask=[64,32,16,8,4,2,1],unmask=[0,1,2|1,4|2|1,8|4|2|1,16|8|4|2|1,32|16|8|4|2|1,64|32|16|8|4|2|1];function to_utf8(bytes,start,end){start=start===undefined?0:start;end=end===undefined?bytes.length:end;var idx=0,hi=128,collecting=0,pos,by;col.length=out.length=0;while(idx<bytes.length){by=bytes[idx];if(!collecting&&by&hi){pos=find_pad_position(by);collecting+=pos;if(pos<8){col[col.length]=by&unmask[6-pos]}}else if(collecting){col[col.length]=by&unmask[6];--collecting;if(!collecting&&col.length){out[out.length]=fcc(reduced(col,pos));col.length=0}}else{out[out.length]=fcc(by)}++idx}if(col.length&&!collecting){out[out.length]=fcc(reduced(col,pos));col.length=0}return out.join("")}function find_pad_position(byt){for(var i=0;i<7;++i){if(!(byt&mask[i])){break}}return i}function reduced(list){var out=0;for(var i=0,len=list.length;i<len;++i){out|=list[i]<<(len-i-1)*6}return out}},{}],13:[function(require,module,exports){module.exports=copy;var slice=[].slice;function copy(source,target,target_start,source_start,source_end){target_start=arguments.length<3?0:target_start;source_start=arguments.length<4?0:source_start;source_end=arguments.length<5?source.length:source_end;if(source_end===source_start){return}if(target.length===0||source.length===0){return}if(source_end>source.length){source_end=source.length}if(target.length-target_start<source_end-source_start){source_end=target.length-target_start+source_start}if(source.buffer!==target.buffer){return fast_copy(source,target,target_start,source_start,source_end)}return slow_copy(source,target,target_start,source_start,source_end)}function fast_copy(source,target,target_start,source_start,source_end){var len=source_end-source_start+target_start;for(var i=target_start,j=source_start;i<len;++i,++j){target[i]=source[j]}}function slow_copy(from,to,j,i,jend){var iend=jend+i,tmp=new Uint8Array(slice.call(from,i,iend)),x=0;for(;i<iend;++i,++x){to[j++]=tmp[x]}}},{}],14:[function(require,module,exports){module.exports=function(size){return new Uint8Array(size)}},{}],15:[function(require,module,exports){module.exports=from;var base64=require("base64-js");var decoders={hex:from_hex,utf8:from_utf,base64:from_base64};function from(source,encoding){if(Array.isArray(source)){return new Uint8Array(source)}return decoders[encoding||"utf8"](source)}function from_hex(str){var size=str.length/2,buf=new Uint8Array(size),character="";for(var i=0,len=str.length;i<len;++i){character+=str.charAt(i);if(i>0&&i%2===1){buf[i>>>1]=parseInt(character,16);character=""}}return buf}function from_utf(str){var arr=[],code;for(var i=0,len=str.length;i<len;++i){code=fixed_cca(str,i);if(code===false){continue}if(code<128){arr[arr.length]=code;continue}codepoint_to_bytes(arr,code)}return new Uint8Array(arr)}function codepoint_to_bytes(arr,code){var copy_code=code,bit_count=0,byte_count,prefix,_byte,pos;do{++bit_count}while(copy_code>>>=1);byte_count=Math.ceil((bit_count-1)/5)|0;prefix=[0,0,192,224,240,248,252][byte_count];pos=[0,0,3,4,5,6,7][byte_count];_byte|=prefix;bit_count=7-pos+6*(byte_count-1);while(bit_count){_byte|=+!!(code&1<<bit_count)<<7-pos;++pos;if(pos%8===0){arr[arr.length]=_byte;_byte=128;pos=2}--bit_count}if(pos){_byte|=+!!(code&1)<<7-pos;arr[arr.length]=_byte}}function pad(str){while(str.length<8){str="0"+str}return str}function fixed_cca(str,idx){idx=idx||0;var code=str.charCodeAt(idx),lo,hi;if(55296<=code&&code<=56319){lo=str.charCodeAt(idx+1);hi=code;if(isNaN(lo)){throw new Error("High surrogate not followed by low surrogate")}return(hi-55296)*1024+(lo-56320)+65536}if(56320<=code&&code<=57343){return false}return code}function from_base64(str){return new Uint8Array(base64.toByteArray(str))}},{"base64-js":11}],16:[function(require,module,exports){module.exports=function(buffer){return buffer instanceof Uint8Array}},{}],17:[function(require,module,exports){module.exports=join;function join(targets,hint){if(!targets.length){return new Uint8Array(0)}var len=hint!==undefined?hint:get_length(targets),out=new Uint8Array(len),cur=targets[0],curlen=cur.length,curidx=0,curoff=0,i=0;while(i<len){if(curoff===curlen){curoff=0;++curidx;cur=targets[curidx];curlen=cur&&cur.length;continue}out[i++]=cur[curoff++]}return out}function get_length(targets){var size=0;for(var i=0,len=targets.length;i<len;++i){size+=targets[i].byteLength}return size}},{}],18:[function(require,module,exports){var proto,map;module.exports=proto={};map=typeof WeakMap==="undefined"?null:new WeakMap;proto.get=!map?no_weakmap_get:get;function no_weakmap_get(target){return new DataView(target.buffer,0)}function get(target){var out=map.get(target.buffer);if(!out){map.set(target.buffer,out=new DataView(target.buffer,0))}return out}},{}],19:[function(require,module,exports){module.exports={readUInt8:read_uint8,readInt8:read_int8,readUInt16LE:read_uint16_le,readUInt32LE:read_uint32_le,readInt16LE:read_int16_le,readInt32LE:read_int32_le,readFloatLE:read_float_le,readDoubleLE:read_double_le,readUInt16BE:read_uint16_be,readUInt32BE:read_uint32_be,readInt16BE:read_int16_be,readInt32BE:read_int32_be,readFloatBE:read_float_be,readDoubleBE:read_double_be};var map=require("./mapped.js");function read_uint8(target,at){return target[at]}function read_int8(target,at){var v=target[at];return v<128?v:v-256}function read_uint16_le(target,at){var dv=map.get(target);return dv.getUint16(at+target.byteOffset,true)}function read_uint32_le(target,at){var dv=map.get(target);return dv.getUint32(at+target.byteOffset,true)}function read_int16_le(target,at){var dv=map.get(target);return dv.getInt16(at+target.byteOffset,true)}function read_int32_le(target,at){var dv=map.get(target);return dv.getInt32(at+target.byteOffset,true)}function read_float_le(target,at){var dv=map.get(target);return dv.getFloat32(at+target.byteOffset,true)}function read_double_le(target,at){var dv=map.get(target);return dv.getFloat64(at+target.byteOffset,true)}function read_uint16_be(target,at){var dv=map.get(target);return dv.getUint16(at+target.byteOffset,false)}function read_uint32_be(target,at){var dv=map.get(target);return dv.getUint32(at+target.byteOffset,false)}function read_int16_be(target,at){var dv=map.get(target);return dv.getInt16(at+target.byteOffset,false)}function read_int32_be(target,at){var dv=map.get(target);return dv.getInt32(at+target.byteOffset,false)}function read_float_be(target,at){var dv=map.get(target);return dv.getFloat32(at+target.byteOffset,false)}function read_double_be(target,at){var dv=map.get(target);return dv.getFloat64(at+target.byteOffset,false)}},{"./mapped.js":18}],20:[function(require,module,exports){module.exports=subarray;function subarray(buf,from,to){return buf.subarray(from||0,to||buf.length)}},{}],21:[function(require,module,exports){module.exports=to;var base64=require("base64-js"),toutf8=require("to-utf8");var encoders={hex:to_hex,utf8:to_utf,base64:to_base64};function to(buf,encoding){return encoders[encoding||"utf8"](buf)}function to_hex(buf){var str="",byt;for(var i=0,len=buf.length;i<len;++i){byt=buf[i];str+=((byt&240)>>>4).toString(16);str+=(byt&15).toString(16)}return str}function to_utf(buf){return toutf8(buf)}function to_base64(buf){return base64.fromByteArray(buf)}},{"base64-js":11,"to-utf8":12}],22:[function(require,module,exports){module.exports={writeUInt8:write_uint8,writeInt8:write_int8,writeUInt16LE:write_uint16_le,writeUInt32LE:write_uint32_le,writeInt16LE:write_int16_le,writeInt32LE:write_int32_le,writeFloatLE:write_float_le,writeDoubleLE:write_double_le,writeUInt16BE:write_uint16_be,writeUInt32BE:write_uint32_be,writeInt16BE:write_int16_be,writeInt32BE:write_int32_be,writeFloatBE:write_float_be,writeDoubleBE:write_double_be};var map=require("./mapped.js");function write_uint8(target,value,at){return target[at]=value}function write_int8(target,value,at){return target[at]=value<0?value+256:value}function write_uint16_le(target,value,at){var dv=map.get(target);return dv.setUint16(at+target.byteOffset,value,true)}function write_uint32_le(target,value,at){var dv=map.get(target);return dv.setUint32(at+target.byteOffset,value,true)}function write_int16_le(target,value,at){var dv=map.get(target);return dv.setInt16(at+target.byteOffset,value,true)}function write_int32_le(target,value,at){var dv=map.get(target);return dv.setInt32(at+target.byteOffset,value,true)}function write_float_le(target,value,at){var dv=map.get(target);return dv.setFloat32(at+target.byteOffset,value,true)}function write_double_le(target,value,at){var dv=map.get(target);return dv.setFloat64(at+target.byteOffset,value,true)}function write_uint16_be(target,value,at){var dv=map.get(target);return dv.setUint16(at+target.byteOffset,value,false)}function write_uint32_be(target,value,at){var dv=map.get(target);return dv.setUint32(at+target.byteOffset,value,false)}function write_int16_be(target,value,at){var dv=map.get(target);return dv.setInt16(at+target.byteOffset,value,false)}function write_int32_be(target,value,at){var dv=map.get(target);return dv.setInt32(at+target.byteOffset,value,false)}function write_float_be(target,value,at){var dv=map.get(target);return dv.setFloat32(at+target.byteOffset,value,false)}function write_double_be(target,value,at){var dv=map.get(target);return dv.setFloat64(at+target.byteOffset,value,false)}},{"./mapped.js":18}],23:[function(require,module,exports){var process=require("__browserify_process");var INFLATE=require("./inflate");var bops=require("bops");var fs=require("fs");var LOCAL_FILE_HEADER=67324752;var CENTRAL_DIRECTORY_FILE_HEADER=33639248;var END_OF_CENTRAL_DIRECTORY_RECORD=101010256;var MADE_BY_UNIX=3;var Reader=exports.Reader=function(data){if(!(this instanceof Reader))return new Reader(data);if(bops.is(data))this._source=new BufferSource(data);else this._source=new FdSource(data);this._offset=0};function FdSource(fd){this._fileLength=fs.fstatSync(fd).size;this.length=function(){return this._fileLength};this.read=function(start,length){var result=bops.create(length);while(length>0){var pos=0;var toRead=length>8192?8192:length;fs.readSync(fd,result,pos,toRead,start);length-=toRead;start+=toRead;pos+=toRead}return result}}function BufferSource(buffer){this._buffer=buffer;this.length=function(){return buffer.length};this.read=function(start,length){var bytes=bops.subarray(this._buffer,start,start+length);return bytes}}Reader.prototype.length=function(){return this._source.length()};Reader.prototype.position=function(){return this._offset};Reader.prototype.seek=function(offset){this._offset=offset};Reader.prototype.read=function(length){var bytes=this._source.read(this._offset,length);this._offset+=length;return bytes};Reader.prototype.readInteger=function(length,bigEndian){if(bigEndian)return bytesToNumberBE(this.read(length));else return bytesToNumberLE(this.read(length))};Reader.prototype.readString=function(length,charset){return bops.to(this.read(length),charset||"utf8")};Reader.prototype.readUncompressed=function(length,method){var compressed=this.read(length);var uncompressed=null;if(method===0)uncompressed=compressed;else if(method===8)uncompressed=INFLATE.inflate(compressed);else throw new Error("Unknown compression method: "+structure.compression_method);return uncompressed};Reader.prototype.readStructure=function(){var stream=this;var structure={};structure.signature=stream.readInteger(4);switch(structure.signature){case LOCAL_FILE_HEADER:this.readLocalFileHeader(structure);break;case CENTRAL_DIRECTORY_FILE_HEADER:this.readCentralDirectoryFileHeader(structure);break;case END_OF_CENTRAL_DIRECTORY_RECORD:this.readEndOfCentralDirectoryRecord(structure);break;default:throw new Error("Unknown ZIP structure signature: 0x"+structure.signature.toString(16))}return structure};Reader.prototype.readLocalFileHeader=function(structure){var stream=this;structure=structure||{};if(!structure.signature)structure.signature=stream.readInteger(4);if(structure.signature!==LOCAL_FILE_HEADER)throw new Error("ZIP local file header signature invalid (expects 0x04034b50, actually 0x"+structure.signature.toString(16)+")");structure.version_needed=stream.readInteger(2);structure.flags=stream.readInteger(2);structure.compression_method=stream.readInteger(2);structure.last_mod_file_time=stream.readInteger(2);structure.last_mod_file_date=stream.readInteger(2);structure.crc_32=stream.readInteger(4);structure.compressed_size=stream.readInteger(4);structure.uncompressed_size=stream.readInteger(4);structure.file_name_length=stream.readInteger(2);structure.extra_field_length=stream.readInteger(2);var n=structure.file_name_length;var m=structure.extra_field_length;structure.file_name=stream.readString(n);structure.extra_field=stream.read(m);return structure};Reader.prototype.readCentralDirectoryFileHeader=function(structure){var stream=this;structure=structure||{};if(!structure.signature)structure.signature=stream.readInteger(4);if(structure.signature!==CENTRAL_DIRECTORY_FILE_HEADER)throw new Error("ZIP central directory file header signature invalid (expects 0x02014b50, actually 0x"+structure.signature.toString(16)+")");structure.version=stream.readInteger(2);structure.version_needed=stream.readInteger(2);structure.flags=stream.readInteger(2);structure.compression_method=stream.readInteger(2);structure.last_mod_file_time=stream.readInteger(2);structure.last_mod_file_date=stream.readInteger(2);structure.crc_32=stream.readInteger(4);structure.compressed_size=stream.readInteger(4);structure.uncompressed_size=stream.readInteger(4);structure.file_name_length=stream.readInteger(2);structure.extra_field_length=stream.readInteger(2);structure.file_comment_length=stream.readInteger(2);structure.disk_number=stream.readInteger(2);structure.internal_file_attributes=stream.readInteger(2);structure.external_file_attributes=stream.readInteger(4);structure.local_file_header_offset=stream.readInteger(4);var n=structure.file_name_length;var m=structure.extra_field_length;var k=structure.file_comment_length;structure.file_name=stream.readString(n);structure.extra_field=stream.read(m);structure.file_comment=stream.readString(k);structure.mode=stream.detectChmod(structure.version,structure.external_file_attributes);return structure};Reader.prototype.detectChmod=function(versionMadeBy,externalFileAttributes){var madeBy=versionMadeBy>>8,mode=externalFileAttributes>>>16,chmod=false;mode=mode&511;if(madeBy===MADE_BY_UNIX&&(process.platform==="darwin"||process.platform==="linux")){chmod=mode.toString(8)}return chmod};Reader.prototype.locateEndOfCentralDirectoryRecord=function(){var length=this.length();var minPosition=length-Math.pow(2,16)-22;var position=length-22+1;while(--position){if(position<minPosition)throw new Error("Unable to find end of central directory record");this.seek(position);var possibleSignature=this.readInteger(4);if(possibleSignature!==END_OF_CENTRAL_DIRECTORY_RECORD)continue;this.seek(position+20);var possibleFileCommentLength=this.readInteger(2);if(position+22+possibleFileCommentLength===length)break}this.seek(position);return position};Reader.prototype.readEndOfCentralDirectoryRecord=function(structure){var stream=this;structure=structure||{};if(!structure.signature)structure.signature=stream.readInteger(4);if(structure.signature!==END_OF_CENTRAL_DIRECTORY_RECORD)throw new Error("ZIP end of central directory record signature invalid (expects 0x06054b50, actually 0x"+structure.signature.toString(16)+")");structure.disk_number=stream.readInteger(2);structure.central_dir_disk_number=stream.readInteger(2);structure.central_dir_disk_records=stream.readInteger(2);structure.central_dir_total_records=stream.readInteger(2);structure.central_dir_size=stream.readInteger(4);structure.central_dir_offset=stream.readInteger(4);structure.file_comment_length=stream.readInteger(2);var n=structure.file_comment_length;structure.file_comment=stream.readString(n);return structure};Reader.prototype.readDataDescriptor=function(){var stream=this;var descriptor={};descriptor.crc_32=stream.readInteger(4);if(descriptor.crc_32===134695760)descriptor.crc_32=stream.readInteger(4);descriptor.compressed_size=stream.readInteger(4);descriptor.uncompressed_size=stream.readInteger(4);return descriptor};Reader.prototype.iterator=function(){var stream=this;stream.locateEndOfCentralDirectoryRecord();var endRecord=stream.readEndOfCentralDirectoryRecord();stream.seek(endRecord.central_dir_offset);var count=endRecord.central_dir_disk_records;return{next:function(){if(count--===0)throw"stop-iteration";var centralHeader=stream.readCentralDirectoryFileHeader();var saved=stream.position();stream.seek(centralHeader.local_file_header_offset);var localHeader=stream.readLocalFileHeader();var start=stream.position();stream.seek(saved);return new Entry(localHeader,stream,start,centralHeader.compressed_size,centralHeader.compression_method,centralHeader.mode)}}};Reader.prototype.forEach=function(block,context){var iterator=this.iterator();var next;while(true){try{next=iterator.next()}catch(exception){if(exception==="stop-iteration")break;if(exception==="skip-iteration")continue;throw exception}block.call(context,next)}};
Reader.prototype.toObject=function(charset){var object={};this.forEach(function(entry){if(entry.isFile()){var data=entry.getData();if(charset)data=data.toString(charset);object[entry.getName()]=data}});return object};Reader.prototype.close=function(mode,options){};var Entry=exports.Entry=function(header,realStream,start,compressedSize,compressionMethod,mode){this._mode=mode;this._header=header;this._realStream=realStream;this._stream=null;this._start=start;this._compressedSize=compressedSize;this._compressionMethod=compressionMethod};Entry.prototype.getName=function(){return this._header.file_name};Entry.prototype.isFile=function(){return!this.isDirectory()};Entry.prototype.isDirectory=function(){return this.getName().slice(-1)==="/"};Entry.prototype.lastModified=function(){return decodeDateTime(this._header.last_mod_file_date,this._header.last_mod_file_time)};Entry.prototype.getData=function(){if(this._stream==null){var bookmark=this._realStream.position();this._realStream.seek(this._start);this._stream=this._realStream.readUncompressed(this._compressedSize,this._compressionMethod);this._realStream.seek(bookmark)}return this._stream};Entry.prototype.getMode=function(){return this._mode};var bytesToNumberLE=function(bytes){var acc=0;for(var i=0;i<bytes.length;i++)acc+=bops.readUInt8(bytes,i)<<8*i;return acc};var bytesToNumberBE=function(bytes){var acc=0;for(var i=0;i<bytes.length;i++)acc=(acc<<8)+bops.readUInt8(bytes,i);return acc};var numberToBytesLE=function(number,length){var bytes=[];for(var i=0;i<length;i++)bytes[i]=number>>8*i&255;return new bops.from(bytes)};var numberToBytesBE=function(number,length){var bytes=[];for(var i=0;i<length;i++)bytes[length-i-1]=number>>8*i&255;return new bops.from(bytes)};var decodeDateTime=function(date,time){return new Date((date>>>9)+1980,(date>>>5&15)-1,date&31,time>>>11&31,time>>>5&63,(time&63)*2)}},{"./inflate":9,__browserify_process:510,bops:10,fs:505}],24:[function(require,module,exports){"use strict";var vkey=require("vkey");module.exports=function(game,opts){return new BindingsUI(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-debug","voxel-plugins-ui"],clientOnly:true};function BindingsUI(game,opts){this.game=game;opts=opts||{};this.kb=opts.kb||game&&game.buttons;if(!this.kb)throw'kb-bindings-ui requires "kb" option set to kb-bindings instance, or voxel-engine game with kb-bindings for game.buttons';if(!this.kb.bindings)throw'kb-bindings-ui "kb" option could not find kb-bindings\' bindings, not set to kb-bindings instance? (vs kb-controls)';this.gui=opts.gui||(game&&game.plugins&&game.plugins.get("voxel-debug")?game.plugins.get("voxel-debug").gui:new require("dat-gui").GUI());this.hideKeys=opts.hideKeys||["ime-","launch-","browser-"];this.folder=this.gui.addFolder("keys");this.vkey2code={};this.vkeyBracket2Bare={};this.vkeyBare2Bracket={};this.keyListing=[];for(var code in vkey){var keyName=vkey[code];this.vkey2code[keyName]=code;var keyNameBare=keyName.replace("<","").replace(">","");this.vkeyBracket2Bare[keyName]=keyNameBare;this.vkeyBare2Bracket[keyNameBare]=keyName;if(!this.shouldHideKey(keyNameBare))this.keyListing.push(keyNameBare)}this.binding2Key={};for(var key in this.kb.bindings){var binding=this.kb.bindings[key];this.binding2Key[binding]=this.vkeyBracket2Bare[key];this.addBinding(binding)}}BindingsUI.prototype.shouldHideKey=function(name){for(var i=0;i<this.hideKeys.length;++i){if(name.indexOf(this.hideKeys[i])===0)return true}return false};BindingsUI.prototype.addBinding=function(binding){var item=this.folder.add(this.binding2Key,binding,this.keyListing);item.onChange(updateBinding(this,binding))};function updateBinding(self,binding){return function(newKeyNameBare){var newKeyName=self.vkeyBare2Bracket[newKeyNameBare];self.removeBindings(binding);self.kb.bindings[newKeyName]=binding}}BindingsUI.prototype.removeBindings=function(binding){for(var key in this.kb.bindings){var thisBinding=this.kb.bindings[key];if(thisBinding===binding){delete this.kb.bindings[key]}}}},{vkey:25}],25:[function(require,module,exports){var ua=typeof window!=="undefined"?window.navigator.userAgent:"",isOSX=/OS X/.test(ua),isOpera=/Opera/.test(ua),maybeFirefox=!/like Gecko/.test(ua)&&!isOpera;var i,output=module.exports={0:isOSX?"<menu>":"<UNK>",1:"<mouse 1>",2:"<mouse 2>",3:"<break>",4:"<mouse 3>",5:"<mouse 4>",6:"<mouse 5>",8:"<backspace>",9:"<tab>",12:"<clear>",13:"<enter>",16:"<shift>",17:"<control>",18:"<alt>",19:"<pause>",20:"<caps-lock>",21:"<ime-hangul>",23:"<ime-junja>",24:"<ime-final>",25:"<ime-kanji>",27:"<escape>",28:"<ime-convert>",29:"<ime-nonconvert>",30:"<ime-accept>",31:"<ime-mode-change>",27:"<escape>",32:"<space>",33:"<page-up>",34:"<page-down>",35:"<end>",36:"<home>",37:"<left>",38:"<up>",39:"<right>",40:"<down>",41:"<select>",42:"<print>",43:"<execute>",44:"<snapshot>",45:"<insert>",46:"<delete>",47:"<help>",91:"<meta>",92:"<meta>",93:isOSX?"<meta>":"<menu>",95:"<sleep>",106:"<num-*>",107:"<num-+>",108:"<num-enter>",109:"<num-->",110:"<num-.>",111:"<num-/>",144:"<num-lock>",145:"<scroll-lock>",160:"<shift-left>",161:"<shift-right>",162:"<control-left>",163:"<control-right>",164:"<alt-left>",165:"<alt-right>",166:"<browser-back>",167:"<browser-forward>",168:"<browser-refresh>",169:"<browser-stop>",170:"<browser-search>",171:"<browser-favorites>",172:"<browser-home>",173:isOSX&&maybeFirefox?"-":"<volume-mute>",174:"<volume-down>",175:"<volume-up>",176:"<next-track>",177:"<prev-track>",178:"<stop>",179:"<play-pause>",180:"<launch-mail>",181:"<launch-media-select>",182:"<launch-app 1>",183:"<launch-app 2>",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",223:"<meta>",224:"<meta>",226:"<alt-gr>",229:"<ime-process>",231:isOpera?"`":"<unicode>",246:"<attention>",247:"<crsel>",248:"<exsel>",249:"<erase-eof>",250:"<play>",251:"<zoom>",252:"<no-name>",253:"<pa-1>",254:"<clear>"};for(i=58;i<65;++i){output[i]=String.fromCharCode(i)}for(i=48;i<58;++i){output[i]=i-48+""}for(i=65;i<91;++i){output[i]=String.fromCharCode(i)}for(i=96;i<106;++i){output[i]="<num-"+(i-96)+">"}for(i=112;i<136;++i){output[i]="F"+(i-111)}},{}],26:[function(require,module,exports){"use strict";module.exports=function(game,opts){return new BlockData(game,opts)};function BlockData(game,opts){this.game=game;this.enable()}BlockData.prototype.enable=function(){var self=this;this.game.on("setBlock",this.onSetBlock=function(target){self.clear.apply(self,target)})};BlockData.prototype.disable=function(){this.game.removeListener("setBlock",this.onSetBlock)};BlockData.prototype.getForChunk=function(x,y,z,noCreate){var chunkIndex=this.game.voxels.chunkAtCoordinates(x,y,z).join("|");var chunk=this.game.voxels.chunks[chunkIndex];if(!chunk)return undefined;if(chunk.blockdata===undefined&&!noCreate)chunk.blockdata={};return chunk.blockdata};BlockData.prototype.coordsToKey=function(x,y,z){return[x,y,z].join(",")};BlockData.prototype.get=function(x,y,z){var blockdataMap=this.getForChunk(x,y,z);if(blockdataMap===undefined)return undefined;return blockdataMap[this.coordsToKey(x,y,z)]};BlockData.prototype.set=function(x,y,z,data){var blockdataMap=this.getForChunk(x,y,z);if(blockdataMap===undefined)return undefined;blockdataMap[this.coordsToKey(x,y,z)]=data};BlockData.prototype.clear=function(x,y,z){var blockdataMap=this.getForChunk(x,y,z,true);if(blockdataMap===undefined)return undefined;delete blockdataMap[this.coordsToKey(x,y,z)]}},{}],27:[function(require,module,exports){(function(){var BucketPlugin,ItemPile;ItemPile=require("itempile");module.exports=function(game,opts){return new BucketPlugin(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-registry","voxel-fluid"]};BucketPlugin=function(){function BucketPlugin(game,opts){var _ref,_ref1;this.game=game;this.opts=opts;this.registry=function(){if((_ref=this.game.plugins.get("voxel-registry"))!=null){return _ref}else{throw new Error('voxel-bucket requires "voxel-registry" plugin')}}.call(this);this.fluidPlugin=function(){if((_ref1=this.game.plugins.get("voxel-fluid"))!=null){return _ref1}else{throw new Error('voxel-bucket requires "voxel-fluid" plugin')}}.call(this);this.fluidBuckets={};if(opts.registerBlocks==null){opts.registerBlocks=true}if(opts.registerItems==null){opts.registerItems=true}if(opts.registerRecipes==null){opts.registerRecipes=true}this.enable()}BucketPlugin.prototype.enable=function(){var bucketName,fluid,ucfirst,_i,_len,_ref,_ref1;if(this.opts.registerItems){this.registry.registerItem("bucket",{itemTexture:"i/bucket_empty",onUse:this.pickupFluid.bind(this),displayName:"Empty Bucket"});ucfirst=function(s){return s.substr(0,1).toUpperCase()+s.substring(1)};_ref=this.fluidPlugin.getFluidNames();for(_i=0,_len=_ref.length;_i<_len;_i++){fluid=_ref[_i];bucketName="bucket"+ucfirst(fluid);this.registry.registerItem(bucketName,{itemTexture:"i/bucket_"+fluid,fluid:fluid,containerItem:"bucket",onUse:this.placeFluid.bind(this,fluid),displayName:""+ucfirst(fluid)+" Bucket"});this.fluidBuckets[fluid]=bucketName}}if(this.opts.registerRecipes){this.recipes=function(){if((_ref1=this.game.plugins.get("voxel-recipes"))!=null){return _ref1}else{throw new Error("voxel-bucket requires voxel-recipes plugin when opts.registerRecipes enabled")}}.call(this);return this.recipes.registerPositional([["ingotIron",void 0,"ingotIron"],["ingotIron","ingotIron","ingotIron"],[void 0,void 0,void 0]],new ItemPile("bucket"))}};BucketPlugin.prototype.disable=function(){};BucketPlugin.prototype.pickupFluid=function(held,target){var flowing,fluid,fluidBucket,name,props;console.log("pickupFluid",held,target);if(!target){return}name=this.registry.getBlockName(target.value);props=this.registry.getBlockProps(name);if(props==null){return}fluid=props.fluid;if(!fluid){return}flowing=props.flowing;if(flowing){return}fluidBucket=this.fluidBuckets[fluid];if(!fluidBucket){return}this.game.setBlock(target.voxel,0);return new ItemPile(fluidBucket)};BucketPlugin.prototype.placeFluid=function(fluid,held,target){var fluidIndex;console.log("placeFluid",fluid,held,target);if(!target){return}fluidIndex=this.registry.getBlockID(fluid);if(fluidIndex==null){return}this.game.setBlock(target.adjacent,fluidIndex);return new ItemPile("bucket")};return BucketPlugin}()}).call(this)},{itempile:28}],28:[function(require,module,exports){(function(){var ItemPile,clone,deepEqual;deepEqual=require("deep-equal");clone=require("clone");module.exports=ItemPile=function(){function ItemPile(item,count,tags){this.item=typeof item==="string"?ItemPile.itemFromString(item):item;this.count=count!=null?count:1;this.tags=tags!=null?tags:{}}ItemPile.prototype.clone=function(){return new ItemPile(this.item,this.count,clone(this.tags,false))};ItemPile.maxPileSize=64;ItemPile.itemFromString=function(s){if(s instanceof ItemPile){return s}if(!s){return""}else{return s}};ItemPile.itemToString=function(item){return""+item};ItemPile.prototype.hasTags=function(){return Object.keys(this.tags).length!==0};ItemPile.prototype.matchesType=function(itemPile){return this.item===itemPile.item};ItemPile.prototype.matchesTypeAndCount=function(itemPile){return this.item===itemPile.item&&this.count===itemPile.count};ItemPile.prototype.matchesTypeAndTags=function(itemPile){return this.item===itemPile.item&&deepEqual(this.tags,itemPile.tags,{strict:true})};ItemPile.prototype.matchesAll=function(itemPile){return this.matchesTypeAndCount(itemPile)&&deepEqual(this.tags,itemPile.tags,{strict:true})};ItemPile.prototype.canPileWith=function(itemPile){if(itemPile.item!==this.item){return false}if(itemPile.count===0||this.count===0){return true}if(itemPile.hasTags()||this.hasTags()){return false}return true};ItemPile.prototype.mergePile=function(itemPile){if(!this.canPileWith(itemPile)){return false}return itemPile.count=this.increase(itemPile.count)};ItemPile.prototype.increase=function(n){var excessCount,newCount,_ref;_ref=this.tryAdding(n),newCount=_ref[0],excessCount=_ref[1];this.count=newCount;return excessCount};ItemPile.prototype.decrease=function(n){var remainingCount,removedCount,_ref;_ref=this.trySubtracting(n),removedCount=_ref[0],remainingCount=_ref[1];this.count=remainingCount;return removedCount};ItemPile.prototype.tryAdding=function(n){var sum;sum=this.count+n;if(sum>ItemPile.maxPileSize&&this.count!==Infinity){return[ItemPile.maxPileSize,sum-ItemPile.maxPileSize]}else{return[sum,0]}};ItemPile.prototype.trySubtracting=function(n){var difference;difference=this.count-n;if(difference<0){return[this.count,n-this.count]}else{return[n,this.count-n]}};ItemPile.prototype.splitPile=function(n){if(n<0){n=this.count+n}else if(n<1){n=Math.ceil(this.count*n)}if(n>this.count){return false}if(n!==Infinity){this.count-=n}return new ItemPile(this.item,n,clone(this.tags,false))};ItemPile.prototype.toString=function(){if(this.hasTags()){return""+this.count+":"+this.item+" "+JSON.stringify(this.tags)}else{return""+this.count+":"+this.item}};ItemPile.fromString=function(s){var a,count,countStr,item,itemStr,tags,tagsStr,_;a=s.match(/^([^:]+):([^ ]+) ?(.*)/);if(!a){return void 0}_=a[0],countStr=a[1],itemStr=a[2],tagsStr=a[3];if(countStr==="Infinity"){count=Infinity}else{count=parseInt(countStr,10)}item=ItemPile.itemFromString(itemStr);if(tagsStr&&tagsStr.length){tags=JSON.parse(tagsStr)}else{tags={}}return new ItemPile(item,count,tags)};ItemPile.fromArray=function(a){var count,item,tags;item=a[0],count=a[1],tags=a[2];return new ItemPile(item,count,tags)};ItemPile.fromArrayIfArray=function(a){if(Array.isArray(a)){return ItemPile.fromArray(a)}else{return a}};return ItemPile}()}).call(this)},{clone:29,"deep-equal":30}],29:[function(require,module,exports){var Buffer=require("__browserify_Buffer");"use strict";function objectToString(o){return Object.prototype.toString.call(o)}var util={isArray:function(ar){return Array.isArray(ar)||typeof ar==="object"&&objectToString(ar)==="[object Array]"},isDate:function(d){return typeof d==="object"&&objectToString(d)==="[object Date]"},isRegExp:function(re){return typeof re==="object"&&objectToString(re)==="[object RegExp]"},getRegExpFlags:function(re){var flags="";re.global&&(flags+="g");re.ignoreCase&&(flags+="i");re.multiline&&(flags+="m");return flags}};if(typeof module==="object")module.exports=clone;function clone(parent,circular){if(typeof circular=="undefined")circular=true;var useBuffer=typeof Buffer!="undefined";var circularParent={};var circularResolved={};var circularReplace=[];function _clone(parent,context,child,cIndex){var i;if(typeof parent=="object"){if(parent==null)return parent;for(i in circularParent)if(circularParent[i]===parent){circularReplace.push({resolveTo:i,child:child,i:cIndex});return null}circularParent[context]=parent;if(util.isArray(parent)){child=[];for(i in parent)child[i]=_clone(parent[i],context+"["+i+"]",child,i)}else if(util.isDate(parent))child=new Date(parent.getTime());else if(util.isRegExp(parent)){child=new RegExp(parent.source,util.getRegExpFlags(parent));if(parent.lastIndex)child.lastIndex=parent.lastIndex}else if(useBuffer&&Buffer.isBuffer(parent)){child=new Buffer(parent.length);parent.copy(child)}else{child={};child.__proto__=parent.__proto__;for(i in parent)child[i]=_clone(parent[i],context+"["+i+"]",child,i)}circularResolved[context]=child}else child=parent;return child}var i;if(circular){var cloned=_clone(parent,"*");for(i in circularReplace){var c=circularReplace[i];if(c&&c.child&&c.i in c.child){c.child[c.i]=circularResolved[c.resolveTo]}}return cloned}else{var child;if(typeof parent=="object"){if(parent==null)return parent;if(parent.constructor.name==="Array"){child=[];for(i in parent)child[i]=clone(parent[i],circular)}else if(util.isDate(parent))child=new Date(parent.getTime());else if(util.isRegExp(parent)){child=new RegExp(parent.source,util.getRegExpFlags(parent));if(parent.lastIndex)child.lastIndex=parent.lastIndex}else{child={};child.__proto__=parent.__proto__;for(i in parent)child[i]=clone(parent[i],circular)}}else child=parent;return child}}clone.clonePrototype=function(parent){if(parent===null)return null;var c=function(){};c.prototype=parent;return new c}},{__browserify_Buffer:509}],30:[function(require,module,exports){var pSlice=Array.prototype.slice;var Object_keys=typeof Object.keys==="function"?Object.keys:function(obj){var keys=[];for(var key in obj)keys.push(key);return keys};var deepEqual=module.exports=function(actual,expected,opts){if(!opts)opts={};if(actual===expected){return true}else if(actual instanceof Date&&expected instanceof Date){return actual.getTime()===expected.getTime()}else if(typeof actual!="object"&&typeof expected!="object"){return opts.strict?actual===expected:actual==expected}else{return objEquiv(actual,expected,opts)}};function isUndefinedOrNull(value){return value===null||value===undefined}function isArguments(object){return Object.prototype.toString.call(object)=="[object Arguments]"}function objEquiv(a,b,opts){if(!opts)opts={};if(isUndefinedOrNull(a)||isUndefinedOrNull(b))return false;if(a.prototype!==b.prototype)return false;if(isArguments(a)){if(!isArguments(b)){return false}a=pSlice.call(a);b=pSlice.call(b);return deepEqual(a,b,opts)}try{var ka=Object_keys(a),kb=Object_keys(b),key,i}catch(e){return false}if(ka.length!=kb.length)return false;ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!=kb[i])return false}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!deepEqual(a[key],b[key],opts))return false}return true}},{}],31:[function(require,module,exports){var Inventory=require("inventory");module.exports=function(game,opts){return new Carry(game,opts)};function Carry(game,opts){opts=opts||{};opts.inventoryWidth=opts.inventoryWidth||10;opts.inventoryRows=opts.inventoryRows||5;this.inventory=new Inventory(opts.inventoryWidth,opts.inventoryRows)}},{inventory:32}],32:[function(require,module,exports){(function(){var EventEmitter,Inventory,ItemPile,deepEqual,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};deepEqual=require("deep-equal");ItemPile=require("itempile");EventEmitter=require("events").EventEmitter;module.exports=Inventory=function(_super){__extends(Inventory,_super);function Inventory(xSize,ySize,opts){var size;if(xSize==null){xSize=10}if(ySize==null){ySize=1}size=xSize*ySize;this.array=new Array(size);this.width=xSize;this.height=ySize}Inventory.prototype.changed=function(){return this.emit("changed")};Inventory.prototype.give=function(itemPile){var excess,i,_i,_j,_ref,_ref1;excess=itemPile.count;for(i=_i=0,_ref=this.array.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){if(this.array[i]!=null&&this.array[i].canPileWith(itemPile)){excess=this.array[i].mergePile(itemPile)}if(itemPile.count===0){break}}for(i=_j=0,_ref1=this.array.length;0<=_ref1?_j<_ref1:_j>_ref1;i=0<=_ref1?++_j:--_j){if(this.array[i]==null){this.array[i]=itemPile.clone();this.array[i].count=0;excess=this.array[i].mergePile(itemPile);if(this.array[i].count===0){this.array[i]=void 0}}if(itemPile.count===0){break}}this.changed();return excess};Inventory.prototype.take=function(itemPile){var given,i,n,_i,_ref;for(i=_i=0,_ref=this.array.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){if(this.array[i]!=null&&this.array[i].matchesTypeAndTags(itemPile)){n=Math.min(itemPile.count,this.array[i].count);itemPile.count-=n;given=this.takeAt(i,n)}}return this.changed()};Inventory.prototype.takeAt=function(position,count){var ret;if(!this.array[position]){return false}ret=this.array[position].splitPile(count);if(this.array[position].count===0){this.array[position]=void 0}this.changed();return ret};Inventory.prototype.toString=function(){var a,i,itemPile,_i,_len,_ref;a=[];_ref=this.array;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){itemPile=_ref[i];if(itemPile==null){a.push("")}else{a.push(""+itemPile)}}return a.join("	")};Inventory.fromString=function(s){var items,ret,strings;strings=s.split("	");items=function(){var _i,_len,_results;_results=[];for(_i=0,_len=strings.length;_i<_len;_i++){s=strings[_i];_results.push(ItemPile.fromString(s))}return _results}();ret=new Inventory(items.length);ret.array=items;return ret};Inventory.prototype.size=function(){return this.array.length};Inventory.prototype.get=function(i){return this.array[i]};Inventory.prototype.set=function(i,itemPile){this.array[i]=itemPile;return this.changed()};Inventory.prototype.clear=function(){var i,_i,_ref,_results;_results=[];for(i=_i=0,_ref=this.size();0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){_results.push(this.set(i,void 0))}return _results};Inventory.prototype.transferTo=function(dest){var i,_i,_ref,_results;_results=[];for(i=_i=0,_ref=this.size();0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){dest.set(i,this.get(i));_results.push(this.set(i,void 0))}return _results};return Inventory}(EventEmitter)}).call(this)},{"deep-equal":33,events:507,itempile:34}],33:[function(require,module,exports){module.exports=require(30)},{}],34:[function(require,module,exports){module.exports=require(28)},{clone:35,"deep-equal":36}],35:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],36:[function(require,module,exports){module.exports=require(30)},{}],37:[function(require,module,exports){(function(){var Chest,ChestDialog,Inventory,InventoryDialog,InventoryWindow,ItemPile,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};InventoryDialog=require("voxel-inventory-dialog").InventoryDialog;Inventory=require("inventory");InventoryWindow=require("inventory-window");ItemPile=require("itempile");module.exports=function(game,opts){return new Chest(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-blockdata","voxel-registry","voxel-recipes","voxel-carry"]};Chest=function(){function Chest(game,opts){var _ref,_ref1,_ref2,_ref3;this.game=game;this.playerInventory=function(){var _ref1,_ref2,_ref3;if((_ref=(_ref1=(_ref2=game.plugins)!=null?(_ref3=_ref2.get("voxel-carry"))!=null?_ref3.inventory:void 0:void 0)!=null?_ref1:opts.playerInventory)!=null){return _ref}else{throw new Error('voxel-chest requires "voxel-carry" plugin or "playerInventory" set to inventory instance')}}();this.registry=(_ref1=game.plugins)!=null?_ref1.get("voxel-registry"):void 0;this.recipes=(_ref2=game.plugins)!=null?_ref2.get("voxel-recipes"):void 0;this.blockdata=(_ref3=game.plugins)!=null?_ref3.get("voxel-blockdata"):void 0;if(opts.registerBlock==null){opts.registerBlock=this.registry!=null}if(opts.registerRecipe==null){opts.registerRecipe=this.recipes!=null}if(this.game.isClient){this.chestDialog=new ChestDialog(game,this.playerInventory,this.registry,this.blockdata)}this.opts=opts;this.enable()}Chest.prototype.enable=function(){if(this.opts.registerBlock){this.registry.registerBlock("chest",{texture:["door_wood_lower","piston_top_normal","bookshelf"],onInteract:function(_this){return function(target){_this.chestDialog.open(target);return true}}(this)})}if(this.opts.registerRecipe){return this.recipes.registerPositional([["wood.plank","wood.plank","wood.plank"],["wood.plank",void 0,"wood.plank"],["wood.plank","wood.plank","wood.plank"]],new ItemPile("chest",1))}};Chest.prototype.disable=function(){};return Chest}();ChestDialog=function(_super){__extends(ChestDialog,_super);function ChestDialog(game,playerInventory,registry,blockdata){var chestCont;this.game=game;this.playerInventory=playerInventory;this.registry=registry;this.blockdata=blockdata;this.chestInventory=new Inventory(10,3);this.chestInventory.on("changed",function(_this){return function(){return _this.updateBlockdata()}}(this));this.chestIW=new InventoryWindow({inventory:this.chestInventory,registry:this.registry});this.chestIW.linkedInventory=this.playerInventory;chestCont=this.chestIW.createContainer();ChestDialog.__super__.constructor.call(this,game,{playerLinkedInventory:this.chestInventory,upper:[chestCont]})}ChestDialog.prototype.loadBlockdata=function(x,y,z){var bd,i,itemPile,newInventory,_i,_len,_ref;if(this.blockdata==null){console.log("voxel-blockdata not loaded, voxel-chest persistence disabled");return}bd=this.blockdata.get(x,y,z);console.log("activeBlockdata=",JSON.stringify(bd));if(bd!=null){console.log("load existing at ",x,y,z);newInventory=Inventory.fromString(bd.inventory);console.log("newInventory="+JSON.stringify(newInventory));_ref=newInventory.array;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){itemPile=_ref[i];console.log("load chest",i,itemPile);this.chestInventory.set(i,itemPile)}}else{console.log("new empty inventory at ",x,y,z);bd={inventory:this.chestInventory.toString()};this.blockdata.set(x,y,z,bd)}this.activeBlockdata=bd;return console.log("activeBlockdata 2=",JSON.stringify(this.activeBlockdata))};ChestDialog.prototype.open=function(target){var x,y,z,_ref;this.chestInventory.clear();_ref=target.voxel,x=_ref[0],y=_ref[1],z=_ref[2];this.loadBlockdata(x,y,z);return ChestDialog.__super__.open.call(this)};ChestDialog.prototype.updateBlockdata=function(){console.log("update with activeBlockdata=",JSON.stringify(this.activeBlockdata));if(this.activeBlockdata==null){return}console.log("chestInventory=",this.chestInventory.toString());return this.activeBlockdata.inventory=this.chestInventory.toString()};ChestDialog.prototype.close=function(){delete this.activeBlockdata;return ChestDialog.__super__.close.call(this)};return ChestDialog}(InventoryDialog)}).call(this)},{inventory:44,"inventory-window":38,itempile:49,"voxel-inventory-dialog":52}],38:[function(require,module,exports){var global=typeof self!=="undefined"?self:typeof window!=="undefined"?window:{};(function(){var CubeIcon,EventEmitter,InventoryWindow,ever,touchup,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__modulo=function(a,b){return(a%b+ +b)%b};EventEmitter=require("events").EventEmitter;ever=require("ever");CubeIcon=require("cube-icon");touchup=require("touchup");module.exports=InventoryWindow=function(_super){__extends(InventoryWindow,_super);function InventoryWindow(opts){var _ref,_ref1,_ref10,_ref11,_ref12,_ref13,_ref14,_ref15,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;if(opts==null){opts={}}this.inventory=function(){if((_ref=opts.inventory)!=null){return _ref}else{throw'inventory-window requires "inventory" option set to Inventory instance'}}();this.linkedInventory=opts.linkedInventory;this.getTexture=(_ref1=(_ref2=opts.getTexture)!=null?_ref2:InventoryWindow.defaultGetTexture)!=null?_ref1:global.InventoryWindow_defaultGetTexture;this.registry=opts.registry;if(this.getTexture==null&&this.registry==null){throw'inventory-window: required "getTexture" or "registry" option missing'}this.getMaxDamage=(_ref3=(_ref4=opts.getMaxDamage)!=null?_ref4:InventoryWindow.defaultGetMaxDamage)!=null?_ref3:global.InventoryWindow_defaultGetMaxDamage;this.inventorySize=(_ref5=opts.inventorySize)!=null?_ref5:this.inventory.size();this.width=(_ref6=opts.width)!=null?_ref6:this.inventory.width;this.textureScale=(_ref7=opts.textureScale)!=null?_ref7:5;this.textureScaleAlgorithm="nearest-neighbor";this.textureSrcPx=(_ref8=opts.textureSrcPx)!=null?_ref8:16;this.textureSize=(_ref9=opts.textureSize)!=null?_ref9:this.textureSrcPx*this.textureScale;this.borderSize=(_ref10=opts.borderSize)!=null?_ref10:4;this.progressThickness=(_ref11=opts.progressThickness)!=null?_ref11:10;this.secondaryMouseButton=(_ref12=opts.secondaryMouseButton)!=null?_ref12:2;this.allowDrop=(_ref13=opts.allowDrop)!=null?_ref13:true;this.allowPickup=(_ref14=opts.allowPickup)!=null?_ref14:true;this.allowDragPaint=(_ref15=opts.allowDragPaint)!=null?_ref15:true;this.progressColorsThresholds=opts.progressColorsThresholds!=null?opts.progressColorsThresholds:opts.progressColorsThresholds=[.2,.4,Infinity];this.progressColors=opts.progressColors!=null?opts.progressColors:opts.progressColors=["red","orange","green"];this.slotNodes=[];this.container=void 0;this.selectedIndex=void 0;this.enable()}InventoryWindow.prototype.enable=function(){if(typeof document!=="undefined"&&document!==null){ever(document).on("mousemove",function(_this){return function(ev){if(!global.InventoryWindow_heldNode){return}return _this.positionAtMouse(global.InventoryWindow_heldNode,ev)}}(this));ever(document).on("mouseup",function(_this){return function(ev){return global.InventoryWindow_mouseButtonDown=void 0}}(this))}return this.inventory.on("changed",function(_this){return function(){return _this.refresh()}}(this))};InventoryWindow.prototype.createContainer=function(){var container,i,node,slotItem,widthpx,_i,_ref;if(typeof document==="undefined"||document===null){return}container=document.createElement("div");for(i=_i=0,_ref=this.inventorySize;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){slotItem=this.inventory.get(i);node=this.createSlotNode(slotItem);this.setBorderStyle(node,i);this.bindSlotNodeEvent(node,i);this.slotNodes.push(node);container.appendChild(node)}widthpx=this.width*(this.textureSize+this.borderSize*2)+2*this.borderSize;container.setAttribute("style","display: block; float: left; width: "+widthpx+"px; -moz-user-select: none; -webkit-user-select: none; -ms-user-select: none;");return this.container=container};InventoryWindow.prototype.bindSlotNodeEvent=function(node,index){ever(node).on("mousedown",function(_this){return function(ev){return _this.clickSlot(index,ev)}}(this));return ever(node).on("mouseover",function(_this){return function(ev){if(!_this.allowDragPaint){return}if(!_this.allowDrop){return}if(global.InventoryWindow_heldItemPile==null){return}if(global.InventoryWindow_mouseButtonDown!==_this.secondaryMouseButton){return}_this.dropOneHeld(index);_this.createHeldNode(global.InventoryWindow_heldItemPile,ev);return _this.refreshSlotNode(index)}}(this))};InventoryWindow.prototype.createSlotNode=function(itemPile){var div;div=document.createElement("div");div.setAttribute("style","display: inline-block; float: inherit; margin: 0; padding: 0; width: "+this.textureSize+"px; height: "+this.textureSize+"px; font-size: 20pt; background-size: 100% auto; image-rendering: -moz-crisp-edges; image-rendering: -o-crisp-edges; image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; -ms-interpolation-mode: nearest-neighbor;");this.populateSlotNode(div,itemPile);return div};InventoryWindow.prototype.populateSlotNode=function(div,itemPile,isSelected){var cube,cubeNode,img,maxDamage,progress,progressColor,progressNode,setImage,src,text,textBox,_ref;src=void 0;text="";progress=void 0;progressColor=void 0;if(itemPile!=null){if(this.registry!=null){src=this.registry.getItemPileTexture(itemPile)}else if(this.getTexture!=null){src=this.getTexture(itemPile)}else{throw'inventory-window textures not specified, set global.InventoryWindow_defaultGetTexture or pass "getTexture" or "registry" option'}text=itemPile.count;if(text===1){text=""}if(text===Infinity){text=""}if(((_ref=itemPile.tags)!=null?_ref.damage:void 0)!=null){if(this.registry!=null){maxDamage=this.registry.getItemProps(itemPile.item).maxDamage}else if(this.getMaxDamage!=null){maxDamage=this.getMaxDamage(itemPile)}else{maxDamage=100}progress=(maxDamage-itemPile.tags.damage)/maxDamage;progressColor=this.getProgressBarColor(progress)}}setImage=function(src){var newImage;if(typeof src==="string"){newImage="url("+src+")"}else{newImage=""}if(global.InventoryWindow_resolvedImageURLs==null){global.InventoryWindow_resolvedImageURLs={}}if(global.InventoryWindow_resolvedImageURLs[newImage]!==div.style.backgroundImage){div.style.backgroundImage=newImage;return global.InventoryWindow_resolvedImageURLs[newImage]=div.style.backgroundImage
}};if(this.textureScaleAlgorithm!=null&&typeof src==="string"){img=new Image;img.onload=function(_this){return function(){return setImage(touchup.scale(img,_this.textureScale,_this.textureScale,_this.textureScaleAlgorithm))}}(this);img.src=src}else{setImage(src)}cubeNode=div.children[0];if(cubeNode==null){cubeNode=document.createElement("div");cubeNode.setAttribute("style","position: relative; z-index: 0;");div.appendChild(cubeNode)}while(cubeNode.firstChild){cubeNode.removeChild(cubeNode.firstChild)}if(Array.isArray(src)){cube=new CubeIcon({images:src});cubeNode.appendChild(cube.container)}textBox=div.children[1];if(textBox==null){textBox=document.createElement("div");textBox.setAttribute("style","position: absolute;");div.appendChild(textBox)}if(textBox.textContent!==text){textBox.textContent=text}progressNode=div.children[2];if(progressNode==null){progressNode=document.createElement("div");progressNode.setAttribute("style","width: 0%; top: "+(this.textureSize-this.borderSize*2)+"px; position: relative; visibility: hidden;");div.appendChild(progressNode)}if(progressColor!=null){progressNode.style.borderTop=""+this.progressThickness+"px solid "+progressColor}if(progress!=null){progressNode.style.width=progress*100+"%"}return progressNode.style.visibility=progress!=null?"":"hidden"};InventoryWindow.prototype.getProgressBarColor=function(progress){var i,threshold,_i,_len,_ref;_ref=this.progressColorsThresholds;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){threshold=_ref[i];if(progress<=threshold){return this.progressColors[i]}}return this.progressColors.slice(-1)[0]};InventoryWindow.prototype.setBorderStyle=function(node,index){var height,kind,x,y;x=__modulo(index,this.width);y=Math.floor(index/this.width);height=this.inventorySize/this.width;if(index===this.selectedIndex){kind="dotted"}else{kind="solid"}node.style.border=""+this.borderSize+"px "+kind+" black";if(y===0){node.style.borderTop=""+this.borderSize*2+"px "+kind+" black"}if(y===height-1){node.style.borderBottom=""+this.borderSize*2+"px "+kind+" black"}if(x===0){node.style.borderLeft=""+this.borderSize*2+"px "+kind+" black"}if(x===this.width-1){return node.style.borderRight=""+this.borderSize*2+"px "+kind+" black"}};InventoryWindow.prototype.setSelected=function(index){this.selectedIndex=index;return this.refresh()};InventoryWindow.prototype.getSelected=function(index){return this.selectedIndex};InventoryWindow.prototype.refreshSlotNode=function(index){this.populateSlotNode(this.slotNodes[index],this.inventory.get(index));return this.setBorderStyle(this.slotNodes[index],index)};InventoryWindow.prototype.refresh=function(){var i,_i,_ref,_results;_results=[];for(i=_i=0,_ref=this.inventorySize;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){_results.push(this.refreshSlotNode(i))}return _results};InventoryWindow.prototype.positionAtMouse=function(node,mouseEvent){var x,y,_ref,_ref1;x=(_ref=mouseEvent.x)!=null?_ref:mouseEvent.clientX;y=(_ref1=mouseEvent.y)!=null?_ref1:mouseEvent.clientY;x-=this.textureSize/2;y-=this.textureSize/2;node.style.left=x+"px";return node.style.top=y+"px"};InventoryWindow.prototype.createHeldNode=function(itemPile,ev){var style;if(global.InventoryWindow_heldNode){this.removeHeldNode()}if(!itemPile||itemPile.count===0){global.InventoryWindow_heldItemPile=void 0;return}global.InventoryWindow_heldItemPile=itemPile;global.InventoryWindow_heldNode=this.createSlotNode(global.InventoryWindow_heldItemPile);global.InventoryWindow_heldNode.setAttribute("style",style=global.InventoryWindow_heldNode.getAttribute("style")+"position: absolute; user-select: none; -moz-user-select: none; -webkit-user-select: none; pointer-events: none; z-index: 10;");this.positionAtMouse(global.InventoryWindow_heldNode,ev);return document.body.appendChild(global.InventoryWindow_heldNode)};InventoryWindow.prototype.removeHeldNode=function(){global.InventoryWindow_heldNode.parentNode.removeChild(global.InventoryWindow_heldNode);global.InventoryWindow_heldNode=void 0;return global.InventoryWindow_heldItemPile=void 0};InventoryWindow.prototype.dropOneHeld=function(index){var oneHeld,tmp;if(this.inventory.get(index)){oneHeld=global.InventoryWindow_heldItemPile.splitPile(1);if(this.inventory.get(index).mergePile(oneHeld)===false){global.InventoryWindow_heldItemPile.increase(1);tmp=global.InventoryWindow_heldItemPile;global.InventoryWindow_heldItemPile=this.inventory.get(index);return this.inventory.set(index,tmp)}else{return this.inventory.changed()}}else{return this.inventory.set(index,global.InventoryWindow_heldItemPile.splitPile(1))}};InventoryWindow.prototype.clickSlot=function(index,ev){var itemPile,shiftDown,tmp,_ref,_ref1;itemPile=this.inventory.get(index);console.log("clickSlot",index,itemPile);global.InventoryWindow_mouseButtonDown=ev.button;shiftDown=ev.shiftKey;if(ev.button!==this.secondaryMouseButton){if(!global.InventoryWindow_heldItemPile||!this.allowDrop){if(!this.allowPickup){return}if(global.InventoryWindow_heldItemPile!=null){if(this.inventory.get(index)!=null){if(!global.InventoryWindow_heldItemPile.canPileWith(this.inventory.get(index))){return}global.InventoryWindow_heldItemPile.mergePile(this.inventory.get(index))}}else{if(!shiftDown){global.InventoryWindow_heldItemPile=this.inventory.get(index);this.inventory.set(index,void 0)}else if(this.linkedInventory&&this.inventory.get(index)!=null){this.linkedInventory.give(this.inventory.get(index));if(this.inventory.get(index).count===0){this.inventory.set(index,void 0)}this.inventory.changed()}}this.emit("pickup")}else{if(this.inventory.get(index)){if(this.inventory.get(index).mergePile(global.InventoryWindow_heldItemPile)===false){tmp=global.InventoryWindow_heldItemPile;global.InventoryWindow_heldItemPile=this.inventory.get(index);this.inventory.set(index,tmp)}else{this.inventory.changed()}}else{this.inventory.set(index,global.InventoryWindow_heldItemPile);global.InventoryWindow_heldItemPile=void 0}}}else{if(!global.InventoryWindow_heldItemPile){if(!this.allowPickup){return}global.InventoryWindow_heldItemPile=(_ref=this.inventory.get(index))!=null?_ref.splitPile(.5):void 0;if(((_ref1=this.inventory.get(index))!=null?_ref1.count:void 0)===0){this.inventory.set(index,void 0)}this.inventory.changed();this.emit("pickup")}else{if(!this.allowDrop){return}this.dropOneHeld(index)}}this.createHeldNode(global.InventoryWindow_heldItemPile,ev);return this.refreshSlotNode(index)};return InventoryWindow}(EventEmitter)}).call(this)},{"cube-icon":39,events:507,ever:40,touchup:43}],39:[function(require,module,exports){(function(){var CubeIcon;module.exports=function(opts){return new CubeIcon(opts)};CubeIcon=function(){function CubeIcon(opts){var a,ch,cubeH,cubeW,cw,dz,face,faceFilters,faceName,faceTransforms,i,rotateX,rotateY,s,scale,shiftX,shiftY,showFaces,_i,_ignored,_ignoredB,_ignoredBack,_ignoredBottom,_ignoredRight,_len,_ref,_ref1,_ref2,_ref3,_ref4,_ref5;if(opts==null){opts={}}showFaces=(_ref=opts.showFaces)!=null?_ref:["left","top","front"];if(opts.images!=null&&Array.isArray(opts.images)){a=opts.images;if(a.length===0){opts.top=opts.side=""}if(a.length===1){opts.top=opts.side=a[0]}if(a.length===2){opts.top=a[0],opts.side=a[1]}if(a.length===3){opts.top=a[0],_ignored=a[1],opts.side=a[2]}if(a.length===4){opts.top=a[0],_ignoredB=a[1],opts.front=a[2],opts.left=a[3]}if(a.length===5){throw new Error("cube-icon images.length unrecognized 5")}if(a.length===6){_ignoredBack=a[0],opts.front=a[1],opts.top=a[2],_ignoredBottom=a[3],opts.left=a[4],_ignoredRight=a[5]}if(a.length>6){throw new Error("cube-icon requires images.length <= 6")}}if(opts.side!=null){opts.left=opts.front=opts.side}rotateX=(_ref1=opts.rotateX)!=null?_ref1:-30;rotateY=(_ref2=opts.rotateY)!=null?_ref2:45;scale=(_ref3=opts.scale)!=null?_ref3:3.55;s=(_ref4=opts.size)!=null?_ref4:16;this.container=document.createElement("div");cw=ch=90;cubeW=Math.floor(ch/(1-Math.sin(rotateX*Math.PI/180))-2);cubeH=Math.ceil(cw/(1+Math.cos(rotateY*Math.PI/180))+1);shiftX=cw-s*scale-5;shiftY=ch-s*scale+5;this.container.setAttribute("style","-webkit-transform: rotateX("+rotateX+"deg) rotateY("+rotateY+"deg) translateX("+shiftX+"px) translateY("+shiftY+"px) scale3d("+scale+","+scale+","+scale+"); transform: rotateX("+rotateX+"deg) rotateY("+rotateY+"deg) translateX("+shiftX+"px) translateY("+shiftY+"px) scale3d("+scale+","+scale+","+scale+"); -webkit-transform-origin: 0 0; transform-origin: 0 0; position: relative; -webkit-transform-style: preserve-3d; transform-style: preserve-3d;");dz=s/2;faceTransforms={front:"rotateY(   0deg ) translateZ( "+dz+"px )",back:"rotateX( 180deg ) translateZ( "+dz+"px )",right:"rotateY(  90deg ) translateZ( "+dz+"px )",left:"rotateY( -90deg ) translateZ( "+dz+"px )",top:"rotateX(  90deg ) translateZ( "+dz+"px )",bottom:"rotateX( -90deg ) translateZ( "+dz+"px )"};faceFilters=(_ref5=opts.faceFilters)!=null?_ref5:{front:"brightness(60%)",left:"brightness(100%)",top:"brightness(150%)"};for(i=_i=0,_len=showFaces.length;_i<_len;i=++_i){faceName=showFaces[i];face=document.createElement("div");face.setAttribute("style","-webkit-transform-style: preserve-3d; transform-style: preserve-3d; -webkit-transform: "+faceTransforms[faceName]+"; transform: "+faceTransforms[faceName]+"; position: absolute; border: 0.5px solid black; width: "+s+"px; height: "+s+"px;");face.style.backgroundImage="url("+opts[faceName]+")";if(faceFilters[faceName]){face.style.webkitFilter=faceFilters[faceName];face.style.filter=faceFilters[faceName]}this.container.style.webkitTransition="-webkit-transform 1s";this.container.style.transition="        transform 1s";this.container.appendChild(face)}}return CubeIcon}()}).call(this)},{}],40:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;module.exports=function(elem){return new Ever(elem)};function Ever(elem){this.element=elem}Ever.prototype=new EventEmitter;Ever.prototype.on=function(name,cb,useCapture){if(!this._events)this._events={};if(!this._events[name])this._events[name]=[];this._events[name].push(cb);this.element.addEventListener(name,cb,useCapture||false);return this};Ever.prototype.addListener=Ever.prototype.on;Ever.prototype.removeListener=function(type,listener,useCapture){if(!this._events)this._events={};this.element.removeEventListener(type,listener,useCapture||false);var xs=this.listeners(type);var ix=xs.indexOf(listener);if(ix>=0)xs.splice(ix,1);return this};Ever.prototype.removeAllListeners=function(type){var self=this;function removeAll(t){var xs=self.listeners(t);for(var i=0;i<xs.length;i++){self.removeListener(t,xs[i])}}if(type){removeAll(type)}else if(self._events){for(var key in self._events){if(key)removeAll(key)}}return EventEmitter.prototype.removeAllListeners.apply(self,arguments)};var initSignatures=require("./init.json");Ever.prototype.emit=function(name,ev){if(typeof name==="object"){ev=name;name=ev.type}if(!isEvent(ev)){var type=Ever.typeOf(name);var opts=ev||{};if(opts.type===undefined)opts.type=name;ev=document.createEvent(type+"s");var init=typeof ev["init"+type]==="function"?"init"+type:"initEvent";var sig=initSignatures[init];var used={};var args=[];for(var i=0;i<sig.length;i++){var key=sig[i];args.push(opts[key]);used[key]=true}ev[init].apply(ev,args);for(var key in opts){if(!used[key])ev[key]=opts[key]}}return this.element.dispatchEvent(ev)};function isEvent(ev){var s=Object.prototype.toString.call(ev);return/\[object \S+Event\]/.test(s)}Ever.types=require("./types.json");Ever.typeOf=function(){var types={};for(var key in Ever.types){var ts=Ever.types[key];for(var i=0;i<ts.length;i++){types[ts[i]]=key}}return function(name){return types[name]||"Event"}}()},{"./init.json":41,"./types.json":42,events:507}],41:[function(require,module,exports){module.exports={initEvent:["type","canBubble","cancelable"],initUIEvent:["type","canBubble","cancelable","view","detail"],initMouseEvent:["type","canBubble","cancelable","view","detail","screenX","screenY","clientX","clientY","ctrlKey","altKey","shiftKey","metaKey","button","relatedTarget"],initMutationEvent:["type","canBubble","cancelable","relatedNode","prevValue","newValue","attrName","attrChange"]}},{}],42:[function(require,module,exports){module.exports={MouseEvent:["click","mousedown","mouseup","mouseover","mousemove","mouseout"],KeyBoardEvent:["keydown","keyup","keypress"],MutationEvent:["DOMSubtreeModified","DOMNodeInserted","DOMNodeRemoved","DOMNodeRemovedFromDocument","DOMNodeInsertedIntoDocument","DOMAttrModified","DOMCharacterDataModified"],HTMLEvent:["load","unload","abort","error","select","change","submit","reset","focus","blur","resize","scroll"],UIEvent:["DOMFocusIn","DOMFocusOut","DOMActivate"]}},{}],43:[function(require,module,exports){(function(){var createCanvas,crop,overallSize,overlay,repeat,scale;createCanvas=function(w,h){var canvas,context;canvas=document.createElement("canvas");canvas.setAttribute("width",w);canvas.setAttribute("height",h);context=canvas.getContext("2d");return[canvas,context]};repeat=function(sourceImage,timesX,timesY){var canvas,context,destH,destW,pattern,_ref;destW=sourceImage.width*timesX;destH=sourceImage.height*timesY;_ref=createCanvas(destW,destH),canvas=_ref[0],context=_ref[1];pattern=context.createPattern(sourceImage,"repeat");context.fillStyle=pattern;context.fillRect(0,0,destW,destH);return canvas.toDataURL()};scale=function(sourceImage,scaleX,scaleY,algorithm){var canvas,context,destH,destW,_ref;destW=sourceImage.width*scaleX;destH=sourceImage.width*scaleY;_ref=createCanvas(destW,destH),canvas=_ref[0],context=_ref[1];if(algorithm==="nearest-neighbor"){context.imageSmoothingEnabled=false;context.webkitImageSmoothingEnabled=false;context.mozImageSmoothingEnabled=false}context.drawImage(sourceImage,0,0,destW,destH);return canvas.toDataURL()};crop=function(sourceImage,ox,oy,ow,oh){var canvas,context,destH,destW,sh,sw,sx,sy,_ref;sx=ox||0;sy=oy||0;destW=sourceImage.width-(ow||0)-sx;destH=sourceImage.height-(oh||0)-sy;sw=destW;sh=destH;_ref=createCanvas(destW,destH),canvas=_ref[0],context=_ref[1];console.log(sx,sy,sw,sh,0,0,destW,destH);context.drawImage(sourceImage,sx,sy,sw,sh,0,0,destW,destH);return canvas.toDataURL()};overallSize=function(sourceImages){var destH,destW,sourceImage,_i,_len;destW=destH=0;for(_i=0,_len=sourceImages.length;_i<_len;_i++){sourceImage=sourceImages[_i];if(sourceImage.width>destW){destW=sourceImage.width}if(sourceImage.height>destH){destH=sourceImage.height}}return[destW,destH]};overlay=function(sourceImages,operation,alpha){var canvas,context,destH,destW,sourceImage,_i,_len,_ref,_ref1;_ref=overallSize(sourceImages),destW=_ref[0],destH=_ref[1];_ref1=createCanvas(destW,destH),canvas=_ref1[0],context=_ref1[1];context.globalAlpha=alpha!=null?alpha:1;context.globalCompositeOperation=operation!=null?operation:"source-over";for(_i=0,_len=sourceImages.length;_i<_len;_i++){sourceImage=sourceImages[_i];context.drawImage(sourceImage,0,0)}return canvas.toDataURL()};module.exports={repeat:repeat,scale:scale,crop:crop,overlay:overlay}}).call(this)},{}],44:[function(require,module,exports){arguments[4][32][0].apply(exports,arguments)},{"deep-equal":45,events:507,itempile:46}],45:[function(require,module,exports){module.exports=require(30)},{}],46:[function(require,module,exports){module.exports=require(28)},{clone:47,"deep-equal":48}],47:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],48:[function(require,module,exports){module.exports=require(30)},{}],49:[function(require,module,exports){module.exports=require(28)},{clone:50,"deep-equal":51}],50:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],51:[function(require,module,exports){module.exports=require(30)},{}],52:[function(require,module,exports){(function(){var Inventory,InventoryDialog,InventoryWindow,ItemPile,ModalDialog,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};Inventory=require("inventory");InventoryWindow=require("inventory-window");ItemPile=require("itempile");ModalDialog=require("voxel-modal-dialog");module.exports=function(game,opts){return new InventoryDialog(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-recipes","voxel-carry","voxel-registry"]};module.exports.InventoryDialog=InventoryDialog=function(_super){__extends(InventoryDialog,_super);function InventoryDialog(game,opts){var contents,element,_i,_len,_ref,_ref1,_ref2,_ref3;this.game=game;if(!this.game.isClient){return}this.registry=function(){var _ref1;if((_ref=(_ref1=game.plugins)!=null?_ref1.get("voxel-registry"):void 0)!=null){return _ref}else{throw new Error('voxel-inventory-dialog requires "voxel-registry" plugin')}}();this.playerInventory=function(){var _ref2,_ref3,_ref4;if((_ref1=(_ref2=(_ref3=game.plugins)!=null?(_ref4=_ref3.get("voxel-carry"))!=null?_ref4.inventory:void 0:void 0)!=null?_ref2:opts.playerInventory)!=null){return _ref1}else{throw new Error('voxel-inventory-dialog requires "voxel-carry" plugin or playerInventory" set to inventory instance')}}();this.playerIW=new InventoryWindow({inventory:this.playerInventory,registry:this.registry,linkedInventory:opts.playerLinkedInventory});this.upper=document.createElement("div");_ref3=(_ref2=opts.upper)!=null?_ref2:[];for(_i=0,_len=_ref3.length;_i<_len;_i++){element=_ref3[_i];this.upper.appendChild(element)}contents=[];contents.push(this.upper);contents.push(document.createElement("br"));contents.push(this.playerIW.createContainer());InventoryDialog.__super__.constructor.call(this,game,{contents:contents,escapeKeys:[192,69]})}InventoryDialog.prototype.enable=function(){};InventoryDialog.prototype.disable=function(){};return InventoryDialog}(ModalDialog)}).call(this)},{inventory:59,"inventory-window":53,itempile:64,"voxel-modal-dialog":67}],53:[function(require,module,exports){arguments[4][38][0].apply(exports,arguments)},{"cube-icon":54,events:507,ever:55,touchup:58}],54:[function(require,module,exports){module.exports=require(39)},{}],55:[function(require,module,exports){module.exports=require(40)},{"./init.json":56,"./types.json":57,events:507}],56:[function(require,module,exports){module.exports=require(41)},{}],57:[function(require,module,exports){module.exports=require(42)},{}],58:[function(require,module,exports){module.exports=require(43)},{}],59:[function(require,module,exports){arguments[4][32][0].apply(exports,arguments)},{"deep-equal":60,events:507,itempile:61}],60:[function(require,module,exports){module.exports=require(30)},{}],61:[function(require,module,exports){module.exports=require(28)},{clone:62,"deep-equal":63}],62:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],63:[function(require,module,exports){module.exports=require(30)},{}],64:[function(require,module,exports){module.exports=require(28)},{clone:65,"deep-equal":66}],65:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],66:[function(require,module,exports){module.exports=require(30)},{}],67:[function(require,module,exports){(function(){var Modal,ModalDialog,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};Modal=require("voxel-modal");ModalDialog=function(_super){__extends(ModalDialog,_super);function ModalDialog(game,opts){var content,_i,_len,_ref;this.game=game;if(opts==null){opts={}}if(opts.contents==null){opts.contents=[]}if(typeof document!=="undefined"&&document!==null){this.box=document.createElement("div");this.box.style.border="6px outset gray";this.box.style.visibility="hidden";this.box.style.position="absolute";this.box.style.top="20%";this.box.style.left="30%";this.box.style.zIndex=1;this.box.style.backgroundImage="linear-gradient(rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.5) 100%)";_ref=opts.contents;for(_i=0,_len=_ref.length;_i<_len;_i++){content=_ref[_i];this.box.appendChild(content)}document.body.appendChild(this.box)}opts.element=this.box;ModalDialog.__super__.constructor.call(this,game,opts)}return ModalDialog}(Modal);module.exports=ModalDialog}).call(this)},{"voxel-modal":68}],68:[function(require,module,exports){"use strict";module.exports=Modal;var ever=require("ever");function Modal(game,opts){this.game=game;opts=opts||{};this.element=opts.element;if(!this.element)throw new Error('voxel-modal requires "element" option');this.escapeKeys=opts.escapeKeys||[192];this.isOpen=false}Modal.prototype.open=function(){if(this.isOpen)return;this.game.interact.release();var self=this;this.game.interact.on("attain",this.onAttain=function(){self.close()});ever(document.body).on("keydown",this.onKeydown=function(ev){if(self.escapeKeys.indexOf(ev.keyCode)!==-1){self.close();ev.preventDefault()}});this.element.style.visibility="";this.isOpen=true};Modal.prototype.close=function(){if(!this.isOpen)return;this.game.interact.removeListener("attain",this.onAttain);ever(document.body).removeListener("keydown",this.onKeydown);this.element.style.visibility="hidden";this.game.interact.request();this.isOpen=false};Modal.prototype.toggle=function(){if(this.isOpen)this.close();else this.open()}},{ever:69}],69:[function(require,module,exports){module.exports=require(40)},{"./init.json":70,"./types.json":71,events:507}],70:[function(require,module,exports){module.exports=require(41)},{}],71:[function(require,module,exports){module.exports=require(42)},{}],72:[function(require,module,exports){var Buffer=require("__browserify_Buffer");(function(){var ClientMC,decodePacket,ever,minecraft_protocol,popCount,tellraw2dom,websocket_stream,webworkify;websocket_stream=require("websocket-stream");minecraft_protocol=require("minecraft-protocol");ever=require("ever");webworkify=require("webworkify");tellraw2dom=require("tellraw2dom");popCount=require("bit-twiddle").popCount;module.exports=function(game,opts){return new ClientMC(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-land","voxel-player","voxel-registry","voxel-console"]};decodePacket=function(data){var buffer,id,name,payload,result;if(!(data instanceof Uint8Array)){return void 0}data._isBuffer=true;buffer=new Buffer(data);result=minecraft_protocol.protocol.parsePacket(buffer);if(!result||result.error){console.log("protocol parse error: "+JSON.stringify(result.error));return void 0}payload=result.results;id=result.results.id;name=minecraft_protocol.protocol.packetNames[minecraft_protocol.protocol.states.PLAY].toClient[id];return{name:name,id:id,payload:payload}};ClientMC=function(){function ClientMC(game,opts){var _base,_base1,_ref;this.game=game;this.opts=opts;this.registry=function(){var _ref1;if((_ref=(_ref1=this.game.plugins)!=null?_ref1.get("voxel-registry"):void 0)!=null){return _ref}else{throw new Error("voxel-clientmc requires voxel-registry plugin")}}.call(this);if((_base=this.opts).url==null){_base.url="ws://localhost:1234"}if((_base1=this.opts).mcBlocks==null){_base1.mcBlocks={0:"air",1:"stone",2:"grass",3:"dirt",4:"cobblestone",5:"plankOak",7:"obsidian",16:"oreCoal",17:"logOak",18:"leavesOak",161:"leavesOak",162:"logOak","default":"brick"}}this.mcPlayerHeight=1.74;this.enable()}ClientMC.prototype.enable=function(){var maxId,mcID,ourBlockID,ourBlockName,_i,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6;if((_ref=this.game.plugins)!=null){_ref.disable("voxel-land")}if((_ref1=this.game.plugins)!=null){_ref1.enable("voxel-fly")}this.ws=websocket_stream(this.opts.url,{type:Uint8Array});this.game.voxels.on("missingChunk",this.missingChunk.bind(this));this.voxelChunks={};this.ws.on("error",function(_this){return function(err){var _ref2;console.log("WebSocket error",err);return(_ref2=_this.game.plugins)!=null?_ref2.disable("voxel-clientmc"):void 0}}(this));this.ws.on("end",function(_this){return function(){var _ref2;console.log("WebSocket end");return(_ref2=_this.game.plugins)!=null?_ref2.disable("voxel-clientmc"):void 0}}(this));this.ws.on("data",function(_this){return function(data){var packet;packet=decodePacket(data);if(packet==null){return}return _this.handlePacket(packet.name,packet.payload)}}(this));if((_ref2=this.game.plugins)!=null){if((_ref3=_ref2.get("voxel-console"))!=null){if((_ref4=_ref3.widget)!=null){_ref4.on("input",this.onConsoleInput=function(_this){return function(text){return _this.sendChat(text)}}(this))}}}this.zlib_worker=webworkify(require("./zlib_worker.js"));ever(this.zlib_worker).on("message",this.onDecompressed.bind(this));this.packetPayloadsPending={};this.packetPayloadsNextID=0;maxId=255;this.translateBlockIDs=new this.game.arrayType(maxId);for(mcID=_i=0,_ref5=this.translateBlockIDs.length;0<=_ref5?_i<_ref5:_i>_ref5;mcID=0<=_ref5?++_i:--_i){this.translateBlockIDs[mcID]=this.registry.getBlockID(this.opts.mcBlocks["default"])}_ref6=this.opts.mcBlocks;for(mcID in _ref6){ourBlockName=_ref6[mcID];ourBlockID=this.registry.getBlockID(ourBlockName);if(ourBlockID==null){throw new Error("voxel-clientmc unrecognized block name: "+ourBlockName+" for MC "+mcID)}this.translateBlockIDs[mcID]=ourBlockID}this.chunkBits=Math.log(this.game.chunkSize)/Math.log(2);this.chunkBits|=0;return this.chunkMask=(1<<this.chunkBits)-1};ClientMC.prototype.disable=function(){var _ref;console.log("voxel-clientmc disablingd");this.game.voxels.removeListener("missingChunk",this.missingChunk);if((_ref=this.game.plugins)!=null){_ref.get("voxel-console").widget.removeListener("input",this.onConsoleInput)}this.ws.end();return typeof this.clearPositionUpdateTimer==="function"?this.clearPositionUpdateTimer():void 0};ClientMC.prototype.handlePacket=function(name,payload){var blockID,id,ourY,thisArrayBuffer,_ref,_ref1,_ref2;if(name==="map_chunk_bulk"){console.log("payload.data.compressedChunkData ",payload.data.compressedChunkData.length,payload.data.compressedChunkData);thisArrayBuffer=payload.data.compressedChunkData.buffer.slice(payload.data.compressedChunkData.byteOffset,payload.data.compressedChunkData.byteOffset+payload.data.compressedChunkData.length);id=this.packetPayloadsNextID;this.packetPayloadsPending[id]=payload.data;this.packetPayloadsNextID+=1;console.log("sending compressedBuffer ",thisArrayBuffer);return this.zlib_worker.postMessage({id:id,compressed:thisArrayBuffer},[thisArrayBuffer])}else if(name==="spawn_position"){console.log("Spawn at ",payload);if((_ref=this.game.plugins)!=null){_ref.get("voxel-player").moveTo(payload.x,payload.y,payload.z)}return this.setupPositionUpdates()}else if(name==="block_change"){console.log("block_change",payload);blockID=this.translateBlockIDs[payload.type];return this.game.setBlock([payload.x,payload.y,payload.z],blockID)}else if(name==="player_position"){console.log("player pos and look",payload);ourY=payload.y-1.62;if((_ref1=this.game.plugins)!=null){_ref1.get("voxel-player").moveTo(payload.x,ourY,payload.z)}return this.sendPacket("player_position",payload)}else if(name==="kicked"){return window.alert("Disconnected from server: "+payload.reason)}else if(name==="chat"){return(_ref2=this.game.plugins)!=null?_ref2.get("voxel-console").logNode(tellraw2dom(payload.message)):void 0}};ClientMC.prototype.sendChat=function(text){return this.sendPacket("chat_message",{message:text})};ClientMC.prototype.setupPositionUpdates=function(){return this.clearPositionUpdateTimer=this.game.setInterval(this.sendPositionUpdate.bind(this),50)};ClientMC.prototype.sendPositionUpdate=function(){var onGround,pos,stance,x,y,z,_ref;pos=(_ref=this.game.plugins)!=null?_ref.get("voxel-player").yaw.position:void 0;if(pos==null){return}x=pos.x;y=pos.y+1;z=pos.z;stance=y+this.mcPlayerHeight;onGround=true;return this.sendPacket("player_position",{x:x,y:y,z:z,stance:stance,onGround:onGround})};ClientMC.prototype.sendPacket=function(name,params){var data;data=minecraft_protocol.protocol.createPacketBuffer(name,params);return this.ws.write(data)};ClientMC.prototype.onDecompressed=function(ev){var i,id,inflated,meta,offset,payload,size,_i,_len,_ref;console.log("onDecompressed",ev);id=ev.data.id;payload=this.packetPayloadsPending[id];delete this.packetPayloadsPending[id];if(ev.data.err){console.log("received decompression error",ev.data.err," for ",ev.data.id);return}inflated=new Buffer(new Uint8Array(ev.data.decompressed));console.log("  decomp",id,inflated.length);offset=meta=size=0;_ref=payload.meta;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){meta=_ref[i];size=(8192+(payload.skyLightSent?2048:0))*popCount(meta.bitMap)+2048*popCount(meta.addBitMap)+256;this.addColumn({x:meta.x,z:meta.z,bitMap:meta.bitMap,addBitMap:meta.addBitMap,skyLightSent:payload.skyLightSent,groundUp:true,data:inflated.slice(offset,offset+size)});offset+=size}if(offset!==inflated.length){return console.log("incomplete chunk decode: "+offset+" != "+inflated.length)}};ClientMC.prototype.addColumn=function(args){var chunkX,chunkY,chunkZ,column,dx,dy,dz,mcBlockID,miniChunk,offset,ourBlockID,size,vchunkKey,vindex,x,y,z,_i,_results;chunkX=args.x;chunkZ=args.z;column=[];offset=0;size=4096;_results=[];for(chunkY=_i=0;_i<16;chunkY=++_i){if(args.bitMap&1<<chunkY){miniChunk=args.data.slice(offset,offset+size);offset+=size;_results.push(function(){var _j,_results1;_results1=[];for(dy=_j=0;_j<16;dy=++_j){y=chunkY*16+dy;_results1.push(function(){var _k,_results2;_results2=[];for(dz=_k=0;_k<16;dz=++_k){z=chunkZ*16+dz;_results2.push(function(){var _base,_l,_results3;_results3=[];for(dx=_l=0;_l<16;dx=++_l){x=chunkX*16+dx;mcBlockID=miniChunk[dx+dz*16+dy*16*16];vchunkKey=(x>>this.chunkBits)+"|"+(y>>this.chunkBits)+"|"+(z>>this.chunkBits);if((_base=this.voxelChunks)[vchunkKey]==null){_base[vchunkKey]=new this.game.arrayType(this.game.chunkSize*this.game.chunkSize*this.game.chunkSize)}ourBlockID=this.translateBlockIDs[mcBlockID];vindex=(x&this.chunkMask)+((y&this.chunkMask)<<this.chunkBits)+((z&this.chunkMask)<<this.chunkBits*2);_results3.push(this.voxelChunks[vchunkKey][vindex]=ourBlockID)}return _results3}.call(this))}return _results2}.call(this))}return _results1}.call(this))}else{}}return _results};ClientMC.prototype.missingChunk=function(pos){var chunk,voxels;voxels=this.voxelChunks[pos.join("|")];if(voxels==null){return}chunk={position:pos,dims:[this.game.chunkSize,this.game.chunkSize,this.game.chunkSize],voxels:voxels};return this.game.showChunk(chunk)};return ClientMC}()}).call(this)},{"./zlib_worker.js":87,__browserify_Buffer:509,"bit-twiddle":73,ever:74,"minecraft-protocol":77,tellraw2dom:79,"websocket-stream":80,webworkify:84}],73:[function(require,module,exports){"use strict";"use restrict";var INT_BITS=32;exports.INT_BITS=INT_BITS;exports.INT_MAX=2147483647;exports.INT_MIN=-1<<INT_BITS-1;exports.sign=function(v){return(v>0)-(v<0)};exports.abs=function(v){var mask=v>>INT_BITS-1;return(v^mask)-mask};exports.min=function(x,y){return y^(x^y)&-(x<y)};exports.max=function(x,y){return x^(x^y)&-(x<y)};exports.isPow2=function(v){return!(v&v-1)&&!!v};exports.log2=function(v){var r,shift;r=(v>65535)<<4;v>>>=r;shift=(v>255)<<3;v>>>=shift;r|=shift;shift=(v>15)<<2;v>>>=shift;r|=shift;shift=(v>3)<<1;v>>>=shift;r|=shift;return r|v>>1};exports.log10=function(v){return v>=1e9?9:v>=1e8?8:v>=1e7?7:v>=1e6?6:v>=1e5?5:v>=1e4?4:v>=1e3?3:v>=100?2:v>=10?1:0};exports.popCount=function(v){v=v-(v>>>1&1431655765);v=(v&858993459)+(v>>>2&858993459);return(v+(v>>>4)&252645135)*16843009>>>24};function countTrailingZeros(v){var c=32;v&=-v;if(v)c--;if(v&65535)c-=16;if(v&16711935)c-=8;if(v&252645135)c-=4;if(v&858993459)c-=2;if(v&1431655765)c-=1;return c}exports.countTrailingZeros=countTrailingZeros;exports.nextPow2=function(v){v+=v===0;--v;v|=v>>>1;v|=v>>>2;v|=v>>>4;v|=v>>>8;v|=v>>>16;return v+1};exports.prevPow2=function(v){v|=v>>>1;v|=v>>>2;v|=v>>>4;v|=v>>>8;v|=v>>>16;return v-(v>>>1)};exports.parity=function(v){v^=v>>>16;v^=v>>>8;v^=v>>>4;v&=15;return 27030>>>v&1};var REVERSE_TABLE=new Array(256);(function(tab){for(var i=0;i<256;++i){var v=i,r=i,s=7;
for(v>>>=1;v;v>>>=1){r<<=1;r|=v&1;--s}tab[i]=r<<s&255}})(REVERSE_TABLE);exports.reverse=function(v){return REVERSE_TABLE[v&255]<<24|REVERSE_TABLE[v>>>8&255]<<16|REVERSE_TABLE[v>>>16&255]<<8|REVERSE_TABLE[v>>>24&255]};exports.interleave2=function(x,y){x&=65535;x=(x|x<<8)&16711935;x=(x|x<<4)&252645135;x=(x|x<<2)&858993459;x=(x|x<<1)&1431655765;y&=65535;y=(y|y<<8)&16711935;y=(y|y<<4)&252645135;y=(y|y<<2)&858993459;y=(y|y<<1)&1431655765;return x|y<<1};exports.deinterleave2=function(v,n){v=v>>>n&1431655765;v=(v|v>>>1)&858993459;v=(v|v>>>2)&252645135;v=(v|v>>>4)&16711935;v=(v|v>>>16)&65535;return v<<16>>16};exports.interleave3=function(x,y,z){x&=1023;x=(x|x<<16)&4278190335;x=(x|x<<8)&251719695;x=(x|x<<4)&3272356035;x=(x|x<<2)&1227133513;y&=1023;y=(y|y<<16)&4278190335;y=(y|y<<8)&251719695;y=(y|y<<4)&3272356035;y=(y|y<<2)&1227133513;x|=y<<1;z&=1023;z=(z|z<<16)&4278190335;z=(z|z<<8)&251719695;z=(z|z<<4)&3272356035;z=(z|z<<2)&1227133513;return x|z<<2};exports.deinterleave3=function(v,n){v=v>>>n&1227133513;v=(v|v>>>2)&3272356035;v=(v|v>>>4)&251719695;v=(v|v>>>8)&4278190335;v=(v|v>>>16)&1023;return v<<22>>22};exports.nextCombination=function(v){var t=v|v-1;return t+1|(~t&-~t)-1>>>countTrailingZeros(v)+1}},{}],74:[function(require,module,exports){module.exports=require(40)},{"./init.json":75,"./types.json":76,events:507}],75:[function(require,module,exports){module.exports=require(41)},{}],76:[function(require,module,exports){module.exports=require(42)},{}],77:[function(require,module,exports){module.exports={protocol:require("./lib/protocol")}},{"./lib/protocol":78}],78:[function(require,module,exports){var process=require("__browserify_process"),Buffer=require("__browserify_Buffer");var assert=require("assert");var util=require("util");var STRING_MAX_LENGTH=240;var SRV_STRING_MAX_LENGTH=32767;var states={HANDSHAKING:"handshaking",STATUS:"status",LOGIN:"login",PLAY:"play"};var packetIDs={handshaking:{toClient:{},toServer:{handshake:0}},status:{toClient:{status_response:0,status_ping:1},toServer:{status_request:0,status_ping:1}},login:{toClient:{login_disconnect:0,encryption_request:1,login_success:2},toServer:{login_start:0,encryption_response:1}},play:{toClient:{keep_alive:0,join_game:1,chat:2,time_update:3,entity_equipment:4,spawn_position:5,update_health:6,respawn:7,player_position:8,held_item_change:9,use_bed:10,animation:11,spawn_player:12,collect_item:13,spawn_object:14,spawn_mob:15,spawn_painting:16,spawn_experience_orb:17,entity_velocity:18,destroy_entities:19,entity:20,entity_relative_move:21,entity_look:22,entity_look_and_relative_move:23,entity_teleport:24,entity_head_look:25,entity_status:26,attach_entity:27,entity_metadata:28,entity_effect:29,remove_entity_effect:30,set_experience:31,entity_properties:32,chunk_data:33,multi_block_change:34,block_change:35,block_action:36,block_break_anim:37,map_chunk_bulk:38,explosion:39,effect:40,sound_effect:41,particle:42,change_game_state:43,spawn_global_entity:44,open_window:45,close_window:46,set_slot:47,window_items:48,window_property:49,confirm_transaction:50,update_sign:51,maps:52,update_block_entity:53,sign_editor_open:54,statistics:55,player_list_item:56,player_abilities:57,tab_complete:58,scoreboard_objective:59,update_score:60,display_scoreboard:61,teams:62,plugin_message:63,disconnect:64},toServer:{keep_alive:0,chat_message:1,use_entity:2,player:3,player_position:4,player_look:5,player_position_and_look:6,player_digging:7,player_block_placement:8,held_item_change:9,animation:10,entity_action:11,steer_vehicle:12,close_window:13,click_window:14,confirm_transaction:15,creative_inventory_action:16,enchant_item:17,update_sign:18,player_abilities:19,tab_complete:20,client_settings:21,client_status:22,plugin_message:23}}};var packetStates={};var packetNames=function(){var ret={};for(var stateName in states){var state=states[stateName];ret[state]={toClient:[],toServer:[]};["toClient","toServer"].forEach(function(direction){for(var name in packetIDs[state][direction]){var id=packetIDs[state][direction][name];ret[state][direction][id]=name;packetStates[name]=state}})}return ret}();var packets={handshaking:{toClient:{},toServer:{handshake:{id:0,fields:[{name:"protocolVersion",type:"varint"},{name:"serverHost",type:"string"},{name:"serverPort",type:"ushort"},{name:"nextState",type:"varint"}]}}},status:{toClient:{status_response:{id:0,fields:[{name:"response",type:"string"}]},status_ping:{id:1,fields:[{name:"time",type:"long"}]}},toServer:{status_request:{id:0,fields:[]},status_ping:{id:1,fields:[{name:"time",type:"long"}]}}},login:{toClient:{login_disconnect:{id:0,fields:[{name:"reason",type:"string"}]},encryption_request:{id:1,fields:[{name:"serverId",type:"string"},{name:"publicKey",type:"byteArray16"},{name:"verifyToken",type:"byteArray16"}]},login_success:{id:2,fields:[{name:"uuid",type:"string"},{name:"username",type:"string"}]}},toServer:{login_start:{id:0,fields:[{name:"username",type:"string"}]},encryption_response:{id:1,fields:[{name:"sharedSecret",type:"byteArray16"},{name:"verifyToken",type:"byteArray16"}]}}},play:{toClient:{keep_alive:{id:0,fields:[{name:"keepAliveId",type:"int"}]},join_game:{id:1,fields:[{name:"entityId",type:"int"},{name:"gameMode",type:"ubyte"},{name:"dimension",type:"byte"},{name:"difficulty",type:"ubyte"},{name:"maxPlayers",type:"ubyte"},{name:"levelType",type:"string"}]},chat:{id:2,fields:[{name:"message",type:"ustring"}]},time_update:{id:3,fields:[{name:"age",type:"long"},{name:"time",type:"long"}]},entity_equipment:{id:4,fields:[{name:"entityId",type:"int"},{name:"slot",type:"short"}]},spawn_position:{id:5,fields:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]},update_health:{id:6,fields:[{name:"health",type:"float"},{name:"food",type:"short"},{name:"foodSaturation",type:"float"}]},respawn:{id:7,fields:[{name:"dimension",type:"int"},{name:"difficulty",type:"ubyte"},{name:"gamemode",type:"ubyte"},{name:"levelType",type:"string"}]},player_position:{id:8,fields:[{name:"x",type:"double"},{name:"y",type:"double"},{name:"z",type:"double"},{name:"yaw",type:"float"},{name:"pitch",type:"float"},{name:"onGround",type:"bool"}]},held_item_change:{id:9,fields:[{name:"slot",type:"byte"}]},use_bed:{id:10,fields:[{name:"entityId",type:"int"},{name:"x",type:"int"},{name:"y",type:"ubyte"},{name:"z",type:"int"}]},animation:{id:11,fields:[{name:"entityId",type:"varint"},{name:"animation",type:"byte"}]},spawn_player:{id:12,fields:[{name:"entityId",type:"varint"},{name:"playerUUID",type:"string"},{name:"playerName",type:"string"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"yaw",type:"byte"},{name:"pitch",type:"byte"},{name:"currentItem",type:"short"},{name:"metadata",type:"entityMetadata"}]},collect_item:{id:13,fields:[{name:"collectedEntityId",type:"int"},{name:"collectorEntityId",type:"int"}]},spawn_object:{id:14,fields:[{name:"entityId",type:"varint"},{name:"type",type:"byte"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"pitch",type:"byte"},{name:"yaw",type:"byte"},{name:"objectData",type:"objectData"}]},spawn_mob:{id:15,fields:[{name:"entityId",type:"varint"},{name:"type",type:"ubyte"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"pitch",type:"byte"},{name:"headPitch",type:"byte"},{name:"yaw",type:"byte"},{name:"velocityX",type:"short"},{name:"velocityY",type:"short"},{name:"velocityZ",type:"short"},{name:"metadata",type:"entityMetadata"}]},spawn_painting:{id:16,fields:[{name:"entityId",type:"varint"},{name:"title",type:"string"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"direction",type:"int"}]},spawn_experience_orb:{id:17,fields:[{name:"entityId",type:"varint"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"count",type:"short"}]},entity_velocity:{id:18,fields:[{name:"entityId",type:"int"},{name:"velocityX",type:"short"},{name:"velocityY",type:"short"},{name:"velocityZ",type:"short"}]},destroy_entities:{id:19,fields:[{name:"entityIds",type:"intArray8"}]},entity:{id:20,fields:[{name:"entityId",type:"int"}]},entity_relative_move:{id:21,fields:[{name:"entityId",type:"int"},{name:"dX",type:"byte"},{name:"dY",type:"byte"},{name:"dZ",type:"byte"}]},entity_look:{id:22,fields:[{name:"entityId",type:"int"},{name:"yaw",type:"byte"},{name:"pitch",type:"byte"}]},entity_look_and_relative_move:{id:23,fields:[{name:"entityId",type:"int"},{name:"dX",type:"byte"},{name:"dY",type:"byte"},{name:"dZ",type:"byte"},{name:"yaw",type:"byte"},{name:"pitch",type:"byte"}]},entity_teleport:{id:24,fields:[{name:"entityId",type:"int"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"yaw",type:"byte"},{name:"pitch",type:"byte"}]},entity_head_look:{id:25,fields:[{name:"entityId",type:"int"},{name:"headYaw",type:"byte"}]},entity_status:{id:26,fields:[{name:"entityId",type:"int"},{name:"entityStatus",type:"byte"}]},attach_entity:{id:27,fields:[{name:"entityId",type:"int"},{name:"vehicleId",type:"int"},{name:"leash",type:"bool"}]},entity_metadata:{id:28,fields:[{name:"entityId",type:"int"},{name:"metadata",type:"entityMetadata"}]},entity_effect:{id:29,fields:[{name:"entityId",type:"int"},{name:"effectId",type:"byte"},{name:"amplifier",type:"byte"},{name:"duration",type:"short"}]},remove_entity_effect:{id:30,fields:[{name:"entityId",type:"int"},{name:"effectId",type:"byte"}]},set_experience:{id:31,fields:[{name:"experienceBar",type:"float"},{name:"level",type:"short"},{name:"totalExperience",type:"short"}]},entity_properties:{id:32,fields:[{name:"entityId",type:"int"},{name:"properties",type:"propertyArray"}]},chunk_data:{id:33,fields:[{name:"x",type:"int"},{name:"z",type:"int"},{name:"groundUp",type:"bool"},{name:"bitMap",type:"ushort"},{name:"addBitMap",type:"ushort"},{name:"compressedChunkData",type:"byteArray32"}]},multi_block_change:{id:34,fields:[{name:"chunkX",type:"int"},{name:"chunkZ",type:"int"},{name:"recordCount",type:"short"},{name:"data",type:"byteArray32"}]},block_change:{id:35,fields:[{name:"x",type:"int"},{name:"y",type:"ubyte"},{name:"z",type:"int"},{name:"type",type:"varint"},{name:"metadata",type:"ubyte"}]},block_action:{id:36,fields:[{name:"x",type:"int"},{name:"y",type:"short"},{name:"z",type:"int"},{name:"byte1",type:"ubyte"},{name:"byte2",type:"ubyte"},{name:"blockId",type:"varint"}]},block_break_anim:{id:37,fields:[{name:"entityId",type:"varint"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"destroyStage",type:"byte"}]},map_chunk_bulk:{id:38,fields:[{name:"data",type:"mapChunkBulk"}]},explosion:{id:39,fields:[{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"},{name:"radius",type:"float"},{name:"affectedBlockOffsets",type:"byteVectorArray"},{name:"playerMotionX",type:"float"},{name:"playerMotionY",type:"float"},{name:"playerMotionZ",type:"float"}]},effect:{id:40,fields:[{name:"effectId",type:"int"},{name:"x",type:"int"},{name:"y",type:"byte"},{name:"z",type:"int"},{name:"data",type:"int"},{name:"global",type:"bool"}]},sound_effect:{id:41,fields:[{name:"soundName",type:"string"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"volume",type:"float"},{name:"pitch",type:"ubyte"}]},particle:{id:42,fields:[{name:"particleName",type:"string"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"},{name:"offsetX",type:"float"},{name:"offsetY",type:"float"},{name:"offsetZ",type:"float"},{name:"particleSpeed",type:"float"},{name:"particles",type:"int"}]},change_game_state:{id:43,fields:[{name:"reason",type:"ubyte"},{name:"gameMode",type:"float"}]},spawn_global_entity:{id:44,fields:[{name:"entityId",type:"varint"},{name:"type",type:"byte"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]},open_window:{id:45,fields:[{name:"windowId",type:"ubyte"},{name:"inventoryType",type:"ubyte"},{name:"windowTitle",type:"string"},{name:"slotCount",type:"ubyte"},{name:"useProvidedTitle",type:"bool"},{name:"entityId",type:"int",condition:function(field_values){return field_values["inventoryType"]==11}}]},close_window:{id:46,fields:[{name:"windowId",type:"ubyte"}]},set_slot:{id:47,fields:[{name:"windowId",type:"ubyte"},{name:"slot",type:"short"},{name:"item",type:"slot"}]},window_items:{id:48,fields:[{name:"windowId",type:"ubyte"},{name:"items",type:"slotArray"}]},window_property:{id:49,fields:[{name:"windowId",type:"ubyte"},{name:"property",type:"short"},{name:"value",type:"short"}]},confirm_transaction:{id:50,fields:[{name:"windowId",type:"ubyte"},{name:"action",type:"short"},{name:"accepted",type:"bool"}]},update_sign:{id:51,fields:[{name:"x",type:"int"},{name:"y",type:"short"},{name:"z",type:"int"},{name:"text1",type:"string"},{name:"text2",type:"string"},{name:"text3",type:"string"},{name:"text4",type:"string"}]},maps:{id:52,fields:[{name:"itemDamage",type:"varint"},{name:"data",type:"byteArray16"}]},update_block_entity:{id:53,fields:[{name:"x",type:"int"},{name:"y",type:"short"},{name:"z",type:"int"},{name:"action",type:"ubyte"},{name:"nbtData",type:"byteArray16"}]},sign_editor_open:{id:54,fields:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]},statistics:{id:55,fields:[{name:"count",type:"statisticArray"}]},player_list_item:{id:56,fields:[{name:"playerName",type:"string"},{name:"online",type:"bool"},{name:"ping",type:"short"}]},player_abilities:{id:57,fields:[{name:"flags",type:"byte"},{name:"flyingSpeed",type:"float"},{name:"walkingSpeed",type:"float"}]},tab_complete:{id:58,fields:[{name:"matches",type:"matchArray"}]},scoreboard_objective:{id:59,fields:[{name:"name",type:"string"},{name:"displayText",type:"string"},{name:"action",type:"byte"}]},update_score:{id:60,fields:[{name:"itemName",type:"string"},{name:"remove",type:"bool"},{name:"scoreName",type:"string",condition:function(field_values){return!field_values["remove"]}},{name:"value",type:"int",condition:function(field_values){return!field_values["remove"]}}]},display_scoreboard:{id:61,fields:[{name:"position",type:"byte"},{name:"name",type:"string"}]},teams:{id:62,fields:[{name:"team",type:"string"},{name:"mode",type:"byte"},{name:"name",type:"string",condition:function(field_values){return field_values["mode"]==0||field_values["mode"]==2}},{name:"prefix",type:"string",condition:function(field_values){return field_values["mode"]==0||field_values["mode"]==2}},{name:"suffix",type:"string",condition:function(field_values){return field_values["mode"]==0||field_values["mode"]==2}},{name:"friendlyFire",type:"byte",condition:function(field_values){return field_values["mode"]==0||field_values["mode"]==2}},{name:"players",type:"stringArray",condition:function(field_values){return field_values["mode"]==0||field_values["mode"]==3||field_values["mode"]==4}}]},plugin_message:{id:63,fields:[{name:"channel",type:"string"},{name:"data",type:"byteArray16"}]},kicked:{id:64,fields:[{name:"reason",type:"string"}]}},toServer:{keep_alive:{id:0,fields:[{name:"keepAliveId",type:"int"}]},chat_message:{id:1,fields:[{name:"message",type:"string"}]},use_entity:{id:2,fields:[{name:"target",type:"int"},{name:"leftClick",type:"byte"}]},player:{id:3,fields:[{name:"onGround",type:"bool"}]},player_position:{id:4,fields:[{name:"x",type:"double"},{name:"stance",type:"double"},{name:"y",type:"double"},{name:"z",type:"double"},{name:"onGround",type:"bool"}]},player_look:{id:5,fields:[{name:"yaw",type:"float"},{name:"pitch",type:"float"},{name:"onGround",type:"bool"}]},player_position_and_look:{id:6,fields:[{name:"x",type:"double"},{name:"stance",type:"double"},{name:"y",type:"double"},{name:"z",type:"double"},{name:"yaw",type:"float"},{name:"pitch",type:"float"},{name:"onGround",type:"bool"}]},player_digging:{id:7,fields:[{name:"status",type:"byte"},{name:"x",type:"int"},{name:"y",type:"ubyte"},{name:"z",type:"int"},{name:"face",type:"byte"}]},player_block_placement:{id:8,fields:[{name:"x",type:"int"},{name:"y",type:"ubyte"},{name:"z",type:"int"},{name:"direction",type:"byte"},{name:"heldItem",type:"slot"},{name:"cursorX",type:"byte"},{name:"cursorY",type:"byte"},{name:"cursorZ",type:"byte"}]},held_item_change:{id:9,fields:[{name:"slotId",type:"short"}]},animation:{id:10,fields:[{name:"entityId",type:"int"},{name:"animation",type:"byte"}]},entity_action:{id:11,fields:[{name:"entityId",type:"int"},{name:"actionId",type:"byte"},{name:"jumpBoost",type:"int"}]},steer_vehicle:{id:12,fields:[{name:"sideways",type:"float"},{name:"forward",type:"float"},{name:"jump",type:"bool"},{name:"unmount",type:"bool"}]},close_window:{id:13,fields:[{name:"windowId",type:"byte"}]},click_window:{id:14,fields:[{name:"windowId",type:"byte"},{name:"slot",type:"short"},{name:"mouseButton",type:"byte"},{name:"action",type:"short"},{name:"mode",type:"byte"},{name:"item",type:"slot"}]},confirm_transaction:{id:15,fields:[{name:"windowId",type:"byte"},{name:"action",type:"short"},{name:"accepted",type:"bool"}]},creative_inventory_action:{id:16,fields:[{name:"slot",type:"short"},{name:"item",type:"slot"}]},enchant_item:{id:17,fields:[{name:"windowId",type:"byte"},{name:"enchantment",type:"byte"}]},update_sign:{id:18,fields:[{name:"x",type:"int"},{name:"y",type:"short"},{name:"z",type:"int"},{name:"text1",type:"string"},{name:"text2",type:"string"},{name:"text3",type:"string"},{name:"text4",type:"string"}]},player_abilities:{id:19,fields:[{name:"flags",type:"byte"},{name:"flyingSpeed",type:"float"},{name:"walkingSpeed",type:"float"}]},tab_complete:{id:20,fields:[{name:"text",type:"string"}]},client_settings:{id:21,fields:[{name:"locale",type:"string"},{name:"viewDistance",type:"byte"},{name:"chatFlags",type:"byte"},{name:"chatColors",type:"bool"},{name:"difficulty",type:"byte"},{name:"showCape",type:"bool"}]},client_status:{id:22,fields:[{name:"payload",type:"byte"}]},plugin_message:{id:23,fields:[{name:"channel",type:"string"},{name:"data",type:"byteArray16"}]}}}};var packetFields={};var packetNames={};var packetIds={};var packetStates={toClient:{},toServer:{}};(function(){for(var stateName in states){var state=states[stateName];packetFields[state]={toClient:[],toServer:[]};packetNames[state]={toClient:[],toServer:[]};packetIds[state]={toClient:[],toServer:[]};["toClient","toServer"].forEach(function(direction){for(var name in packets[state][direction]){var info=packets[state][direction][name];var id=info.id;var fields=info.fields;assert(id!==undefined,"missing id for packet "+name);assert(fields!==undefined,"missing fields for packet "+name);assert(packetNames[state][direction][id]===undefined,"duplicate packet id "+id+" for "+name);assert(packetIds[state][direction][name]===undefined,"duplicate packet name "+name+" for "+id);assert(packetFields[state][direction][id]===undefined,"duplicate packet id "+id+" for "+name);assert(packetStates[direction][name]===undefined,"duplicate packet name "+name+" for "+id+", must be unique across all states");packetNames[state][direction][id]=name;packetIds[state][direction][name]=id;packetFields[state][direction][id]=fields;packetStates[direction][name]=state}})}})();var types={"int":[readInt,writeInt,4],"short":[readShort,writeShort,2],ushort:[readUShort,writeUShort,2],"byte":[readByte,writeByte,1],ubyte:[readUByte,writeUByte,1],string:[readString,writeString,sizeOfString],ustring:[readString,writeString,sizeOfUString],byteArray16:[readByteArray16,writeByteArray16,sizeOfByteArray16],bool:[readBool,writeBool,1],"double":[readDouble,writeDouble,8],"float":[readFloat,writeFloat,4],slot:[readSlot,writeSlot,sizeOfSlot],"long":[readLong,writeLong,8],varint:[readVarInt,writeVarInt,sizeOfVarInt],ascii:[readAscii,writeAscii,sizeOfAscii],entityMetadata:[readEntityMetadata,writeEntityMetadata,sizeOfEntityMetadata],byteArray32:[readByteArray32,writeByteArray32,sizeOfByteArray32],slotArray:[readSlotArray,writeSlotArray,sizeOfSlotArray],mapChunkBulk:[readMapChunkBulk,writeMapChunkBulk,sizeOfMapChunkBulk],objectData:[readObjectData,writeObjectData,sizeOfObjectData],intArray8:[readIntArray8,writeIntArray8,sizeOfIntArray8],intVector:[readIntVector,writeIntVector,12],byteVector:[readByteVector,writeByteVector,3],byteVectorArray:[readByteVectorArray,writeByteVectorArray,sizeOfByteVectorArray],stringArray:[readStringArray,writeStringArray,sizeOfStringArray],UUID:[readUUID,writeUUID,16],propertyArray:[readPropertyArray,writePropertyArray,sizeOfPropertyArray],statisticArray:[readStatisticArray,writeStatisticArray,sizeOfStatisticArray],matchArray:[readMatchArray,writeMatchArray,sizeOfMatchArray]};var debug;if(process.env.NODE_DEBUG&&/(minecraft-protocol|mc-proto)/.test(process.env.NODE_DEBUG)){var pid=process.pid;debug=function(x){if(!console.error)return;console.error("MC-PROTO: %d",pid,util.format.apply(util,arguments).slice(0,500))}}else{debug=function(){}}function sizeOfByteArray32(value){return 4+value.length}function writeByteArray32(value,buffer,offset){buffer.writeInt32BE(value.length,offset);value.copy(buffer,offset+4);return offset+4+value.length}function sizeOfSlotArray(value){var size=2;for(var i=0;i<value.length;++i){size+=sizeOfSlot(value[i])}return size}function writeSlotArray(value,buffer,offset){buffer.writeInt16BE(value.length,offset);offset+=2;value.forEach(function(slot){offset=writeSlot(slot,buffer,offset)});return offset}var entityMetadataTypes={0:"byte",1:"short",2:"int",3:"float",4:"string",5:"slot",6:"intVector"};var entityMetadataTypeBytes={};for(var n in entityMetadataTypes){if(!entityMetadataTypes.hasOwnProperty(n))continue;entityMetadataTypeBytes[entityMetadataTypes[n]]=n}function sizeOfEntityMetadata(value){var size=1+value.length;var item;for(var i=0;i<value.length;++i){item=value[i];size+=sizeOf(item.type,item.value)}return size}function writeEntityMetadata(value,buffer,offset){value.forEach(function(item){var type=entityMetadataTypeBytes[item.type];var headerByte=type<<5|item.key;buffer.writeUInt8(headerByte,offset);offset+=1;offset=types[item.type][1](item.value,buffer,offset)});buffer.writeUInt8(127,offset);return offset+1}function sizeOfObjectData(value){return value.intField===0?4:10}function writeObjectData(value,buffer,offset){buffer.writeInt32BE(value.intField,offset);if(value.intField===0)return-1;offset+=4;buffer.writeInt16BE(value.velocityX,offset);offset+=2;buffer.writeInt16BE(value.velocityY,offset);offset+=2;buffer.writeInt16BE(value.velocityZ,offset);return offset+2}function sizeOfMapChunkBulk(value){return 7+value.compressedChunkData.length+12*value.meta.length}function writeMapChunkBulk(value,buffer,offset){buffer.writeInt16BE(value.meta.length,offset);offset+=2;buffer.writeInt32BE(value.compressedChunkData.length,offset);offset+=4;buffer.writeInt8(+value.skyLightSent,offset);offset+=1;value.compressedChunkData.copy(buffer,offset);offset+=value.compressedChunkData.length;var meta;for(var i=0;i<value.meta.length;++i){meta=value.meta[i];buffer.writeInt32BE(meta.x,offset);offset+=4;buffer.writeInt32BE(meta.z,offset);offset+=4;buffer.writeUInt16BE(meta.bitMap,offset);offset+=2;buffer.writeUInt16BE(meta.addBitMap,offset);offset+=2}return offset}function sizeOfIntArray8(value){return 1+4*value.length}function writeIntArray8(value,buffer,offset){buffer.writeInt8(value.length,offset);offset+=1;value.forEach(function(item){buffer.writeInt32BE(item,offset);offset+=4});return offset}function writeIntVector(value,buffer,offset){buffer.writeInt32BE(value.x,offset);buffer.writeInt32BE(value.y,offset+4);buffer.writeInt32BE(value.z,offset+8);return offset+12}function writeByteVector(value,buffer,offset){buffer.writeInt8(value.x,offset);buffer.writeInt8(value.y,offset+1);buffer.writeInt8(value.z,offset+2);return offset+3}function sizeOfByteVectorArray(value){return 4+3*value.length}function writeByteVectorArray(value,buffer,offset){buffer.writeInt32BE(value.length,offset);offset+=4;value.forEach(function(vec){buffer.writeInt8(vec.x,offset);offset+=1;buffer.writeInt8(vec.y,offset);offset+=1;buffer.writeInt8(vec.z,offset);offset+=1});return offset}function sizeOfStringArray(value){var size=2;for(var i=0;i<value.length;++i){size+=sizeOfString(value[i])}return size}function writeStringArray(value,buffer,offset){buffer.writeInt16BE(value.length,offset);offset+=2;value.forEach(function(string){offset=writeString(string,buffer,offset)});return offset}function sizeOfPropertyArray(value){var size=4;for(var i=0;i<value.length;++i){size+=sizeOfString(value[i].key)+types["double"][2]+types["short"][2];for(var j=0;j<value[i].elementList.length;j++){size+=types["UUID"][2]+types["double"][2]+types["byte"][2]}}return size}function writeUUID(value,buffer,offset){buffer.writeInt32BE(value[0],offset);buffer.writeInt32BE(value[1],offset+4);buffer.writeInt32BE(value[2],offset+8);buffer.writeInt32BE(value[3],offset+12);return offset+16}function writePropertyArray(value,buffer,offset){buffer.writeInt32BE(value.length,offset);offset+=4;for(var i=0;i<value.length;++i){offset=writeString(value[i].key,buffer,offset);offset=writeDouble(value[i].value,buffer,offset);offset=writeShort(value[i].elementList.length,buffer,offset);for(var j=0;j<value[i].elementList.length;j++){offset=writeUUID(value[i].elementList[j].uuid,buffer,offset);offset=writeDouble(value[i].elementList[j].amount,buffer,offset);offset=writeByte(value[i].elementList[j].operation,buffer,offset)}}return offset}function readIntArray8(buffer,offset){var results=readByte(buffer,offset);if(!results)return null;var count=results.value;var cursor=offset+results.size;var cursorEnd=cursor+4*count;if(cursorEnd>buffer.length)return null;var array=[];for(var i=0;i<count;++i){array.push(buffer.readInt32BE(cursor));cursor+=4}return{value:array,size:cursorEnd-offset}}function readByteVectorArray(buffer,offset){var results=readInt(buffer,offset);if(!results)return null;var count=results.value;var cursor=offset+results.size;var cursorEnd=cursor+3*count;if(cursorEnd>buffer.length)return null;var array=[];for(var i=0;i<count;++i){array.push({x:buffer.readInt8(cursor),y:buffer.readInt8(cursor+1),z:buffer.readInt8(cursor+2)});cursor+=3}return{value:array,size:cursorEnd-offset}}function readByteVector(buffer,offset){if(offset+3>buffer.length)return null;return{value:{x:buffer.readInt8(offset),y:buffer.readInt8(offset+1),z:buffer.readInt8(offset+2)},size:3}}function readIntVector(buffer,offset){if(offset+12>buffer.length)return null;return{value:{x:buffer.readInt32BE(offset),y:buffer.readInt32BE(offset+4),z:buffer.readInt32BE(offset+8)},size:12}}function readEntityMetadata(buffer,offset){var cursor=offset;var metadata=[];var item,key,type,results,reader,typeName,dataType;while(true){if(cursor+1>buffer.length)return null;item=buffer.readUInt8(cursor);cursor+=1;if(item===127){return{value:metadata,size:cursor-offset}}key=item&31;type=item>>5;typeName=entityMetadataTypes[type];debug("Reading entity metadata type "+type+" ("+(typeName||"unknown")+")");if(!typeName){return{error:new Error("unrecognized entity metadata type "+type)}}dataType=types[typeName];if(!dataType){return{error:new Error("unrecognized entity metadata type name "+typeName)}}reader=dataType[0];if(!reader){return{error:new Error("missing reader for entity metadata type name "+typeName)}}results=reader(buffer,cursor);if(!results)return null;metadata.push({key:key,value:results.value,type:typeName});cursor+=results.size}}function readObjectData(buffer,offset){var cursor=offset+4;if(cursor>buffer.length)return null;var intField=buffer.readInt32BE(offset);if(intField===0){return{value:{intField:intField},size:cursor-offset}}if(cursor+6>buffer.length)return null;var velocityX=buffer.readInt16BE(cursor);cursor+=2;var velocityY=buffer.readInt16BE(cursor);cursor+=2;var velocityZ=buffer.readInt16BE(cursor);cursor+=2;return{value:{intField:intField,velocityX:velocityX,velocityY:velocityY,velocityZ:velocityZ},size:cursor-offset}}function readMapChunkBulk(buffer,offset){var cursor=offset+7;if(cursor>buffer.length)return null;var chunkColumnCount=buffer.readInt16BE(offset);var dataSize=buffer.readInt32BE(offset+2);var skyLightSent=!!buffer.readInt8(offset+6);var cursorEnd=cursor+dataSize+12*chunkColumnCount;if(cursorEnd>buffer.length)return null;var compressedChunkDataEnd=cursor+dataSize;var compressedChunkData=buffer.slice(cursor,compressedChunkDataEnd);cursor=compressedChunkDataEnd;var meta=[];var i,chunkX,chunkZ,bitMap,addBitMap;for(i=0;i<chunkColumnCount;++i){chunkX=buffer.readInt32BE(cursor);cursor+=4;chunkZ=buffer.readInt32BE(cursor);cursor+=4;bitMap=buffer.readUInt16BE(cursor);cursor+=2;addBitMap=buffer.readUInt16BE(cursor);cursor+=2;meta.push({x:chunkX,z:chunkZ,bitMap:bitMap,addBitMap:addBitMap})}if(chunkColumnCount!==meta.length){return{error:new Error("ChunkColumnCount different from length of meta")}}return{value:{skyLightSent:skyLightSent,compressedChunkData:compressedChunkData,meta:meta},size:cursorEnd-offset}}function readAscii(buffer,offset){var results=readShort(buffer,offset);if(!results)return null;var strBegin=offset+results.size;var strLen=results.value;var strEnd=strBegin+strLen;if(strEnd>buffer.length)return null;var str=buffer.slice(strBegin,strEnd).toString("ascii");return{value:str,size:strEnd-offset}}function readString(buffer,offset){var length=readVarInt(buffer,offset);if(!!!length)return null;var cursor=offset+length.size;var stringLength=length.value;var strEnd=cursor+stringLength;if(strEnd>buffer.length)return null;var value=buffer.toString("utf8",cursor,strEnd);cursor=strEnd;return{value:value,size:cursor-offset}}function readByteArray16(buffer,offset){var results=readShort(buffer,offset);if(!results)return null;var bytesBegin=offset+results.size;var bytesSize=results.value;var bytesEnd=bytesBegin+bytesSize;if(bytesEnd>buffer.length)return null;var bytes=buffer.slice(bytesBegin,bytesEnd);return{value:bytes,size:bytesEnd-offset}}function readByteArray32(buffer,offset){var results=readInt(buffer,offset);if(!results)return null;var bytesBegin=offset+results.size;var bytesSize=results.value;var bytesEnd=bytesBegin+bytesSize;if(bytesEnd>buffer.length)return null;var bytes=buffer.slice(bytesBegin,bytesEnd);return{value:bytes,size:bytesEnd-offset}}function readSlotArray(buffer,offset){var results=readShort(buffer,offset);if(!results)return null;var count=results.value;var cursor=offset+results.size;var slotArray=[];for(var i=0;i<count;++i){results=readSlot(buffer,cursor);if(!results)return null;slotArray.push(results.value);cursor+=results.size}return{value:slotArray,size:cursor-offset}}function readStringArray(buffer,offset){var results=readShort(buffer,offset);if(!results)return null;var count=results.value;var cursor=offset+results.size;var stringArray=[];for(var i=0;i<count;++i){results=readString(buffer,cursor);if(!results)return null;stringArray.push(results.value);cursor+=results.size}return{value:stringArray,size:cursor-offset}}function readUUID(buffer,offset){if(offset+16>buffer.length)return null;return{value:[buffer.readInt32BE(offset),buffer.readInt32BE(offset+4),buffer.readInt32BE(offset+8),buffer.readInt32BE(offset+12)],size:16}}function readPropertyArray(buffer,offset){var results=readInt(buffer,offset);if(!results)return null;var count=results.value;var cursor=offset+results.size;var propertyArray=[];for(var i=0;i<count;++i){var property={};var elementListLength;results=readString(buffer,cursor);if(!results)return null;property.key=results.value;cursor+=results.size;results=readDouble(buffer,cursor);if(!results)return null;property.value=results.value;cursor+=results.size;results=readShort(buffer,cursor);if(!results)return null;elementListLength=results.value;cursor+=results.size;property.elementList=[];for(var j=0;j<elementListLength;j++){property.elementList[j]={};results=readUUID(buffer,cursor);if(!results)return null;property.elementList[j].uuid=results.value;cursor+=results.size;results=readDouble(buffer,cursor);if(!results)return null;property.elementList[j].amount=results.value;cursor+=results.size;results=readByte(buffer,cursor);if(!results)return null;property.elementList[j].operation=results.value;cursor+=results.size}propertyArray.push(property)}return{value:propertyArray,size:cursor-offset}}function readShort(buffer,offset){if(offset+2>buffer.length)return null;
var value=buffer.readInt16BE(offset);return{value:value,size:2}}function readUShort(buffer,offset){if(offset+2>buffer.length)return null;var value=buffer.readUInt16BE(offset);return{value:value,size:2}}function readInt(buffer,offset){if(offset+4>buffer.length)return null;var value=buffer.readInt32BE(offset);return{value:value,size:4}}function readFloat(buffer,offset){if(offset+4>buffer.length)return null;var value=buffer.readFloatBE(offset);return{value:value,size:4}}function readDouble(buffer,offset){if(offset+8>buffer.length)return null;var value=buffer.readDoubleBE(offset);return{value:value,size:8}}function readLong(buffer,offset){if(offset+8>buffer.length)return null;return{value:[buffer.readInt32BE(offset),buffer.readInt32BE(offset+4)],size:8}}function readByte(buffer,offset){if(offset+1>buffer.length)return null;var value=buffer.readInt8(offset);return{value:value,size:1}}function readUByte(buffer,offset){if(offset+1>buffer.length)return null;var value=buffer.readUInt8(offset);return{value:value,size:1}}function readBool(buffer,offset){if(offset+1>buffer.length)return null;var value=buffer.readInt8(offset);return{value:!!value,size:1}}function readSlot(buffer,offset){var results=readShort(buffer,offset);if(!results)return null;var blockId=results.value;var cursor=offset+results.size;if(blockId===-1){return{value:{id:blockId},size:cursor-offset}}var cursorEnd=cursor+5;if(cursorEnd>buffer.length)return null;var itemCount=buffer.readInt8(cursor);var itemDamage=buffer.readInt16BE(cursor+1);var nbtDataSize=buffer.readInt16BE(cursor+3);if(nbtDataSize===-1)nbtDataSize=0;var nbtDataEnd=cursorEnd+nbtDataSize;if(nbtDataEnd>buffer.length)return null;var nbtData=buffer.slice(cursorEnd,nbtDataEnd);return{value:{id:blockId,itemCount:itemCount,itemDamage:itemDamage,nbtData:nbtData},size:nbtDataEnd-offset}}function sizeOfSlot(value){return value.id===-1?2:7+value.nbtData.length}function writeSlot(value,buffer,offset){buffer.writeInt16BE(value.id,offset);if(value.id===-1)return offset+2;buffer.writeInt8(value.itemCount,offset+2);buffer.writeInt16BE(value.itemDamage,offset+3);var nbtDataSize=value.nbtData.length;if(nbtDataSize===0)nbtDataSize=-1;buffer.writeInt16BE(nbtDataSize,offset+5);value.nbtData.copy(buffer,offset+7);return offset+7+value.nbtData.length}function sizeOfString(value){assert.ok(value.length<STRING_MAX_LENGTH,"string greater than max length");return sizeOfVarInt(value.length)+value.length}function sizeOfUString(value){assert.ok(value.length<SRV_STRING_MAX_LENGTH,"string greater than max length");return sizeOfVarInt(value.length)+value.length}function writeString(value,buffer,offset){offset=writeVarInt(value.length,buffer,offset);buffer.write(value,offset,value.length,"utf8");return offset+value.length}function sizeOfAscii(value){return 2+value.length}function writeAscii(value,buffer,offset){buffer.writeInt16BE(value.length,offset);offset+=2;for(var i=0;i<value.length;++i){buffer.writeUInt8(value.charCodeAt(i),offset);offset+=1}return offset}function sizeOfByteArray16(value){assert.ok(Buffer.isBuffer(value),"non buffer passed to ByteArray16Writer");return 2+value.length}function writeByteArray16(value,buffer,offset){buffer.writeInt16BE(value.length,offset);value.copy(buffer,offset+2);return offset+2+value.length}function writeByte(value,buffer,offset){buffer.writeInt8(value,offset);return offset+1}function writeBool(value,buffer,offset){buffer.writeInt8(+value,offset);return offset+1}function writeUByte(value,buffer,offset){buffer.writeUInt8(value,offset);return offset+1}function writeFloat(value,buffer,offset){buffer.writeFloatBE(value,offset);return offset+4}function writeDouble(value,buffer,offset){buffer.writeDoubleBE(value,offset);return offset+8}function writeShort(value,buffer,offset){buffer.writeInt16BE(value,offset);return offset+2}function writeUShort(value,buffer,offset){buffer.writeUInt16BE(value,offset);return offset+2}function writeInt(value,buffer,offset){buffer.writeInt32BE(value,offset);return offset+4}function writeLong(value,buffer,offset){buffer.writeInt32BE(value[0],offset);buffer.writeInt32BE(value[1],offset+4);return offset+8}function readVarInt(buffer,offset){var result=0;var shift=0;var cursor=offset;while(true){if(cursor+1>buffer.length)return null;var b=buffer.readUInt8(cursor);result|=(b&127)<<shift;cursor++;if(!(b&128)){return{value:result,size:cursor-offset}}shift+=7;assert.ok(shift<64,"varint is too big")}}function sizeOfVarInt(value){var cursor=0;while(value&~127){value>>>=7;cursor++}return cursor+1}function writeVarInt(value,buffer,offset){var cursor=0;while(value&~127){buffer.writeUInt8(value&255|128,offset+cursor);cursor++;value>>>=7}buffer.writeUInt8(value,offset+cursor);return offset+cursor+1}function readStatisticArray(buffer,offset){var lenWrapper=readVarInt(buffer,offset);if(!lenWrapper)return null;var len=lenWrapper.value;var cursor=offset+lenWrapper.size;var returnVal={};for(var i=0;i<len;i++){var statNameWrapper=readString(buffer,cursor);if(!statNameWrapper)return null;cursor+=statNameWrapper.size;var valueWrapper=readVarInt(buffer,cursor);if(!valueWrapper)return null;cursor+=valueWrapper.size;returnVal[statNameWrapper.value]=valueWrapper.value}return{value:returnVal,size:cursor-offset}}function sizeOfStatisticArray(value){return Object.keys(value).reduce(function(size,key){size+=sizeOfString(key);size+=sizeOfVarInt(value[key]);return size},sizeOfVarInt(Object.keys(value).length))}function writeStatisticArray(value,buffer,offset){var cursor=offset;cursor=writeVarInt(Object.keys(value).length,buffer,cursor);Object.keys(value).forEach(function(key){cursor=writeString(key,buffer,cursor);cursor=writeVarInt(value[key],buffer,cursor)});return cursor}function readMatchArray(buffer,offset){var lengthWrapper=readVarInt(buffer,offset);if(!!!lengthWrapper)return null;var cursor=offset+lengthWrapper.size;var matches=[];for(var i=0;i<lengthWrapper.value;i++){var match=readString(buffer,cursor);if(!!!match)return null;cursor+=match.size;matches[i]=match.value}return{value:matches,size:cursor-offset}}function sizeOfMatchArray(value){var size=sizeOfVarInt(value.length);for(var s in value){size+=sizeOfString(value)}return size}function writeMatchArray(value,buffer,offset){offset=writeVarInt(value.length,buffer,offset);for(var s in value){offset=writeString(s,buffer,offset)}return offset}function get(packetId,state,toServer){var direction=toServer?"toServer":"toClient";var packetInfo=packetFields[state][direction][packetId];if(!packetInfo){return null}return packetInfo}function sizeOf(type,value){var dataType=types[type];assert.ok(dataType,"unknown data type "+type);var size=dataType[2];if(typeof size==="function"){return size(value)}else{return size}}function createPacketBuffer(packetId,state,params,isServer){var length=0;if(typeof packetId==="string"&&typeof state!=="string"&&!params){params=state;state=packetStates[!isServer?"toServer":"toClient"][packetId]}if(typeof packetId==="string")packetId=packetIds[state][!isServer?"toServer":"toClient"][packetId];assert.notEqual(packetId,undefined);var packet=get(packetId,state,!isServer);assert.notEqual(packet,null);packet.forEach(function(fieldInfo){var condition=fieldInfo.condition;if(typeof condition!="undefined"&&!condition(params))return;length+=sizeOf(fieldInfo.type,params[fieldInfo.name])});length+=sizeOfVarInt(packetId);var size=length+sizeOfVarInt(length);var buffer=new Buffer(size);var offset=writeVarInt(length,buffer,0);offset=writeVarInt(packetId,buffer,offset);packet.forEach(function(fieldInfo){var condition=fieldInfo.condition;if(typeof condition!="undefined"&&!condition(params))return;var write=types[fieldInfo.type][1];var value=params[fieldInfo.name];if(typeof value==="undefined")value=0;offset=write(value,buffer,offset)});return buffer}function parsePacket(buffer,state,isServer,shouldParsePayload){if(state==null)state=states.PLAY;if(shouldParsePayload==null)shouldParsePayload=true;var cursor=0;var lengthField=readVarInt(buffer,0);if(!!!lengthField)return null;var length=lengthField.value;cursor+=lengthField.size;if(length+lengthField.size>buffer.length)return null;var buffer=buffer.slice(0,length+cursor);var packetIdField=readVarInt(buffer,lengthField.size);var packetId=packetIdField.value;cursor+=packetIdField.size;if(shouldParsePayload)return parsePayload(packetId,state,isServer,buffer,cursor,length,lengthField.size);else return{size:length+lengthField.size,results:{raw:buffer}}}function parsePayload(packetId,state,isServer,buffer,cursor,length,payloadSize){function readPacketField(fieldInfo){var read=types[fieldInfo.type][0];if(!read){return{error:new Error("missing reader for data type: "+fieldInfo.type)}}var readResults=read(buffer,cursor);if(!readResults)return null;if(readResults.error)return{error:readResults.error};return readResults}if(state==null)state==states.PLAY;var cursor=0;var lengthField=readVarInt(buffer,0);if(!!!lengthField)return null;var length=lengthField.value;cursor+=lengthField.size;if(length+lengthField.size>buffer.length)return null;var buffer=buffer.slice(0,length+cursor);var packetIdField=readVarInt(buffer,lengthField.size);var packetId=packetIdField.value;cursor+=packetIdField.size;var results={id:packetId};var packetInfo=get(packetId,state,isServer);if(packetInfo===null){return{error:new Error("Unrecognized packetId: "+packetId+" (0x"+packetId.toString(16)+")"),size:length+payloadSize,results:results}}else{debug("read packetId "+packetId+" (0x"+packetId.toString(16)+")")}var i,fieldInfo,readResults;for(i=0;i<packetInfo.length;++i){fieldInfo=packetInfo[i];var condition=fieldInfo.condition;if(typeof condition!="undefined"&&!condition(results)){results[fieldInfo.name]=null;continue}readResults=readPacketField(fieldInfo);if(!!!readResults){var error=new Error("A deserializer returned null");error.packetId=packetId;error.fieldInfo=fieldInfo.name;return{size:length+payloadSize,error:error,results:results}}if(readResults.error){return readResults}results[fieldInfo.name]=readResults.value;cursor+=readResults.size}debug(results);return{size:length+payloadSize,results:results}}module.exports={version:4,minecraftVersion:"1.7.2",sessionVersion:13,parsePacket:parsePacket,createPacketBuffer:createPacketBuffer,STRING_MAX_LENGTH:STRING_MAX_LENGTH,packetIds:packetIds,packetNames:packetNames,packetFields:packetFields,states:states,get:get,debug:debug}},{__browserify_Buffer:509,__browserify_process:510,assert:506,util:529}],79:[function(require,module,exports){"use strict";var colormc2html={black:"black",dark_blue:"#0000b2",dark_green:"#14ab00",dark_aqua:"#13aaab",dark_red:"#a90400",dark_purple:"#a900b2",gold:"#feac00",gray:"gray",dark_gray:"#555555",blue:"#544cff",green:"#5cff00",aqua:"#5bffff",red:"#fd5650",light_purple:"#fd4dff",yellow:"yellow",white:"white"};var translations={"chat.type.text":"<%s> %s","chat.type.emote":"* %s %s","chat.type.announcement":"[%s] %s","chat.type.admin":"[%s: %s]","chat.stream.text":"(%s) <%s> %s","chat.stream.emote":"(%s) * %s %s"};var isTrue=function(x){if(x===undefined)return false;if(x==="false")return false;return true};var parseRaw=function(raw,opts){var json;opts=opts||{};if(typeof raw==="string"){try{json=JSON.parse(raw)}catch(error){console.log(raw);return document.createTextNode("Invalid JSON: "+error)}}else{json=raw}var parseObject=function(element){if(typeof element==="string"){return document.createTextNode(element)}var node=document.createElement("span");if("color"in element)node.style.color=colormc2html[element.color];if(isTrue(element.bold))node.style.fontWeight="bold";if(isTrue(element.italic))node.style.fontStyle="italic";if(isTrue(element.underlined)||isTrue(element.strikethrough))node.style.textDecoration=(isTrue(element.underlined)?"underline ":"")+(isTrue(element.strikethrough)?"line-through":"");if("clickEvent"in element){if(opts.click){node.addEventListener("click",function(ev){opts.click(element,element.clickEvent,ev)})}}if("hoverEvent"in element){if(opts.hover){node.addEventListener("mouseover",function(ev){opts.hover(element,element.hoverEvent,ev)})}if(opts.hoverOut){node.addEventListener("mouseout",function(ev){opts.hoverOut(element,element.hoverEvent,ev)})}}if("text"in element)node.textContent=element.text;if("translate"in element){var translate=translations[element.translate]||element.translate;var translateTexts=translate.split("%s");(element["with"]||[]).forEach(function(x,i){node.appendChild(document.createTextNode(translateTexts[i]||" "));node.appendChild(parseObject(x))});if(!/%s$/.test(translateTexts))node.appendChild(document.createTextNode(translateTexts.splice(-1)[0]))}if("extra"in element){element.extra.forEach(function(x){node.appendChild(parseObject(x))})}return node};return parseObject(json)};module.exports=parseRaw},{}],80:[function(require,module,exports){var through=require("through");var isBuffer=require("isbuffer");var WebSocketPoly=require("ws");function WebsocketStream(server,options){if(!(this instanceof WebsocketStream))return new WebsocketStream(server,options);this.stream=through(this.write.bind(this),this.end.bind(this));this.stream.websocketStream=this;this.options=options||{};this._buffer=[];if(typeof server==="object"){this.ws=server;this.ws.on("message",this.onMessage.bind(this));this.ws.on("error",this.onError.bind(this));this.ws.on("close",this.onClose.bind(this));this.ws.on("open",this.onOpen.bind(this));if(this.ws.readyState===1)this._open=true}else{this.ws=new WebSocketPoly(server,this.options.protocol);this.ws.binaryType=this.options.binaryType||"arraybuffer";this.ws.onmessage=this.onMessage.bind(this);this.ws.onerror=this.onError.bind(this);this.ws.onclose=this.onClose.bind(this);this.ws.onopen=this.onOpen.bind(this)}return this.stream}module.exports=WebsocketStream;module.exports.WebsocketStream=WebsocketStream;WebsocketStream.prototype.onMessage=function(e){var data=e;if(data.data)data=data.data;var type=this.options.type;if(type&&data instanceof ArrayBuffer)data=new type(data);this.stream.queue(data)};WebsocketStream.prototype.onError=function(err){this.stream.emit("error",err)};WebsocketStream.prototype.onClose=function(err){if(this._destroy)return;this.stream.emit("end");this.stream.emit("close")};WebsocketStream.prototype.onOpen=function(err){if(this._destroy)return;this._open=true;for(var i=0;i<this._buffer.length;i++){this._write(this._buffer[i])}this._buffer=undefined;this.stream.emit("open");this.stream.emit("connect");if(this._end)this.ws.close()};WebsocketStream.prototype.write=function(data){if(!this._open){this._buffer.push(data)}else{this._write(data)}};WebsocketStream.prototype._write=function(data){if(this.ws.readyState==1)typeof WebSocket!="undefined"&&this.ws instanceof WebSocket?this.ws.send(data):this.ws.send(data,{binary:isBuffer(data)});else this.stream.emit("error","Not connected")};WebsocketStream.prototype.end=function(data){if(data!==undefined)this.stream.queue(data);if(this._open)this.ws.close();this._end=true}},{isbuffer:81,through:82,ws:83}],81:[function(require,module,exports){var Buffer=require("buffer").Buffer;module.exports=isBuffer;function isBuffer(o){return Buffer.isBuffer(o)||/\[object (.+Array|Array.+)\]/.test(Object.prototype.toString.call(o))}},{buffer:511}],82:[function(require,module,exports){var process=require("__browserify_process");var Stream=require("stream");exports=module.exports=through;through.through=through;function through(write,end,opts){write=write||function(data){this.queue(data)};end=end||function(){this.queue(null)};var ended=false,destroyed=false,buffer=[],_ended=false;var stream=new Stream;stream.readable=stream.writable=true;stream.paused=false;stream.autoDestroy=!(opts&&opts.autoDestroy===false);stream.write=function(data){write.call(this,data);return!stream.paused};function drain(){while(buffer.length&&!stream.paused){var data=buffer.shift();if(null===data)return stream.emit("end");else stream.emit("data",data)}}stream.queue=stream.push=function(data){if(_ended)return stream;if(data==null)_ended=true;buffer.push(data);drain();return stream};stream.on("end",function(){stream.readable=false;if(!stream.writable&&stream.autoDestroy)process.nextTick(function(){stream.destroy()})});function _end(){stream.writable=false;end.call(stream);if(!stream.readable&&stream.autoDestroy)stream.destroy()}stream.end=function(data){if(ended)return;ended=true;if(arguments.length)stream.write(data);_end();return stream};stream.destroy=function(){if(destroyed)return;destroyed=true;ended=true;buffer.length=0;stream.writable=stream.readable=false;stream.emit("close");return stream};stream.pause=function(){if(stream.paused)return;stream.paused=true;return stream};stream.resume=function(){if(stream.paused){stream.paused=false;stream.emit("resume")}drain();if(!stream.paused)stream.emit("drain");return stream};return stream}},{__browserify_process:510,stream:520}],83:[function(require,module,exports){var global=function(){return this}();var WebSocket=global.WebSocket||global.MozWebSocket;module.exports=WebSocket?ws:null;function ws(uri,protocols,opts){var instance;if(protocols){instance=new WebSocket(uri,protocols)}else{instance=new WebSocket(uri)}return instance}if(WebSocket)ws.prototype=WebSocket.prototype},{}],84:[function(require,module,exports){var bundleFn=arguments[3];var sources=arguments[4];var cache=arguments[5];var stringify=JSON.stringify;module.exports=function(fn){var keys=[];var wkey;var cacheKeys=Object.keys(cache);for(var i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i];if(cache[key].exports===fn){wkey=key;break}}if(!wkey){wkey=Math.floor(Math.pow(16,8)*Math.random()).toString(16);var wcache={};for(var i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i];wcache[key]=key}sources[wkey]=[Function(["require","module","exports"],"("+fn+")(self)"),wcache]}var skey=Math.floor(Math.pow(16,8)*Math.random()).toString(16);var scache={};scache[wkey]=wkey;sources[skey]=[Function(["require"],"require("+stringify(wkey)+")(self)"),scache];var src="("+bundleFn+")({"+Object.keys(sources).map(function(key){return stringify(key)+":["+sources[key][0]+","+stringify(sources[key][1])+"]"}).join(",")+"},{},["+stringify(skey)+"])";return new Worker(window.URL.createObjectURL(new Blob([src],{type:"text/javascript"})))}},{}],85:[function(require,module,exports){var Buffer=require("__browserify_Buffer");var Zlib=module.exports=require("./zlib");function error(){var m=[].slice.call(arguments).join(" ");throw new Error([m,"we accept pull requests","http://github.com/brianloveswords/zlib-browserify"].join("\n"))}["createGzip","createGunzip","createDeflate","createDeflateRaw","createInflate","createInflateRaw","createUnzip","Gzip","Gunzip","Inflate","InflateRaw","Deflate","DeflateRaw","Unzip","inflateRaw","deflateRaw"].forEach(function(name){Zlib[name]=function(){error("sorry,",name,"is not implemented yet")}});var _deflate=Zlib.deflate;var _gzip=Zlib.gzip;Zlib.deflate=function deflate(stringOrBuffer,callback){return _deflate(Buffer(stringOrBuffer),callback)};Zlib.gzip=function gzip(stringOrBuffer,callback){return _gzip(Buffer(stringOrBuffer),callback)}},{"./zlib":86,__browserify_Buffer:509}],86:[function(require,module,exports){var process=require("__browserify_process"),Buffer=require("__browserify_Buffer");(function(){"use strict";function q(b){throw b}var t=void 0,u=!0;var A="undefined"!==typeof Uint8Array&&"undefined"!==typeof Uint16Array&&"undefined"!==typeof Uint32Array;function E(b,a){this.index="number"===typeof a?a:0;this.m=0;this.buffer=b instanceof(A?Uint8Array:Array)?b:new(A?Uint8Array:Array)(32768);2*this.buffer.length<=this.index&&q(Error("invalid index"));this.buffer.length<=this.index&&this.f()}E.prototype.f=function(){var b=this.buffer,a,c=b.length,d=new(A?Uint8Array:Array)(c<<1);if(A)d.set(b);else for(a=0;a<c;++a)d[a]=b[a];return this.buffer=d};E.prototype.d=function(b,a,c){var d=this.buffer,f=this.index,e=this.m,g=d[f],k;c&&1<a&&(b=8<a?(G[b&255]<<24|G[b>>>8&255]<<16|G[b>>>16&255]<<8|G[b>>>24&255])>>32-a:G[b]>>8-a);if(8>a+e)g=g<<a|b,e+=a;else for(k=0;k<a;++k)g=g<<1|b>>a-k-1&1,8===++e&&(e=0,d[f++]=G[g],g=0,f===d.length&&(d=this.f()));d[f]=g;this.buffer=d;this.m=e;this.index=f};E.prototype.finish=function(){var b=this.buffer,a=this.index,c;0<this.m&&(b[a]<<=8-this.m,b[a]=G[b[a]],a++);A?c=b.subarray(0,a):(b.length=a,c=b);return c};var aa=new(A?Uint8Array:Array)(256),J;for(J=0;256>J;++J){for(var N=J,Q=N,ba=7,N=N>>>1;N;N>>>=1)Q<<=1,Q|=N&1,--ba;aa[J]=(Q<<ba&255)>>>0}var G=aa;function R(b,a,c){var d,f="number"===typeof a?a:a=0,e="number"===typeof c?c:b.length;d=-1;for(f=e&7;f--;++a)d=d>>>8^S[(d^b[a])&255];for(f=e>>3;f--;a+=8)d=d>>>8^S[(d^b[a])&255],d=d>>>8^S[(d^b[a+1])&255],d=d>>>8^S[(d^b[a+2])&255],d=d>>>8^S[(d^b[a+3])&255],d=d>>>8^S[(d^b[a+4])&255],d=d>>>8^S[(d^b[a+5])&255],d=d>>>8^S[(d^b[a+6])&255],d=d>>>8^S[(d^b[a+7])&255];return(d^4294967295)>>>0}var ga=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],S=A?new Uint32Array(ga):ga;function ha(){}function ia(b){this.buffer=new(A?Uint16Array:Array)(2*b);this.length=0}ia.prototype.getParent=function(b){return 2*((b-2)/4|0)};ia.prototype.push=function(b,a){var c,d,f=this.buffer,e;c=this.length;f[this.length++]=a;for(f[this.length++]=b;0<c;)if(d=this.getParent(c),f[c]>f[d])e=f[c],f[c]=f[d],f[d]=e,e=f[c+1],f[c+1]=f[d+1],f[d+1]=e,c=d;else break;return this.length};ia.prototype.pop=function(){var b,a,c=this.buffer,d,f,e;a=c[0];b=c[1];this.length-=2;c[0]=c[this.length];c[1]=c[this.length+1];for(e=0;;){f=2*e+2;if(f>=this.length)break;f+2<this.length&&c[f+2]>c[f]&&(f+=2);if(c[f]>c[e])d=c[e],c[e]=c[f],c[f]=d,d=c[e+1],c[e+1]=c[f+1],c[f+1]=d;else break;e=f}return{index:b,value:a,length:this.length}};function ja(b){var a=b.length,c=0,d=Number.POSITIVE_INFINITY,f,e,g,k,h,l,s,n,m;for(n=0;n<a;++n)b[n]>c&&(c=b[n]),b[n]<d&&(d=b[n]);f=1<<c;e=new(A?Uint32Array:Array)(f);g=1;k=0;for(h=2;g<=c;){for(n=0;n<a;++n)if(b[n]===g){l=0;s=k;for(m=0;m<g;++m)l=l<<1|s&1,s>>=1;for(m=l;m<f;m+=h)e[m]=g<<16|n;++k}++g;k<<=1;h<<=1}return[e,c,d]}function ma(b,a){this.k=na;this.F=0;this.input=A&&b instanceof Array?new Uint8Array(b):b;this.b=0;a&&(a.lazy&&(this.F=a.lazy),"number"===typeof a.compressionType&&(this.k=a.compressionType),a.outputBuffer&&(this.a=A&&a.outputBuffer instanceof Array?new Uint8Array(a.outputBuffer):a.outputBuffer),"number"===typeof a.outputIndex&&(this.b=a.outputIndex));this.a||(this.a=new(A?Uint8Array:Array)(32768))}var na=2,oa={NONE:0,L:1,t:na,X:3},pa=[],T;for(T=0;288>T;T++)switch(u){case 143>=T:pa.push([T+48,8]);break;case 255>=T:pa.push([T-144+400,9]);break;case 279>=T:pa.push([T-256+0,7]);break;case 287>=T:pa.push([T-280+192,8]);break;default:q("invalid literal: "+T)}ma.prototype.h=function(){var b,a,c,d,f=this.input;switch(this.k){case 0:c=0;for(d=f.length;c<d;){a=A?f.subarray(c,c+65535):f.slice(c,c+65535);c+=a.length;var e=a,g=c===d,k=t,h=t,l=t,s=t,n=t,m=this.a,p=this.b;if(A){for(m=new Uint8Array(this.a.buffer);m.length<=p+e.length+5;)m=new Uint8Array(m.length<<1);m.set(this.a)}k=g?1:0;m[p++]=k|0;h=e.length;l=~h+65536&65535;m[p++]=h&255;m[p++]=h>>>8&255;m[p++]=l&255;m[p++]=l>>>8&255;if(A)m.set(e,p),p+=e.length,m=m.subarray(0,p);else{s=0;for(n=e.length;s<n;++s)m[p++]=e[s];m.length=p}this.b=p;this.a=m}break;case 1:var r=new E(A?new Uint8Array(this.a.buffer):this.a,this.b);r.d(1,1,u);r.d(1,2,u);var v=qa(this,f),x,O,y;x=0;for(O=v.length;x<O;x++)if(y=v[x],E.prototype.d.apply(r,pa[y]),256<y)r.d(v[++x],v[++x],u),r.d(v[++x],5),r.d(v[++x],v[++x],u);else if(256===y)break;this.a=r.finish();this.b=this.a.length;break;case na:var D=new E(A?new Uint8Array(this.a.buffer):this.a,this.b),Da,P,U,V,W,qb=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ca,Ea,da,Fa,ka,sa=Array(19),Ga,X,la,B,Ha;Da=na;D.d(1,1,u);D.d(Da,2,u);P=qa(this,f);ca=ra(this.U,15);Ea=ta(ca);da=ra(this.T,7);Fa=ta(da);for(U=286;257<U&&0===ca[U-1];U--);for(V=30;1<V&&0===da[V-1];V--);var Ia=U,Ja=V,I=new(A?Uint32Array:Array)(Ia+Ja),w,K,z,ea,H=new(A?Uint32Array:Array)(316),F,C,L=new(A?Uint8Array:Array)(19);for(w=K=0;w<Ia;w++)I[K++]=ca[w];for(w=0;w<Ja;w++)I[K++]=da[w];if(!A){w=0;for(ea=L.length;w<ea;++w)L[w]=0}w=F=0;for(ea=I.length;w<ea;w+=K){for(K=1;w+K<ea&&I[w+K]===I[w];++K);z=K;if(0===I[w])if(3>z)for(;0<z--;)H[F++]=0,L[0]++;else for(;0<z;)C=138>z?z:138,C>z-3&&C<z&&(C=z-3),10>=C?(H[F++]=17,H[F++]=C-3,L[17]++):(H[F++]=18,H[F++]=C-11,L[18]++),z-=C;else if(H[F++]=I[w],L[I[w]]++,z--,3>z)for(;0<z--;)H[F++]=I[w],L[I[w]]++;else for(;0<z;)C=6>z?z:6,C>z-3&&C<z&&(C=z-3),H[F++]=16,H[F++]=C-3,L[16]++,z-=C}b=A?H.subarray(0,F):H.slice(0,F);ka=ra(L,7);for(B=0;19>B;B++)sa[B]=ka[qb[B]];for(W=19;4<W&&0===sa[W-1];W--);Ga=ta(ka);D.d(U-257,5,u);D.d(V-1,5,u);D.d(W-4,4,u);for(B=0;B<W;B++)D.d(sa[B],3,u);B=0;for(Ha=b.length;B<Ha;B++)if(X=b[B],D.d(Ga[X],ka[X],u),16<=X){B++;switch(X){case 16:la=2;break;case 17:la=3;break;case 18:la=7;break;default:q("invalid code: "+X)}D.d(b[B],la,u)}var Ka=[Ea,ca],La=[Fa,da],M,Ma,fa,va,Na,Oa,Pa,Qa;Na=Ka[0];Oa=Ka[1];Pa=La[0];Qa=La[1];M=0;for(Ma=P.length;M<Ma;++M)if(fa=P[M],D.d(Na[fa],Oa[fa],u),256<fa)D.d(P[++M],P[++M],u),va=P[++M],D.d(Pa[va],Qa[va],u),D.d(P[++M],P[++M],u);else if(256===fa)break;this.a=D.finish();this.b=this.a.length;break;default:q("invalid compression type")}return this.a};function ua(b,a){this.length=b;this.N=a}var wa=function(){function b(a){switch(u){case 3===a:return[257,a-3,0];case 4===a:return[258,a-4,0];case 5===a:return[259,a-5,0];case 6===a:return[260,a-6,0];case 7===a:return[261,a-7,0];case 8===a:return[262,a-8,0];case 9===a:return[263,a-9,0];case 10===a:return[264,a-10,0];case 12>=a:return[265,a-11,1];case 14>=a:return[266,a-13,1];case 16>=a:return[267,a-15,1];case 18>=a:return[268,a-17,1];case 22>=a:return[269,a-19,2];case 26>=a:return[270,a-23,2];case 30>=a:return[271,a-27,2];case 34>=a:return[272,a-31,2];case 42>=a:return[273,a-35,3];case 50>=a:return[274,a-43,3];case 58>=a:return[275,a-51,3];case 66>=a:return[276,a-59,3];case 82>=a:return[277,a-67,4];case 98>=a:return[278,a-83,4];case 114>=a:return[279,a-99,4];case 130>=a:return[280,a-115,4];case 162>=a:return[281,a-131,5];case 194>=a:return[282,a-163,5];case 226>=a:return[283,a-195,5];case 257>=a:return[284,a-227,5];case 258===a:return[285,a-258,0];default:q("invalid length: "+a)}}var a=[],c,d;for(c=3;258>=c;c++)d=b(c),a[c]=d[2]<<24|d[1]<<16|d[0];return a}(),xa=A?new Uint32Array(wa):wa;function qa(b,a){function c(a,c){var b=a.N,d=[],e=0,f;f=xa[a.length];d[e++]=f&65535;d[e++]=f>>16&255;d[e++]=f>>24;var g;switch(u){case 1===b:g=[0,b-1,0];break;case 2===b:g=[1,b-2,0];break;case 3===b:g=[2,b-3,0];break;case 4===b:g=[3,b-4,0];break;case 6>=b:g=[4,b-5,1];break;case 8>=b:g=[5,b-7,1];break;case 12>=b:g=[6,b-9,2];break;case 16>=b:g=[7,b-13,2];break;case 24>=b:g=[8,b-17,3];break;case 32>=b:g=[9,b-25,3];break;case 48>=b:g=[10,b-33,4];break;case 64>=b:g=[11,b-49,4];break;case 96>=b:g=[12,b-65,5];break;case 128>=b:g=[13,b-97,5];break;case 192>=b:g=[14,b-129,6];break;case 256>=b:g=[15,b-193,6];break;case 384>=b:g=[16,b-257,7];break;case 512>=b:g=[17,b-385,7];break;case 768>=b:g=[18,b-513,8];break;case 1024>=b:g=[19,b-769,8];break;case 1536>=b:g=[20,b-1025,9];break;case 2048>=b:g=[21,b-1537,9];break;case 3072>=b:g=[22,b-2049,10];break;case 4096>=b:g=[23,b-3073,10];break;case 6144>=b:g=[24,b-4097,11];break;case 8192>=b:g=[25,b-6145,11];break;case 12288>=b:g=[26,b-8193,12];break;case 16384>=b:g=[27,b-12289,12];break;case 24576>=b:g=[28,b-16385,13];break;case 32768>=b:g=[29,b-24577,13];break;default:q("invalid distance")}f=g;d[e++]=f[0];d[e++]=f[1];d[e++]=f[2];var h,k;h=0;for(k=d.length;h<k;++h)m[p++]=d[h];v[d[0]]++;x[d[3]]++;r=a.length+c-1;n=null}var d,f,e,g,k,h={},l,s,n,m=A?new Uint16Array(2*a.length):[],p=0,r=0,v=new(A?Uint32Array:Array)(286),x=new(A?Uint32Array:Array)(30),O=b.F,y;if(!A){for(e=0;285>=e;)v[e++]=0;for(e=0;29>=e;)x[e++]=0}v[256]=1;d=0;for(f=a.length;d<f;++d){e=k=0;for(g=3;e<g&&d+e!==f;++e)k=k<<8|a[d+e];h[k]===t&&(h[k]=[]);l=h[k];if(!(0<r--)){for(;0<l.length&&32768<d-l[0];)l.shift();if(d+3>=f){n&&c(n,-1);e=0;for(g=f-d;e<g;++e)y=a[d+e],m[p++]=y,++v[y];break}0<l.length?(s=ya(a,d,l),n?n.length<s.length?(y=a[d-1],m[p++]=y,++v[y],c(s,0)):c(n,-1):s.length<O?n=s:c(s,0)):n?c(n,-1):(y=a[d],m[p++]=y,++v[y])}l.push(d)}m[p++]=256;v[256]++;b.U=v;b.T=x;return A?m.subarray(0,p):m}function ya(b,a,c){var d,f,e=0,g,k,h,l,s=b.length;k=0;l=c.length;a:for(;k<l;k++){d=c[l-k-1];g=3;if(3<e){for(h=e;3<h;h--)if(b[d+h-1]!==b[a+h-1])continue a;g=e}for(;258>g&&a+g<s&&b[d+g]===b[a+g];)++g;g>e&&(f=d,e=g);if(258===g)break}return new ua(e,a-f)}function ra(b,a){var c=b.length,d=new ia(572),f=new(A?Uint8Array:Array)(c),e,g,k,h,l;if(!A)for(h=0;h<c;h++)f[h]=0;for(h=0;h<c;++h)0<b[h]&&d.push(h,b[h]);e=Array(d.length/2);g=new(A?Uint32Array:Array)(d.length/2);if(1===e.length)return f[d.pop().index]=1,f;h=0;for(l=d.length/2;h<l;++h)e[h]=d.pop(),g[h]=e[h].value;k=za(g,g.length,a);h=0;for(l=e.length;h<l;++h)f[e[h].index]=k[h];return f}function za(b,a,c){function d(b){var c=h[b][l[b]];c===a?(d(b+1),d(b+1)):--g[c];++l[b]}var f=new(A?Uint16Array:Array)(c),e=new(A?Uint8Array:Array)(c),g=new(A?Uint8Array:Array)(a),k=Array(c),h=Array(c),l=Array(c),s=(1<<c)-a,n=1<<c-1,m,p,r,v,x;f[c-1]=a;for(p=0;p<c;++p)s<n?e[p]=0:(e[p]=1,s-=n),s<<=1,f[c-2-p]=(f[c-1-p]/2|0)+a;f[0]=e[0];k[0]=Array(f[0]);h[0]=Array(f[0]);for(p=1;p<c;++p)f[p]>2*f[p-1]+e[p]&&(f[p]=2*f[p-1]+e[p]),k[p]=Array(f[p]),h[p]=Array(f[p]);for(m=0;m<a;++m)g[m]=c;for(r=0;r<f[c-1];++r)k[c-1][r]=b[r],h[c-1][r]=r;for(m=0;m<c;++m)l[m]=0;
1===e[c-1]&&(--g[0],++l[c-1]);for(p=c-2;0<=p;--p){v=m=0;x=l[p+1];for(r=0;r<f[p];r++)v=k[p+1][x]+k[p+1][x+1],v>b[m]?(k[p][r]=v,h[p][r]=a,x+=2):(k[p][r]=b[m],h[p][r]=m,++m);l[p]=0;1===e[p]&&d(p)}return g}function ta(b){var a=new(A?Uint16Array:Array)(b.length),c=[],d=[],f=0,e,g,k,h;e=0;for(g=b.length;e<g;e++)c[b[e]]=(c[b[e]]|0)+1;e=1;for(g=16;e<=g;e++)d[e]=f,f+=c[e]|0,f<<=1;e=0;for(g=b.length;e<g;e++){f=d[b[e]];d[b[e]]+=1;k=a[e]=0;for(h=b[e];k<h;k++)a[e]=a[e]<<1|f&1,f>>>=1}return a}function Aa(b,a){this.input=b;this.b=this.c=0;this.g={};a&&(a.flags&&(this.g=a.flags),"string"===typeof a.filename&&(this.filename=a.filename),"string"===typeof a.comment&&(this.w=a.comment),a.deflateOptions&&(this.l=a.deflateOptions));this.l||(this.l={})}Aa.prototype.h=function(){var b,a,c,d,f,e,g,k,h=new(A?Uint8Array:Array)(32768),l=0,s=this.input,n=this.c,m=this.filename,p=this.w;h[l++]=31;h[l++]=139;h[l++]=8;b=0;this.g.fname&&(b|=Ba);this.g.fcomment&&(b|=Ca);this.g.fhcrc&&(b|=Ra);h[l++]=b;a=(Date.now?Date.now():+new Date)/1e3|0;h[l++]=a&255;h[l++]=a>>>8&255;h[l++]=a>>>16&255;h[l++]=a>>>24&255;h[l++]=0;h[l++]=Sa;if(this.g.fname!==t){g=0;for(k=m.length;g<k;++g)e=m.charCodeAt(g),255<e&&(h[l++]=e>>>8&255),h[l++]=e&255;h[l++]=0}if(this.g.comment){g=0;for(k=p.length;g<k;++g)e=p.charCodeAt(g),255<e&&(h[l++]=e>>>8&255),h[l++]=e&255;h[l++]=0}this.g.fhcrc&&(c=R(h,0,l)&65535,h[l++]=c&255,h[l++]=c>>>8&255);this.l.outputBuffer=h;this.l.outputIndex=l;f=new ma(s,this.l);h=f.h();l=f.b;A&&(l+8>h.buffer.byteLength?(this.a=new Uint8Array(l+8),this.a.set(new Uint8Array(h.buffer)),h=this.a):h=new Uint8Array(h.buffer));d=R(s,t,t);h[l++]=d&255;h[l++]=d>>>8&255;h[l++]=d>>>16&255;h[l++]=d>>>24&255;k=s.length;h[l++]=k&255;h[l++]=k>>>8&255;h[l++]=k>>>16&255;h[l++]=k>>>24&255;this.c=n;A&&l<h.length&&(this.a=h=h.subarray(0,l));return h};var Sa=255,Ra=2,Ba=8,Ca=16;function Y(b,a){this.o=[];this.p=32768;this.e=this.j=this.c=this.s=0;this.input=A?new Uint8Array(b):b;this.u=!1;this.q=Ta;this.K=!1;if(a||!(a={}))a.index&&(this.c=a.index),a.bufferSize&&(this.p=a.bufferSize),a.bufferType&&(this.q=a.bufferType),a.resize&&(this.K=a.resize);switch(this.q){case Ua:this.b=32768;this.a=new(A?Uint8Array:Array)(32768+this.p+258);break;case Ta:this.b=0;this.a=new(A?Uint8Array:Array)(this.p);this.f=this.S;this.z=this.O;this.r=this.Q;break;default:q(Error("invalid inflate mode"))}}var Ua=0,Ta=1;Y.prototype.i=function(){for(;!this.u;){var b=Z(this,3);b&1&&(this.u=u);b>>>=1;switch(b){case 0:var a=this.input,c=this.c,d=this.a,f=this.b,e=t,g=t,k=t,h=d.length,l=t;this.e=this.j=0;e=a[c++];e===t&&q(Error("invalid uncompressed block header: LEN (first byte)"));g=e;e=a[c++];e===t&&q(Error("invalid uncompressed block header: LEN (second byte)"));g|=e<<8;e=a[c++];e===t&&q(Error("invalid uncompressed block header: NLEN (first byte)"));k=e;e=a[c++];e===t&&q(Error("invalid uncompressed block header: NLEN (second byte)"));k|=e<<8;g===~k&&q(Error("invalid uncompressed block header: length verify"));c+g>a.length&&q(Error("input buffer is broken"));switch(this.q){case Ua:for(;f+g>d.length;){l=h-f;g-=l;if(A)d.set(a.subarray(c,c+l),f),f+=l,c+=l;else for(;l--;)d[f++]=a[c++];this.b=f;d=this.f();f=this.b}break;case Ta:for(;f+g>d.length;)d=this.f({B:2});break;default:q(Error("invalid inflate mode"))}if(A)d.set(a.subarray(c,c+g),f),f+=g,c+=g;else for(;g--;)d[f++]=a[c++];this.c=c;this.b=f;this.a=d;break;case 1:this.r(Va,Wa);break;case 2:Xa(this);break;default:q(Error("unknown BTYPE: "+b))}}return this.z()};var Ya=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Za=A?new Uint16Array(Ya):Ya,$a=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],ab=A?new Uint16Array($a):$a,bb=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],cb=A?new Uint8Array(bb):bb,db=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],eb=A?new Uint16Array(db):db,fb=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],gb=A?new Uint8Array(fb):fb,hb=new(A?Uint8Array:Array)(288),$,ib;$=0;for(ib=hb.length;$<ib;++$)hb[$]=143>=$?8:255>=$?9:279>=$?7:8;var Va=ja(hb),jb=new(A?Uint8Array:Array)(30),kb,lb;kb=0;for(lb=jb.length;kb<lb;++kb)jb[kb]=5;var Wa=ja(jb);function Z(b,a){for(var c=b.j,d=b.e,f=b.input,e=b.c,g;d<a;)g=f[e++],g===t&&q(Error("input buffer is broken")),c|=g<<d,d+=8;g=c&(1<<a)-1;b.j=c>>>a;b.e=d-a;b.c=e;return g}function mb(b,a){for(var c=b.j,d=b.e,f=b.input,e=b.c,g=a[0],k=a[1],h,l,s;d<k;){h=f[e++];if(h===t)break;c|=h<<d;d+=8}l=g[c&(1<<k)-1];s=l>>>16;b.j=c>>s;b.e=d-s;b.c=e;return l&65535}function Xa(b){function a(a,b,c){var d,e,f,g;for(g=0;g<a;)switch(d=mb(this,b),d){case 16:for(f=3+Z(this,2);f--;)c[g++]=e;break;case 17:for(f=3+Z(this,3);f--;)c[g++]=0;e=0;break;case 18:for(f=11+Z(this,7);f--;)c[g++]=0;e=0;break;default:e=c[g++]=d}return c}var c=Z(b,5)+257,d=Z(b,5)+1,f=Z(b,4)+4,e=new(A?Uint8Array:Array)(Za.length),g,k,h,l;for(l=0;l<f;++l)e[Za[l]]=Z(b,3);g=ja(e);k=new(A?Uint8Array:Array)(c);h=new(A?Uint8Array:Array)(d);b.r(ja(a.call(b,c,g,k)),ja(a.call(b,d,g,h)))}Y.prototype.r=function(b,a){var c=this.a,d=this.b;this.A=b;for(var f=c.length-258,e,g,k,h;256!==(e=mb(this,b));)if(256>e)d>=f&&(this.b=d,c=this.f(),d=this.b),c[d++]=e;else{g=e-257;h=ab[g];0<cb[g]&&(h+=Z(this,cb[g]));e=mb(this,a);k=eb[e];0<gb[e]&&(k+=Z(this,gb[e]));d>=f&&(this.b=d,c=this.f(),d=this.b);for(;h--;)c[d]=c[d++-k]}for(;8<=this.e;)this.e-=8,this.c--;this.b=d};Y.prototype.Q=function(b,a){var c=this.a,d=this.b;this.A=b;for(var f=c.length,e,g,k,h;256!==(e=mb(this,b));)if(256>e)d>=f&&(c=this.f(),f=c.length),c[d++]=e;else{g=e-257;h=ab[g];0<cb[g]&&(h+=Z(this,cb[g]));e=mb(this,a);k=eb[e];0<gb[e]&&(k+=Z(this,gb[e]));d+h>f&&(c=this.f(),f=c.length);for(;h--;)c[d]=c[d++-k]}for(;8<=this.e;)this.e-=8,this.c--;this.b=d};Y.prototype.f=function(){var b=new(A?Uint8Array:Array)(this.b-32768),a=this.b-32768,c,d,f=this.a;if(A)b.set(f.subarray(32768,b.length));else{c=0;for(d=b.length;c<d;++c)b[c]=f[c+32768]}this.o.push(b);this.s+=b.length;if(A)f.set(f.subarray(a,a+32768));else for(c=0;32768>c;++c)f[c]=f[a+c];this.b=32768;return f};Y.prototype.S=function(b){var a,c=this.input.length/this.c+1|0,d,f,e,g=this.input,k=this.a;b&&("number"===typeof b.B&&(c=b.B),"number"===typeof b.M&&(c+=b.M));2>c?(d=(g.length-this.c)/this.A[2],e=258*(d/2)|0,f=e<k.length?k.length+e:k.length<<1):f=k.length*c;A?(a=new Uint8Array(f),a.set(k)):a=k;return this.a=a};Y.prototype.z=function(){var b=0,a=this.a,c=this.o,d,f=new(A?Uint8Array:Array)(this.s+(this.b-32768)),e,g,k,h;if(0===c.length)return A?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);e=0;for(g=c.length;e<g;++e){d=c[e];k=0;for(h=d.length;k<h;++k)f[b++]=d[k]}e=32768;for(g=this.b;e<g;++e)f[b++]=a[e];this.o=[];return this.buffer=f};Y.prototype.O=function(){var b,a=this.b;A?this.K?(b=new Uint8Array(a),b.set(this.a.subarray(0,a))):b=this.a.subarray(0,a):(this.a.length>a&&(this.a.length=a),b=this.a);return this.buffer=b};function nb(b){this.input=b;this.c=0;this.G=[];this.R=!1}nb.prototype.i=function(){for(var b=this.input.length;this.c<b;){var a=new ha,c=t,d=t,f=t,e=t,g=t,k=t,h=t,l=t,s=t,n=this.input,m=this.c;a.C=n[m++];a.D=n[m++];(31!==a.C||139!==a.D)&&q(Error("invalid file signature:"+a.C+","+a.D));a.v=n[m++];switch(a.v){case 8:break;default:q(Error("unknown compression method: "+a.v))}a.n=n[m++];l=n[m++]|n[m++]<<8|n[m++]<<16|n[m++]<<24;a.$=new Date(1e3*l);a.ba=n[m++];a.aa=n[m++];0<(a.n&4)&&(a.W=n[m++]|n[m++]<<8,m+=a.W);if(0<(a.n&Ba)){h=[];for(k=0;0<(g=n[m++]);)h[k++]=String.fromCharCode(g);a.name=h.join("")}if(0<(a.n&Ca)){h=[];for(k=0;0<(g=n[m++]);)h[k++]=String.fromCharCode(g);a.w=h.join("")}0<(a.n&Ra)&&(a.P=R(n,0,m)&65535,a.P!==(n[m++]|n[m++]<<8)&&q(Error("invalid header crc16")));c=n[n.length-4]|n[n.length-3]<<8|n[n.length-2]<<16|n[n.length-1]<<24;n.length-m-4-4<512*c&&(e=c);d=new Y(n,{index:m,bufferSize:e});a.data=f=d.i();m=d.c;a.Y=s=(n[m++]|n[m++]<<8|n[m++]<<16|n[m++]<<24)>>>0;R(f,t,t)!==s&&q(Error("invalid CRC-32 checksum: 0x"+R(f,t,t).toString(16)+" / 0x"+s.toString(16)));a.Z=c=(n[m++]|n[m++]<<8|n[m++]<<16|n[m++]<<24)>>>0;(f.length&4294967295)!==c&&q(Error("invalid input size: "+(f.length&4294967295)+" / "+c));this.G.push(a);this.c=m}this.R=u;var p=this.G,r,v,x=0,O=0,y;r=0;for(v=p.length;r<v;++r)O+=p[r].data.length;if(A){y=new Uint8Array(O);for(r=0;r<v;++r)y.set(p[r].data,x),x+=p[r].data.length}else{y=[];for(r=0;r<v;++r)y[r]=p[r].data;y=Array.prototype.concat.apply([],y)}return y};function ob(b){if("string"===typeof b){var a=b.split(""),c,d;c=0;for(d=a.length;c<d;c++)a[c]=(a[c].charCodeAt(0)&255)>>>0;b=a}for(var f=1,e=0,g=b.length,k,h=0;0<g;){k=1024<g?1024:g;g-=k;do f+=b[h++],e+=f;while(--k);f%=65521;e%=65521}return(e<<16|f)>>>0}function pb(b,a){var c,d;this.input=b;this.c=0;if(a||!(a={}))a.index&&(this.c=a.index),a.verify&&(this.V=a.verify);c=b[this.c++];d=b[this.c++];switch(c&15){case rb:this.method=rb;break;default:q(Error("unsupported compression method"))}0!==((c<<8)+d)%31&&q(Error("invalid fcheck flag:"+((c<<8)+d)%31));d&32&&q(Error("fdict flag is not supported"));this.J=new Y(b,{index:this.c,bufferSize:a.bufferSize,bufferType:a.bufferType,resize:a.resize})}pb.prototype.i=function(){var b=this.input,a,c;a=this.J.i();this.c=this.J.c;this.V&&(c=(b[this.c++]<<24|b[this.c++]<<16|b[this.c++]<<8|b[this.c++])>>>0,c!==ob(a)&&q(Error("invalid adler-32 checksum")));return a};var rb=8;function sb(b,a){this.input=b;this.a=new(A?Uint8Array:Array)(32768);this.k=tb.t;var c={},d;if((a||!(a={}))&&"number"===typeof a.compressionType)this.k=a.compressionType;for(d in a)c[d]=a[d];c.outputBuffer=this.a;this.I=new ma(this.input,c)}var tb=oa;sb.prototype.h=function(){var b,a,c,d,f,e,g,k=0;g=this.a;b=rb;switch(b){case rb:a=Math.LOG2E*Math.log(32768)-8;break;default:q(Error("invalid compression method"))}c=a<<4|b;g[k++]=c;switch(b){case rb:switch(this.k){case tb.NONE:f=0;break;case tb.L:f=1;break;case tb.t:f=2;break;default:q(Error("unsupported compression type"))}break;default:q(Error("invalid compression method"))}d=f<<6|0;g[k++]=d|31-(256*c+d)%31;e=ob(this.input);this.I.b=k;g=this.I.h();k=g.length;A&&(g=new Uint8Array(g.buffer),g.length<=k+4&&(this.a=new Uint8Array(g.length+4),this.a.set(g),g=this.a),g=g.subarray(0,k+4));g[k++]=e>>24&255;g[k++]=e>>16&255;g[k++]=e>>8&255;g[k++]=e&255;return g};exports.deflate=ub;exports.deflateSync=vb;exports.inflate=wb;exports.inflateSync=xb;exports.gzip=yb;exports.gzipSync=zb;exports.gunzip=Ab;exports.gunzipSync=Bb;function ub(b,a,c){process.nextTick(function(){var d,f;try{f=vb(b,c)}catch(e){d=e}a(d,f)})}function vb(b,a){var c;c=new sb(b).h();a||(a={});return a.H?c:Cb(c)}function wb(b,a,c){process.nextTick(function(){var d,f;try{f=xb(b,c)}catch(e){d=e}a(d,f)})}function xb(b,a){var c;b.subarray=b.slice;c=new pb(b).i();a||(a={});return a.noBuffer?c:Cb(c)}function yb(b,a,c){process.nextTick(function(){var d,f;try{f=zb(b,c)}catch(e){d=e}a(d,f)})}function zb(b,a){var c;b.subarray=b.slice;c=new Aa(b).h();a||(a={});return a.H?c:Cb(c)}function Ab(b,a,c){process.nextTick(function(){var d,f;try{f=Bb(b,c)}catch(e){d=e}a(d,f)})}function Bb(b,a){var c;b.subarray=b.slice;c=new nb(b).i();a||(a={});return a.H?c:Cb(c)}function Cb(b){var a=new Buffer(b.length),c,d;c=0;for(d=b.length;c<d;++c)a[c]=b[c];return a}}).call(this)},{__browserify_Buffer:509,__browserify_process:510}],87:[function(require,module,exports){var Buffer=require("__browserify_Buffer");(function(){var ever,zlib;zlib=require("zlib-browserify");ever=require("ever");module.exports=function(){return ever(this).on("message",function(ev){var compressedArrayBuffer,compressedArrayView,compressedBuffer,id;compressedArrayBuffer=ev.data.compressed;compressedArrayView=new Uint8Array(compressedArrayBuffer);compressedBuffer=new Buffer(compressedArrayView);id=ev.data.id;console.log("worker decomp start "+id+" len"+compressedBuffer.length);return zlib.inflate(compressedBuffer,function(_this){return function(err,decompressed){var decompressedBuffer;console.log("worker err"+err);if(err){_this.postMessage({id:id,err:err.toString()});return}decompressedBuffer=decompressed.buffer;return _this.postMessage({id:id,decompressed:decompressedBuffer},[decompressedBuffer])}}(this))})}}).call(this)},{__browserify_Buffer:509,ever:74,"zlib-browserify":85}],88:[function(require,module,exports){(function(){var CommandsPlugin,ItemPile,shellwords,__slice=[].slice;shellwords=require("shellwords");ItemPile=require("itempile");module.exports=function(game,opts){return new CommandsPlugin(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-console"]};CommandsPlugin=function(){function CommandsPlugin(game,opts){var _ref,_ref1;this.game=game;this.console=(_ref=this.game.plugins)!=null?_ref.get("voxel-console"):void 0;if(this.console==null){throw new Error("voxel-commands requires voxel-console")}this.registry=(_ref1=this.game.plugins)!=null?_ref1.get("voxel-registry"):void 0;if(this.registry==null){throw new Error("voxel-commands requires voxel-registry")}this.handlers={undefined:function(){var args,command;command=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];return this.console.log("Invalid command "+command+" "+args.join(" "))},help:function(){this.console.log("Available commands:");this.console.log(".pos x y z");this.console.log(".home");this.console.log(".item name [count [tags]]");this.console.log(".block name [data]");this.console.log(".plugins");this.console.log(".enable plugin");this.console.log(".disable plugin");if(this.game.plugins.isEnabled("voxel-health")){this.console.log(".heal")}if(this.game.plugins.isEnabled("voxel-webview")){this.console.log(".url address")}if(this.game.plugins.isEnabled("voxel-webview")){return this.console.log(".web")}},plugins:function(){var list,_ref2;list=(_ref2=this.game.plugins)!=null?_ref2.list():void 0;return this.console.log("Enabled plugins ("+list.length+"): "+list.join(" "))},enable:function(name){var _ref2;if((_ref2=this.game.plugins)!=null?_ref2.enable(name):void 0){return this.console.log("Enabled plugin: "+name)}else{return this.console.log("Failed to enable plugin: "+name)}},disable:function(name){if(this.game.plugins.disable(name)){return this.console.log("Disabled plugin: "+name)}else{return this.console.log("Failed to disable plugin: "+name)}},pos:function(x,y,z){var player,_ref2;player=(_ref2=this.game.plugins)!=null?_ref2.get("voxel-player"):void 0;if(player){player.moveTo(x,y,z);return this.console.log([player.position.x,player.position.y,player.position.z])}},home:function(){var _ref2,_ref3;return(_ref2=this.game.plugins)!=null?(_ref3=_ref2.get("voxel-player"))!=null?_ref3.home():void 0:void 0},item:function(name,count,tags){var carry,pile,props,_ref2;props=this.registry.getItemProps(name);if(props==null){this.console.log("No such item: "+name);return}if(count==null){count=1}count=parseInt(count,10);if(isNaN(count)){count=1}if(tags==null){tags=void 0}pile=new ItemPile(name,count,tags);carry=(_ref2=this.game.plugins)!=null?_ref2.get("voxel-carry"):void 0;if(carry){carry.inventory.give(pile);if(tags==null){tags=""}return this.console.log("Gave "+name+" x "+count+" "+tags)}},block:function(name,data){var blockdata,dataInfo,hit,index,oldData,oldIndex,oldName,reachDistance,x,y,z,_ref2,_ref3;if(name!=null){index=this.registry.getBlockIndex(name);if(index==null){this.console.log("No such block: "+name);return}}reachDistance=8;hit=this.game.raycastVoxels(this.game.cameraPosition(),this.game.cameraVector(),reachDistance);if(!hit){this.console.log("No block targetted");return}_ref2=hit.voxel,x=_ref2[0],y=_ref2[1],z=_ref2[2];oldIndex=hit.value;oldName=this.registry.getBlockName(oldIndex);if(name!=null){this.game.setBlock(hit.voxel,index)}blockdata=(_ref3=this.game.plugins)!=null?_ref3.get("voxel-blockdata"):void 0;if(blockdata!=null){oldData=blockdata.get(x,y,z);if(data!=null){blockdata.set(x,y,z,data)}}dataInfo="";if(oldData!=null){dataInfo=""+JSON.stringify(oldData)+" -> "}if(data==null){data=oldData}if(oldData!=null){dataInfo+=JSON.stringify(data)}if(name==null){name=oldName}if(index==null){index=oldIndex}return this.console.log("Set ("+x+", "+y+", "+z+") "+oldName+"/"+oldIndex+" -> "+name+"/"+index+"  "+dataInfo)},heal:function(){return this.game.plugins.get("voxel-health").heal(999)},url:function(address){if(this.game.plugins.get("voxel-webview")){return document.getElementById("voxel-webview").src=address}},web:function(){var z;if(this.game.plugins.get("voxel-webview")){z=document.getElementById("voxel-webview").parentElement.parentElement.style.zIndex;return document.getElementById("voxel-webview").parentElement.parentElement.style.zIndex={"-1":0,0:-1}[z]}}};this.handlers.p=this.handlers.position=this.handlers.tp=this.handlers.pos;this.handlers.i=this.handlers.give=this.handlers.item;this.handlers.b=this.handlers.setblock=this.handlers.set=this.handlers.block;this.enable()}CommandsPlugin.prototype.process=function(input){var args,command,connection,handler,words,_ref,_ref1;if(input.indexOf(".")!==0){this.console.log(input);connection=(_ref=this.game.plugins)!=null?(_ref1=_ref.get("voxel-client"))!=null?_ref1.connection:void 0:void 0;if(connection!=null){connection.emit("chat",{message:input})}else{this.console.log("Not connected to server. Type .help for commands")}return}input=input.substring(1);words=shellwords.split(input);command=words[0],args=2<=words.length?__slice.call(words,1):[];handler=this.handlers[command];if(handler==null){handler=this.handlers.undefined;args.unshift(command)}return handler.apply(this,args)};CommandsPlugin.prototype.enable=function(){var _ref,_ref1,_ref2;if((_ref=this.console.widget)!=null){_ref.on("input",this.onInput=function(_this){return function(input){return _this.process(input)}}(this))}return(_ref1=this.game.plugins)!=null?(_ref2=_ref1.get("voxel-client"))!=null?_ref2.connection.on("chat",this.onChat=function(_this){return function(input){var _ref3;return _this.console.log((_ref3=input.message)!=null?_ref3:input)}}(this)):void 0:void 0};CommandsPlugin.prototype.disable=function(){var _ref,_ref1;this.console.widget.removeListener("input",this.onInput);return(_ref=this.game.plugins)!=null?(_ref1=_ref.get("voxel-client"))!=null?_ref1.connection.removeListener("chat",this.onChat):void 0:void 0};return CommandsPlugin}()}).call(this)},{itempile:89,shellwords:94}],89:[function(require,module,exports){(function(){var ItemPile,clone,deepEqual;deepEqual=require("deep-equal");clone=require("clone");module.exports=ItemPile=function(){function ItemPile(item,count,tags){this.item=typeof item==="string"?ItemPile.itemFromString(item):item;this.count=count!=null?count:1;this.tags=tags!=null?tags:{}}ItemPile.prototype.clone=function(){return new ItemPile(this.item,this.count,clone(this.tags,false))};ItemPile.maxPileSize=64;ItemPile.itemFromString=function(s){if(s instanceof ItemPile){return s}if(!s){return""}else{return s}};ItemPile.itemToString=function(item){return""+item};ItemPile.prototype.hasTags=function(){return Object.keys(this.tags).length!==0};ItemPile.prototype.matchesType=function(itemPile){return this.item===itemPile.item};ItemPile.prototype.matchesTypeAndCount=function(itemPile){return this.item===itemPile.item&&this.count===itemPile.count};ItemPile.prototype.matchesTypeAndTags=function(itemPile){return this.item===itemPile.item&&deepEqual(this.tags,itemPile.tags,{strict:true})};ItemPile.prototype.matchesAll=function(itemPile){return this.matchesTypeAndCount(itemPile)&&deepEqual(this.tags,itemPile.tags,{strict:true})};ItemPile.prototype.canPileWith=function(itemPile){if(itemPile.item!==this.item){return false}if(itemPile.count===0||this.count===0){return true}if(itemPile.hasTags()||this.hasTags()){return false}return true};ItemPile.prototype.mergePile=function(itemPile){if(!this.canPileWith(itemPile)){return false}return itemPile.count=this.increase(itemPile.count)};ItemPile.prototype.increase=function(n){var excessCount,newCount,_ref;_ref=this.tryAdding(n),newCount=_ref[0],excessCount=_ref[1];this.count=newCount;return excessCount};ItemPile.prototype.decrease=function(n){var remainingCount,removedCount,_ref;_ref=this.trySubtracting(n),removedCount=_ref[0],remainingCount=_ref[1];this.count=remainingCount;return removedCount};ItemPile.prototype.tryAdding=function(n){var sum;sum=this.count+n;if(sum>ItemPile.maxPileSize&&this.count!==Infinity){return[ItemPile.maxPileSize,sum-ItemPile.maxPileSize]}else{return[sum,0]}};ItemPile.prototype.trySubtracting=function(n){var difference;difference=this.count-n;if(difference<0){return[this.count,n-this.count]}else{return[n,this.count-n]}};ItemPile.prototype.splitPile=function(n){if(n<0){n=this.count+n}else if(n<1){n=Math.ceil(this.count*n)}if(n>this.count){return false}if(n!==Infinity){this.count-=n}return new ItemPile(this.item,n,clone(this.tags,false))};ItemPile.prototype.toString=function(){if(this.hasTags()){return""+this.count+":"+this.item+" "+JSON.stringify(this.tags)}else{return""+this.count+":"+this.item}};ItemPile.fromString=function(s){var a,count,countStr,item,itemStr,tags,tagsStr,_;a=s.match(/^([^:]+):([^ ]+) ?(.*)/);if(!a){return void 0}_=a[0],countStr=a[1],itemStr=a[2],tagsStr=a[3];count=parseInt(countStr,10);item=ItemPile.itemFromString(itemStr);if(tagsStr&&tagsStr.length){tags=JSON.parse(tagsStr)}else{tags={}}return new ItemPile(item,count,tags)};return ItemPile}()}).call(this)},{clone:90,"deep-equal":91}],90:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],91:[function(require,module,exports){var pSlice=Array.prototype.slice;var objectKeys=require("./lib/keys.js");var isArguments=require("./lib/is_arguments.js");var deepEqual=module.exports=function(actual,expected,opts){if(!opts)opts={};if(actual===expected){return true}else if(actual instanceof Date&&expected instanceof Date){return actual.getTime()===expected.getTime()}else if(typeof actual!="object"&&typeof expected!="object"){return opts.strict?actual===expected:actual==expected}else{return objEquiv(actual,expected,opts)}};function isUndefinedOrNull(value){return value===null||value===undefined}function objEquiv(a,b,opts){if(isUndefinedOrNull(a)||isUndefinedOrNull(b))return false;if(a.prototype!==b.prototype)return false;if(isArguments(a)){if(!isArguments(b)){return false}a=pSlice.call(a);b=pSlice.call(b);return deepEqual(a,b,opts)}try{var ka=objectKeys(a),kb=objectKeys(b),key,i}catch(e){return false}if(ka.length!=kb.length)return false;ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!=kb[i])return false}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!deepEqual(a[key],b[key],opts))return false}return true}},{"./lib/is_arguments.js":92,"./lib/keys.js":93}],92:[function(require,module,exports){var supportsArgumentsClass=function(){return Object.prototype.toString.call(arguments)}()=="[object Arguments]";exports=module.exports=supportsArgumentsClass?supported:unsupported;exports.supported=supported;function supported(object){return Object.prototype.toString.call(object)=="[object Arguments]"}exports.unsupported=unsupported;function unsupported(object){return object&&typeof object=="object"&&typeof object.length=="number"&&Object.prototype.hasOwnProperty.call(object,"callee")&&!Object.prototype.propertyIsEnumerable.call(object,"callee")||false}},{}],93:[function(require,module,exports){exports=module.exports=typeof Object.keys==="function"?Object.keys:shim;exports.shim=shim;function shim(obj){var keys=[];for(var key in obj)keys.push(key);return keys}},{}],94:[function(require,module,exports){(function(){var scan;scan=function(string,pattern,callback){var match,result;result="";while(string.length>0){match=string.match(pattern);if(match){result+=string.slice(0,match.index);result+=callback(match);string=string.slice(match.index+match[0].length)}else{result+=string;string=""}}return result};exports.split=function(line){var field,words;if(line==null){line=""}words=[];field="";scan(line,/\s*(?:([^\s\\\'\"]+)|'((?:[^\'\\]|\\.)*)'|"((?:[^\"\\]|\\.)*)"|(\\.?)|(\S))(\s|$)?/,function(match){var dq,escape,garbage,raw,seperator,sq,word;raw=match[0],word=match[1],sq=match[2],dq=match[3],escape=match[4],garbage=match[5],seperator=match[6];if(garbage!=null){throw new Error("Unmatched quote")}field+=word||(sq||dq||escape).replace(/\\(?=.)/,"");if(seperator!=null){words.push(field);return field=""}});if(field){words.push(field)}return words};exports.escape=function(str){if(str==null){str=""}if(str==null){return"''"}return str.replace(/([^A-Za-z0-9_\-.,:\/@\n])/g,"\\$1").replace(/\n/g,"'\n'")}}).call(this)},{}],95:[function(require,module,exports){(function(){var Console,ConsoleWidget,Modal,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};Modal=require("voxel-modal");ConsoleWidget=require("console-widget");module.exports=function(game,opts){return new Console(game,opts)};Console=function(_super){__extends(Console,_super);function Console(game,opts){var widgetOpts,_base;this.game=game;this.opts=opts;if(!this.game.isClient){return}if((_base=this.opts).includeTextBindings==null){_base.includeTextBindings={console:void 0,console2:"/",console3:"."}}widgetOpts=this.opts;widgetOpts.closeKeys=[];this.widget=ConsoleWidget(widgetOpts);this.bindKeys();Console.__super__.constructor.call(this,game,{element:this.widget.containerNode})}Console.prototype.bindKeys=function(){return["console","console2","console3"].forEach(function(_this){return function(binding){if(_this.game.buttons.down==null){throw new Error("voxel-console requires @game.buttons set to kb-bindings instance (vs kb-controls)")}return _this.game.buttons.down.on(binding,function(){var initialText;initialText=_this.opts.includeTextBindings[binding];return _this.open(initialText)})}}(this))};Console.prototype.open=function(initialText){if(initialText==null){initialText=void 0}Console.__super__.open.call(this);return this.widget.open(initialText)};Console.prototype.close=function(){return Console.__super__.close.call(this)};Console.prototype.log=function(text){return this.widget.log(text)};Console.prototype.logNode=function(node){return this.widget.logNode(node)};return Console}(Modal)}).call(this)},{"console-widget":96,"voxel-modal":98}],96:[function(require,module,exports){(function(){var ConsoleWidget,EventEmitter,MAX_LINES,vkey,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};EventEmitter=require("events").EventEmitter;vkey=require("vkey");MAX_LINES=999;ConsoleWidget=function(_super){__extends(ConsoleWidget,_super);function ConsoleWidget(opts){var _base,_base1,_base2,_base3,_base4,_base5;this.opts=opts;if(this.opts==null){this.opts={}}if((_base=this.opts).widthPx==null){_base.widthPx=500}if((_base1=this.opts).rows==null){_base1.rows=10}if((_base2=this.opts).lineHeightPx==null){_base2.lineHeightPx=20}if((_base3=this.opts).font==null){_base3.font="12pt Menlo, Courier, 'Courier New', monospace"}if((_base4=this.opts).backgroundImage==null){_base4.backgroundImage="linear-gradient(rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.6) 100%)"}if((_base5=this.opts).closeKeys==null){_base5.closeKeys=["<escape>"]}this.history=[];this.historyCursor=this.history.length;this.createNodes()}ConsoleWidget.prototype.show=function(){return this.containerNode.style.visibility=""};ConsoleWidget.prototype.hide=function(){return this.containerNode.style.visibility="hidden"};ConsoleWidget.prototype.open=function(text){if(text==null){text=void 0}this.show();if(text!=null){this.setInput(text)}this.registerEvents();return this.focusInput()};ConsoleWidget.prototype.close=function(){this.unregisterEvents();return this.hide()};ConsoleWidget.prototype.isOpen=function(){return this.containerNode.style.visibility!=="hidden"};ConsoleWidget.prototype.log=function(text){return this.logNode(document.createTextNode(text))};ConsoleWidget.prototype.logNode=function(node){this.outputNode.appendChild(node);this.outputNode.appendChild(document.createElement("br"));return this.scrollOutput()};ConsoleWidget.prototype.focusInput=function(){return this.inputNode.focus()};ConsoleWidget.prototype.setInput=function(text){return this.inputNode.value=text};ConsoleWidget.prototype.scrollOutput=function(){var _base;return typeof(_base=this.outputNode).scrollByLines==="function"?_base.scrollByLines(MAX_LINES+1):void 0};ConsoleWidget.prototype.createNodes=function(){this.containerNode=document.createElement("div");this.containerNode.setAttribute("style","width: "+this.opts.widthPx+"px; height: "+this.opts.lineHeightPx*this.opts.rows+"px; border: 1px solid white; color: white; visibility: hidden; bottom: 0px; position: absolute; font: "+this.opts.font+"; background-image: "+this.opts.backgroundImage+";");this.outputNode=document.createElement("div");this.outputNode.setAttribute("style","overflow-y: scroll; width: 100%; height: "+this.opts.lineHeightPx*(this.opts.rows-1)+"px;");this.inputNode=document.createElement("input");this.inputNode.setAttribute("style","width: 100%; height: "+this.opts.lineHeightPx+"px; padding: 0px; border: 1px dashed white; background-color: transparent; color: white; font: "+this.opts.font+";");this.containerNode.appendChild(this.outputNode);this.containerNode.appendChild(this.inputNode);return document.body.appendChild(this.containerNode)};ConsoleWidget.prototype.registerEvents=function(){return document.body.addEventListener("keydown",this.onKeydown=function(_this){return function(ev){var key,preventDefault,_base,_base1,_base2,_base3,_base4,_base5,_base6,_base7;key=vkey[ev.keyCode];preventDefault=true;if(key==="<enter>"){if(_this.inputNode.value.length===0){return}_this.history.push(_this.inputNode.value);_this.historyCursor=_this.history.length-1;_this.emit("input",_this.inputNode.value);_this.inputNode.value=""}else if(key==="<up>"){if(ev.shiftKey){if(typeof(_base=_this.outputNode).scrollByLines==="function"){_base.scrollByLines(-1)}}else{if(_this.history[_this.historyCursor]!=null){_this.inputNode.value=_this.history[_this.historyCursor]}_this.historyCursor-=1;if(_this.historyCursor<0){_this.historyCursor=0}}}else if(key==="<down>"){if(ev.shiftKey){if(typeof(_base1=_this.outputNode).scrollByLines==="function"){_base1.scrollByLines(1)}}else{if(_this.history[_this.historyCursor]!=null){_this.inputNode.value=_this.history[_this.historyCursor]}_this.historyCursor+=1;if(_this.historyCursor>_this.history.length-1){_this.historyCursor=_this.history.length-1}}}else if(key==="<page-up>"){if(ev.shiftKey){if(typeof(_base2=_this.outputNode).scrollByLines==="function"){_base2.scrollByLines(-1)}}else if(ev.ctrlKey||ev.metaKey){if(typeof(_base3=_this.outputNode).scrollByLines==="function"){_base3.scrollByLines(-MAX_LINES)}}else{if(typeof(_base4=_this.outputNode).scrollByPages==="function"){_base4.scrollByPages(-1)}}}else if(key==="<page-down>"){if(ev.shiftKey){if(typeof(_base5=_this.outputNode).scrollByLines==="function"){_base5.scrollByLines(1)}}else if(ev.ctrlKey||ev.metaKey){if(typeof(_base6=_this.outputNode).scrollByLines==="function"){_base6.scrollByLines(MAX_LINES)}}else{if(typeof(_base7=_this.outputNode).scrollByPages==="function"){_base7.scrollByPages(1)}}}else if(_this.opts.closeKeys.indexOf(key)!==-1){_this.close()}else{preventDefault=false}if(preventDefault){return ev.preventDefault()}}}(this))};ConsoleWidget.prototype.unregisterEvents=function(){return document.body.removeEventListener("keydown",this.onKeydown)};return ConsoleWidget}(EventEmitter);module.exports=function(opts){return new ConsoleWidget(opts)}}).call(this)},{events:507,vkey:97}],97:[function(require,module,exports){module.exports=require(25)},{}],98:[function(require,module,exports){arguments[4][68][0].apply(exports,arguments)},{ever:99}],99:[function(require,module,exports){module.exports=require(40)
},{"./init.json":100,"./types.json":101,events:507}],100:[function(require,module,exports){module.exports=require(41)},{}],101:[function(require,module,exports){module.exports=require(42)},{}],102:[function(require,module,exports){(function(){var DaylightPlugin;module.exports=function(game,opts){return new DaylightPlugin(game,opts)};DaylightPlugin=function(){function DaylightPlugin(game,opts){this.game=game;if(opts==null){opts={}}if(opts.ambientColor==null){opts.ambientColor=8947848}if(opts.directionalColor==null){opts.directionalColor=16777215}this.ambientLight=new game.THREE.AmbientLight(opts.ambientColor);this.directionalLight=new game.THREE.DirectionalLight(opts.directionalColor,1);this.directionalLight.position.set(1,1,.5).normalize();this.enable()}DaylightPlugin.prototype.enable=function(){this.game.scene.add(this.ambientLight);return this.game.scene.add(this.directionalLight)};DaylightPlugin.prototype.disable=function(){this.game.scene.remove(this.ambientLight);return this.game.scene.remove(this.directionalLight)};return DaylightPlugin}()}).call(this)},{}],103:[function(require,module,exports){function Debug(game,opts){opts=opts||{};if(opts.THREE)game=opts;this.game=game;this.gui=opts.gui||new(require("dat-gui").GUI);this.liveData=true;this._datum=[];this._init();this.open();this.enable()}module.exports=function(game,opts){return new Debug(game,opts)};module.exports.pluginInfo={clientOnly:true};module.exports.Debug=Debug;Debug.prototype.enable=function(){this.gui.domElement.style.opacity=1};Debug.prototype.disable=function(){this.gui.domElement.style.opacity=0};Debug.prototype.axis=function(p,size){p=p||[0,1,0];var helper=new this.game.THREE.AxisHelper(size||10);helper.position.set(p[0],p[1],p[2]);this.game.scene.add(helper);return helper};Debug.prototype.open=function(){(function open(folder){folder.open();for(var i in folder.__folders){open(folder.__folders[i])}})(this.folder)};Debug.prototype.close=function(){(function close(folder){folder.close();for(var i in folder.__folders){close(folder.__folders[i])}})(this.folder)};Debug.prototype._init=function(){var self=this;this.folder=this.gui.addFolder("debug");this.folder.add(this,"liveData").listen();this.folder.add(this.game,"paused");this._player();this._camera();this._chunks();this._render();function update(folder){for(var i in folder.__controllers){folder.__controllers[i].updateDisplay()}for(var i in folder.__folders){update(folder.__folders[i])}}this.game.on("tick",function(){if(self.liveData===true){for(var i in self._datum){self._datum[i].update()}update(self.folder)}});this.folder.open();return this.folder};Debug.prototype._player=function(){var folder=this.folder.addFolder("game.controls.target().avatar");function subfolder(name,el){var sub=folder.addFolder(name);sub.add(el,"x");sub.add(el,"y");sub.add(el,"z")}subfolder("position",this.game.controls.target().avatar.position);subfolder("rotation",this.game.controls.target().avatar.rotation)};Debug.prototype._camera=function(){var self=this;function Camera(prop){var selfself=this;this.x=.01;this.y=.01;this.z=.01;this.update=function(){var p=self.game[prop]();selfself.x=p[0];selfself.y=p[1];selfself.z=p[2]};self._datum.push(this)}var campos=this.folder.addFolder("game.cameraPosition()");var pos=new Camera("cameraPosition");campos.add(pos,"x");campos.add(pos,"y");campos.add(pos,"z");var camrot=this.folder.addFolder("game.cameraVector()");var vec=new Camera("cameraVector");camrot.add(vec,"x");camrot.add(vec,"y");camrot.add(vec,"z")};Debug.prototype._chunks=function(){var self=this;var folder=this.folder.addFolder("chunks");function Data(){var selfself=this;this.chunksLoaded=0;this.pendingChunks=0;this.voxels=0;this.update=function(){selfself.chunksLoaded=Object.keys(self.game.voxels.chunks).length;selfself.pendingChunks=self.game.pendingChunks.length;selfself.voxels=selfself.chunksLoaded*self.game.chunkSize*self.game.chunkSize*self.game.chunkSize};self._datum.push(this)}var d=new Data;folder.add(d,"chunksLoaded");folder.add(d,"pendingChunks");folder.add(d,"voxels")};Debug.prototype._render=function(){var self=this;var folder=this.folder.addFolder("render");this.mesherName="transgreedy";folder.add(this,"mesherName",["greedy","transgreedy","culled"]).onChange(function(value){self.game.mesher=require("voxel").meshers[value];self.game.showAllChunks()});folder.add(this.game,"meshType",["surfaceMesh","wireMesh"]).onChange(function(value){self.game.showAllChunks()});if(this.game.texture_modules&&this.game.texture_modules.length>1){this.useShader=true;folder.add(this,"useShader").onChange(function(value){var i=value?0:1;var old_names;if(self.game.materials.names){self.old_names=self.game.materials.names}self.game.texture_opts.game=self.game;self.game.materials=self.game.texture_modules[i](self.game.texture_opts);self.game.materials.load(self.old_names);self.game.showAllChunks()})}if(this.game.materials.opts!==undefined){this.useTransparency=this.game.materials.opts.useTransparency;folder.add(this,"useTransparency").onChange(function(value){self.game.materials.opts.useTransparency=value;self.game.materials=self.game.materials.reconfigure();self.game.showAllChunks()});this.useFourTap=this.game.materials.opts.useFourTap;folder.add(this,"useFourTap").onChange(function(value){self.game.materials.opts.useFourTap=value;self.game.materials=self.game.materials.reconfigure();self.game.showAllChunks()});this.tilepad=this.game.materials.opts.tilepad;folder.add(this,"tilepad").onChange(function(value){self.game.materials.opts.tilepad=value;self.game.materials=self.game.materials.reconfigure();self.game.showAllChunks()})}if(this.game.materials.texturePath!==undefined){this.texturePack=this.game.materials.texturePath.split("/")[1];folder.add(this,"texturePack").onFinishChange(function(value){self.game.materials.opts.texturePath="AssetPacks/"+value+"/textures/blocks/";self.game.materials=self.game.materials.reconfigure();var mine=self.game.plugins&&self.game.plugins.get("mine");if(mine)mine.setupTextures();self.game.showAllChunks()})}}},{"dat-gui":104,voxel:108}],104:[function(require,module,exports){module.exports=require("./vendor/dat.gui");module.exports.color=require("./vendor/dat.color")},{"./vendor/dat.color":105,"./vendor/dat.gui":106}],105:[function(require,module,exports){var dat=module.exports=dat||{};dat.color=dat.color||{};dat.utils=dat.utils||{};dat.utils.common=function(){var ARR_EACH=Array.prototype.forEach;var ARR_SLICE=Array.prototype.slice;return{BREAK:{},extend:function(target){this.each(ARR_SLICE.call(arguments,1),function(obj){for(var key in obj)if(!this.isUndefined(obj[key]))target[key]=obj[key]},this);return target},defaults:function(target){this.each(ARR_SLICE.call(arguments,1),function(obj){for(var key in obj)if(this.isUndefined(target[key]))target[key]=obj[key]},this);return target},compose:function(){var toCall=ARR_SLICE.call(arguments);return function(){var args=ARR_SLICE.call(arguments);for(var i=toCall.length-1;i>=0;i--){args=[toCall[i].apply(this,args)]}return args[0]}},each:function(obj,itr,scope){if(ARR_EACH&&obj.forEach===ARR_EACH){obj.forEach(itr,scope)}else if(obj.length===obj.length+0){for(var key=0,l=obj.length;key<l;key++)if(key in obj&&itr.call(scope,obj[key],key)===this.BREAK)return}else{for(var key in obj)if(itr.call(scope,obj[key],key)===this.BREAK)return}},defer:function(fnc){setTimeout(fnc,0)},toArray:function(obj){if(obj.toArray)return obj.toArray();return ARR_SLICE.call(obj)},isUndefined:function(obj){return obj===undefined},isNull:function(obj){return obj===null},isNaN:function(obj){return obj!==obj},isArray:Array.isArray||function(obj){return obj.constructor===Array},isObject:function(obj){return obj===Object(obj)},isNumber:function(obj){return obj===obj+0},isString:function(obj){return obj===obj+""},isBoolean:function(obj){return obj===false||obj===true},isFunction:function(obj){return Object.prototype.toString.call(obj)==="[object Function]"}}}();dat.color.toString=function(common){return function(color){if(color.a==1||common.isUndefined(color.a)){var s=color.hex.toString(16);while(s.length<6){s="0"+s}return"#"+s}else{return"rgba("+Math.round(color.r)+","+Math.round(color.g)+","+Math.round(color.b)+","+color.a+")"}}}(dat.utils.common);dat.Color=dat.color.Color=function(interpret,math,toString,common){var Color=function(){this.__state=interpret.apply(this,arguments);if(this.__state===false){throw"Failed to interpret color arguments"}this.__state.a=this.__state.a||1};Color.COMPONENTS=["r","g","b","h","s","v","hex","a"];common.extend(Color.prototype,{toString:function(){return toString(this)},toOriginal:function(){return this.__state.conversion.write(this)}});defineRGBComponent(Color.prototype,"r",2);defineRGBComponent(Color.prototype,"g",1);defineRGBComponent(Color.prototype,"b",0);defineHSVComponent(Color.prototype,"h");defineHSVComponent(Color.prototype,"s");defineHSVComponent(Color.prototype,"v");Object.defineProperty(Color.prototype,"a",{get:function(){return this.__state.a},set:function(v){this.__state.a=v}});Object.defineProperty(Color.prototype,"hex",{get:function(){if(!this.__state.space!=="HEX"){this.__state.hex=math.rgb_to_hex(this.r,this.g,this.b)}return this.__state.hex},set:function(v){this.__state.space="HEX";this.__state.hex=v}});function defineRGBComponent(target,component,componentHexIndex){Object.defineProperty(target,component,{get:function(){if(this.__state.space==="RGB"){return this.__state[component]}recalculateRGB(this,component,componentHexIndex);return this.__state[component]},set:function(v){if(this.__state.space!=="RGB"){recalculateRGB(this,component,componentHexIndex);this.__state.space="RGB"}this.__state[component]=v}})}function defineHSVComponent(target,component){Object.defineProperty(target,component,{get:function(){if(this.__state.space==="HSV")return this.__state[component];recalculateHSV(this);return this.__state[component]},set:function(v){if(this.__state.space!=="HSV"){recalculateHSV(this);this.__state.space="HSV"}this.__state[component]=v}})}function recalculateRGB(color,component,componentHexIndex){if(color.__state.space==="HEX"){color.__state[component]=math.component_from_hex(color.__state.hex,componentHexIndex)}else if(color.__state.space==="HSV"){common.extend(color.__state,math.hsv_to_rgb(color.__state.h,color.__state.s,color.__state.v))}else{throw"Corrupted color state"}}function recalculateHSV(color){var result=math.rgb_to_hsv(color.r,color.g,color.b);common.extend(color.__state,{s:result.s,v:result.v});if(!common.isNaN(result.h)){color.__state.h=result.h}else if(common.isUndefined(color.__state.h)){color.__state.h=0}}return Color}(dat.color.interpret=function(toString,common){var result,toReturn;var interpret=function(){toReturn=false;var original=arguments.length>1?common.toArray(arguments):arguments[0];common.each(INTERPRETATIONS,function(family){if(family.litmus(original)){common.each(family.conversions,function(conversion,conversionName){result=conversion.read(original);if(toReturn===false&&result!==false){toReturn=result;result.conversionName=conversionName;result.conversion=conversion;return common.BREAK}});return common.BREAK}});return toReturn};var INTERPRETATIONS=[{litmus:common.isString,conversions:{THREE_CHAR_HEX:{read:function(original){var test=original.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);if(test===null)return false;return{space:"HEX",hex:parseInt("0x"+test[1].toString()+test[1].toString()+test[2].toString()+test[2].toString()+test[3].toString()+test[3].toString())}},write:toString},SIX_CHAR_HEX:{read:function(original){var test=original.match(/^#([A-F0-9]{6})$/i);if(test===null)return false;return{space:"HEX",hex:parseInt("0x"+test[1].toString())}},write:toString},CSS_RGB:{read:function(original){var test=original.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);if(test===null)return false;return{space:"RGB",r:parseFloat(test[1]),g:parseFloat(test[2]),b:parseFloat(test[3])}},write:toString},CSS_RGBA:{read:function(original){var test=original.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\,\s*(.+)\s*\)/);if(test===null)return false;return{space:"RGB",r:parseFloat(test[1]),g:parseFloat(test[2]),b:parseFloat(test[3]),a:parseFloat(test[4])}},write:toString}}},{litmus:common.isNumber,conversions:{HEX:{read:function(original){return{space:"HEX",hex:original,conversionName:"HEX"}},write:function(color){return color.hex}}}},{litmus:common.isArray,conversions:{RGB_ARRAY:{read:function(original){if(original.length!=3)return false;return{space:"RGB",r:original[0],g:original[1],b:original[2]}},write:function(color){return[color.r,color.g,color.b]}},RGBA_ARRAY:{read:function(original){if(original.length!=4)return false;return{space:"RGB",r:original[0],g:original[1],b:original[2],a:original[3]}},write:function(color){return[color.r,color.g,color.b,color.a]}}}},{litmus:common.isObject,conversions:{RGBA_OBJ:{read:function(original){if(common.isNumber(original.r)&&common.isNumber(original.g)&&common.isNumber(original.b)&&common.isNumber(original.a)){return{space:"RGB",r:original.r,g:original.g,b:original.b,a:original.a}}return false},write:function(color){return{r:color.r,g:color.g,b:color.b,a:color.a}}},RGB_OBJ:{read:function(original){if(common.isNumber(original.r)&&common.isNumber(original.g)&&common.isNumber(original.b)){return{space:"RGB",r:original.r,g:original.g,b:original.b}}return false},write:function(color){return{r:color.r,g:color.g,b:color.b}}},HSVA_OBJ:{read:function(original){if(common.isNumber(original.h)&&common.isNumber(original.s)&&common.isNumber(original.v)&&common.isNumber(original.a)){return{space:"HSV",h:original.h,s:original.s,v:original.v,a:original.a}}return false},write:function(color){return{h:color.h,s:color.s,v:color.v,a:color.a}}},HSV_OBJ:{read:function(original){if(common.isNumber(original.h)&&common.isNumber(original.s)&&common.isNumber(original.v)){return{space:"HSV",h:original.h,s:original.s,v:original.v}}return false},write:function(color){return{h:color.h,s:color.s,v:color.v}}}}}];return interpret}(dat.color.toString,dat.utils.common),dat.color.math=function(){var tmpComponent;return{hsv_to_rgb:function(h,s,v){var hi=Math.floor(h/60)%6;var f=h/60-Math.floor(h/60);var p=v*(1-s);var q=v*(1-f*s);var t=v*(1-(1-f)*s);var c=[[v,t,p],[q,v,p],[p,v,t],[p,q,v],[t,p,v],[v,p,q]][hi];return{r:c[0]*255,g:c[1]*255,b:c[2]*255}},rgb_to_hsv:function(r,g,b){var min=Math.min(r,g,b),max=Math.max(r,g,b),delta=max-min,h,s;if(max!=0){s=delta/max}else{return{h:NaN,s:0,v:0}}if(r==max){h=(g-b)/delta}else if(g==max){h=2+(b-r)/delta}else{h=4+(r-g)/delta}h/=6;if(h<0){h+=1}return{h:h*360,s:s,v:max/255}},rgb_to_hex:function(r,g,b){var hex=this.hex_with_component(0,2,r);hex=this.hex_with_component(hex,1,g);hex=this.hex_with_component(hex,0,b);return hex},component_from_hex:function(hex,componentIndex){return hex>>componentIndex*8&255},hex_with_component:function(hex,componentIndex,value){return value<<(tmpComponent=componentIndex*8)|hex&~(255<<tmpComponent)}}}(),dat.color.toString,dat.utils.common)},{}],106:[function(require,module,exports){var dat=module.exports=dat||{};dat.gui=dat.gui||{};dat.utils=dat.utils||{};dat.controllers=dat.controllers||{};dat.dom=dat.dom||{};dat.color=dat.color||{};dat.utils.css=function(){return{load:function(url,doc){doc=doc||document;var link=doc.createElement("link");link.type="text/css";link.rel="stylesheet";link.href=url;doc.getElementsByTagName("head")[0].appendChild(link)},inject:function(css,doc){doc=doc||document;var injected=document.createElement("style");injected.type="text/css";injected.innerHTML=css;doc.getElementsByTagName("head")[0].appendChild(injected)}}}();dat.utils.common=function(){var ARR_EACH=Array.prototype.forEach;var ARR_SLICE=Array.prototype.slice;return{BREAK:{},extend:function(target){this.each(ARR_SLICE.call(arguments,1),function(obj){for(var key in obj)if(!this.isUndefined(obj[key]))target[key]=obj[key]},this);return target},defaults:function(target){this.each(ARR_SLICE.call(arguments,1),function(obj){for(var key in obj)if(this.isUndefined(target[key]))target[key]=obj[key]},this);return target},compose:function(){var toCall=ARR_SLICE.call(arguments);return function(){var args=ARR_SLICE.call(arguments);for(var i=toCall.length-1;i>=0;i--){args=[toCall[i].apply(this,args)]}return args[0]}},each:function(obj,itr,scope){if(ARR_EACH&&obj.forEach===ARR_EACH){obj.forEach(itr,scope)}else if(obj.length===obj.length+0){for(var key=0,l=obj.length;key<l;key++)if(key in obj&&itr.call(scope,obj[key],key)===this.BREAK)return}else{for(var key in obj)if(itr.call(scope,obj[key],key)===this.BREAK)return}},defer:function(fnc){setTimeout(fnc,0)},toArray:function(obj){if(obj.toArray)return obj.toArray();return ARR_SLICE.call(obj)},isUndefined:function(obj){return obj===undefined},isNull:function(obj){return obj===null},isNaN:function(obj){return obj!==obj},isArray:Array.isArray||function(obj){return obj.constructor===Array},isObject:function(obj){return obj===Object(obj)},isNumber:function(obj){return obj===obj+0},isString:function(obj){return obj===obj+""},isBoolean:function(obj){return obj===false||obj===true},isFunction:function(obj){return Object.prototype.toString.call(obj)==="[object Function]"}}}();dat.controllers.Controller=function(common){var Controller=function(object,property){this.initialValue=object[property];this.domElement=document.createElement("div");this.object=object;this.property=property;this.__onChange=undefined;this.__onFinishChange=undefined};common.extend(Controller.prototype,{onChange:function(fnc){this.__onChange=fnc;return this},onFinishChange:function(fnc){this.__onFinishChange=fnc;return this},setValue:function(newValue){this.object[this.property]=newValue;if(this.__onChange){this.__onChange.call(this,newValue)}this.updateDisplay();return this},getValue:function(){return this.object[this.property]},updateDisplay:function(){return this},isModified:function(){return this.initialValue!==this.getValue()}});return Controller}(dat.utils.common);dat.dom.dom=function(common){var EVENT_MAP={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]};var EVENT_MAP_INV={};common.each(EVENT_MAP,function(v,k){common.each(v,function(e){EVENT_MAP_INV[e]=k})});var CSS_VALUE_PIXELS=/(\d+(\.\d+)?)px/;function cssValueToPixels(val){if(val==="0"||common.isUndefined(val))return 0;var match=val.match(CSS_VALUE_PIXELS);if(!common.isNull(match)){return parseFloat(match[1])}return 0}var dom={makeSelectable:function(elem,selectable){if(elem===undefined||elem.style===undefined)return;elem.onselectstart=selectable?function(){return false}:function(){};elem.style.MozUserSelect=selectable?"auto":"none";elem.style.KhtmlUserSelect=selectable?"auto":"none";elem.unselectable=selectable?"on":"off"},makeFullscreen:function(elem,horizontal,vertical){if(common.isUndefined(horizontal))horizontal=true;if(common.isUndefined(vertical))vertical=true;elem.style.position="absolute";if(horizontal){elem.style.left=0;elem.style.right=0}if(vertical){elem.style.top=0;elem.style.bottom=0}},fakeEvent:function(elem,eventType,params,aux){params=params||{};var className=EVENT_MAP_INV[eventType];if(!className){throw new Error("Event type "+eventType+" not supported.")}var evt=document.createEvent(className);switch(className){case"MouseEvents":var clientX=params.x||params.clientX||0;var clientY=params.y||params.clientY||0;evt.initMouseEvent(eventType,params.bubbles||false,params.cancelable||true,window,params.clickCount||1,0,0,clientX,clientY,false,false,false,false,0,null);break;case"KeyboardEvents":var init=evt.initKeyboardEvent||evt.initKeyEvent;common.defaults(params,{cancelable:true,ctrlKey:false,altKey:false,shiftKey:false,metaKey:false,keyCode:undefined,charCode:undefined});init(eventType,params.bubbles||false,params.cancelable,window,params.ctrlKey,params.altKey,params.shiftKey,params.metaKey,params.keyCode,params.charCode);break;default:evt.initEvent(eventType,params.bubbles||false,params.cancelable||true);break}common.defaults(evt,aux);elem.dispatchEvent(evt)},bind:function(elem,event,func,bool){bool=bool||false;if(elem.addEventListener)elem.addEventListener(event,func,bool);else if(elem.attachEvent)elem.attachEvent("on"+event,func);return dom},unbind:function(elem,event,func,bool){bool=bool||false;if(elem.removeEventListener)elem.removeEventListener(event,func,bool);else if(elem.detachEvent)elem.detachEvent("on"+event,func);return dom},addClass:function(elem,className){if(elem.className===undefined){elem.className=className}else if(elem.className!==className){var classes=elem.className.split(/ +/);if(classes.indexOf(className)==-1){classes.push(className);elem.className=classes.join(" ").replace(/^\s+/,"").replace(/\s+$/,"")}}return dom},removeClass:function(elem,className){if(className){if(elem.className===undefined){}else if(elem.className===className){elem.removeAttribute("class")}else{var classes=elem.className.split(/ +/);var index=classes.indexOf(className);if(index!=-1){classes.splice(index,1);elem.className=classes.join(" ")}}}else{elem.className=undefined}return dom},hasClass:function(elem,className){return new RegExp("(?:^|\\s+)"+className+"(?:\\s+|$)").test(elem.className)||false},getWidth:function(elem){var style=getComputedStyle(elem);return cssValueToPixels(style["border-left-width"])+cssValueToPixels(style["border-right-width"])+cssValueToPixels(style["padding-left"])+cssValueToPixels(style["padding-right"])+cssValueToPixels(style["width"])},getHeight:function(elem){var style=getComputedStyle(elem);return cssValueToPixels(style["border-top-width"])+cssValueToPixels(style["border-bottom-width"])+cssValueToPixels(style["padding-top"])+cssValueToPixels(style["padding-bottom"])+cssValueToPixels(style["height"])},getOffset:function(elem){var offset={left:0,top:0};if(elem.offsetParent){do{offset.left+=elem.offsetLeft;offset.top+=elem.offsetTop}while(elem=elem.offsetParent)}return offset},isActive:function(elem){return elem===document.activeElement&&(elem.type||elem.href)}};return dom}(dat.utils.common);dat.controllers.OptionController=function(Controller,dom,common){var OptionController=function(object,property,options){OptionController.superclass.call(this,object,property);var _this=this;this.__select=document.createElement("select");if(common.isArray(options)){var map={};common.each(options,function(element){map[element]=element});options=map}common.each(options,function(value,key){var opt=document.createElement("option");opt.innerHTML=key;opt.setAttribute("value",value);_this.__select.appendChild(opt)});this.updateDisplay();dom.bind(this.__select,"change",function(){var desiredValue=this.options[this.selectedIndex].value;_this.setValue(desiredValue)});this.domElement.appendChild(this.__select)};OptionController.superclass=Controller;common.extend(OptionController.prototype,Controller.prototype,{setValue:function(v){var toReturn=OptionController.superclass.prototype.setValue.call(this,v);if(this.__onFinishChange){this.__onFinishChange.call(this,this.getValue())}return toReturn},updateDisplay:function(){this.__select.value=this.getValue();return OptionController.superclass.prototype.updateDisplay.call(this)}});return OptionController}(dat.controllers.Controller,dat.dom.dom,dat.utils.common);dat.controllers.NumberController=function(Controller,common){var NumberController=function(object,property,params){NumberController.superclass.call(this,object,property);params=params||{};this.__min=params.min;this.__max=params.max;this.__step=params.step;if(common.isUndefined(this.__step)){if(this.initialValue==0){this.__impliedStep=1}else{this.__impliedStep=Math.pow(10,Math.floor(Math.log(this.initialValue)/Math.LN10))/10}}else{this.__impliedStep=this.__step}this.__precision=numDecimals(this.__impliedStep)};NumberController.superclass=Controller;common.extend(NumberController.prototype,Controller.prototype,{setValue:function(v){if(this.__min!==undefined&&v<this.__min){v=this.__min}else if(this.__max!==undefined&&v>this.__max){v=this.__max}if(this.__step!==undefined&&v%this.__step!=0){v=Math.round(v/this.__step)*this.__step}return NumberController.superclass.prototype.setValue.call(this,v)},min:function(v){this.__min=v;return this},max:function(v){this.__max=v;return this},step:function(v){this.__step=v;return this}});function numDecimals(x){x=x.toString();if(x.indexOf(".")>-1){return x.length-x.indexOf(".")-1}else{return 0}}return NumberController}(dat.controllers.Controller,dat.utils.common);dat.controllers.NumberControllerBox=function(NumberController,dom,common){var NumberControllerBox=function(object,property,params){this.__truncationSuspended=false;NumberControllerBox.superclass.call(this,object,property,params);var _this=this;var prev_y;this.__input=document.createElement("input");this.__input.setAttribute("type","text");dom.bind(this.__input,"change",onChange);dom.bind(this.__input,"blur",onBlur);dom.bind(this.__input,"mousedown",onMouseDown);dom.bind(this.__input,"keydown",function(e){if(e.keyCode===13){_this.__truncationSuspended=true;this.blur();_this.__truncationSuspended=false}});function onChange(){var attempted=parseFloat(_this.__input.value);if(!common.isNaN(attempted))_this.setValue(attempted)}function onBlur(){onChange();if(_this.__onFinishChange){_this.__onFinishChange.call(_this,_this.getValue())}}function onMouseDown(e){dom.bind(window,"mousemove",onMouseDrag);dom.bind(window,"mouseup",onMouseUp);prev_y=e.clientY}function onMouseDrag(e){var diff=prev_y-e.clientY;_this.setValue(_this.getValue()+diff*_this.__impliedStep);prev_y=e.clientY}function onMouseUp(){dom.unbind(window,"mousemove",onMouseDrag);dom.unbind(window,"mouseup",onMouseUp)}this.updateDisplay();this.domElement.appendChild(this.__input)};NumberControllerBox.superclass=NumberController;common.extend(NumberControllerBox.prototype,NumberController.prototype,{updateDisplay:function(){this.__input.value=this.__truncationSuspended?this.getValue():roundToDecimal(this.getValue(),this.__precision);return NumberControllerBox.superclass.prototype.updateDisplay.call(this)}});function roundToDecimal(value,decimals){var tenTo=Math.pow(10,decimals);return Math.round(value*tenTo)/tenTo}return NumberControllerBox}(dat.controllers.NumberController,dat.dom.dom,dat.utils.common);dat.controllers.NumberControllerSlider=function(NumberController,dom,css,common,styleSheet){var NumberControllerSlider=function(object,property,min,max,step){NumberControllerSlider.superclass.call(this,object,property,{min:min,max:max,step:step});var _this=this;this.__background=document.createElement("div");this.__foreground=document.createElement("div");dom.bind(this.__background,"mousedown",onMouseDown);dom.addClass(this.__background,"slider");dom.addClass(this.__foreground,"slider-fg");function onMouseDown(e){dom.bind(window,"mousemove",onMouseDrag);dom.bind(window,"mouseup",onMouseUp);onMouseDrag(e)}function onMouseDrag(e){e.preventDefault();var offset=dom.getOffset(_this.__background);var width=dom.getWidth(_this.__background);_this.setValue(map(e.clientX,offset.left,offset.left+width,_this.__min,_this.__max));return false}function onMouseUp(){dom.unbind(window,"mousemove",onMouseDrag);dom.unbind(window,"mouseup",onMouseUp);if(_this.__onFinishChange){_this.__onFinishChange.call(_this,_this.getValue())}}this.updateDisplay();this.__background.appendChild(this.__foreground);this.domElement.appendChild(this.__background)};NumberControllerSlider.superclass=NumberController;NumberControllerSlider.useDefaultStyles=function(){css.inject(styleSheet)};common.extend(NumberControllerSlider.prototype,NumberController.prototype,{updateDisplay:function(){var pct=(this.getValue()-this.__min)/(this.__max-this.__min);this.__foreground.style.width=pct*100+"%";return NumberControllerSlider.superclass.prototype.updateDisplay.call(this)}});function map(v,i1,i2,o1,o2){return o1+(o2-o1)*((v-i1)/(i2-i1))}return NumberControllerSlider}(dat.controllers.NumberController,dat.dom.dom,dat.utils.css,dat.utils.common,".slider {\n  box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);\n  height: 1em;\n  border-radius: 1em;\n  background-color: #eee;\n  padding: 0 0.5em;\n  overflow: hidden;\n}\n\n.slider-fg {\n  padding: 1px 0 2px 0;\n  background-color: #aaa;\n  height: 1em;\n  margin-left: -0.5em;\n  padding-right: 0.5em;\n  border-radius: 1em 0 0 1em;\n}\n\n.slider-fg:after {\n  display: inline-block;\n  border-radius: 1em;\n  background-color: #fff;\n  border:  1px solid #aaa;\n  content: '';\n  float: right;\n  margin-right: -1em;\n  margin-top: -1px;\n  height: 0.9em;\n  width: 0.9em;\n}");dat.controllers.FunctionController=function(Controller,dom,common){var FunctionController=function(object,property,text){FunctionController.superclass.call(this,object,property);var _this=this;this.__button=document.createElement("div");this.__button.innerHTML=text===undefined?"Fire":text;dom.bind(this.__button,"click",function(e){e.preventDefault();_this.fire();return false});dom.addClass(this.__button,"button");this.domElement.appendChild(this.__button)};FunctionController.superclass=Controller;common.extend(FunctionController.prototype,Controller.prototype,{fire:function(){if(this.__onChange){this.__onChange.call(this)}if(this.__onFinishChange){this.__onFinishChange.call(this,this.getValue())}this.getValue().call(this.object)}});return FunctionController}(dat.controllers.Controller,dat.dom.dom,dat.utils.common);dat.controllers.BooleanController=function(Controller,dom,common){var BooleanController=function(object,property){BooleanController.superclass.call(this,object,property);var _this=this;this.__prev=this.getValue();this.__checkbox=document.createElement("input");this.__checkbox.setAttribute("type","checkbox");dom.bind(this.__checkbox,"change",onChange,false);this.domElement.appendChild(this.__checkbox);this.updateDisplay();function onChange(){_this.setValue(!_this.__prev)}};BooleanController.superclass=Controller;common.extend(BooleanController.prototype,Controller.prototype,{setValue:function(v){var toReturn=BooleanController.superclass.prototype.setValue.call(this,v);if(this.__onFinishChange){this.__onFinishChange.call(this,this.getValue())}this.__prev=this.getValue();return toReturn},updateDisplay:function(){if(this.getValue()===true){this.__checkbox.setAttribute("checked","checked");this.__checkbox.checked=true}else{this.__checkbox.checked=false}return BooleanController.superclass.prototype.updateDisplay.call(this)}});return BooleanController}(dat.controllers.Controller,dat.dom.dom,dat.utils.common);dat.color.toString=function(common){return function(color){if(color.a==1||common.isUndefined(color.a)){var s=color.hex.toString(16);while(s.length<6){s="0"+s}return"#"+s}else{return"rgba("+Math.round(color.r)+","+Math.round(color.g)+","+Math.round(color.b)+","+color.a+")"}}}(dat.utils.common);dat.color.interpret=function(toString,common){var result,toReturn;var interpret=function(){toReturn=false;var original=arguments.length>1?common.toArray(arguments):arguments[0];common.each(INTERPRETATIONS,function(family){if(family.litmus(original)){common.each(family.conversions,function(conversion,conversionName){result=conversion.read(original);if(toReturn===false&&result!==false){toReturn=result;result.conversionName=conversionName;result.conversion=conversion;return common.BREAK}});return common.BREAK}});return toReturn};var INTERPRETATIONS=[{litmus:common.isString,conversions:{THREE_CHAR_HEX:{read:function(original){var test=original.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);if(test===null)return false;return{space:"HEX",hex:parseInt("0x"+test[1].toString()+test[1].toString()+test[2].toString()+test[2].toString()+test[3].toString()+test[3].toString())}},write:toString},SIX_CHAR_HEX:{read:function(original){var test=original.match(/^#([A-F0-9]{6})$/i);if(test===null)return false;return{space:"HEX",hex:parseInt("0x"+test[1].toString())}},write:toString},CSS_RGB:{read:function(original){var test=original.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);if(test===null)return false;return{space:"RGB",r:parseFloat(test[1]),g:parseFloat(test[2]),b:parseFloat(test[3])}
},write:toString},CSS_RGBA:{read:function(original){var test=original.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\,\s*(.+)\s*\)/);if(test===null)return false;return{space:"RGB",r:parseFloat(test[1]),g:parseFloat(test[2]),b:parseFloat(test[3]),a:parseFloat(test[4])}},write:toString}}},{litmus:common.isNumber,conversions:{HEX:{read:function(original){return{space:"HEX",hex:original,conversionName:"HEX"}},write:function(color){return color.hex}}}},{litmus:common.isArray,conversions:{RGB_ARRAY:{read:function(original){if(original.length!=3)return false;return{space:"RGB",r:original[0],g:original[1],b:original[2]}},write:function(color){return[color.r,color.g,color.b]}},RGBA_ARRAY:{read:function(original){if(original.length!=4)return false;return{space:"RGB",r:original[0],g:original[1],b:original[2],a:original[3]}},write:function(color){return[color.r,color.g,color.b,color.a]}}}},{litmus:common.isObject,conversions:{RGBA_OBJ:{read:function(original){if(common.isNumber(original.r)&&common.isNumber(original.g)&&common.isNumber(original.b)&&common.isNumber(original.a)){return{space:"RGB",r:original.r,g:original.g,b:original.b,a:original.a}}return false},write:function(color){return{r:color.r,g:color.g,b:color.b,a:color.a}}},RGB_OBJ:{read:function(original){if(common.isNumber(original.r)&&common.isNumber(original.g)&&common.isNumber(original.b)){return{space:"RGB",r:original.r,g:original.g,b:original.b}}return false},write:function(color){return{r:color.r,g:color.g,b:color.b}}},HSVA_OBJ:{read:function(original){if(common.isNumber(original.h)&&common.isNumber(original.s)&&common.isNumber(original.v)&&common.isNumber(original.a)){return{space:"HSV",h:original.h,s:original.s,v:original.v,a:original.a}}return false},write:function(color){return{h:color.h,s:color.s,v:color.v,a:color.a}}},HSV_OBJ:{read:function(original){if(common.isNumber(original.h)&&common.isNumber(original.s)&&common.isNumber(original.v)){return{space:"HSV",h:original.h,s:original.s,v:original.v}}return false},write:function(color){return{h:color.h,s:color.s,v:color.v}}}}}];return interpret}(dat.color.toString,dat.utils.common);dat.GUI=dat.gui.GUI=function(css,saveDialogueContents,styleSheet,controllerFactory,Controller,BooleanController,FunctionController,NumberControllerBox,NumberControllerSlider,OptionController,ColorController,requestAnimationFrame,CenteredDiv,dom,common){css.inject(styleSheet);var CSS_NAMESPACE="dg";var HIDE_KEY_CODE=72;var CLOSE_BUTTON_HEIGHT=20;var DEFAULT_DEFAULT_PRESET_NAME="Default";var SUPPORTS_LOCAL_STORAGE=function(){try{return"localStorage"in window&&window["localStorage"]!==null}catch(e){return false}}();var SAVE_DIALOGUE;var auto_place_virgin=true;var auto_place_container;var hide=false;var hideable_guis=[];var GUI=function(params){var _this=this;this.domElement=document.createElement("div");this.__ul=document.createElement("ul");this.domElement.appendChild(this.__ul);dom.addClass(this.domElement,CSS_NAMESPACE);this.__folders={};this.__controllers=[];this.__rememberedObjects=[];this.__rememberedObjectIndecesToControllers=[];this.__listening=[];params=params||{};params=common.defaults(params,{autoPlace:true,width:GUI.DEFAULT_WIDTH});params=common.defaults(params,{resizable:params.autoPlace,hideable:params.autoPlace});if(!common.isUndefined(params.load)){if(params.preset)params.load.preset=params.preset}else{params.load={preset:DEFAULT_DEFAULT_PRESET_NAME}}if(common.isUndefined(params.parent)&&params.hideable){hideable_guis.push(this)}params.resizable=common.isUndefined(params.parent)&&params.resizable;if(params.autoPlace&&common.isUndefined(params.scrollable)){params.scrollable=true}var use_local_storage=SUPPORTS_LOCAL_STORAGE&&localStorage.getItem(getLocalStorageHash(this,"isLocal"))==="true";Object.defineProperties(this,{parent:{get:function(){return params.parent}},scrollable:{get:function(){return params.scrollable}},autoPlace:{get:function(){return params.autoPlace}},preset:{get:function(){if(_this.parent){return _this.getRoot().preset}else{return params.load.preset}},set:function(v){if(_this.parent){_this.getRoot().preset=v}else{params.load.preset=v}setPresetSelectIndex(this);_this.revert()}},width:{get:function(){return params.width},set:function(v){params.width=v;setWidth(_this,v)}},name:{get:function(){return params.name},set:function(v){params.name=v;if(title_row_name){title_row_name.innerHTML=params.name}}},closed:{get:function(){return params.closed},set:function(v){params.closed=v;if(params.closed){dom.addClass(_this.__ul,GUI.CLASS_CLOSED)}else{dom.removeClass(_this.__ul,GUI.CLASS_CLOSED)}this.onResize();if(_this.__closeButton){_this.__closeButton.innerHTML=v?GUI.TEXT_OPEN:GUI.TEXT_CLOSED}}},load:{get:function(){return params.load}},useLocalStorage:{get:function(){return use_local_storage},set:function(bool){if(SUPPORTS_LOCAL_STORAGE){use_local_storage=bool;if(bool){dom.bind(window,"unload",saveToLocalStorage)}else{dom.unbind(window,"unload",saveToLocalStorage)}localStorage.setItem(getLocalStorageHash(_this,"isLocal"),bool)}}}});if(common.isUndefined(params.parent)){params.closed=false;dom.addClass(this.domElement,GUI.CLASS_MAIN);dom.makeSelectable(this.domElement,false);if(SUPPORTS_LOCAL_STORAGE){if(use_local_storage){_this.useLocalStorage=true;var saved_gui=localStorage.getItem(getLocalStorageHash(this,"gui"));if(saved_gui){params.load=JSON.parse(saved_gui)}}}this.__closeButton=document.createElement("div");this.__closeButton.innerHTML=GUI.TEXT_CLOSED;dom.addClass(this.__closeButton,GUI.CLASS_CLOSE_BUTTON);this.domElement.appendChild(this.__closeButton);dom.bind(this.__closeButton,"click",function(){_this.closed=!_this.closed})}else{if(params.closed===undefined){params.closed=true}var title_row_name=document.createTextNode(params.name);dom.addClass(title_row_name,"controller-name");var title_row=addRow(_this,title_row_name);var on_click_title=function(e){e.preventDefault();_this.closed=!_this.closed;return false};dom.addClass(this.__ul,GUI.CLASS_CLOSED);dom.addClass(title_row,"title");dom.bind(title_row,"click",on_click_title);if(!params.closed){this.closed=false}}if(params.autoPlace){if(common.isUndefined(params.parent)){if(auto_place_virgin){auto_place_container=document.createElement("div");dom.addClass(auto_place_container,CSS_NAMESPACE);dom.addClass(auto_place_container,GUI.CLASS_AUTO_PLACE_CONTAINER);document.body.appendChild(auto_place_container);auto_place_virgin=false}auto_place_container.appendChild(this.domElement);dom.addClass(this.domElement,GUI.CLASS_AUTO_PLACE)}if(!this.parent)setWidth(_this,params.width)}dom.bind(window,"resize",function(){_this.onResize()});dom.bind(this.__ul,"webkitTransitionEnd",function(){_this.onResize()});dom.bind(this.__ul,"transitionend",function(){_this.onResize()});dom.bind(this.__ul,"oTransitionEnd",function(){_this.onResize()});this.onResize();if(params.resizable){addResizeHandle(this)}function saveToLocalStorage(){localStorage.setItem(getLocalStorageHash(_this,"gui"),JSON.stringify(_this.getSaveObject()))}var root=_this.getRoot();function resetWidth(){var root=_this.getRoot();root.width+=1;common.defer(function(){root.width-=1})}if(!params.parent){resetWidth()}};GUI.toggleHide=function(){hide=!hide;common.each(hideable_guis,function(gui){gui.domElement.style.zIndex=hide?-999:999;gui.domElement.style.opacity=hide?0:1})};GUI.CLASS_AUTO_PLACE="a";GUI.CLASS_AUTO_PLACE_CONTAINER="ac";GUI.CLASS_MAIN="main";GUI.CLASS_CONTROLLER_ROW="cr";GUI.CLASS_TOO_TALL="taller-than-window";GUI.CLASS_CLOSED="closed";GUI.CLASS_CLOSE_BUTTON="close-button";GUI.CLASS_DRAG="drag";GUI.DEFAULT_WIDTH=245;GUI.TEXT_CLOSED="Close Controls";GUI.TEXT_OPEN="Open Controls";dom.bind(window,"keydown",function(e){if(document.activeElement.type!=="text"&&(e.which===HIDE_KEY_CODE||e.keyCode==HIDE_KEY_CODE)){GUI.toggleHide()}},false);common.extend(GUI.prototype,{add:function(object,property){return add(this,object,property,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(object,property){return add(this,object,property,{color:true})},remove:function(controller){this.__ul.removeChild(controller.__li);this.__controllers.slice(this.__controllers.indexOf(controller),1);var _this=this;common.defer(function(){_this.onResize()})},destroy:function(){if(this.autoPlace){auto_place_container.removeChild(this.domElement)}},addFolder:function(name){if(this.__folders[name]!==undefined){throw new Error("You already have a folder in this GUI by the"+' name "'+name+'"')}var new_gui_params={name:name,parent:this};new_gui_params.autoPlace=this.autoPlace;if(this.load&&this.load.folders&&this.load.folders[name]){new_gui_params.closed=this.load.folders[name].closed;new_gui_params.load=this.load.folders[name]}var gui=new GUI(new_gui_params);this.__folders[name]=gui;var li=addRow(this,gui.domElement);dom.addClass(li,"folder");return gui},open:function(){this.closed=false},close:function(){this.closed=true},onResize:function(){var root=this.getRoot();if(root.scrollable){var top=dom.getOffset(root.__ul).top;var h=0;common.each(root.__ul.childNodes,function(node){if(!(root.autoPlace&&node===root.__save_row))h+=dom.getHeight(node)});if(window.innerHeight-top-CLOSE_BUTTON_HEIGHT<h){dom.addClass(root.domElement,GUI.CLASS_TOO_TALL);root.__ul.style.height=window.innerHeight-top-CLOSE_BUTTON_HEIGHT+"px"}else{dom.removeClass(root.domElement,GUI.CLASS_TOO_TALL);root.__ul.style.height="auto"}}if(root.__resize_handle){common.defer(function(){root.__resize_handle.style.height=root.__ul.offsetHeight+"px"})}if(root.__closeButton){root.__closeButton.style.width=root.width+"px"}},remember:function(){if(common.isUndefined(SAVE_DIALOGUE)){SAVE_DIALOGUE=new CenteredDiv;SAVE_DIALOGUE.domElement.innerHTML=saveDialogueContents}if(this.parent){throw new Error("You can only call remember on a top level GUI.")}var _this=this;common.each(Array.prototype.slice.call(arguments),function(object){if(_this.__rememberedObjects.length==0){addSaveMenu(_this)}if(_this.__rememberedObjects.indexOf(object)==-1){_this.__rememberedObjects.push(object)}});if(this.autoPlace){setWidth(this,this.width)}},getRoot:function(){var gui=this;while(gui.parent){gui=gui.parent}return gui},getSaveObject:function(){var toReturn=this.load;toReturn.closed=this.closed;if(this.__rememberedObjects.length>0){toReturn.preset=this.preset;if(!toReturn.remembered){toReturn.remembered={}}toReturn.remembered[this.preset]=getCurrentPreset(this)}toReturn.folders={};common.each(this.__folders,function(element,key){toReturn.folders[key]=element.getSaveObject()});return toReturn},save:function(){if(!this.load.remembered){this.load.remembered={}}this.load.remembered[this.preset]=getCurrentPreset(this);markPresetModified(this,false)},saveAs:function(presetName){if(!this.load.remembered){this.load.remembered={};this.load.remembered[DEFAULT_DEFAULT_PRESET_NAME]=getCurrentPreset(this,true)}this.load.remembered[presetName]=getCurrentPreset(this);this.preset=presetName;addPresetOption(this,presetName,true)},revert:function(gui){common.each(this.__controllers,function(controller){if(!this.getRoot().load.remembered){controller.setValue(controller.initialValue)}else{recallSavedValue(gui||this.getRoot(),controller)}},this);common.each(this.__folders,function(folder){folder.revert(folder)});if(!gui){markPresetModified(this.getRoot(),false)}},listen:function(controller){var init=this.__listening.length==0;this.__listening.push(controller);if(init)updateDisplays(this.__listening)}});function add(gui,object,property,params){if(object[property]===undefined){throw new Error("Object "+object+' has no property "'+property+'"')}var controller;if(params.color){controller=new ColorController(object,property)}else{var factoryArgs=[object,property].concat(params.factoryArgs);controller=controllerFactory.apply(gui,factoryArgs)}if(params.before instanceof Controller){params.before=params.before.__li}recallSavedValue(gui,controller);dom.addClass(controller.domElement,"c");var name=document.createElement("span");dom.addClass(name,"property-name");name.innerHTML=controller.property;var container=document.createElement("div");container.appendChild(name);container.appendChild(controller.domElement);var li=addRow(gui,container,params.before);dom.addClass(li,GUI.CLASS_CONTROLLER_ROW);dom.addClass(li,typeof controller.getValue());augmentController(gui,li,controller);gui.__controllers.push(controller);return controller}function addRow(gui,dom,liBefore){var li=document.createElement("li");if(dom)li.appendChild(dom);if(liBefore){gui.__ul.insertBefore(li,params.before)}else{gui.__ul.appendChild(li)}gui.onResize();return li}function augmentController(gui,li,controller){controller.__li=li;controller.__gui=gui;common.extend(controller,{options:function(options){if(arguments.length>1){controller.remove();return add(gui,controller.object,controller.property,{before:controller.__li.nextElementSibling,factoryArgs:[common.toArray(arguments)]})}if(common.isArray(options)||common.isObject(options)){controller.remove();return add(gui,controller.object,controller.property,{before:controller.__li.nextElementSibling,factoryArgs:[options]})}},name:function(v){controller.__li.firstElementChild.firstElementChild.innerHTML=v;return controller},listen:function(){controller.__gui.listen(controller);return controller},remove:function(){controller.__gui.remove(controller);return controller}});if(controller instanceof NumberControllerSlider){var box=new NumberControllerBox(controller.object,controller.property,{min:controller.__min,max:controller.__max,step:controller.__step});common.each(["updateDisplay","onChange","onFinishChange"],function(method){var pc=controller[method];var pb=box[method];controller[method]=box[method]=function(){var args=Array.prototype.slice.call(arguments);pc.apply(controller,args);return pb.apply(box,args)}});dom.addClass(li,"has-slider");controller.domElement.insertBefore(box.domElement,controller.domElement.firstElementChild)}else if(controller instanceof NumberControllerBox){var r=function(returned){if(common.isNumber(controller.__min)&&common.isNumber(controller.__max)){controller.remove();return add(gui,controller.object,controller.property,{before:controller.__li.nextElementSibling,factoryArgs:[controller.__min,controller.__max,controller.__step]})}return returned};controller.min=common.compose(r,controller.min);controller.max=common.compose(r,controller.max)}else if(controller instanceof BooleanController){dom.bind(li,"click",function(){dom.fakeEvent(controller.__checkbox,"click")});dom.bind(controller.__checkbox,"click",function(e){e.stopPropagation()})}else if(controller instanceof FunctionController){dom.bind(li,"click",function(){dom.fakeEvent(controller.__button,"click")});dom.bind(li,"mouseover",function(){dom.addClass(controller.__button,"hover")});dom.bind(li,"mouseout",function(){dom.removeClass(controller.__button,"hover")})}else if(controller instanceof ColorController){dom.addClass(li,"color");controller.updateDisplay=common.compose(function(r){li.style.borderLeftColor=controller.__color.toString();return r},controller.updateDisplay);controller.updateDisplay()}controller.setValue=common.compose(function(r){if(gui.getRoot().__preset_select&&controller.isModified()){markPresetModified(gui.getRoot(),true)}return r},controller.setValue)}function recallSavedValue(gui,controller){var root=gui.getRoot();var matched_index=root.__rememberedObjects.indexOf(controller.object);if(matched_index!=-1){var controller_map=root.__rememberedObjectIndecesToControllers[matched_index];if(controller_map===undefined){controller_map={};root.__rememberedObjectIndecesToControllers[matched_index]=controller_map}controller_map[controller.property]=controller;if(root.load&&root.load.remembered){var preset_map=root.load.remembered;var preset;if(preset_map[gui.preset]){preset=preset_map[gui.preset]}else if(preset_map[DEFAULT_DEFAULT_PRESET_NAME]){preset=preset_map[DEFAULT_DEFAULT_PRESET_NAME]}else{return}if(preset[matched_index]&&preset[matched_index][controller.property]!==undefined){var value=preset[matched_index][controller.property];controller.initialValue=value;controller.setValue(value)}}}}function getLocalStorageHash(gui,key){return document.location.href+"."+key}function addSaveMenu(gui){var div=gui.__save_row=document.createElement("li");dom.addClass(gui.domElement,"has-save");gui.__ul.insertBefore(div,gui.__ul.firstChild);dom.addClass(div,"save-row");var gears=document.createElement("span");gears.innerHTML="&nbsp;";dom.addClass(gears,"button gears");var button=document.createElement("span");button.innerHTML="Save";dom.addClass(button,"button");dom.addClass(button,"save");var button2=document.createElement("span");button2.innerHTML="New";dom.addClass(button2,"button");dom.addClass(button2,"save-as");var button3=document.createElement("span");button3.innerHTML="Revert";dom.addClass(button3,"button");dom.addClass(button3,"revert");var select=gui.__preset_select=document.createElement("select");if(gui.load&&gui.load.remembered){common.each(gui.load.remembered,function(value,key){addPresetOption(gui,key,key==gui.preset)})}else{addPresetOption(gui,DEFAULT_DEFAULT_PRESET_NAME,false)}dom.bind(select,"change",function(){for(var index=0;index<gui.__preset_select.length;index++){gui.__preset_select[index].innerHTML=gui.__preset_select[index].value}gui.preset=this.value});div.appendChild(select);div.appendChild(gears);div.appendChild(button);div.appendChild(button2);div.appendChild(button3);if(SUPPORTS_LOCAL_STORAGE){var saveLocally=document.getElementById("dg-save-locally");var explain=document.getElementById("dg-local-explain");saveLocally.style.display="block";var localStorageCheckBox=document.getElementById("dg-local-storage");if(localStorage.getItem(getLocalStorageHash(gui,"isLocal"))==="true"){localStorageCheckBox.setAttribute("checked","checked")}function showHideExplain(){explain.style.display=gui.useLocalStorage?"block":"none"}showHideExplain();dom.bind(localStorageCheckBox,"change",function(){gui.useLocalStorage=!gui.useLocalStorage;showHideExplain()})}var newConstructorTextArea=document.getElementById("dg-new-constructor");dom.bind(newConstructorTextArea,"keydown",function(e){if(e.metaKey&&(e.which===67||e.keyCode==67)){SAVE_DIALOGUE.hide()}});dom.bind(gears,"click",function(){newConstructorTextArea.innerHTML=JSON.stringify(gui.getSaveObject(),undefined,2);SAVE_DIALOGUE.show();newConstructorTextArea.focus();newConstructorTextArea.select()});dom.bind(button,"click",function(){gui.save()});dom.bind(button2,"click",function(){var presetName=prompt("Enter a new preset name.");if(presetName)gui.saveAs(presetName)});dom.bind(button3,"click",function(){gui.revert()})}function addResizeHandle(gui){gui.__resize_handle=document.createElement("div");common.extend(gui.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});var pmouseX;dom.bind(gui.__resize_handle,"mousedown",dragStart);dom.bind(gui.__closeButton,"mousedown",dragStart);gui.domElement.insertBefore(gui.__resize_handle,gui.domElement.firstElementChild);function dragStart(e){e.preventDefault();pmouseX=e.clientX;dom.addClass(gui.__closeButton,GUI.CLASS_DRAG);dom.bind(window,"mousemove",drag);dom.bind(window,"mouseup",dragStop);return false}function drag(e){e.preventDefault();gui.width+=pmouseX-e.clientX;gui.onResize();pmouseX=e.clientX;return false}function dragStop(){dom.removeClass(gui.__closeButton,GUI.CLASS_DRAG);dom.unbind(window,"mousemove",drag);dom.unbind(window,"mouseup",dragStop)}}function setWidth(gui,w){gui.domElement.style.width=w+"px";if(gui.__save_row&&gui.autoPlace){gui.__save_row.style.width=w+"px"}if(gui.__closeButton){gui.__closeButton.style.width=w+"px"}}function getCurrentPreset(gui,useInitialValues){var toReturn={};common.each(gui.__rememberedObjects,function(val,index){var saved_values={};var controller_map=gui.__rememberedObjectIndecesToControllers[index];common.each(controller_map,function(controller,property){saved_values[property]=useInitialValues?controller.initialValue:controller.getValue()});toReturn[index]=saved_values});return toReturn}function addPresetOption(gui,name,setSelected){var opt=document.createElement("option");opt.innerHTML=name;opt.value=name;gui.__preset_select.appendChild(opt);if(setSelected){gui.__preset_select.selectedIndex=gui.__preset_select.length-1}}function setPresetSelectIndex(gui){for(var index=0;index<gui.__preset_select.length;index++){if(gui.__preset_select[index].value==gui.preset){gui.__preset_select.selectedIndex=index}}}function markPresetModified(gui,modified){var opt=gui.__preset_select[gui.__preset_select.selectedIndex];if(modified){opt.innerHTML=opt.value+"*"}else{opt.innerHTML=opt.value}}function updateDisplays(controllerArray){if(controllerArray.length!=0){requestAnimationFrame(function(){updateDisplays(controllerArray)})}common.each(controllerArray,function(c){c.updateDisplay()})}return GUI}(dat.utils.css,'<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n      \n    </div>\n    \n  </div>\n\n</div>',".dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity 0.1s linear;-o-transition:opacity 0.1s linear;-moz-transition:opacity 0.1s linear;transition:opacity 0.1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity 0.1s linear;-o-transition:opacity 0.1s linear;-moz-transition:opacity 0.1s linear;transition:opacity 0.1s linear;border:0;position:absolute;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-x:hidden}.dg.a.has-save ul{margin-top:27px}.dg.a.has-save ul.closed{margin-top:0}.dg.a .save-row{position:fixed;top:0;z-index:1002}.dg li{-webkit-transition:height 0.1s ease-out;-o-transition:height 0.1s ease-out;-moz-transition:height 0.1s ease-out;transition:height 0.1s ease-out}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;overflow:hidden;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li > *{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .c{float:left;width:60%}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:9px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2fa1d6}.dg .cr.number input[type=text]{color:#2fa1d6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2fa1d6}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}\n",dat.controllers.factory=function(OptionController,NumberControllerBox,NumberControllerSlider,StringController,FunctionController,BooleanController,common){return function(object,property){var initialValue=object[property];if(common.isArray(arguments[2])||common.isObject(arguments[2])){return new OptionController(object,property,arguments[2])}if(common.isNumber(initialValue)){if(common.isNumber(arguments[2])&&common.isNumber(arguments[3])){return new NumberControllerSlider(object,property,arguments[2],arguments[3])}else{return new NumberControllerBox(object,property,{min:arguments[2],max:arguments[3]})}}if(common.isString(initialValue)){return new StringController(object,property)}if(common.isFunction(initialValue)){return new FunctionController(object,property,"")}if(common.isBoolean(initialValue)){return new BooleanController(object,property)}}}(dat.controllers.OptionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.StringController=function(Controller,dom,common){var StringController=function(object,property){StringController.superclass.call(this,object,property);var _this=this;this.__input=document.createElement("input");this.__input.setAttribute("type","text");dom.bind(this.__input,"keyup",onChange);dom.bind(this.__input,"change",onChange);dom.bind(this.__input,"blur",onBlur);dom.bind(this.__input,"keydown",function(e){if(e.keyCode===13){this.blur()}});function onChange(){_this.setValue(_this.__input.value)}function onBlur(){if(_this.__onFinishChange){_this.__onFinishChange.call(_this,_this.getValue())}}this.updateDisplay();this.domElement.appendChild(this.__input)};StringController.superclass=Controller;common.extend(StringController.prototype,Controller.prototype,{updateDisplay:function(){if(!dom.isActive(this.__input)){this.__input.value=this.getValue()}return StringController.superclass.prototype.updateDisplay.call(this)}});return StringController}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.FunctionController,dat.controllers.BooleanController,dat.utils.common),dat.controllers.Controller,dat.controllers.BooleanController,dat.controllers.FunctionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.OptionController,dat.controllers.ColorController=function(Controller,dom,Color,interpret,common){var ColorController=function(object,property){ColorController.superclass.call(this,object,property);this.__color=new Color(this.getValue());this.__temp=new Color(0);var _this=this;this.domElement=document.createElement("div");dom.makeSelectable(this.domElement,false);this.__selector=document.createElement("div");this.__selector.className="selector";this.__saturation_field=document.createElement("div");this.__saturation_field.className="saturation-field";this.__field_knob=document.createElement("div");this.__field_knob.className="field-knob";this.__field_knob_border="2px solid ";this.__hue_knob=document.createElement("div");this.__hue_knob.className="hue-knob";this.__hue_field=document.createElement("div");this.__hue_field.className="hue-field";this.__input=document.createElement("input");this.__input.type="text";this.__input_textShadow="0 1px 1px ";dom.bind(this.__input,"keydown",function(e){if(e.keyCode===13){onBlur.call(this)}});dom.bind(this.__input,"blur",onBlur);dom.bind(this.__selector,"mousedown",function(e){dom.addClass(this,"drag").bind(window,"mouseup",function(e){dom.removeClass(_this.__selector,"drag")})});var value_field=document.createElement("div");common.extend(this.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"});common.extend(this.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:this.__field_knob_border+(this.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1});common.extend(this.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1});common.extend(this.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"});common.extend(value_field.style,{width:"100%",height:"100%",background:"none"});linearGradient(value_field,"top","rgba(0,0,0,0)","#000");common.extend(this.__hue_field.style,{width:"15px",height:"100px",display:"inline-block",border:"1px solid #555",cursor:"ns-resize"});hueGradient(this.__hue_field);common.extend(this.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:this.__input_textShadow+"rgba(0,0,0,0.7)"});dom.bind(this.__saturation_field,"mousedown",fieldDown);dom.bind(this.__field_knob,"mousedown",fieldDown);dom.bind(this.__hue_field,"mousedown",function(e){setH(e);dom.bind(window,"mousemove",setH);dom.bind(window,"mouseup",unbindH)});function fieldDown(e){setSV(e);dom.bind(window,"mousemove",setSV);dom.bind(window,"mouseup",unbindSV)}function unbindSV(){dom.unbind(window,"mousemove",setSV);dom.unbind(window,"mouseup",unbindSV)
}function onBlur(){var i=interpret(this.value);if(i!==false){_this.__color.__state=i;_this.setValue(_this.__color.toOriginal())}else{this.value=_this.__color.toString()}}function unbindH(){dom.unbind(window,"mousemove",setH);dom.unbind(window,"mouseup",unbindH)}this.__saturation_field.appendChild(value_field);this.__selector.appendChild(this.__field_knob);this.__selector.appendChild(this.__saturation_field);this.__selector.appendChild(this.__hue_field);this.__hue_field.appendChild(this.__hue_knob);this.domElement.appendChild(this.__input);this.domElement.appendChild(this.__selector);this.updateDisplay();function setSV(e){e.preventDefault();var w=dom.getWidth(_this.__saturation_field);var o=dom.getOffset(_this.__saturation_field);var s=(e.clientX-o.left+document.body.scrollLeft)/w;var v=1-(e.clientY-o.top+document.body.scrollTop)/w;if(v>1)v=1;else if(v<0)v=0;if(s>1)s=1;else if(s<0)s=0;_this.__color.v=v;_this.__color.s=s;_this.setValue(_this.__color.toOriginal());return false}function setH(e){e.preventDefault();var s=dom.getHeight(_this.__hue_field);var o=dom.getOffset(_this.__hue_field);var h=1-(e.clientY-o.top+document.body.scrollTop)/s;if(h>1)h=1;else if(h<0)h=0;_this.__color.h=h*360;_this.setValue(_this.__color.toOriginal());return false}};ColorController.superclass=Controller;common.extend(ColorController.prototype,Controller.prototype,{updateDisplay:function(){var i=interpret(this.getValue());if(i!==false){var mismatch=false;common.each(Color.COMPONENTS,function(component){if(!common.isUndefined(i[component])&&!common.isUndefined(this.__color.__state[component])&&i[component]!==this.__color.__state[component]){mismatch=true;return{}}},this);if(mismatch){common.extend(this.__color.__state,i)}}common.extend(this.__temp.__state,this.__color.__state);this.__temp.a=1;var flip=this.__color.v<.5||this.__color.s>.5?255:0;var _flip=255-flip;common.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toString(),border:this.__field_knob_border+"rgb("+flip+","+flip+","+flip+")"});this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px";this.__temp.s=1;this.__temp.v=1;linearGradient(this.__saturation_field,"left","#fff",this.__temp.toString());common.extend(this.__input.style,{backgroundColor:this.__input.value=this.__color.toString(),color:"rgb("+flip+","+flip+","+flip+")",textShadow:this.__input_textShadow+"rgba("+_flip+","+_flip+","+_flip+",.7)"})}});var vendors=["-moz-","-o-","-webkit-","-ms-",""];function linearGradient(elem,x,a,b){elem.style.background="";common.each(vendors,function(vendor){elem.style.cssText+="background: "+vendor+"linear-gradient("+x+", "+a+" 0%, "+b+" 100%); "})}function hueGradient(elem){elem.style.background="";elem.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);";elem.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);";elem.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);";elem.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);";elem.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}return ColorController}(dat.controllers.Controller,dat.dom.dom,dat.color.Color=function(interpret,math,toString,common){var Color=function(){this.__state=interpret.apply(this,arguments);if(this.__state===false){throw"Failed to interpret color arguments"}this.__state.a=this.__state.a||1};Color.COMPONENTS=["r","g","b","h","s","v","hex","a"];common.extend(Color.prototype,{toString:function(){return toString(this)},toOriginal:function(){return this.__state.conversion.write(this)}});defineRGBComponent(Color.prototype,"r",2);defineRGBComponent(Color.prototype,"g",1);defineRGBComponent(Color.prototype,"b",0);defineHSVComponent(Color.prototype,"h");defineHSVComponent(Color.prototype,"s");defineHSVComponent(Color.prototype,"v");Object.defineProperty(Color.prototype,"a",{get:function(){return this.__state.a},set:function(v){this.__state.a=v}});Object.defineProperty(Color.prototype,"hex",{get:function(){if(!this.__state.space!=="HEX"){this.__state.hex=math.rgb_to_hex(this.r,this.g,this.b)}return this.__state.hex},set:function(v){this.__state.space="HEX";this.__state.hex=v}});function defineRGBComponent(target,component,componentHexIndex){Object.defineProperty(target,component,{get:function(){if(this.__state.space==="RGB"){return this.__state[component]}recalculateRGB(this,component,componentHexIndex);return this.__state[component]},set:function(v){if(this.__state.space!=="RGB"){recalculateRGB(this,component,componentHexIndex);this.__state.space="RGB"}this.__state[component]=v}})}function defineHSVComponent(target,component){Object.defineProperty(target,component,{get:function(){if(this.__state.space==="HSV")return this.__state[component];recalculateHSV(this);return this.__state[component]},set:function(v){if(this.__state.space!=="HSV"){recalculateHSV(this);this.__state.space="HSV"}this.__state[component]=v}})}function recalculateRGB(color,component,componentHexIndex){if(color.__state.space==="HEX"){color.__state[component]=math.component_from_hex(color.__state.hex,componentHexIndex)}else if(color.__state.space==="HSV"){common.extend(color.__state,math.hsv_to_rgb(color.__state.h,color.__state.s,color.__state.v))}else{throw"Corrupted color state"}}function recalculateHSV(color){var result=math.rgb_to_hsv(color.r,color.g,color.b);common.extend(color.__state,{s:result.s,v:result.v});if(!common.isNaN(result.h)){color.__state.h=result.h}else if(common.isUndefined(color.__state.h)){color.__state.h=0}}return Color}(dat.color.interpret,dat.color.math=function(){var tmpComponent;return{hsv_to_rgb:function(h,s,v){var hi=Math.floor(h/60)%6;var f=h/60-Math.floor(h/60);var p=v*(1-s);var q=v*(1-f*s);var t=v*(1-(1-f)*s);var c=[[v,t,p],[q,v,p],[p,v,t],[p,q,v],[t,p,v],[v,p,q]][hi];return{r:c[0]*255,g:c[1]*255,b:c[2]*255}},rgb_to_hsv:function(r,g,b){var min=Math.min(r,g,b),max=Math.max(r,g,b),delta=max-min,h,s;if(max!=0){s=delta/max}else{return{h:NaN,s:0,v:0}}if(r==max){h=(g-b)/delta}else if(g==max){h=2+(b-r)/delta}else{h=4+(r-g)/delta}h/=6;if(h<0){h+=1}return{h:h*360,s:s,v:max/255}},rgb_to_hex:function(r,g,b){var hex=this.hex_with_component(0,2,r);hex=this.hex_with_component(hex,1,g);hex=this.hex_with_component(hex,0,b);return hex},component_from_hex:function(hex,componentIndex){return hex>>componentIndex*8&255},hex_with_component:function(hex,componentIndex,value){return value<<(tmpComponent=componentIndex*8)|hex&~(255<<tmpComponent)}}}(),dat.color.toString,dat.utils.common),dat.color.interpret,dat.utils.common),dat.utils.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){window.setTimeout(callback,1e3/60)}}(),dat.dom.CenteredDiv=function(dom,common){var CenteredDiv=function(){this.backgroundElement=document.createElement("div");common.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear"});dom.makeFullscreen(this.backgroundElement);this.backgroundElement.style.position="fixed";this.domElement=document.createElement("div");common.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear"});document.body.appendChild(this.backgroundElement);document.body.appendChild(this.domElement);var _this=this;dom.bind(this.backgroundElement,"click",function(){_this.hide()})};CenteredDiv.prototype.show=function(){var _this=this;this.backgroundElement.style.display="block";this.domElement.style.display="block";this.domElement.style.opacity=0;this.domElement.style.webkitTransform="scale(1.1)";this.layout();common.defer(function(){_this.backgroundElement.style.opacity=1;_this.domElement.style.opacity=1;_this.domElement.style.webkitTransform="scale(1)"})};CenteredDiv.prototype.hide=function(){var _this=this;var hide=function(){_this.domElement.style.display="none";_this.backgroundElement.style.display="none";dom.unbind(_this.domElement,"webkitTransitionEnd",hide);dom.unbind(_this.domElement,"transitionend",hide);dom.unbind(_this.domElement,"oTransitionEnd",hide)};dom.bind(this.domElement,"webkitTransitionEnd",hide);dom.bind(this.domElement,"transitionend",hide);dom.bind(this.domElement,"oTransitionEnd",hide);this.backgroundElement.style.opacity=0;this.domElement.style.opacity=0;this.domElement.style.webkitTransform="scale(1.1)"};CenteredDiv.prototype.layout=function(){this.domElement.style.left=window.innerWidth/2-dom.getWidth(this.domElement)/2+"px";this.domElement.style.top=window.innerHeight/2-dom.getHeight(this.domElement)/2+"px"};function lockScroll(e){console.log(e)}return CenteredDiv}(dat.dom.dom,dat.utils.common),dat.dom.dom,dat.utils.common)},{}],107:[function(require,module,exports){var events=require("events");var inherits=require("inherits");module.exports=function(opts){return new Chunker(opts)};module.exports.Chunker=Chunker;function Chunker(opts){this.distance=opts.chunkDistance||2;this.chunkSize=opts.chunkSize||32;this.cubeSize=opts.cubeSize||25;this.generateVoxelChunk=opts.generateVoxelChunk;this.chunks={};this.meshes={};if(this.chunkSize&this.chunkSize-1!==0)throw new Error("chunkSize must be a power of 2");var bits=0;for(var size=this.chunkSize;size>0;size>>=1)bits++;this.chunkBits=bits-1}inherits(Chunker,events.EventEmitter);Chunker.prototype.nearbyChunks=function(position,distance){var current=this.chunkAtPosition(position);var x=current[0];var y=current[1];var z=current[2];var dist=distance||this.distance;var nearby=[];for(var cx=x-dist;cx!==x+dist;++cx){for(var cy=y-dist;cy!==y+dist;++cy){for(var cz=z-dist;cz!==z+dist;++cz){nearby.push([cx,cy,cz])}}}return nearby};Chunker.prototype.requestMissingChunks=function(position){var self=this;this.nearbyChunks(position).map(function(chunk){if(!self.chunks[chunk.join("|")]){self.emit("missingChunk",chunk)}})};Chunker.prototype.getBounds=function(x,y,z){var bits=this.chunkBits;var low=[x<<bits,y<<bits,z<<bits];var high=[x+1<<bits,y+1<<bits,z+1<<bits];return[low,high]};Chunker.prototype.generateChunk=function(x,y,z){var self=this;var bounds=this.getBounds(x,y,z);var chunk=this.generateVoxelChunk(bounds[0],bounds[1],x,y,z);var position=[x,y,z];chunk.position=position;this.chunks[position.join("|")]=chunk;return chunk};Chunker.prototype.chunkAtCoordinates=function(x,y,z){var bits=this.chunkBits;var cx=x>>bits;var cy=y>>bits;var cz=z>>bits;var chunkPos=[cx,cy,cz];return chunkPos};Chunker.prototype.chunkAtPosition=function(position){var cubeSize=this.cubeSize;var x=Math.floor(position[0]/cubeSize);var y=Math.floor(position[1]/cubeSize);var z=Math.floor(position[2]/cubeSize);var chunkPos=this.chunkAtCoordinates(x,y,z);return chunkPos};Chunker.prototype.voxelIndexFromCoordinates=function(x,y,z){var bits=this.chunkBits;var mask=(1<<bits)-1;var vidx=(x&mask)+((y&mask)<<bits)+((z&mask)<<bits*2);return vidx};Chunker.prototype.voxelIndexFromPosition=function(pos){var v=this.voxelVector(pos);return this.voxelIndex(v)};Chunker.prototype.voxelAtCoordinates=function(x,y,z,val){var ckey=this.chunkAtCoordinates(x,y,z).join("|");var chunk=this.chunks[ckey];if(!chunk)return false;var vidx=this.voxelIndexFromCoordinates(x,y,z);var v=chunk.voxels[vidx];if(typeof val!=="undefined"){chunk.voxels[vidx]=val}return v};Chunker.prototype.voxelAtPosition=function(pos,val){var cubeSize=this.cubeSize;var x=Math.floor(pos[0]/cubeSize);var y=Math.floor(pos[1]/cubeSize);var z=Math.floor(pos[2]/cubeSize);var v=this.voxelAtCoordinates(x,y,z,val);return v};Chunker.prototype.voxelIndex=function(voxelVector){var vidx=this.voxelIndexFromCoordinates(voxelVector[0],voxelVector[1],voxelVector[2]);return vidx};Chunker.prototype.voxelVector=function(pos){var cubeSize=this.cubeSize;var mask=(1<<this.chunkBits)-1;var vx=Math.floor(pos[0]/cubeSize)&mask;var vy=Math.floor(pos[1]/cubeSize)&mask;var vz=Math.floor(pos[2]/cubeSize)&mask;return[vx,vy,vz]}},{events:507,inherits:114}],108:[function(require,module,exports){var chunker=require("./chunker");module.exports=function(opts){if(!opts.generateVoxelChunk)opts.generateVoxelChunk=function(low,high){return generate(low,high,module.exports.generator["Valley"])};return chunker(opts)};module.exports.meshers={culled:require("./meshers/culled").mesher,greedy:require("./meshers/greedy").mesher,transgreedy:require("./meshers/transgreedy").mesher,monotone:require("./meshers/monotone").mesher,stupid:require("./meshers/stupid").mesher};module.exports.Chunker=chunker.Chunker;module.exports.geometry={};module.exports.generator={};module.exports.generate=generate;function generate(l,h,f,game){var d=[h[0]-l[0],h[1]-l[1],h[2]-l[2]];var v=new Int8Array(d[0]*d[1]*d[2]);var n=0;for(var k=l[2];k<h[2];++k)for(var j=l[1];j<h[1];++j)for(var i=l[0];i<h[0];++i,++n){v[n]=f(i,j,k,n,game)}return{voxels:v,dims:d}}module.exports.generator["Sphere"]=function(i,j,k){return i*i+j*j+k*k<=16*16?1:0};module.exports.generator["Noise"]=function(i,j,k){return Math.random()<.1?Math.random()*16777215:0};module.exports.generator["Dense Noise"]=function(i,j,k){return Math.round(Math.random()*16777215)};module.exports.generator["Checker"]=function(i,j,k){return!!(i+j+k&1)?(i^j^k)&2?1:16777215:0};module.exports.generator["Hill"]=function(i,j,k){return j<=16*Math.exp(-(i*i+k*k)/64)?1:0};module.exports.generator["Valley"]=function(i,j,k){return j<=(i*i+k*k)*31/(32*32*2)+1?1:0};module.exports.generator["Hilly Terrain"]=function(i,j,k){var h0=3*Math.sin(Math.PI*i/12-Math.PI*k*.1)+27;if(j>h0+1){return 0}if(h0<=j){return 1}var h1=2*Math.sin(Math.PI*i*.25-Math.PI*k*.3)+20;if(h1<=j){return 2}if(2<j){return Math.random()<.1?2236962:11184810}return 3};module.exports.scale=function(x,fromLow,fromHigh,toLow,toHigh){return(x-fromLow)*(toHigh-toLow)/(fromHigh-fromLow)+toLow};module.exports.generateExamples=function(){return{Sphere:generate([-16,-16,-16],[16,16,16],module.exports.generator["Sphere"]),Noise:generate([0,0,0],[16,16,16],module.exports.generator["Noise"]),"Dense Noise":generate([0,0,0],[16,16,16],module.exports.generator["Dense Noise"]),Checker:generate([0,0,0],[8,8,8],module.exports.generator["Checker"]),Hill:generate([-16,0,-16],[16,16,16],module.exports.generator["Hill"]),Valley:generate([0,0,0],[32,32,32],module.exports.generator["Valley"]),"Hilly Terrain":generate([0,0,0],[32,32,32],module.exports.generator["Hilly Terrain"])}}},{"./chunker":107,"./meshers/culled":109,"./meshers/greedy":110,"./meshers/monotone":111,"./meshers/stupid":112,"./meshers/transgreedy":113}],109:[function(require,module,exports){function CulledMesh(volume,dims){var dir=new Array(3);for(var i=0;i<3;++i){dir[i]=[[0,0,0],[0,0,0]];dir[i][0][(i+1)%3]=1;dir[i][1][(i+2)%3]=1}var vertices=[],faces=[],x=[0,0,0],B=[[false,true],[false,true],[false,true]],n=-dims[0]*dims[1];for(B[2]=[false,true],x[2]=-1;x[2]<dims[2];B[2]=[true,++x[2]<dims[2]-1])for(n-=dims[0],B[1]=[false,true],x[1]=-1;x[1]<dims[1];B[1]=[true,++x[1]<dims[1]-1])for(n-=1,B[0]=[false,true],x[0]=-1;x[0]<dims[0];B[0]=[true,++x[0]<dims[0]-1],++n){var p=B[0][0]&&B[1][0]&&B[2][0]?volume[n]:0,b=[B[0][1]&&B[1][0]&&B[2][0]?volume[n+1]:0,B[0][0]&&B[1][1]&&B[2][0]?volume[n+dims[0]]:0,B[0][0]&&B[1][0]&&B[2][1]?volume[n+dims[0]*dims[1]]:0];for(var d=0;d<3;++d)if(!!p!==!!b[d]){var s=!p?1:0;var t=[x[0],x[1],x[2]],u=dir[d][s],v=dir[d][s^1];++t[d];var vertex_count=vertices.length;vertices.push([t[0],t[1],t[2]]);vertices.push([t[0]+u[0],t[1]+u[1],t[2]+u[2]]);vertices.push([t[0]+u[0]+v[0],t[1]+u[1]+v[1],t[2]+u[2]+v[2]]);vertices.push([t[0]+v[0],t[1]+v[1],t[2]+v[2]]);faces.push([vertex_count,vertex_count+1,vertex_count+2,vertex_count+3,s?b[d]:p])}}return{vertices:vertices,faces:faces}}if(exports){exports.mesher=CulledMesh}},{}],110:[function(require,module,exports){var GreedyMesh=function(){var mask=new Int32Array(4096);return function(volume,dims){var vertices=[],faces=[],dimsX=dims[0],dimsY=dims[1],dimsXY=dimsX*dimsY;for(var d=0;d<3;++d){var i,j,k,l,w,W,h,n,c,u=(d+1)%3,v=(d+2)%3,x=[0,0,0],q=[0,0,0],du=[0,0,0],dv=[0,0,0],dimsD=dims[d],dimsU=dims[u],dimsV=dims[v],qdimsX,qdimsXY,xd;if(mask.length<dimsU*dimsV){mask=new Int32Array(dimsU*dimsV)}q[d]=1;x[d]=-1;qdimsX=dimsX*q[1];qdimsXY=dimsXY*q[2];while(x[d]<dimsD){xd=x[d];n=0;for(x[v]=0;x[v]<dimsV;++x[v]){for(x[u]=0;x[u]<dimsU;++x[u],++n){var a=xd>=0&&volume[x[0]+dimsX*x[1]+dimsXY*x[2]],b=xd<dimsD-1&&volume[x[0]+q[0]+dimsX*x[1]+qdimsX+dimsXY*x[2]+qdimsXY];if(a?b:!b){mask[n]=0;continue}mask[n]=a?a:-b}}++x[d];n=0;for(j=0;j<dimsV;++j){for(i=0;i<dimsU;){c=mask[n];if(!c){i++;n++;continue}w=1;while(c===mask[n+w]&&i+w<dimsU)w++;for(h=1;j+h<dimsV;++h){k=0;while(k<w&&c===mask[n+k+h*dimsU])k++;if(k<w)break}du[d]=0;dv[d]=0;x[u]=i;x[v]=j;if(c>0){dv[v]=h;dv[u]=0;du[u]=w;du[v]=0}else{c=-c;du[v]=h;du[u]=0;dv[u]=w;dv[v]=0}var vertex_count=vertices.length;vertices.push([x[0],x[1],x[2]]);vertices.push([x[0]+du[0],x[1]+du[1],x[2]+du[2]]);vertices.push([x[0]+du[0]+dv[0],x[1]+du[1]+dv[1],x[2]+du[2]+dv[2]]);vertices.push([x[0]+dv[0],x[1]+dv[1],x[2]+dv[2]]);faces.push([vertex_count,vertex_count+1,vertex_count+2,vertex_count+3,c]);W=n+w;for(l=0;l<h;++l){for(k=n;k<W;++k){mask[k+l*dimsU]=0}}i+=w;n+=w}}}}return{vertices:vertices,faces:faces}}}();if(exports){exports.mesher=GreedyMesh}},{}],111:[function(require,module,exports){"use strict";var MonotoneMesh=function(){function MonotonePolygon(c,v,ul,ur){this.color=c;this.left=[[ul,v]];this.right=[[ur,v]]}MonotonePolygon.prototype.close_off=function(v){this.left.push([this.left[this.left.length-1][0],v]);this.right.push([this.right[this.right.length-1][0],v])};MonotonePolygon.prototype.merge_run=function(v,u_l,u_r){var l=this.left[this.left.length-1][0],r=this.right[this.right.length-1][0];if(l!==u_l){this.left.push([l,v]);this.left.push([u_l,v])}if(r!==u_r){this.right.push([r,v]);this.right.push([u_r,v])}};return function(volume,dims){function f(i,j,k){return volume[i+dims[0]*(j+dims[1]*k)]}var vertices=[],faces=[];for(var d=0;d<3;++d){var i,j,k,u=(d+1)%3,v=(d+2)%3,x=new Int32Array(3),q=new Int32Array(3),runs=new Int32Array(2*(dims[u]+1)),frontier=new Int32Array(dims[u]),next_frontier=new Int32Array(dims[u]),left_index=new Int32Array(2*dims[v]),right_index=new Int32Array(2*dims[v]),stack=new Int32Array(24*dims[v]),delta=[[0,0],[0,0]];q[d]=1;for(x[d]=-1;x[d]<dims[d];){var n=0,polygons=[],nf=0;for(x[v]=0;x[v]<dims[v];++x[v]){var nr=0,p=0,c=0;for(x[u]=0;x[u]<dims[u];++x[u],p=c){var a=0<=x[d]?f(x[0],x[1],x[2]):0,b=x[d]<dims[d]-1?f(x[0]+q[0],x[1]+q[1],x[2]+q[2]):0;c=a;if(!a===!b){c=0}else if(!a){c=-b}if(p!==c){runs[nr++]=x[u];runs[nr++]=c}}runs[nr++]=dims[u];runs[nr++]=0;var fp=0;for(var i=0,j=0;i<nf&&j<nr-2;){var p=polygons[frontier[i]],p_l=p.left[p.left.length-1][0],p_r=p.right[p.right.length-1][0],p_c=p.color,r_l=runs[j],r_r=runs[j+2],r_c=runs[j+1];if(r_r>p_l&&p_r>r_l&&r_c===p_c){p.merge_run(x[v],r_l,r_r);next_frontier[fp++]=frontier[i];++i;j+=2}else{if(r_r<=p_r){if(!!r_c){var n_poly=new MonotonePolygon(r_c,x[v],r_l,r_r);next_frontier[fp++]=polygons.length;polygons.push(n_poly)}j+=2}if(p_r<=r_r){p.close_off(x[v]);++i}}}for(;i<nf;++i){polygons[frontier[i]].close_off(x[v])}for(;j<nr-2;j+=2){var r_l=runs[j],r_r=runs[j+2],r_c=runs[j+1];if(!!r_c){var n_poly=new MonotonePolygon(r_c,x[v],r_l,r_r);next_frontier[fp++]=polygons.length;polygons.push(n_poly)}}var tmp=next_frontier;next_frontier=frontier;frontier=tmp;nf=fp}for(var i=0;i<nf;++i){var p=polygons[frontier[i]];p.close_off(dims[v])}x[d]++;for(var i=0;i<polygons.length;++i){var p=polygons[i],c=p.color,flipped=false;if(c<0){flipped=true;c=-c}for(var j=0;j<p.left.length;++j){left_index[j]=vertices.length;var y=[0,0,0],z=p.left[j];y[d]=x[d];y[u]=z[0];y[v]=z[1];vertices.push(y)}for(var j=0;j<p.right.length;++j){right_index[j]=vertices.length;var y=[0,0,0],z=p.right[j];y[d]=x[d];y[u]=z[0];y[v]=z[1];vertices.push(y)}var bottom=0,top=0,l_i=1,r_i=1,side=true;stack[top++]=left_index[0];stack[top++]=p.left[0][0];stack[top++]=p.left[0][1];stack[top++]=right_index[0];stack[top++]=p.right[0][0];stack[top++]=p.right[0][1];while(l_i<p.left.length||r_i<p.right.length){var n_side=false;if(l_i===p.left.length){n_side=true}else if(r_i!==p.right.length){var l=p.left[l_i],r=p.right[r_i];n_side=l[1]>r[1]}var idx=n_side?right_index[r_i]:left_index[l_i],vert=n_side?p.right[r_i]:p.left[l_i];if(n_side!==side){while(bottom+3<top){if(flipped===n_side){faces.push([stack[bottom],stack[bottom+3],idx,c])}else{faces.push([stack[bottom+3],stack[bottom],idx,c])}bottom+=3}}else{while(bottom+3<top){for(var j=0;j<2;++j)for(var k=0;k<2;++k){delta[j][k]=stack[top-3*(j+1)+k+1]-vert[k]}var det=delta[0][0]*delta[1][1]-delta[1][0]*delta[0][1];if(n_side===det>0){break}if(det!==0){if(flipped===n_side){faces.push([stack[top-3],stack[top-6],idx,c])}else{faces.push([stack[top-6],stack[top-3],idx,c])}}top-=3}}stack[top++]=idx;stack[top++]=vert[0];stack[top++]=vert[1];if(n_side){++r_i}else{++l_i}side=n_side}}}}return{vertices:vertices,faces:faces}}}();if(exports){exports.mesher=MonotoneMesh}},{}],112:[function(require,module,exports){function StupidMesh(volume,dims){var vertices=[],faces=[],x=[0,0,0],n=0;for(x[2]=0;x[2]<dims[2];++x[2])for(x[1]=0;x[1]<dims[1];++x[1])for(x[0]=0;x[0]<dims[0];++x[0],++n)if(!!volume[n]){for(var d=0;d<3;++d){var t=[x[0],x[1],x[2]],u=[0,0,0],v=[0,0,0];u[(d+1)%3]=1;v[(d+2)%3]=1;for(var s=0;s<2;++s){t[d]=x[d]+s;var tmp=u;u=v;v=tmp;var vertex_count=vertices.length;vertices.push([t[0],t[1],t[2]]);vertices.push([t[0]+u[0],t[1]+u[1],t[2]+u[2]]);vertices.push([t[0]+u[0]+v[0],t[1]+u[1]+v[1],t[2]+u[2]+v[2]]);vertices.push([t[0]+v[0],t[1]+v[1],t[2]+v[2]]);faces.push([vertex_count,vertex_count+1,vertex_count+2,vertex_count+3,volume[n]])}}}return{vertices:vertices,faces:faces}}if(exports){exports.mesher=StupidMesh}},{}],113:[function(require,module,exports){var GreedyMesh=function greedyLoader(){var mask=new Int32Array(4096);var invMask=new Int32Array(4096);var kTransparentMask=32768;var kNoFlagsMask=32767;var kTransparentTypes=[];kTransparentTypes[16]=true;function isTransparent(v){return(v&kTransparentMask)===kTransparentMask}function removeFlags(v){return v&kNoFlagsMask}return function ohSoGreedyMesher(volume,dims,mesherExtraData){var vertices=[],faces=[],dimsX=dims[0],dimsY=dims[1],dimsXY=dimsX*dimsY;var tVertices=[],tFaces=[];var transparentTypes=mesherExtraData?mesherExtraData.transparentTypes||{}:{};var getType=function(voxels,offset){var type=voxels[offset];return type|(type in transparentTypes?kTransparentMask:0)};for(var d=0;d<3;++d){var i,j,k,l,w,W,h,n,c,u=(d+1)%3,v=(d+2)%3,x=[0,0,0],q=[0,0,0],du=[0,0,0],dv=[0,0,0],dimsD=dims[d],dimsU=dims[u],dimsV=dims[v],qdimsX,qdimsXY,xd;if(mask.length<dimsU*dimsV){mask=new Int32Array(dimsU*dimsV);invMask=new Int32Array(dimsU*dimsV)}q[d]=1;x[d]=-1;qdimsX=dimsX*q[1];qdimsXY=dimsXY*q[2];while(x[d]<dimsD){xd=x[d];n=0;for(x[v]=0;x[v]<dimsV;++x[v]){for(x[u]=0;x[u]<dimsU;++x[u],++n){var a=xd>=0&&getType(volume,x[0]+dimsX*x[1]+dimsXY*x[2]),b=xd<dimsD-1&&getType(volume,x[0]+q[0]+dimsX*x[1]+qdimsX+dimsXY*x[2]+qdimsXY);if(isTransparent(a)&&isTransparent(b)){mask[n]=a;invMask[n]=b}else if(a&&(!b||isTransparent(b))){mask[n]=a;invMask[n]=0}else if(b&&(!a||isTransparent(a))){mask[n]=0;invMask[n]=b}else{mask[n]=0;invMask[n]=0}}}++x[d];function generateMesh(mask,dimsV,dimsU,vertices,faces,clockwise){clockwise=clockwise===undefined?true:clockwise;var n,j,i,c,w,h,k,du=[0,0,0],dv=[0,0,0];n=0;for(j=0;j<dimsV;++j){for(i=0;i<dimsU;){c=mask[n];if(!c){i++;n++;continue}w=1;while(c===mask[n+w]&&i+w<dimsU)w++;for(h=1;j+h<dimsV;++h){k=0;while(k<w&&c===mask[n+k+h*dimsU])k++;if(k<w)break}du[d]=0;dv[d]=0;x[u]=i;x[v]=j;if(clockwise){dv[v]=h;dv[u]=0;du[u]=w;du[v]=0}else{du[v]=h;du[u]=0;dv[u]=w;dv[v]=0}var vertex_count=vertices.length;vertices.push([x[0],x[1],x[2]]);vertices.push([x[0]+du[0],x[1]+du[1],x[2]+du[2]]);vertices.push([x[0]+du[0]+dv[0],x[1]+du[1]+dv[1],x[2]+du[2]+dv[2]]);vertices.push([x[0]+dv[0],x[1]+dv[1],x[2]+dv[2]]);faces.push([vertex_count,vertex_count+1,vertex_count+2,vertex_count+3,removeFlags(c)]);W=n+w;for(l=0;l<h;++l){for(k=n;k<W;++k){mask[k+l*dimsU]=0}}i+=w;n+=w}}}generateMesh(mask,dimsV,dimsU,vertices,faces,true);generateMesh(invMask,dimsV,dimsU,vertices,faces,false)}}return{vertices:vertices,faces:faces}}}();if(exports){exports.mesher=GreedyMesh}},{}],114:[function(require,module,exports){module.exports=require(4)},{}],115:[function(require,module,exports){(function(){var DropPlugin,coffee_script,ever;ever=require("ever");coffee_script=require("coffee-script");require("string.prototype.endswith");module.exports=function(game,opts){return new DropPlugin(game,opts)};DropPlugin=function(){function DropPlugin(game,opts){this.game=game;if(!this.game.isClient){return}if(this.game.materials.artPacks==null){throw new Error("voxel-drop requires voxel-texture-shader with artPacks")}this.packs=this.game.materials.artPacks;this.body=ever(document.body);this.enable()}DropPlugin.prototype.enable=function(){this.body.on("dragover",this.dragover=function(ev){ev.stopPropagation();return ev.preventDefault()});return this.body.on("drop",this.drop=function(_this){return function(mouseEvent){var file,files,shouldAppend,_i,_len,_results;mouseEvent.stopPropagation();mouseEvent.preventDefault();console.log("drop",mouseEvent);files=mouseEvent.target.files||mouseEvent.dataTransfer.files;console.log("Dropped",files);_results=[];for(_i=0,_len=files.length;_i<_len;_i++){file=files[_i];console.log("Reading dropped",file);if(file.name.endsWith(".zip")){shouldAppend=mouseEvent.shiftKey;_results.push(_this.loadArtPack(file,shouldAppend))}else if(file.name.endsWith(".js")){_results.push(_this.loadScript(file))}else if(file.name.endsWith(".coffee")){_results.push(_this.loadScript(file))}else{_results.push(window.alert("Unrecognized file dropped: "+file.name+". Try dropping a resourcepack/artpack (.zip)"))}}return _results}}(this))};DropPlugin.prototype.readAll=function(file,cb){var reader;reader=new FileReader;ever(reader).on("load",function(_this){return function(readEvent){var result;if(readEvent.total!==readEvent.loaded){return}result=readEvent.currentTarget.result;return cb(result)}}(this));return reader};DropPlugin.prototype.readAllText=function(file,cb){return this.readAll(file,cb).readAsText(file)};DropPlugin.prototype.readAllData=function(file,cb){return this.readAll(file,cb).readAsArrayBuffer(file)};DropPlugin.prototype.loadScript=function(file){return this.readAllText(file,function(_this){return function(rawText){var createCreatePlugin,createPlugin,e,name,opts,plugin,text;if(file.name.endsWith(".coffee")){text=coffee_script.compile(rawText)}else{text=rawText}try{createCreatePlugin=new Function("var module = {exports: {}}; var require = "+_this.game.plugins.require+"; "+text+" return module.exports;")}catch(_error){e=_error;window.alert("Exception loading plugin "+file.name+": "+e);throw e}createPlugin=createCreatePlugin();name=file.name;opts={};console.log("loadScript #file.name = "+createPlugin);if(!createPlugin||typeof createPlugin!=="function"){console.log("Ignored non-plugin "+name+", returned "+createPlugin);return}plugin=_this.game.plugins.instantiate(createPlugin,name,opts);if(!plugin){return window.alert("Failed to load plugin "+name)}else{return console.log("Loaded plugin: "+name+" = "+plugin)}}}(this))};DropPlugin.prototype.loadArtPack=function(file,shouldAppend){return this.readAllData(file,function(_this){return function(arrayBuffer){if(!shouldAppend){_this.packs.clear()}_this.packs.addPack(arrayBuffer,file.name);return _this.game.showAllChunks()}}(this))};DropPlugin.prototype.disable=function(){this.body.removeListener("dragover",this.dragover);return this.body.removeListener("drop",this.drop)};return DropPlugin}()}).call(this)},{"coffee-script":116,ever:125,"string.prototype.endswith":128}],116:[function(require,module,exports){var process=require("__browserify_process"),global=typeof self!=="undefined"?self:typeof window!=="undefined"?window:{};(function(){var Lexer,SourceMap,compile,formatSourcePosition,fs,getSourceMap,helpers,lexer,parser,path,sourceMaps,vm,withPrettyErrors,__hasProp={}.hasOwnProperty,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};fs=require("fs");vm=require("vm");path=require("path");Lexer=require("./lexer").Lexer;parser=require("./parser").parser;helpers=require("./helpers");SourceMap=require("./sourcemap");exports.VERSION="1.7.1";exports.FILE_EXTENSIONS=[".coffee",".litcoffee",".coffee.md"];exports.helpers=helpers;withPrettyErrors=function(fn){return function(code,options){var err;if(options==null){options={}}try{return fn.call(this,code,options)}catch(_error){err=_error;throw helpers.updateSyntaxError(err,code,options.filename)}}};exports.compile=compile=withPrettyErrors(function(code,options){var answer,currentColumn,currentLine,extend,fragment,fragments,header,js,map,merge,newLines,_i,_len;merge=helpers.merge,extend=helpers.extend;options=extend({},options);if(options.sourceMap){map=new SourceMap}fragments=parser.parse(lexer.tokenize(code,options)).compileToFragments(options);currentLine=0;if(options.header){currentLine+=1}if(options.shiftLine){currentLine+=1}currentColumn=0;js="";for(_i=0,_len=fragments.length;_i<_len;_i++){fragment=fragments[_i];if(options.sourceMap){if(fragment.locationData){map.add([fragment.locationData.first_line,fragment.locationData.first_column],[currentLine,currentColumn],{noReplace:true})}newLines=helpers.count(fragment.code,"\n");currentLine+=newLines;if(newLines){currentColumn=fragment.code.length-(fragment.code.lastIndexOf("\n")+1)}else{currentColumn+=fragment.code.length}}js+=fragment.code}if(options.header){header="Generated by CoffeeScript "+this.VERSION;js="// "+header+"\n"+js}if(options.sourceMap){answer={js:js};answer.sourceMap=map;answer.v3SourceMap=map.generate(options,code);return answer}else{return js}});exports.tokens=withPrettyErrors(function(code,options){return lexer.tokenize(code,options)});exports.nodes=withPrettyErrors(function(source,options){if(typeof source==="string"){return parser.parse(lexer.tokenize(source,options))}else{return parser.parse(source)}});exports.run=function(code,options){var answer,dir,mainModule,_ref;if(options==null){options={}}mainModule=require.main;mainModule.filename=process.argv[1]=options.filename?fs.realpathSync(options.filename):".";mainModule.moduleCache&&(mainModule.moduleCache={});dir=options.filename?path.dirname(fs.realpathSync(options.filename)):fs.realpathSync(".");mainModule.paths=require("module")._nodeModulePaths(dir);if(!helpers.isCoffee(mainModule.filename)||require.extensions){answer=compile(code,options);code=(_ref=answer.js)!=null?_ref:answer}return mainModule._compile(code,mainModule.filename)};exports["eval"]=function(code,options){var Module,Script,js,k,o,r,sandbox,v,_i,_len,_module,_ref,_ref1,_require;if(options==null){options={}}if(!(code=code.trim())){return}Script=vm.Script;if(Script){if(options.sandbox!=null){if(options.sandbox instanceof Script.createContext().constructor){sandbox=options.sandbox}else{sandbox=Script.createContext();_ref=options.sandbox;for(k in _ref){if(!__hasProp.call(_ref,k))continue;v=_ref[k];sandbox[k]=v}}sandbox.global=sandbox.root=sandbox.GLOBAL=sandbox}else{sandbox=global}sandbox.__filename=options.filename||"eval";sandbox.__dirname=path.dirname(sandbox.__filename);if(!(sandbox!==global||sandbox.module||sandbox.require)){Module=require("module");sandbox.module=_module=new Module(options.modulename||"eval");sandbox.require=_require=function(path){return Module._load(path,_module,true)};
_module.filename=sandbox.__filename;_ref1=Object.getOwnPropertyNames(require);for(_i=0,_len=_ref1.length;_i<_len;_i++){r=_ref1[_i];if(r!=="paths"){_require[r]=require[r]}}_require.paths=_module.paths=Module._nodeModulePaths(process.cwd());_require.resolve=function(request){return Module._resolveFilename(request,_module)}}}o={};for(k in options){if(!__hasProp.call(options,k))continue;v=options[k];o[k]=v}o.bare=true;js=compile(code,o);if(sandbox===global){return vm.runInThisContext(js)}else{return vm.runInContext(js,sandbox)}};exports.register=function(){return require("./register")};exports._compileFile=function(filename,sourceMap){var answer,err,raw,stripped;if(sourceMap==null){sourceMap=false}raw=fs.readFileSync(filename,"utf8");stripped=raw.charCodeAt(0)===65279?raw.substring(1):raw;try{answer=compile(stripped,{filename:filename,sourceMap:sourceMap,literate:helpers.isLiterate(filename)})}catch(_error){err=_error;throw helpers.updateSyntaxError(err,stripped,filename)}return answer};lexer=new Lexer;parser.lexer={lex:function(){var tag,token;token=this.tokens[this.pos++];if(token){tag=token[0],this.yytext=token[1],this.yylloc=token[2];this.errorToken=token.origin||token;this.yylineno=this.yylloc.first_line}else{tag=""}return tag},setInput:function(tokens){this.tokens=tokens;return this.pos=0},upcomingInput:function(){return""}};parser.yy=require("./nodes");parser.yy.parseError=function(message,_arg){var errorLoc,errorTag,errorText,errorToken,token,tokens,_ref;token=_arg.token;_ref=parser.lexer,errorToken=_ref.errorToken,tokens=_ref.tokens;errorTag=errorToken[0],errorText=errorToken[1],errorLoc=errorToken[2];errorText=errorToken===tokens[tokens.length-1]?"end of input":errorTag==="INDENT"||errorTag==="OUTDENT"?"indentation":helpers.nameWhitespaceCharacter(errorText);return helpers.throwSyntaxError("unexpected "+errorText,errorLoc)};formatSourcePosition=function(frame,getSourceMapping){var as,column,fileLocation,fileName,functionName,isConstructor,isMethodCall,line,methodName,source,tp,typeName;fileName=void 0;fileLocation="";if(frame.isNative()){fileLocation="native"}else{if(frame.isEval()){fileName=frame.getScriptNameOrSourceURL();if(!fileName){fileLocation=""+frame.getEvalOrigin()+", "}}else{fileName=frame.getFileName()}fileName||(fileName="<anonymous>");line=frame.getLineNumber();column=frame.getColumnNumber();source=getSourceMapping(fileName,line,column);fileLocation=source?""+fileName+":"+source[0]+":"+source[1]:""+fileName+":"+line+":"+column}functionName=frame.getFunctionName();isConstructor=frame.isConstructor();isMethodCall=!(frame.isToplevel()||isConstructor);if(isMethodCall){methodName=frame.getMethodName();typeName=frame.getTypeName();if(functionName){tp=as="";if(typeName&&functionName.indexOf(typeName)){tp=""+typeName+"."}if(methodName&&functionName.indexOf("."+methodName)!==functionName.length-methodName.length-1){as=" [as "+methodName+"]"}return""+tp+functionName+as+" ("+fileLocation+")"}else{return""+typeName+"."+(methodName||"<anonymous>")+" ("+fileLocation+")"}}else if(isConstructor){return"new "+(functionName||"<anonymous>")+" ("+fileLocation+")"}else if(functionName){return""+functionName+" ("+fileLocation+")"}else{return fileLocation}};sourceMaps={};getSourceMap=function(filename){var answer,_ref;if(sourceMaps[filename]){return sourceMaps[filename]}if(_ref=path!=null?path.extname(filename):void 0,__indexOf.call(exports.FILE_EXTENSIONS,_ref)<0){return}answer=exports._compileFile(filename,true);return sourceMaps[filename]=answer.sourceMap};Error.prepareStackTrace=function(err,stack){var frame,frames,getSourceMapping,_ref;getSourceMapping=function(filename,line,column){var answer,sourceMap;sourceMap=getSourceMap(filename);if(sourceMap){answer=sourceMap.sourceLocation([line-1,column-1])}if(answer){return[answer[0]+1,answer[1]+1]}else{return null}};frames=function(){var _i,_len,_results;_results=[];for(_i=0,_len=stack.length;_i<_len;_i++){frame=stack[_i];if(frame.getFunction()===exports.run){break}_results.push("  at "+formatSourcePosition(frame,getSourceMapping))}return _results}();return""+err.name+": "+((_ref=err.message)!=null?_ref:"")+"\n"+frames.join("\n")+"\n"}}).call(this)},{"./helpers":117,"./lexer":118,"./nodes":119,"./parser":120,"./register":121,"./sourcemap":124,__browserify_process:510,fs:505,module:505,path:514,vm:530}],117:[function(require,module,exports){var process=require("__browserify_process");(function(){var buildLocationData,extend,flatten,last,repeat,syntaxErrorToString,_ref;exports.starts=function(string,literal,start){return literal===string.substr(start,literal.length)};exports.ends=function(string,literal,back){var len;len=literal.length;return literal===string.substr(string.length-len-(back||0),len)};exports.repeat=repeat=function(str,n){var res;res="";while(n>0){if(n&1){res+=str}n>>>=1;str+=str}return res};exports.compact=function(array){var item,_i,_len,_results;_results=[];for(_i=0,_len=array.length;_i<_len;_i++){item=array[_i];if(item){_results.push(item)}}return _results};exports.count=function(string,substr){var num,pos;num=pos=0;if(!substr.length){return 1/0}while(pos=1+string.indexOf(substr,pos)){num++}return num};exports.merge=function(options,overrides){return extend(extend({},options),overrides)};extend=exports.extend=function(object,properties){var key,val;for(key in properties){val=properties[key];object[key]=val}return object};exports.flatten=flatten=function(array){var element,flattened,_i,_len;flattened=[];for(_i=0,_len=array.length;_i<_len;_i++){element=array[_i];if(element instanceof Array){flattened=flattened.concat(flatten(element))}else{flattened.push(element)}}return flattened};exports.del=function(obj,key){var val;val=obj[key];delete obj[key];return val};exports.last=last=function(array,back){return array[array.length-(back||0)-1]};exports.some=(_ref=Array.prototype.some)!=null?_ref:function(fn){var e,_i,_len;for(_i=0,_len=this.length;_i<_len;_i++){e=this[_i];if(fn(e)){return true}}return false};exports.invertLiterate=function(code){var line,lines,maybe_code;maybe_code=true;lines=function(){var _i,_len,_ref1,_results;_ref1=code.split("\n");_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){line=_ref1[_i];if(maybe_code&&/^([ ]{4}|[ ]{0,3}\t)/.test(line)){_results.push(line)}else if(maybe_code=/^\s*$/.test(line)){_results.push(line)}else{_results.push("# "+line)}}return _results}();return lines.join("\n")};buildLocationData=function(first,last){if(!last){return first}else{return{first_line:first.first_line,first_column:first.first_column,last_line:last.last_line,last_column:last.last_column}}};exports.addLocationDataFn=function(first,last){return function(obj){if(typeof obj==="object"&&!!obj["updateLocationDataIfMissing"]){obj.updateLocationDataIfMissing(buildLocationData(first,last))}return obj}};exports.locationDataToString=function(obj){var locationData;if("2"in obj&&"first_line"in obj[2]){locationData=obj[2]}else if("first_line"in obj){locationData=obj}if(locationData){return""+(locationData.first_line+1)+":"+(locationData.first_column+1)+"-"+(""+(locationData.last_line+1)+":"+(locationData.last_column+1))}else{return"No location data"}};exports.baseFileName=function(file,stripExt,useWinPathSep){var parts,pathSep;if(stripExt==null){stripExt=false}if(useWinPathSep==null){useWinPathSep=false}pathSep=useWinPathSep?/\\|\//:/\//;parts=file.split(pathSep);file=parts[parts.length-1];if(!(stripExt&&file.indexOf(".")>=0)){return file}parts=file.split(".");parts.pop();if(parts[parts.length-1]==="coffee"&&parts.length>1){parts.pop()}return parts.join(".")};exports.isCoffee=function(file){return/\.((lit)?coffee|coffee\.md)$/.test(file)};exports.isLiterate=function(file){return/\.(litcoffee|coffee\.md)$/.test(file)};exports.throwSyntaxError=function(message,location){var error;error=new SyntaxError(message);error.location=location;error.toString=syntaxErrorToString;error.stack=error.toString();throw error};exports.updateSyntaxError=function(error,code,filename){if(error.toString===syntaxErrorToString){error.code||(error.code=code);error.filename||(error.filename=filename);error.stack=error.toString()}return error};syntaxErrorToString=function(){var codeLine,colorize,colorsEnabled,end,filename,first_column,first_line,last_column,last_line,marker,start,_ref1,_ref2;if(!(this.code&&this.location)){return Error.prototype.toString.call(this)}_ref1=this.location,first_line=_ref1.first_line,first_column=_ref1.first_column,last_line=_ref1.last_line,last_column=_ref1.last_column;if(last_line==null){last_line=first_line}if(last_column==null){last_column=first_column}filename=this.filename||"[stdin]";codeLine=this.code.split("\n")[first_line];start=first_column;end=first_line===last_line?last_column+1:codeLine.length;marker=repeat(" ",start)+repeat("^",end-start);if(typeof process!=="undefined"&&process!==null){colorsEnabled=process.stdout.isTTY&&!process.env.NODE_DISABLE_COLORS}if((_ref2=this.colorful)!=null?_ref2:colorsEnabled){colorize=function(str){return"[1;31m"+str+"[0m"};codeLine=codeLine.slice(0,start)+colorize(codeLine.slice(start,end))+codeLine.slice(end);marker=colorize(marker)}return""+filename+":"+(first_line+1)+":"+(first_column+1)+": error: "+this.message+"\n"+codeLine+"\n"+marker};exports.nameWhitespaceCharacter=function(string){switch(string){case" ":return"space";case"\n":return"newline";case"\r":return"carriage return";case"	":return"tab";default:return string}}}).call(this)},{__browserify_process:510}],118:[function(require,module,exports){(function(){var BOM,BOOL,CALLABLE,CODE,COFFEE_ALIASES,COFFEE_ALIAS_MAP,COFFEE_KEYWORDS,COMMENT,COMPARE,COMPOUND_ASSIGN,HEREDOC,HEREDOC_ILLEGAL,HEREDOC_INDENT,HEREGEX,HEREGEX_OMIT,IDENTIFIER,INDENTABLE_CLOSERS,INDEXABLE,INVERSES,JSTOKEN,JS_FORBIDDEN,JS_KEYWORDS,LINE_BREAK,LINE_CONTINUER,LOGIC,Lexer,MATH,MULTILINER,MULTI_DENT,NOT_REGEX,NOT_SPACED_REGEX,NUMBER,OPERATOR,REGEX,RELATION,RESERVED,Rewriter,SHIFT,SIMPLESTR,STRICT_PROSCRIBED,TRAILING_SPACES,UNARY,UNARY_MATH,WHITESPACE,compact,count,invertLiterate,key,last,locationDataToString,repeat,starts,throwSyntaxError,_ref,_ref1,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};_ref=require("./rewriter"),Rewriter=_ref.Rewriter,INVERSES=_ref.INVERSES;_ref1=require("./helpers"),count=_ref1.count,starts=_ref1.starts,compact=_ref1.compact,last=_ref1.last,repeat=_ref1.repeat,invertLiterate=_ref1.invertLiterate,locationDataToString=_ref1.locationDataToString,throwSyntaxError=_ref1.throwSyntaxError;exports.Lexer=Lexer=function(){function Lexer(){}Lexer.prototype.tokenize=function(code,opts){var consumed,i,tag,_ref2;if(opts==null){opts={}}this.literate=opts.literate;this.indent=0;this.baseIndent=0;this.indebt=0;this.outdebt=0;this.indents=[];this.ends=[];this.tokens=[];this.chunkLine=opts.line||0;this.chunkColumn=opts.column||0;code=this.clean(code);i=0;while(this.chunk=code.slice(i)){consumed=this.identifierToken()||this.commentToken()||this.whitespaceToken()||this.lineToken()||this.heredocToken()||this.stringToken()||this.numberToken()||this.regexToken()||this.jsToken()||this.literalToken();_ref2=this.getLineAndColumnFromChunk(consumed),this.chunkLine=_ref2[0],this.chunkColumn=_ref2[1];i+=consumed}this.closeIndentation();if(tag=this.ends.pop()){this.error("missing "+tag)}if(opts.rewrite===false){return this.tokens}return(new Rewriter).rewrite(this.tokens)};Lexer.prototype.clean=function(code){if(code.charCodeAt(0)===BOM){code=code.slice(1)}code=code.replace(/\r/g,"").replace(TRAILING_SPACES,"");if(WHITESPACE.test(code)){code="\n"+code;this.chunkLine--}if(this.literate){code=invertLiterate(code)}return code};Lexer.prototype.identifierToken=function(){var colon,colonOffset,forcedIdentifier,id,idLength,input,match,poppedToken,prev,tag,tagToken,_ref2,_ref3,_ref4;if(!(match=IDENTIFIER.exec(this.chunk))){return 0}input=match[0],id=match[1],colon=match[2];idLength=id.length;poppedToken=void 0;if(id==="own"&&this.tag()==="FOR"){this.token("OWN",id);return id.length}forcedIdentifier=colon||(prev=last(this.tokens))&&((_ref2=prev[0])==="."||_ref2==="?."||_ref2==="::"||_ref2==="?::"||!prev.spaced&&prev[0]==="@");tag="IDENTIFIER";if(!forcedIdentifier&&(__indexOf.call(JS_KEYWORDS,id)>=0||__indexOf.call(COFFEE_KEYWORDS,id)>=0)){tag=id.toUpperCase();if(tag==="WHEN"&&(_ref3=this.tag(),__indexOf.call(LINE_BREAK,_ref3)>=0)){tag="LEADING_WHEN"}else if(tag==="FOR"){this.seenFor=true}else if(tag==="UNLESS"){tag="IF"}else if(__indexOf.call(UNARY,tag)>=0){tag="UNARY"}else if(__indexOf.call(RELATION,tag)>=0){if(tag!=="INSTANCEOF"&&this.seenFor){tag="FOR"+tag;this.seenFor=false}else{tag="RELATION";if(this.value()==="!"){poppedToken=this.tokens.pop();id="!"+id}}}}if(__indexOf.call(JS_FORBIDDEN,id)>=0){if(forcedIdentifier){tag="IDENTIFIER";id=new String(id);id.reserved=true}else if(__indexOf.call(RESERVED,id)>=0){this.error('reserved word "'+id+'"')}}if(!forcedIdentifier){if(__indexOf.call(COFFEE_ALIASES,id)>=0){id=COFFEE_ALIAS_MAP[id]}tag=function(){switch(id){case"!":return"UNARY";case"==":case"!=":return"COMPARE";case"&&":case"||":return"LOGIC";case"true":case"false":return"BOOL";case"break":case"continue":return"STATEMENT";default:return tag}}()}tagToken=this.token(tag,id,0,idLength);if(poppedToken){_ref4=[poppedToken[2].first_line,poppedToken[2].first_column],tagToken[2].first_line=_ref4[0],tagToken[2].first_column=_ref4[1]}if(colon){colonOffset=input.lastIndexOf(":");this.token(":",":",colonOffset,colon.length)}return input.length};Lexer.prototype.numberToken=function(){var binaryLiteral,lexedLength,match,number,octalLiteral;if(!(match=NUMBER.exec(this.chunk))){return 0}number=match[0];if(/^0[BOX]/.test(number)){this.error("radix prefix '"+number+"' must be lowercase")}else if(/E/.test(number)&&!/^0x/.test(number)){this.error("exponential notation '"+number+"' must be indicated with a lowercase 'e'")}else if(/^0\d*[89]/.test(number)){this.error("decimal literal '"+number+"' must not be prefixed with '0'")}else if(/^0\d+/.test(number)){this.error("octal literal '"+number+"' must be prefixed with '0o'")}lexedLength=number.length;if(octalLiteral=/^0o([0-7]+)/.exec(number)){number="0x"+parseInt(octalLiteral[1],8).toString(16)}if(binaryLiteral=/^0b([01]+)/.exec(number)){number="0x"+parseInt(binaryLiteral[1],2).toString(16)}this.token("NUMBER",number,0,lexedLength);return lexedLength};Lexer.prototype.stringToken=function(){var octalEsc,quote,string,trimmed;switch(quote=this.chunk.charAt(0)){case"'":string=SIMPLESTR.exec(this.chunk)[0];break;case'"':string=this.balancedString(this.chunk,'"')}if(!string){return 0}trimmed=this.removeNewlines(string.slice(1,-1));if(quote==='"'&&0<string.indexOf("#{",1)){this.interpolateString(trimmed,{strOffset:1,lexedLength:string.length})}else{this.token("STRING",quote+this.escapeLines(trimmed)+quote,0,string.length)}if(octalEsc=/^(?:\\.|[^\\])*\\(?:0[0-7]|[1-7])/.test(string)){this.error("octal escape sequences "+string+" are not allowed")}return string.length};Lexer.prototype.heredocToken=function(){var doc,heredoc,match,quote;if(!(match=HEREDOC.exec(this.chunk))){return 0}heredoc=match[0];quote=heredoc.charAt(0);doc=this.sanitizeHeredoc(match[2],{quote:quote,indent:null});if(quote==='"'&&0<=doc.indexOf("#{")){this.interpolateString(doc,{heredoc:true,strOffset:3,lexedLength:heredoc.length})}else{this.token("STRING",this.makeString(doc,quote,true),0,heredoc.length)}return heredoc.length};Lexer.prototype.commentToken=function(){var comment,here,match;if(!(match=this.chunk.match(COMMENT))){return 0}comment=match[0],here=match[1];if(here){this.token("HERECOMMENT",this.sanitizeHeredoc(here,{herecomment:true,indent:repeat(" ",this.indent)}),0,comment.length)}return comment.length};Lexer.prototype.jsToken=function(){var match,script;if(!(this.chunk.charAt(0)==="`"&&(match=JSTOKEN.exec(this.chunk)))){return 0}this.token("JS",(script=match[0]).slice(1,-1),0,script.length);return script.length};Lexer.prototype.regexToken=function(){var flags,length,match,prev,regex,_ref2,_ref3;if(this.chunk.charAt(0)!=="/"){return 0}if(length=this.heregexToken()){return length}prev=last(this.tokens);if(prev&&(_ref2=prev[0],__indexOf.call(prev.spaced?NOT_REGEX:NOT_SPACED_REGEX,_ref2)>=0)){return 0}if(!(match=REGEX.exec(this.chunk))){return 0}_ref3=match,match=_ref3[0],regex=_ref3[1],flags=_ref3[2];if(regex==="//"){return 0}if(regex.slice(0,2)==="/*"){this.error("regular expressions cannot begin with `*`")}this.token("REGEX",""+regex+flags,0,match.length);return match.length};Lexer.prototype.heregexToken=function(){var body,flags,flagsOffset,heregex,match,plusToken,prev,re,tag,token,tokens,value,_i,_len,_ref2,_ref3,_ref4;if(!(match=HEREGEX.exec(this.chunk))){return 0}heregex=match[0],body=match[1],flags=match[2];if(0>body.indexOf("#{")){re=this.escapeLines(body.replace(HEREGEX_OMIT,"$1$2").replace(/\//g,"\\/"),true);if(re.match(/^\*/)){this.error("regular expressions cannot begin with `*`")}this.token("REGEX","/"+(re||"(?:)")+"/"+flags,0,heregex.length);return heregex.length}this.token("IDENTIFIER","RegExp",0,0);this.token("CALL_START","(",0,0);tokens=[];_ref2=this.interpolateString(body,{regex:true});for(_i=0,_len=_ref2.length;_i<_len;_i++){token=_ref2[_i];tag=token[0],value=token[1];if(tag==="TOKENS"){tokens.push.apply(tokens,value)}else if(tag==="NEOSTRING"){if(!(value=value.replace(HEREGEX_OMIT,"$1$2"))){continue}value=value.replace(/\\/g,"\\\\");token[0]="STRING";token[1]=this.makeString(value,'"',true);tokens.push(token)}else{this.error("Unexpected "+tag)}prev=last(this.tokens);plusToken=["+","+"];plusToken[2]=prev[2];tokens.push(plusToken)}tokens.pop();if(((_ref3=tokens[0])!=null?_ref3[0]:void 0)!=="STRING"){this.token("STRING",'""',0,0);this.token("+","+",0,0)}(_ref4=this.tokens).push.apply(_ref4,tokens);if(flags){flagsOffset=heregex.lastIndexOf(flags);this.token(",",",",flagsOffset,0);this.token("STRING",'"'+flags+'"',flagsOffset,flags.length)}this.token(")",")",heregex.length-1,0);return heregex.length};Lexer.prototype.lineToken=function(){var diff,indent,match,noNewlines,size;if(!(match=MULTI_DENT.exec(this.chunk))){return 0}indent=match[0];this.seenFor=false;size=indent.length-1-indent.lastIndexOf("\n");noNewlines=this.unfinished();if(size-this.indebt===this.indent){if(noNewlines){this.suppressNewlines()}else{this.newlineToken(0)}return indent.length}if(size>this.indent){if(noNewlines){this.indebt=size-this.indent;this.suppressNewlines();return indent.length}if(!this.tokens.length){this.baseIndent=this.indent=size;return indent.length}diff=size-this.indent+this.outdebt;this.token("INDENT",diff,indent.length-size,size);this.indents.push(diff);this.ends.push("OUTDENT");this.outdebt=this.indebt=0;this.indent=size}else if(size<this.baseIndent){this.error("missing indentation",indent.length)}else{this.indebt=0;this.outdentToken(this.indent-size,noNewlines,indent.length)}return indent.length};Lexer.prototype.outdentToken=function(moveOut,noNewlines,outdentLength){var decreasedIndent,dent,lastIndent,_ref2;decreasedIndent=this.indent-moveOut;while(moveOut>0){lastIndent=this.indents[this.indents.length-1];if(!lastIndent){moveOut=0}else if(lastIndent===this.outdebt){moveOut-=this.outdebt;this.outdebt=0}else if(lastIndent<this.outdebt){this.outdebt-=lastIndent;moveOut-=lastIndent}else{dent=this.indents.pop()+this.outdebt;if(outdentLength&&(_ref2=this.chunk[outdentLength],__indexOf.call(INDENTABLE_CLOSERS,_ref2)>=0)){decreasedIndent-=dent-moveOut;moveOut=dent}this.outdebt=0;this.pair("OUTDENT");this.token("OUTDENT",moveOut,0,outdentLength);moveOut-=dent}}if(dent){this.outdebt-=moveOut}while(this.value()===";"){this.tokens.pop()}if(!(this.tag()==="TERMINATOR"||noNewlines)){this.token("TERMINATOR","\n",outdentLength,0)}this.indent=decreasedIndent;return this};Lexer.prototype.whitespaceToken=function(){var match,nline,prev;if(!((match=WHITESPACE.exec(this.chunk))||(nline=this.chunk.charAt(0)==="\n"))){return 0}prev=last(this.tokens);if(prev){prev[match?"spaced":"newLine"]=true}if(match){return match[0].length}else{return 0}};Lexer.prototype.newlineToken=function(offset){while(this.value()===";"){this.tokens.pop()}if(this.tag()!=="TERMINATOR"){this.token("TERMINATOR","\n",offset,0)}return this};Lexer.prototype.suppressNewlines=function(){if(this.value()==="\\"){this.tokens.pop()}return this};Lexer.prototype.literalToken=function(){var match,prev,tag,value,_ref2,_ref3,_ref4,_ref5;if(match=OPERATOR.exec(this.chunk)){value=match[0];if(CODE.test(value)){this.tagParameters()}}else{value=this.chunk.charAt(0)}tag=value;prev=last(this.tokens);if(value==="="&&prev){if(!prev[1].reserved&&(_ref2=prev[1],__indexOf.call(JS_FORBIDDEN,_ref2)>=0)){this.error('reserved word "'+this.value()+"\" can't be assigned")}if((_ref3=prev[1])==="||"||_ref3==="&&"){prev[0]="COMPOUND_ASSIGN";prev[1]+="=";return value.length}}if(value===";"){this.seenFor=false;tag="TERMINATOR"}else if(__indexOf.call(MATH,value)>=0){tag="MATH"}else if(__indexOf.call(COMPARE,value)>=0){tag="COMPARE"}else if(__indexOf.call(COMPOUND_ASSIGN,value)>=0){tag="COMPOUND_ASSIGN"}else if(__indexOf.call(UNARY,value)>=0){tag="UNARY"}else if(__indexOf.call(UNARY_MATH,value)>=0){tag="UNARY_MATH"}else if(__indexOf.call(SHIFT,value)>=0){tag="SHIFT"}else if(__indexOf.call(LOGIC,value)>=0||value==="?"&&(prev!=null?prev.spaced:void 0)){tag="LOGIC"}else if(prev&&!prev.spaced){if(value==="("&&(_ref4=prev[0],__indexOf.call(CALLABLE,_ref4)>=0)){if(prev[0]==="?"){prev[0]="FUNC_EXIST"}tag="CALL_START"}else if(value==="["&&(_ref5=prev[0],__indexOf.call(INDEXABLE,_ref5)>=0)){tag="INDEX_START";switch(prev[0]){case"?":prev[0]="INDEX_SOAK"}}}switch(value){case"(":case"{":case"[":this.ends.push(INVERSES[value]);break;case")":case"}":case"]":this.pair(value)}this.token(tag,value);return value.length};Lexer.prototype.sanitizeHeredoc=function(doc,options){var attempt,herecomment,indent,match,_ref2;indent=options.indent,herecomment=options.herecomment;if(herecomment){if(HEREDOC_ILLEGAL.test(doc)){this.error('block comment cannot contain "*/", starting')}if(doc.indexOf("\n")<0){return doc}}else{while(match=HEREDOC_INDENT.exec(doc)){attempt=match[1];if(indent===null||0<(_ref2=attempt.length)&&_ref2<indent.length){indent=attempt}}}if(indent){doc=doc.replace(RegExp("\\n"+indent,"g"),"\n")}if(!herecomment){doc=doc.replace(/^\n/,"")}return doc};Lexer.prototype.tagParameters=function(){var i,stack,tok,tokens;if(this.tag()!==")"){return this}stack=[];tokens=this.tokens;i=tokens.length;tokens[--i][0]="PARAM_END";while(tok=tokens[--i]){switch(tok[0]){case")":stack.push(tok);break;case"(":case"CALL_START":if(stack.length){stack.pop()}else if(tok[0]==="("){tok[0]="PARAM_START";return this}else{return this}}}return this};Lexer.prototype.closeIndentation=function(){return this.outdentToken(this.indent)};Lexer.prototype.balancedString=function(str,end){var continueCount,i,letter,match,prev,stack,_i,_ref2;continueCount=0;stack=[end];for(i=_i=1,_ref2=str.length;1<=_ref2?_i<_ref2:_i>_ref2;i=1<=_ref2?++_i:--_i){if(continueCount){--continueCount;continue}switch(letter=str.charAt(i)){case"\\":++continueCount;continue;case end:stack.pop();if(!stack.length){return str.slice(0,+i+1||9e9)}end=stack[stack.length-1];continue}if(end==="}"&&(letter==='"'||letter==="'")){stack.push(end=letter)}else if(end==="}"&&letter==="/"&&(match=HEREGEX.exec(str.slice(i))||REGEX.exec(str.slice(i)))){continueCount+=match[0].length-1}else if(end==="}"&&letter==="{"){stack.push(end="}")}else if(end==='"'&&prev==="#"&&letter==="{"){stack.push(end="}")}prev=letter}return this.error("missing "+stack.pop()+", starting")};Lexer.prototype.interpolateString=function(str,options){var column,errorToken,expr,heredoc,i,inner,interpolated,len,letter,lexedLength,line,locationToken,nested,offsetInChunk,pi,plusToken,popped,regex,rparen,strOffset,tag,token,tokens,value,_i,_len,_ref2,_ref3,_ref4;if(options==null){options={}}heredoc=options.heredoc,regex=options.regex,offsetInChunk=options.offsetInChunk,strOffset=options.strOffset,lexedLength=options.lexedLength;offsetInChunk||(offsetInChunk=0);strOffset||(strOffset=0);lexedLength||(lexedLength=str.length);tokens=[];pi=0;i=-1;while(letter=str.charAt(i+=1)){if(letter==="\\"){i+=1;continue}if(!(letter==="#"&&str.charAt(i+1)==="{"&&(expr=this.balancedString(str.slice(i+1),"}")))){continue}if(pi<i){tokens.push(this.makeToken("NEOSTRING",str.slice(pi,i),strOffset+pi))}if(!errorToken){errorToken=this.makeToken("","string interpolation",offsetInChunk+i+1,2)}inner=expr.slice(1,-1);if(inner.length){_ref2=this.getLineAndColumnFromChunk(strOffset+i+1),line=_ref2[0],column=_ref2[1];nested=(new Lexer).tokenize(inner,{line:line,column:column,rewrite:false});popped=nested.pop();if(((_ref3=nested[0])!=null?_ref3[0]:void 0)==="TERMINATOR"){popped=nested.shift()}if(len=nested.length){if(len>1){nested.unshift(this.makeToken("(","(",strOffset+i+1,0));nested.push(this.makeToken(")",")",strOffset+i+1+inner.length,0))}tokens.push(["TOKENS",nested])}}i+=expr.length;pi=i+1}if(i>pi&&pi<str.length){tokens.push(this.makeToken("NEOSTRING",str.slice(pi),strOffset+pi))}if(regex){return tokens}if(!tokens.length){return this.token("STRING",'""',offsetInChunk,lexedLength)}if(tokens[0][0]!=="NEOSTRING"){tokens.unshift(this.makeToken("NEOSTRING","",offsetInChunk))}if(interpolated=tokens.length>1){this.token("(","(",offsetInChunk,0,errorToken)}for(i=_i=0,_len=tokens.length;_i<_len;i=++_i){token=tokens[i];tag=token[0],value=token[1];if(i){if(i){plusToken=this.token("+","+")}locationToken=tag==="TOKENS"?value[0]:token;plusToken[2]={first_line:locationToken[2].first_line,first_column:locationToken[2].first_column,last_line:locationToken[2].first_line,last_column:locationToken[2].first_column}}if(tag==="TOKENS"){(_ref4=this.tokens).push.apply(_ref4,value)}else if(tag==="NEOSTRING"){token[0]="STRING";token[1]=this.makeString(value,'"',heredoc);this.tokens.push(token)}else{this.error("Unexpected "+tag)}}if(interpolated){rparen=this.makeToken(")",")",offsetInChunk+lexedLength,0);rparen.stringEnd=true;this.tokens.push(rparen)}return tokens};Lexer.prototype.pair=function(tag){var wanted;if(tag!==(wanted=last(this.ends))){if("OUTDENT"!==wanted){this.error("unmatched "+tag)}this.outdentToken(last(this.indents),true);return this.pair(tag)}return this.ends.pop()};Lexer.prototype.getLineAndColumnFromChunk=function(offset){var column,lineCount,lines,string;if(offset===0){return[this.chunkLine,this.chunkColumn]}if(offset>=this.chunk.length){string=this.chunk}else{string=this.chunk.slice(0,+(offset-1)+1||9e9)}lineCount=count(string,"\n");column=this.chunkColumn;if(lineCount>0){lines=string.split("\n");column=last(lines).length}else{column+=string.length}return[this.chunkLine+lineCount,column]};Lexer.prototype.makeToken=function(tag,value,offsetInChunk,length){var lastCharacter,locationData,token,_ref2,_ref3;if(offsetInChunk==null){offsetInChunk=0}if(length==null){length=value.length}locationData={};_ref2=this.getLineAndColumnFromChunk(offsetInChunk),locationData.first_line=_ref2[0],locationData.first_column=_ref2[1];lastCharacter=Math.max(0,length-1);_ref3=this.getLineAndColumnFromChunk(offsetInChunk+lastCharacter),locationData.last_line=_ref3[0],locationData.last_column=_ref3[1];token=[tag,value,locationData];return token};Lexer.prototype.token=function(tag,value,offsetInChunk,length,origin){var token;token=this.makeToken(tag,value,offsetInChunk,length);if(origin){token.origin=origin}this.tokens.push(token);return token};Lexer.prototype.tag=function(index,tag){var tok;return(tok=last(this.tokens,index))&&(tag?tok[0]=tag:tok[0])};Lexer.prototype.value=function(index,val){var tok;return(tok=last(this.tokens,index))&&(val?tok[1]=val:tok[1])};Lexer.prototype.unfinished=function(){var _ref2;return LINE_CONTINUER.test(this.chunk)||((_ref2=this.tag())==="\\"||_ref2==="."||_ref2==="?."||_ref2==="?::"||_ref2==="UNARY"||_ref2==="MATH"||_ref2==="UNARY_MATH"||_ref2==="+"||_ref2==="-"||_ref2==="**"||_ref2==="SHIFT"||_ref2==="RELATION"||_ref2==="COMPARE"||_ref2==="LOGIC"||_ref2==="THROW"||_ref2==="EXTENDS")};Lexer.prototype.removeNewlines=function(str){return str.replace(/^\s*\n\s*/,"").replace(/([^\\]|\\\\)\s*\n\s*$/,"$1")};Lexer.prototype.escapeLines=function(str,heredoc){str=str.replace(/\\[^\S\n]*(\n|\\)\s*/g,function(escaped,character){if(character==="\n"){return""}else{return escaped}});if(heredoc){return str.replace(MULTILINER,"\\n")}else{return str.replace(/\s*\n\s*/g," ")}};Lexer.prototype.makeString=function(body,quote,heredoc){if(!body){return quote+quote}body=body.replace(RegExp("\\\\("+quote+"|\\\\)","g"),function(match,contents){if(contents===quote){return contents}else{return match}});body=body.replace(RegExp(""+quote,"g"),"\\$&");return quote+this.escapeLines(body,heredoc)+quote};Lexer.prototype.error=function(message,offset){var first_column,first_line,_ref2;if(offset==null){offset=0}_ref2=this.getLineAndColumnFromChunk(offset),first_line=_ref2[0],first_column=_ref2[1];return throwSyntaxError(message,{first_line:first_line,first_column:first_column})};return Lexer}();JS_KEYWORDS=["true","false","null","this","new","delete","typeof","in","instanceof","return","throw","break","continue","debugger","if","else","switch","for","while","do","try","catch","finally","class","extends","super"];COFFEE_KEYWORDS=["undefined","then","unless","until","loop","of","by","when"];COFFEE_ALIAS_MAP={and:"&&",or:"||",is:"==",isnt:"!=",not:"!",yes:"true",no:"false",on:"true",off:"false"};COFFEE_ALIASES=function(){var _results;_results=[];for(key in COFFEE_ALIAS_MAP){_results.push(key)}return _results}();COFFEE_KEYWORDS=COFFEE_KEYWORDS.concat(COFFEE_ALIASES);RESERVED=["case","default","function","var","void","with","const","let","enum","export","import","native","__hasProp","__extends","__slice","__bind","__indexOf","implements","interface","package","private","protected","public","static","yield"];STRICT_PROSCRIBED=["arguments","eval"];JS_FORBIDDEN=JS_KEYWORDS.concat(RESERVED).concat(STRICT_PROSCRIBED);exports.RESERVED=RESERVED.concat(JS_KEYWORDS).concat(COFFEE_KEYWORDS).concat(STRICT_PROSCRIBED);exports.STRICT_PROSCRIBED=STRICT_PROSCRIBED;BOM=65279;IDENTIFIER=/^([$A-Za-z_\x7f-\uffff][$\w\x7f-\uffff]*)([^\n\S]*:(?!:))?/;NUMBER=/^0b[01]+|^0o[0-7]+|^0x[\da-f]+|^\d*\.?\d+(?:e[+-]?\d+)?/i;HEREDOC=/^("""|''')((?:\\[\s\S]|[^\\])*?)(?:\n[^\n\S]*)?\1/;OPERATOR=/^(?:[-=]>|[-+*\/%<>&|^!?=]=|>>>=?|([-+:])\1|([&|<>*\/%])\2=?|\?(\.|::)|\.{2,3})/;WHITESPACE=/^[^\n\S]+/;COMMENT=/^###([^#][\s\S]*?)(?:###[^\n\S]*|###$)|^(?:\s*#(?!##[^#]).*)+/;CODE=/^[-=]>/;MULTI_DENT=/^(?:\n[^\n\S]*)+/;SIMPLESTR=/^'[^\\']*(?:\\[\s\S][^\\']*)*'/;JSTOKEN=/^`[^\\`]*(?:\\.[^\\`]*)*`/;REGEX=/^(\/(?![\s=])[^[\/\n\\]*(?:(?:\\[\s\S]|\[[^\]\n\\]*(?:\\[\s\S][^\]\n\\]*)*])[^[\/\n\\]*)*\/)([imgy]{0,4})(?!\w)/;HEREGEX=/^\/{3}((?:\\?[\s\S])+?)\/{3}([imgy]{0,4})(?!\w)/;HEREGEX_OMIT=/((?:\\\\)+)|\\(\s|\/)|\s+(?:#.*)?/g;MULTILINER=/\n/g;HEREDOC_INDENT=/\n+([^\n\S]*)/g;HEREDOC_ILLEGAL=/\*\//;LINE_CONTINUER=/^\s*(?:,|\??\.(?![.\d])|::)/;TRAILING_SPACES=/\s+$/;COMPOUND_ASSIGN=["-=","+=","/=","*=","%=","||=","&&=","?=","<<=",">>=",">>>=","&=","^=","|=","**=","//=","%%="];UNARY=["NEW","TYPEOF","DELETE","DO"];UNARY_MATH=["!","~"];LOGIC=["&&","||","&","|","^"];SHIFT=["<<",">>",">>>"];COMPARE=["==","!=","<",">","<=",">="];MATH=["*","/","%","//","%%"];RELATION=["IN","OF","INSTANCEOF"];BOOL=["TRUE","FALSE"];NOT_REGEX=["NUMBER","REGEX","BOOL","NULL","UNDEFINED","++","--"];NOT_SPACED_REGEX=NOT_REGEX.concat(")","}","THIS","IDENTIFIER","STRING","]");CALLABLE=["IDENTIFIER","STRING","REGEX",")","]","}","?","::","@","THIS","SUPER"];INDEXABLE=CALLABLE.concat("NUMBER","BOOL","NULL","UNDEFINED");LINE_BREAK=["INDENT","OUTDENT","TERMINATOR"];INDENTABLE_CLOSERS=[")","}","]"]}).call(this)},{"./helpers":117,"./rewriter":122}],119:[function(require,module,exports){(function(){var Access,Arr,Assign,Base,Block,Call,Class,Code,CodeFragment,Comment,Existence,Expansion,Extends,For,HEXNUM,IDENTIFIER,IDENTIFIER_STR,IS_REGEX,IS_STRING,If,In,Index,LEVEL_ACCESS,LEVEL_COND,LEVEL_LIST,LEVEL_OP,LEVEL_PAREN,LEVEL_TOP,Literal,METHOD_DEF,NEGATE,NO,NUMBER,Obj,Op,Param,Parens,RESERVED,Range,Return,SIMPLENUM,STRICT_PROSCRIBED,Scope,Slice,Splat,Switch,TAB,THIS,Throw,Try,UTILITIES,Value,While,YES,addLocationDataFn,compact,del,ends,extend,flatten,fragmentsToText,isLiteralArguments,isLiteralThis,last,locationDataToString,merge,multident,parseNum,some,starts,throwSyntaxError,unfoldSoak,utility,_ref,_ref1,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]
}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1},__slice=[].slice;Error.stackTraceLimit=Infinity;Scope=require("./scope").Scope;_ref=require("./lexer"),RESERVED=_ref.RESERVED,STRICT_PROSCRIBED=_ref.STRICT_PROSCRIBED;_ref1=require("./helpers"),compact=_ref1.compact,flatten=_ref1.flatten,extend=_ref1.extend,merge=_ref1.merge,del=_ref1.del,starts=_ref1.starts,ends=_ref1.ends,last=_ref1.last,some=_ref1.some,addLocationDataFn=_ref1.addLocationDataFn,locationDataToString=_ref1.locationDataToString,throwSyntaxError=_ref1.throwSyntaxError;exports.extend=extend;exports.addLocationDataFn=addLocationDataFn;YES=function(){return true};NO=function(){return false};THIS=function(){return this};NEGATE=function(){this.negated=!this.negated;return this};exports.CodeFragment=CodeFragment=function(){function CodeFragment(parent,code){var _ref2;this.code=""+code;this.locationData=parent!=null?parent.locationData:void 0;this.type=(parent!=null?(_ref2=parent.constructor)!=null?_ref2.name:void 0:void 0)||"unknown"}CodeFragment.prototype.toString=function(){return""+this.code+(this.locationData?": "+locationDataToString(this.locationData):"")};return CodeFragment}();fragmentsToText=function(fragments){var fragment;return function(){var _i,_len,_results;_results=[];for(_i=0,_len=fragments.length;_i<_len;_i++){fragment=fragments[_i];_results.push(fragment.code)}return _results}().join("")};exports.Base=Base=function(){function Base(){}Base.prototype.compile=function(o,lvl){return fragmentsToText(this.compileToFragments(o,lvl))};Base.prototype.compileToFragments=function(o,lvl){var node;o=extend({},o);if(lvl){o.level=lvl}node=this.unfoldSoak(o)||this;node.tab=o.indent;if(o.level===LEVEL_TOP||!node.isStatement(o)){return node.compileNode(o)}else{return node.compileClosure(o)}};Base.prototype.compileClosure=function(o){var args,argumentsNode,func,jumpNode,meth;if(jumpNode=this.jumps()){jumpNode.error("cannot use a pure statement in an expression")}o.sharedScope=true;func=new Code([],Block.wrap([this]));args=[];if((argumentsNode=this.contains(isLiteralArguments))||this.contains(isLiteralThis)){args=[new Literal("this")];if(argumentsNode){meth="apply";args.push(new Literal("arguments"))}else{meth="call"}func=new Value(func,[new Access(new Literal(meth))])}return new Call(func,args).compileNode(o)};Base.prototype.cache=function(o,level,reused){var ref,sub;if(!this.isComplex()){ref=level?this.compileToFragments(o,level):this;return[ref,ref]}else{ref=new Literal(reused||o.scope.freeVariable("ref"));sub=new Assign(ref,this);if(level){return[sub.compileToFragments(o,level),[this.makeCode(ref.value)]]}else{return[sub,ref]}}};Base.prototype.cacheToCodeFragments=function(cacheValues){return[fragmentsToText(cacheValues[0]),fragmentsToText(cacheValues[1])]};Base.prototype.makeReturn=function(res){var me;me=this.unwrapAll();if(res){return new Call(new Literal(""+res+".push"),[me])}else{return new Return(me)}};Base.prototype.contains=function(pred){var node;node=void 0;this.traverseChildren(false,function(n){if(pred(n)){node=n;return false}});return node};Base.prototype.lastNonComment=function(list){var i;i=list.length;while(i--){if(!(list[i]instanceof Comment)){return list[i]}}return null};Base.prototype.toString=function(idt,name){var tree;if(idt==null){idt=""}if(name==null){name=this.constructor.name}tree="\n"+idt+name;if(this.soak){tree+="?"}this.eachChild(function(node){return tree+=node.toString(idt+TAB)});return tree};Base.prototype.eachChild=function(func){var attr,child,_i,_j,_len,_len1,_ref2,_ref3;if(!this.children){return this}_ref2=this.children;for(_i=0,_len=_ref2.length;_i<_len;_i++){attr=_ref2[_i];if(this[attr]){_ref3=flatten([this[attr]]);for(_j=0,_len1=_ref3.length;_j<_len1;_j++){child=_ref3[_j];if(func(child)===false){return this}}}}return this};Base.prototype.traverseChildren=function(crossScope,func){return this.eachChild(function(child){var recur;recur=func(child);if(recur!==false){return child.traverseChildren(crossScope,func)}})};Base.prototype.invert=function(){return new Op("!",this)};Base.prototype.unwrapAll=function(){var node;node=this;while(node!==(node=node.unwrap())){continue}return node};Base.prototype.children=[];Base.prototype.isStatement=NO;Base.prototype.jumps=NO;Base.prototype.isComplex=YES;Base.prototype.isChainable=NO;Base.prototype.isAssignable=NO;Base.prototype.unwrap=THIS;Base.prototype.unfoldSoak=NO;Base.prototype.assigns=NO;Base.prototype.updateLocationDataIfMissing=function(locationData){if(this.locationData){return this}this.locationData=locationData;return this.eachChild(function(child){return child.updateLocationDataIfMissing(locationData)})};Base.prototype.error=function(message){return throwSyntaxError(message,this.locationData)};Base.prototype.makeCode=function(code){return new CodeFragment(this,code)};Base.prototype.wrapInBraces=function(fragments){return[].concat(this.makeCode("("),fragments,this.makeCode(")"))};Base.prototype.joinFragmentArrays=function(fragmentsList,joinStr){var answer,fragments,i,_i,_len;answer=[];for(i=_i=0,_len=fragmentsList.length;_i<_len;i=++_i){fragments=fragmentsList[i];if(i){answer.push(this.makeCode(joinStr))}answer=answer.concat(fragments)}return answer};return Base}();exports.Block=Block=function(_super){__extends(Block,_super);function Block(nodes){this.expressions=compact(flatten(nodes||[]))}Block.prototype.children=["expressions"];Block.prototype.push=function(node){this.expressions.push(node);return this};Block.prototype.pop=function(){return this.expressions.pop()};Block.prototype.unshift=function(node){this.expressions.unshift(node);return this};Block.prototype.unwrap=function(){if(this.expressions.length===1){return this.expressions[0]}else{return this}};Block.prototype.isEmpty=function(){return!this.expressions.length};Block.prototype.isStatement=function(o){var exp,_i,_len,_ref2;_ref2=this.expressions;for(_i=0,_len=_ref2.length;_i<_len;_i++){exp=_ref2[_i];if(exp.isStatement(o)){return true}}return false};Block.prototype.jumps=function(o){var exp,jumpNode,_i,_len,_ref2;_ref2=this.expressions;for(_i=0,_len=_ref2.length;_i<_len;_i++){exp=_ref2[_i];if(jumpNode=exp.jumps(o)){return jumpNode}}};Block.prototype.makeReturn=function(res){var expr,len;len=this.expressions.length;while(len--){expr=this.expressions[len];if(!(expr instanceof Comment)){this.expressions[len]=expr.makeReturn(res);if(expr instanceof Return&&!expr.expression){this.expressions.splice(len,1)}break}}return this};Block.prototype.compileToFragments=function(o,level){if(o==null){o={}}if(o.scope){return Block.__super__.compileToFragments.call(this,o,level)}else{return this.compileRoot(o)}};Block.prototype.compileNode=function(o){var answer,compiledNodes,fragments,index,node,top,_i,_len,_ref2;this.tab=o.indent;top=o.level===LEVEL_TOP;compiledNodes=[];_ref2=this.expressions;for(index=_i=0,_len=_ref2.length;_i<_len;index=++_i){node=_ref2[index];node=node.unwrapAll();node=node.unfoldSoak(o)||node;if(node instanceof Block){compiledNodes.push(node.compileNode(o))}else if(top){node.front=true;fragments=node.compileToFragments(o);if(!node.isStatement(o)){fragments.unshift(this.makeCode(""+this.tab));fragments.push(this.makeCode(";"))}compiledNodes.push(fragments)}else{compiledNodes.push(node.compileToFragments(o,LEVEL_LIST))}}if(top){if(this.spaced){return[].concat(this.joinFragmentArrays(compiledNodes,"\n\n"),this.makeCode("\n"))}else{return this.joinFragmentArrays(compiledNodes,"\n")}}if(compiledNodes.length){answer=this.joinFragmentArrays(compiledNodes,", ")}else{answer=[this.makeCode("void 0")]}if(compiledNodes.length>1&&o.level>=LEVEL_LIST){return this.wrapInBraces(answer)}else{return answer}};Block.prototype.compileRoot=function(o){var exp,fragments,i,name,prelude,preludeExps,rest,_i,_len,_ref2;o.indent=o.bare?"":TAB;o.level=LEVEL_TOP;this.spaced=true;o.scope=new Scope(null,this,null);_ref2=o.locals||[];for(_i=0,_len=_ref2.length;_i<_len;_i++){name=_ref2[_i];o.scope.parameter(name)}prelude=[];if(!o.bare){preludeExps=function(){var _j,_len1,_ref3,_results;_ref3=this.expressions;_results=[];for(i=_j=0,_len1=_ref3.length;_j<_len1;i=++_j){exp=_ref3[i];if(!(exp.unwrap()instanceof Comment)){break}_results.push(exp)}return _results}.call(this);rest=this.expressions.slice(preludeExps.length);this.expressions=preludeExps;if(preludeExps.length){prelude=this.compileNode(merge(o,{indent:""}));prelude.push(this.makeCode("\n"))}this.expressions=rest}fragments=this.compileWithDeclarations(o);if(o.bare){return fragments}return[].concat(prelude,this.makeCode("(function() {\n"),fragments,this.makeCode("\n}).call(this);\n"))};Block.prototype.compileWithDeclarations=function(o){var assigns,declars,exp,fragments,i,post,rest,scope,spaced,_i,_len,_ref2,_ref3,_ref4;fragments=[];post=[];_ref2=this.expressions;for(i=_i=0,_len=_ref2.length;_i<_len;i=++_i){exp=_ref2[i];exp=exp.unwrap();if(!(exp instanceof Comment||exp instanceof Literal)){break}}o=merge(o,{level:LEVEL_TOP});if(i){rest=this.expressions.splice(i,9e9);_ref3=[this.spaced,false],spaced=_ref3[0],this.spaced=_ref3[1];_ref4=[this.compileNode(o),spaced],fragments=_ref4[0],this.spaced=_ref4[1];this.expressions=rest}post=this.compileNode(o);scope=o.scope;if(scope.expressions===this){declars=o.scope.hasDeclarations();assigns=scope.hasAssignments;if(declars||assigns){if(i){fragments.push(this.makeCode("\n"))}fragments.push(this.makeCode(""+this.tab+"var "));if(declars){fragments.push(this.makeCode(scope.declaredVariables().join(", ")))}if(assigns){if(declars){fragments.push(this.makeCode(",\n"+(this.tab+TAB)))}fragments.push(this.makeCode(scope.assignedVariables().join(",\n"+(this.tab+TAB))))}fragments.push(this.makeCode(";\n"+(this.spaced?"\n":"")))}else if(fragments.length&&post.length){fragments.push(this.makeCode("\n"))}}return fragments.concat(post)};Block.wrap=function(nodes){if(nodes.length===1&&nodes[0]instanceof Block){return nodes[0]}return new Block(nodes)};return Block}(Base);exports.Literal=Literal=function(_super){__extends(Literal,_super);function Literal(value){this.value=value}Literal.prototype.makeReturn=function(){if(this.isStatement()){return this}else{return Literal.__super__.makeReturn.apply(this,arguments)}};Literal.prototype.isAssignable=function(){return IDENTIFIER.test(this.value)};Literal.prototype.isStatement=function(){var _ref2;return(_ref2=this.value)==="break"||_ref2==="continue"||_ref2==="debugger"};Literal.prototype.isComplex=NO;Literal.prototype.assigns=function(name){return name===this.value};Literal.prototype.jumps=function(o){if(this.value==="break"&&!((o!=null?o.loop:void 0)||(o!=null?o.block:void 0))){return this}if(this.value==="continue"&&!(o!=null?o.loop:void 0)){return this}};Literal.prototype.compileNode=function(o){var answer,code,_ref2;code=this.value==="this"?((_ref2=o.scope.method)!=null?_ref2.bound:void 0)?o.scope.method.context:this.value:this.value.reserved?'"'+this.value+'"':this.value;answer=this.isStatement()?""+this.tab+code+";":code;return[this.makeCode(answer)]};Literal.prototype.toString=function(){return' "'+this.value+'"'};return Literal}(Base);exports.Undefined=function(_super){__extends(Undefined,_super);function Undefined(){return Undefined.__super__.constructor.apply(this,arguments)}Undefined.prototype.isAssignable=NO;Undefined.prototype.isComplex=NO;Undefined.prototype.compileNode=function(o){return[this.makeCode(o.level>=LEVEL_ACCESS?"(void 0)":"void 0")]};return Undefined}(Base);exports.Null=function(_super){__extends(Null,_super);function Null(){return Null.__super__.constructor.apply(this,arguments)}Null.prototype.isAssignable=NO;Null.prototype.isComplex=NO;Null.prototype.compileNode=function(){return[this.makeCode("null")]};return Null}(Base);exports.Bool=function(_super){__extends(Bool,_super);Bool.prototype.isAssignable=NO;Bool.prototype.isComplex=NO;Bool.prototype.compileNode=function(){return[this.makeCode(this.val)]};function Bool(val){this.val=val}return Bool}(Base);exports.Return=Return=function(_super){__extends(Return,_super);function Return(expr){if(expr&&!expr.unwrap().isUndefined){this.expression=expr}}Return.prototype.children=["expression"];Return.prototype.isStatement=YES;Return.prototype.makeReturn=THIS;Return.prototype.jumps=THIS;Return.prototype.compileToFragments=function(o,level){var expr,_ref2;expr=(_ref2=this.expression)!=null?_ref2.makeReturn():void 0;if(expr&&!(expr instanceof Return)){return expr.compileToFragments(o,level)}else{return Return.__super__.compileToFragments.call(this,o,level)}};Return.prototype.compileNode=function(o){var answer;answer=[];answer.push(this.makeCode(this.tab+("return"+(this.expression?" ":""))));if(this.expression){answer=answer.concat(this.expression.compileToFragments(o,LEVEL_PAREN))}answer.push(this.makeCode(";"));return answer};return Return}(Base);exports.Value=Value=function(_super){__extends(Value,_super);function Value(base,props,tag){if(!props&&base instanceof Value){return base}this.base=base;this.properties=props||[];if(tag){this[tag]=true}return this}Value.prototype.children=["base","properties"];Value.prototype.add=function(props){this.properties=this.properties.concat(props);return this};Value.prototype.hasProperties=function(){return!!this.properties.length};Value.prototype.bareLiteral=function(type){return!this.properties.length&&this.base instanceof type};Value.prototype.isArray=function(){return this.bareLiteral(Arr)};Value.prototype.isRange=function(){return this.bareLiteral(Range)};Value.prototype.isComplex=function(){return this.hasProperties()||this.base.isComplex()};Value.prototype.isAssignable=function(){return this.hasProperties()||this.base.isAssignable()};Value.prototype.isSimpleNumber=function(){return this.bareLiteral(Literal)&&SIMPLENUM.test(this.base.value)};Value.prototype.isString=function(){return this.bareLiteral(Literal)&&IS_STRING.test(this.base.value)};Value.prototype.isRegex=function(){return this.bareLiteral(Literal)&&IS_REGEX.test(this.base.value)};Value.prototype.isAtomic=function(){var node,_i,_len,_ref2;_ref2=this.properties.concat(this.base);for(_i=0,_len=_ref2.length;_i<_len;_i++){node=_ref2[_i];if(node.soak||node instanceof Call){return false}}return true};Value.prototype.isNotCallable=function(){return this.isSimpleNumber()||this.isString()||this.isRegex()||this.isArray()||this.isRange()||this.isSplice()||this.isObject()};Value.prototype.isStatement=function(o){return!this.properties.length&&this.base.isStatement(o)};Value.prototype.assigns=function(name){return!this.properties.length&&this.base.assigns(name)};Value.prototype.jumps=function(o){return!this.properties.length&&this.base.jumps(o)};Value.prototype.isObject=function(onlyGenerated){if(this.properties.length){return false}return this.base instanceof Obj&&(!onlyGenerated||this.base.generated)};Value.prototype.isSplice=function(){return last(this.properties)instanceof Slice};Value.prototype.looksStatic=function(className){var _ref2;return this.base.value===className&&this.properties.length&&((_ref2=this.properties[0].name)!=null?_ref2.value:void 0)!=="prototype"};Value.prototype.unwrap=function(){if(this.properties.length){return this}else{return this.base}};Value.prototype.cacheReference=function(o){var base,bref,name,nref;name=last(this.properties);if(this.properties.length<2&&!this.base.isComplex()&&!(name!=null?name.isComplex():void 0)){return[this,this]}base=new Value(this.base,this.properties.slice(0,-1));if(base.isComplex()){bref=new Literal(o.scope.freeVariable("base"));base=new Value(new Parens(new Assign(bref,base)))}if(!name){return[base,bref]}if(name.isComplex()){nref=new Literal(o.scope.freeVariable("name"));name=new Index(new Assign(nref,name.index));nref=new Index(nref)}return[base.add(name),new Value(bref||base.base,[nref||name])]};Value.prototype.compileNode=function(o){var fragments,prop,props,_i,_len;this.base.front=this.front;props=this.properties;fragments=this.base.compileToFragments(o,props.length?LEVEL_ACCESS:null);if((this.base instanceof Parens||props.length)&&SIMPLENUM.test(fragmentsToText(fragments))){fragments.push(this.makeCode("."))}for(_i=0,_len=props.length;_i<_len;_i++){prop=props[_i];fragments.push.apply(fragments,prop.compileToFragments(o))}return fragments};Value.prototype.unfoldSoak=function(o){return this.unfoldedSoak!=null?this.unfoldedSoak:this.unfoldedSoak=function(_this){return function(){var fst,i,ifn,prop,ref,snd,_i,_len,_ref2,_ref3;if(ifn=_this.base.unfoldSoak(o)){(_ref2=ifn.body.properties).push.apply(_ref2,_this.properties);return ifn}_ref3=_this.properties;for(i=_i=0,_len=_ref3.length;_i<_len;i=++_i){prop=_ref3[i];if(!prop.soak){continue}prop.soak=false;fst=new Value(_this.base,_this.properties.slice(0,i));snd=new Value(_this.base,_this.properties.slice(i));if(fst.isComplex()){ref=new Literal(o.scope.freeVariable("ref"));fst=new Parens(new Assign(ref,fst));snd.base=ref}return new If(new Existence(fst),snd,{soak:true})}return false}}(this)()};return Value}(Base);exports.Comment=Comment=function(_super){__extends(Comment,_super);function Comment(comment){this.comment=comment}Comment.prototype.isStatement=YES;Comment.prototype.makeReturn=THIS;Comment.prototype.compileNode=function(o,level){var code,comment;comment=this.comment.replace(/^(\s*)#/gm,"$1 *");code="/*"+multident(comment,this.tab)+(__indexOf.call(comment,"\n")>=0?"\n"+this.tab:"")+" */";if((level||o.level)===LEVEL_TOP){code=o.indent+code}return[this.makeCode("\n"),this.makeCode(code)]};return Comment}(Base);exports.Call=Call=function(_super){__extends(Call,_super);function Call(variable,args,soak){this.args=args!=null?args:[];this.soak=soak;this.isNew=false;this.isSuper=variable==="super";this.variable=this.isSuper?null:variable;if(variable instanceof Value&&variable.isNotCallable()){variable.error("literal is not a function")}}Call.prototype.children=["variable","args"];Call.prototype.newInstance=function(){var base,_ref2;base=((_ref2=this.variable)!=null?_ref2.base:void 0)||this.variable;if(base instanceof Call&&!base.isNew){base.newInstance()}else{this.isNew=true}return this};Call.prototype.superReference=function(o){var accesses,method;method=o.scope.namedMethod();if(method!=null?method.klass:void 0){accesses=[new Access(new Literal("__super__"))];if(method["static"]){accesses.push(new Access(new Literal("constructor")))}accesses.push(new Access(new Literal(method.name)));return new Value(new Literal(method.klass),accesses).compile(o)}else if(method!=null?method.ctor:void 0){return""+method.name+".__super__.constructor"}else{return this.error("cannot call super outside of an instance method.")}};Call.prototype.superThis=function(o){var method;method=o.scope.method;return method&&!method.klass&&method.context||"this"};Call.prototype.unfoldSoak=function(o){var call,ifn,left,list,rite,_i,_len,_ref2,_ref3;if(this.soak){if(this.variable){if(ifn=unfoldSoak(o,this,"variable")){return ifn}_ref2=new Value(this.variable).cacheReference(o),left=_ref2[0],rite=_ref2[1]}else{left=new Literal(this.superReference(o));rite=new Value(left)}rite=new Call(rite,this.args);rite.isNew=this.isNew;left=new Literal("typeof "+left.compile(o)+' === "function"');return new If(left,new Value(rite),{soak:true})}call=this;list=[];while(true){if(call.variable instanceof Call){list.push(call);call=call.variable;continue}if(!(call.variable instanceof Value)){break}list.push(call);if(!((call=call.variable.base)instanceof Call)){break}}_ref3=list.reverse();for(_i=0,_len=_ref3.length;_i<_len;_i++){call=_ref3[_i];if(ifn){if(call.variable instanceof Call){call.variable=ifn}else{call.variable.base=ifn}}ifn=unfoldSoak(o,call,"variable")}return ifn};Call.prototype.compileNode=function(o){var arg,argIndex,compiledArgs,compiledArray,fragments,preface,_i,_len,_ref2,_ref3;if((_ref2=this.variable)!=null){_ref2.front=this.front}compiledArray=Splat.compileSplattedArray(o,this.args,true);if(compiledArray.length){return this.compileSplat(o,compiledArray)}compiledArgs=[];_ref3=this.args;for(argIndex=_i=0,_len=_ref3.length;_i<_len;argIndex=++_i){arg=_ref3[argIndex];if(argIndex){compiledArgs.push(this.makeCode(", "))}compiledArgs.push.apply(compiledArgs,arg.compileToFragments(o,LEVEL_LIST))}fragments=[];if(this.isSuper){preface=this.superReference(o)+(".call("+this.superThis(o));if(compiledArgs.length){preface+=", "}fragments.push(this.makeCode(preface))}else{if(this.isNew){fragments.push(this.makeCode("new "))}fragments.push.apply(fragments,this.variable.compileToFragments(o,LEVEL_ACCESS));fragments.push(this.makeCode("("))}fragments.push.apply(fragments,compiledArgs);fragments.push(this.makeCode(")"));return fragments};Call.prototype.compileSplat=function(o,splatArgs){var answer,base,fun,idt,name,ref;if(this.isSuper){return[].concat(this.makeCode(""+this.superReference(o)+".apply("+this.superThis(o)+", "),splatArgs,this.makeCode(")"))}if(this.isNew){idt=this.tab+TAB;return[].concat(this.makeCode("(function(func, args, ctor) {\n"+idt+"ctor.prototype = func.prototype;\n"+idt+"var child = new ctor, result = func.apply(child, args);\n"+idt+"return Object(result) === result ? result : child;\n"+this.tab+"})("),this.variable.compileToFragments(o,LEVEL_LIST),this.makeCode(", "),splatArgs,this.makeCode(", function(){})"))}answer=[];base=new Value(this.variable);if((name=base.properties.pop())&&base.isComplex()){ref=o.scope.freeVariable("ref");answer=answer.concat(this.makeCode("("+ref+" = "),base.compileToFragments(o,LEVEL_LIST),this.makeCode(")"),name.compileToFragments(o))}else{fun=base.compileToFragments(o,LEVEL_ACCESS);if(SIMPLENUM.test(fragmentsToText(fun))){fun=this.wrapInBraces(fun)}if(name){ref=fragmentsToText(fun);fun.push.apply(fun,name.compileToFragments(o))}else{ref="null"}answer=answer.concat(fun)}return answer=answer.concat(this.makeCode(".apply("+ref+", "),splatArgs,this.makeCode(")"))};return Call}(Base);exports.Extends=Extends=function(_super){__extends(Extends,_super);function Extends(child,parent){this.child=child;this.parent=parent}Extends.prototype.children=["child","parent"];Extends.prototype.compileToFragments=function(o){return new Call(new Value(new Literal(utility("extends"))),[this.child,this.parent]).compileToFragments(o)};return Extends}(Base);exports.Access=Access=function(_super){__extends(Access,_super);function Access(name,tag){this.name=name;this.name.asKey=true;this.soak=tag==="soak"}Access.prototype.children=["name"];Access.prototype.compileToFragments=function(o){var name;name=this.name.compileToFragments(o);if(IDENTIFIER.test(fragmentsToText(name))){name.unshift(this.makeCode("."))}else{name.unshift(this.makeCode("["));name.push(this.makeCode("]"))}return name};Access.prototype.isComplex=NO;return Access}(Base);exports.Index=Index=function(_super){__extends(Index,_super);function Index(index){this.index=index}Index.prototype.children=["index"];Index.prototype.compileToFragments=function(o){return[].concat(this.makeCode("["),this.index.compileToFragments(o,LEVEL_PAREN),this.makeCode("]"))};Index.prototype.isComplex=function(){return this.index.isComplex()};return Index}(Base);exports.Range=Range=function(_super){__extends(Range,_super);Range.prototype.children=["from","to"];function Range(from,to,tag){this.from=from;this.to=to;this.exclusive=tag==="exclusive";this.equals=this.exclusive?"":"="}Range.prototype.compileVariables=function(o){var step,_ref2,_ref3,_ref4,_ref5;o=merge(o,{top:true});_ref2=this.cacheToCodeFragments(this.from.cache(o,LEVEL_LIST)),this.fromC=_ref2[0],this.fromVar=_ref2[1];_ref3=this.cacheToCodeFragments(this.to.cache(o,LEVEL_LIST)),this.toC=_ref3[0],this.toVar=_ref3[1];if(step=del(o,"step")){_ref4=this.cacheToCodeFragments(step.cache(o,LEVEL_LIST)),this.step=_ref4[0],this.stepVar=_ref4[1]}_ref5=[this.fromVar.match(NUMBER),this.toVar.match(NUMBER)],this.fromNum=_ref5[0],this.toNum=_ref5[1];if(this.stepVar){return this.stepNum=this.stepVar.match(NUMBER)}};Range.prototype.compileNode=function(o){var cond,condPart,from,gt,idx,idxName,known,lt,namedIndex,stepPart,to,varPart,_ref2,_ref3;if(!this.fromVar){this.compileVariables(o)}if(!o.index){return this.compileArray(o)}known=this.fromNum&&this.toNum;idx=del(o,"index");idxName=del(o,"name");namedIndex=idxName&&idxName!==idx;varPart=""+idx+" = "+this.fromC;if(this.toC!==this.toVar){varPart+=", "+this.toC}if(this.step!==this.stepVar){varPart+=", "+this.step}_ref2=[""+idx+" <"+this.equals,""+idx+" >"+this.equals],lt=_ref2[0],gt=_ref2[1];condPart=this.stepNum?parseNum(this.stepNum[0])>0?""+lt+" "+this.toVar:""+gt+" "+this.toVar:known?(_ref3=[parseNum(this.fromNum[0]),parseNum(this.toNum[0])],from=_ref3[0],to=_ref3[1],_ref3,from<=to?""+lt+" "+to:""+gt+" "+to):(cond=this.stepVar?""+this.stepVar+" > 0":""+this.fromVar+" <= "+this.toVar,""+cond+" ? "+lt+" "+this.toVar+" : "+gt+" "+this.toVar);stepPart=this.stepVar?""+idx+" += "+this.stepVar:known?namedIndex?from<=to?"++"+idx:"--"+idx:from<=to?""+idx+"++":""+idx+"--":namedIndex?""+cond+" ? ++"+idx+" : --"+idx:""+cond+" ? "+idx+"++ : "+idx+"--";if(namedIndex){varPart=""+idxName+" = "+varPart}if(namedIndex){stepPart=""+idxName+" = "+stepPart}return[this.makeCode(""+varPart+"; "+condPart+"; "+stepPart)]};Range.prototype.compileArray=function(o){var args,body,cond,hasArgs,i,idt,post,pre,range,result,vars,_i,_ref2,_ref3,_results;if(this.fromNum&&this.toNum&&Math.abs(this.fromNum-this.toNum)<=20){range=function(){_results=[];for(var _i=_ref2=+this.fromNum,_ref3=+this.toNum;_ref2<=_ref3?_i<=_ref3:_i>=_ref3;_ref2<=_ref3?_i++:_i--){_results.push(_i)}return _results}.apply(this);if(this.exclusive){range.pop()}return[this.makeCode("["+range.join(", ")+"]")]}idt=this.tab+TAB;i=o.scope.freeVariable("i");result=o.scope.freeVariable("results");pre="\n"+idt+result+" = [];";if(this.fromNum&&this.toNum){o.index=i;body=fragmentsToText(this.compileNode(o))}else{vars=""+i+" = "+this.fromC+(this.toC!==this.toVar?", "+this.toC:"");cond=""+this.fromVar+" <= "+this.toVar;body="var "+vars+"; "+cond+" ? "+i+" <"+this.equals+" "+this.toVar+" : "+i+" >"+this.equals+" "+this.toVar+"; "+cond+" ? "+i+"++ : "+i+"--"}post="{ "+result+".push("+i+"); }\n"+idt+"return "+result+";\n"+o.indent;hasArgs=function(node){return node!=null?node.contains(isLiteralArguments):void 0};if(hasArgs(this.from)||hasArgs(this.to)){args=", arguments"}return[this.makeCode("(function() {"+pre+"\n"+idt+"for ("+body+")"+post+"}).apply(this"+(args!=null?args:"")+")")]};return Range}(Base);exports.Slice=Slice=function(_super){__extends(Slice,_super);Slice.prototype.children=["range"];function Slice(range){this.range=range;Slice.__super__.constructor.call(this)}Slice.prototype.compileNode=function(o){var compiled,compiledText,from,fromCompiled,to,toStr,_ref2;_ref2=this.range,to=_ref2.to,from=_ref2.from;fromCompiled=from&&from.compileToFragments(o,LEVEL_PAREN)||[this.makeCode("0")];if(to){compiled=to.compileToFragments(o,LEVEL_PAREN);compiledText=fragmentsToText(compiled);if(!(!this.range.exclusive&&+compiledText===-1)){toStr=", "+(this.range.exclusive?compiledText:SIMPLENUM.test(compiledText)?""+(+compiledText+1):(compiled=to.compileToFragments(o,LEVEL_ACCESS),"+"+fragmentsToText(compiled)+" + 1 || 9e9"))}}return[this.makeCode(".slice("+fragmentsToText(fromCompiled)+(toStr||"")+")")]};return Slice}(Base);exports.Obj=Obj=function(_super){__extends(Obj,_super);function Obj(props,generated){this.generated=generated!=null?generated:false;this.objects=this.properties=props||[]}Obj.prototype.children=["properties"];Obj.prototype.compileNode=function(o){var answer,i,idt,indent,join,lastNoncom,node,prop,props,_i,_j,_len,_len1;props=this.properties;if(!props.length){return[this.makeCode(this.front?"({})":"{}")]}if(this.generated){for(_i=0,_len=props.length;_i<_len;_i++){node=props[_i];if(node instanceof Value){node.error("cannot have an implicit value in an implicit object")}}}idt=o.indent+=TAB;lastNoncom=this.lastNonComment(this.properties);answer=[];for(i=_j=0,_len1=props.length;_j<_len1;i=++_j){prop=props[i];join=i===props.length-1?"":prop===lastNoncom||prop instanceof Comment?"\n":",\n";indent=prop instanceof Comment?"":idt;if(prop instanceof Assign&&prop.variable instanceof Value&&prop.variable.hasProperties()){prop.variable.error("Invalid object key")}if(prop instanceof Value&&prop["this"]){prop=new Assign(prop.properties[0].name,prop,"object")}if(!(prop instanceof Comment)){if(!(prop instanceof Assign)){prop=new Assign(prop,prop,"object")}(prop.variable.base||prop.variable).asKey=true}if(indent){answer.push(this.makeCode(indent))}answer.push.apply(answer,prop.compileToFragments(o,LEVEL_TOP));if(join){answer.push(this.makeCode(join))}}answer.unshift(this.makeCode("{"+(props.length&&"\n")));answer.push(this.makeCode(""+(props.length&&"\n"+this.tab)+"}"));if(this.front){return this.wrapInBraces(answer)}else{return answer}};Obj.prototype.assigns=function(name){var prop,_i,_len,_ref2;_ref2=this.properties;for(_i=0,_len=_ref2.length;_i<_len;_i++){prop=_ref2[_i];if(prop.assigns(name)){return true}}return false};return Obj}(Base);exports.Arr=Arr=function(_super){__extends(Arr,_super);function Arr(objs){this.objects=objs||[]}Arr.prototype.children=["objects"];Arr.prototype.compileNode=function(o){var answer,compiledObjs,fragments,index,obj,_i,_len;if(!this.objects.length){return[this.makeCode("[]")]}o.indent+=TAB;answer=Splat.compileSplattedArray(o,this.objects);if(answer.length){return answer}answer=[];compiledObjs=function(){var _i,_len,_ref2,_results;_ref2=this.objects;_results=[];for(_i=0,_len=_ref2.length;_i<_len;_i++){obj=_ref2[_i];_results.push(obj.compileToFragments(o,LEVEL_LIST))}return _results}.call(this);for(index=_i=0,_len=compiledObjs.length;_i<_len;index=++_i){fragments=compiledObjs[index];if(index){answer.push(this.makeCode(", "))}answer.push.apply(answer,fragments)}if(fragmentsToText(answer).indexOf("\n")>=0){answer.unshift(this.makeCode("[\n"+o.indent));answer.push(this.makeCode("\n"+this.tab+"]"))}else{answer.unshift(this.makeCode("["));answer.push(this.makeCode("]"))}return answer};Arr.prototype.assigns=function(name){var obj,_i,_len,_ref2;_ref2=this.objects;for(_i=0,_len=_ref2.length;_i<_len;_i++){obj=_ref2[_i];if(obj.assigns(name)){return true}}return false};return Arr}(Base);exports.Class=Class=function(_super){__extends(Class,_super);function Class(variable,parent,body){this.variable=variable;this.parent=parent;this.body=body!=null?body:new Block;this.boundFuncs=[];this.body.classBody=true}Class.prototype.children=["variable","parent","body"];Class.prototype.determineName=function(){var decl,tail;if(!this.variable){return null}decl=(tail=last(this.variable.properties))?tail instanceof Access&&tail.name.value:this.variable.base.value;if(__indexOf.call(STRICT_PROSCRIBED,decl)>=0){this.variable.error("class variable name may not be "+decl)}return decl&&(decl=IDENTIFIER.test(decl)&&decl)};Class.prototype.setContext=function(name){return this.body.traverseChildren(false,function(node){if(node.classBody){return false}if(node instanceof Literal&&node.value==="this"){return node.value=name}else if(node instanceof Code){node.klass=name;if(node.bound){return node.context=name}}})};Class.prototype.addBoundFunctions=function(o){var bvar,lhs,_i,_len,_ref2;_ref2=this.boundFuncs;for(_i=0,_len=_ref2.length;_i<_len;_i++){bvar=_ref2[_i];lhs=new Value(new Literal("this"),[new Access(bvar)]).compile(o);this.ctor.body.unshift(new Literal(""+lhs+" = "+utility("bind")+"("+lhs+", this)"))}};Class.prototype.addProperties=function(node,name,o){var assign,base,exprs,func,props;props=node.base.properties.slice(0);exprs=function(){var _results;_results=[];while(assign=props.shift()){if(assign instanceof Assign){base=assign.variable.base;delete assign.context;func=assign.value;if(base.value==="constructor"){if(this.ctor){assign.error("cannot define more than one constructor in a class")}if(func.bound){assign.error("cannot define a constructor as a bound function")}if(func instanceof Code){assign=this.ctor=func
}else{this.externalCtor=o.classScope.freeVariable("class");assign=new Assign(new Literal(this.externalCtor),func)}}else{if(assign.variable["this"]){func["static"]=true}else{assign.variable=new Value(new Literal(name),[new Access(new Literal("prototype")),new Access(base)]);if(func instanceof Code&&func.bound){this.boundFuncs.push(base);func.bound=false}}}}_results.push(assign)}return _results}.call(this);return compact(exprs)};Class.prototype.walkBody=function(name,o){return this.traverseChildren(false,function(_this){return function(child){var cont,exps,i,node,_i,_len,_ref2;cont=true;if(child instanceof Class){return false}if(child instanceof Block){_ref2=exps=child.expressions;for(i=_i=0,_len=_ref2.length;_i<_len;i=++_i){node=_ref2[i];if(node instanceof Assign&&node.variable.looksStatic(name)){node.value["static"]=true}else if(node instanceof Value&&node.isObject(true)){cont=false;exps[i]=_this.addProperties(node,name,o)}}child.expressions=exps=flatten(exps)}return cont&&!(child instanceof Class)}}(this))};Class.prototype.hoistDirectivePrologue=function(){var expressions,index,node;index=0;expressions=this.body.expressions;while((node=expressions[index])&&node instanceof Comment||node instanceof Value&&node.isString()){++index}return this.directives=expressions.splice(0,index)};Class.prototype.ensureConstructor=function(name){if(!this.ctor){this.ctor=new Code;if(this.externalCtor){this.ctor.body.push(new Literal(""+this.externalCtor+".apply(this, arguments)"))}else if(this.parent){this.ctor.body.push(new Literal(""+name+".__super__.constructor.apply(this, arguments)"))}this.ctor.body.makeReturn();this.body.expressions.unshift(this.ctor)}this.ctor.ctor=this.ctor.name=name;this.ctor.klass=null;return this.ctor.noReturn=true};Class.prototype.compileNode=function(o){var args,argumentsNode,func,jumpNode,klass,lname,name,superClass,_ref2;if(jumpNode=this.body.jumps()){jumpNode.error("Class bodies cannot contain pure statements")}if(argumentsNode=this.body.contains(isLiteralArguments)){argumentsNode.error("Class bodies shouldn't reference arguments")}name=this.determineName()||"_Class";if(name.reserved){name="_"+name}lname=new Literal(name);func=new Code([],Block.wrap([this.body]));args=[];o.classScope=func.makeScope(o.scope);this.hoistDirectivePrologue();this.setContext(name);this.walkBody(name,o);this.ensureConstructor(name);this.addBoundFunctions(o);this.body.spaced=true;this.body.expressions.push(lname);if(this.parent){superClass=new Literal(o.classScope.freeVariable("super",false));this.body.expressions.unshift(new Extends(lname,superClass));func.params.push(new Param(superClass));args.push(this.parent)}(_ref2=this.body.expressions).unshift.apply(_ref2,this.directives);klass=new Parens(new Call(func,args));if(this.variable){klass=new Assign(this.variable,klass)}return klass.compileToFragments(o)};return Class}(Base);exports.Assign=Assign=function(_super){__extends(Assign,_super);function Assign(variable,value,context,options){var forbidden,name,_ref2;this.variable=variable;this.value=value;this.context=context;this.param=options&&options.param;this.subpattern=options&&options.subpattern;forbidden=(_ref2=name=this.variable.unwrapAll().value,__indexOf.call(STRICT_PROSCRIBED,_ref2)>=0);if(forbidden&&this.context!=="object"){this.variable.error('variable name may not be "'+name+'"')}}Assign.prototype.children=["variable","value"];Assign.prototype.isStatement=function(o){return(o!=null?o.level:void 0)===LEVEL_TOP&&this.context!=null&&__indexOf.call(this.context,"?")>=0};Assign.prototype.assigns=function(name){return this[this.context==="object"?"value":"variable"].assigns(name)};Assign.prototype.unfoldSoak=function(o){return unfoldSoak(o,this,"variable")};Assign.prototype.compileNode=function(o){var answer,compiledName,isValue,match,name,val,varBase,_ref2,_ref3,_ref4,_ref5;if(isValue=this.variable instanceof Value){if(this.variable.isArray()||this.variable.isObject()){return this.compilePatternMatch(o)}if(this.variable.isSplice()){return this.compileSplice(o)}if((_ref2=this.context)==="||="||_ref2==="&&="||_ref2==="?="){return this.compileConditional(o)}if((_ref3=this.context)==="**="||_ref3==="//="||_ref3==="%%="){return this.compileSpecialMath(o)}}compiledName=this.variable.compileToFragments(o,LEVEL_LIST);name=fragmentsToText(compiledName);if(!this.context){varBase=this.variable.unwrapAll();if(!varBase.isAssignable()){this.variable.error('"'+this.variable.compile(o)+'" cannot be assigned')}if(!(typeof varBase.hasProperties==="function"?varBase.hasProperties():void 0)){if(this.param){o.scope.add(name,"var")}else{o.scope.find(name)}}}if(this.value instanceof Code&&(match=METHOD_DEF.exec(name))){if(match[2]){this.value.klass=match[1]}this.value.name=(_ref4=(_ref5=match[3])!=null?_ref5:match[4])!=null?_ref4:match[5]}val=this.value.compileToFragments(o,LEVEL_LIST);if(this.context==="object"){return compiledName.concat(this.makeCode(": "),val)}answer=compiledName.concat(this.makeCode(" "+(this.context||"=")+" "),val);if(o.level<=LEVEL_LIST){return answer}else{return this.wrapInBraces(answer)}};Assign.prototype.compilePatternMatch=function(o){var acc,assigns,code,expandedIdx,fragments,i,idx,isObject,ivar,name,obj,objects,olen,ref,rest,top,val,value,vvar,vvarText,_i,_len,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7;top=o.level===LEVEL_TOP;value=this.value;objects=this.variable.base.objects;if(!(olen=objects.length)){code=value.compileToFragments(o);if(o.level>=LEVEL_OP){return this.wrapInBraces(code)}else{return code}}isObject=this.variable.isObject();if(top&&olen===1&&!((obj=objects[0])instanceof Splat)){if(obj instanceof Assign){_ref2=obj,_ref3=_ref2.variable,idx=_ref3.base,obj=_ref2.value}else{idx=isObject?obj["this"]?obj.properties[0].name:obj:new Literal(0)}acc=IDENTIFIER.test(idx.unwrap().value||0);value=new Value(value);value.properties.push(new(acc?Access:Index)(idx));if(_ref4=obj.unwrap().value,__indexOf.call(RESERVED,_ref4)>=0){obj.error("assignment to a reserved word: "+obj.compile(o))}return new Assign(obj,value,null,{param:this.param}).compileToFragments(o,LEVEL_TOP)}vvar=value.compileToFragments(o,LEVEL_LIST);vvarText=fragmentsToText(vvar);assigns=[];expandedIdx=false;if(!IDENTIFIER.test(vvarText)||this.variable.assigns(vvarText)){assigns.push([this.makeCode(""+(ref=o.scope.freeVariable("ref"))+" = ")].concat(__slice.call(vvar)));vvar=[this.makeCode(ref)];vvarText=ref}for(i=_i=0,_len=objects.length;_i<_len;i=++_i){obj=objects[i];idx=i;if(isObject){if(obj instanceof Assign){_ref5=obj,_ref6=_ref5.variable,idx=_ref6.base,obj=_ref5.value}else{if(obj.base instanceof Parens){_ref7=new Value(obj.unwrapAll()).cacheReference(o),obj=_ref7[0],idx=_ref7[1]}else{idx=obj["this"]?obj.properties[0].name:obj}}}if(!expandedIdx&&obj instanceof Splat){name=obj.name.unwrap().value;obj=obj.unwrap();val=""+olen+" <= "+vvarText+".length ? "+utility("slice")+".call("+vvarText+", "+i;if(rest=olen-i-1){ivar=o.scope.freeVariable("i");val+=", "+ivar+" = "+vvarText+".length - "+rest+") : ("+ivar+" = "+i+", [])"}else{val+=") : []"}val=new Literal(val);expandedIdx=""+ivar+"++"}else if(!expandedIdx&&obj instanceof Expansion){if(rest=olen-i-1){if(rest===1){expandedIdx=""+vvarText+".length - 1"}else{ivar=o.scope.freeVariable("i");val=new Literal(""+ivar+" = "+vvarText+".length - "+rest);expandedIdx=""+ivar+"++";assigns.push(val.compileToFragments(o,LEVEL_LIST))}}continue}else{name=obj.unwrap().value;if(obj instanceof Splat||obj instanceof Expansion){obj.error("multiple splats/expansions are disallowed in an assignment")}if(typeof idx==="number"){idx=new Literal(expandedIdx||idx);acc=false}else{acc=isObject&&IDENTIFIER.test(idx.unwrap().value||0)}val=new Value(new Literal(vvarText),[new(acc?Access:Index)(idx)])}if(name!=null&&__indexOf.call(RESERVED,name)>=0){obj.error("assignment to a reserved word: "+obj.compile(o))}assigns.push(new Assign(obj,val,null,{param:this.param,subpattern:true}).compileToFragments(o,LEVEL_LIST))}if(!(top||this.subpattern)){assigns.push(vvar)}fragments=this.joinFragmentArrays(assigns,", ");if(o.level<LEVEL_LIST){return fragments}else{return this.wrapInBraces(fragments)}};Assign.prototype.compileConditional=function(o){var fragments,left,right,_ref2;_ref2=this.variable.cacheReference(o),left=_ref2[0],right=_ref2[1];if(!left.properties.length&&left.base instanceof Literal&&left.base.value!=="this"&&!o.scope.check(left.base.value)){this.variable.error('the variable "'+left.base.value+"\" can't be assigned with "+this.context+" because it has not been declared before")}if(__indexOf.call(this.context,"?")>=0){o.isExistentialEquals=true;return new If(new Existence(left),right,{type:"if"}).addElse(new Assign(right,this.value,"=")).compileToFragments(o)}else{fragments=new Op(this.context.slice(0,-1),left,new Assign(right,this.value,"=")).compileToFragments(o);if(o.level<=LEVEL_LIST){return fragments}else{return this.wrapInBraces(fragments)}}};Assign.prototype.compileSpecialMath=function(o){var left,right,_ref2;_ref2=this.variable.cacheReference(o),left=_ref2[0],right=_ref2[1];return new Assign(left,new Op(this.context.slice(0,-1),right,this.value)).compileToFragments(o)};Assign.prototype.compileSplice=function(o){var answer,exclusive,from,fromDecl,fromRef,name,to,valDef,valRef,_ref2,_ref3,_ref4;_ref2=this.variable.properties.pop().range,from=_ref2.from,to=_ref2.to,exclusive=_ref2.exclusive;name=this.variable.compile(o);if(from){_ref3=this.cacheToCodeFragments(from.cache(o,LEVEL_OP)),fromDecl=_ref3[0],fromRef=_ref3[1]}else{fromDecl=fromRef="0"}if(to){if(from instanceof Value&&from.isSimpleNumber()&&to instanceof Value&&to.isSimpleNumber()){to=to.compile(o)-fromRef;if(!exclusive){to+=1}}else{to=to.compile(o,LEVEL_ACCESS)+" - "+fromRef;if(!exclusive){to+=" + 1"}}}else{to="9e9"}_ref4=this.value.cache(o,LEVEL_LIST),valDef=_ref4[0],valRef=_ref4[1];answer=[].concat(this.makeCode("[].splice.apply("+name+", ["+fromDecl+", "+to+"].concat("),valDef,this.makeCode(")), "),valRef);if(o.level>LEVEL_TOP){return this.wrapInBraces(answer)}else{return answer}};return Assign}(Base);exports.Code=Code=function(_super){__extends(Code,_super);function Code(params,body,tag){this.params=params||[];this.body=body||new Block;this.bound=tag==="boundfunc"}Code.prototype.children=["params","body"];Code.prototype.isStatement=function(){return!!this.ctor};Code.prototype.jumps=NO;Code.prototype.makeScope=function(parentScope){return new Scope(parentScope,this.body,this)};Code.prototype.compileNode=function(o){var answer,boundfunc,code,exprs,i,lit,p,param,params,ref,splats,uniqs,val,wasEmpty,wrapper,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_len5,_m,_n,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7;if(this.bound&&((_ref2=o.scope.method)!=null?_ref2.bound:void 0)){this.context=o.scope.method.context}if(this.bound&&!this.context){this.context="_this";wrapper=new Code([new Param(new Literal(this.context))],new Block([this]));boundfunc=new Call(wrapper,[new Literal("this")]);boundfunc.updateLocationDataIfMissing(this.locationData);return boundfunc.compileNode(o)}o.scope=del(o,"classScope")||this.makeScope(o.scope);o.scope.shared=del(o,"sharedScope");o.indent+=TAB;delete o.bare;delete o.isExistentialEquals;params=[];exprs=[];_ref3=this.params;for(_i=0,_len=_ref3.length;_i<_len;_i++){param=_ref3[_i];if(!(param instanceof Expansion)){o.scope.parameter(param.asReference(o))}}_ref4=this.params;for(_j=0,_len1=_ref4.length;_j<_len1;_j++){param=_ref4[_j];if(!(param.splat||param instanceof Expansion)){continue}_ref5=this.params;for(_k=0,_len2=_ref5.length;_k<_len2;_k++){p=_ref5[_k].name;if(!!(param instanceof Expansion)){continue}if(p["this"]){p=p.properties[0].name}if(p.value){o.scope.add(p.value,"var",true)}}splats=new Assign(new Value(new Arr(function(){var _l,_len3,_ref6,_results;_ref6=this.params;_results=[];for(_l=0,_len3=_ref6.length;_l<_len3;_l++){p=_ref6[_l];_results.push(p.asReference(o))}return _results}.call(this))),new Value(new Literal("arguments")));break}_ref6=this.params;for(_l=0,_len3=_ref6.length;_l<_len3;_l++){param=_ref6[_l];if(param.isComplex()){val=ref=param.asReference(o);if(param.value){val=new Op("?",ref,param.value)}exprs.push(new Assign(new Value(param.name),val,"=",{param:true}))}else{ref=param;if(param.value){lit=new Literal(ref.name.value+" == null");val=new Assign(new Value(param.name),param.value,"=");exprs.push(new If(lit,val))}}if(!splats){params.push(ref)}}wasEmpty=this.body.isEmpty();if(splats){exprs.unshift(splats)}if(exprs.length){(_ref7=this.body.expressions).unshift.apply(_ref7,exprs)}for(i=_m=0,_len4=params.length;_m<_len4;i=++_m){p=params[i];params[i]=p.compileToFragments(o);o.scope.parameter(fragmentsToText(params[i]))}uniqs=[];this.eachParamName(function(name,node){if(__indexOf.call(uniqs,name)>=0){node.error("multiple parameters named '"+name+"'")}return uniqs.push(name)});if(!(wasEmpty||this.noReturn)){this.body.makeReturn()}code="function";if(this.ctor){code+=" "+this.name}code+="(";answer=[this.makeCode(code)];for(i=_n=0,_len5=params.length;_n<_len5;i=++_n){p=params[i];if(i){answer.push(this.makeCode(", "))}answer.push.apply(answer,p)}answer.push(this.makeCode(") {"));if(!this.body.isEmpty()){answer=answer.concat(this.makeCode("\n"),this.body.compileWithDeclarations(o),this.makeCode("\n"+this.tab))}answer.push(this.makeCode("}"));if(this.ctor){return[this.makeCode(this.tab)].concat(__slice.call(answer))}if(this.front||o.level>=LEVEL_ACCESS){return this.wrapInBraces(answer)}else{return answer}};Code.prototype.eachParamName=function(iterator){var param,_i,_len,_ref2,_results;_ref2=this.params;_results=[];for(_i=0,_len=_ref2.length;_i<_len;_i++){param=_ref2[_i];_results.push(param.eachName(iterator))}return _results};Code.prototype.traverseChildren=function(crossScope,func){if(crossScope){return Code.__super__.traverseChildren.call(this,crossScope,func)}};return Code}(Base);exports.Param=Param=function(_super){__extends(Param,_super);function Param(name,value,splat){var _ref2;this.name=name;this.value=value;this.splat=splat;if(_ref2=name=this.name.unwrapAll().value,__indexOf.call(STRICT_PROSCRIBED,_ref2)>=0){this.name.error('parameter name "'+name+'" is not allowed')}}Param.prototype.children=["name","value"];Param.prototype.compileToFragments=function(o){return this.name.compileToFragments(o,LEVEL_LIST)};Param.prototype.asReference=function(o){var node;if(this.reference){return this.reference}node=this.name;if(node["this"]){node=node.properties[0].name;if(node.value.reserved){node=new Literal(o.scope.freeVariable(node.value))}}else if(node.isComplex()){node=new Literal(o.scope.freeVariable("arg"))}node=new Value(node);if(this.splat){node=new Splat(node)}node.updateLocationDataIfMissing(this.locationData);return this.reference=node};Param.prototype.isComplex=function(){return this.name.isComplex()};Param.prototype.eachName=function(iterator,name){var atParam,node,obj,_i,_len,_ref2;if(name==null){name=this.name}atParam=function(obj){var node;node=obj.properties[0].name;if(!node.value.reserved){return iterator(node.value,node)}};if(name instanceof Literal){return iterator(name.value,name)}if(name instanceof Value){return atParam(name)}_ref2=name.objects;for(_i=0,_len=_ref2.length;_i<_len;_i++){obj=_ref2[_i];if(obj instanceof Assign){this.eachName(iterator,obj.value.unwrap())}else if(obj instanceof Splat){node=obj.name.unwrap();iterator(node.value,node)}else if(obj instanceof Value){if(obj.isArray()||obj.isObject()){this.eachName(iterator,obj.base)}else if(obj["this"]){atParam(obj)}else{iterator(obj.base.value,obj.base)}}else if(!(obj instanceof Expansion)){obj.error("illegal parameter "+obj.compile())}}};return Param}(Base);exports.Splat=Splat=function(_super){__extends(Splat,_super);Splat.prototype.children=["name"];Splat.prototype.isAssignable=YES;function Splat(name){this.name=name.compile?name:new Literal(name)}Splat.prototype.assigns=function(name){return this.name.assigns(name)};Splat.prototype.compileToFragments=function(o){return this.name.compileToFragments(o)};Splat.prototype.unwrap=function(){return this.name};Splat.compileSplattedArray=function(o,list,apply){var args,base,compiledNode,concatPart,fragments,i,index,node,_i,_len;index=-1;while((node=list[++index])&&!(node instanceof Splat)){continue}if(index>=list.length){return[]}if(list.length===1){node=list[0];fragments=node.compileToFragments(o,LEVEL_LIST);if(apply){return fragments}return[].concat(node.makeCode(""+utility("slice")+".call("),fragments,node.makeCode(")"))}args=list.slice(index);for(i=_i=0,_len=args.length;_i<_len;i=++_i){node=args[i];compiledNode=node.compileToFragments(o,LEVEL_LIST);args[i]=node instanceof Splat?[].concat(node.makeCode(""+utility("slice")+".call("),compiledNode,node.makeCode(")")):[].concat(node.makeCode("["),compiledNode,node.makeCode("]"))}if(index===0){node=list[0];concatPart=node.joinFragmentArrays(args.slice(1),", ");return args[0].concat(node.makeCode(".concat("),concatPart,node.makeCode(")"))}base=function(){var _j,_len1,_ref2,_results;_ref2=list.slice(0,index);_results=[];for(_j=0,_len1=_ref2.length;_j<_len1;_j++){node=_ref2[_j];_results.push(node.compileToFragments(o,LEVEL_LIST))}return _results}();base=list[0].joinFragmentArrays(base,", ");concatPart=list[index].joinFragmentArrays(args,", ");return[].concat(list[0].makeCode("["),base,list[index].makeCode("].concat("),concatPart,last(list).makeCode(")"))};return Splat}(Base);exports.Expansion=Expansion=function(_super){__extends(Expansion,_super);function Expansion(){return Expansion.__super__.constructor.apply(this,arguments)}Expansion.prototype.isComplex=NO;Expansion.prototype.compileNode=function(o){return this.error("Expansion must be used inside a destructuring assignment or parameter list")};Expansion.prototype.asReference=function(o){return this};Expansion.prototype.eachName=function(iterator){};return Expansion}(Base);exports.While=While=function(_super){__extends(While,_super);function While(condition,options){this.condition=(options!=null?options.invert:void 0)?condition.invert():condition;this.guard=options!=null?options.guard:void 0}While.prototype.children=["condition","guard","body"];While.prototype.isStatement=YES;While.prototype.makeReturn=function(res){if(res){return While.__super__.makeReturn.apply(this,arguments)}else{this.returns=!this.jumps({loop:true});return this}};While.prototype.addBody=function(body){this.body=body;return this};While.prototype.jumps=function(){var expressions,jumpNode,node,_i,_len;expressions=this.body.expressions;if(!expressions.length){return false}for(_i=0,_len=expressions.length;_i<_len;_i++){node=expressions[_i];if(jumpNode=node.jumps({loop:true})){return jumpNode}}return false};While.prototype.compileNode=function(o){var answer,body,rvar,set;o.indent+=TAB;set="";body=this.body;if(body.isEmpty()){body=this.makeCode("")}else{if(this.returns){body.makeReturn(rvar=o.scope.freeVariable("results"));set=""+this.tab+rvar+" = [];\n"}if(this.guard){if(body.expressions.length>1){body.expressions.unshift(new If(new Parens(this.guard).invert(),new Literal("continue")))}else{if(this.guard){body=Block.wrap([new If(this.guard,body)])}}}body=[].concat(this.makeCode("\n"),body.compileToFragments(o,LEVEL_TOP),this.makeCode("\n"+this.tab))}answer=[].concat(this.makeCode(set+this.tab+"while ("),this.condition.compileToFragments(o,LEVEL_PAREN),this.makeCode(") {"),body,this.makeCode("}"));if(this.returns){answer.push(this.makeCode("\n"+this.tab+"return "+rvar+";"))}return answer};return While}(Base);exports.Op=Op=function(_super){var CONVERSIONS,INVERSIONS;__extends(Op,_super);function Op(op,first,second,flip){if(op==="in"){return new In(first,second)}if(op==="do"){return this.generateDo(first)}if(op==="new"){if(first instanceof Call&&!first["do"]&&!first.isNew){return first.newInstance()}if(first instanceof Code&&first.bound||first["do"]){first=new Parens(first)}}this.operator=CONVERSIONS[op]||op;this.first=first;this.second=second;this.flip=!!flip;return this}CONVERSIONS={"==":"===","!=":"!==",of:"in"};INVERSIONS={"!==":"===","===":"!=="};Op.prototype.children=["first","second"];Op.prototype.isSimpleNumber=NO;Op.prototype.isUnary=function(){return!this.second};Op.prototype.isComplex=function(){var _ref2;return!(this.isUnary()&&((_ref2=this.operator)==="+"||_ref2==="-"))||this.first.isComplex()};Op.prototype.isChainable=function(){var _ref2;return(_ref2=this.operator)==="<"||_ref2===">"||_ref2===">="||_ref2==="<="||_ref2==="==="||_ref2==="!=="};Op.prototype.invert=function(){var allInvertable,curr,fst,op,_ref2;if(this.isChainable()&&this.first.isChainable()){allInvertable=true;curr=this;while(curr&&curr.operator){allInvertable&&(allInvertable=curr.operator in INVERSIONS);curr=curr.first}if(!allInvertable){return new Parens(this).invert()}curr=this;while(curr&&curr.operator){curr.invert=!curr.invert;curr.operator=INVERSIONS[curr.operator];curr=curr.first}return this}else if(op=INVERSIONS[this.operator]){this.operator=op;if(this.first.unwrap()instanceof Op){this.first.invert()}return this}else if(this.second){return new Parens(this).invert()}else if(this.operator==="!"&&(fst=this.first.unwrap())instanceof Op&&((_ref2=fst.operator)==="!"||_ref2==="in"||_ref2==="instanceof")){return fst}else{return new Op("!",this)}};Op.prototype.unfoldSoak=function(o){var _ref2;return((_ref2=this.operator)==="++"||_ref2==="--"||_ref2==="delete")&&unfoldSoak(o,this,"first")};Op.prototype.generateDo=function(exp){var call,func,param,passedParams,ref,_i,_len,_ref2;passedParams=[];func=exp instanceof Assign&&(ref=exp.value.unwrap())instanceof Code?ref:exp;_ref2=func.params||[];for(_i=0,_len=_ref2.length;_i<_len;_i++){param=_ref2[_i];if(param.value){passedParams.push(param.value);delete param.value}else{passedParams.push(param)}}call=new Call(exp,passedParams);call["do"]=true;return call};Op.prototype.compileNode=function(o){var answer,isChain,lhs,rhs,_ref2,_ref3;isChain=this.isChainable()&&this.first.isChainable();if(!isChain){this.first.front=this.front}if(this.operator==="delete"&&o.scope.check(this.first.unwrapAll().value)){this.error("delete operand may not be argument or var")}if(((_ref2=this.operator)==="--"||_ref2==="++")&&(_ref3=this.first.unwrapAll().value,__indexOf.call(STRICT_PROSCRIBED,_ref3)>=0)){this.error('cannot increment/decrement "'+this.first.unwrapAll().value+'"')}if(this.isUnary()){return this.compileUnary(o)}if(isChain){return this.compileChain(o)}switch(this.operator){case"?":return this.compileExistence(o);case"**":return this.compilePower(o);case"//":return this.compileFloorDivision(o);case"%%":return this.compileModulo(o);default:lhs=this.first.compileToFragments(o,LEVEL_OP);rhs=this.second.compileToFragments(o,LEVEL_OP);answer=[].concat(lhs,this.makeCode(" "+this.operator+" "),rhs);if(o.level<=LEVEL_OP){return answer}else{return this.wrapInBraces(answer)}}};Op.prototype.compileChain=function(o){var fragments,fst,shared,_ref2;_ref2=this.first.second.cache(o),this.first.second=_ref2[0],shared=_ref2[1];fst=this.first.compileToFragments(o,LEVEL_OP);fragments=fst.concat(this.makeCode(" "+(this.invert?"&&":"||")+" "),shared.compileToFragments(o),this.makeCode(" "+this.operator+" "),this.second.compileToFragments(o,LEVEL_OP));return this.wrapInBraces(fragments)};Op.prototype.compileExistence=function(o){var fst,ref;if(this.first.isComplex()){ref=new Literal(o.scope.freeVariable("ref"));fst=new Parens(new Assign(ref,this.first))}else{fst=this.first;ref=fst}return new If(new Existence(fst),ref,{type:"if"}).addElse(this.second).compileToFragments(o)};Op.prototype.compileUnary=function(o){var op,parts,plusMinus;parts=[];op=this.operator;parts.push([this.makeCode(op)]);if(op==="!"&&this.first instanceof Existence){this.first.negated=!this.first.negated;return this.first.compileToFragments(o)}if(o.level>=LEVEL_ACCESS){return new Parens(this).compileToFragments(o)}plusMinus=op==="+"||op==="-";if(op==="new"||op==="typeof"||op==="delete"||plusMinus&&this.first instanceof Op&&this.first.operator===op){parts.push([this.makeCode(" ")])}if(plusMinus&&this.first instanceof Op||op==="new"&&this.first.isStatement(o)){this.first=new Parens(this.first)}parts.push(this.first.compileToFragments(o,LEVEL_OP));if(this.flip){parts.reverse()}return this.joinFragmentArrays(parts,"")};Op.prototype.compilePower=function(o){var pow;pow=new Value(new Literal("Math"),[new Access(new Literal("pow"))]);return new Call(pow,[this.first,this.second]).compileToFragments(o)};Op.prototype.compileFloorDivision=function(o){var div,floor;floor=new Value(new Literal("Math"),[new Access(new Literal("floor"))]);div=new Op("/",this.first,this.second);return new Call(floor,[div]).compileToFragments(o)};Op.prototype.compileModulo=function(o){var mod;mod=new Value(new Literal(utility("modulo")));return new Call(mod,[this.first,this.second]).compileToFragments(o)};Op.prototype.toString=function(idt){return Op.__super__.toString.call(this,idt,this.constructor.name+" "+this.operator)};return Op}(Base);exports.In=In=function(_super){__extends(In,_super);function In(object,array){this.object=object;this.array=array}In.prototype.children=["object","array"];In.prototype.invert=NEGATE;In.prototype.compileNode=function(o){var hasSplat,obj,_i,_len,_ref2;if(this.array instanceof Value&&this.array.isArray()&&this.array.base.objects.length){_ref2=this.array.base.objects;for(_i=0,_len=_ref2.length;_i<_len;_i++){obj=_ref2[_i];if(!(obj instanceof Splat)){continue}hasSplat=true;break}if(!hasSplat){return this.compileOrTest(o)}}return this.compileLoopTest(o)};In.prototype.compileOrTest=function(o){var cmp,cnj,i,item,ref,sub,tests,_i,_len,_ref2,_ref3,_ref4;_ref2=this.object.cache(o,LEVEL_OP),sub=_ref2[0],ref=_ref2[1];_ref3=this.negated?[" !== "," && "]:[" === "," || "],cmp=_ref3[0],cnj=_ref3[1];tests=[];_ref4=this.array.base.objects;for(i=_i=0,_len=_ref4.length;_i<_len;i=++_i){item=_ref4[i];if(i){tests.push(this.makeCode(cnj))}tests=tests.concat(i?ref:sub,this.makeCode(cmp),item.compileToFragments(o,LEVEL_ACCESS))}if(o.level<LEVEL_OP){return tests}else{return this.wrapInBraces(tests)}};In.prototype.compileLoopTest=function(o){var fragments,ref,sub,_ref2;_ref2=this.object.cache(o,LEVEL_LIST),sub=_ref2[0],ref=_ref2[1];fragments=[].concat(this.makeCode(utility("indexOf")+".call("),this.array.compileToFragments(o,LEVEL_LIST),this.makeCode(", "),ref,this.makeCode(") "+(this.negated?"< 0":">= 0")));if(fragmentsToText(sub)===fragmentsToText(ref)){return fragments}fragments=sub.concat(this.makeCode(", "),fragments);if(o.level<LEVEL_LIST){return fragments}else{return this.wrapInBraces(fragments)}};In.prototype.toString=function(idt){return In.__super__.toString.call(this,idt,this.constructor.name+(this.negated?"!":""))};return In}(Base);exports.Try=Try=function(_super){__extends(Try,_super);function Try(attempt,errorVariable,recovery,ensure){this.attempt=attempt;this.errorVariable=errorVariable;this.recovery=recovery;this.ensure=ensure}Try.prototype.children=["attempt","recovery","ensure"];Try.prototype.isStatement=YES;Try.prototype.jumps=function(o){var _ref2;return this.attempt.jumps(o)||((_ref2=this.recovery)!=null?_ref2.jumps(o):void 0)};Try.prototype.makeReturn=function(res){if(this.attempt){this.attempt=this.attempt.makeReturn(res)}if(this.recovery){this.recovery=this.recovery.makeReturn(res)}return this};Try.prototype.compileNode=function(o){var catchPart,ensurePart,placeholder,tryPart;o.indent+=TAB;tryPart=this.attempt.compileToFragments(o,LEVEL_TOP);catchPart=this.recovery?(placeholder=new Literal("_error"),this.errorVariable?this.recovery.unshift(new Assign(this.errorVariable,placeholder)):void 0,[].concat(this.makeCode(" catch ("),placeholder.compileToFragments(o),this.makeCode(") {\n"),this.recovery.compileToFragments(o,LEVEL_TOP),this.makeCode("\n"+this.tab+"}"))):!(this.ensure||this.recovery)?[this.makeCode(" catch (_error) {}")]:[];ensurePart=this.ensure?[].concat(this.makeCode(" finally {\n"),this.ensure.compileToFragments(o,LEVEL_TOP),this.makeCode("\n"+this.tab+"}")):[];return[].concat(this.makeCode(""+this.tab+"try {\n"),tryPart,this.makeCode("\n"+this.tab+"}"),catchPart,ensurePart)};return Try}(Base);exports.Throw=Throw=function(_super){__extends(Throw,_super);function Throw(expression){this.expression=expression}Throw.prototype.children=["expression"];Throw.prototype.isStatement=YES;Throw.prototype.jumps=NO;Throw.prototype.makeReturn=THIS;Throw.prototype.compileNode=function(o){return[].concat(this.makeCode(this.tab+"throw "),this.expression.compileToFragments(o),this.makeCode(";"))};return Throw}(Base);exports.Existence=Existence=function(_super){__extends(Existence,_super);function Existence(expression){this.expression=expression}Existence.prototype.children=["expression"];Existence.prototype.invert=NEGATE;Existence.prototype.compileNode=function(o){var cmp,cnj,code,_ref2;this.expression.front=this.front;code=this.expression.compile(o,LEVEL_OP);if(IDENTIFIER.test(code)&&!o.scope.check(code)){_ref2=this.negated?["===","||"]:["!==","&&"],cmp=_ref2[0],cnj=_ref2[1];code="typeof "+code+" "+cmp+' "undefined" '+cnj+" "+code+" "+cmp+" null"}else{code=""+code+" "+(this.negated?"==":"!=")+" null"}return[this.makeCode(o.level<=LEVEL_COND?code:"("+code+")")]};return Existence}(Base);exports.Parens=Parens=function(_super){__extends(Parens,_super);function Parens(body){this.body=body}Parens.prototype.children=["body"];Parens.prototype.unwrap=function(){return this.body};Parens.prototype.isComplex=function(){return this.body.isComplex()};Parens.prototype.compileNode=function(o){var bare,expr,fragments;expr=this.body.unwrap();if(expr instanceof Value&&expr.isAtomic()){expr.front=this.front;return expr.compileToFragments(o)}fragments=expr.compileToFragments(o,LEVEL_PAREN);bare=o.level<LEVEL_OP&&(expr instanceof Op||expr instanceof Call||expr instanceof For&&expr.returns);if(bare){return fragments}else{return this.wrapInBraces(fragments)}};return Parens}(Base);exports.For=For=function(_super){__extends(For,_super);function For(body,source){var _ref2;this.source=source.source,this.guard=source.guard,this.step=source.step,this.name=source.name,this.index=source.index;this.body=Block.wrap([body]);this.own=!!source.own;this.object=!!source.object;if(this.object){_ref2=[this.index,this.name],this.name=_ref2[0],this.index=_ref2[1]}if(this.index instanceof Value){this.index.error("index cannot be a pattern matching expression")}this.range=this.source instanceof Value&&this.source.base instanceof Range&&!this.source.properties.length;this.pattern=this.name instanceof Value;if(this.range&&this.index){this.index.error("indexes do not apply to range loops")}if(this.range&&this.pattern){this.name.error("cannot pattern match over range loops")}if(this.own&&!this.object){this.name.error("cannot use own with for-in")}this.returns=false}For.prototype.children=["body","source","guard","step"];For.prototype.compileNode=function(o){var body,bodyFragments,compare,compareDown,declare,declareDown,defPart,defPartFragments,down,forPartFragments,guardPart,idt1,increment,index,ivar,kvar,kvarAssign,lastJumps,lvar,name,namePart,ref,resultPart,returnResult,rvar,scope,source,step,stepNum,stepVar,svar,varPart,_ref2,_ref3;body=Block.wrap([this.body]);lastJumps=(_ref2=last(body.expressions))!=null?_ref2.jumps():void 0;if(lastJumps&&lastJumps instanceof Return){this.returns=false}source=this.range?this.source.base:this.source;scope=o.scope;if(!this.pattern){name=this.name&&this.name.compile(o,LEVEL_LIST)}index=this.index&&this.index.compile(o,LEVEL_LIST);if(name&&!this.pattern){scope.find(name)}if(index){scope.find(index)}if(this.returns){rvar=scope.freeVariable("results")}ivar=this.object&&index||scope.freeVariable("i");kvar=this.range&&name||index||ivar;kvarAssign=kvar!==ivar?""+kvar+" = ":"";if(this.step&&!this.range){_ref3=this.cacheToCodeFragments(this.step.cache(o,LEVEL_LIST)),step=_ref3[0],stepVar=_ref3[1];stepNum=stepVar.match(NUMBER)}if(this.pattern){name=ivar}varPart="";guardPart="";defPart="";idt1=this.tab+TAB;if(this.range){forPartFragments=source.compileToFragments(merge(o,{index:ivar,name:name,step:this.step}))}else{svar=this.source.compile(o,LEVEL_LIST);
if((name||this.own)&&!IDENTIFIER.test(svar)){defPart+=""+this.tab+(ref=scope.freeVariable("ref"))+" = "+svar+";\n";svar=ref}if(name&&!this.pattern){namePart=""+name+" = "+svar+"["+kvar+"]"}if(!this.object){if(step!==stepVar){defPart+=""+this.tab+step+";\n"}if(!(this.step&&stepNum&&(down=parseNum(stepNum[0])<0))){lvar=scope.freeVariable("len")}declare=""+kvarAssign+ivar+" = 0, "+lvar+" = "+svar+".length";declareDown=""+kvarAssign+ivar+" = "+svar+".length - 1";compare=""+ivar+" < "+lvar;compareDown=""+ivar+" >= 0";if(this.step){if(stepNum){if(down){compare=compareDown;declare=declareDown}}else{compare=""+stepVar+" > 0 ? "+compare+" : "+compareDown;declare="("+stepVar+" > 0 ? ("+declare+") : "+declareDown+")"}increment=""+ivar+" += "+stepVar}else{increment=""+(kvar!==ivar?"++"+ivar:""+ivar+"++")}forPartFragments=[this.makeCode(""+declare+"; "+compare+"; "+kvarAssign+increment)]}}if(this.returns){resultPart=""+this.tab+rvar+" = [];\n";returnResult="\n"+this.tab+"return "+rvar+";";body.makeReturn(rvar)}if(this.guard){if(body.expressions.length>1){body.expressions.unshift(new If(new Parens(this.guard).invert(),new Literal("continue")))}else{if(this.guard){body=Block.wrap([new If(this.guard,body)])}}}if(this.pattern){body.expressions.unshift(new Assign(this.name,new Literal(""+svar+"["+kvar+"]")))}defPartFragments=[].concat(this.makeCode(defPart),this.pluckDirectCall(o,body));if(namePart){varPart="\n"+idt1+namePart+";"}if(this.object){forPartFragments=[this.makeCode(""+kvar+" in "+svar)];if(this.own){guardPart="\n"+idt1+"if (!"+utility("hasProp")+".call("+svar+", "+kvar+")) continue;"}}bodyFragments=body.compileToFragments(merge(o,{indent:idt1}),LEVEL_TOP);if(bodyFragments&&bodyFragments.length>0){bodyFragments=[].concat(this.makeCode("\n"),bodyFragments,this.makeCode("\n"))}return[].concat(defPartFragments,this.makeCode(""+(resultPart||"")+this.tab+"for ("),forPartFragments,this.makeCode(") {"+guardPart+varPart),bodyFragments,this.makeCode(""+this.tab+"}"+(returnResult||"")))};For.prototype.pluckDirectCall=function(o,body){var base,defs,expr,fn,idx,ref,val,_i,_len,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8;defs=[];_ref2=body.expressions;for(idx=_i=0,_len=_ref2.length;_i<_len;idx=++_i){expr=_ref2[idx];expr=expr.unwrapAll();if(!(expr instanceof Call)){continue}val=(_ref3=expr.variable)!=null?_ref3.unwrapAll():void 0;if(!(val instanceof Code||val instanceof Value&&((_ref4=val.base)!=null?_ref4.unwrapAll():void 0)instanceof Code&&val.properties.length===1&&((_ref5=(_ref6=val.properties[0].name)!=null?_ref6.value:void 0)==="call"||_ref5==="apply"))){continue}fn=((_ref7=val.base)!=null?_ref7.unwrapAll():void 0)||val;ref=new Literal(o.scope.freeVariable("fn"));base=new Value(ref);if(val.base){_ref8=[base,val],val.base=_ref8[0],base=_ref8[1]}body.expressions[idx]=new Call(base,expr.args);defs=defs.concat(this.makeCode(this.tab),new Assign(ref,fn).compileToFragments(o,LEVEL_TOP),this.makeCode(";\n"))}return defs};return For}(While);exports.Switch=Switch=function(_super){__extends(Switch,_super);function Switch(subject,cases,otherwise){this.subject=subject;this.cases=cases;this.otherwise=otherwise}Switch.prototype.children=["subject","cases","otherwise"];Switch.prototype.isStatement=YES;Switch.prototype.jumps=function(o){var block,conds,jumpNode,_i,_len,_ref2,_ref3,_ref4;if(o==null){o={block:true}}_ref2=this.cases;for(_i=0,_len=_ref2.length;_i<_len;_i++){_ref3=_ref2[_i],conds=_ref3[0],block=_ref3[1];if(jumpNode=block.jumps(o)){return jumpNode}}return(_ref4=this.otherwise)!=null?_ref4.jumps(o):void 0};Switch.prototype.makeReturn=function(res){var pair,_i,_len,_ref2,_ref3;_ref2=this.cases;for(_i=0,_len=_ref2.length;_i<_len;_i++){pair=_ref2[_i];pair[1].makeReturn(res)}if(res){this.otherwise||(this.otherwise=new Block([new Literal("void 0")]))}if((_ref3=this.otherwise)!=null){_ref3.makeReturn(res)}return this};Switch.prototype.compileNode=function(o){var block,body,cond,conditions,expr,fragments,i,idt1,idt2,_i,_j,_len,_len1,_ref2,_ref3,_ref4;idt1=o.indent+TAB;idt2=o.indent=idt1+TAB;fragments=[].concat(this.makeCode(this.tab+"switch ("),this.subject?this.subject.compileToFragments(o,LEVEL_PAREN):this.makeCode("false"),this.makeCode(") {\n"));_ref2=this.cases;for(i=_i=0,_len=_ref2.length;_i<_len;i=++_i){_ref3=_ref2[i],conditions=_ref3[0],block=_ref3[1];_ref4=flatten([conditions]);for(_j=0,_len1=_ref4.length;_j<_len1;_j++){cond=_ref4[_j];if(!this.subject){cond=cond.invert()}fragments=fragments.concat(this.makeCode(idt1+"case "),cond.compileToFragments(o,LEVEL_PAREN),this.makeCode(":\n"))}if((body=block.compileToFragments(o,LEVEL_TOP)).length>0){fragments=fragments.concat(body,this.makeCode("\n"))}if(i===this.cases.length-1&&!this.otherwise){break}expr=this.lastNonComment(block.expressions);if(expr instanceof Return||expr instanceof Literal&&expr.jumps()&&expr.value!=="debugger"){continue}fragments.push(cond.makeCode(idt2+"break;\n"))}if(this.otherwise&&this.otherwise.expressions.length){fragments.push.apply(fragments,[this.makeCode(idt1+"default:\n")].concat(__slice.call(this.otherwise.compileToFragments(o,LEVEL_TOP)),[this.makeCode("\n")]))}fragments.push(this.makeCode(this.tab+"}"));return fragments};return Switch}(Base);exports.If=If=function(_super){__extends(If,_super);function If(condition,body,options){this.body=body;if(options==null){options={}}this.condition=options.type==="unless"?condition.invert():condition;this.elseBody=null;this.isChain=false;this.soak=options.soak}If.prototype.children=["condition","body","elseBody"];If.prototype.bodyNode=function(){var _ref2;return(_ref2=this.body)!=null?_ref2.unwrap():void 0};If.prototype.elseBodyNode=function(){var _ref2;return(_ref2=this.elseBody)!=null?_ref2.unwrap():void 0};If.prototype.addElse=function(elseBody){if(this.isChain){this.elseBodyNode().addElse(elseBody)}else{this.isChain=elseBody instanceof If;this.elseBody=this.ensureBlock(elseBody);this.elseBody.updateLocationDataIfMissing(elseBody.locationData)}return this};If.prototype.isStatement=function(o){var _ref2;return(o!=null?o.level:void 0)===LEVEL_TOP||this.bodyNode().isStatement(o)||((_ref2=this.elseBodyNode())!=null?_ref2.isStatement(o):void 0)};If.prototype.jumps=function(o){var _ref2;return this.body.jumps(o)||((_ref2=this.elseBody)!=null?_ref2.jumps(o):void 0)};If.prototype.compileNode=function(o){if(this.isStatement(o)){return this.compileStatement(o)}else{return this.compileExpression(o)}};If.prototype.makeReturn=function(res){if(res){this.elseBody||(this.elseBody=new Block([new Literal("void 0")]))}this.body&&(this.body=new Block([this.body.makeReturn(res)]));this.elseBody&&(this.elseBody=new Block([this.elseBody.makeReturn(res)]));return this};If.prototype.ensureBlock=function(node){if(node instanceof Block){return node}else{return new Block([node])}};If.prototype.compileStatement=function(o){var answer,body,child,cond,exeq,ifPart,indent;child=del(o,"chainChild");exeq=del(o,"isExistentialEquals");if(exeq){return new If(this.condition.invert(),this.elseBodyNode(),{type:"if"}).compileToFragments(o)}indent=o.indent+TAB;cond=this.condition.compileToFragments(o,LEVEL_PAREN);body=this.ensureBlock(this.body).compileToFragments(merge(o,{indent:indent}));ifPart=[].concat(this.makeCode("if ("),cond,this.makeCode(") {\n"),body,this.makeCode("\n"+this.tab+"}"));if(!child){ifPart.unshift(this.makeCode(this.tab))}if(!this.elseBody){return ifPart}answer=ifPart.concat(this.makeCode(" else "));if(this.isChain){o.chainChild=true;answer=answer.concat(this.elseBody.unwrap().compileToFragments(o,LEVEL_TOP))}else{answer=answer.concat(this.makeCode("{\n"),this.elseBody.compileToFragments(merge(o,{indent:indent}),LEVEL_TOP),this.makeCode("\n"+this.tab+"}"))}return answer};If.prototype.compileExpression=function(o){var alt,body,cond,fragments;cond=this.condition.compileToFragments(o,LEVEL_COND);body=this.bodyNode().compileToFragments(o,LEVEL_LIST);alt=this.elseBodyNode()?this.elseBodyNode().compileToFragments(o,LEVEL_LIST):[this.makeCode("void 0")];fragments=cond.concat(this.makeCode(" ? "),body,this.makeCode(" : "),alt);if(o.level>=LEVEL_COND){return this.wrapInBraces(fragments)}else{return fragments}};If.prototype.unfoldSoak=function(){return this.soak&&this};return If}(Base);UTILITIES={"extends":function(){return"function(child, parent) { for (var key in parent) { if ("+utility("hasProp")+".call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; }"},bind:function(){return"function(fn, me){ return function(){ return fn.apply(me, arguments); }; }"},indexOf:function(){return"[].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; }"},modulo:function(){return"function(a, b) { return (a % b + +b) % b; }"},hasProp:function(){return"{}.hasOwnProperty"},slice:function(){return"[].slice"}};LEVEL_TOP=1;LEVEL_PAREN=2;LEVEL_LIST=3;LEVEL_COND=4;LEVEL_OP=5;LEVEL_ACCESS=6;TAB="  ";IDENTIFIER_STR="[$A-Za-z_\\x7f-\\uffff][$\\w\\x7f-\\uffff]*";IDENTIFIER=RegExp("^"+IDENTIFIER_STR+"$");SIMPLENUM=/^[+-]?\d+$/;HEXNUM=/^[+-]?0x[\da-f]+/i;NUMBER=/^[+-]?(?:0x[\da-f]+|\d*\.?\d+(?:e[+-]?\d+)?)$/i;METHOD_DEF=RegExp("^("+IDENTIFIER_STR+")(\\.prototype)?(?:\\.("+IDENTIFIER_STR+")|\\[(\"(?:[^\\\\\"\\r\\n]|\\\\.)*\"|'(?:[^\\\\'\\r\\n]|\\\\.)*')\\]|\\[(0x[\\da-fA-F]+|\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)\\])$");IS_STRING=/^['"]/;IS_REGEX=/^\//;utility=function(name){var ref;ref="__"+name;Scope.root.assign(ref,UTILITIES[name]());return ref};multident=function(code,tab){code=code.replace(/\n/g,"$&"+tab);return code.replace(/\s+$/,"")};parseNum=function(x){if(x==null){return 0}else if(x.match(HEXNUM)){return parseInt(x,16)}else{return parseFloat(x)}};isLiteralArguments=function(node){return node instanceof Literal&&node.value==="arguments"&&!node.asKey};isLiteralThis=function(node){return node instanceof Literal&&node.value==="this"&&!node.asKey||node instanceof Code&&node.bound||node instanceof Call&&node.isSuper};unfoldSoak=function(o,parent,name){var ifn;if(!(ifn=parent[name].unfoldSoak(o))){return}parent[name]=ifn.body;ifn.body=new Value(parent);return ifn}}).call(this)},{"./helpers":117,"./lexer":118,"./scope":123}],120:[function(require,module,exports){var process=require("__browserify_process");var parser=function(){var parser={trace:function trace(){},yy:{},symbols_:{error:2,Root:3,Body:4,Line:5,TERMINATOR:6,Expression:7,Statement:8,Return:9,Comment:10,STATEMENT:11,Value:12,Invocation:13,Code:14,Operation:15,Assign:16,If:17,Try:18,While:19,For:20,Switch:21,Class:22,Throw:23,Block:24,INDENT:25,OUTDENT:26,Identifier:27,IDENTIFIER:28,AlphaNumeric:29,NUMBER:30,STRING:31,Literal:32,JS:33,REGEX:34,DEBUGGER:35,UNDEFINED:36,NULL:37,BOOL:38,Assignable:39,"=":40,AssignObj:41,ObjAssignable:42,":":43,ThisProperty:44,RETURN:45,HERECOMMENT:46,PARAM_START:47,ParamList:48,PARAM_END:49,FuncGlyph:50,"->":51,"=>":52,OptComma:53,",":54,Param:55,ParamVar:56,"...":57,Array:58,Object:59,Splat:60,SimpleAssignable:61,Accessor:62,Parenthetical:63,Range:64,This:65,".":66,"?.":67,"::":68,"?::":69,Index:70,INDEX_START:71,IndexValue:72,INDEX_END:73,INDEX_SOAK:74,Slice:75,"{":76,AssignList:77,"}":78,CLASS:79,EXTENDS:80,OptFuncExist:81,Arguments:82,SUPER:83,FUNC_EXIST:84,CALL_START:85,CALL_END:86,ArgList:87,THIS:88,"@":89,"[":90,"]":91,RangeDots:92,"..":93,Arg:94,SimpleArgs:95,TRY:96,Catch:97,FINALLY:98,CATCH:99,THROW:100,"(":101,")":102,WhileSource:103,WHILE:104,WHEN:105,UNTIL:106,Loop:107,LOOP:108,ForBody:109,FOR:110,ForStart:111,ForSource:112,ForVariables:113,OWN:114,ForValue:115,FORIN:116,FOROF:117,BY:118,SWITCH:119,Whens:120,ELSE:121,When:122,LEADING_WHEN:123,IfBlock:124,IF:125,POST_IF:126,UNARY:127,UNARY_MATH:128,"-":129,"+":130,"--":131,"++":132,"?":133,MATH:134,"**":135,SHIFT:136,COMPARE:137,LOGIC:138,RELATION:139,COMPOUND_ASSIGN:140,$accept:0,$end:1},terminals_:{2:"error",6:"TERMINATOR",11:"STATEMENT",25:"INDENT",26:"OUTDENT",28:"IDENTIFIER",30:"NUMBER",31:"STRING",33:"JS",34:"REGEX",35:"DEBUGGER",36:"UNDEFINED",37:"NULL",38:"BOOL",40:"=",43:":",45:"RETURN",46:"HERECOMMENT",47:"PARAM_START",49:"PARAM_END",51:"->",52:"=>",54:",",57:"...",66:".",67:"?.",68:"::",69:"?::",71:"INDEX_START",73:"INDEX_END",74:"INDEX_SOAK",76:"{",78:"}",79:"CLASS",80:"EXTENDS",83:"SUPER",84:"FUNC_EXIST",85:"CALL_START",86:"CALL_END",88:"THIS",89:"@",90:"[",91:"]",93:"..",96:"TRY",98:"FINALLY",99:"CATCH",100:"THROW",101:"(",102:")",104:"WHILE",105:"WHEN",106:"UNTIL",108:"LOOP",110:"FOR",114:"OWN",116:"FORIN",117:"FOROF",118:"BY",119:"SWITCH",121:"ELSE",123:"LEADING_WHEN",125:"IF",126:"POST_IF",127:"UNARY",128:"UNARY_MATH",129:"-",130:"+",131:"--",132:"++",133:"?",134:"MATH",135:"**",136:"SHIFT",137:"COMPARE",138:"LOGIC",139:"RELATION",140:"COMPOUND_ASSIGN"},productions_:[0,[3,0],[3,1],[4,1],[4,3],[4,2],[5,1],[5,1],[8,1],[8,1],[8,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[24,2],[24,3],[27,1],[29,1],[29,1],[32,1],[32,1],[32,1],[32,1],[32,1],[32,1],[32,1],[16,3],[16,4],[16,5],[41,1],[41,3],[41,5],[41,1],[42,1],[42,1],[42,1],[9,2],[9,1],[10,1],[14,5],[14,2],[50,1],[50,1],[53,0],[53,1],[48,0],[48,1],[48,3],[48,4],[48,6],[55,1],[55,2],[55,3],[55,1],[56,1],[56,1],[56,1],[56,1],[60,2],[61,1],[61,2],[61,2],[61,1],[39,1],[39,1],[39,1],[12,1],[12,1],[12,1],[12,1],[12,1],[62,2],[62,2],[62,2],[62,2],[62,1],[62,1],[70,3],[70,2],[72,1],[72,1],[59,4],[77,0],[77,1],[77,3],[77,4],[77,6],[22,1],[22,2],[22,3],[22,4],[22,2],[22,3],[22,4],[22,5],[13,3],[13,3],[13,1],[13,2],[81,0],[81,1],[82,2],[82,4],[65,1],[65,1],[44,2],[58,2],[58,4],[92,1],[92,1],[64,5],[75,3],[75,2],[75,2],[75,1],[87,1],[87,3],[87,4],[87,4],[87,6],[94,1],[94,1],[94,1],[95,1],[95,3],[18,2],[18,3],[18,4],[18,5],[97,3],[97,3],[97,2],[23,2],[63,3],[63,5],[103,2],[103,4],[103,2],[103,4],[19,2],[19,2],[19,2],[19,1],[107,2],[107,2],[20,2],[20,2],[20,2],[109,2],[109,2],[111,2],[111,3],[115,1],[115,1],[115,1],[115,1],[113,1],[113,3],[112,2],[112,2],[112,4],[112,4],[112,4],[112,6],[112,6],[21,5],[21,7],[21,4],[21,6],[120,1],[120,2],[122,3],[122,4],[124,3],[124,5],[17,1],[17,3],[17,3],[17,3],[15,2],[15,2],[15,2],[15,2],[15,2],[15,2],[15,2],[15,2],[15,2],[15,3],[15,3],[15,3],[15,3],[15,3],[15,3],[15,3],[15,3],[15,3],[15,5],[15,4],[15,3]],performAction:function anonymous(yytext,yyleng,yylineno,yy,yystate,$$,_$){var $0=$$.length-1;switch(yystate){case 1:return this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Block);break;case 2:return this.$=$$[$0];break;case 3:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(yy.Block.wrap([$$[$0]]));break;case 4:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])($$[$0-2].push($$[$0]));break;case 5:this.$=$$[$0-1];break;case 6:this.$=$$[$0];break;case 7:this.$=$$[$0];break;case 8:this.$=$$[$0];break;case 9:this.$=$$[$0];break;case 10:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Literal($$[$0]));break;case 11:this.$=$$[$0];break;case 12:this.$=$$[$0];break;case 13:this.$=$$[$0];break;case 14:this.$=$$[$0];break;case 15:this.$=$$[$0];break;case 16:this.$=$$[$0];break;case 17:this.$=$$[$0];break;case 18:this.$=$$[$0];break;case 19:this.$=$$[$0];break;case 20:this.$=$$[$0];break;case 21:this.$=$$[$0];break;case 22:this.$=$$[$0];break;case 23:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Block);break;case 24:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])($$[$0-1]);break;case 25:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Literal($$[$0]));break;case 26:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Literal($$[$0]));break;case 27:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Literal($$[$0]));break;case 28:this.$=$$[$0];break;case 29:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Literal($$[$0]));break;case 30:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Literal($$[$0]));break;case 31:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Literal($$[$0]));break;case 32:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Undefined);break;case 33:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Null);break;case 34:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Bool($$[$0]));break;case 35:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Assign($$[$0-2],$$[$0]));break;case 36:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])(new yy.Assign($$[$0-3],$$[$0]));break;case 37:this.$=yy.addLocationDataFn(_$[$0-4],_$[$0])(new yy.Assign($$[$0-4],$$[$0-1]));break;case 38:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Value($$[$0]));break;case 39:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Assign(yy.addLocationDataFn(_$[$0-2])(new yy.Value($$[$0-2])),$$[$0],"object"));break;case 40:this.$=yy.addLocationDataFn(_$[$0-4],_$[$0])(new yy.Assign(yy.addLocationDataFn(_$[$0-4])(new yy.Value($$[$0-4])),$$[$0-1],"object"));break;case 41:this.$=$$[$0];break;case 42:this.$=$$[$0];break;case 43:this.$=$$[$0];break;case 44:this.$=$$[$0];break;case 45:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Return($$[$0]));break;case 46:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Return);break;case 47:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Comment($$[$0]));break;case 48:this.$=yy.addLocationDataFn(_$[$0-4],_$[$0])(new yy.Code($$[$0-3],$$[$0],$$[$0-1]));break;case 49:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Code([],$$[$0],$$[$0-1]));break;case 50:this.$=yy.addLocationDataFn(_$[$0],_$[$0])("func");break;case 51:this.$=yy.addLocationDataFn(_$[$0],_$[$0])("boundfunc");break;case 52:this.$=$$[$0];break;case 53:this.$=$$[$0];break;case 54:this.$=yy.addLocationDataFn(_$[$0],_$[$0])([]);break;case 55:this.$=yy.addLocationDataFn(_$[$0],_$[$0])([$$[$0]]);break;case 56:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])($$[$0-2].concat($$[$0]));break;case 57:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])($$[$0-3].concat($$[$0]));break;case 58:this.$=yy.addLocationDataFn(_$[$0-5],_$[$0])($$[$0-5].concat($$[$0-2]));break;case 59:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Param($$[$0]));break;case 60:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Param($$[$0-1],null,true));break;case 61:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Param($$[$0-2],$$[$0]));break;case 62:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Expansion);break;case 63:this.$=$$[$0];break;case 64:this.$=$$[$0];break;case 65:this.$=$$[$0];break;case 66:this.$=$$[$0];break;case 67:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Splat($$[$0-1]));break;case 68:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Value($$[$0]));break;case 69:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])($$[$0-1].add($$[$0]));break;case 70:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Value($$[$0-1],[].concat($$[$0])));break;case 71:this.$=$$[$0];break;case 72:this.$=$$[$0];break;case 73:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Value($$[$0]));break;case 74:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Value($$[$0]));break;case 75:this.$=$$[$0];break;case 76:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Value($$[$0]));break;case 77:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Value($$[$0]));break;case 78:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Value($$[$0]));break;case 79:this.$=$$[$0];break;case 80:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Access($$[$0]));break;case 81:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Access($$[$0],"soak"));break;case 82:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])([yy.addLocationDataFn(_$[$0-1])(new yy.Access(new yy.Literal("prototype"))),yy.addLocationDataFn(_$[$0])(new yy.Access($$[$0]))]);break;case 83:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])([yy.addLocationDataFn(_$[$0-1])(new yy.Access(new yy.Literal("prototype"),"soak")),yy.addLocationDataFn(_$[$0])(new yy.Access($$[$0]))]);break;case 84:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Access(new yy.Literal("prototype")));break;case 85:this.$=$$[$0];break;case 86:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])($$[$0-1]);break;case 87:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(yy.extend($$[$0],{soak:true}));break;case 88:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Index($$[$0]));break;case 89:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Slice($$[$0]));break;case 90:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])(new yy.Obj($$[$0-2],$$[$0-3].generated));break;case 91:this.$=yy.addLocationDataFn(_$[$0],_$[$0])([]);break;case 92:this.$=yy.addLocationDataFn(_$[$0],_$[$0])([$$[$0]]);break;case 93:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])($$[$0-2].concat($$[$0]));break;case 94:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])($$[$0-3].concat($$[$0]));break;case 95:this.$=yy.addLocationDataFn(_$[$0-5],_$[$0])($$[$0-5].concat($$[$0-2]));break;case 96:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Class);break;case 97:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Class(null,null,$$[$0]));break;case 98:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Class(null,$$[$0]));break;case 99:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])(new yy.Class(null,$$[$0-1],$$[$0]));break;case 100:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Class($$[$0]));break;case 101:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Class($$[$0-1],null,$$[$0]));break;case 102:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])(new yy.Class($$[$0-2],$$[$0]));break;case 103:this.$=yy.addLocationDataFn(_$[$0-4],_$[$0])(new yy.Class($$[$0-3],$$[$0-1],$$[$0]));break;case 104:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Call($$[$0-2],$$[$0],$$[$0-1]));break;case 105:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Call($$[$0-2],$$[$0],$$[$0-1]));break;case 106:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Call("super",[new yy.Splat(new yy.Literal("arguments"))]));break;case 107:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Call("super",$$[$0]));break;case 108:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(false);break;case 109:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(true);break;case 110:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])([]);break;case 111:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])($$[$0-2]);break;case 112:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Value(new yy.Literal("this")));break;case 113:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Value(new yy.Literal("this")));break;case 114:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Value(yy.addLocationDataFn(_$[$0-1])(new yy.Literal("this")),[yy.addLocationDataFn(_$[$0])(new yy.Access($$[$0]))],"this"));break;case 115:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Arr([]));break;case 116:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])(new yy.Arr($$[$0-2]));break;case 117:this.$=yy.addLocationDataFn(_$[$0],_$[$0])("inclusive");break;case 118:this.$=yy.addLocationDataFn(_$[$0],_$[$0])("exclusive");break;case 119:this.$=yy.addLocationDataFn(_$[$0-4],_$[$0])(new yy.Range($$[$0-3],$$[$0-1],$$[$0-2]));break;case 120:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Range($$[$0-2],$$[$0],$$[$0-1]));break;case 121:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Range($$[$0-1],null,$$[$0]));break;case 122:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Range(null,$$[$0],$$[$0-1]));break;case 123:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Range(null,null,$$[$0]));break;case 124:this.$=yy.addLocationDataFn(_$[$0],_$[$0])([$$[$0]]);break;case 125:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])($$[$0-2].concat($$[$0]));break;case 126:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])($$[$0-3].concat($$[$0]));break;case 127:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])($$[$0-2]);break;case 128:this.$=yy.addLocationDataFn(_$[$0-5],_$[$0])($$[$0-5].concat($$[$0-2]));break;case 129:this.$=$$[$0];break;case 130:this.$=$$[$0];break;case 131:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Expansion);break;case 132:this.$=$$[$0];break;case 133:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])([].concat($$[$0-2],$$[$0]));break;case 134:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Try($$[$0]));break;case 135:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Try($$[$0-1],$$[$0][0],$$[$0][1]));break;case 136:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])(new yy.Try($$[$0-2],null,null,$$[$0]));break;case 137:this.$=yy.addLocationDataFn(_$[$0-4],_$[$0])(new yy.Try($$[$0-3],$$[$0-2][0],$$[$0-2][1],$$[$0]));break;case 138:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])([$$[$0-1],$$[$0]]);break;case 139:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])([yy.addLocationDataFn(_$[$0-1])(new yy.Value($$[$0-1])),$$[$0]]);break;case 140:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])([null,$$[$0]]);break;case 141:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Throw($$[$0]));break;case 142:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Parens($$[$0-1]));break;case 143:this.$=yy.addLocationDataFn(_$[$0-4],_$[$0])(new yy.Parens($$[$0-2]));break;case 144:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.While($$[$0]));break;case 145:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])(new yy.While($$[$0-2],{guard:$$[$0]}));break;case 146:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.While($$[$0],{invert:true}));break;case 147:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])(new yy.While($$[$0-2],{invert:true,guard:$$[$0]}));break;case 148:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])($$[$0-1].addBody($$[$0]));break;case 149:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])($$[$0].addBody(yy.addLocationDataFn(_$[$0-1])(yy.Block.wrap([$$[$0-1]]))));break;case 150:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])($$[$0].addBody(yy.addLocationDataFn(_$[$0-1])(yy.Block.wrap([$$[$0-1]]))));break;case 151:this.$=yy.addLocationDataFn(_$[$0],_$[$0])($$[$0]);break;case 152:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.While(yy.addLocationDataFn(_$[$0-1])(new yy.Literal("true"))).addBody($$[$0]));break;case 153:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.While(yy.addLocationDataFn(_$[$0-1])(new yy.Literal("true"))).addBody(yy.addLocationDataFn(_$[$0])(yy.Block.wrap([$$[$0]]))));break;case 154:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.For($$[$0-1],$$[$0]));break;case 155:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.For($$[$0-1],$$[$0]));break;case 156:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.For($$[$0],$$[$0-1]));break;case 157:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])({source:yy.addLocationDataFn(_$[$0])(new yy.Value($$[$0]))});break;case 158:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(function(){$$[$0].own=$$[$0-1].own;$$[$0].name=$$[$0-1][0];$$[$0].index=$$[$0-1][1];return $$[$0]}());break;case 159:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])($$[$0]);break;case 160:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(function(){$$[$0].own=true;return $$[$0]}());break;case 161:this.$=$$[$0];break;case 162:this.$=$$[$0];break;case 163:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Value($$[$0]));break;case 164:this.$=yy.addLocationDataFn(_$[$0],_$[$0])(new yy.Value($$[$0]));break;case 165:this.$=yy.addLocationDataFn(_$[$0],_$[$0])([$$[$0]]);break;case 166:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])([$$[$0-2],$$[$0]]);break;case 167:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])({source:$$[$0]});break;case 168:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])({source:$$[$0],object:true});break;case 169:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])({source:$$[$0-2],guard:$$[$0]});break;case 170:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])({source:$$[$0-2],guard:$$[$0],object:true});break;case 171:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])({source:$$[$0-2],step:$$[$0]});break;case 172:this.$=yy.addLocationDataFn(_$[$0-5],_$[$0])({source:$$[$0-4],guard:$$[$0-2],step:$$[$0]});break;case 173:this.$=yy.addLocationDataFn(_$[$0-5],_$[$0])({source:$$[$0-4],step:$$[$0-2],guard:$$[$0]});break;case 174:this.$=yy.addLocationDataFn(_$[$0-4],_$[$0])(new yy.Switch($$[$0-3],$$[$0-1]));break;case 175:this.$=yy.addLocationDataFn(_$[$0-6],_$[$0])(new yy.Switch($$[$0-5],$$[$0-3],$$[$0-1]));break;case 176:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])(new yy.Switch(null,$$[$0-1]));break;case 177:this.$=yy.addLocationDataFn(_$[$0-5],_$[$0])(new yy.Switch(null,$$[$0-3],$$[$0-1]));break;case 178:this.$=$$[$0];break;case 179:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])($$[$0-1].concat($$[$0]));break;case 180:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])([[$$[$0-1],$$[$0]]]);break;case 181:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])([[$$[$0-2],$$[$0-1]]]);break;case 182:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.If($$[$0-1],$$[$0],{type:$$[$0-2]}));break;case 183:this.$=yy.addLocationDataFn(_$[$0-4],_$[$0])($$[$0-4].addElse(yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.If($$[$0-1],$$[$0],{type:$$[$0-2]}))));break;case 184:this.$=$$[$0];break;case 185:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])($$[$0-2].addElse($$[$0]));break;case 186:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.If($$[$0],yy.addLocationDataFn(_$[$0-2])(yy.Block.wrap([$$[$0-2]])),{type:$$[$0-1],statement:true}));break;case 187:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.If($$[$0],yy.addLocationDataFn(_$[$0-2])(yy.Block.wrap([$$[$0-2]])),{type:$$[$0-1],statement:true}));break;case 188:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Op($$[$0-1],$$[$0]));break;case 189:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Op($$[$0-1],$$[$0]));break;case 190:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Op("-",$$[$0]));break;case 191:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Op("+",$$[$0]));break;case 192:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Op("--",$$[$0]));break;case 193:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Op("++",$$[$0]));break;case 194:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Op("--",$$[$0-1],null,true));break;case 195:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Op("++",$$[$0-1],null,true));break;case 196:this.$=yy.addLocationDataFn(_$[$0-1],_$[$0])(new yy.Existence($$[$0-1]));break;case 197:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Op("+",$$[$0-2],$$[$0]));break;case 198:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Op("-",$$[$0-2],$$[$0]));break;case 199:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Op($$[$0-1],$$[$0-2],$$[$0]));break;case 200:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Op($$[$0-1],$$[$0-2],$$[$0]));break;case 201:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Op($$[$0-1],$$[$0-2],$$[$0]));break;case 202:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Op($$[$0-1],$$[$0-2],$$[$0]));break;case 203:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Op($$[$0-1],$$[$0-2],$$[$0]));break;case 204:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(function(){if($$[$0-1].charAt(0)==="!"){return new yy.Op($$[$0-1].slice(1),$$[$0-2],$$[$0]).invert()}else{return new yy.Op($$[$0-1],$$[$0-2],$$[$0])}}());break;case 205:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Assign($$[$0-2],$$[$0],$$[$0-1]));break;case 206:this.$=yy.addLocationDataFn(_$[$0-4],_$[$0])(new yy.Assign($$[$0-4],$$[$0-1],$$[$0-3]));break;case 207:this.$=yy.addLocationDataFn(_$[$0-3],_$[$0])(new yy.Assign($$[$0-3],$$[$0],$$[$0-2]));break;case 208:this.$=yy.addLocationDataFn(_$[$0-2],_$[$0])(new yy.Extends($$[$0-2],$$[$0]));break}},table:[{1:[2,1],3:1,4:2,5:3,7:4,8:5,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[3]},{1:[2,2],6:[1,73]},{1:[2,3],6:[2,3],26:[2,3],102:[2,3]},{1:[2,6],6:[2,6],26:[2,6],102:[2,6],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,7],6:[2,7],26:[2,7],102:[2,7],103:87,104:[1,64],106:[1,65],109:88,110:[1,67],111:68,126:[1,86]},{1:[2,11],6:[2,11],25:[2,11],26:[2,11],49:[2,11],54:[2,11],57:[2,11],62:90,66:[1,92],67:[1,93],68:[1,94],69:[1,95],70:96,71:[1,97],73:[2,11],74:[1,98],78:[2,11],81:89,84:[1,91],85:[2,108],86:[2,11],91:[2,11],93:[2,11],102:[2,11],104:[2,11],105:[2,11],106:[2,11],110:[2,11],118:[2,11],126:[2,11],129:[2,11],130:[2,11],133:[2,11],134:[2,11],135:[2,11],136:[2,11],137:[2,11],138:[2,11],139:[2,11]},{1:[2,12],6:[2,12],25:[2,12],26:[2,12],49:[2,12],54:[2,12],57:[2,12],62:100,66:[1,92],67:[1,93],68:[1,94],69:[1,95],70:96,71:[1,97],73:[2,12],74:[1,98],78:[2,12],81:99,84:[1,91],85:[2,108],86:[2,12],91:[2,12],93:[2,12],102:[2,12],104:[2,12],105:[2,12],106:[2,12],110:[2,12],118:[2,12],126:[2,12],129:[2,12],130:[2,12],133:[2,12],134:[2,12],135:[2,12],136:[2,12],137:[2,12],138:[2,12],139:[2,12]},{1:[2,13],6:[2,13],25:[2,13],26:[2,13],49:[2,13],54:[2,13],57:[2,13],73:[2,13],78:[2,13],86:[2,13],91:[2,13],93:[2,13],102:[2,13],104:[2,13],105:[2,13],106:[2,13],110:[2,13],118:[2,13],126:[2,13],129:[2,13],130:[2,13],133:[2,13],134:[2,13],135:[2,13],136:[2,13],137:[2,13],138:[2,13],139:[2,13]},{1:[2,14],6:[2,14],25:[2,14],26:[2,14],49:[2,14],54:[2,14],57:[2,14],73:[2,14],78:[2,14],86:[2,14],91:[2,14],93:[2,14],102:[2,14],104:[2,14],105:[2,14],106:[2,14],110:[2,14],118:[2,14],126:[2,14],129:[2,14],130:[2,14],133:[2,14],134:[2,14],135:[2,14],136:[2,14],137:[2,14],138:[2,14],139:[2,14]},{1:[2,15],6:[2,15],25:[2,15],26:[2,15],49:[2,15],54:[2,15],57:[2,15],73:[2,15],78:[2,15],86:[2,15],91:[2,15],93:[2,15],102:[2,15],104:[2,15],105:[2,15],106:[2,15],110:[2,15],118:[2,15],126:[2,15],129:[2,15],130:[2,15],133:[2,15],134:[2,15],135:[2,15],136:[2,15],137:[2,15],138:[2,15],139:[2,15]},{1:[2,16],6:[2,16],25:[2,16],26:[2,16],49:[2,16],54:[2,16],57:[2,16],73:[2,16],78:[2,16],86:[2,16],91:[2,16],93:[2,16],102:[2,16],104:[2,16],105:[2,16],106:[2,16],110:[2,16],118:[2,16],126:[2,16],129:[2,16],130:[2,16],133:[2,16],134:[2,16],135:[2,16],136:[2,16],137:[2,16],138:[2,16],139:[2,16]},{1:[2,17],6:[2,17],25:[2,17],26:[2,17],49:[2,17],54:[2,17],57:[2,17],73:[2,17],78:[2,17],86:[2,17],91:[2,17],93:[2,17],102:[2,17],104:[2,17],105:[2,17],106:[2,17],110:[2,17],118:[2,17],126:[2,17],129:[2,17],130:[2,17],133:[2,17],134:[2,17],135:[2,17],136:[2,17],137:[2,17],138:[2,17],139:[2,17]},{1:[2,18],6:[2,18],25:[2,18],26:[2,18],49:[2,18],54:[2,18],57:[2,18],73:[2,18],78:[2,18],86:[2,18],91:[2,18],93:[2,18],102:[2,18],104:[2,18],105:[2,18],106:[2,18],110:[2,18],118:[2,18],126:[2,18],129:[2,18],130:[2,18],133:[2,18],134:[2,18],135:[2,18],136:[2,18],137:[2,18],138:[2,18],139:[2,18]},{1:[2,19],6:[2,19],25:[2,19],26:[2,19],49:[2,19],54:[2,19],57:[2,19],73:[2,19],78:[2,19],86:[2,19],91:[2,19],93:[2,19],102:[2,19],104:[2,19],105:[2,19],106:[2,19],110:[2,19],118:[2,19],126:[2,19],129:[2,19],130:[2,19],133:[2,19],134:[2,19],135:[2,19],136:[2,19],137:[2,19],138:[2,19],139:[2,19]},{1:[2,20],6:[2,20],25:[2,20],26:[2,20],49:[2,20],54:[2,20],57:[2,20],73:[2,20],78:[2,20],86:[2,20],91:[2,20],93:[2,20],102:[2,20],104:[2,20],105:[2,20],106:[2,20],110:[2,20],118:[2,20],126:[2,20],129:[2,20],130:[2,20],133:[2,20],134:[2,20],135:[2,20],136:[2,20],137:[2,20],138:[2,20],139:[2,20]},{1:[2,21],6:[2,21],25:[2,21],26:[2,21],49:[2,21],54:[2,21],57:[2,21],73:[2,21],78:[2,21],86:[2,21],91:[2,21],93:[2,21],102:[2,21],104:[2,21],105:[2,21],106:[2,21],110:[2,21],118:[2,21],126:[2,21],129:[2,21],130:[2,21],133:[2,21],134:[2,21],135:[2,21],136:[2,21],137:[2,21],138:[2,21],139:[2,21]},{1:[2,22],6:[2,22],25:[2,22],26:[2,22],49:[2,22],54:[2,22],57:[2,22],73:[2,22],78:[2,22],86:[2,22],91:[2,22],93:[2,22],102:[2,22],104:[2,22],105:[2,22],106:[2,22],110:[2,22],118:[2,22],126:[2,22],129:[2,22],130:[2,22],133:[2,22],134:[2,22],135:[2,22],136:[2,22],137:[2,22],138:[2,22],139:[2,22]},{1:[2,8],6:[2,8],26:[2,8],102:[2,8],104:[2,8],106:[2,8],110:[2,8],126:[2,8]},{1:[2,9],6:[2,9],26:[2,9],102:[2,9],104:[2,9],106:[2,9],110:[2,9],126:[2,9]},{1:[2,10],6:[2,10],26:[2,10],102:[2,10],104:[2,10],106:[2,10],110:[2,10],126:[2,10]},{1:[2,75],6:[2,75],25:[2,75],26:[2,75],40:[1,101],49:[2,75],54:[2,75],57:[2,75],66:[2,75],67:[2,75],68:[2,75],69:[2,75],71:[2,75],73:[2,75],74:[2,75],78:[2,75],84:[2,75],85:[2,75],86:[2,75],91:[2,75],93:[2,75],102:[2,75],104:[2,75],105:[2,75],106:[2,75],110:[2,75],118:[2,75],126:[2,75],129:[2,75],130:[2,75],133:[2,75],134:[2,75],135:[2,75],136:[2,75],137:[2,75],138:[2,75],139:[2,75]},{1:[2,76],6:[2,76],25:[2,76],26:[2,76],49:[2,76],54:[2,76],57:[2,76],66:[2,76],67:[2,76],68:[2,76],69:[2,76],71:[2,76],73:[2,76],74:[2,76],78:[2,76],84:[2,76],85:[2,76],86:[2,76],91:[2,76],93:[2,76],102:[2,76],104:[2,76],105:[2,76],106:[2,76],110:[2,76],118:[2,76],126:[2,76],129:[2,76],130:[2,76],133:[2,76],134:[2,76],135:[2,76],136:[2,76],137:[2,76],138:[2,76],139:[2,76]},{1:[2,77],6:[2,77],25:[2,77],26:[2,77],49:[2,77],54:[2,77],57:[2,77],66:[2,77],67:[2,77],68:[2,77],69:[2,77],71:[2,77],73:[2,77],74:[2,77],78:[2,77],84:[2,77],85:[2,77],86:[2,77],91:[2,77],93:[2,77],102:[2,77],104:[2,77],105:[2,77],106:[2,77],110:[2,77],118:[2,77],126:[2,77],129:[2,77],130:[2,77],133:[2,77],134:[2,77],135:[2,77],136:[2,77],137:[2,77],138:[2,77],139:[2,77]},{1:[2,78],6:[2,78],25:[2,78],26:[2,78],49:[2,78],54:[2,78],57:[2,78],66:[2,78],67:[2,78],68:[2,78],69:[2,78],71:[2,78],73:[2,78],74:[2,78],78:[2,78],84:[2,78],85:[2,78],86:[2,78],91:[2,78],93:[2,78],102:[2,78],104:[2,78],105:[2,78],106:[2,78],110:[2,78],118:[2,78],126:[2,78],129:[2,78],130:[2,78],133:[2,78],134:[2,78],135:[2,78],136:[2,78],137:[2,78],138:[2,78],139:[2,78]},{1:[2,79],6:[2,79],25:[2,79],26:[2,79],49:[2,79],54:[2,79],57:[2,79],66:[2,79],67:[2,79],68:[2,79],69:[2,79],71:[2,79],73:[2,79],74:[2,79],78:[2,79],84:[2,79],85:[2,79],86:[2,79],91:[2,79],93:[2,79],102:[2,79],104:[2,79],105:[2,79],106:[2,79],110:[2,79],118:[2,79],126:[2,79],129:[2,79],130:[2,79],133:[2,79],134:[2,79],135:[2,79],136:[2,79],137:[2,79],138:[2,79],139:[2,79]},{1:[2,106],6:[2,106],25:[2,106],26:[2,106],49:[2,106],54:[2,106],57:[2,106],66:[2,106],67:[2,106],68:[2,106],69:[2,106],71:[2,106],73:[2,106],74:[2,106],78:[2,106],82:102,84:[2,106],85:[1,103],86:[2,106],91:[2,106],93:[2,106],102:[2,106],104:[2,106],105:[2,106],106:[2,106],110:[2,106],118:[2,106],126:[2,106],129:[2,106],130:[2,106],133:[2,106],134:[2,106],135:[2,106],136:[2,106],137:[2,106],138:[2,106],139:[2,106]},{6:[2,54],25:[2,54],27:108,28:[1,72],44:109,48:104,49:[2,54],54:[2,54],55:105,56:106,57:[1,107],58:110,59:111,76:[1,69],89:[1,112],90:[1,113]},{24:114,25:[1,115]},{7:116,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:118,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:119,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:120,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{12:122,13:123,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:124,44:62,58:46,59:47,61:121,63:23,64:24,65:25,76:[1,69],83:[1,26],88:[1,57],89:[1,58],90:[1,56],101:[1,55]},{12:122,13:123,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:124,44:62,58:46,59:47,61:125,63:23,64:24,65:25,76:[1,69],83:[1,26],88:[1,57],89:[1,58],90:[1,56],101:[1,55]},{1:[2,72],6:[2,72],25:[2,72],26:[2,72],40:[2,72],49:[2,72],54:[2,72],57:[2,72],66:[2,72],67:[2,72],68:[2,72],69:[2,72],71:[2,72],73:[2,72],74:[2,72],78:[2,72],80:[1,129],84:[2,72],85:[2,72],86:[2,72],91:[2,72],93:[2,72],102:[2,72],104:[2,72],105:[2,72],106:[2,72],110:[2,72],118:[2,72],126:[2,72],129:[2,72],130:[2,72],131:[1,126],132:[1,127],133:[2,72],134:[2,72],135:[2,72],136:[2,72],137:[2,72],138:[2,72],139:[2,72],140:[1,128]},{1:[2,184],6:[2,184],25:[2,184],26:[2,184],49:[2,184],54:[2,184],57:[2,184],73:[2,184],78:[2,184],86:[2,184],91:[2,184],93:[2,184],102:[2,184],104:[2,184],105:[2,184],106:[2,184],110:[2,184],118:[2,184],121:[1,130],126:[2,184],129:[2,184],130:[2,184],133:[2,184],134:[2,184],135:[2,184],136:[2,184],137:[2,184],138:[2,184],139:[2,184]},{24:131,25:[1,115]},{24:132,25:[1,115]},{1:[2,151],6:[2,151],25:[2,151],26:[2,151],49:[2,151],54:[2,151],57:[2,151],73:[2,151],78:[2,151],86:[2,151],91:[2,151],93:[2,151],102:[2,151],104:[2,151],105:[2,151],106:[2,151],110:[2,151],118:[2,151],126:[2,151],129:[2,151],130:[2,151],133:[2,151],134:[2,151],135:[2,151],136:[2,151],137:[2,151],138:[2,151],139:[2,151]},{24:133,25:[1,115]},{7:134,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,25:[1,135],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,96],6:[2,96],12:122,13:123,24:136,25:[1,115],26:[2,96],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:124,44:62,49:[2,96],54:[2,96],57:[2,96],58:46,59:47,61:138,63:23,64:24,65:25,73:[2,96],76:[1,69],78:[2,96],80:[1,137],83:[1,26],86:[2,96],88:[1,57],89:[1,58],90:[1,56],91:[2,96],93:[2,96],101:[1,55],102:[2,96],104:[2,96],105:[2,96],106:[2,96],110:[2,96],118:[2,96],126:[2,96],129:[2,96],130:[2,96],133:[2,96],134:[2,96],135:[2,96],136:[2,96],137:[2,96],138:[2,96],139:[2,96]},{7:139,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,46],6:[2,46],7:140,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,26:[2,46],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],102:[2,46],103:38,104:[2,46],106:[2,46],107:39,108:[1,66],109:40,110:[2,46],111:68,119:[1,41],124:36,125:[1,63],126:[2,46],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,47],6:[2,47],25:[2,47],26:[2,47],54:[2,47],78:[2,47],102:[2,47],104:[2,47],106:[2,47],110:[2,47],126:[2,47]},{1:[2,73],6:[2,73],25:[2,73],26:[2,73],40:[2,73],49:[2,73],54:[2,73],57:[2,73],66:[2,73],67:[2,73],68:[2,73],69:[2,73],71:[2,73],73:[2,73],74:[2,73],78:[2,73],84:[2,73],85:[2,73],86:[2,73],91:[2,73],93:[2,73],102:[2,73],104:[2,73],105:[2,73],106:[2,73],110:[2,73],118:[2,73],126:[2,73],129:[2,73],130:[2,73],133:[2,73],134:[2,73],135:[2,73],136:[2,73],137:[2,73],138:[2,73],139:[2,73]},{1:[2,74],6:[2,74],25:[2,74],26:[2,74],40:[2,74],49:[2,74],54:[2,74],57:[2,74],66:[2,74],67:[2,74],68:[2,74],69:[2,74],71:[2,74],73:[2,74],74:[2,74],78:[2,74],84:[2,74],85:[2,74],86:[2,74],91:[2,74],93:[2,74],102:[2,74],104:[2,74],105:[2,74],106:[2,74],110:[2,74],118:[2,74],126:[2,74],129:[2,74],130:[2,74],133:[2,74],134:[2,74],135:[2,74],136:[2,74],137:[2,74],138:[2,74],139:[2,74]},{1:[2,28],6:[2,28],25:[2,28],26:[2,28],49:[2,28],54:[2,28],57:[2,28],66:[2,28],67:[2,28],68:[2,28],69:[2,28],71:[2,28],73:[2,28],74:[2,28],78:[2,28],84:[2,28],85:[2,28],86:[2,28],91:[2,28],93:[2,28],102:[2,28],104:[2,28],105:[2,28],106:[2,28],110:[2,28],118:[2,28],126:[2,28],129:[2,28],130:[2,28],133:[2,28],134:[2,28],135:[2,28],136:[2,28],137:[2,28],138:[2,28],139:[2,28]},{1:[2,29],6:[2,29],25:[2,29],26:[2,29],49:[2,29],54:[2,29],57:[2,29],66:[2,29],67:[2,29],68:[2,29],69:[2,29],71:[2,29],73:[2,29],74:[2,29],78:[2,29],84:[2,29],85:[2,29],86:[2,29],91:[2,29],93:[2,29],102:[2,29],104:[2,29],105:[2,29],106:[2,29],110:[2,29],118:[2,29],126:[2,29],129:[2,29],130:[2,29],133:[2,29],134:[2,29],135:[2,29],136:[2,29],137:[2,29],138:[2,29],139:[2,29]},{1:[2,30],6:[2,30],25:[2,30],26:[2,30],49:[2,30],54:[2,30],57:[2,30],66:[2,30],67:[2,30],68:[2,30],69:[2,30],71:[2,30],73:[2,30],74:[2,30],78:[2,30],84:[2,30],85:[2,30],86:[2,30],91:[2,30],93:[2,30],102:[2,30],104:[2,30],105:[2,30],106:[2,30],110:[2,30],118:[2,30],126:[2,30],129:[2,30],130:[2,30],133:[2,30],134:[2,30],135:[2,30],136:[2,30],137:[2,30],138:[2,30],139:[2,30]},{1:[2,31],6:[2,31],25:[2,31],26:[2,31],49:[2,31],54:[2,31],57:[2,31],66:[2,31],67:[2,31],68:[2,31],69:[2,31],71:[2,31],73:[2,31],74:[2,31],78:[2,31],84:[2,31],85:[2,31],86:[2,31],91:[2,31],93:[2,31],102:[2,31],104:[2,31],105:[2,31],106:[2,31],110:[2,31],118:[2,31],126:[2,31],129:[2,31],130:[2,31],133:[2,31],134:[2,31],135:[2,31],136:[2,31],137:[2,31],138:[2,31],139:[2,31]},{1:[2,32],6:[2,32],25:[2,32],26:[2,32],49:[2,32],54:[2,32],57:[2,32],66:[2,32],67:[2,32],68:[2,32],69:[2,32],71:[2,32],73:[2,32],74:[2,32],78:[2,32],84:[2,32],85:[2,32],86:[2,32],91:[2,32],93:[2,32],102:[2,32],104:[2,32],105:[2,32],106:[2,32],110:[2,32],118:[2,32],126:[2,32],129:[2,32],130:[2,32],133:[2,32],134:[2,32],135:[2,32],136:[2,32],137:[2,32],138:[2,32],139:[2,32]},{1:[2,33],6:[2,33],25:[2,33],26:[2,33],49:[2,33],54:[2,33],57:[2,33],66:[2,33],67:[2,33],68:[2,33],69:[2,33],71:[2,33],73:[2,33],74:[2,33],78:[2,33],84:[2,33],85:[2,33],86:[2,33],91:[2,33],93:[2,33],102:[2,33],104:[2,33],105:[2,33],106:[2,33],110:[2,33],118:[2,33],126:[2,33],129:[2,33],130:[2,33],133:[2,33],134:[2,33],135:[2,33],136:[2,33],137:[2,33],138:[2,33],139:[2,33]},{1:[2,34],6:[2,34],25:[2,34],26:[2,34],49:[2,34],54:[2,34],57:[2,34],66:[2,34],67:[2,34],68:[2,34],69:[2,34],71:[2,34],73:[2,34],74:[2,34],78:[2,34],84:[2,34],85:[2,34],86:[2,34],91:[2,34],93:[2,34],102:[2,34],104:[2,34],105:[2,34],106:[2,34],110:[2,34],118:[2,34],126:[2,34],129:[2,34],130:[2,34],133:[2,34],134:[2,34],135:[2,34],136:[2,34],137:[2,34],138:[2,34],139:[2,34]},{4:141,5:3,7:4,8:5,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,25:[1,142],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:143,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,25:[1,147],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],57:[1,149],58:46,59:47,60:148,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],87:145,88:[1,57],89:[1,58],90:[1,56],91:[1,144],94:146,96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,112],6:[2,112],25:[2,112],26:[2,112],49:[2,112],54:[2,112],57:[2,112],66:[2,112],67:[2,112],68:[2,112],69:[2,112],71:[2,112],73:[2,112],74:[2,112],78:[2,112],84:[2,112],85:[2,112],86:[2,112],91:[2,112],93:[2,112],102:[2,112],104:[2,112],105:[2,112],106:[2,112],110:[2,112],118:[2,112],126:[2,112],129:[2,112],130:[2,112],133:[2,112],134:[2,112],135:[2,112],136:[2,112],137:[2,112],138:[2,112],139:[2,112]},{1:[2,113],6:[2,113],25:[2,113],26:[2,113],27:150,28:[1,72],49:[2,113],54:[2,113],57:[2,113],66:[2,113],67:[2,113],68:[2,113],69:[2,113],71:[2,113],73:[2,113],74:[2,113],78:[2,113],84:[2,113],85:[2,113],86:[2,113],91:[2,113],93:[2,113],102:[2,113],104:[2,113],105:[2,113],106:[2,113],110:[2,113],118:[2,113],126:[2,113],129:[2,113],130:[2,113],133:[2,113],134:[2,113],135:[2,113],136:[2,113],137:[2,113],138:[2,113],139:[2,113]},{25:[2,50]},{25:[2,51]},{1:[2,68],6:[2,68],25:[2,68],26:[2,68],40:[2,68],49:[2,68],54:[2,68],57:[2,68],66:[2,68],67:[2,68],68:[2,68],69:[2,68],71:[2,68],73:[2,68],74:[2,68],78:[2,68],80:[2,68],84:[2,68],85:[2,68],86:[2,68],91:[2,68],93:[2,68],102:[2,68],104:[2,68],105:[2,68],106:[2,68],110:[2,68],118:[2,68],126:[2,68],129:[2,68],130:[2,68],131:[2,68],132:[2,68],133:[2,68],134:[2,68],135:[2,68],136:[2,68],137:[2,68],138:[2,68],139:[2,68],140:[2,68]},{1:[2,71],6:[2,71],25:[2,71],26:[2,71],40:[2,71],49:[2,71],54:[2,71],57:[2,71],66:[2,71],67:[2,71],68:[2,71],69:[2,71],71:[2,71],73:[2,71],74:[2,71],78:[2,71],80:[2,71],84:[2,71],85:[2,71],86:[2,71],91:[2,71],93:[2,71],102:[2,71],104:[2,71],105:[2,71],106:[2,71],110:[2,71],118:[2,71],126:[2,71],129:[2,71],130:[2,71],131:[2,71],132:[2,71],133:[2,71],134:[2,71],135:[2,71],136:[2,71],137:[2,71],138:[2,71],139:[2,71],140:[2,71]},{7:151,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:152,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:153,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:155,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,24:154,25:[1,115],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{27:160,28:[1,72],44:161,58:162,59:163,64:156,76:[1,69],89:[1,112],90:[1,56],113:157,114:[1,158],115:159},{112:164,116:[1,165],117:[1,166]},{6:[2,91],10:170,25:[2,91],27:171,28:[1,72],29:172,30:[1,70],31:[1,71],41:168,42:169,44:173,46:[1,45],54:[2,91],77:167,78:[2,91],89:[1,112]},{1:[2,26],6:[2,26],25:[2,26],26:[2,26],43:[2,26],49:[2,26],54:[2,26],57:[2,26],66:[2,26],67:[2,26],68:[2,26],69:[2,26],71:[2,26],73:[2,26],74:[2,26],78:[2,26],84:[2,26],85:[2,26],86:[2,26],91:[2,26],93:[2,26],102:[2,26],104:[2,26],105:[2,26],106:[2,26],110:[2,26],118:[2,26],126:[2,26],129:[2,26],130:[2,26],133:[2,26],134:[2,26],135:[2,26],136:[2,26],137:[2,26],138:[2,26],139:[2,26]},{1:[2,27],6:[2,27],25:[2,27],26:[2,27],43:[2,27],49:[2,27],54:[2,27],57:[2,27],66:[2,27],67:[2,27],68:[2,27],69:[2,27],71:[2,27],73:[2,27],74:[2,27],78:[2,27],84:[2,27],85:[2,27],86:[2,27],91:[2,27],93:[2,27],102:[2,27],104:[2,27],105:[2,27],106:[2,27],110:[2,27],118:[2,27],126:[2,27],129:[2,27],130:[2,27],133:[2,27],134:[2,27],135:[2,27],136:[2,27],137:[2,27],138:[2,27],139:[2,27]},{1:[2,25],6:[2,25],25:[2,25],26:[2,25],40:[2,25],43:[2,25],49:[2,25],54:[2,25],57:[2,25],66:[2,25],67:[2,25],68:[2,25],69:[2,25],71:[2,25],73:[2,25],74:[2,25],78:[2,25],80:[2,25],84:[2,25],85:[2,25],86:[2,25],91:[2,25],93:[2,25],102:[2,25],104:[2,25],105:[2,25],106:[2,25],110:[2,25],116:[2,25],117:[2,25],118:[2,25],126:[2,25],129:[2,25],130:[2,25],131:[2,25],132:[2,25],133:[2,25],134:[2,25],135:[2,25],136:[2,25],137:[2,25],138:[2,25],139:[2,25],140:[2,25]},{1:[2,5],5:174,6:[2,5],7:4,8:5,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,26:[2,5],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],102:[2,5],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,196],6:[2,196],25:[2,196],26:[2,196],49:[2,196],54:[2,196],57:[2,196],73:[2,196],78:[2,196],86:[2,196],91:[2,196],93:[2,196],102:[2,196],104:[2,196],105:[2,196],106:[2,196],110:[2,196],118:[2,196],126:[2,196],129:[2,196],130:[2,196],133:[2,196],134:[2,196],135:[2,196],136:[2,196],137:[2,196],138:[2,196],139:[2,196]},{7:175,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:176,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:177,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:178,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:179,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:180,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:181,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:182,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:183,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,150],6:[2,150],25:[2,150],26:[2,150],49:[2,150],54:[2,150],57:[2,150],73:[2,150],78:[2,150],86:[2,150],91:[2,150],93:[2,150],102:[2,150],104:[2,150],105:[2,150],106:[2,150],110:[2,150],118:[2,150],126:[2,150],129:[2,150],130:[2,150],133:[2,150],134:[2,150],135:[2,150],136:[2,150],137:[2,150],138:[2,150],139:[2,150]},{1:[2,155],6:[2,155],25:[2,155],26:[2,155],49:[2,155],54:[2,155],57:[2,155],73:[2,155],78:[2,155],86:[2,155],91:[2,155],93:[2,155],102:[2,155],104:[2,155],105:[2,155],106:[2,155],110:[2,155],118:[2,155],126:[2,155],129:[2,155],130:[2,155],133:[2,155],134:[2,155],135:[2,155],136:[2,155],137:[2,155],138:[2,155],139:[2,155]},{7:184,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,149],6:[2,149],25:[2,149],26:[2,149],49:[2,149],54:[2,149],57:[2,149],73:[2,149],78:[2,149],86:[2,149],91:[2,149],93:[2,149],102:[2,149],104:[2,149],105:[2,149],106:[2,149],110:[2,149],118:[2,149],126:[2,149],129:[2,149],130:[2,149],133:[2,149],134:[2,149],135:[2,149],136:[2,149],137:[2,149],138:[2,149],139:[2,149]},{1:[2,154],6:[2,154],25:[2,154],26:[2,154],49:[2,154],54:[2,154],57:[2,154],73:[2,154],78:[2,154],86:[2,154],91:[2,154],93:[2,154],102:[2,154],104:[2,154],105:[2,154],106:[2,154],110:[2,154],118:[2,154],126:[2,154],129:[2,154],130:[2,154],133:[2,154],134:[2,154],135:[2,154],136:[2,154],137:[2,154],138:[2,154],139:[2,154]},{82:185,85:[1,103]},{1:[2,69],6:[2,69],25:[2,69],26:[2,69],40:[2,69],49:[2,69],54:[2,69],57:[2,69],66:[2,69],67:[2,69],68:[2,69],69:[2,69],71:[2,69],73:[2,69],74:[2,69],78:[2,69],80:[2,69],84:[2,69],85:[2,69],86:[2,69],91:[2,69],93:[2,69],102:[2,69],104:[2,69],105:[2,69],106:[2,69],110:[2,69],118:[2,69],126:[2,69],129:[2,69],130:[2,69],131:[2,69],132:[2,69],133:[2,69],134:[2,69],135:[2,69],136:[2,69],137:[2,69],138:[2,69],139:[2,69],140:[2,69]},{85:[2,109]},{27:186,28:[1,72]},{27:187,28:[1,72]},{1:[2,84],6:[2,84],25:[2,84],26:[2,84],27:188,28:[1,72],40:[2,84],49:[2,84],54:[2,84],57:[2,84],66:[2,84],67:[2,84],68:[2,84],69:[2,84],71:[2,84],73:[2,84],74:[2,84],78:[2,84],80:[2,84],84:[2,84],85:[2,84],86:[2,84],91:[2,84],93:[2,84],102:[2,84],104:[2,84],105:[2,84],106:[2,84],110:[2,84],118:[2,84],126:[2,84],129:[2,84],130:[2,84],131:[2,84],132:[2,84],133:[2,84],134:[2,84],135:[2,84],136:[2,84],137:[2,84],138:[2,84],139:[2,84],140:[2,84]},{27:189,28:[1,72]},{1:[2,85],6:[2,85],25:[2,85],26:[2,85],40:[2,85],49:[2,85],54:[2,85],57:[2,85],66:[2,85],67:[2,85],68:[2,85],69:[2,85],71:[2,85],73:[2,85],74:[2,85],78:[2,85],80:[2,85],84:[2,85],85:[2,85],86:[2,85],91:[2,85],93:[2,85],102:[2,85],104:[2,85],105:[2,85],106:[2,85],110:[2,85],118:[2,85],126:[2,85],129:[2,85],130:[2,85],131:[2,85],132:[2,85],133:[2,85],134:[2,85],135:[2,85],136:[2,85],137:[2,85],138:[2,85],139:[2,85],140:[2,85]},{7:191,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],57:[1,195],58:46,59:47,61:35,63:23,64:24,65:25,72:190,75:192,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],92:193,93:[1,194],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{70:196,71:[1,97],74:[1,98]},{82:197,85:[1,103]},{1:[2,70],6:[2,70],25:[2,70],26:[2,70],40:[2,70],49:[2,70],54:[2,70],57:[2,70],66:[2,70],67:[2,70],68:[2,70],69:[2,70],71:[2,70],73:[2,70],74:[2,70],78:[2,70],80:[2,70],84:[2,70],85:[2,70],86:[2,70],91:[2,70],93:[2,70],102:[2,70],104:[2,70],105:[2,70],106:[2,70],110:[2,70],118:[2,70],126:[2,70],129:[2,70],130:[2,70],131:[2,70],132:[2,70],133:[2,70],134:[2,70],135:[2,70],136:[2,70],137:[2,70],138:[2,70],139:[2,70],140:[2,70]},{6:[1,199],7:198,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,25:[1,200],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,107],6:[2,107],25:[2,107],26:[2,107],49:[2,107],54:[2,107],57:[2,107],66:[2,107],67:[2,107],68:[2,107],69:[2,107],71:[2,107],73:[2,107],74:[2,107],78:[2,107],84:[2,107],85:[2,107],86:[2,107],91:[2,107],93:[2,107],102:[2,107],104:[2,107],105:[2,107],106:[2,107],110:[2,107],118:[2,107],126:[2,107],129:[2,107],130:[2,107],133:[2,107],134:[2,107],135:[2,107],136:[2,107],137:[2,107],138:[2,107],139:[2,107]},{7:203,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,25:[1,147],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],57:[1,149],58:46,59:47,60:148,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],86:[1,201],87:202,88:[1,57],89:[1,58],90:[1,56],94:146,96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{6:[2,52],25:[2,52],49:[1,204],53:206,54:[1,205]},{6:[2,55],25:[2,55],26:[2,55],49:[2,55],54:[2,55]},{6:[2,59],25:[2,59],26:[2,59],40:[1,208],49:[2,59],54:[2,59],57:[1,207]},{6:[2,62],25:[2,62],26:[2,62],49:[2,62],54:[2,62]},{6:[2,63],25:[2,63],26:[2,63],40:[2,63],49:[2,63],54:[2,63],57:[2,63]},{6:[2,64],25:[2,64],26:[2,64],40:[2,64],49:[2,64],54:[2,64],57:[2,64]},{6:[2,65],25:[2,65],26:[2,65],40:[2,65],49:[2,65],54:[2,65],57:[2,65]},{6:[2,66],25:[2,66],26:[2,66],40:[2,66],49:[2,66],54:[2,66],57:[2,66]},{27:150,28:[1,72]},{7:203,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,25:[1,147],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],57:[1,149],58:46,59:47,60:148,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],87:145,88:[1,57],89:[1,58],90:[1,56],91:[1,144],94:146,96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,49],6:[2,49],25:[2,49],26:[2,49],49:[2,49],54:[2,49],57:[2,49],73:[2,49],78:[2,49],86:[2,49],91:[2,49],93:[2,49],102:[2,49],104:[2,49],105:[2,49],106:[2,49],110:[2,49],118:[2,49],126:[2,49],129:[2,49],130:[2,49],133:[2,49],134:[2,49],135:[2,49],136:[2,49],137:[2,49],138:[2,49],139:[2,49]},{4:210,5:3,7:4,8:5,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,26:[1,209],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,188],6:[2,188],25:[2,188],26:[2,188],49:[2,188],54:[2,188],57:[2,188],73:[2,188],78:[2,188],86:[2,188],91:[2,188],93:[2,188],102:[2,188],103:84,104:[2,188],105:[2,188],106:[2,188],109:85,110:[2,188],111:68,118:[2,188],126:[2,188],129:[2,188],130:[2,188],133:[1,74],134:[2,188],135:[2,188],136:[2,188],137:[2,188],138:[2,188],139:[2,188]},{103:87,104:[1,64],106:[1,65],109:88,110:[1,67],111:68,126:[1,86]},{1:[2,189],6:[2,189],25:[2,189],26:[2,189],49:[2,189],54:[2,189],57:[2,189],73:[2,189],78:[2,189],86:[2,189],91:[2,189],93:[2,189],102:[2,189],103:84,104:[2,189],105:[2,189],106:[2,189],109:85,110:[2,189],111:68,118:[2,189],126:[2,189],129:[2,189],130:[2,189],133:[1,74],134:[2,189],135:[1,78],136:[2,189],137:[2,189],138:[2,189],139:[2,189]},{1:[2,190],6:[2,190],25:[2,190],26:[2,190],49:[2,190],54:[2,190],57:[2,190],73:[2,190],78:[2,190],86:[2,190],91:[2,190],93:[2,190],102:[2,190],103:84,104:[2,190],105:[2,190],106:[2,190],109:85,110:[2,190],111:68,118:[2,190],126:[2,190],129:[2,190],130:[2,190],133:[1,74],134:[2,190],135:[1,78],136:[2,190],137:[2,190],138:[2,190],139:[2,190]},{1:[2,191],6:[2,191],25:[2,191],26:[2,191],49:[2,191],54:[2,191],57:[2,191],73:[2,191],78:[2,191],86:[2,191],91:[2,191],93:[2,191],102:[2,191],103:84,104:[2,191],105:[2,191],106:[2,191],109:85,110:[2,191],111:68,118:[2,191],126:[2,191],129:[2,191],130:[2,191],133:[1,74],134:[2,191],135:[1,78],136:[2,191],137:[2,191],138:[2,191],139:[2,191]},{1:[2,192],6:[2,192],25:[2,192],26:[2,192],49:[2,192],54:[2,192],57:[2,192],66:[2,72],67:[2,72],68:[2,72],69:[2,72],71:[2,72],73:[2,192],74:[2,72],78:[2,192],84:[2,72],85:[2,72],86:[2,192],91:[2,192],93:[2,192],102:[2,192],104:[2,192],105:[2,192],106:[2,192],110:[2,192],118:[2,192],126:[2,192],129:[2,192],130:[2,192],133:[2,192],134:[2,192],135:[2,192],136:[2,192],137:[2,192],138:[2,192],139:[2,192]},{62:90,66:[1,92],67:[1,93],68:[1,94],69:[1,95],70:96,71:[1,97],74:[1,98],81:89,84:[1,91],85:[2,108]},{62:100,66:[1,92],67:[1,93],68:[1,94],69:[1,95],70:96,71:[1,97],74:[1,98],81:99,84:[1,91],85:[2,108]},{66:[2,75],67:[2,75],68:[2,75],69:[2,75],71:[2,75],74:[2,75],84:[2,75],85:[2,75]},{1:[2,193],6:[2,193],25:[2,193],26:[2,193],49:[2,193],54:[2,193],57:[2,193],66:[2,72],67:[2,72],68:[2,72],69:[2,72],71:[2,72],73:[2,193],74:[2,72],78:[2,193],84:[2,72],85:[2,72],86:[2,193],91:[2,193],93:[2,193],102:[2,193],104:[2,193],105:[2,193],106:[2,193],110:[2,193],118:[2,193],126:[2,193],129:[2,193],130:[2,193],133:[2,193],134:[2,193],135:[2,193],136:[2,193],137:[2,193],138:[2,193],139:[2,193]},{1:[2,194],6:[2,194],25:[2,194],26:[2,194],49:[2,194],54:[2,194],57:[2,194],73:[2,194],78:[2,194],86:[2,194],91:[2,194],93:[2,194],102:[2,194],104:[2,194],105:[2,194],106:[2,194],110:[2,194],118:[2,194],126:[2,194],129:[2,194],130:[2,194],133:[2,194],134:[2,194],135:[2,194],136:[2,194],137:[2,194],138:[2,194],139:[2,194]},{1:[2,195],6:[2,195],25:[2,195],26:[2,195],49:[2,195],54:[2,195],57:[2,195],73:[2,195],78:[2,195],86:[2,195],91:[2,195],93:[2,195],102:[2,195],104:[2,195],105:[2,195],106:[2,195],110:[2,195],118:[2,195],126:[2,195],129:[2,195],130:[2,195],133:[2,195],134:[2,195],135:[2,195],136:[2,195],137:[2,195],138:[2,195],139:[2,195]},{6:[1,213],7:211,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,25:[1,212],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:214,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{24:215,25:[1,115],125:[1,216]},{1:[2,134],6:[2,134],25:[2,134],26:[2,134],49:[2,134],54:[2,134],57:[2,134],73:[2,134],78:[2,134],86:[2,134],91:[2,134],93:[2,134],97:217,98:[1,218],99:[1,219],102:[2,134],104:[2,134],105:[2,134],106:[2,134],110:[2,134],118:[2,134],126:[2,134],129:[2,134],130:[2,134],133:[2,134],134:[2,134],135:[2,134],136:[2,134],137:[2,134],138:[2,134],139:[2,134]},{1:[2,148],6:[2,148],25:[2,148],26:[2,148],49:[2,148],54:[2,148],57:[2,148],73:[2,148],78:[2,148],86:[2,148],91:[2,148],93:[2,148],102:[2,148],104:[2,148],105:[2,148],106:[2,148],110:[2,148],118:[2,148],126:[2,148],129:[2,148],130:[2,148],133:[2,148],134:[2,148],135:[2,148],136:[2,148],137:[2,148],138:[2,148],139:[2,148]},{1:[2,156],6:[2,156],25:[2,156],26:[2,156],49:[2,156],54:[2,156],57:[2,156],73:[2,156],78:[2,156],86:[2,156],91:[2,156],93:[2,156],102:[2,156],104:[2,156],105:[2,156],106:[2,156],110:[2,156],118:[2,156],126:[2,156],129:[2,156],130:[2,156],133:[2,156],134:[2,156],135:[2,156],136:[2,156],137:[2,156],138:[2,156],139:[2,156]},{25:[1,220],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{120:221,122:222,123:[1,223]},{1:[2,97],6:[2,97],25:[2,97],26:[2,97],49:[2,97],54:[2,97],57:[2,97],73:[2,97],78:[2,97],86:[2,97],91:[2,97],93:[2,97],102:[2,97],104:[2,97],105:[2,97],106:[2,97],110:[2,97],118:[2,97],126:[2,97],129:[2,97],130:[2,97],133:[2,97],134:[2,97],135:[2,97],136:[2,97],137:[2,97],138:[2,97],139:[2,97]},{7:224,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,100],6:[2,100],24:225,25:[1,115],26:[2,100],49:[2,100],54:[2,100],57:[2,100],66:[2,72],67:[2,72],68:[2,72],69:[2,72],71:[2,72],73:[2,100],74:[2,72],78:[2,100],80:[1,226],84:[2,72],85:[2,72],86:[2,100],91:[2,100],93:[2,100],102:[2,100],104:[2,100],105:[2,100],106:[2,100],110:[2,100],118:[2,100],126:[2,100],129:[2,100],130:[2,100],133:[2,100],134:[2,100],135:[2,100],136:[2,100],137:[2,100],138:[2,100],139:[2,100]},{1:[2,141],6:[2,141],25:[2,141],26:[2,141],49:[2,141],54:[2,141],57:[2,141],73:[2,141],78:[2,141],86:[2,141],91:[2,141],93:[2,141],102:[2,141],103:84,104:[2,141],105:[2,141],106:[2,141],109:85,110:[2,141],111:68,118:[2,141],126:[2,141],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,45],6:[2,45],26:[2,45],102:[2,45],103:84,104:[2,45],106:[2,45],109:85,110:[2,45],111:68,126:[2,45],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{6:[1,73],102:[1,227]},{4:228,5:3,7:4,8:5,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{6:[2,129],25:[2,129],54:[2,129],57:[1,230],91:[2,129],92:229,93:[1,194],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,115],6:[2,115],25:[2,115],26:[2,115],40:[2,115],49:[2,115],54:[2,115],57:[2,115],66:[2,115],67:[2,115],68:[2,115],69:[2,115],71:[2,115],73:[2,115],74:[2,115],78:[2,115],84:[2,115],85:[2,115],86:[2,115],91:[2,115],93:[2,115],102:[2,115],104:[2,115],105:[2,115],106:[2,115],110:[2,115],116:[2,115],117:[2,115],118:[2,115],126:[2,115],129:[2,115],130:[2,115],133:[2,115],134:[2,115],135:[2,115],136:[2,115],137:[2,115],138:[2,115],139:[2,115]},{6:[2,52],25:[2,52],53:231,54:[1,232],91:[2,52]},{6:[2,124],25:[2,124],26:[2,124],54:[2,124],86:[2,124],91:[2,124]},{7:203,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,25:[1,147],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],57:[1,149],58:46,59:47,60:148,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],87:233,88:[1,57],89:[1,58],90:[1,56],94:146,96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{6:[2,130],25:[2,130],26:[2,130],54:[2,130],86:[2,130],91:[2,130]},{6:[2,131],25:[2,131],26:[2,131],54:[2,131],86:[2,131],91:[2,131]},{1:[2,114],6:[2,114],25:[2,114],26:[2,114],40:[2,114],43:[2,114],49:[2,114],54:[2,114],57:[2,114],66:[2,114],67:[2,114],68:[2,114],69:[2,114],71:[2,114],73:[2,114],74:[2,114],78:[2,114],80:[2,114],84:[2,114],85:[2,114],86:[2,114],91:[2,114],93:[2,114],102:[2,114],104:[2,114],105:[2,114],106:[2,114],110:[2,114],116:[2,114],117:[2,114],118:[2,114],126:[2,114],129:[2,114],130:[2,114],131:[2,114],132:[2,114],133:[2,114],134:[2,114],135:[2,114],136:[2,114],137:[2,114],138:[2,114],139:[2,114],140:[2,114]},{24:234,25:[1,115],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,144],6:[2,144],25:[2,144],26:[2,144],49:[2,144],54:[2,144],57:[2,144],73:[2,144],78:[2,144],86:[2,144],91:[2,144],93:[2,144],102:[2,144],103:84,104:[1,64],105:[1,235],106:[1,65],109:85,110:[1,67],111:68,118:[2,144],126:[2,144],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,146],6:[2,146],25:[2,146],26:[2,146],49:[2,146],54:[2,146],57:[2,146],73:[2,146],78:[2,146],86:[2,146],91:[2,146],93:[2,146],102:[2,146],103:84,104:[1,64],105:[1,236],106:[1,65],109:85,110:[1,67],111:68,118:[2,146],126:[2,146],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,152],6:[2,152],25:[2,152],26:[2,152],49:[2,152],54:[2,152],57:[2,152],73:[2,152],78:[2,152],86:[2,152],91:[2,152],93:[2,152],102:[2,152],104:[2,152],105:[2,152],106:[2,152],110:[2,152],118:[2,152],126:[2,152],129:[2,152],130:[2,152],133:[2,152],134:[2,152],135:[2,152],136:[2,152],137:[2,152],138:[2,152],139:[2,152]},{1:[2,153],6:[2,153],25:[2,153],26:[2,153],49:[2,153],54:[2,153],57:[2,153],73:[2,153],78:[2,153],86:[2,153],91:[2,153],93:[2,153],102:[2,153],103:84,104:[1,64],105:[2,153],106:[1,65],109:85,110:[1,67],111:68,118:[2,153],126:[2,153],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,157],6:[2,157],25:[2,157],26:[2,157],49:[2,157],54:[2,157],57:[2,157],73:[2,157],78:[2,157],86:[2,157],91:[2,157],93:[2,157],102:[2,157],104:[2,157],105:[2,157],106:[2,157],110:[2,157],118:[2,157],126:[2,157],129:[2,157],130:[2,157],133:[2,157],134:[2,157],135:[2,157],136:[2,157],137:[2,157],138:[2,157],139:[2,157]},{116:[2,159],117:[2,159]},{27:160,28:[1,72],44:161,58:162,59:163,76:[1,69],89:[1,112],90:[1,113],113:237,115:159},{54:[1,238],116:[2,165],117:[2,165]},{54:[2,161],116:[2,161],117:[2,161]},{54:[2,162],116:[2,162],117:[2,162]},{54:[2,163],116:[2,163],117:[2,163]},{54:[2,164],116:[2,164],117:[2,164]},{1:[2,158],6:[2,158],25:[2,158],26:[2,158],49:[2,158],54:[2,158],57:[2,158],73:[2,158],78:[2,158],86:[2,158],91:[2,158],93:[2,158],102:[2,158],104:[2,158],105:[2,158],106:[2,158],110:[2,158],118:[2,158],126:[2,158],129:[2,158],130:[2,158],133:[2,158],134:[2,158],135:[2,158],136:[2,158],137:[2,158],138:[2,158],139:[2,158]},{7:239,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:240,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{6:[2,52],25:[2,52],53:241,54:[1,242],78:[2,52]},{6:[2,92],25:[2,92],26:[2,92],54:[2,92],78:[2,92]},{6:[2,38],25:[2,38],26:[2,38],43:[1,243],54:[2,38],78:[2,38]},{6:[2,41],25:[2,41],26:[2,41],54:[2,41],78:[2,41]},{6:[2,42],25:[2,42],26:[2,42],43:[2,42],54:[2,42],78:[2,42]},{6:[2,43],25:[2,43],26:[2,43],43:[2,43],54:[2,43],78:[2,43]},{6:[2,44],25:[2,44],26:[2,44],43:[2,44],54:[2,44],78:[2,44]},{1:[2,4],6:[2,4],26:[2,4],102:[2,4]},{1:[2,197],6:[2,197],25:[2,197],26:[2,197],49:[2,197],54:[2,197],57:[2,197],73:[2,197],78:[2,197],86:[2,197],91:[2,197],93:[2,197],102:[2,197],103:84,104:[2,197],105:[2,197],106:[2,197],109:85,110:[2,197],111:68,118:[2,197],126:[2,197],129:[2,197],130:[2,197],133:[1,74],134:[1,77],135:[1,78],136:[2,197],137:[2,197],138:[2,197],139:[2,197]},{1:[2,198],6:[2,198],25:[2,198],26:[2,198],49:[2,198],54:[2,198],57:[2,198],73:[2,198],78:[2,198],86:[2,198],91:[2,198],93:[2,198],102:[2,198],103:84,104:[2,198],105:[2,198],106:[2,198],109:85,110:[2,198],111:68,118:[2,198],126:[2,198],129:[2,198],130:[2,198],133:[1,74],134:[1,77],135:[1,78],136:[2,198],137:[2,198],138:[2,198],139:[2,198]},{1:[2,199],6:[2,199],25:[2,199],26:[2,199],49:[2,199],54:[2,199],57:[2,199],73:[2,199],78:[2,199],86:[2,199],91:[2,199],93:[2,199],102:[2,199],103:84,104:[2,199],105:[2,199],106:[2,199],109:85,110:[2,199],111:68,118:[2,199],126:[2,199],129:[2,199],130:[2,199],133:[1,74],134:[2,199],135:[1,78],136:[2,199],137:[2,199],138:[2,199],139:[2,199]},{1:[2,200],6:[2,200],25:[2,200],26:[2,200],49:[2,200],54:[2,200],57:[2,200],73:[2,200],78:[2,200],86:[2,200],91:[2,200],93:[2,200],102:[2,200],103:84,104:[2,200],105:[2,200],106:[2,200],109:85,110:[2,200],111:68,118:[2,200],126:[2,200],129:[2,200],130:[2,200],133:[1,74],134:[2,200],135:[1,78],136:[2,200],137:[2,200],138:[2,200],139:[2,200]},{1:[2,201],6:[2,201],25:[2,201],26:[2,201],49:[2,201],54:[2,201],57:[2,201],73:[2,201],78:[2,201],86:[2,201],91:[2,201],93:[2,201],102:[2,201],103:84,104:[2,201],105:[2,201],106:[2,201],109:85,110:[2,201],111:68,118:[2,201],126:[2,201],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[2,201],137:[2,201],138:[2,201],139:[2,201]},{1:[2,202],6:[2,202],25:[2,202],26:[2,202],49:[2,202],54:[2,202],57:[2,202],73:[2,202],78:[2,202],86:[2,202],91:[2,202],93:[2,202],102:[2,202],103:84,104:[2,202],105:[2,202],106:[2,202],109:85,110:[2,202],111:68,118:[2,202],126:[2,202],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[2,202],138:[2,202],139:[1,82]},{1:[2,203],6:[2,203],25:[2,203],26:[2,203],49:[2,203],54:[2,203],57:[2,203],73:[2,203],78:[2,203],86:[2,203],91:[2,203],93:[2,203],102:[2,203],103:84,104:[2,203],105:[2,203],106:[2,203],109:85,110:[2,203],111:68,118:[2,203],126:[2,203],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[2,203],139:[1,82]},{1:[2,204],6:[2,204],25:[2,204],26:[2,204],49:[2,204],54:[2,204],57:[2,204],73:[2,204],78:[2,204],86:[2,204],91:[2,204],93:[2,204],102:[2,204],103:84,104:[2,204],105:[2,204],106:[2,204],109:85,110:[2,204],111:68,118:[2,204],126:[2,204],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[2,204],138:[2,204],139:[2,204]},{1:[2,187],6:[2,187],25:[2,187],26:[2,187],49:[2,187],54:[2,187],57:[2,187],73:[2,187],78:[2,187],86:[2,187],91:[2,187],93:[2,187],102:[2,187],103:84,104:[1,64],105:[2,187],106:[1,65],109:85,110:[1,67],111:68,118:[2,187],126:[2,187],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,186],6:[2,186],25:[2,186],26:[2,186],49:[2,186],54:[2,186],57:[2,186],73:[2,186],78:[2,186],86:[2,186],91:[2,186],93:[2,186],102:[2,186],103:84,104:[1,64],105:[2,186],106:[1,65],109:85,110:[1,67],111:68,118:[2,186],126:[2,186],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,104],6:[2,104],25:[2,104],26:[2,104],49:[2,104],54:[2,104],57:[2,104],66:[2,104],67:[2,104],68:[2,104],69:[2,104],71:[2,104],73:[2,104],74:[2,104],78:[2,104],84:[2,104],85:[2,104],86:[2,104],91:[2,104],93:[2,104],102:[2,104],104:[2,104],105:[2,104],106:[2,104],110:[2,104],118:[2,104],126:[2,104],129:[2,104],130:[2,104],133:[2,104],134:[2,104],135:[2,104],136:[2,104],137:[2,104],138:[2,104],139:[2,104]},{1:[2,80],6:[2,80],25:[2,80],26:[2,80],40:[2,80],49:[2,80],54:[2,80],57:[2,80],66:[2,80],67:[2,80],68:[2,80],69:[2,80],71:[2,80],73:[2,80],74:[2,80],78:[2,80],80:[2,80],84:[2,80],85:[2,80],86:[2,80],91:[2,80],93:[2,80],102:[2,80],104:[2,80],105:[2,80],106:[2,80],110:[2,80],118:[2,80],126:[2,80],129:[2,80],130:[2,80],131:[2,80],132:[2,80],133:[2,80],134:[2,80],135:[2,80],136:[2,80],137:[2,80],138:[2,80],139:[2,80],140:[2,80]},{1:[2,81],6:[2,81],25:[2,81],26:[2,81],40:[2,81],49:[2,81],54:[2,81],57:[2,81],66:[2,81],67:[2,81],68:[2,81],69:[2,81],71:[2,81],73:[2,81],74:[2,81],78:[2,81],80:[2,81],84:[2,81],85:[2,81],86:[2,81],91:[2,81],93:[2,81],102:[2,81],104:[2,81],105:[2,81],106:[2,81],110:[2,81],118:[2,81],126:[2,81],129:[2,81],130:[2,81],131:[2,81],132:[2,81],133:[2,81],134:[2,81],135:[2,81],136:[2,81],137:[2,81],138:[2,81],139:[2,81],140:[2,81]},{1:[2,82],6:[2,82],25:[2,82],26:[2,82],40:[2,82],49:[2,82],54:[2,82],57:[2,82],66:[2,82],67:[2,82],68:[2,82],69:[2,82],71:[2,82],73:[2,82],74:[2,82],78:[2,82],80:[2,82],84:[2,82],85:[2,82],86:[2,82],91:[2,82],93:[2,82],102:[2,82],104:[2,82],105:[2,82],106:[2,82],110:[2,82],118:[2,82],126:[2,82],129:[2,82],130:[2,82],131:[2,82],132:[2,82],133:[2,82],134:[2,82],135:[2,82],136:[2,82],137:[2,82],138:[2,82],139:[2,82],140:[2,82]},{1:[2,83],6:[2,83],25:[2,83],26:[2,83],40:[2,83],49:[2,83],54:[2,83],57:[2,83],66:[2,83],67:[2,83],68:[2,83],69:[2,83],71:[2,83],73:[2,83],74:[2,83],78:[2,83],80:[2,83],84:[2,83],85:[2,83],86:[2,83],91:[2,83],93:[2,83],102:[2,83],104:[2,83],105:[2,83],106:[2,83],110:[2,83],118:[2,83],126:[2,83],129:[2,83],130:[2,83],131:[2,83],132:[2,83],133:[2,83],134:[2,83],135:[2,83],136:[2,83],137:[2,83],138:[2,83],139:[2,83],140:[2,83]},{73:[1,244]},{57:[1,195],73:[2,88],92:245,93:[1,194],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{73:[2,89]},{7:246,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,73:[2,123],76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{11:[2,117],28:[2,117],30:[2,117],31:[2,117],33:[2,117],34:[2,117],35:[2,117],36:[2,117],37:[2,117],38:[2,117],45:[2,117],46:[2,117],47:[2,117],51:[2,117],52:[2,117],73:[2,117],76:[2,117],79:[2,117],83:[2,117],88:[2,117],89:[2,117],90:[2,117],96:[2,117],100:[2,117],101:[2,117],104:[2,117],106:[2,117],108:[2,117],110:[2,117],119:[2,117],125:[2,117],127:[2,117],128:[2,117],129:[2,117],130:[2,117],131:[2,117],132:[2,117]},{11:[2,118],28:[2,118],30:[2,118],31:[2,118],33:[2,118],34:[2,118],35:[2,118],36:[2,118],37:[2,118],38:[2,118],45:[2,118],46:[2,118],47:[2,118],51:[2,118],52:[2,118],73:[2,118],76:[2,118],79:[2,118],83:[2,118],88:[2,118],89:[2,118],90:[2,118],96:[2,118],100:[2,118],101:[2,118],104:[2,118],106:[2,118],108:[2,118],110:[2,118],119:[2,118],125:[2,118],127:[2,118],128:[2,118],129:[2,118],130:[2,118],131:[2,118],132:[2,118]},{1:[2,87],6:[2,87],25:[2,87],26:[2,87],40:[2,87],49:[2,87],54:[2,87],57:[2,87],66:[2,87],67:[2,87],68:[2,87],69:[2,87],71:[2,87],73:[2,87],74:[2,87],78:[2,87],80:[2,87],84:[2,87],85:[2,87],86:[2,87],91:[2,87],93:[2,87],102:[2,87],104:[2,87],105:[2,87],106:[2,87],110:[2,87],118:[2,87],126:[2,87],129:[2,87],130:[2,87],131:[2,87],132:[2,87],133:[2,87],134:[2,87],135:[2,87],136:[2,87],137:[2,87],138:[2,87],139:[2,87],140:[2,87]},{1:[2,105],6:[2,105],25:[2,105],26:[2,105],49:[2,105],54:[2,105],57:[2,105],66:[2,105],67:[2,105],68:[2,105],69:[2,105],71:[2,105],73:[2,105],74:[2,105],78:[2,105],84:[2,105],85:[2,105],86:[2,105],91:[2,105],93:[2,105],102:[2,105],104:[2,105],105:[2,105],106:[2,105],110:[2,105],118:[2,105],126:[2,105],129:[2,105],130:[2,105],133:[2,105],134:[2,105],135:[2,105],136:[2,105],137:[2,105],138:[2,105],139:[2,105]},{1:[2,35],6:[2,35],25:[2,35],26:[2,35],49:[2,35],54:[2,35],57:[2,35],73:[2,35],78:[2,35],86:[2,35],91:[2,35],93:[2,35],102:[2,35],103:84,104:[2,35],105:[2,35],106:[2,35],109:85,110:[2,35],111:68,118:[2,35],126:[2,35],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{7:247,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:248,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,110],6:[2,110],25:[2,110],26:[2,110],49:[2,110],54:[2,110],57:[2,110],66:[2,110],67:[2,110],68:[2,110],69:[2,110],71:[2,110],73:[2,110],74:[2,110],78:[2,110],84:[2,110],85:[2,110],86:[2,110],91:[2,110],93:[2,110],102:[2,110],104:[2,110],105:[2,110],106:[2,110],110:[2,110],118:[2,110],126:[2,110],129:[2,110],130:[2,110],133:[2,110],134:[2,110],135:[2,110],136:[2,110],137:[2,110],138:[2,110],139:[2,110]},{6:[2,52],25:[2,52],53:249,54:[1,232],86:[2,52]},{6:[2,129],25:[2,129],26:[2,129],54:[2,129],57:[1,250],86:[2,129],91:[2,129],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{50:251,51:[1,59],52:[1,60]},{6:[2,53],25:[2,53],26:[2,53],27:108,28:[1,72],44:109,55:252,56:106,57:[1,107],58:110,59:111,76:[1,69],89:[1,112],90:[1,113]},{6:[1,253],25:[1,254]},{6:[2,60],25:[2,60],26:[2,60],49:[2,60],54:[2,60]},{7:255,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,23],6:[2,23],25:[2,23],26:[2,23],49:[2,23],54:[2,23],57:[2,23],73:[2,23],78:[2,23],86:[2,23],91:[2,23],93:[2,23],98:[2,23],99:[2,23],102:[2,23],104:[2,23],105:[2,23],106:[2,23],110:[2,23],118:[2,23],121:[2,23],123:[2,23],126:[2,23],129:[2,23],130:[2,23],133:[2,23],134:[2,23],135:[2,23],136:[2,23],137:[2,23],138:[2,23],139:[2,23]},{6:[1,73],26:[1,256]},{1:[2,205],6:[2,205],25:[2,205],26:[2,205],49:[2,205],54:[2,205],57:[2,205],73:[2,205],78:[2,205],86:[2,205],91:[2,205],93:[2,205],102:[2,205],103:84,104:[2,205],105:[2,205],106:[2,205],109:85,110:[2,205],111:68,118:[2,205],126:[2,205],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{7:257,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:258,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,208],6:[2,208],25:[2,208],26:[2,208],49:[2,208],54:[2,208],57:[2,208],73:[2,208],78:[2,208],86:[2,208],91:[2,208],93:[2,208],102:[2,208],103:84,104:[2,208],105:[2,208],106:[2,208],109:85,110:[2,208],111:68,118:[2,208],126:[2,208],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,185],6:[2,185],25:[2,185],26:[2,185],49:[2,185],54:[2,185],57:[2,185],73:[2,185],78:[2,185],86:[2,185],91:[2,185],93:[2,185],102:[2,185],104:[2,185],105:[2,185],106:[2,185],110:[2,185],118:[2,185],126:[2,185],129:[2,185],130:[2,185],133:[2,185],134:[2,185],135:[2,185],136:[2,185],137:[2,185],138:[2,185],139:[2,185]},{7:259,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,135],6:[2,135],25:[2,135],26:[2,135],49:[2,135],54:[2,135],57:[2,135],73:[2,135],78:[2,135],86:[2,135],91:[2,135],93:[2,135],98:[1,260],102:[2,135],104:[2,135],105:[2,135],106:[2,135],110:[2,135],118:[2,135],126:[2,135],129:[2,135],130:[2,135],133:[2,135],134:[2,135],135:[2,135],136:[2,135],137:[2,135],138:[2,135],139:[2,135]},{24:261,25:[1,115]},{24:264,25:[1,115],27:262,28:[1,72],59:263,76:[1,69]},{120:265,122:222,123:[1,223]},{26:[1,266],121:[1,267],122:268,123:[1,223]},{26:[2,178],121:[2,178],123:[2,178]},{7:270,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],95:269,96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,98],6:[2,98],24:271,25:[1,115],26:[2,98],49:[2,98],54:[2,98],57:[2,98],73:[2,98],78:[2,98],86:[2,98],91:[2,98],93:[2,98],102:[2,98],103:84,104:[1,64],105:[2,98],106:[1,65],109:85,110:[1,67],111:68,118:[2,98],126:[2,98],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,101],6:[2,101],25:[2,101],26:[2,101],49:[2,101],54:[2,101],57:[2,101],73:[2,101],78:[2,101],86:[2,101],91:[2,101],93:[2,101],102:[2,101],104:[2,101],105:[2,101],106:[2,101],110:[2,101],118:[2,101],126:[2,101],129:[2,101],130:[2,101],133:[2,101],134:[2,101],135:[2,101],136:[2,101],137:[2,101],138:[2,101],139:[2,101]},{7:272,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,142],6:[2,142],25:[2,142],26:[2,142],49:[2,142],54:[2,142],57:[2,142],66:[2,142],67:[2,142],68:[2,142],69:[2,142],71:[2,142],73:[2,142],74:[2,142],78:[2,142],84:[2,142],85:[2,142],86:[2,142],91:[2,142],93:[2,142],102:[2,142],104:[2,142],105:[2,142],106:[2,142],110:[2,142],118:[2,142],126:[2,142],129:[2,142],130:[2,142],133:[2,142],134:[2,142],135:[2,142],136:[2,142],137:[2,142],138:[2,142],139:[2,142]},{6:[1,73],26:[1,273]},{7:274,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{6:[2,67],11:[2,118],25:[2,67],28:[2,118],30:[2,118],31:[2,118],33:[2,118],34:[2,118],35:[2,118],36:[2,118],37:[2,118],38:[2,118],45:[2,118],46:[2,118],47:[2,118],51:[2,118],52:[2,118],54:[2,67],76:[2,118],79:[2,118],83:[2,118],88:[2,118],89:[2,118],90:[2,118],91:[2,67],96:[2,118],100:[2,118],101:[2,118],104:[2,118],106:[2,118],108:[2,118],110:[2,118],119:[2,118],125:[2,118],127:[2,118],128:[2,118],129:[2,118],130:[2,118],131:[2,118],132:[2,118]},{6:[1,276],25:[1,277],91:[1,275]},{6:[2,53],7:203,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,25:[2,53],26:[2,53],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],57:[1,149],58:46,59:47,60:148,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],86:[2,53],88:[1,57],89:[1,58],90:[1,56],91:[2,53],94:278,96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{6:[2,52],25:[2,52],26:[2,52],53:279,54:[1,232]},{1:[2,182],6:[2,182],25:[2,182],26:[2,182],49:[2,182],54:[2,182],57:[2,182],73:[2,182],78:[2,182],86:[2,182],91:[2,182],93:[2,182],102:[2,182],104:[2,182],105:[2,182],106:[2,182],110:[2,182],118:[2,182],121:[2,182],126:[2,182],129:[2,182],130:[2,182],133:[2,182],134:[2,182],135:[2,182],136:[2,182],137:[2,182],138:[2,182],139:[2,182]},{7:280,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:281,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{116:[2,160],117:[2,160]},{27:160,28:[1,72],44:161,58:162,59:163,76:[1,69],89:[1,112],90:[1,113],115:282},{1:[2,167],6:[2,167],25:[2,167],26:[2,167],49:[2,167],54:[2,167],57:[2,167],73:[2,167],78:[2,167],86:[2,167],91:[2,167],93:[2,167],102:[2,167],103:84,104:[2,167],105:[1,283],106:[2,167],109:85,110:[2,167],111:68,118:[1,284],126:[2,167],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,168],6:[2,168],25:[2,168],26:[2,168],49:[2,168],54:[2,168],57:[2,168],73:[2,168],78:[2,168],86:[2,168],91:[2,168],93:[2,168],102:[2,168],103:84,104:[2,168],105:[1,285],106:[2,168],109:85,110:[2,168],111:68,118:[2,168],126:[2,168],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{6:[1,287],25:[1,288],78:[1,286]},{6:[2,53],10:170,25:[2,53],26:[2,53],27:171,28:[1,72],29:172,30:[1,70],31:[1,71],41:289,42:169,44:173,46:[1,45],78:[2,53],89:[1,112]},{7:290,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,25:[1,291],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,86],6:[2,86],25:[2,86],26:[2,86],40:[2,86],49:[2,86],54:[2,86],57:[2,86],66:[2,86],67:[2,86],68:[2,86],69:[2,86],71:[2,86],73:[2,86],74:[2,86],78:[2,86],80:[2,86],84:[2,86],85:[2,86],86:[2,86],91:[2,86],93:[2,86],102:[2,86],104:[2,86],105:[2,86],106:[2,86],110:[2,86],118:[2,86],126:[2,86],129:[2,86],130:[2,86],131:[2,86],132:[2,86],133:[2,86],134:[2,86],135:[2,86],136:[2,86],137:[2,86],138:[2,86],139:[2,86],140:[2,86]},{7:292,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,73:[2,121],76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{73:[2,122],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,36],6:[2,36],25:[2,36],26:[2,36],49:[2,36],54:[2,36],57:[2,36],73:[2,36],78:[2,36],86:[2,36],91:[2,36],93:[2,36],102:[2,36],103:84,104:[2,36],105:[2,36],106:[2,36],109:85,110:[2,36],111:68,118:[2,36],126:[2,36],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{26:[1,293],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{6:[1,276],25:[1,277],86:[1,294]},{6:[2,67],25:[2,67],26:[2,67],54:[2,67],86:[2,67],91:[2,67]},{24:295,25:[1,115]},{6:[2,56],25:[2,56],26:[2,56],49:[2,56],54:[2,56]},{27:108,28:[1,72],44:109,55:296,56:106,57:[1,107],58:110,59:111,76:[1,69],89:[1,112],90:[1,113]},{6:[2,54],25:[2,54],26:[2,54],27:108,28:[1,72],44:109,48:297,54:[2,54],55:105,56:106,57:[1,107],58:110,59:111,76:[1,69],89:[1,112],90:[1,113]},{6:[2,61],25:[2,61],26:[2,61],49:[2,61],54:[2,61],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,24],6:[2,24],25:[2,24],26:[2,24],49:[2,24],54:[2,24],57:[2,24],73:[2,24],78:[2,24],86:[2,24],91:[2,24],93:[2,24],98:[2,24],99:[2,24],102:[2,24],104:[2,24],105:[2,24],106:[2,24],110:[2,24],118:[2,24],121:[2,24],123:[2,24],126:[2,24],129:[2,24],130:[2,24],133:[2,24],134:[2,24],135:[2,24],136:[2,24],137:[2,24],138:[2,24],139:[2,24]},{26:[1,298],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,207],6:[2,207],25:[2,207],26:[2,207],49:[2,207],54:[2,207],57:[2,207],73:[2,207],78:[2,207],86:[2,207],91:[2,207],93:[2,207],102:[2,207],103:84,104:[2,207],105:[2,207],106:[2,207],109:85,110:[2,207],111:68,118:[2,207],126:[2,207],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{24:299,25:[1,115],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{24:300,25:[1,115]},{1:[2,136],6:[2,136],25:[2,136],26:[2,136],49:[2,136],54:[2,136],57:[2,136],73:[2,136],78:[2,136],86:[2,136],91:[2,136],93:[2,136],102:[2,136],104:[2,136],105:[2,136],106:[2,136],110:[2,136],118:[2,136],126:[2,136],129:[2,136],130:[2,136],133:[2,136],134:[2,136],135:[2,136],136:[2,136],137:[2,136],138:[2,136],139:[2,136]},{24:301,25:[1,115]},{24:302,25:[1,115]},{1:[2,140],6:[2,140],25:[2,140],26:[2,140],49:[2,140],54:[2,140],57:[2,140],73:[2,140],78:[2,140],86:[2,140],91:[2,140],93:[2,140],98:[2,140],102:[2,140],104:[2,140],105:[2,140],106:[2,140],110:[2,140],118:[2,140],126:[2,140],129:[2,140],130:[2,140],133:[2,140],134:[2,140],135:[2,140],136:[2,140],137:[2,140],138:[2,140],139:[2,140]},{26:[1,303],121:[1,304],122:268,123:[1,223]},{1:[2,176],6:[2,176],25:[2,176],26:[2,176],49:[2,176],54:[2,176],57:[2,176],73:[2,176],78:[2,176],86:[2,176],91:[2,176],93:[2,176],102:[2,176],104:[2,176],105:[2,176],106:[2,176],110:[2,176],118:[2,176],126:[2,176],129:[2,176],130:[2,176],133:[2,176],134:[2,176],135:[2,176],136:[2,176],137:[2,176],138:[2,176],139:[2,176]},{24:305,25:[1,115]},{26:[2,179],121:[2,179],123:[2,179]},{24:306,25:[1,115],54:[1,307]},{25:[2,132],54:[2,132],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,99],6:[2,99],25:[2,99],26:[2,99],49:[2,99],54:[2,99],57:[2,99],73:[2,99],78:[2,99],86:[2,99],91:[2,99],93:[2,99],102:[2,99],104:[2,99],105:[2,99],106:[2,99],110:[2,99],118:[2,99],126:[2,99],129:[2,99],130:[2,99],133:[2,99],134:[2,99],135:[2,99],136:[2,99],137:[2,99],138:[2,99],139:[2,99]},{1:[2,102],6:[2,102],24:308,25:[1,115],26:[2,102],49:[2,102],54:[2,102],57:[2,102],73:[2,102],78:[2,102],86:[2,102],91:[2,102],93:[2,102],102:[2,102],103:84,104:[1,64],105:[2,102],106:[1,65],109:85,110:[1,67],111:68,118:[2,102],126:[2,102],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{102:[1,309]},{91:[1,310],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,116],6:[2,116],25:[2,116],26:[2,116],40:[2,116],49:[2,116],54:[2,116],57:[2,116],66:[2,116],67:[2,116],68:[2,116],69:[2,116],71:[2,116],73:[2,116],74:[2,116],78:[2,116],84:[2,116],85:[2,116],86:[2,116],91:[2,116],93:[2,116],102:[2,116],104:[2,116],105:[2,116],106:[2,116],110:[2,116],116:[2,116],117:[2,116],118:[2,116],126:[2,116],129:[2,116],130:[2,116],133:[2,116],134:[2,116],135:[2,116],136:[2,116],137:[2,116],138:[2,116],139:[2,116]},{7:203,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],57:[1,149],58:46,59:47,60:148,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],94:311,96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:203,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,25:[1,147],27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],57:[1,149],58:46,59:47,60:148,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],87:312,88:[1,57],89:[1,58],90:[1,56],94:146,96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{6:[2,125],25:[2,125],26:[2,125],54:[2,125],86:[2,125],91:[2,125]},{6:[1,276],25:[1,277],26:[1,313]},{1:[2,145],6:[2,145],25:[2,145],26:[2,145],49:[2,145],54:[2,145],57:[2,145],73:[2,145],78:[2,145],86:[2,145],91:[2,145],93:[2,145],102:[2,145],103:84,104:[1,64],105:[2,145],106:[1,65],109:85,110:[1,67],111:68,118:[2,145],126:[2,145],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,147],6:[2,147],25:[2,147],26:[2,147],49:[2,147],54:[2,147],57:[2,147],73:[2,147],78:[2,147],86:[2,147],91:[2,147],93:[2,147],102:[2,147],103:84,104:[1,64],105:[2,147],106:[1,65],109:85,110:[1,67],111:68,118:[2,147],126:[2,147],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{116:[2,166],117:[2,166]},{7:314,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:315,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:316,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,90],6:[2,90],25:[2,90],26:[2,90],40:[2,90],49:[2,90],54:[2,90],57:[2,90],66:[2,90],67:[2,90],68:[2,90],69:[2,90],71:[2,90],73:[2,90],74:[2,90],78:[2,90],84:[2,90],85:[2,90],86:[2,90],91:[2,90],93:[2,90],102:[2,90],104:[2,90],105:[2,90],106:[2,90],110:[2,90],116:[2,90],117:[2,90],118:[2,90],126:[2,90],129:[2,90],130:[2,90],133:[2,90],134:[2,90],135:[2,90],136:[2,90],137:[2,90],138:[2,90],139:[2,90]},{10:170,27:171,28:[1,72],29:172,30:[1,70],31:[1,71],41:317,42:169,44:173,46:[1,45],89:[1,112]},{6:[2,91],10:170,25:[2,91],26:[2,91],27:171,28:[1,72],29:172,30:[1,70],31:[1,71],41:168,42:169,44:173,46:[1,45],54:[2,91],77:318,89:[1,112]},{6:[2,93],25:[2,93],26:[2,93],54:[2,93],78:[2,93]},{6:[2,39],25:[2,39],26:[2,39],54:[2,39],78:[2,39],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{7:319,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{73:[2,120],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,37],6:[2,37],25:[2,37],26:[2,37],49:[2,37],54:[2,37],57:[2,37],73:[2,37],78:[2,37],86:[2,37],91:[2,37],93:[2,37],102:[2,37],104:[2,37],105:[2,37],106:[2,37],110:[2,37],118:[2,37],126:[2,37],129:[2,37],130:[2,37],133:[2,37],134:[2,37],135:[2,37],136:[2,37],137:[2,37],138:[2,37],139:[2,37]},{1:[2,111],6:[2,111],25:[2,111],26:[2,111],49:[2,111],54:[2,111],57:[2,111],66:[2,111],67:[2,111],68:[2,111],69:[2,111],71:[2,111],73:[2,111],74:[2,111],78:[2,111],84:[2,111],85:[2,111],86:[2,111],91:[2,111],93:[2,111],102:[2,111],104:[2,111],105:[2,111],106:[2,111],110:[2,111],118:[2,111],126:[2,111],129:[2,111],130:[2,111],133:[2,111],134:[2,111],135:[2,111],136:[2,111],137:[2,111],138:[2,111],139:[2,111]},{1:[2,48],6:[2,48],25:[2,48],26:[2,48],49:[2,48],54:[2,48],57:[2,48],73:[2,48],78:[2,48],86:[2,48],91:[2,48],93:[2,48],102:[2,48],104:[2,48],105:[2,48],106:[2,48],110:[2,48],118:[2,48],126:[2,48],129:[2,48],130:[2,48],133:[2,48],134:[2,48],135:[2,48],136:[2,48],137:[2,48],138:[2,48],139:[2,48]},{6:[2,57],25:[2,57],26:[2,57],49:[2,57],54:[2,57]},{6:[2,52],25:[2,52],26:[2,52],53:320,54:[1,205]},{1:[2,206],6:[2,206],25:[2,206],26:[2,206],49:[2,206],54:[2,206],57:[2,206],73:[2,206],78:[2,206],86:[2,206],91:[2,206],93:[2,206],102:[2,206],104:[2,206],105:[2,206],106:[2,206],110:[2,206],118:[2,206],126:[2,206],129:[2,206],130:[2,206],133:[2,206],134:[2,206],135:[2,206],136:[2,206],137:[2,206],138:[2,206],139:[2,206]},{1:[2,183],6:[2,183],25:[2,183],26:[2,183],49:[2,183],54:[2,183],57:[2,183],73:[2,183],78:[2,183],86:[2,183],91:[2,183],93:[2,183],102:[2,183],104:[2,183],105:[2,183],106:[2,183],110:[2,183],118:[2,183],121:[2,183],126:[2,183],129:[2,183],130:[2,183],133:[2,183],134:[2,183],135:[2,183],136:[2,183],137:[2,183],138:[2,183],139:[2,183]},{1:[2,137],6:[2,137],25:[2,137],26:[2,137],49:[2,137],54:[2,137],57:[2,137],73:[2,137],78:[2,137],86:[2,137],91:[2,137],93:[2,137],102:[2,137],104:[2,137],105:[2,137],106:[2,137],110:[2,137],118:[2,137],126:[2,137],129:[2,137],130:[2,137],133:[2,137],134:[2,137],135:[2,137],136:[2,137],137:[2,137],138:[2,137],139:[2,137]},{1:[2,138],6:[2,138],25:[2,138],26:[2,138],49:[2,138],54:[2,138],57:[2,138],73:[2,138],78:[2,138],86:[2,138],91:[2,138],93:[2,138],98:[2,138],102:[2,138],104:[2,138],105:[2,138],106:[2,138],110:[2,138],118:[2,138],126:[2,138],129:[2,138],130:[2,138],133:[2,138],134:[2,138],135:[2,138],136:[2,138],137:[2,138],138:[2,138],139:[2,138]},{1:[2,139],6:[2,139],25:[2,139],26:[2,139],49:[2,139],54:[2,139],57:[2,139],73:[2,139],78:[2,139],86:[2,139],91:[2,139],93:[2,139],98:[2,139],102:[2,139],104:[2,139],105:[2,139],106:[2,139],110:[2,139],118:[2,139],126:[2,139],129:[2,139],130:[2,139],133:[2,139],134:[2,139],135:[2,139],136:[2,139],137:[2,139],138:[2,139],139:[2,139]},{1:[2,174],6:[2,174],25:[2,174],26:[2,174],49:[2,174],54:[2,174],57:[2,174],73:[2,174],78:[2,174],86:[2,174],91:[2,174],93:[2,174],102:[2,174],104:[2,174],105:[2,174],106:[2,174],110:[2,174],118:[2,174],126:[2,174],129:[2,174],130:[2,174],133:[2,174],134:[2,174],135:[2,174],136:[2,174],137:[2,174],138:[2,174],139:[2,174]},{24:321,25:[1,115]},{26:[1,322]},{6:[1,323],26:[2,180],121:[2,180],123:[2,180]},{7:324,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{1:[2,103],6:[2,103],25:[2,103],26:[2,103],49:[2,103],54:[2,103],57:[2,103],73:[2,103],78:[2,103],86:[2,103],91:[2,103],93:[2,103],102:[2,103],104:[2,103],105:[2,103],106:[2,103],110:[2,103],118:[2,103],126:[2,103],129:[2,103],130:[2,103],133:[2,103],134:[2,103],135:[2,103],136:[2,103],137:[2,103],138:[2,103],139:[2,103]},{1:[2,143],6:[2,143],25:[2,143],26:[2,143],49:[2,143],54:[2,143],57:[2,143],66:[2,143],67:[2,143],68:[2,143],69:[2,143],71:[2,143],73:[2,143],74:[2,143],78:[2,143],84:[2,143],85:[2,143],86:[2,143],91:[2,143],93:[2,143],102:[2,143],104:[2,143],105:[2,143],106:[2,143],110:[2,143],118:[2,143],126:[2,143],129:[2,143],130:[2,143],133:[2,143],134:[2,143],135:[2,143],136:[2,143],137:[2,143],138:[2,143],139:[2,143]},{1:[2,119],6:[2,119],25:[2,119],26:[2,119],49:[2,119],54:[2,119],57:[2,119],66:[2,119],67:[2,119],68:[2,119],69:[2,119],71:[2,119],73:[2,119],74:[2,119],78:[2,119],84:[2,119],85:[2,119],86:[2,119],91:[2,119],93:[2,119],102:[2,119],104:[2,119],105:[2,119],106:[2,119],110:[2,119],118:[2,119],126:[2,119],129:[2,119],130:[2,119],133:[2,119],134:[2,119],135:[2,119],136:[2,119],137:[2,119],138:[2,119],139:[2,119]},{6:[2,126],25:[2,126],26:[2,126],54:[2,126],86:[2,126],91:[2,126]},{6:[2,52],25:[2,52],26:[2,52],53:325,54:[1,232]},{6:[2,127],25:[2,127],26:[2,127],54:[2,127],86:[2,127],91:[2,127]},{1:[2,169],6:[2,169],25:[2,169],26:[2,169],49:[2,169],54:[2,169],57:[2,169],73:[2,169],78:[2,169],86:[2,169],91:[2,169],93:[2,169],102:[2,169],103:84,104:[2,169],105:[2,169],106:[2,169],109:85,110:[2,169],111:68,118:[1,326],126:[2,169],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,171],6:[2,171],25:[2,171],26:[2,171],49:[2,171],54:[2,171],57:[2,171],73:[2,171],78:[2,171],86:[2,171],91:[2,171],93:[2,171],102:[2,171],103:84,104:[2,171],105:[1,327],106:[2,171],109:85,110:[2,171],111:68,118:[2,171],126:[2,171],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,170],6:[2,170],25:[2,170],26:[2,170],49:[2,170],54:[2,170],57:[2,170],73:[2,170],78:[2,170],86:[2,170],91:[2,170],93:[2,170],102:[2,170],103:84,104:[2,170],105:[2,170],106:[2,170],109:85,110:[2,170],111:68,118:[2,170],126:[2,170],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{6:[2,94],25:[2,94],26:[2,94],54:[2,94],78:[2,94]},{6:[2,52],25:[2,52],26:[2,52],53:328,54:[1,242]},{26:[1,329],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{6:[1,253],25:[1,254],26:[1,330]},{26:[1,331]},{1:[2,177],6:[2,177],25:[2,177],26:[2,177],49:[2,177],54:[2,177],57:[2,177],73:[2,177],78:[2,177],86:[2,177],91:[2,177],93:[2,177],102:[2,177],104:[2,177],105:[2,177],106:[2,177],110:[2,177],118:[2,177],126:[2,177],129:[2,177],130:[2,177],133:[2,177],134:[2,177],135:[2,177],136:[2,177],137:[2,177],138:[2,177],139:[2,177]},{26:[2,181],121:[2,181],123:[2,181]},{25:[2,133],54:[2,133],103:84,104:[1,64],106:[1,65],109:85,110:[1,67],111:68,126:[1,83],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{6:[1,276],25:[1,277],26:[1,332]},{7:333,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{7:334,8:117,9:18,10:19,11:[1,20],12:6,13:7,14:8,15:9,16:10,17:11,18:12,19:13,20:14,21:15,22:16,23:17,27:61,28:[1,72],29:48,30:[1,70],31:[1,71],32:22,33:[1,49],34:[1,50],35:[1,51],36:[1,52],37:[1,53],38:[1,54],39:21,44:62,45:[1,44],46:[1,45],47:[1,27],50:28,51:[1,59],52:[1,60],58:46,59:47,61:35,63:23,64:24,65:25,76:[1,69],79:[1,42],83:[1,26],88:[1,57],89:[1,58],90:[1,56],96:[1,37],100:[1,43],101:[1,55],103:38,104:[1,64],106:[1,65],107:39,108:[1,66],109:40,110:[1,67],111:68,119:[1,41],124:36,125:[1,63],127:[1,29],128:[1,30],129:[1,31],130:[1,32],131:[1,33],132:[1,34]},{6:[1,287],25:[1,288],26:[1,335]},{6:[2,40],25:[2,40],26:[2,40],54:[2,40],78:[2,40]},{6:[2,58],25:[2,58],26:[2,58],49:[2,58],54:[2,58]},{1:[2,175],6:[2,175],25:[2,175],26:[2,175],49:[2,175],54:[2,175],57:[2,175],73:[2,175],78:[2,175],86:[2,175],91:[2,175],93:[2,175],102:[2,175],104:[2,175],105:[2,175],106:[2,175],110:[2,175],118:[2,175],126:[2,175],129:[2,175],130:[2,175],133:[2,175],134:[2,175],135:[2,175],136:[2,175],137:[2,175],138:[2,175],139:[2,175]},{6:[2,128],25:[2,128],26:[2,128],54:[2,128],86:[2,128],91:[2,128]},{1:[2,172],6:[2,172],25:[2,172],26:[2,172],49:[2,172],54:[2,172],57:[2,172],73:[2,172],78:[2,172],86:[2,172],91:[2,172],93:[2,172],102:[2,172],103:84,104:[2,172],105:[2,172],106:[2,172],109:85,110:[2,172],111:68,118:[2,172],126:[2,172],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{1:[2,173],6:[2,173],25:[2,173],26:[2,173],49:[2,173],54:[2,173],57:[2,173],73:[2,173],78:[2,173],86:[2,173],91:[2,173],93:[2,173],102:[2,173],103:84,104:[2,173],105:[2,173],106:[2,173],109:85,110:[2,173],111:68,118:[2,173],126:[2,173],129:[1,76],130:[1,75],133:[1,74],134:[1,77],135:[1,78],136:[1,79],137:[1,80],138:[1,81],139:[1,82]},{6:[2,95],25:[2,95],26:[2,95],54:[2,95],78:[2,95]}],defaultActions:{59:[2,50],60:[2,51],91:[2,109],192:[2,89]},parseError:function parseError(str,hash){if(hash.recoverable){this.trace(str)
}else{throw new Error(str)}},parse:function parse(input){var self=this,stack=[0],vstack=[null],lstack=[],table=this.table,yytext="",yylineno=0,yyleng=0,recovering=0,TERROR=2,EOF=1;var args=lstack.slice.call(arguments,1);this.lexer.setInput(input);this.lexer.yy=this.yy;this.yy.lexer=this.lexer;this.yy.parser=this;if(typeof this.lexer.yylloc=="undefined"){this.lexer.yylloc={}}var yyloc=this.lexer.yylloc;lstack.push(yyloc);var ranges=this.lexer.options&&this.lexer.options.ranges;if(typeof this.yy.parseError==="function"){this.parseError=this.yy.parseError}else{this.parseError=Object.getPrototypeOf(this).parseError}function popStack(n){stack.length=stack.length-2*n;vstack.length=vstack.length-n;lstack.length=lstack.length-n}function lex(){var token;token=self.lexer.lex()||EOF;if(typeof token!=="number"){token=self.symbols_[token]||token}return token}var symbol,preErrorSymbol,state,action,a,r,yyval={},p,len,newState,expected;while(true){state=stack[stack.length-1];if(this.defaultActions[state]){action=this.defaultActions[state]}else{if(symbol===null||typeof symbol=="undefined"){symbol=lex()}action=table[state]&&table[state][symbol]}if(typeof action==="undefined"||!action.length||!action[0]){var errStr="";expected=[];for(p in table[state]){if(this.terminals_[p]&&p>TERROR){expected.push("'"+this.terminals_[p]+"'")}}if(this.lexer.showPosition){errStr="Parse error on line "+(yylineno+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+expected.join(", ")+", got '"+(this.terminals_[symbol]||symbol)+"'"}else{errStr="Parse error on line "+(yylineno+1)+": Unexpected "+(symbol==EOF?"end of input":"'"+(this.terminals_[symbol]||symbol)+"'")}this.parseError(errStr,{text:this.lexer.match,token:this.terminals_[symbol]||symbol,line:this.lexer.yylineno,loc:yyloc,expected:expected})}if(action[0]instanceof Array&&action.length>1){throw new Error("Parse Error: multiple actions possible at state: "+state+", token: "+symbol)}switch(action[0]){case 1:stack.push(symbol);vstack.push(this.lexer.yytext);lstack.push(this.lexer.yylloc);stack.push(action[1]);symbol=null;if(!preErrorSymbol){yyleng=this.lexer.yyleng;yytext=this.lexer.yytext;yylineno=this.lexer.yylineno;yyloc=this.lexer.yylloc;if(recovering>0){recovering--}}else{symbol=preErrorSymbol;preErrorSymbol=null}break;case 2:len=this.productions_[action[1]][1];yyval.$=vstack[vstack.length-len];yyval._$={first_line:lstack[lstack.length-(len||1)].first_line,last_line:lstack[lstack.length-1].last_line,first_column:lstack[lstack.length-(len||1)].first_column,last_column:lstack[lstack.length-1].last_column};if(ranges){yyval._$.range=[lstack[lstack.length-(len||1)].range[0],lstack[lstack.length-1].range[1]]}r=this.performAction.apply(yyval,[yytext,yyleng,yylineno,this.yy,action[1],vstack,lstack].concat(args));if(typeof r!=="undefined"){return r}if(len){stack=stack.slice(0,-1*len*2);vstack=vstack.slice(0,-1*len);lstack=lstack.slice(0,-1*len)}stack.push(this.productions_[action[1]][0]);vstack.push(yyval.$);lstack.push(yyval._$);newState=table[stack[stack.length-2]][stack[stack.length-1]];stack.push(newState);break;case 3:return true}}return true}};function Parser(){this.yy={}}Parser.prototype=parser;parser.Parser=Parser;return new Parser}();if(typeof require!=="undefined"&&typeof exports!=="undefined"){exports.parser=parser;exports.Parser=parser.Parser;exports.parse=function(){return parser.parse.apply(parser,arguments)};exports.main=function commonjsMain(args){if(!args[1]){console.log("Usage: "+args[0]+" FILE");process.exit(1)}var source=require("fs").readFileSync(require("path").normalize(args[1]),"utf8");return exports.parser.parse(source)};if(typeof module!=="undefined"&&require.main===module){exports.main(process.argv.slice(1))}}},{__browserify_process:510,fs:505,path:514}],121:[function(require,module,exports){(function(){var CoffeeScript,Module,binary,child_process,ext,findExtension,fork,helpers,loadFile,path,_i,_len,_ref;CoffeeScript=require("./coffee-script");child_process=require("child_process");helpers=require("./helpers");path=require("path");loadFile=function(module,filename){var answer;answer=CoffeeScript._compileFile(filename,false);return module._compile(answer,filename)};if(require.extensions){_ref=CoffeeScript.FILE_EXTENSIONS;for(_i=0,_len=_ref.length;_i<_len;_i++){ext=_ref[_i];require.extensions[ext]=loadFile}Module=require("module");findExtension=function(filename){var curExtension,extensions;extensions=path.basename(filename).split(".");if(extensions[0]===""){extensions.shift()}while(extensions.shift()){curExtension="."+extensions.join(".");if(Module._extensions[curExtension]){return curExtension}}return".js"};Module.prototype.load=function(filename){var extension;this.filename=filename;this.paths=Module._nodeModulePaths(path.dirname(filename));extension=findExtension(filename);Module._extensions[extension](this,filename);return this.loaded=true}}if(child_process){fork=child_process.fork;binary=require.resolve("../../bin/coffee");child_process.fork=function(path,args,options){if(helpers.isCoffee(path)){if(!Array.isArray(args)){options=args||{};args=[]}args=[path].concat(args);path=binary}return fork(path,args,options)}}}).call(this)},{"./coffee-script":116,"./helpers":117,child_process:505,module:505,path:514}],122:[function(require,module,exports){(function(){var BALANCED_PAIRS,CALL_CLOSERS,EXPRESSION_CLOSE,EXPRESSION_END,EXPRESSION_START,IMPLICIT_CALL,IMPLICIT_END,IMPLICIT_FUNC,IMPLICIT_UNSPACED_CALL,INVERSES,LINEBREAKS,SINGLE_CLOSERS,SINGLE_LINERS,generate,left,rite,_i,_len,_ref,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1},__slice=[].slice;generate=function(tag,value,origin){var tok;tok=[tag,value];tok.generated=true;if(origin){tok.origin=origin}return tok};exports.Rewriter=function(){function Rewriter(){}Rewriter.prototype.rewrite=function(tokens){this.tokens=tokens;this.removeLeadingNewlines();this.closeOpenCalls();this.closeOpenIndexes();this.normalizeLines();this.tagPostfixConditionals();this.addImplicitBracesAndParens();this.addLocationDataToGeneratedTokens();return this.tokens};Rewriter.prototype.scanTokens=function(block){var i,token,tokens;tokens=this.tokens;i=0;while(token=tokens[i]){i+=block.call(this,token,i,tokens)}return true};Rewriter.prototype.detectEnd=function(i,condition,action){var levels,token,tokens,_ref,_ref1;tokens=this.tokens;levels=0;while(token=tokens[i]){if(levels===0&&condition.call(this,token,i)){return action.call(this,token,i)}if(!token||levels<0){return action.call(this,token,i-1)}if(_ref=token[0],__indexOf.call(EXPRESSION_START,_ref)>=0){levels+=1}else if(_ref1=token[0],__indexOf.call(EXPRESSION_END,_ref1)>=0){levels-=1}i+=1}return i-1};Rewriter.prototype.removeLeadingNewlines=function(){var i,tag,_i,_len,_ref;_ref=this.tokens;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){tag=_ref[i][0];if(tag!=="TERMINATOR"){break}}if(i){return this.tokens.splice(0,i)}};Rewriter.prototype.closeOpenCalls=function(){var action,condition;condition=function(token,i){var _ref;return(_ref=token[0])===")"||_ref==="CALL_END"||token[0]==="OUTDENT"&&this.tag(i-1)===")"};action=function(token,i){return this.tokens[token[0]==="OUTDENT"?i-1:i][0]="CALL_END"};return this.scanTokens(function(token,i){if(token[0]==="CALL_START"){this.detectEnd(i+1,condition,action)}return 1})};Rewriter.prototype.closeOpenIndexes=function(){var action,condition;condition=function(token,i){var _ref;return(_ref=token[0])==="]"||_ref==="INDEX_END"};action=function(token,i){return token[0]="INDEX_END"};return this.scanTokens(function(token,i){if(token[0]==="INDEX_START"){this.detectEnd(i+1,condition,action)}return 1})};Rewriter.prototype.matchTags=function(){var fuzz,i,j,pattern,_i,_ref,_ref1;i=arguments[0],pattern=2<=arguments.length?__slice.call(arguments,1):[];fuzz=0;for(j=_i=0,_ref=pattern.length;0<=_ref?_i<_ref:_i>_ref;j=0<=_ref?++_i:--_i){while(this.tag(i+j+fuzz)==="HERECOMMENT"){fuzz+=2}if(pattern[j]==null){continue}if(typeof pattern[j]==="string"){pattern[j]=[pattern[j]]}if(_ref1=this.tag(i+j+fuzz),__indexOf.call(pattern[j],_ref1)<0){return false}}return true};Rewriter.prototype.looksObjectish=function(j){return this.matchTags(j,"@",null,":")||this.matchTags(j,null,":")};Rewriter.prototype.findTagsBackwards=function(i,tags){var backStack,_ref,_ref1,_ref2,_ref3,_ref4,_ref5;backStack=[];while(i>=0&&(backStack.length||(_ref2=this.tag(i),__indexOf.call(tags,_ref2)<0)&&((_ref3=this.tag(i),__indexOf.call(EXPRESSION_START,_ref3)<0)||this.tokens[i].generated)&&(_ref4=this.tag(i),__indexOf.call(LINEBREAKS,_ref4)<0))){if(_ref=this.tag(i),__indexOf.call(EXPRESSION_END,_ref)>=0){backStack.push(this.tag(i))}if((_ref1=this.tag(i),__indexOf.call(EXPRESSION_START,_ref1)>=0)&&backStack.length){backStack.pop()}i-=1}return _ref5=this.tag(i),__indexOf.call(tags,_ref5)>=0};Rewriter.prototype.addImplicitBracesAndParens=function(){var stack;stack=[];return this.scanTokens(function(token,i,tokens){var endImplicitCall,endImplicitObject,forward,inImplicit,inImplicitCall,inImplicitControl,inImplicitObject,newLine,nextTag,offset,prevTag,prevToken,s,sameLine,stackIdx,stackTag,stackTop,startIdx,startImplicitCall,startImplicitObject,startsLine,tag,_ref,_ref1,_ref2,_ref3,_ref4,_ref5;tag=token[0];prevTag=(prevToken=i>0?tokens[i-1]:[])[0];nextTag=(i<tokens.length-1?tokens[i+1]:[])[0];stackTop=function(){return stack[stack.length-1]};startIdx=i;forward=function(n){return i-startIdx+n};inImplicit=function(){var _ref,_ref1;return(_ref=stackTop())!=null?(_ref1=_ref[2])!=null?_ref1.ours:void 0:void 0};inImplicitCall=function(){var _ref;return inImplicit()&&((_ref=stackTop())!=null?_ref[0]:void 0)==="("};inImplicitObject=function(){var _ref;return inImplicit()&&((_ref=stackTop())!=null?_ref[0]:void 0)==="{"};inImplicitControl=function(){var _ref;return inImplicit&&((_ref=stackTop())!=null?_ref[0]:void 0)==="CONTROL"};startImplicitCall=function(j){var idx;idx=j!=null?j:i;stack.push(["(",idx,{ours:true}]);tokens.splice(idx,0,generate("CALL_START","("));if(j==null){return i+=1}};endImplicitCall=function(){stack.pop();tokens.splice(i,0,generate("CALL_END",")"));return i+=1};startImplicitObject=function(j,startsLine){var idx;if(startsLine==null){startsLine=true}idx=j!=null?j:i;stack.push(["{",idx,{sameLine:true,startsLine:startsLine,ours:true}]);tokens.splice(idx,0,generate("{",generate(new String("{")),token));if(j==null){return i+=1}};endImplicitObject=function(j){j=j!=null?j:i;stack.pop();tokens.splice(j,0,generate("}","}",token));return i+=1};if(inImplicitCall()&&(tag==="IF"||tag==="TRY"||tag==="FINALLY"||tag==="CATCH"||tag==="CLASS"||tag==="SWITCH")){stack.push(["CONTROL",i,{ours:true}]);return forward(1)}if(tag==="INDENT"&&inImplicit()){if(prevTag!=="=>"&&prevTag!=="->"&&prevTag!=="["&&prevTag!=="("&&prevTag!==","&&prevTag!=="{"&&prevTag!=="TRY"&&prevTag!=="ELSE"&&prevTag!=="="){while(inImplicitCall()){endImplicitCall()}}if(inImplicitControl()){stack.pop()}stack.push([tag,i]);return forward(1)}if(__indexOf.call(EXPRESSION_START,tag)>=0){stack.push([tag,i]);return forward(1)}if(__indexOf.call(EXPRESSION_END,tag)>=0){while(inImplicit()){if(inImplicitCall()){endImplicitCall()}else if(inImplicitObject()){endImplicitObject()}else{stack.pop()}}stack.pop()}if((__indexOf.call(IMPLICIT_FUNC,tag)>=0&&token.spaced&&!token.stringEnd||tag==="?"&&i>0&&!tokens[i-1].spaced)&&(__indexOf.call(IMPLICIT_CALL,nextTag)>=0||__indexOf.call(IMPLICIT_UNSPACED_CALL,nextTag)>=0&&!((_ref=tokens[i+1])!=null?_ref.spaced:void 0)&&!((_ref1=tokens[i+1])!=null?_ref1.newLine:void 0))){if(tag==="?"){tag=token[0]="FUNC_EXIST"}startImplicitCall(i+1);return forward(2)}if(__indexOf.call(IMPLICIT_FUNC,tag)>=0&&this.matchTags(i+1,"INDENT",null,":")&&!this.findTagsBackwards(i,["CLASS","EXTENDS","IF","CATCH","SWITCH","LEADING_WHEN","FOR","WHILE","UNTIL"])){startImplicitCall(i+1);stack.push(["INDENT",i+2]);return forward(3)}if(tag===":"){if(this.tag(i-2)==="@"){s=i-2}else{s=i-1}while(this.tag(s-2)==="HERECOMMENT"){s-=2}this.insideForDeclaration=nextTag==="FOR";startsLine=s===0||(_ref2=this.tag(s-1),__indexOf.call(LINEBREAKS,_ref2)>=0)||tokens[s-1].newLine;if(stackTop()){_ref3=stackTop(),stackTag=_ref3[0],stackIdx=_ref3[1];if((stackTag==="{"||stackTag==="INDENT"&&this.tag(stackIdx-1)==="{")&&(startsLine||this.tag(s-1)===","||this.tag(s-1)==="{")){return forward(1)}}startImplicitObject(s,!!startsLine);return forward(2)}if(inImplicitObject()&&__indexOf.call(LINEBREAKS,tag)>=0){stackTop()[2].sameLine=false}newLine=prevTag==="OUTDENT"||prevToken.newLine;if(__indexOf.call(IMPLICIT_END,tag)>=0||__indexOf.call(CALL_CLOSERS,tag)>=0&&newLine){while(inImplicit()){_ref4=stackTop(),stackTag=_ref4[0],stackIdx=_ref4[1],_ref5=_ref4[2],sameLine=_ref5.sameLine,startsLine=_ref5.startsLine;if(inImplicitCall()&&prevTag!==","){endImplicitCall()}else if(inImplicitObject()&&!this.insideForDeclaration&&sameLine&&tag!=="TERMINATOR"&&prevTag!==":"&&endImplicitObject()){}else if(inImplicitObject()&&tag==="TERMINATOR"&&prevTag!==","&&!(startsLine&&this.looksObjectish(i+1))){endImplicitObject()}else{break}}}if(tag===","&&!this.looksObjectish(i+1)&&inImplicitObject()&&!this.insideForDeclaration&&(nextTag!=="TERMINATOR"||!this.looksObjectish(i+2))){offset=nextTag==="OUTDENT"?1:0;while(inImplicitObject()){endImplicitObject(i+offset)}}return forward(1)})};Rewriter.prototype.addLocationDataToGeneratedTokens=function(){return this.scanTokens(function(token,i,tokens){var column,line,nextLocation,prevLocation,_ref,_ref1;if(token[2]){return 1}if(!(token.generated||token.explicit)){return 1}if(token[0]==="{"&&(nextLocation=(_ref=tokens[i+1])!=null?_ref[2]:void 0)){line=nextLocation.first_line,column=nextLocation.first_column}else if(prevLocation=(_ref1=tokens[i-1])!=null?_ref1[2]:void 0){line=prevLocation.last_line,column=prevLocation.last_column}else{line=column=0}token[2]={first_line:line,first_column:column,last_line:line,last_column:column};return 1})};Rewriter.prototype.normalizeLines=function(){var action,condition,indent,outdent,starter;starter=indent=outdent=null;condition=function(token,i){var _ref,_ref1,_ref2,_ref3;return token[1]!==";"&&(_ref=token[0],__indexOf.call(SINGLE_CLOSERS,_ref)>=0)&&!(token[0]==="TERMINATOR"&&(_ref1=this.tag(i+1),__indexOf.call(EXPRESSION_CLOSE,_ref1)>=0))&&!(token[0]==="ELSE"&&starter!=="THEN")&&!(((_ref2=token[0])==="CATCH"||_ref2==="FINALLY")&&(starter==="->"||starter==="=>"))||(_ref3=token[0],__indexOf.call(CALL_CLOSERS,_ref3)>=0)&&this.tokens[i-1].newLine};action=function(token,i){return this.tokens.splice(this.tag(i-1)===","?i-1:i,0,outdent)};return this.scanTokens(function(token,i,tokens){var j,tag,_i,_ref,_ref1,_ref2;tag=token[0];if(tag==="TERMINATOR"){if(this.tag(i+1)==="ELSE"&&this.tag(i-1)!=="OUTDENT"){tokens.splice.apply(tokens,[i,1].concat(__slice.call(this.indentation())));return 1}if(_ref=this.tag(i+1),__indexOf.call(EXPRESSION_CLOSE,_ref)>=0){tokens.splice(i,1);return 0}}if(tag==="CATCH"){for(j=_i=1;_i<=2;j=++_i){if(!((_ref1=this.tag(i+j))==="OUTDENT"||_ref1==="TERMINATOR"||_ref1==="FINALLY")){continue}tokens.splice.apply(tokens,[i+j,0].concat(__slice.call(this.indentation())));return 2+j}}if(__indexOf.call(SINGLE_LINERS,tag)>=0&&this.tag(i+1)!=="INDENT"&&!(tag==="ELSE"&&this.tag(i+1)==="IF")){starter=tag;_ref2=this.indentation(tokens[i]),indent=_ref2[0],outdent=_ref2[1];if(starter==="THEN"){indent.fromThen=true}tokens.splice(i+1,0,indent);this.detectEnd(i+2,condition,action);if(tag==="THEN"){tokens.splice(i,1)}return 1}return 1})};Rewriter.prototype.tagPostfixConditionals=function(){var action,condition,original;original=null;condition=function(token,i){var prevTag,tag;tag=token[0];prevTag=this.tokens[i-1][0];return tag==="TERMINATOR"||tag==="INDENT"&&__indexOf.call(SINGLE_LINERS,prevTag)<0};action=function(token,i){if(token[0]!=="INDENT"||token.generated&&!token.fromThen){return original[0]="POST_"+original[0]}};return this.scanTokens(function(token,i){if(token[0]!=="IF"){return 1}original=token;this.detectEnd(i+1,condition,action);return 1})};Rewriter.prototype.indentation=function(origin){var indent,outdent;indent=["INDENT",2];outdent=["OUTDENT",2];if(origin){indent.generated=outdent.generated=true;indent.origin=outdent.origin=origin}else{indent.explicit=outdent.explicit=true}return[indent,outdent]};Rewriter.prototype.generate=generate;Rewriter.prototype.tag=function(i){var _ref;return(_ref=this.tokens[i])!=null?_ref[0]:void 0};return Rewriter}();BALANCED_PAIRS=[["(",")"],["[","]"],["{","}"],["INDENT","OUTDENT"],["CALL_START","CALL_END"],["PARAM_START","PARAM_END"],["INDEX_START","INDEX_END"]];exports.INVERSES=INVERSES={};EXPRESSION_START=[];EXPRESSION_END=[];for(_i=0,_len=BALANCED_PAIRS.length;_i<_len;_i++){_ref=BALANCED_PAIRS[_i],left=_ref[0],rite=_ref[1];EXPRESSION_START.push(INVERSES[rite]=left);EXPRESSION_END.push(INVERSES[left]=rite)}EXPRESSION_CLOSE=["CATCH","THEN","ELSE","FINALLY"].concat(EXPRESSION_END);IMPLICIT_FUNC=["IDENTIFIER","SUPER",")","CALL_END","]","INDEX_END","@","THIS"];IMPLICIT_CALL=["IDENTIFIER","NUMBER","STRING","JS","REGEX","NEW","PARAM_START","CLASS","IF","TRY","SWITCH","THIS","BOOL","NULL","UNDEFINED","UNARY","UNARY_MATH","SUPER","THROW","@","->","=>","[","(","{","--","++"];IMPLICIT_UNSPACED_CALL=["+","-"];IMPLICIT_END=["POST_IF","FOR","WHILE","UNTIL","WHEN","BY","LOOP","TERMINATOR"];SINGLE_LINERS=["ELSE","->","=>","TRY","FINALLY","THEN"];SINGLE_CLOSERS=["TERMINATOR","CATCH","FINALLY","ELSE","OUTDENT","LEADING_WHEN"];LINEBREAKS=["TERMINATOR","INDENT","OUTDENT"];CALL_CLOSERS=[".","?.","::","?::"]}).call(this)},{}],123:[function(require,module,exports){(function(){var Scope,extend,last,_ref;_ref=require("./helpers"),extend=_ref.extend,last=_ref.last;exports.Scope=Scope=function(){Scope.root=null;function Scope(parent,expressions,method){this.parent=parent;this.expressions=expressions;this.method=method;this.variables=[{name:"arguments",type:"arguments"}];this.positions={};if(!this.parent){Scope.root=this}}Scope.prototype.add=function(name,type,immediate){if(this.shared&&!immediate){return this.parent.add(name,type,immediate)}if(Object.prototype.hasOwnProperty.call(this.positions,name)){return this.variables[this.positions[name]].type=type}else{return this.positions[name]=this.variables.push({name:name,type:type})-1}};Scope.prototype.namedMethod=function(){var _ref1;if(((_ref1=this.method)!=null?_ref1.name:void 0)||!this.parent){return this.method}return this.parent.namedMethod()};Scope.prototype.find=function(name){if(this.check(name)){return true}this.add(name,"var");return false};Scope.prototype.parameter=function(name){if(this.shared&&this.parent.check(name,true)){return}return this.add(name,"param")};Scope.prototype.check=function(name){var _ref1;return!!(this.type(name)||((_ref1=this.parent)!=null?_ref1.check(name):void 0))};Scope.prototype.temporary=function(name,index){if(name.length>1){return"_"+name+(index>1?index-1:"")}else{return"_"+(index+parseInt(name,36)).toString(36).replace(/\d/g,"a")}};Scope.prototype.type=function(name){var v,_i,_len,_ref1;_ref1=this.variables;for(_i=0,_len=_ref1.length;_i<_len;_i++){v=_ref1[_i];if(v.name===name){return v.type}}return null};Scope.prototype.freeVariable=function(name,reserve){var index,temp;if(reserve==null){reserve=true}index=0;while(this.check(temp=this.temporary(name,index))){index++}if(reserve){this.add(temp,"var",true)}return temp};Scope.prototype.assign=function(name,value){this.add(name,{value:value,assigned:true},true);return this.hasAssignments=true};Scope.prototype.hasDeclarations=function(){return!!this.declaredVariables().length};Scope.prototype.declaredVariables=function(){var realVars,tempVars,v,_i,_len,_ref1;realVars=[];tempVars=[];_ref1=this.variables;for(_i=0,_len=_ref1.length;_i<_len;_i++){v=_ref1[_i];if(v.type==="var"){(v.name.charAt(0)==="_"?tempVars:realVars).push(v.name)}}return realVars.sort().concat(tempVars.sort())};Scope.prototype.assignedVariables=function(){var v,_i,_len,_ref1,_results;_ref1=this.variables;_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){v=_ref1[_i];if(v.type.assigned){_results.push(""+v.name+" = "+v.type.value)}}return _results};return Scope}()}).call(this)},{"./helpers":117}],124:[function(require,module,exports){(function(){var LineMap,SourceMap;LineMap=function(){function LineMap(line){this.line=line;this.columns=[]}LineMap.prototype.add=function(column,_arg,options){var sourceColumn,sourceLine;sourceLine=_arg[0],sourceColumn=_arg[1];if(options==null){options={}}if(this.columns[column]&&options.noReplace){return}return this.columns[column]={line:this.line,column:column,sourceLine:sourceLine,sourceColumn:sourceColumn}};LineMap.prototype.sourceLocation=function(column){var mapping;while(!((mapping=this.columns[column])||column<=0)){column--}return mapping&&[mapping.sourceLine,mapping.sourceColumn]};return LineMap}();SourceMap=function(){var BASE64_CHARS,VLQ_CONTINUATION_BIT,VLQ_SHIFT,VLQ_VALUE_MASK;function SourceMap(){this.lines=[]}SourceMap.prototype.add=function(sourceLocation,generatedLocation,options){var column,line,lineMap,_base;if(options==null){options={}}line=generatedLocation[0],column=generatedLocation[1];lineMap=(_base=this.lines)[line]||(_base[line]=new LineMap(line));return lineMap.add(column,sourceLocation,options)};SourceMap.prototype.sourceLocation=function(_arg){var column,line,lineMap;line=_arg[0],column=_arg[1];while(!((lineMap=this.lines[line])||line<=0)){line--}return lineMap&&lineMap.sourceLocation(column)};SourceMap.prototype.generate=function(options,code){var buffer,lastColumn,lastSourceColumn,lastSourceLine,lineMap,lineNumber,mapping,needComma,v3,writingline,_i,_j,_len,_len1,_ref,_ref1;if(options==null){options={}}if(code==null){code=null}writingline=0;lastColumn=0;lastSourceLine=0;lastSourceColumn=0;needComma=false;buffer="";_ref=this.lines;for(lineNumber=_i=0,_len=_ref.length;_i<_len;lineNumber=++_i){lineMap=_ref[lineNumber];if(lineMap){_ref1=lineMap.columns;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){mapping=_ref1[_j];if(!mapping){continue}while(writingline<mapping.line){lastColumn=0;needComma=false;buffer+=";";writingline++}if(needComma){buffer+=",";needComma=false}buffer+=this.encodeVlq(mapping.column-lastColumn);lastColumn=mapping.column;buffer+=this.encodeVlq(0);buffer+=this.encodeVlq(mapping.sourceLine-lastSourceLine);lastSourceLine=mapping.sourceLine;buffer+=this.encodeVlq(mapping.sourceColumn-lastSourceColumn);lastSourceColumn=mapping.sourceColumn;needComma=true}}}v3={version:3,file:options.generatedFile||"",sourceRoot:options.sourceRoot||"",sources:options.sourceFiles||[""],names:[],mappings:buffer};if(options.inline){v3.sourcesContent=[code]}return JSON.stringify(v3,null,2)};VLQ_SHIFT=5;VLQ_CONTINUATION_BIT=1<<VLQ_SHIFT;VLQ_VALUE_MASK=VLQ_CONTINUATION_BIT-1;SourceMap.prototype.encodeVlq=function(value){var answer,nextChunk,signBit,valueToEncode;answer="";signBit=value<0?1:0;valueToEncode=(Math.abs(value)<<1)+signBit;while(valueToEncode||!answer){nextChunk=valueToEncode&VLQ_VALUE_MASK;valueToEncode=valueToEncode>>VLQ_SHIFT;if(valueToEncode){nextChunk|=VLQ_CONTINUATION_BIT}answer+=this.encodeBase64(nextChunk)}return answer};BASE64_CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";SourceMap.prototype.encodeBase64=function(value){return BASE64_CHARS[value]||function(){throw new Error("Cannot Base64 encode value: "+value)}()};return SourceMap}();module.exports=SourceMap}).call(this)},{}],125:[function(require,module,exports){module.exports=require(40)},{"./init.json":126,"./types.json":127,events:507}],126:[function(require,module,exports){module.exports=require(41)},{}],127:[function(require,module,exports){module.exports=require(42)},{}],128:[function(require,module,exports){if(!String.prototype.endsWith){(function(){"use strict";var toString={}.toString;var endsWith=function(search){if(this==null){throw TypeError()}var string=String(this);if(search&&toString.call(search)=="[object RegExp]"){throw TypeError()}var stringLength=string.length;var searchString=String(search);var searchLength=searchString.length;var pos=stringLength;if(arguments.length>1){var position=arguments[1];if(position!==undefined){pos=position?Number(position):0;if(pos!=pos){pos=0}}}var end=Math.min(Math.max(pos,0),stringLength);var start=end-searchLength;if(start<0){return false}var index=-1;while(++index<searchLength){if(string.charCodeAt(start+index)!=searchString.charCodeAt(index)){return false}}return true};if(Object.defineProperty){Object.defineProperty(String.prototype,"endsWith",{value:endsWith,configurable:true,writable:true})}else{String.prototype.endsWith=endsWith}})()}},{}],129:[function(require,module,exports){var process=require("__browserify_process");var voxel=require("voxel");var voxelMesh=require("voxel-mesh");var ray=require("voxel-raycast");var texture=require("voxel-texture");var control=require("voxel-control");var voxelView=require("voxel-view");var THREE=require("three");var Stats=require("./lib/stats");var Detector=require("./lib/detector");var inherits=require("inherits");var path=require("path");var EventEmitter=require("events").EventEmitter;if(process.browser)var interact=require("interact");var requestAnimationFrame=require("raf");var collisions=require("collide-3d-tilemap");var aabb=require("aabb-3d");var glMatrix=require("gl-matrix");var vector=glMatrix.vec3;var SpatialEventEmitter=require("spatial-events");var regionChange=require("voxel-region-change");var kb=require("kb-bindings");var physical=require("voxel-physical");var pin=require("pin-it");var tic=require("tic")();module.exports=Game;function Game(opts){if(!(this instanceof Game))return new Game(opts);var self=this;if(!opts)opts={};if(process.browser&&this.notCapable(opts))return;this.isClient=Boolean(typeof opts.isClient!=="undefined"?opts.isClient:process.browser);if(!("generateChunks"in opts))opts.generateChunks=true;this.generateChunks=opts.generateChunks;this.setConfigurablePositions(opts);this.configureChunkLoading(opts);this.setDimensions(opts);this.THREE=THREE;this.vector=vector;this.glMatrix=glMatrix;this.arrayType=opts.arrayType||{1:Uint8Array,2:Uint16Array,4:Uint32Array}[opts.arrayTypeSize]||Uint8Array;this.cubeSize=1;this.chunkSize=opts.chunkSize||32;this.texture_modules=opts.texture_modules||[texture];this.chunkDistance=opts.chunkDistance||2;this.removeDistance=opts.removeDistance||this.chunkDistance+1;this.skyColor=opts.skyColor||12571109;this.playerHeight=opts.playerHeight||1.62;this.meshType=opts.meshType||"surfaceMesh";this.mesher=opts.mesher||voxel.meshers.transgreedy;this.materialType=opts.materialType||THREE.MeshLambertMaterial;this.materialParams=opts.materialParams||{};this.materialTransparentTypes=opts.materialTransparentTypes||{};this.items=[];this.voxels=voxel(this);this.scene=new THREE.Scene;this.view=opts.view||new voxelView(THREE,{width:this.width,height:this.height,skyColor:this.skyColor});this.view.bindToScene(this.scene);this.camera=this.view.getCamera();if(!opts.lightsDisabled)this.addLights(this.scene);this.fogScale=opts.fogScale||32;if(!opts.fogDisabled)this.scene.fog=new THREE.Fog(this.skyColor,25e-5,this.worldWidth()*this.fogScale);this.collideVoxels=collisions(this.getBlock.bind(this),1,[Infinity,Infinity,Infinity],[-Infinity,-Infinity,-Infinity]);this.timer=this.initializeTimer(opts.tickFPS||16);this.paused=false;this.spatial=new SpatialEventEmitter;this.region=regionChange(this.spatial,aabb([0,0,0],[1,1,1]),this.chunkSize);this.voxelRegion=regionChange(this.spatial,1);this.chunkRegion=regionChange(this.spatial,this.chunkSize);this.asyncChunkGeneration=false;this.chunksNeedsUpdate={};this.pendingChunks=[];if(this.isClient){this.materials=this.texture_modules[0](this.texture_opts={useAtlas:opts.useAtlas===undefined?false:opts.useAtlas,texturePath:opts.texturePath||"./textures/",artPacks:opts.artPacks,materialType:opts.materialType||THREE.MeshLambertMaterial,materialParams:opts.materialParams||{},materialFlatColor:opts.materialFlatColor===true,game:this});if(opts.appendDocument)this.appendTo(document.body);if(opts.exposeGlobal)window.game=window.g=this}this.materialNames=opts.materials||[["grass","dirt","grass_dirt"],"brick","dirt"];self.chunkRegion.on("change",function(newChunk){self.removeFarChunks()});if(this.isClient)this.materials.load(this.materialNames);if(this.generateChunks)this.handleChunkGeneration();if(!this.isClient)return;this.paused=true;this.initializeRendering(opts);this.showAllChunks();setTimeout(function(){self.asyncChunkGeneration="asyncChunkGeneration"in opts?opts.asyncChunkGeneration:true},2e3);this.initializeControls(opts)}inherits(Game,EventEmitter);Game.prototype.voxelPosition=function(gamePosition){var _=Math.floor;var p=gamePosition;var v=[];v[0]=_(p[0]);v[1]=_(p[1]);v[2]=_(p[2]);return v};Game.prototype.cameraPosition=function(){return this.view.cameraPosition()};Game.prototype.cameraVector=function(){return this.view.cameraVector()};Game.prototype.makePhysical=function(target,envelope,blocksCreation){var vel=this.terminalVelocity;envelope=envelope||[2/3,1.5,2/3];var obj=physical(target,this.potentialCollisionSet(),envelope,{x:vel[0],y:vel[1],z:vel[2]});obj.blocksCreation=!!blocksCreation;return obj};Game.prototype.addItem=function(item){if(!item.tick){var newItem=physical(item.mesh,this.potentialCollisionSet(),[item.size,item.size,item.size]);if(item.velocity){newItem.velocity.copy(item.velocity);newItem.subjectTo(this.gravity)}newItem.repr=function(){return"debris"};newItem.mesh=item.mesh;newItem.blocksCreation=item.blocksCreation;item=newItem}this.items.push(item);if(item.mesh)this.scene.add(item.mesh);return this.items[this.items.length-1]};Game.prototype.removeItem=function(item){var ix=this.items.indexOf(item);if(ix<0)return;this.items.splice(ix,1);if(item.mesh)this.scene.remove(item.mesh)};Game.prototype.raycast=Game.prototype.raycastVoxels=function(start,direction,maxDistance,epilson){if(!start)return this.raycastVoxels(this.cameraPosition(),this.cameraVector(),10);var hitNormal=[0,0,0];var hitPosition=[0,0,0];var cp=start||this.cameraPosition();var cv=direction||this.cameraVector();var hitBlock=ray(this,cp,cv,maxDistance||10,hitPosition,hitNormal,epilson||this.epilson);if(hitBlock<=0)return false;var adjacentPosition=[0,0,0];var voxelPosition=this.voxelPosition(hitPosition);vector.add(adjacentPosition,voxelPosition,hitNormal);return{position:hitPosition,voxel:voxelPosition,direction:direction,value:hitBlock,normal:hitNormal,adjacent:adjacentPosition}};Game.prototype.canCreateBlock=function(pos){pos=this.parseVectorArguments(arguments);var floored=pos.map(function(i){return Math.floor(i)});var bbox=aabb(floored,[1,1,1]);for(var i=0,len=this.items.length;i<len;++i){var item=this.items[i];var itemInTheWay=item.blocksCreation&&item.aabb&&bbox.intersects(item.aabb());if(itemInTheWay)return false}return true};Game.prototype.createBlock=function(pos,val){if(typeof val==="string")val=this.materials.find(val);if(!this.canCreateBlock(pos))return false;this.setBlock(pos,val);return true};Game.prototype.setBlock=function(pos,val){if(typeof val==="string")val=this.materials.find(val);var old=this.voxels.voxelAtPosition(pos,val);var c=this.voxels.chunkAtPosition(pos);var chunk=this.voxels.chunks[c.join("|")];if(!chunk)return;this.addChunkToNextUpdate(chunk);this.spatial.emit("change-block",pos,old,val);this.emit("setBlock",pos,val,old)};Game.prototype.getBlock=function(pos){pos=this.parseVectorArguments(arguments);return this.voxels.voxelAtPosition(pos)};Game.prototype.blockPosition=function(pos){pos=this.parseVectorArguments(arguments);var ox=Math.floor(pos[0]);var oy=Math.floor(pos[1]);var oz=Math.floor(pos[2]);return[ox,oy,oz]};Game.prototype.blocks=function(low,high,iterator){var l=low,h=high;var d=[h[0]-l[0],h[1]-l[1],h[2]-l[2]];if(!iterator)var voxels=new this.arrayType(d[0]*d[1]*d[2]);var i=0;for(var z=l[2];z<h[2];++z)for(var y=l[1];y<h[1];++y)for(var x=l[0];x<h[0];++x,++i){if(iterator)iterator(x,y,z,i);else voxels[i]=this.voxels.voxelAtPosition([x,y,z])}if(!iterator)return{voxels:voxels,dims:d}};Game.prototype.createAdjacent=function(hit,val){this.createBlock(hit.adjacent,val)
};Game.prototype.appendTo=function(element){this.view.appendTo(element)};Game.prototype.gravity=[0,-36e-7,0];Game.prototype.friction=.3;Game.prototype.epilson=1e-8;Game.prototype.terminalVelocity=[.9,.1,.9];Game.prototype.defaultButtons={W:"forward",A:"left",S:"backward",D:"right","<up>":"forward","<left>":"left","<down>":"backward","<right>":"right","<mouse 1>":"fire","<mouse 3>":"firealt","<space>":"jump","<shift>":"crouch","<control>":"alt","<tab>":"sprint"};Game.prototype.parseVectorArguments=function(args){if(!args)return false;if(args[0]instanceof Array)return args[0];return[args[0],args[1],args[2]]};Game.prototype.setConfigurablePositions=function(opts){var sp=opts.startingPosition;this.startingPosition=sp||[35,1024,35];var wo=opts.worldOrigin;this.worldOrigin=wo||[0,0,0]};Game.prototype.setDimensions=function(opts){if(opts.container)this.container=opts.container;if(opts.container&&opts.container.clientHeight){this.height=opts.container.clientHeight}else{this.height=typeof window==="undefined"?1:window.innerHeight}if(opts.container&&opts.container.clientWidth){this.width=opts.container.clientWidth}else{this.width=typeof window==="undefined"?1:window.innerWidth}};Game.prototype.notCapable=function(opts){var self=this;if(!Detector().webgl){this.view={appendTo:function(el){el.appendChild(self.notCapableMessage())}};return true}return false};Game.prototype.notCapableMessage=function(){var wrapper=document.createElement("div");wrapper.className="errorMessage";var a=document.createElement("a");a.title="You need WebGL and Pointer Lock (Chrome 23/Firefox 14) to play this game. Click here for more information.";a.innerHTML=a.title;a.href="http://get.webgl.org";wrapper.appendChild(a);return wrapper};Game.prototype.onWindowResize=function(){var width=window.innerWidth;var height=window.innerHeight;if(this.container){width=this.container.clientWidth;height=this.container.clientHeight}this.view.resizeWindow(width,height)};Game.prototype.control=function(target){this.controlling=target;return this.controls.target(target)};Game.prototype.potentialCollisionSet=function(){return[{collide:this.collideTerrain.bind(this)}]};Game.prototype.playerPosition=function(){var target=this.controls.target();var position=target?target.avatar.position:this.camera.localToWorld(this.camera.position.clone());return[position.x,position.y,position.z]};Game.prototype.playerAABB=function(position){var pos=position||this.playerPosition();var lower=[];var upper=[1/2,this.playerHeight,1/2];var playerBottom=[1/4,this.playerHeight,1/4];vector.subtract(lower,pos,playerBottom);var bbox=aabb(lower,upper);return bbox};Game.prototype.collideTerrain=function(other,bbox,vec,resting){var self=this;var axes=["x","y","z"];var vec3=[vec.x,vec.y,vec.z];this.collideVoxels(bbox,vec3,function hit(axis,tile,coords,dir,edge){if(!tile)return;if(Math.abs(vec3[axis])<Math.abs(edge))return;vec3[axis]=vec[axes[axis]]=edge;other.acceleration[axes[axis]]=0;resting[axes[axis]]=dir;other.friction[axes[(axis+1)%3]]=other.friction[axes[(axis+2)%3]]=axis===1?self.friction:1;return true})};Game.prototype.addStats=function(){stats=new Stats;stats.domElement.style.position="absolute";stats.domElement.style.bottom="0px";document.body.appendChild(stats.domElement)};Game.prototype.addLights=function(scene){var ambientLight,directionalLight;ambientLight=new THREE.AmbientLight(13421772);scene.add(ambientLight);var light=new THREE.DirectionalLight(16777215,1);light.position.set(1,1,.5).normalize();scene.add(light)};Game.prototype.configureChunkLoading=function(opts){var self=this;if(!opts.generateChunks)return;if(!opts.generate){this.generate=function(x,y,z){return x*x+y*y+z*z<=15*15?1:0}}else{this.generate=opts.generate}if(opts.generateVoxelChunk){this.generateVoxelChunk=opts.generateVoxelChunk}else{this.generateVoxelChunk=function(low,high){return voxel.generate(low,high,self.generate,self)}}};Game.prototype.worldWidth=function(){return this.chunkSize*2*this.chunkDistance};Game.prototype.chunkToWorld=function(pos){return[pos[0]*this.chunkSize,pos[1]*this.chunkSize,pos[2]*this.chunkSize]};Game.prototype.removeFarChunks=function(playerPosition){var self=this;playerPosition=playerPosition||this.playerPosition();var nearbyChunks=this.voxels.nearbyChunks(playerPosition,this.removeDistance).map(function(chunkPos){return chunkPos.join("|")});Object.keys(self.voxels.chunks).map(function(chunkIndex){if(nearbyChunks.indexOf(chunkIndex)>-1)return;var chunk=self.voxels.chunks[chunkIndex];var mesh=self.voxels.meshes[chunkIndex];var pendingIndex=self.pendingChunks.indexOf(chunkIndex);if(pendingIndex!==-1)self.pendingChunks.splice(pendingIndex,1);if(!chunk)return;var chunkPosition=chunk.position;if(mesh){if(mesh.surfaceMesh){self.scene.remove(mesh.surfaceMesh);mesh.surfaceMesh.geometry.dispose()}if(mesh.wireMesh){mesh.wireMesh.geometry.dispose();self.scene.remove(mesh.wireMesh)}delete mesh.data;delete mesh.geometry;delete mesh.meshed;delete mesh.surfaceMesh;delete mesh.wireMesh}delete self.voxels.chunks[chunkIndex];self.emit("removeChunk",chunkPosition)});self.voxels.requestMissingChunks(playerPosition)};Game.prototype.addChunkToNextUpdate=function(chunk){this.chunksNeedsUpdate[chunk.position.join("|")]=chunk};Game.prototype.updateDirtyChunks=function(){var self=this;Object.keys(this.chunksNeedsUpdate).forEach(function showChunkAtIndex(chunkIndex){var chunk=self.chunksNeedsUpdate[chunkIndex];self.emit("dirtyChunkUpdate",chunk);self.showChunk(chunk)});this.chunksNeedsUpdate={}};Game.prototype.loadPendingChunks=function(count){var pendingChunks=this.pendingChunks;if(!this.asyncChunkGeneration){count=pendingChunks.length}else{count=count||pendingChunks.length*.1;count=Math.max(1,Math.min(count,pendingChunks.length))}for(var i=0;i<count;i+=1){var chunkPos=pendingChunks[i].split("|");var chunk=this.voxels.generateChunk(chunkPos[0]|0,chunkPos[1]|0,chunkPos[2]|0);if(this.isClient)this.showChunk(chunk)}if(count)pendingChunks.splice(0,count)};Game.prototype.getChunkAtPosition=function(pos){var chunkID=this.voxels.chunkAtPosition(pos).join("|");var chunk=this.voxels.chunks[chunkID];return chunk};Game.prototype.showAllChunks=function(){for(var chunkIndex in this.voxels.chunks){this.showChunk(this.voxels.chunks[chunkIndex])}};Game.prototype.showChunk=function(chunk){var chunkIndex=chunk.position.join("|");var bounds=this.voxels.getBounds.apply(this.voxels,chunk.position);var scale=new THREE.Vector3(1,1,1);var transparentTypes=this.materials.getTransparentVoxelTypes?this.materials.getTransparentVoxelTypes():{};var mesh=voxelMesh(chunk,this.mesher,scale,this.THREE,{transparentTypes:transparentTypes});this.voxels.chunks[chunkIndex]=chunk;if(this.voxels.meshes[chunkIndex]){if(this.voxels.meshes[chunkIndex].surfaceMesh)this.scene.remove(this.voxels.meshes[chunkIndex].surfaceMesh);if(this.voxels.meshes[chunkIndex].wireMesh)this.scene.remove(this.voxels.meshes[chunkIndex].wireMesh)}this.voxels.meshes[chunkIndex]=mesh;if(this.isClient){if(this.meshType==="wireMesh")mesh.createWireMesh();else mesh.createSurfaceMesh(this.materials.material);this.materials.paint(mesh)}mesh.setPosition(bounds[0][0],bounds[0][1],bounds[0][2]);mesh.addToScene(this.scene);this.emit("renderChunk",chunk);return mesh};Game.prototype.addMarker=function(position){var geometry=new THREE.SphereGeometry(.1,10,10);var material=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.FlatShading});var mesh=new THREE.Mesh(geometry,material);mesh.position.copy(position);this.scene.add(mesh)};Game.prototype.addAABBMarker=function(aabb,color){var geometry=new THREE.CubeGeometry(aabb.width(),aabb.height(),aabb.depth());var material=new THREE.MeshBasicMaterial({color:color||16777215,wireframe:true,transparent:true,opacity:.5,side:THREE.DoubleSide});var mesh=new THREE.Mesh(geometry,material);mesh.position.set(aabb.x0()+aabb.width()/2,aabb.y0()+aabb.height()/2,aabb.z0()+aabb.depth()/2);this.scene.add(mesh);return mesh};Game.prototype.addVoxelMarker=function(x,y,z,color){var bbox=aabb([x,y,z],[1,1,1]);return this.addAABBMarker(bbox,color)};Game.prototype.pin=pin;Game.prototype.onControlChange=function(gained,stream){this.paused=false;if(!gained&&!this.optout){this.buttons.disable();return}this.buttons.enable();stream.pipe(this.controls.createWriteRotationStream())};Game.prototype.onControlOptOut=function(){this.optout=true};Game.prototype.onFire=function(state){this.emit("fire",this.controlling,state)};Game.prototype.setInterval=tic.interval.bind(tic);Game.prototype.setTimeout=tic.timeout.bind(tic);Game.prototype.tick=function(delta){for(var i=0,len=this.items.length;i<len;++i){this.items[i].tick(delta)}if(this.materials)this.materials.tick(delta);if(this.pendingChunks.length)this.loadPendingChunks();if(Object.keys(this.chunksNeedsUpdate).length>0)this.updateDirtyChunks();tic.tick(delta);this.emit("tick",delta);if(!this.controls)return;var playerPos=this.playerPosition();this.spatial.emit("position",playerPos,playerPos)};Game.prototype.render=function(delta){this.view.render(this.scene)};Game.prototype.initializeTimer=function(rate){var self=this;var accum=0;var now=0;var last=null;var dt=0;var wholeTick;self.frameUpdated=true;self.interval=setInterval(timer,0);return self.interval;function timer(){if(self.paused){last=Date.now();accum=0;return}now=Date.now();dt=now-(last||now);last=now;accum+=dt;if(accum<rate)return;wholeTick=accum/rate|0;if(wholeTick<=0)return;wholeTick*=rate;self.tick(wholeTick);accum-=wholeTick;self.frameUpdated=true}};Game.prototype.initializeRendering=function(opts){var self=this;if(!opts.statsDisabled)self.addStats();window.addEventListener("resize",self.onWindowResize.bind(self),false);requestAnimationFrame(window).on("data",function(dt){self.emit("prerender",dt);self.render(dt);self.emit("postrender",dt)});if(typeof stats!=="undefined"){self.on("postrender",function(){stats.update()})}};Game.prototype.initializeControls=function(opts){this.keybindings=opts.keybindings||this.defaultButtons;this.buttons=kb(document.body,this.keybindings);this.buttons.disable();this.optout=false;this.interact=interact(opts.interactElement||this.view.element,opts.interactMouseDrag);this.interact.on("attain",this.onControlChange.bind(this,true)).on("release",this.onControlChange.bind(this,false)).on("opt-out",this.onControlOptOut.bind(this));this.hookupControls(this.buttons,opts)};Game.prototype.hookupControls=function(buttons,opts){opts=opts||{};opts.controls=opts.controls||{};opts.controls.onfire=this.onFire.bind(this);this.controls=control(buttons,opts.controls);this.items.push(this.controls);this.controlling=null};Game.prototype.handleChunkGeneration=function(){var self=this;this.voxels.on("missingChunk",function(chunkPos){self.pendingChunks.push(chunkPos.join("|"))});this.voxels.requestMissingChunks(this.worldOrigin);this.loadPendingChunks(this.pendingChunks.length)};Game.prototype.destroy=function(){clearInterval(this.timer)}},{"./lib/detector":130,"./lib/stats":131,__browserify_process:510,"aabb-3d":132,"collide-3d-tilemap":133,events:507,"gl-matrix":134,inherits:135,interact:136,"kb-bindings":145,path:514,"pin-it":150,raf:151,"spatial-events":152,three:154,tic:155,voxel:170,"voxel-control":156,"voxel-mesh":157,"voxel-physical":158,"voxel-raycast":162,"voxel-region-change":163,"voxel-texture":164,"voxel-view":168}],130:[function(require,module,exports){module.exports=function(){return{canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return false}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var domElement=document.createElement("div");domElement.style.fontFamily="monospace";domElement.style.fontSize="13px";domElement.style.textAlign="center";domElement.style.background="#eee";domElement.style.color="#000";domElement.style.padding="1em";domElement.style.width="475px";domElement.style.margin="5em auto 0";if(!this.webgl){domElement.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/">here</a>.'].join("\n")}return domElement},addGetWebGLMessage:function(parameters){var parent,id,domElement;parameters=parameters||{};parent=parameters.parent!==undefined?parameters.parent:document.body;id=parameters.id!==undefined?parameters.id:"oldie";domElement=Detector.getWebGLErrorMessage();domElement.id=id;parent.appendChild(domElement)}}}},{}],131:[function(require,module,exports){var Stats=function(){var startTime=Date.now(),prevTime=startTime;var ms=0,msMin=Infinity,msMax=0;var fps=0,fpsMin=Infinity,fpsMax=0;var frames=0,mode=0;var container=document.createElement("div");container.id="stats";container.addEventListener("mousedown",function(event){event.preventDefault();setMode(++mode%2)},false);container.style.cssText="width:80px;opacity:0.9;cursor:pointer";var fpsDiv=document.createElement("div");fpsDiv.id="fps";fpsDiv.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002";container.appendChild(fpsDiv);var fpsText=document.createElement("div");fpsText.id="fpsText";fpsText.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";fpsText.innerHTML="FPS";fpsDiv.appendChild(fpsText);var fpsGraph=document.createElement("div");fpsGraph.id="fpsGraph";fpsGraph.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff";fpsDiv.appendChild(fpsGraph);while(fpsGraph.children.length<74){var bar=document.createElement("span");bar.style.cssText="width:1px;height:30px;float:left;background-color:#113";fpsGraph.appendChild(bar)}var msDiv=document.createElement("div");msDiv.id="ms";msDiv.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none";container.appendChild(msDiv);var msText=document.createElement("div");msText.id="msText";msText.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";msText.innerHTML="MS";msDiv.appendChild(msText);var msGraph=document.createElement("div");msGraph.id="msGraph";msGraph.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0";msDiv.appendChild(msGraph);while(msGraph.children.length<74){var bar=document.createElement("span");bar.style.cssText="width:1px;height:30px;float:left;background-color:#131";msGraph.appendChild(bar)}var setMode=function(value){mode=value;switch(mode){case 0:fpsDiv.style.display="block";msDiv.style.display="none";break;case 1:fpsDiv.style.display="none";msDiv.style.display="block";break}};var updateGraph=function(dom,value){var child=dom.appendChild(dom.firstChild);child.style.height=value+"px"};return{REVISION:11,domElement:container,setMode:setMode,begin:function(){startTime=Date.now()},end:function(){var time=Date.now();ms=time-startTime;msMin=Math.min(msMin,ms);msMax=Math.max(msMax,ms);msText.textContent=ms+" MS ("+msMin+"-"+msMax+")";updateGraph(msGraph,Math.min(30,30-ms/200*30));frames++;if(time>prevTime+1e3){fps=Math.round(frames*1e3/(time-prevTime));fpsMin=Math.min(fpsMin,fps);fpsMax=Math.max(fpsMax,fps);fpsText.textContent=fps+" FPS ("+fpsMin+"-"+fpsMax+")";updateGraph(fpsGraph,Math.min(30,30-fps/100*30));prevTime=time;frames=0}return time},update:function(){startTime=this.end()}}};module.exports=Stats},{}],132:[function(require,module,exports){module.exports=AABB;var vec3=require("gl-matrix").vec3;function AABB(pos,vec){if(!(this instanceof AABB)){return new AABB(pos,vec)}this.base=pos;this.vec=vec;this.mag=vec3.length(this.vec);this.max=vec3.create();vec3.add(this.max,this.base,this.vec)}var cons=AABB,proto=cons.prototype;proto.width=function(){return this.vec[0]};proto.height=function(){return this.vec[1]};proto.depth=function(){return this.vec[2]};proto.x0=function(){return this.base[0]};proto.y0=function(){return this.base[1]};proto.z0=function(){return this.base[2]};proto.x1=function(){return this.max[0]};proto.y1=function(){return this.max[1]};proto.z1=function(){return this.max[2]};proto.translate=function(by){vec3.add(this.max,this.max,by);vec3.add(this.base,this.base,by);return this};proto.expand=function(aabb){var max=vec3.create(),min=vec3.create();vec3.max(max,aabb.max,this.max);vec3.min(min,aabb.base,this.base);vec3.sub(max,max,min);return new AABB(min,max)};proto.intersects=function(aabb){if(aabb.base[0]>this.max[0])return false;if(aabb.base[1]>this.max[1])return false;if(aabb.base[2]>this.max[2])return false;if(aabb.max[0]<this.base[0])return false;if(aabb.max[1]<this.base[1])return false;if(aabb.max[2]<this.base[2])return false;return true};proto.union=function(aabb){if(!this.intersects(aabb))return null;var base_x=Math.max(aabb.base[0],this.base[0]),base_y=Math.max(aabb.base[1],this.base[1]),base_z=Math.max(aabb.base[2],this.base[2]),max_x=Math.min(aabb.max[0],this.max[0]),max_y=Math.min(aabb.max[1],this.max[1]),max_z=Math.min(aabb.max[2],this.max[2]);return new AABB([base_x,base_y,base_z],[max_x-base_x,max_y-base_y,max_z-base_z])}},{"gl-matrix":134}],133:[function(require,module,exports){module.exports=function(field,tilesize,dimensions,offset){dimensions=dimensions||[Math.sqrt(field.length)>>0,Math.sqrt(field.length)>>0,Math.sqrt(field.length)>>0];offset=offset||[0,0,0];field=typeof field==="function"?field:function(x,y,z){return this[x+y*dimensions[1]+z*dimensions[1]*dimensions[2]]}.bind(field);var coords;coords=[0,0,0];return collide;function collide(box,vec,oncollision){if(vec[0]===0&&vec[1]===0&&vec[2]===0)return;collideaxis(0);collideaxis(1);collideaxis(2);function collideaxis(i_axis){var j_axis=(i_axis+1)%3,k_axis=(i_axis+2)%3,posi=vec[i_axis]>0,leading=box[posi?"max":"base"][i_axis],dir=posi?1:-1,i_start=Math.floor(leading/tilesize),i_end=Math.floor((leading+vec[i_axis])/tilesize)+dir,j_start=Math.floor(box.base[j_axis]/tilesize),j_end=Math.ceil(box.max[j_axis]/tilesize),k_start=Math.floor(box.base[k_axis]/tilesize),k_end=Math.ceil(box.max[k_axis]/tilesize),done=false,edge_vector,edge,tile;var step=0;for(var i=i_start;!done&&i!==i_end;++step,i+=dir){if(i<offset[i_axis]||i>=dimensions[i_axis])continue;for(var j=j_start;!done&&j!==j_end;++j){if(j<offset[j_axis]||j>=dimensions[j_axis])continue;for(var k=k_start;k!==k_end;++k){if(k<offset[k_axis]||k>=dimensions[k_axis])continue;coords[i_axis]=i;coords[j_axis]=j;coords[k_axis]=k;tile=field.apply(field,coords);if(tile===undefined)continue;edge=dir>0?i*tilesize:(i+1)*tilesize;edge_vector=edge-leading;if(oncollision(i_axis,tile,coords,dir,edge_vector)){done=true;break}}}}coords[0]=coords[1]=coords[2]=0;coords[i_axis]=vec[i_axis];box.translate(coords)}}}},{}],134:[function(require,module,exports){(function(){"use strict";var shim={};if(typeof exports==="undefined"){if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){shim.exports={};define(function(){return shim.exports})}else{shim.exports=window}}else{shim.exports=exports}(function(exports){var vec2={};if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}vec2.create=function(){return new Float32Array(2)};vec2.clone=function(a){var out=new Float32Array(2);out[0]=a[0];out[1]=a[1];return out};vec2.fromValues=function(x,y){var out=new Float32Array(2);out[0]=x;out[1]=y;return out};vec2.copy=function(out,a){out[0]=a[0];out[1]=a[1];return out};vec2.set=function(out,x,y){out[0]=x;out[1]=y;return out};vec2.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];return out};vec2.sub=vec2.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];return out};vec2.mul=vec2.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];return out};vec2.div=vec2.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];return out};vec2.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);return out};vec2.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);return out};vec2.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;return out};vec2.dist=vec2.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return Math.sqrt(x*x+y*y)};vec2.sqrDist=vec2.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return x*x+y*y};vec2.len=vec2.length=function(a){var x=a[0],y=a[1];return Math.sqrt(x*x+y*y)};vec2.sqrLen=vec2.squaredLength=function(a){var x=a[0],y=a[1];return x*x+y*y};vec2.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];return out};vec2.normalize=function(out,a){var x=a[0],y=a[1];var len=x*x+y*y;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len}return out};vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};vec2.cross=function(out,a,b){var z=a[0]*b[1]-a[1]*b[0];out[0]=out[1]=0;out[2]=z;return out};vec2.lerp=function(out,a,b,t){var ax=a[0],ay=a[1];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);return out};vec2.transformMat2=function(out,a,m){var x=a[0],y=a[1];out[0]=x*m[0]+y*m[1];out[1]=x*m[2]+y*m[3];return out};vec2.forEach=function(){var vec=new Float32Array(2);return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=2}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1]}return a}}();vec2.str=function(a){return"vec2("+a[0]+", "+a[1]+")"};if(typeof exports!=="undefined"){exports.vec2=vec2}var vec3={};if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}vec3.create=function(){return new Float32Array(3)};vec3.clone=function(a){var out=new Float32Array(3);out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.fromValues=function(x,y,z){var out=new Float32Array(3);out[0]=x;out[1]=y;out[2]=z;return out};vec3.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.set=function(out,x,y,z){out[0]=x;out[1]=y;out[2]=z;return out};vec3.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];return out};vec3.sub=vec3.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];return out};vec3.mul=vec3.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];return out};vec3.div=vec3.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];return out};vec3.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);return out};vec3.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);return out};vec3.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;return out};vec3.dist=vec3.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.sqrDist=vec3.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return x*x+y*y+z*z};vec3.len=vec3.length=function(a){var x=a[0],y=a[1],z=a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.sqrLen=vec3.squaredLength=function(a){var x=a[0],y=a[1],z=a[2];return x*x+y*y+z*z};vec3.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];return out};vec3.normalize=function(out,a){var x=a[0],y=a[1],z=a[2];var len=x*x+y*y+z*z;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len}return out};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.cross=function(out,a,b){var ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2];out[0]=ay*bz-az*by;out[1]=az*bx-ax*bz;out[2]=ax*by-ay*bx;return out};vec3.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);return out};vec3.transformMat4=function(out,a,m){var x=a[0],y=a[1],z=a[2];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12];out[1]=m[1]*x+m[5]*y+m[9]*z+m[13];out[2]=m[2]*x+m[6]*y+m[10]*z+m[14];return out};vec3.transformQuat=function(out,a,q){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec3.forEach=function(){var vec=new Float32Array(3);return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=3}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2]}return a}}();vec3.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"};if(typeof exports!=="undefined"){exports.vec3=vec3}var vec4={};if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}vec4.create=function(){return new Float32Array(4)};vec4.clone=function(a){var out=new Float32Array(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.fromValues=function(x,y,z,w){var out=new Float32Array(4);out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.set=function(out,x,y,z,w){out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];return out};vec4.sub=vec4.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];return out};vec4.mul=vec4.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];out[3]=a[3]*b[3];return out};vec4.div=vec4.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];out[3]=a[3]/b[3];return out};vec4.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);out[3]=Math.min(a[3],b[3]);return out};vec4.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);out[3]=Math.max(a[3],b[3]);return out};vec4.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;return out};vec4.dist=vec4.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.sqrDist=vec4.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return x*x+y*y+z*z+w*w};vec4.len=vec4.length=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.sqrLen=vec4.squaredLength=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return x*x+y*y+z*z+w*w};vec4.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=-a[3];return out};vec4.normalize=function(out,a){var x=a[0],y=a[1],z=a[2],w=a[3];var len=x*x+y*y+z*z+w*w;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len;out[3]=a[3]*len}return out};vec4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};vec4.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],aw=a[3];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);out[3]=aw+t*(b[3]-aw);return out};vec4.transformMat4=function(out,a,m){var x=a[0],y=a[1],z=a[2],w=a[3];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w;out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w;out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w;out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w;return out};vec4.transformQuat=function(out,a,q){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec4.forEach=function(){var vec=new Float32Array(4);return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=4}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];vec[3]=a[i+3];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2];a[i+3]=vec[3]}return a}}();vec4.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.vec4=vec4}var mat2={};var mat2Identity=new Float32Array([1,0,0,1]);if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}mat2.create=function(){return new Float32Array(mat2Identity)};mat2.clone=function(a){var out=new Float32Array(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};mat2.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};mat2.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=1;return out};mat2.transpose=function(out,a){if(out===a){var a1=a[1];out[1]=a[2];out[2]=a1}else{out[0]=a[0];out[1]=a[2];out[2]=a[1];out[3]=a[3]}return out};mat2.invert=function(out,a){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],det=a0*a3-a2*a1;if(!det){return null}det=1/det;out[0]=a3*det;out[1]=-a1*det;out[2]=-a2*det;out[3]=a0*det;return out};mat2.adjoint=function(out,a){var a0=a[0];out[0]=a[3];out[1]=-a[1];out[2]=-a[2];out[3]=a0;return out};mat2.determinant=function(a){return a[0]*a[3]-a[2]*a[1]};mat2.mul=mat2.multiply=function(out,a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=a0*b0+a1*b2;out[1]=a0*b1+a1*b3;out[2]=a2*b0+a3*b2;out[3]=a2*b1+a3*b3;return out};mat2.rotate=function(out,a,rad){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],s=Math.sin(rad),c=Math.cos(rad);out[0]=a0*c+a1*s;out[1]=a0*-s+a1*c;out[2]=a2*c+a3*s;out[3]=a2*-s+a3*c;return out};mat2.scale=function(out,a,v){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],v0=v[0],v1=v[1];out[0]=a0*v0;out[1]=a1*v1;out[2]=a2*v0;out[3]=a3*v1;return out};mat2.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.mat2=mat2}var mat3={};var mat3Identity=new Float32Array([1,0,0,0,1,0,0,0,1]);if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}mat3.create=function(){return new Float32Array(mat3Identity)};mat3.clone=function(a){var out=new Float32Array(9);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.transpose=function(out,a){if(out===a){var a01=a[1],a02=a[2],a12=a[5];out[1]=a[3];out[2]=a[6];out[3]=a01;out[5]=a[7];out[6]=a02;out[7]=a12}else{out[0]=a[0];out[1]=a[3];out[2]=a[6];out[3]=a[1];out[4]=a[4];out[5]=a[7];out[6]=a[2];out[7]=a[5];out[8]=a[8]}return out};mat3.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b01=a22*a11-a12*a21,b11=-a22*a10+a12*a20,b21=a21*a10-a11*a20,det=a00*b01+a01*b11+a02*b21;if(!det){return null}det=1/det;out[0]=b01*det;out[1]=(-a22*a01+a02*a21)*det;out[2]=(a12*a01-a02*a11)*det;out[3]=b11*det;out[4]=(a22*a00-a02*a20)*det;out[5]=(-a12*a00+a02*a10)*det;out[6]=b21*det;out[7]=(-a21*a00+a01*a20)*det;out[8]=(a11*a00-a01*a10)*det;return out};mat3.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];out[0]=a11*a22-a12*a21;out[1]=a02*a21-a01*a22;out[2]=a01*a12-a02*a11;out[3]=a12*a20-a10*a22;out[4]=a00*a22-a02*a20;out[5]=a02*a10-a00*a12;out[6]=a10*a21-a11*a20;out[7]=a01*a20-a00*a21;out[8]=a00*a11-a01*a10;return out};mat3.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)};mat3.mul=mat3.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b00=b[0],b01=b[1],b02=b[2],b10=b[3],b11=b[4],b12=b[5],b20=b[6],b21=b[7],b22=b[8];out[0]=b00*a00+b01*a10+b02*a20;out[1]=b00*a01+b01*a11+b02*a21;out[2]=b00*a02+b01*a12+b02*a22;out[3]=b10*a00+b11*a10+b12*a20;out[4]=b10*a01+b11*a11+b12*a21;out[5]=b10*a02+b11*a12+b12*a22;out[6]=b20*a00+b21*a10+b22*a20;out[7]=b20*a01+b21*a11+b22*a21;out[8]=b20*a02+b21*a12+b22*a22;return out};mat3.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"
};if(typeof exports!=="undefined"){exports.mat3=mat3}var mat4={};var mat4Identity=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}mat4.create=function(){return new Float32Array(mat4Identity)};mat4.clone=function(a){var out=new Float32Array(16);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.transpose=function(out,a){if(out===a){var a01=a[1],a02=a[2],a03=a[3],a12=a[6],a13=a[7],a23=a[11];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a01;out[6]=a[9];out[7]=a[13];out[8]=a02;out[9]=a12;out[11]=a[14];out[12]=a03;out[13]=a13;out[14]=a23}else{out[0]=a[0];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a[1];out[5]=a[5];out[6]=a[9];out[7]=a[13];out[8]=a[2];out[9]=a[6];out[10]=a[10];out[11]=a[14];out[12]=a[3];out[13]=a[7];out[14]=a[11];out[15]=a[15]}return out};mat4.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a02*b10-a01*b11-a03*b09)*det;out[2]=(a31*b05-a32*b04+a33*b03)*det;out[3]=(a22*b04-a21*b05-a23*b03)*det;out[4]=(a12*b08-a10*b11-a13*b07)*det;out[5]=(a00*b11-a02*b08+a03*b07)*det;out[6]=(a32*b02-a30*b05-a33*b01)*det;out[7]=(a20*b05-a22*b02+a23*b01)*det;out[8]=(a10*b10-a11*b08+a13*b06)*det;out[9]=(a01*b08-a00*b10-a03*b06)*det;out[10]=(a30*b04-a31*b02+a33*b00)*det;out[11]=(a21*b02-a20*b04-a23*b00)*det;out[12]=(a11*b07-a10*b09-a12*b06)*det;out[13]=(a00*b09-a01*b07+a02*b06)*det;out[14]=(a31*b01-a30*b03-a32*b00)*det;out[15]=(a20*b03-a21*b01+a22*b00)*det;return out};mat4.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];out[0]=a11*(a22*a33-a23*a32)-a21*(a12*a33-a13*a32)+a31*(a12*a23-a13*a22);out[1]=-(a01*(a22*a33-a23*a32)-a21*(a02*a33-a03*a32)+a31*(a02*a23-a03*a22));out[2]=a01*(a12*a33-a13*a32)-a11*(a02*a33-a03*a32)+a31*(a02*a13-a03*a12);out[3]=-(a01*(a12*a23-a13*a22)-a11*(a02*a23-a03*a22)+a21*(a02*a13-a03*a12));out[4]=-(a10*(a22*a33-a23*a32)-a20*(a12*a33-a13*a32)+a30*(a12*a23-a13*a22));out[5]=a00*(a22*a33-a23*a32)-a20*(a02*a33-a03*a32)+a30*(a02*a23-a03*a22);out[6]=-(a00*(a12*a33-a13*a32)-a10*(a02*a33-a03*a32)+a30*(a02*a13-a03*a12));out[7]=a00*(a12*a23-a13*a22)-a10*(a02*a23-a03*a22)+a20*(a02*a13-a03*a12);out[8]=a10*(a21*a33-a23*a31)-a20*(a11*a33-a13*a31)+a30*(a11*a23-a13*a21);out[9]=-(a00*(a21*a33-a23*a31)-a20*(a01*a33-a03*a31)+a30*(a01*a23-a03*a21));out[10]=a00*(a11*a33-a13*a31)-a10*(a01*a33-a03*a31)+a30*(a01*a13-a03*a11);out[11]=-(a00*(a11*a23-a13*a21)-a10*(a01*a23-a03*a21)+a20*(a01*a13-a03*a11));out[12]=-(a10*(a21*a32-a22*a31)-a20*(a11*a32-a12*a31)+a30*(a11*a22-a12*a21));out[13]=a00*(a21*a32-a22*a31)-a20*(a01*a32-a02*a31)+a30*(a01*a22-a02*a21);out[14]=-(a00*(a11*a32-a12*a31)-a10*(a01*a32-a02*a31)+a30*(a01*a12-a02*a11));out[15]=a00*(a11*a22-a12*a21)-a10*(a01*a22-a02*a21)+a20*(a01*a12-a02*a11);return out};mat4.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32;return b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06};mat4.mul=mat4.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=b0*a00+b1*a10+b2*a20+b3*a30;out[1]=b0*a01+b1*a11+b2*a21+b3*a31;out[2]=b0*a02+b1*a12+b2*a22+b3*a32;out[3]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[4];b1=b[5];b2=b[6];b3=b[7];out[4]=b0*a00+b1*a10+b2*a20+b3*a30;out[5]=b0*a01+b1*a11+b2*a21+b3*a31;out[6]=b0*a02+b1*a12+b2*a22+b3*a32;out[7]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[8];b1=b[9];b2=b[10];b3=b[11];out[8]=b0*a00+b1*a10+b2*a20+b3*a30;out[9]=b0*a01+b1*a11+b2*a21+b3*a31;out[10]=b0*a02+b1*a12+b2*a22+b3*a32;out[11]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[12];b1=b[13];b2=b[14];b3=b[15];out[12]=b0*a00+b1*a10+b2*a20+b3*a30;out[13]=b0*a01+b1*a11+b2*a21+b3*a31;out[14]=b0*a02+b1*a12+b2*a22+b3*a32;out[15]=b0*a03+b1*a13+b2*a23+b3*a33;return out};mat4.translate=function(out,a,v){var x=v[0],y=v[1],z=v[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;if(a===out){out[12]=a[0]*x+a[4]*y+a[8]*z+a[12];out[13]=a[1]*x+a[5]*y+a[9]*z+a[13];out[14]=a[2]*x+a[6]*y+a[10]*z+a[14];out[15]=a[3]*x+a[7]*y+a[11]*z+a[15]}else{a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a03;out[4]=a10;out[5]=a11;out[6]=a12;out[7]=a13;out[8]=a20;out[9]=a21;out[10]=a22;out[11]=a23;out[12]=a00*x+a10*y+a20*z+a[12];out[13]=a01*x+a11*y+a21*z+a[13];out[14]=a02*x+a12*y+a22*z+a[14];out[15]=a03*x+a13*y+a23*z+a[15]}return out};mat4.scale=function(out,a,v){var x=v[0],y=v[1],z=v[2];out[0]=a[0]*x;out[1]=a[1]*x;out[2]=a[2]*x;out[3]=a[3]*x;out[4]=a[4]*y;out[5]=a[5]*y;out[6]=a[6]*y;out[7]=a[7]*y;out[8]=a[8]*z;out[9]=a[9]*z;out[10]=a[10]*z;out[11]=a[11]*z;out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.rotate=function(out,a,rad,axis){var x=axis[0],y=axis[1],z=axis[2],len=Math.sqrt(x*x+y*y+z*z),s,c,t,a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,b00,b01,b02,b10,b11,b12,b20,b21,b22;if(Math.abs(len)<GLMAT_EPSILON){return null}len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];b00=x*x*t+c;b01=y*x*t+z*s;b02=z*x*t-y*s;b10=x*y*t-z*s;b11=y*y*t+c;b12=z*y*t+x*s;b20=x*z*t+y*s;b21=y*z*t-x*s;b22=z*z*t+c;out[0]=a00*b00+a10*b01+a20*b02;out[1]=a01*b00+a11*b01+a21*b02;out[2]=a02*b00+a12*b01+a22*b02;out[3]=a03*b00+a13*b01+a23*b02;out[4]=a00*b10+a10*b11+a20*b12;out[5]=a01*b10+a11*b11+a21*b12;out[6]=a02*b10+a12*b11+a22*b12;out[7]=a03*b10+a13*b11+a23*b12;out[8]=a00*b20+a10*b21+a20*b22;out[9]=a01*b20+a11*b21+a21*b22;out[10]=a02*b20+a12*b21+a22*b22;out[11]=a03*b20+a13*b21+a23*b22;if(a!==out){out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}return out};mat4.rotateX=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[4]=a10*c+a20*s;out[5]=a11*c+a21*s;out[6]=a12*c+a22*s;out[7]=a13*c+a23*s;out[8]=a20*c-a10*s;out[9]=a21*c-a11*s;out[10]=a22*c-a12*s;out[11]=a23*c-a13*s;return out};mat4.rotateY=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c-a20*s;out[1]=a01*c-a21*s;out[2]=a02*c-a22*s;out[3]=a03*c-a23*s;out[8]=a00*s+a20*c;out[9]=a01*s+a21*c;out[10]=a02*s+a22*c;out[11]=a03*s+a23*c;return out};mat4.rotateZ=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7];if(a!==out){out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c+a10*s;out[1]=a01*c+a11*s;out[2]=a02*c+a12*s;out[3]=a03*c+a13*s;out[4]=a10*c-a00*s;out[5]=a11*c-a01*s;out[6]=a12*c-a02*s;out[7]=a13*c-a03*s;return out};mat4.fromRotationTranslation=function(out,q,v){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=0;out[4]=xy-wz;out[5]=1-(xx+zz);out[6]=yz+wx;out[7]=0;out[8]=xz+wy;out[9]=yz-wx;out[10]=1-(xx+yy);out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out};mat4.frustum=function(out,left,right,bottom,top,near,far){var rl=1/(right-left),tb=1/(top-bottom),nf=1/(near-far);out[0]=near*2*rl;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=near*2*tb;out[6]=0;out[7]=0;out[8]=(right+left)*rl;out[9]=(top+bottom)*tb;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near*2*nf;out[15]=0;return out};mat4.perspective=function(out,fovy,aspect,near,far){var f=1/Math.tan(fovy/2),nf=1/(near-far);out[0]=f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=f;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=2*far*near*nf;out[15]=0;return out};mat4.ortho=function(out,left,right,bottom,top,near,far){var lr=1/(left-right),bt=1/(bottom-top),nf=1/(near-far);out[0]=-2*lr;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=-2*bt;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=2*nf;out[11]=0;out[12]=(left+right)*lr;out[13]=(top+bottom)*bt;out[14]=(far+near)*nf;out[15]=1;return out};mat4.lookAt=function(out,eye,center,up){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len,eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];if(Math.abs(eyex-centerx)<GLMAT_EPSILON&&Math.abs(eyey-centery)<GLMAT_EPSILON&&Math.abs(eyez-centerz)<GLMAT_EPSILON){return mat4.identity(out)}z0=eyex-centerx;z1=eyey-centery;z2=eyez-centerz;len=1/Math.sqrt(z0*z0+z1*z1+z2*z2);z0*=len;z1*=len;z2*=len;x0=upy*z2-upz*z1;x1=upz*z0-upx*z2;x2=upx*z1-upy*z0;len=Math.sqrt(x0*x0+x1*x1+x2*x2);if(!len){x0=0;x1=0;x2=0}else{len=1/len;x0*=len;x1*=len;x2*=len}y0=z1*x2-z2*x1;y1=z2*x0-z0*x2;y2=z0*x1-z1*x0;len=Math.sqrt(y0*y0+y1*y1+y2*y2);if(!len){y0=0;y1=0;y2=0}else{len=1/len;y0*=len;y1*=len;y2*=len}out[0]=x0;out[1]=y0;out[2]=z0;out[3]=0;out[4]=x1;out[5]=y1;out[6]=z1;out[7]=0;out[8]=x2;out[9]=y2;out[10]=z2;out[11]=0;out[12]=-(x0*eyex+x1*eyey+x2*eyez);out[13]=-(y0*eyex+y1*eyey+y2*eyez);out[14]=-(z0*eyex+z1*eyey+z2*eyez);out[15]=1;return out};mat4.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"};if(typeof exports!=="undefined"){exports.mat4=mat4}var quat={};var quatIdentity=new Float32Array([0,0,0,1]);if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}quat.create=function(){return new Float32Array(quatIdentity)};quat.clone=vec4.clone;quat.fromValues=vec4.fromValues;quat.copy=vec4.copy;quat.set=vec4.set;quat.identity=function(out){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.setAxisAngle=function(out,axis,rad){rad=rad*.5;var s=Math.sin(rad);out[0]=s*axis[0];out[1]=s*axis[1];out[2]=s*axis[2];out[3]=Math.cos(rad);return out};quat.add=vec4.add;quat.mul=quat.multiply=function(out,a,b){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];out[0]=ax*bw+aw*bx+ay*bz-az*by;out[1]=ay*bw+aw*by+az*bx-ax*bz;out[2]=az*bw+aw*bz+ax*by-ay*bx;out[3]=aw*bw-ax*bx-ay*by-az*bz;return out};quat.scale=vec4.scale;quat.rotateX=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+aw*bx;out[1]=ay*bw+az*bx;out[2]=az*bw-ay*bx;out[3]=aw*bw-ax*bx;return out};quat.rotateY=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],by=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw-az*by;out[1]=ay*bw+aw*by;out[2]=az*bw+ax*by;out[3]=aw*bw-ay*by;return out};quat.rotateZ=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bz=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+ay*bz;out[1]=ay*bw-ax*bz;out[2]=az*bw+aw*bz;out[3]=aw*bw-az*bz;return out};quat.calculateW=function(out,a){var x=a[0],y=a[1],z=a[2];out[0]=x;out[1]=y;out[2]=z;out[3]=-Math.sqrt(Math.abs(1-x*x-y*y-z*z));return out};quat.dot=vec4.dot;quat.lerp=vec4.lerp;quat.slerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=a[3];var cosHalfTheta=ax*bx+ay*by+az*bz+aw*bw,halfTheta,sinHalfTheta,ratioA,ratioB;if(Math.abs(cosHalfTheta)>=1){if(out!==a){out[0]=ax;out[1]=ay;out[2]=az;out[3]=aw}return out}halfTheta=Math.acos(cosHalfTheta);sinHalfTheta=Math.sqrt(1-cosHalfTheta*cosHalfTheta);if(Math.abs(sinHalfTheta)<.001){out[0]=ax*.5+bx*.5;out[1]=ay*.5+by*.5;out[2]=az*.5+bz*.5;out[3]=aw*.5+bw*.5;return out}ratioA=Math.sin((1-t)*halfTheta)/sinHalfTheta;ratioB=Math.sin(t*halfTheta)/sinHalfTheta;out[0]=ax*ratioA+bx*ratioB;out[1]=ay*ratioA+by*ratioB;out[2]=az*ratioA+bz*ratioB;out[3]=aw*ratioA+bw*ratioB;return out};quat.invert=function(out,a){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],dot=a0*a0+a1*a1+a2*a2+a3*a3,invDot=dot?1/dot:0;out[0]=-a0*invDot;out[1]=-a1*invDot;out[2]=-a2*invDot;out[3]=a3*invDot;return out};quat.conjugate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=a[3];return out};quat.len=quat.length=vec4.length;quat.sqrLen=quat.squaredLength=vec4.squaredLength;quat.normalize=vec4.normalize;quat.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.quat=quat}})(shim.exports)})()},{}],135:[function(require,module,exports){module.exports=require(4)},{}],136:[function(require,module,exports){var lock=require("pointer-lock"),drag=require("drag-stream"),full=require("fullscreen");var EE=require("events").EventEmitter,Stream=require("stream").Stream;module.exports=interact;function interact(el,skiplock){var ee=new EE,internal;if(!lock.available()||skiplock){internal=usedrag(el)}else{internal=uselock(el,politelydeclined)}ee.release=function(){internal.release&&internal.release()};ee.request=function(){internal.request&&internal.request()};ee.destroy=function(){internal.destroy&&internal.destroy()};ee.pointerAvailable=function(){return lock.available()};ee.fullscreenAvailable=function(){return full.available()};forward();return ee;function politelydeclined(){ee.emit("opt-out");internal.destroy();internal=usedrag(el);forward()}function forward(){internal.on("attain",function(stream){ee.emit("attain",stream)});internal.on("release",function(){ee.emit("release")})}}function uselock(el,declined){var pointer=lock(el),fs=full(el);pointer.on("needs-fullscreen",function(){fs.once("attain",function(){pointer.request()});fs.request()});pointer.on("error",declined);return pointer}function usedrag(el){var ee=new EE,d=drag(el),stream;d.paused=true;d.on("resume",function(){stream=new Stream;stream.readable=true;stream.initial=null});d.on("data",function(datum){if(!stream){stream=new Stream;stream.readable=true;stream.initial=null}if(!stream.initial){stream.initial={x:datum.dx,y:datum.dy,t:datum.dt};return ee.emit("attain",stream)}if(stream.paused){ee.emit("release");stream.emit("end");stream.readable=false;stream.emit("close");stream=null}stream.emit("data",datum)});return ee}},{"drag-stream":137,events:507,fullscreen:143,"pointer-lock":144,stream:520}],137:[function(require,module,exports){module.exports=dragstream;var Stream=require("stream"),read=require("domnode-dom").createReadStream,through=require("through");function dragstream(el){var body=el.ownerDocument.body,down=read(el,"mousedown"),up=read(body,"mouseup",false),move=read(body,"mousemove",false),anchor={x:0,y:0,t:0},drag=through(on_move);drag.pause();down.on("data",on_down);up.on("data",on_up);return move.pipe(drag);function on_move(ev){if(drag.paused)return;drag.emit("data",datum(ev.screenX-anchor.x,ev.screenY-anchor.y,+new Date));anchor.x=ev.screenX;anchor.y=ev.screenY}function on_down(ev){anchor.x=ev.screenX;anchor.y=ev.screenY;anchor.t=+new Date;drag.resume();drag.emit("data",datum(anchor.x,anchor.y,anchor.t))}function on_up(ev){drag.pause();drag.emit("data",datum(ev.screenX-anchor.x,ev.screenY-anchor.y,+new Date))}function datum(dx,dy,when){return{dx:dx,dy:dy,dt:when-anchor.t}}}},{"domnode-dom":138,stream:520,through:142}],138:[function(require,module,exports){module.exports=require("./lib/index")},{"./lib/index":139}],139:[function(require,module,exports){var WriteStream=require("./writable"),ReadStream=require("./readable"),DOMStream={};DOMStream.WriteStream=WriteStream;DOMStream.ReadStream=ReadStream;DOMStream.createAppendStream=function(el,mimetype){return new DOMStream.WriteStream(el,DOMStream.WriteStream.APPEND,mimetype)};DOMStream.createWriteStream=function(el,mimetype){return new DOMStream.WriteStream(el,DOMStream.WriteStream.WRITE,mimetype)};DOMStream.createReadStream=DOMStream.createEventStream=function(el,type,preventDefault){preventDefault=preventDefault===undefined?true:preventDefault;return new DOMStream.ReadStream(el,type,preventDefault)};module.exports=DOMStream},{"./readable":140,"./writable":141}],140:[function(require,module,exports){module.exports=DOMStream;var Stream=require("stream").Stream;var listener=function(el,type,onmsg){return el.addEventListener(type,onmsg,false)};if(typeof $!=="undefined")listener=function(el,type,onmsg){return el=$(el)[type](onmsg)};if(typeof document!=="undefined"&&!document.createElement("div").addEventListener)listener=function(el,type,onmsg){return el.attachEvent("on"+type,onmsg)};function DOMStream(el,eventType,shouldPreventDefault){this.el=el;this.eventType=eventType;this.shouldPreventDefault=shouldPreventDefault;var self=this;if(el&&this.eventType)listener(this.el,this.eventType,function(){return self.listen.apply(self,arguments)});Stream.call(this)}var cons=DOMStream,proto=cons.prototype=Object.create(Stream.prototype);proto.constructor=cons;proto.listen=function(ev){if(this.shouldPreventDefault)ev.preventDefault?ev.preventDefault():ev.returnValue=false;var collectData=this.eventType==="submit"||this.eventType==="change"||this.eventType==="keydown"||this.eventType==="keyup"||this.eventType==="input";if(collectData){if(this.el.tagName.toUpperCase()==="FORM")return this.handleFormSubmit(ev);return this.emit("data",valueFromElement(this.el))}this.emit("data",ev)};proto.handleFormSubmit=function(ev){var elements=[];if(this.el.querySelectorAll){elements=this.el.querySelectorAll("input,textarea,select")}else{var inputs={INPUT:true,TEXTAREA:true,SELECT:true};var recurse=function(el){for(var i=0,len=el.childNodes.length;i<len;++i){if(el.childNodes[i].tagName){if(inputs[el.childNodes[i].tagName.toUpperCase()]){elements.push(el)}else{recurse(el.childNodes[i])}}}};recurse(this.el)}var output={},attr,val;for(var i=0,len=elements.length;i<len;++i){attr=elements[i].getAttribute("name");val=valueFromElement(elements[i]);output[attr]=val}return this.emit("data",output)};function valueFromElement(el){switch(el.getAttribute("type")){case"radio":return el.checked?el.value:null;case"checkbox":return"data",el.checked}return el.value}},{stream:520}],141:[function(require,module,exports){module.exports=DOMStream;var Stream=require("stream").Stream;function DOMStream(el,mode,mimetype){this.el=el;this.mode=mode;this.mimetype=mimetype||"text/html";Stream.call(this)}var cons=DOMStream,proto=cons.prototype=Object.create(Stream.prototype);proto.constructor=cons;cons.APPEND=0;cons.WRITE=1;proto.writable=true;proto.setMimetype=function(mime){this.mimetype=mime};proto.write=function(data){var result=this.mode===cons.APPEND?this.append(data):this.insert(data);this.emit("data",this.el.childNodes);return result};proto.end=function(){};proto.insert=function(data){this.el.innerHTML="";return this.append(data)};proto.append=function(data){var result=this[this.resolveMimetypeHandler()](data);for(var i=0,len=result.length;i<len;++i){this.el.appendChild(result[i])}return true};proto.resolveMimetypeHandler=function(){var type=this.mimetype.replace(/(\/\w)/,function(x){return x.slice(1).toUpperCase()});type=type.charAt(0).toUpperCase()+type.slice(1);return"construct"+type};proto.constructTextHtml=function(data){var isTableFragment=/(tr|td|th)/.test(data)&&!/table/.test(data),div;if(isTableFragment){div=document.createElement("table")}div=div||document.createElement("div");div.innerHTML=data;return[].slice.call(div.childNodes)};proto.constructTextPlain=function(data){var textNode=document.createTextNode(data);return[textNode]}},{stream:520}],142:[function(require,module,exports){var process=require("__browserify_process");var Stream=require("stream");exports=module.exports=through;through.through=through;function through(write,end){write=write||function(data){this.emit("data",data)};end=end||function(){this.emit("end")};var ended=false,destroyed=false;var stream=new Stream,buffer=[];stream.buffer=buffer;stream.readable=stream.writable=true;stream.paused=false;stream.write=function(data){write.call(this,data);return!stream.paused};function drain(){while(buffer.length&&!stream.paused){var data=buffer.shift();if(null===data)return stream.emit("end");else stream.emit("data",data)}}stream.queue=function(data){buffer.push(data);drain()};stream.on("end",function(){stream.readable=false;if(!stream.writable)process.nextTick(function(){stream.destroy()})});function _end(){stream.writable=false;end.call(stream);if(!stream.readable)stream.destroy()}stream.end=function(data){if(ended)return;ended=true;if(arguments.length)stream.write(data);_end()};stream.destroy=function(){if(destroyed)return;destroyed=true;ended=true;buffer.length=0;stream.writable=stream.readable=false;stream.emit("close")};stream.pause=function(){if(stream.paused)return;stream.paused=true;stream.emit("pause")};stream.resume=function(){if(stream.paused){stream.paused=false}drain();if(!stream.paused)stream.emit("drain")};return stream}},{__browserify_process:510,stream:520}],143:[function(require,module,exports){module.exports=fullscreen;fullscreen.available=available;var EE=require("events").EventEmitter;function available(){return!!shim(document.body)}function fullscreen(el){var ael=el.addEventListener||el.attachEvent,doc=el.ownerDocument,body=doc.body,rfs=shim(el),ee=new EE;var vendors=["","webkit","moz","ms","o"];for(var i=0,len=vendors.length;i<len;++i){ael.call(doc,vendors[i]+"fullscreenchange",onfullscreenchange);ael.call(doc,vendors[i]+"fullscreenerror",onfullscreenerror)}ee.release=release;ee.request=request;ee.target=fullscreenelement;if(!shim){setTimeout(function(){ee.emit("error",new Error("fullscreen is not supported"))},0)}return ee;function onfullscreenchange(){if(!fullscreenelement()){return ee.emit("release")}ee.emit("attain")}function onfullscreenerror(){ee.emit("error")}function request(){return rfs.call(el)}function release(){(el.exitFullscreen||el.exitFullscreen||el.webkitExitFullScreen||el.webkitExitFullscreen||el.mozExitFullScreen||el.mozExitFullscreen||el.msExitFullScreen||el.msExitFullscreen||el.oExitFullScreen||el.oExitFullscreen).call(el)}function fullscreenelement(){return 0||doc.fullScreenElement||doc.fullscreenElement||doc.webkitFullScreenElement||doc.webkitFullscreenElement||doc.mozFullScreenElement||doc.mozFullscreenElement||doc.msFullScreenElement||doc.msFullscreenElement||doc.oFullScreenElement||doc.oFullscreenElement||null}}function shim(el){return el.requestFullscreen||el.webkitRequestFullscreen||el.webkitRequestFullScreen||el.mozRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen||el.msRequestFullScreen||el.oRequestFullscreen||el.oRequestFullScreen}},{events:507}],144:[function(require,module,exports){module.exports=pointer;pointer.available=available;var EE=require("events").EventEmitter,Stream=require("stream").Stream;function available(){return!!shim(document.body)}function pointer(el){var ael=el.addEventListener||el.attachEvent,rel=el.removeEventListener||el.detachEvent,doc=el.ownerDocument,body=doc.body,rpl=shim(el),out={dx:0,dy:0,dt:0},ee=new EE,stream=null,lastPageX,lastPageY,needsFullscreen=false,mouseDownMS;ael.call(el,"mousedown",onmousedown,false);ael.call(el,"mouseup",onmouseup,false);ael.call(body,"mousemove",onmove,false);var vendors=["","webkit","moz","ms","o"];for(var i=0,len=vendors.length;i<len;++i){ael.call(doc,vendors[i]+"pointerlockchange",onpointerlockchange);ael.call(doc,vendors[i]+"pointerlockerror",onpointerlockerror)}ee.release=release;ee.target=pointerlockelement;ee.request=onmousedown;ee.destroy=function(){rel.call(el,"mouseup",onmouseup,false);rel.call(el,"mousedown",onmousedown,false);rel.call(el,"mousemove",onmove,false)};if(!shim){setTimeout(function(){ee.emit("error",new Error("pointer lock is not supported"))},0)}return ee;function onmousedown(ev){if(pointerlockelement()){return}mouseDownMS=+new Date;rpl.call(el)}function onmouseup(ev){if(!needsFullscreen){return}ee.emit("needs-fullscreen");needsFullscreen=false}function onpointerlockchange(ev){if(!pointerlockelement()){if(stream)release();return}stream=new Stream;stream.readable=true;stream.initial={x:lastPageX,y:lastPageY,t:Date.now()};ee.emit("attain",stream)}function onpointerlockerror(ev){var dt=+new Date-mouseDownMS;if(dt<100){needsFullscreen=true;return}if(stream){stream.emit("error",ev);stream=null}}function release(){ee.emit("release");if(stream){stream.emit("end");stream.readable=false;stream.emit("close");stream=null}var pel=pointerlockelement();if(!pel){return}(doc.exitPointerLock||doc.mozExitPointerLock||doc.webkitExitPointerLock||doc.msExitPointerLock||doc.oExitPointerLock).call(doc)}function onmove(ev){lastPageX=ev.pageX;lastPageY=ev.pageY;if(!stream)return;out.dx=ev.movementX||ev.webkitMovementX||ev.mozMovementX||ev.msMovementX||ev.oMovementX||0;out.dy=ev.movementY||ev.webkitMovementY||ev.mozMovementY||ev.msMovementY||ev.oMovementY||0;out.dt=Date.now()-stream.initial.t;ee.emit("data",out);stream.emit("data",out)}function pointerlockelement(){return 0||doc.pointerLockElement||doc.mozPointerLockElement||doc.webkitPointerLockElement||doc.msPointerLockElement||doc.oPointerLockElement||null}}function shim(el){return el.requestPointerLock||el.webkitRequestPointerLock||el.mozRequestPointerLock||el.msRequestPointerLock||el.oRequestPointerLock||null}},{events:507,stream:520}],145:[function(require,module,exports){var ever=require("ever"),vkey=require("vkey"),max=Math.max,EventEmitter=require("events").EventEmitter;module.exports=function(el,bindings,state,opts){var root=null;if(bindings===undefined||!el.ownerDocument){state=bindings;bindings=el;el=this.document.body;try{root=window.top.document.body}catch(e){}}var ee=ever(el),re=root?ever(root):ee,measured={},enabled=true;opts=opts||{};opts.preventDefaults=opts.preventDefaults===undefined?true:opts.preventDefaults;state=state||{};state.down=new EventEmitter;state.up=new EventEmitter;state.changed=new EventEmitter;state.bindings=bindings;for(var key in bindings){if(bindings[key]==="enabled"||bindings[key]==="enable"||bindings[key]==="disable"||bindings[key]==="destroy"||bindings[key]==="down"||bindings[key]==="up"||bindings[key]==="changed"||bindings[key]==="bindings"){throw new Error(bindings[key]+" is reserved")}state[bindings[key]]=0;measured[key]=1}re.on("keyup",wrapped(onoff(kb,false)));re.on("keydown",wrapped(onoff(kb,true)));ee.on("mouseup",wrapped(onoff(mouse,false)));ee.on("mousedown",wrapped(onoff(mouse,true)));ee.on("contextmenu",function(ev){if(opts.preventDefaults)ev.preventDefault()});state.enabled=function(){return enabled};state.enable=enable_disable(true);state.disable=enable_disable(false);state.destroy=function(){re.removeAllListeners();ee.removeAllListeners()};return state;function clear(){for(var key in bindings){state[bindings[key]]=0;measured[key]=1}}function enable_disable(on_or_off){return function(){clear();enabled=on_or_off;return this}}function wrapped(fn){return function(ev){if(enabled){if(opts.preventDefaults)ev.preventDefault();fn(ev)}else{return}}}function onoff(find,on_or_off){return function(ev){var key=find(ev),binding=bindings[key];if(binding){var previous_state=state[binding];state[binding]+=on_or_off?max(measured[key]--,0):-(measured[key]=1);if(!on_or_off&&state[binding]<0){state[binding]=0}if(previous_state!==state[binding]){if(on_or_off)state.down.emit(binding);else state.up.emit(binding);state.changed.emit(binding,on_or_off)}}}}function mouse(ev){return"<mouse "+ev.which+">"}function kb(ev){return vkey[ev.keyCode]||ev.char}}},{events:507,ever:146,vkey:149}],146:[function(require,module,exports){module.exports=require(40)},{"./init.json":147,"./types.json":148,events:507}],147:[function(require,module,exports){module.exports=require(41)},{}],148:[function(require,module,exports){module.exports=require(42)},{}],149:[function(require,module,exports){module.exports=require(25)},{}],150:[function(require,module,exports){module.exports=pin;var pins={},stack_holder={},pin_holder;function make_pin_for(name,obj){var container=document.createElement("div"),header=document.createElement("h4"),body=document.createElement("pre");container.style.background="white";container.style.marginBottom="4px";container.appendChild(header);container.appendChild(body);header.textContents=header.innerText=obj&&obj.repr?obj.repr():name;body.style.padding="8px";if(!pin_holder){pin_holder=document.createElement("div");pin_holder.style.position="absolute";pin_holder.style.top=pin_holder.style.right="4px";document.body.appendChild(pin_holder)}pin_holder.appendChild(container);return(pins[name]=pins[name]||[]).push({body:body,last:-Infinity,for_object:obj}),pins[name]}function update_pin(item,into,retain,depth){if(!retain)into.innerHTML="";if(depth>1)return;depth=depth||0;switch(typeof item){case"number":into.innerText+=item.toFixed(3);break;case"string":into.innerText+='"'+item+'"';break;case"undefined":case"object":if(item){for(var key in item)if(item.hasOwnProperty(key)){into.innerText+=key+":";update_pin(item[key],into,true,depth+1);into.innerText+="\n"}break}case"boolean":into.innerText+=""+item;break}}function pin(item,every,obj,name){if(!name)Error.captureStackTrace(stack_holder);var location=name||stack_holder.stack.split("\n").slice(2)[0].replace(/^\s+at /g,""),target=pins[location]||make_pin_for(location,obj),now=Date.now(),every=every||0;if(arguments.length<3)target=target[0];else{for(var i=0,len=target.length;i<len;++i){if(target[i].for_object===obj){target=target[i];break}}if(i===len){pins[location].push(target=make_pin_for(location,obj))}}if(now-target.last>every){update_pin(item,target.body);target.last=now}}},{}],151:[function(require,module,exports){module.exports=raf;var EE=require("events").EventEmitter,global=typeof window==="undefined"?this:window;var _raf=global.requestAnimationFrame||global.webkitRequestAnimationFrame||global.mozRequestAnimationFrame||global.msRequestAnimationFrame||global.oRequestAnimationFrame||(global.setImmediate?function(fn,el){setImmediate(fn)}:function(fn,el){setTimeout(fn,0)});function raf(el){var now=raf.now(),ee=new EE;ee.pause=function(){ee.paused=true};ee.resume=function(){ee.paused=false};_raf(iter,el);return ee;function iter(timestamp){var _now=raf.now(),dt=_now-now;now=_now;ee.emit("data",dt);if(!ee.paused){_raf(iter,el)}}}raf.polyfill=_raf;raf.now=function(){return Date.now()}},{events:507}],152:[function(require,module,exports){module.exports=SpatialEventEmitter;var slice=[].slice,Tree=require("./tree"),aabb=require("aabb-3d");function SpatialEventEmitter(){this.root=null;this.infinites={}}var cons=SpatialEventEmitter,proto=cons.prototype;proto.size=16;proto.addListener=proto.addEventListener=proto.on=function(event,bbox,listener){if(!finite(bbox)){(this.infinites[event]=this.infinites[event]||[]).push({bbox:bbox,func:listener});
return this}(this.root=this.root||this.create_root(bbox)).add(event,bbox,listener);return this};proto.once=function(event,bbox,listener){var self=this;self.on(event,bbox,function once(){listener.apply(null,arguments);self.remove(event,once)});return self};proto.removeListener=proto.removeEventListener=proto.remove=function(event,listener){if(this.root){this.root.remove(event,listener)}if(!this.infinites[event]){return this}for(var i=0,len=this.infinites[event].length;i<len;++i){if(this.infinites[event][i].func===listener){break}}if(i!==len){this.infinites[event].splice(i,1)}return this};proto.emit=function(event,bbox){var args=slice.call(arguments,2);if("0"in bbox){bbox=aabb(bbox,[0,0,0])}if(this.root){this.root.send(event,bbox,args)}if(!this.infinites[event]){return this}var list=this.infinites[event].slice();for(var i=0,len=list.length;i<len;++i){if(list[i].bbox.intersects(bbox)){list[i].func.apply(null,args)}}return this};proto.rootSize=function(size){proto.size=size};proto.create_root=function(bbox){var self=this,size=self.size,base=[Math.floor(bbox.x0()/size)*size,Math.floor(bbox.y0()/size)*size,Math.floor(bbox.z0()/size)*size],tree_bbox=new bbox.constructor(base,[size,size,size]);function OurTree(size,bbox){Tree.call(this,size,bbox,null)}OurTree.prototype=Object.create(Tree.prototype);OurTree.prototype.constructor=OurTree;OurTree.prototype.grow=function(new_root){self.root=new_root};OurTree.prototype.min_size=size;return new OurTree(size,tree_bbox)};function finite(bbox){return isFinite(bbox.x0())&&isFinite(bbox.x1())&&isFinite(bbox.y0())&&isFinite(bbox.y1())&&isFinite(bbox.z0())&&isFinite(bbox.z1())}},{"./tree":153,"aabb-3d":132}],153:[function(require,module,exports){module.exports=Tree;var aabb=require("aabb-3d");function Tree(size,bbox,parent){this.listeners={};this.size=size;this.bbox=bbox;this.parent=parent;this.children=[]}var cons=Tree,proto=cons.prototype;proto.add=function(event,bbox,listener){if(!this.parent&&!this.contains(bbox)){return this.expand(bbox).add(event,bbox,listener)}for(var i=0,len=this.children.length;i<len;++i){if(this.children[i].contains(bbox)){return this.children[i].add(event,bbox,listener)}}var size=this.size/2;if(size>this.min_size&&bbox.vec[0]<size&&bbox.vec[1]<size&&bbox.vec[2]<size){if(Math.floor(bbox.x0()/size)===Math.floor(bbox.x1()/size)&&Math.floor(bbox.y0()/size)===Math.floor(bbox.y1()/size)&&Math.floor(bbox.z0()/size)===Math.floor(bbox.z1()/size)){var inst=new this.constructor(size,aabb([Math.floor(bbox.x0()/size)*size,Math.floor(bbox.y0()/size)*size,Math.floor(bbox.z0()/size)*size],[size,size,size]),this);this.children.push(inst);return inst.add(event,bbox,listener)}}(this.listeners[event]=this.listeners[event]||[]).push({bbox:bbox,func:listener})};proto.contains=function(bbox){return bbox.x0()>=this.bbox.x0()&&bbox.y0()>=this.bbox.y0()&&bbox.z0()>=this.bbox.z0()&&bbox.x1()<=this.bbox.x1()&&bbox.y1()<=this.bbox.y1()&&bbox.z1()<=this.bbox.z1()};proto.expand=function(bbox){var size=this.size,new_size=size*2,expanded=this.bbox.expand(bbox),new_i=Math.floor(bbox.x0()/size),new_j=Math.floor(bbox.y0()/size),new_k=Math.floor(bbox.z0()/size),cur_i=Math.floor(this.bbox.x0()/size),cur_j=Math.floor(this.bbox.y0()/size),cur_k=Math.floor(this.bbox.z0()/size),new_base=[new_i-cur_i>=0?cur_i:cur_i-1,new_j-cur_j>=0?cur_j:cur_j-1,new_k-cur_k>=0?cur_k:cur_k-1].map(function(ii){return ii*size}),new_bbox=aabb(new_base,[new_size,new_size,new_size]),new_root=new this.constructor(new_size,new_bbox),self=this;this.parent=new_root;this.grow(this.parent);new_root.children.push(self);return new_root};proto.remove=function(event,listener){var list=this.listeners[event];if(list){for(var i=0,len=list.length;i<len;++i){if(list[i].func===listener)break}if(i!==len){list.splice(i,1)}}for(var i=0,len=this.children.length;i<len;++i){this.children[i].remove(event,listener)}};proto.send=function(event,bbox,args){for(var i=0,len=this.children.length;i<len;++i){if(bbox.intersects(this.children[i].bbox)){this.children[i].send(event,bbox,args)}}var list=this.listeners[event];if(!list){return}for(var i=0,len=list.length;i<len;++i){if(list[i].bbox.intersects(bbox)){list[i].func.apply(null,args)}}}},{"aabb-3d":132}],154:[function(require,module,exports){var self=self||{};var THREE=THREE||{REVISION:"59dev"};self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}};self.Int32Array=self.Int32Array||Array;self.Float32Array=self.Float32Array||Array;String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};THREE.extend=function(obj,source){if(Object.keys){var keys=Object.keys(source);for(var i=0,il=keys.length;i<il;i++){var prop=keys[i];Object.defineProperty(obj,prop,Object.getOwnPropertyDescriptor(source,prop))}}else{var safeHasOwnProperty={}.hasOwnProperty;for(var prop in source){if(safeHasOwnProperty.call(source,prop)){obj[prop]=source[prop]}}}return obj};(function(){var lastTime=0;var vendors=["ms","moz","webkit","o"];for(var x=0;x<vendors.length&&!self.requestAnimationFrame;++x){self.requestAnimationFrame=self[vendors[x]+"RequestAnimationFrame"];self.cancelAnimationFrame=self[vendors[x]+"CancelAnimationFrame"]||self[vendors[x]+"CancelRequestAnimationFrame"]}if(self.requestAnimationFrame===undefined&&self["setTimeout"]!==undefined){self.requestAnimationFrame=function(callback){var currTime=Date.now(),timeToCall=Math.max(0,16-(currTime-lastTime));var id=self.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id}}if(self.cancelAnimationFrame===undefined&&self["clearTimeout"]!==undefined){self.cancelAnimationFrame=function(id){self.clearTimeout(id)}}})();THREE.CullFaceNone=0;THREE.CullFaceBack=1;THREE.CullFaceFront=2;THREE.CullFaceFrontBack=3;THREE.FrontFaceDirectionCW=0;THREE.FrontFaceDirectionCCW=1;THREE.BasicShadowMap=0;THREE.PCFShadowMap=1;THREE.PCFSoftShadowMap=2;THREE.FrontSide=0;THREE.BackSide=1;THREE.DoubleSide=2;THREE.NoShading=0;THREE.FlatShading=1;THREE.SmoothShading=2;THREE.NoColors=0;THREE.FaceColors=1;THREE.VertexColors=2;THREE.NoBlending=0;THREE.NormalBlending=1;THREE.AdditiveBlending=2;THREE.SubtractiveBlending=3;THREE.MultiplyBlending=4;THREE.CustomBlending=5;THREE.AddEquation=100;THREE.SubtractEquation=101;THREE.ReverseSubtractEquation=102;THREE.ZeroFactor=200;THREE.OneFactor=201;THREE.SrcColorFactor=202;THREE.OneMinusSrcColorFactor=203;THREE.SrcAlphaFactor=204;THREE.OneMinusSrcAlphaFactor=205;THREE.DstAlphaFactor=206;THREE.OneMinusDstAlphaFactor=207;THREE.DstColorFactor=208;THREE.OneMinusDstColorFactor=209;THREE.SrcAlphaSaturateFactor=210;THREE.MultiplyOperation=0;THREE.MixOperation=1;THREE.AddOperation=2;THREE.UVMapping=function(){};THREE.CubeReflectionMapping=function(){};THREE.CubeRefractionMapping=function(){};THREE.SphericalReflectionMapping=function(){};THREE.SphericalRefractionMapping=function(){};THREE.RepeatWrapping=1e3;THREE.ClampToEdgeWrapping=1001;THREE.MirroredRepeatWrapping=1002;THREE.NearestFilter=1003;THREE.NearestMipMapNearestFilter=1004;THREE.NearestMipMapLinearFilter=1005;THREE.LinearFilter=1006;THREE.LinearMipMapNearestFilter=1007;THREE.LinearMipMapLinearFilter=1008;THREE.UnsignedByteType=1009;THREE.ByteType=1010;THREE.ShortType=1011;THREE.UnsignedShortType=1012;THREE.IntType=1013;THREE.UnsignedIntType=1014;THREE.FloatType=1015;THREE.UnsignedShort4444Type=1016;THREE.UnsignedShort5551Type=1017;THREE.UnsignedShort565Type=1018;THREE.AlphaFormat=1019;THREE.RGBFormat=1020;THREE.RGBAFormat=1021;THREE.LuminanceFormat=1022;THREE.LuminanceAlphaFormat=1023;THREE.RGB_S3TC_DXT1_Format=2001;THREE.RGBA_S3TC_DXT1_Format=2002;THREE.RGBA_S3TC_DXT3_Format=2003;THREE.RGBA_S3TC_DXT5_Format=2004;THREE.Color=function(value){if(value!==undefined)this.set(value);return this};THREE.Color.prototype={constructor:THREE.Color,r:1,g:1,b:1,set:function(value){if(value instanceof THREE.Color){this.copy(value)}else if(typeof value==="number"){this.setHex(value)}else if(typeof value==="string"){this.setStyle(value)}return this},setHex:function(hex){hex=Math.floor(hex);this.r=(hex>>16&255)/255;this.g=(hex>>8&255)/255;this.b=(hex&255)/255;return this},setRGB:function(r,g,b){this.r=r;this.g=g;this.b=b;return this},setHSL:function(h,s,l){if(s===0){this.r=this.g=this.b=l}else{var hue2rgb=function(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*6*(2/3-t);return p};var p=l<=.5?l*(1+s):l+s-l*s;var q=2*l-p;this.r=hue2rgb(q,p,h+1/3);this.g=hue2rgb(q,p,h);this.b=hue2rgb(q,p,h-1/3)}return this},setStyle:function(style){if(/^rgb\((\d+),(\d+),(\d+)\)$/i.test(style)){var color=/^rgb\((\d+),(\d+),(\d+)\)$/i.exec(style);this.r=Math.min(255,parseInt(color[1],10))/255;this.g=Math.min(255,parseInt(color[2],10))/255;this.b=Math.min(255,parseInt(color[3],10))/255;return this}if(/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.test(style)){var color=/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.exec(style);this.r=Math.min(100,parseInt(color[1],10))/100;this.g=Math.min(100,parseInt(color[2],10))/100;this.b=Math.min(100,parseInt(color[3],10))/100;return this}if(/^\#([0-9a-f]{6})$/i.test(style)){var color=/^\#([0-9a-f]{6})$/i.exec(style);this.setHex(parseInt(color[1],16));return this}if(/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(style)){var color=/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(style);this.setHex(parseInt(color[1]+color[1]+color[2]+color[2]+color[3]+color[3],16));return this}if(/^(\w+)$/i.test(style)){this.setHex(THREE.ColorKeywords[style]);return this}},copy:function(color){this.r=color.r;this.g=color.g;this.b=color.b;return this},copyGammaToLinear:function(color){this.r=color.r*color.r;this.g=color.g*color.g;this.b=color.b*color.b;return this},copyLinearToGamma:function(color){this.r=Math.sqrt(color.r);this.g=Math.sqrt(color.g);this.b=Math.sqrt(color.b);return this},convertGammaToLinear:function(){var r=this.r,g=this.g,b=this.b;this.r=r*r;this.g=g*g;this.b=b*b;return this},convertLinearToGamma:function(){this.r=Math.sqrt(this.r);this.g=Math.sqrt(this.g);this.b=Math.sqrt(this.b);return this},getHex:function(){return this.r*255<<16^this.g*255<<8^this.b*255<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(){var hsl={h:0,s:0,l:0};return function(){var r=this.r,g=this.g,b=this.b;var max=Math.max(r,g,b);var min=Math.min(r,g,b);var hue,saturation;var lightness=(min+max)/2;if(min===max){hue=0;saturation=0}else{var delta=max-min;saturation=lightness<=.5?delta/(max+min):delta/(2-max-min);switch(max){case r:hue=(g-b)/delta+(g<b?6:0);break;case g:hue=(b-r)/delta+2;break;case b:hue=(r-g)/delta+4;break}hue/=6}hsl.h=hue;hsl.s=saturation;hsl.l=lightness;return hsl}}(),getStyle:function(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+","+(this.b*255|0)+")"},offsetHSL:function(h,s,l){var hsl=this.getHSL();hsl.h+=h;hsl.s+=s;hsl.l+=l;this.setHSL(hsl.h,hsl.s,hsl.l);return this},add:function(color){this.r+=color.r;this.g+=color.g;this.b+=color.b;return this},addColors:function(color1,color2){this.r=color1.r+color2.r;this.g=color1.g+color2.g;this.b=color1.b+color2.b;return this},addScalar:function(s){this.r+=s;this.g+=s;this.b+=s;return this},multiply:function(color){this.r*=color.r;this.g*=color.g;this.b*=color.b;return this},multiplyScalar:function(s){this.r*=s;this.g*=s;this.b*=s;return this},lerp:function(color,alpha){this.r+=(color.r-this.r)*alpha;this.g+=(color.g-this.g)*alpha;this.b+=(color.b-this.b)*alpha;return this},equals:function(c){return c.r===this.r&&c.g===this.g&&c.b===this.b},clone:function(){return(new THREE.Color).setRGB(this.r,this.g,this.b)}};THREE.ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};THREE.Quaternion=function(x,y,z,w){this.x=x||0;this.y=y||0;this.z=z||0;this.w=w!==undefined?w:1};THREE.Quaternion.prototype={constructor:THREE.Quaternion,set:function(x,y,z,w){this.x=x;this.y=y;this.z=z;this.w=w;return this},copy:function(q){this.x=q.x;this.y=q.y;this.z=q.z;this.w=q.w;return this},setFromEuler:function(v,order){var c1=Math.cos(v.x/2);var c2=Math.cos(v.y/2);var c3=Math.cos(v.z/2);var s1=Math.sin(v.x/2);var s2=Math.sin(v.y/2);var s3=Math.sin(v.z/2);if(order===undefined||order==="XYZ"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="YXZ"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}else if(order==="ZXY"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="ZYX"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}else if(order==="YZX"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="XZY"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}return this},setFromAxisAngle:function(axis,angle){var halfAngle=angle/2,s=Math.sin(halfAngle);this.x=axis.x*s;this.y=axis.y*s;this.z=axis.z*s;this.w=Math.cos(halfAngle);return this},setFromRotationMatrix:function(m){var te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10],trace=m11+m22+m33,s;if(trace>0){s=.5/Math.sqrt(trace+1);this.w=.25/s;this.x=(m32-m23)*s;this.y=(m13-m31)*s;this.z=(m21-m12)*s}else if(m11>m22&&m11>m33){s=2*Math.sqrt(1+m11-m22-m33);this.w=(m32-m23)/s;this.x=.25*s;this.y=(m12+m21)/s;this.z=(m13+m31)/s}else if(m22>m33){s=2*Math.sqrt(1+m22-m11-m33);this.w=(m13-m31)/s;this.x=(m12+m21)/s;this.y=.25*s;this.z=(m23+m32)/s}else{s=2*Math.sqrt(1+m33-m11-m22);this.w=(m21-m12)/s;this.x=(m13+m31)/s;this.y=(m23+m32)/s;this.z=.25*s}return this},inverse:function(){this.conjugate().normalize();return this},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var l=this.length();if(l===0){this.x=0;this.y=0;this.z=0;this.w=1}else{l=1/l;this.x=this.x*l;this.y=this.y*l;this.z=this.z*l;this.w=this.w*l}return this},multiply:function(q,p){if(p!==undefined){console.warn("DEPRECATED: Quaternion's .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead.");return this.multiplyQuaternions(q,p)}return this.multiplyQuaternions(this,q)},multiplyQuaternions:function(a,b){var qax=a.x,qay=a.y,qaz=a.z,qaw=a.w;var qbx=b.x,qby=b.y,qbz=b.z,qbw=b.w;this.x=qax*qbw+qaw*qbx+qay*qbz-qaz*qby;this.y=qay*qbw+qaw*qby+qaz*qbx-qax*qbz;this.z=qaz*qbw+qaw*qbz+qax*qby-qay*qbx;this.w=qaw*qbw-qax*qbx-qay*qby-qaz*qbz;return this},multiplyVector3:function(vector){console.warn("DEPRECATED: Quaternion's .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead.");return vector.applyQuaternion(this)},slerp:function(qb,t){var x=this.x,y=this.y,z=this.z,w=this.w;var cosHalfTheta=w*qb.w+x*qb.x+y*qb.y+z*qb.z;if(cosHalfTheta<0){this.w=-qb.w;this.x=-qb.x;this.y=-qb.y;this.z=-qb.z;cosHalfTheta=-cosHalfTheta}else{this.copy(qb)}if(cosHalfTheta>=1){this.w=w;this.x=x;this.y=y;this.z=z;return this}var halfTheta=Math.acos(cosHalfTheta);var sinHalfTheta=Math.sqrt(1-cosHalfTheta*cosHalfTheta);if(Math.abs(sinHalfTheta)<.001){this.w=.5*(w+this.w);this.x=.5*(x+this.x);this.y=.5*(y+this.y);this.z=.5*(z+this.z);return this}var ratioA=Math.sin((1-t)*halfTheta)/sinHalfTheta,ratioB=Math.sin(t*halfTheta)/sinHalfTheta;this.w=w*ratioA+this.w*ratioB;this.x=x*ratioA+this.x*ratioB;this.y=y*ratioA+this.y*ratioB;this.z=z*ratioA+this.z*ratioB;return this},equals:function(v){return v.x===this.x&&v.y===this.y&&v.z===this.z&&v.w===this.w},fromArray:function(array){this.x=array[0];this.y=array[1];this.z=array[2];this.w=array[3];return this},toArray:function(){return[this.x,this.y,this.z,this.w]},clone:function(){return new THREE.Quaternion(this.x,this.y,this.z,this.w)}};THREE.Quaternion.slerp=function(qa,qb,qm,t){return qm.copy(qa).slerp(qb,t)};THREE.Vector2=function(x,y){this.x=x||0;this.y=y||0};THREE.Vector2.prototype={constructor:THREE.Vector2,set:function(x,y){this.x=x;this.y=y;return this},setX:function(x){this.x=x;return this},setY:function(y){this.y=y;return this},setComponent:function(index,value){switch(index){case 0:this.x=value;break;case 1:this.y=value;break;default:throw new Error("index is out of range: "+index)}},getComponent:function(index){switch(index){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+index)}},copy:function(v){this.x=v.x;this.y=v.y;return this},add:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector2's .add() now only accepts one argument. Use .addVectors( a, b ) instead.");return this.addVectors(v,w)}this.x+=v.x;this.y+=v.y;return this},addVectors:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;return this},addScalar:function(s){this.x+=s;this.y+=s;return this},sub:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector2's .sub() now only accepts one argument. Use .subVectors( a, b ) instead.");return this.subVectors(v,w)}this.x-=v.x;this.y-=v.y;return this},subVectors:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;return this},multiplyScalar:function(s){this.x*=s;this.y*=s;return this},divideScalar:function(s){if(s!==0){this.x/=s;this.y/=s}else{this.set(0,0)}return this},min:function(v){if(this.x>v.x){this.x=v.x}if(this.y>v.y){this.y=v.y}return this},max:function(v){if(this.x<v.x){this.x=v.x}if(this.y<v.y){this.y=v.y}return this},clamp:function(min,max){if(this.x<min.x){this.x=min.x}else if(this.x>max.x){this.x=max.x}if(this.y<min.y){this.y=min.y}else if(this.y>max.y){this.y=max.y}return this},negate:function(){return this.multiplyScalar(-1)},dot:function(v){return this.x*v.x+this.y*v.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(v){return Math.sqrt(this.distanceToSquared(v))},distanceToSquared:function(v){var dx=this.x-v.x,dy=this.y-v.y;return dx*dx+dy*dy},setLength:function(l){var oldLength=this.length();if(oldLength!==0&&l!==oldLength){this.multiplyScalar(l/oldLength)}return this},lerp:function(v,alpha){this.x+=(v.x-this.x)*alpha;this.y+=(v.y-this.y)*alpha;return this},equals:function(v){return v.x===this.x&&v.y===this.y},fromArray:function(array){this.x=array[0];this.y=array[1];return this},toArray:function(){return[this.x,this.y]},clone:function(){return new THREE.Vector2(this.x,this.y)}};THREE.Vector3=function(x,y,z){this.x=x||0;this.y=y||0;this.z=z||0};THREE.Vector3.prototype={constructor:THREE.Vector3,set:function(x,y,z){this.x=x;this.y=y;this.z=z;return this},setX:function(x){this.x=x;return this},setY:function(y){this.y=y;return this},setZ:function(z){this.z=z;return this},setComponent:function(index,value){switch(index){case 0:this.x=value;break;case 1:this.y=value;break;case 2:this.z=value;break;default:throw new Error("index is out of range: "+index)}},getComponent:function(index){switch(index){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+index)}},copy:function(v){this.x=v.x;this.y=v.y;this.z=v.z;return this},add:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector3's .add() now only accepts one argument. Use .addVectors( a, b ) instead.");return this.addVectors(v,w)}this.x+=v.x;this.y+=v.y;this.z+=v.z;return this},addScalar:function(s){this.x+=s;this.y+=s;this.z+=s;return this},addVectors:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;return this},sub:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector3's .sub() now only accepts one argument. Use .subVectors( a, b ) instead.");return this.subVectors(v,w)}this.x-=v.x;this.y-=v.y;this.z-=v.z;return this},subVectors:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;return this},multiply:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector3's .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead.");return this.multiplyVectors(v,w)}this.x*=v.x;this.y*=v.y;this.z*=v.z;return this},multiplyScalar:function(s){this.x*=s;this.y*=s;this.z*=s;return this},multiplyVectors:function(a,b){this.x=a.x*b.x;this.y=a.y*b.y;this.z=a.z*b.z;return this},applyMatrix3:function(m){var x=this.x;var y=this.y;var z=this.z;var e=m.elements;this.x=e[0]*x+e[3]*y+e[6]*z;this.y=e[1]*x+e[4]*y+e[7]*z;this.z=e[2]*x+e[5]*y+e[8]*z;return this},applyMatrix4:function(m){var x=this.x,y=this.y,z=this.z;var e=m.elements;this.x=e[0]*x+e[4]*y+e[8]*z+e[12];this.y=e[1]*x+e[5]*y+e[9]*z+e[13];this.z=e[2]*x+e[6]*y+e[10]*z+e[14];return this},applyProjection:function(m){var x=this.x,y=this.y,z=this.z;var e=m.elements;var d=1/(e[3]*x+e[7]*y+e[11]*z+e[15]);this.x=(e[0]*x+e[4]*y+e[8]*z+e[12])*d;this.y=(e[1]*x+e[5]*y+e[9]*z+e[13])*d;this.z=(e[2]*x+e[6]*y+e[10]*z+e[14])*d;return this},applyQuaternion:function(q){var x=this.x;var y=this.y;var z=this.z;var qx=q.x;var qy=q.y;var qz=q.z;var qw=q.w;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;this.x=ix*qw+iw*-qx+iy*-qz-iz*-qy;this.y=iy*qw+iw*-qy+iz*-qx-ix*-qz;this.z=iz*qw+iw*-qz+ix*-qy-iy*-qx;return this},transformDirection:function(m){var x=this.x,y=this.y,z=this.z;var e=m.elements;this.x=e[0]*x+e[4]*y+e[8]*z;this.y=e[1]*x+e[5]*y+e[9]*z;this.z=e[2]*x+e[6]*y+e[10]*z;this.normalize();return this},divide:function(v){this.x/=v.x;this.y/=v.y;this.z/=v.z;return this},divideScalar:function(s){if(s!==0){this.x/=s;this.y/=s;this.z/=s}else{this.x=0;this.y=0;this.z=0}return this},min:function(v){if(this.x>v.x){this.x=v.x}if(this.y>v.y){this.y=v.y}if(this.z>v.z){this.z=v.z}return this},max:function(v){if(this.x<v.x){this.x=v.x}if(this.y<v.y){this.y=v.y}if(this.z<v.z){this.z=v.z}return this},clamp:function(min,max){if(this.x<min.x){this.x=min.x}else if(this.x>max.x){this.x=max.x}if(this.y<min.y){this.y=min.y}else if(this.y>max.y){this.y=max.y}if(this.z<min.z){this.z=min.z}else if(this.z>max.z){this.z=max.z}return this},negate:function(){return this.multiplyScalar(-1)},dot:function(v){return this.x*v.x+this.y*v.y+this.z*v.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(l){var oldLength=this.length();if(oldLength!==0&&l!==oldLength){this.multiplyScalar(l/oldLength)}return this},lerp:function(v,alpha){this.x+=(v.x-this.x)*alpha;this.y+=(v.y-this.y)*alpha;this.z+=(v.z-this.z)*alpha;return this},cross:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector3's .cross() now only accepts one argument. Use .crossVectors( a, b ) instead.");return this.crossVectors(v,w)}var x=this.x,y=this.y,z=this.z;this.x=y*v.z-z*v.y;this.y=z*v.x-x*v.z;this.z=x*v.y-y*v.x;return this},crossVectors:function(a,b){this.x=a.y*b.z-a.z*b.y;this.y=a.z*b.x-a.x*b.z;this.z=a.x*b.y-a.y*b.x;return this},angleTo:function(v){var theta=this.dot(v)/(this.length()*v.length());return Math.acos(THREE.Math.clamp(theta,-1,1))},distanceTo:function(v){return Math.sqrt(this.distanceToSquared(v))},distanceToSquared:function(v){var dx=this.x-v.x;var dy=this.y-v.y;var dz=this.z-v.z;return dx*dx+dy*dy+dz*dz},setEulerFromRotationMatrix:function(m,order){function clamp(x){return Math.min(Math.max(x,-1),1)}var te=m.elements;var m11=te[0],m12=te[4],m13=te[8];var m21=te[1],m22=te[5],m23=te[9];var m31=te[2],m32=te[6],m33=te[10];if(order===undefined||order==="XYZ"){this.y=Math.asin(clamp(m13));if(Math.abs(m13)<.99999){this.x=Math.atan2(-m23,m33);this.z=Math.atan2(-m12,m11)}else{this.x=Math.atan2(m32,m22);this.z=0}}else if(order==="YXZ"){this.x=Math.asin(-clamp(m23));if(Math.abs(m23)<.99999){this.y=Math.atan2(m13,m33);this.z=Math.atan2(m21,m22)}else{this.y=Math.atan2(-m31,m11);this.z=0}}else if(order==="ZXY"){this.x=Math.asin(clamp(m32));if(Math.abs(m32)<.99999){this.y=Math.atan2(-m31,m33);this.z=Math.atan2(-m12,m22)}else{this.y=0;this.z=Math.atan2(m21,m11)}}else if(order==="ZYX"){this.y=Math.asin(-clamp(m31));if(Math.abs(m31)<.99999){this.x=Math.atan2(m32,m33);this.z=Math.atan2(m21,m11)}else{this.x=0;this.z=Math.atan2(-m12,m22)}}else if(order==="YZX"){this.z=Math.asin(clamp(m21));if(Math.abs(m21)<.99999){this.x=Math.atan2(-m23,m22);this.y=Math.atan2(-m31,m11)}else{this.x=0;this.y=Math.atan2(m13,m33)}}else if(order==="XZY"){this.z=Math.asin(-clamp(m12));if(Math.abs(m12)<.99999){this.x=Math.atan2(m32,m22);this.y=Math.atan2(m13,m11)}else{this.x=Math.atan2(-m23,m33);this.y=0}}return this},setEulerFromQuaternion:function(q,order){function clamp(x){return Math.min(Math.max(x,-1),1)}var sqx=q.x*q.x;var sqy=q.y*q.y;var sqz=q.z*q.z;var sqw=q.w*q.w;if(order===undefined||order==="XYZ"){this.x=Math.atan2(2*(q.x*q.w-q.y*q.z),sqw-sqx-sqy+sqz);this.y=Math.asin(clamp(2*(q.x*q.z+q.y*q.w)));this.z=Math.atan2(2*(q.z*q.w-q.x*q.y),sqw+sqx-sqy-sqz)}else if(order==="YXZ"){this.x=Math.asin(clamp(2*(q.x*q.w-q.y*q.z)));this.y=Math.atan2(2*(q.x*q.z+q.y*q.w),sqw-sqx-sqy+sqz);this.z=Math.atan2(2*(q.x*q.y+q.z*q.w),sqw-sqx+sqy-sqz)}else if(order==="ZXY"){this.x=Math.asin(clamp(2*(q.x*q.w+q.y*q.z)));this.y=Math.atan2(2*(q.y*q.w-q.z*q.x),sqw-sqx-sqy+sqz);this.z=Math.atan2(2*(q.z*q.w-q.x*q.y),sqw-sqx+sqy-sqz)}else if(order==="ZYX"){this.x=Math.atan2(2*(q.x*q.w+q.z*q.y),sqw-sqx-sqy+sqz);this.y=Math.asin(clamp(2*(q.y*q.w-q.x*q.z)));this.z=Math.atan2(2*(q.x*q.y+q.z*q.w),sqw+sqx-sqy-sqz)}else if(order==="YZX"){this.x=Math.atan2(2*(q.x*q.w-q.z*q.y),sqw-sqx+sqy-sqz);this.y=Math.atan2(2*(q.y*q.w-q.x*q.z),sqw+sqx-sqy-sqz);this.z=Math.asin(clamp(2*(q.x*q.y+q.z*q.w)))}else if(order==="XZY"){this.x=Math.atan2(2*(q.x*q.w+q.y*q.z),sqw-sqx+sqy-sqz);this.y=Math.atan2(2*(q.x*q.z+q.y*q.w),sqw+sqx-sqy-sqz);this.z=Math.asin(clamp(2*(q.z*q.w-q.x*q.y)))}return this},getPositionFromMatrix:function(m){this.x=m.elements[12];this.y=m.elements[13];this.z=m.elements[14];return this},getScaleFromMatrix:function(m){var sx=this.set(m.elements[0],m.elements[1],m.elements[2]).length();var sy=this.set(m.elements[4],m.elements[5],m.elements[6]).length();var sz=this.set(m.elements[8],m.elements[9],m.elements[10]).length();this.x=sx;this.y=sy;this.z=sz;return this},getColumnFromMatrix:function(index,matrix){var offset=index*4;var me=matrix.elements;this.x=me[offset];this.y=me[offset+1];this.z=me[offset+2];return this},equals:function(v){return v.x===this.x&&v.y===this.y&&v.z===this.z},fromArray:function(array){this.x=array[0];this.y=array[1];this.z=array[2];return this},toArray:function(){return[this.x,this.y,this.z]},clone:function(){return new THREE.Vector3(this.x,this.y,this.z)}};THREE.extend(THREE.Vector3.prototype,{applyEuler:function(){var q1=new THREE.Quaternion;return function(v,eulerOrder){var quaternion=q1.setFromEuler(v,eulerOrder);this.applyQuaternion(quaternion);return this}}(),applyAxisAngle:function(){var q1=new THREE.Quaternion;return function(axis,angle){var quaternion=q1.setFromAxisAngle(axis,angle);this.applyQuaternion(quaternion);return this}}(),projectOnVector:function(){var v1=new THREE.Vector3;return function(vector){v1.copy(vector).normalize();var d=this.dot(v1);return this.copy(v1).multiplyScalar(d)}}(),projectOnPlane:function(){var v1=new THREE.Vector3;return function(planeNormal){v1.copy(this).projectOnVector(planeNormal);return this.sub(v1)}}(),reflect:function(){var v1=new THREE.Vector3;return function(vector){v1.copy(this).projectOnVector(vector).multiplyScalar(2);return this.subVectors(v1,this)}}()});THREE.Vector4=function(x,y,z,w){this.x=x||0;this.y=y||0;this.z=z||0;this.w=w!==undefined?w:1};THREE.Vector4.prototype={constructor:THREE.Vector4,set:function(x,y,z,w){this.x=x;this.y=y;this.z=z;this.w=w;return this},setX:function(x){this.x=x;return this},setY:function(y){this.y=y;return this},setZ:function(z){this.z=z;return this},setW:function(w){this.w=w;return this},setComponent:function(index,value){switch(index){case 0:this.x=value;break;case 1:this.y=value;break;case 2:this.z=value;break;case 3:this.w=value;break;default:throw new Error("index is out of range: "+index)}},getComponent:function(index){switch(index){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+index)}},copy:function(v){this.x=v.x;this.y=v.y;this.z=v.z;this.w=v.w!==undefined?v.w:1;return this},add:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector4's .add() now only accepts one argument. Use .addVectors( a, b ) instead.");return this.addVectors(v,w)}this.x+=v.x;this.y+=v.y;this.z+=v.z;this.w+=v.w;return this},addScalar:function(s){this.x+=s;this.y+=s;this.z+=s;this.w+=s;return this},addVectors:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;this.w=a.w+b.w;return this},sub:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector4's .sub() now only accepts one argument. Use .subVectors( a, b ) instead.");return this.subVectors(v,w)}this.x-=v.x;this.y-=v.y;this.z-=v.z;this.w-=v.w;return this},subVectors:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;this.w=a.w-b.w;return this},multiplyScalar:function(s){this.x*=s;this.y*=s;this.z*=s;this.w*=s;return this},applyMatrix4:function(m){var x=this.x;var y=this.y;
var z=this.z;var w=this.w;var e=m.elements;this.x=e[0]*x+e[4]*y+e[8]*z+e[12]*w;this.y=e[1]*x+e[5]*y+e[9]*z+e[13]*w;this.z=e[2]*x+e[6]*y+e[10]*z+e[14]*w;this.w=e[3]*x+e[7]*y+e[11]*z+e[15]*w;return this},divideScalar:function(s){if(s!==0){this.x/=s;this.y/=s;this.z/=s;this.w/=s}else{this.x=0;this.y=0;this.z=0;this.w=1}return this},setAxisAngleFromQuaternion:function(q){this.w=2*Math.acos(q.w);var s=Math.sqrt(1-q.w*q.w);if(s<1e-4){this.x=1;this.y=0;this.z=0}else{this.x=q.x/s;this.y=q.y/s;this.z=q.z/s}return this},setAxisAngleFromRotationMatrix:function(m){var angle,x,y,z,epsilon=.01,epsilon2=.1,te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10];if(Math.abs(m12-m21)<epsilon&&Math.abs(m13-m31)<epsilon&&Math.abs(m23-m32)<epsilon){if(Math.abs(m12+m21)<epsilon2&&Math.abs(m13+m31)<epsilon2&&Math.abs(m23+m32)<epsilon2&&Math.abs(m11+m22+m33-3)<epsilon2){this.set(1,0,0,0);return this}angle=Math.PI;var xx=(m11+1)/2;var yy=(m22+1)/2;var zz=(m33+1)/2;var xy=(m12+m21)/4;var xz=(m13+m31)/4;var yz=(m23+m32)/4;if(xx>yy&&xx>zz){if(xx<epsilon){x=0;y=.707106781;z=.707106781}else{x=Math.sqrt(xx);y=xy/x;z=xz/x}}else if(yy>zz){if(yy<epsilon){x=.707106781;y=0;z=.707106781}else{y=Math.sqrt(yy);x=xy/y;z=yz/y}}else{if(zz<epsilon){x=.707106781;y=.707106781;z=0}else{z=Math.sqrt(zz);x=xz/z;y=yz/z}}this.set(x,y,z,angle);return this}var s=Math.sqrt((m32-m23)*(m32-m23)+(m13-m31)*(m13-m31)+(m21-m12)*(m21-m12));if(Math.abs(s)<.001)s=1;this.x=(m32-m23)/s;this.y=(m13-m31)/s;this.z=(m21-m12)/s;this.w=Math.acos((m11+m22+m33-1)/2);return this},min:function(v){if(this.x>v.x){this.x=v.x}if(this.y>v.y){this.y=v.y}if(this.z>v.z){this.z=v.z}if(this.w>v.w){this.w=v.w}return this},max:function(v){if(this.x<v.x){this.x=v.x}if(this.y<v.y){this.y=v.y}if(this.z<v.z){this.z=v.z}if(this.w<v.w){this.w=v.w}return this},clamp:function(min,max){if(this.x<min.x){this.x=min.x}else if(this.x>max.x){this.x=max.x}if(this.y<min.y){this.y=min.y}else if(this.y>max.y){this.y=max.y}if(this.z<min.z){this.z=min.z}else if(this.z>max.z){this.z=max.z}if(this.w<min.w){this.w=min.w}else if(this.w>max.w){this.w=max.w}return this},negate:function(){return this.multiplyScalar(-1)},dot:function(v){return this.x*v.x+this.y*v.y+this.z*v.z+this.w*v.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(l){var oldLength=this.length();if(oldLength!==0&&l!==oldLength){this.multiplyScalar(l/oldLength)}return this},lerp:function(v,alpha){this.x+=(v.x-this.x)*alpha;this.y+=(v.y-this.y)*alpha;this.z+=(v.z-this.z)*alpha;this.w+=(v.w-this.w)*alpha;return this},equals:function(v){return v.x===this.x&&v.y===this.y&&v.z===this.z&&v.w===this.w},fromArray:function(array){this.x=array[0];this.y=array[1];this.z=array[2];this.w=array[3];return this},toArray:function(){return[this.x,this.y,this.z,this.w]},clone:function(){return new THREE.Vector4(this.x,this.y,this.z,this.w)}};THREE.Line3=function(start,end){this.start=start!==undefined?start:new THREE.Vector3;this.end=end!==undefined?end:new THREE.Vector3};THREE.Line3.prototype={constructor:THREE.Line3,set:function(start,end){this.start.copy(start);this.end.copy(end);return this},copy:function(line){this.start.copy(line.start);this.end.copy(line.end);return this},center:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(t,optionalTarget){var result=optionalTarget||new THREE.Vector3;return this.delta(result).multiplyScalar(t).add(this.start)},closestPointToPointParameter:function(){var startP=new THREE.Vector3;var startEnd=new THREE.Vector3;return function(point,clampToLine){startP.subVectors(point,this.start);startEnd.subVectors(this.end,this.start);var startEnd2=startEnd.dot(startEnd);var startEnd_startP=startEnd.dot(startP);var t=startEnd_startP/startEnd2;if(clampToLine){t=THREE.Math.clamp(t,0,1)}return t}}(),closestPointToPoint:function(point,clampToLine,optionalTarget){var t=this.closestPointToPointParameter(point,clampToLine);var result=optionalTarget||new THREE.Vector3;return this.delta(result).multiplyScalar(t).add(this.start)},applyMatrix4:function(matrix){this.start.applyMatrix4(matrix);this.end.applyMatrix4(matrix);return this},equals:function(line){return line.start.equals(this.start)&&line.end.equals(this.end)},clone:function(){return(new THREE.Line3).copy(this)}};THREE.Box2=function(min,max){this.min=min!==undefined?min:new THREE.Vector2(Infinity,Infinity);this.max=max!==undefined?max:new THREE.Vector2(-Infinity,-Infinity)};THREE.Box2.prototype={constructor:THREE.Box2,set:function(min,max){this.min.copy(min);this.max.copy(max);return this},setFromPoints:function(points){if(points.length>0){var point=points[0];this.min.copy(point);this.max.copy(point);for(var i=1,il=points.length;i<il;i++){point=points[i];if(point.x<this.min.x){this.min.x=point.x}else if(point.x>this.max.x){this.max.x=point.x}if(point.y<this.min.y){this.min.y=point.y}else if(point.y>this.max.y){this.max.y=point.y}}}else{this.makeEmpty()}return this},setFromCenterAndSize:function(){var v1=new THREE.Vector2;return function(center,size){var halfSize=v1.copy(size).multiplyScalar(.5);this.min.copy(center).sub(halfSize);this.max.copy(center).add(halfSize);return this}}(),copy:function(box){this.min.copy(box.min);this.max.copy(box.max);return this},makeEmpty:function(){this.min.x=this.min.y=Infinity;this.max.x=this.max.y=-Infinity;return this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},center:function(optionalTarget){var result=optionalTarget||new THREE.Vector2;return result.addVectors(this.min,this.max).multiplyScalar(.5)},size:function(optionalTarget){var result=optionalTarget||new THREE.Vector2;return result.subVectors(this.max,this.min)},expandByPoint:function(point){this.min.min(point);this.max.max(point);return this},expandByVector:function(vector){this.min.sub(vector);this.max.add(vector);return this},expandByScalar:function(scalar){this.min.addScalar(-scalar);this.max.addScalar(scalar);return this},containsPoint:function(point){if(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y){return false}return true},containsBox:function(box){if(this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y){return true}return false},getParameter:function(point){return new THREE.Vector2((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(box){if(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y){return false}return true},clampPoint:function(point,optionalTarget){var result=optionalTarget||new THREE.Vector2;return result.copy(point).clamp(this.min,this.max)},distanceToPoint:function(){var v1=new THREE.Vector2;return function(point){var clampedPoint=v1.copy(point).clamp(this.min,this.max);return clampedPoint.sub(point).length()}}(),intersect:function(box){this.min.max(box.min);this.max.min(box.max);return this},union:function(box){this.min.min(box.min);this.max.max(box.max);return this},translate:function(offset){this.min.add(offset);this.max.add(offset);return this},equals:function(box){return box.min.equals(this.min)&&box.max.equals(this.max)},clone:function(){return(new THREE.Box2).copy(this)}};THREE.Box3=function(min,max){this.min=min!==undefined?min:new THREE.Vector3(Infinity,Infinity,Infinity);this.max=max!==undefined?max:new THREE.Vector3(-Infinity,-Infinity,-Infinity)};THREE.Box3.prototype={constructor:THREE.Box3,set:function(min,max){this.min.copy(min);this.max.copy(max);return this},setFromPoints:function(points){if(points.length>0){var point=points[0];this.min.copy(point);this.max.copy(point);for(var i=1,il=points.length;i<il;i++){point=points[i];if(point.x<this.min.x){this.min.x=point.x}else if(point.x>this.max.x){this.max.x=point.x}if(point.y<this.min.y){this.min.y=point.y}else if(point.y>this.max.y){this.max.y=point.y}if(point.z<this.min.z){this.min.z=point.z}else if(point.z>this.max.z){this.max.z=point.z}}}else{this.makeEmpty()}return this},setFromCenterAndSize:function(){var v1=new THREE.Vector3;return function(center,size){var halfSize=v1.copy(size).multiplyScalar(.5);this.min.copy(center).sub(halfSize);this.max.copy(center).add(halfSize);return this}}(),copy:function(box){this.min.copy(box.min);this.max.copy(box.max);return this},makeEmpty:function(){this.min.x=this.min.y=this.min.z=Infinity;this.max.x=this.max.y=this.max.z=-Infinity;return this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},center:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.addVectors(this.min,this.max).multiplyScalar(.5)},size:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.subVectors(this.max,this.min)},expandByPoint:function(point){this.min.min(point);this.max.max(point);return this},expandByVector:function(vector){this.min.sub(vector);this.max.add(vector);return this},expandByScalar:function(scalar){this.min.addScalar(-scalar);this.max.addScalar(scalar);return this},containsPoint:function(point){if(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y||point.z<this.min.z||point.z>this.max.z){return false}return true},containsBox:function(box){if(this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y&&this.min.z<=box.min.z&&box.max.z<=this.max.z){return true}return false},getParameter:function(point){return new THREE.Vector3((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y),(point.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(box){if(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y||box.max.z<this.min.z||box.min.z>this.max.z){return false}return true},clampPoint:function(point,optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.copy(point).clamp(this.min,this.max)},distanceToPoint:function(){var v1=new THREE.Vector3;return function(point){var clampedPoint=v1.copy(point).clamp(this.min,this.max);return clampedPoint.sub(point).length()}}(),getBoundingSphere:function(){var v1=new THREE.Vector3;return function(optionalTarget){var result=optionalTarget||new THREE.Sphere;result.center=this.center();result.radius=this.size(v1).length()*.5;return result}}(),intersect:function(box){this.min.max(box.min);this.max.min(box.max);return this},union:function(box){this.min.min(box.min);this.max.max(box.max);return this},applyMatrix4:function(){var points=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];return function(matrix){points[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(matrix);points[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(matrix);points[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(matrix);points[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(matrix);points[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(matrix);points[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(matrix);points[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(matrix);points[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(matrix);this.makeEmpty();this.setFromPoints(points);return this}}(),translate:function(offset){this.min.add(offset);this.max.add(offset);return this},equals:function(box){return box.min.equals(this.min)&&box.max.equals(this.max)},clone:function(){return(new THREE.Box3).copy(this)}};THREE.Matrix3=function(n11,n12,n13,n21,n22,n23,n31,n32,n33){this.elements=new Float32Array(9);this.set(n11!==undefined?n11:1,n12||0,n13||0,n21||0,n22!==undefined?n22:1,n23||0,n31||0,n32||0,n33!==undefined?n33:1)};THREE.Matrix3.prototype={constructor:THREE.Matrix3,set:function(n11,n12,n13,n21,n22,n23,n31,n32,n33){var te=this.elements;te[0]=n11;te[3]=n12;te[6]=n13;te[1]=n21;te[4]=n22;te[7]=n23;te[2]=n31;te[5]=n32;te[8]=n33;return this},identity:function(){this.set(1,0,0,0,1,0,0,0,1);return this},copy:function(m){var me=m.elements;this.set(me[0],me[3],me[6],me[1],me[4],me[7],me[2],me[5],me[8]);return this},multiplyVector3:function(vector){console.warn("DEPRECATED: Matrix3's .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead.");return vector.applyMatrix3(this)},multiplyVector3Array:function(){var v1=new THREE.Vector3;return function(a){for(var i=0,il=a.length;i<il;i+=3){v1.x=a[i];v1.y=a[i+1];v1.z=a[i+2];v1.applyMatrix3(this);a[i]=v1.x;a[i+1]=v1.y;a[i+2]=v1.z}return a}}(),multiplyScalar:function(s){var te=this.elements;te[0]*=s;te[3]*=s;te[6]*=s;te[1]*=s;te[4]*=s;te[7]*=s;te[2]*=s;te[5]*=s;te[8]*=s;return this},determinant:function(){var te=this.elements;var a=te[0],b=te[1],c=te[2],d=te[3],e=te[4],f=te[5],g=te[6],h=te[7],i=te[8];return a*e*i-a*f*h-b*d*i+b*f*g+c*d*h-c*e*g},getInverse:function(matrix,throwOnInvertible){var me=matrix.elements;var te=this.elements;te[0]=me[10]*me[5]-me[6]*me[9];te[1]=-me[10]*me[1]+me[2]*me[9];te[2]=me[6]*me[1]-me[2]*me[5];te[3]=-me[10]*me[4]+me[6]*me[8];te[4]=me[10]*me[0]-me[2]*me[8];te[5]=-me[6]*me[0]+me[2]*me[4];te[6]=me[9]*me[4]-me[5]*me[8];te[7]=-me[9]*me[0]+me[1]*me[8];te[8]=me[5]*me[0]-me[1]*me[4];var det=me[0]*te[0]+me[1]*te[3]+me[2]*te[6];if(det===0){var msg="Matrix3.getInverse(): can't invert matrix, determinant is 0";if(throwOnInvertible||false){throw new Error(msg)}else{console.warn(msg)}this.identity();return this}this.multiplyScalar(1/det);return this},transpose:function(){var tmp,m=this.elements;tmp=m[1];m[1]=m[3];m[3]=tmp;tmp=m[2];m[2]=m[6];m[6]=tmp;tmp=m[5];m[5]=m[7];m[7]=tmp;return this},getNormalMatrix:function(m){this.getInverse(m).transpose();return this},transposeIntoArray:function(r){var m=this.elements;r[0]=m[0];r[1]=m[3];r[2]=m[6];r[3]=m[1];r[4]=m[4];r[5]=m[7];r[6]=m[2];r[7]=m[5];r[8]=m[8];return this},clone:function(){var te=this.elements;return new THREE.Matrix3(te[0],te[3],te[6],te[1],te[4],te[7],te[2],te[5],te[8])}};THREE.Matrix4=function(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){var te=this.elements=new Float32Array(16);te[0]=n11!==undefined?n11:1;te[4]=n12||0;te[8]=n13||0;te[12]=n14||0;te[1]=n21||0;te[5]=n22!==undefined?n22:1;te[9]=n23||0;te[13]=n24||0;te[2]=n31||0;te[6]=n32||0;te[10]=n33!==undefined?n33:1;te[14]=n34||0;te[3]=n41||0;te[7]=n42||0;te[11]=n43||0;te[15]=n44!==undefined?n44:1};THREE.Matrix4.prototype={constructor:THREE.Matrix4,set:function(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){var te=this.elements;te[0]=n11;te[4]=n12;te[8]=n13;te[12]=n14;te[1]=n21;te[5]=n22;te[9]=n23;te[13]=n24;te[2]=n31;te[6]=n32;te[10]=n33;te[14]=n34;te[3]=n41;te[7]=n42;te[11]=n43;te[15]=n44;return this},identity:function(){this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return this},copy:function(m){var me=m.elements;this.set(me[0],me[4],me[8],me[12],me[1],me[5],me[9],me[13],me[2],me[6],me[10],me[14],me[3],me[7],me[11],me[15]);return this},extractPosition:function(m){console.warn("DEPRECATED: Matrix4's .extractPosition() has been renamed to .copyPosition().");return this.copyPosition(m)},copyPosition:function(m){var te=this.elements;var me=m.elements;te[12]=me[12];te[13]=me[13];te[14]=me[14];return this},extractRotation:function(){var v1=new THREE.Vector3;return function(m){var te=this.elements;var me=m.elements;var scaleX=1/v1.set(me[0],me[1],me[2]).length();var scaleY=1/v1.set(me[4],me[5],me[6]).length();var scaleZ=1/v1.set(me[8],me[9],me[10]).length();te[0]=me[0]*scaleX;te[1]=me[1]*scaleX;te[2]=me[2]*scaleX;te[4]=me[4]*scaleY;te[5]=me[5]*scaleY;te[6]=me[6]*scaleY;te[8]=me[8]*scaleZ;te[9]=me[9]*scaleZ;te[10]=me[10]*scaleZ;return this}}(),setRotationFromEuler:function(v,order){console.warn("DEPRECATED: Matrix4's .setRotationFromEuler() has been deprecated in favor of makeRotationFromEuler.  Please update your code.");return this.makeRotationFromEuler(v,order)},makeRotationFromEuler:function(v,order){var te=this.elements;var x=v.x,y=v.y,z=v.z;var a=Math.cos(x),b=Math.sin(x);var c=Math.cos(y),d=Math.sin(y);var e=Math.cos(z),f=Math.sin(z);if(order===undefined||order==="XYZ"){var ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e;te[4]=-c*f;te[8]=d;te[1]=af+be*d;te[5]=ae-bf*d;te[9]=-b*c;te[2]=bf-ae*d;te[6]=be+af*d;te[10]=a*c}else if(order==="YXZ"){var ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce+df*b;te[4]=de*b-cf;te[8]=a*d;te[1]=a*f;te[5]=a*e;te[9]=-b;te[2]=cf*b-de;te[6]=df+ce*b;te[10]=a*c}else if(order==="ZXY"){var ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce-df*b;te[4]=-a*f;te[8]=de+cf*b;te[1]=cf+de*b;te[5]=a*e;te[9]=df-ce*b;te[2]=-a*d;te[6]=b;te[10]=a*c}else if(order==="ZYX"){var ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e;te[4]=be*d-af;te[8]=ae*d+bf;te[1]=c*f;te[5]=bf*d+ae;te[9]=af*d-be;te[2]=-d;te[6]=b*c;te[10]=a*c}else if(order==="YZX"){var ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e;te[4]=bd-ac*f;te[8]=bc*f+ad;te[1]=f;te[5]=a*e;te[9]=-b*e;te[2]=-d*e;te[6]=ad*f+bc;te[10]=ac-bd*f}else if(order==="XZY"){var ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e;te[4]=-f;te[8]=d*e;te[1]=ac*f+bd;te[5]=a*e;te[9]=ad*f-bc;te[2]=bc*f-ad;te[6]=b*e;te[10]=bd*f+ac}te[3]=0;te[7]=0;te[11]=0;te[12]=0;te[13]=0;te[14]=0;te[15]=1;return this},setRotationFromQuaternion:function(q){console.warn("DEPRECATED: Matrix4's .setRotationFromQuaternion() has been deprecated in favor of makeRotationFromQuaternion.  Please update your code.");return this.makeRotationFromQuaternion(q)},makeRotationFromQuaternion:function(q){var te=this.elements;var x=q.x,y=q.y,z=q.z,w=q.w;var x2=x+x,y2=y+y,z2=z+z;var xx=x*x2,xy=x*y2,xz=x*z2;var yy=y*y2,yz=y*z2,zz=z*z2;var wx=w*x2,wy=w*y2,wz=w*z2;te[0]=1-(yy+zz);te[4]=xy-wz;te[8]=xz+wy;te[1]=xy+wz;te[5]=1-(xx+zz);te[9]=yz-wx;te[2]=xz-wy;te[6]=yz+wx;te[10]=1-(xx+yy);te[3]=0;te[7]=0;te[11]=0;te[12]=0;te[13]=0;te[14]=0;te[15]=1;return this},lookAt:function(){var x=new THREE.Vector3;var y=new THREE.Vector3;var z=new THREE.Vector3;return function(eye,target,up){var te=this.elements;z.subVectors(eye,target).normalize();if(z.length()===0){z.z=1}x.crossVectors(up,z).normalize();if(x.length()===0){z.x+=1e-4;x.crossVectors(up,z).normalize()}y.crossVectors(z,x);te[0]=x.x;te[4]=y.x;te[8]=z.x;te[1]=x.y;te[5]=y.y;te[9]=z.y;te[2]=x.z;te[6]=y.z;te[10]=z.z;return this}}(),multiply:function(m,n){if(n!==undefined){console.warn("DEPRECATED: Matrix4's .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead.");return this.multiplyMatrices(m,n)}return this.multiplyMatrices(this,m)},multiplyMatrices:function(a,b){var ae=a.elements;var be=b.elements;var te=this.elements;var a11=ae[0],a12=ae[4],a13=ae[8],a14=ae[12];var a21=ae[1],a22=ae[5],a23=ae[9],a24=ae[13];var a31=ae[2],a32=ae[6],a33=ae[10],a34=ae[14];var a41=ae[3],a42=ae[7],a43=ae[11],a44=ae[15];var b11=be[0],b12=be[4],b13=be[8],b14=be[12];var b21=be[1],b22=be[5],b23=be[9],b24=be[13];var b31=be[2],b32=be[6],b33=be[10],b34=be[14];var b41=be[3],b42=be[7],b43=be[11],b44=be[15];te[0]=a11*b11+a12*b21+a13*b31+a14*b41;te[4]=a11*b12+a12*b22+a13*b32+a14*b42;te[8]=a11*b13+a12*b23+a13*b33+a14*b43;te[12]=a11*b14+a12*b24+a13*b34+a14*b44;te[1]=a21*b11+a22*b21+a23*b31+a24*b41;te[5]=a21*b12+a22*b22+a23*b32+a24*b42;te[9]=a21*b13+a22*b23+a23*b33+a24*b43;te[13]=a21*b14+a22*b24+a23*b34+a24*b44;te[2]=a31*b11+a32*b21+a33*b31+a34*b41;te[6]=a31*b12+a32*b22+a33*b32+a34*b42;te[10]=a31*b13+a32*b23+a33*b33+a34*b43;te[14]=a31*b14+a32*b24+a33*b34+a34*b44;te[3]=a41*b11+a42*b21+a43*b31+a44*b41;te[7]=a41*b12+a42*b22+a43*b32+a44*b42;te[11]=a41*b13+a42*b23+a43*b33+a44*b43;te[15]=a41*b14+a42*b24+a43*b34+a44*b44;return this},multiplyToArray:function(a,b,r){var te=this.elements;this.multiplyMatrices(a,b);r[0]=te[0];r[1]=te[1];r[2]=te[2];r[3]=te[3];r[4]=te[4];r[5]=te[5];r[6]=te[6];r[7]=te[7];r[8]=te[8];r[9]=te[9];r[10]=te[10];r[11]=te[11];r[12]=te[12];r[13]=te[13];r[14]=te[14];r[15]=te[15];return this},multiplyScalar:function(s){var te=this.elements;te[0]*=s;te[4]*=s;te[8]*=s;te[12]*=s;te[1]*=s;te[5]*=s;te[9]*=s;te[13]*=s;te[2]*=s;te[6]*=s;te[10]*=s;te[14]*=s;te[3]*=s;te[7]*=s;te[11]*=s;te[15]*=s;return this},multiplyVector3:function(vector){console.warn("DEPRECATED: Matrix4's .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead.");return vector.applyProjection(this)},multiplyVector4:function(vector){console.warn("DEPRECATED: Matrix4's .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead.");return vector.applyMatrix4(this)},multiplyVector3Array:function(){var v1=new THREE.Vector3;return function(a){for(var i=0,il=a.length;i<il;i+=3){v1.x=a[i];v1.y=a[i+1];v1.z=a[i+2];v1.applyProjection(this);a[i]=v1.x;a[i+1]=v1.y;a[i+2]=v1.z}return a}}(),rotateAxis:function(v){console.warn("DEPRECATED: Matrix4's .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead.");v.transformDirection(this)},crossVector:function(vector){console.warn("DEPRECATED: Matrix4's .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead.");return vector.applyMatrix4(this)},determinant:function(){var te=this.elements;var n11=te[0],n12=te[4],n13=te[8],n14=te[12];var n21=te[1],n22=te[5],n23=te[9],n24=te[13];var n31=te[2],n32=te[6],n33=te[10],n34=te[14];var n41=te[3],n42=te[7],n43=te[11],n44=te[15];return n41*(+n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34)+n42*(+n11*n23*n34-n11*n24*n33+n14*n21*n33-n13*n21*n34+n13*n24*n31-n14*n23*n31)+n43*(+n11*n24*n32-n11*n22*n34-n14*n21*n32+n12*n21*n34+n14*n22*n31-n12*n24*n31)+n44*(-n13*n22*n31-n11*n23*n32+n11*n22*n33+n13*n21*n32-n12*n21*n33+n12*n23*n31)},transpose:function(){var te=this.elements;var tmp;tmp=te[1];te[1]=te[4];te[4]=tmp;tmp=te[2];te[2]=te[8];te[8]=tmp;tmp=te[6];te[6]=te[9];te[9]=tmp;tmp=te[3];te[3]=te[12];te[12]=tmp;tmp=te[7];te[7]=te[13];te[13]=tmp;tmp=te[11];te[11]=te[14];te[14]=tmp;return this},flattenToArray:function(flat){var te=this.elements;flat[0]=te[0];flat[1]=te[1];flat[2]=te[2];flat[3]=te[3];flat[4]=te[4];flat[5]=te[5];flat[6]=te[6];flat[7]=te[7];flat[8]=te[8];flat[9]=te[9];flat[10]=te[10];flat[11]=te[11];flat[12]=te[12];flat[13]=te[13];flat[14]=te[14];flat[15]=te[15];return flat},flattenToArrayOffset:function(flat,offset){var te=this.elements;flat[offset]=te[0];flat[offset+1]=te[1];flat[offset+2]=te[2];flat[offset+3]=te[3];flat[offset+4]=te[4];flat[offset+5]=te[5];flat[offset+6]=te[6];flat[offset+7]=te[7];flat[offset+8]=te[8];flat[offset+9]=te[9];flat[offset+10]=te[10];flat[offset+11]=te[11];flat[offset+12]=te[12];flat[offset+13]=te[13];flat[offset+14]=te[14];flat[offset+15]=te[15];return flat},getPosition:function(){var v1=new THREE.Vector3;return function(){console.warn("DEPRECATED: Matrix4's .getPosition() has been removed. Use Vector3.getPositionFromMatrix( matrix ) instead.");var te=this.elements;return v1.set(te[12],te[13],te[14])}}(),setPosition:function(v){var te=this.elements;te[12]=v.x;te[13]=v.y;te[14]=v.z;return this},getInverse:function(m,throwOnInvertible){var te=this.elements;var me=m.elements;var n11=me[0],n12=me[4],n13=me[8],n14=me[12];var n21=me[1],n22=me[5],n23=me[9],n24=me[13];var n31=me[2],n32=me[6],n33=me[10],n34=me[14];var n41=me[3],n42=me[7],n43=me[11],n44=me[15];te[0]=n23*n34*n42-n24*n33*n42+n24*n32*n43-n22*n34*n43-n23*n32*n44+n22*n33*n44;te[4]=n14*n33*n42-n13*n34*n42-n14*n32*n43+n12*n34*n43+n13*n32*n44-n12*n33*n44;te[8]=n13*n24*n42-n14*n23*n42+n14*n22*n43-n12*n24*n43-n13*n22*n44+n12*n23*n44;te[12]=n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34;te[1]=n24*n33*n41-n23*n34*n41-n24*n31*n43+n21*n34*n43+n23*n31*n44-n21*n33*n44;te[5]=n13*n34*n41-n14*n33*n41+n14*n31*n43-n11*n34*n43-n13*n31*n44+n11*n33*n44;te[9]=n14*n23*n41-n13*n24*n41-n14*n21*n43+n11*n24*n43+n13*n21*n44-n11*n23*n44;te[13]=n13*n24*n31-n14*n23*n31+n14*n21*n33-n11*n24*n33-n13*n21*n34+n11*n23*n34;te[2]=n22*n34*n41-n24*n32*n41+n24*n31*n42-n21*n34*n42-n22*n31*n44+n21*n32*n44;te[6]=n14*n32*n41-n12*n34*n41-n14*n31*n42+n11*n34*n42+n12*n31*n44-n11*n32*n44;te[10]=n12*n24*n41-n14*n22*n41+n14*n21*n42-n11*n24*n42-n12*n21*n44+n11*n22*n44;te[14]=n14*n22*n31-n12*n24*n31-n14*n21*n32+n11*n24*n32+n12*n21*n34-n11*n22*n34;te[3]=n23*n32*n41-n22*n33*n41-n23*n31*n42+n21*n33*n42+n22*n31*n43-n21*n32*n43;te[7]=n12*n33*n41-n13*n32*n41+n13*n31*n42-n11*n33*n42-n12*n31*n43+n11*n32*n43;te[11]=n13*n22*n41-n12*n23*n41-n13*n21*n42+n11*n23*n42+n12*n21*n43-n11*n22*n43;te[15]=n12*n23*n31-n13*n22*n31+n13*n21*n32-n11*n23*n32-n12*n21*n33+n11*n22*n33;var det=me[0]*te[0]+me[1]*te[4]+me[2]*te[8]+me[3]*te[12];if(det==0){var msg="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(throwOnInvertible||false){throw new Error(msg)}else{console.warn(msg)}this.identity();return this}this.multiplyScalar(1/det);return this},translate:function(v){console.warn("DEPRECATED: Matrix4's .translate() has been removed.")},rotateX:function(angle){console.warn("DEPRECATED: Matrix4's .rotateX() has been removed.")},rotateY:function(angle){console.warn("DEPRECATED: Matrix4's .rotateY() has been removed.")},rotateZ:function(angle){console.warn("DEPRECATED: Matrix4's .rotateZ() has been removed.")},rotateByAxis:function(axis,angle){console.warn("DEPRECATED: Matrix4's .rotateByAxis() has been removed.")},scale:function(v){var te=this.elements;var x=v.x,y=v.y,z=v.z;te[0]*=x;te[4]*=y;te[8]*=z;te[1]*=x;te[5]*=y;te[9]*=z;te[2]*=x;te[6]*=y;te[10]*=z;te[3]*=x;te[7]*=y;te[11]*=z;return this},getMaxScaleOnAxis:function(){var te=this.elements;var scaleXSq=te[0]*te[0]+te[1]*te[1]+te[2]*te[2];var scaleYSq=te[4]*te[4]+te[5]*te[5]+te[6]*te[6];var scaleZSq=te[8]*te[8]+te[9]*te[9]+te[10]*te[10];return Math.sqrt(Math.max(scaleXSq,Math.max(scaleYSq,scaleZSq)))},makeTranslation:function(x,y,z){this.set(1,0,0,x,0,1,0,y,0,0,1,z,0,0,0,1);return this},makeRotationX:function(theta){var c=Math.cos(theta),s=Math.sin(theta);this.set(1,0,0,0,0,c,-s,0,0,s,c,0,0,0,0,1);return this},makeRotationY:function(theta){var c=Math.cos(theta),s=Math.sin(theta);this.set(c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1);return this},makeRotationZ:function(theta){var c=Math.cos(theta),s=Math.sin(theta);this.set(c,-s,0,0,s,c,0,0,0,0,1,0,0,0,0,1);return this},makeRotationAxis:function(axis,angle){var c=Math.cos(angle);var s=Math.sin(angle);var t=1-c;var x=axis.x,y=axis.y,z=axis.z;var tx=t*x,ty=t*y;this.set(tx*x+c,tx*y-s*z,tx*z+s*y,0,tx*y+s*z,ty*y+c,ty*z-s*x,0,tx*z-s*y,ty*z+s*x,t*z*z+c,0,0,0,0,1);return this},makeScale:function(x,y,z){this.set(x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1);return this},compose:function(position,quaternion,scale){console.warn("DEPRECATED: Matrix4's .compose() has been deprecated in favor of makeFromPositionQuaternionScale. Please update your code.");return this.makeFromPositionQuaternionScale(position,quaternion,scale)},makeFromPositionQuaternionScale:function(position,quaternion,scale){this.makeRotationFromQuaternion(quaternion);this.scale(scale);this.setPosition(position);return this},makeFromPositionEulerScale:function(position,rotation,eulerOrder,scale){this.makeRotationFromEuler(rotation,eulerOrder);this.scale(scale);this.setPosition(position);return this},makeFrustum:function(left,right,bottom,top,near,far){var te=this.elements;var x=2*near/(right-left);var y=2*near/(top-bottom);var a=(right+left)/(right-left);var b=(top+bottom)/(top-bottom);var c=-(far+near)/(far-near);var d=-2*far*near/(far-near);te[0]=x;te[4]=0;te[8]=a;te[12]=0;te[1]=0;te[5]=y;te[9]=b;te[13]=0;te[2]=0;te[6]=0;te[10]=c;te[14]=d;te[3]=0;te[7]=0;te[11]=-1;te[15]=0;return this},makePerspective:function(fov,aspect,near,far){var ymax=near*Math.tan(THREE.Math.degToRad(fov*.5));var ymin=-ymax;var xmin=ymin*aspect;var xmax=ymax*aspect;return this.makeFrustum(xmin,xmax,ymin,ymax,near,far)},makeOrthographic:function(left,right,top,bottom,near,far){var te=this.elements;var w=right-left;var h=top-bottom;var p=far-near;var x=(right+left)/w;var y=(top+bottom)/h;var z=(far+near)/p;te[0]=2/w;te[4]=0;te[8]=0;te[12]=-x;te[1]=0;te[5]=2/h;te[9]=0;te[13]=-y;te[2]=0;te[6]=0;te[10]=-2/p;te[14]=-z;te[3]=0;te[7]=0;te[11]=0;te[15]=1;return this},clone:function(){var te=this.elements;return new THREE.Matrix4(te[0],te[4],te[8],te[12],te[1],te[5],te[9],te[13],te[2],te[6],te[10],te[14],te[3],te[7],te[11],te[15])}};THREE.extend(THREE.Matrix4.prototype,{decompose:function(){var x=new THREE.Vector3;var y=new THREE.Vector3;var z=new THREE.Vector3;var matrix=new THREE.Matrix4;return function(position,quaternion,scale){var te=this.elements;x.set(te[0],te[1],te[2]);y.set(te[4],te[5],te[6]);z.set(te[8],te[9],te[10]);position=position instanceof THREE.Vector3?position:new THREE.Vector3;quaternion=quaternion instanceof THREE.Quaternion?quaternion:new THREE.Quaternion;scale=scale instanceof THREE.Vector3?scale:new THREE.Vector3;scale.x=x.length();scale.y=y.length();scale.z=z.length();position.x=te[12];position.y=te[13];position.z=te[14];matrix.copy(this);matrix.elements[0]/=scale.x;matrix.elements[1]/=scale.x;matrix.elements[2]/=scale.x;matrix.elements[4]/=scale.y;matrix.elements[5]/=scale.y;matrix.elements[6]/=scale.y;matrix.elements[8]/=scale.z;matrix.elements[9]/=scale.z;matrix.elements[10]/=scale.z;quaternion.setFromRotationMatrix(matrix);return[position,quaternion,scale]}}()});THREE.Ray=function(origin,direction){this.origin=origin!==undefined?origin:new THREE.Vector3;this.direction=direction!==undefined?direction:new THREE.Vector3};THREE.Ray.prototype={constructor:THREE.Ray,set:function(origin,direction){this.origin.copy(origin);this.direction.copy(direction);return this},copy:function(ray){this.origin.copy(ray.origin);this.direction.copy(ray.direction);return this},at:function(t,optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.copy(this.direction).multiplyScalar(t).add(this.origin)},recast:function(){var v1=new THREE.Vector3;return function(t){this.origin.copy(this.at(t,v1));return this}}(),closestPointToPoint:function(point,optionalTarget){var result=optionalTarget||new THREE.Vector3;result.subVectors(point,this.origin);var directionDistance=result.dot(this.direction);return result.copy(this.direction).multiplyScalar(directionDistance).add(this.origin)},distanceToPoint:function(){var v1=new THREE.Vector3;return function(point){var directionDistance=v1.subVectors(point,this.origin).dot(this.direction);v1.copy(this.direction).multiplyScalar(directionDistance).add(this.origin);return v1.distanceTo(point)}}(),isIntersectionSphere:function(sphere){return this.distanceToPoint(sphere.center)<=sphere.radius},isIntersectionPlane:function(plane){var denominator=plane.normal.dot(this.direction);if(denominator!=0){return true}if(plane.distanceToPoint(this.origin)==0){return true}return false},distanceToPlane:function(plane){var denominator=plane.normal.dot(this.direction);if(denominator==0){if(plane.distanceToPoint(this.origin)==0){return 0}return undefined}var t=-(this.origin.dot(plane.normal)+plane.constant)/denominator;return t},intersectPlane:function(plane,optionalTarget){var t=this.distanceToPlane(plane);if(t===undefined){return undefined}return this.at(t,optionalTarget)},applyMatrix4:function(matrix4){this.direction.add(this.origin).applyMatrix4(matrix4);this.origin.applyMatrix4(matrix4);this.direction.sub(this.origin);return this},equals:function(ray){return ray.origin.equals(this.origin)&&ray.direction.equals(this.direction)},clone:function(){return(new THREE.Ray).copy(this)}};THREE.Sphere=function(center,radius){this.center=center!==undefined?center:new THREE.Vector3;this.radius=radius!==undefined?radius:0};THREE.Sphere.prototype={constructor:THREE.Sphere,set:function(center,radius){this.center.copy(center);
this.radius=radius;return this},setFromCenterAndPoints:function(center,points){var maxRadiusSq=0;for(var i=0,il=points.length;i<il;i++){var radiusSq=center.distanceToSquared(points[i]);maxRadiusSq=Math.max(maxRadiusSq,radiusSq)}this.center=center;this.radius=Math.sqrt(maxRadiusSq);return this},copy:function(sphere){this.center.copy(sphere.center);this.radius=sphere.radius;return this},empty:function(){return this.radius<=0},containsPoint:function(point){return point.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(point){return point.distanceTo(this.center)-this.radius},intersectsSphere:function(sphere){var radiusSum=this.radius+sphere.radius;return sphere.center.distanceToSquared(this.center)<=radiusSum*radiusSum},clampPoint:function(point,optionalTarget){var deltaLengthSq=this.center.distanceToSquared(point);var result=optionalTarget||new THREE.Vector3;result.copy(point);if(deltaLengthSq>this.radius*this.radius){result.sub(this.center).normalize();result.multiplyScalar(this.radius).add(this.center)}return result},getBoundingBox:function(optionalTarget){var box=optionalTarget||new THREE.Box3;box.set(this.center,this.center);box.expandByScalar(this.radius);return box},applyMatrix4:function(matrix){this.center.applyMatrix4(matrix);this.radius=this.radius*matrix.getMaxScaleOnAxis();return this},translate:function(offset){this.center.add(offset);return this},equals:function(sphere){return sphere.center.equals(this.center)&&sphere.radius===this.radius},clone:function(){return(new THREE.Sphere).copy(this)}};THREE.Frustum=function(p0,p1,p2,p3,p4,p5){this.planes=[p0!==undefined?p0:new THREE.Plane,p1!==undefined?p1:new THREE.Plane,p2!==undefined?p2:new THREE.Plane,p3!==undefined?p3:new THREE.Plane,p4!==undefined?p4:new THREE.Plane,p5!==undefined?p5:new THREE.Plane]};THREE.Frustum.prototype={constructor:THREE.Frustum,set:function(p0,p1,p2,p3,p4,p5){var planes=this.planes;planes[0].copy(p0);planes[1].copy(p1);planes[2].copy(p2);planes[3].copy(p3);planes[4].copy(p4);planes[5].copy(p5);return this},copy:function(frustum){var planes=this.planes;for(var i=0;i<6;i++){planes[i].copy(frustum.planes[i])}return this},setFromMatrix:function(m){var planes=this.planes;var me=m.elements;var me0=me[0],me1=me[1],me2=me[2],me3=me[3];var me4=me[4],me5=me[5],me6=me[6],me7=me[7];var me8=me[8],me9=me[9],me10=me[10],me11=me[11];var me12=me[12],me13=me[13],me14=me[14],me15=me[15];planes[0].setComponents(me3-me0,me7-me4,me11-me8,me15-me12).normalize();planes[1].setComponents(me3+me0,me7+me4,me11+me8,me15+me12).normalize();planes[2].setComponents(me3+me1,me7+me5,me11+me9,me15+me13).normalize();planes[3].setComponents(me3-me1,me7-me5,me11-me9,me15-me13).normalize();planes[4].setComponents(me3-me2,me7-me6,me11-me10,me15-me14).normalize();planes[5].setComponents(me3+me2,me7+me6,me11+me10,me15+me14).normalize();return this},intersectsObject:function(){var center=new THREE.Vector3;return function(object){var matrix=object.matrixWorld;var planes=this.planes;var negRadius=-object.geometry.boundingSphere.radius*matrix.getMaxScaleOnAxis();center.getPositionFromMatrix(matrix);for(var i=0;i<6;i++){var distance=planes[i].distanceToPoint(center);if(distance<negRadius){return false}}return true}}(),intersectsSphere:function(sphere){var planes=this.planes;var center=sphere.center;var negRadius=-sphere.radius;for(var i=0;i<6;i++){var distance=planes[i].distanceToPoint(center);if(distance<negRadius){return false}}return true},containsPoint:function(point){var planes=this.planes;for(var i=0;i<6;i++){if(planes[i].distanceToPoint(point)<0){return false}}return true},clone:function(){return(new THREE.Frustum).copy(this)}};THREE.Plane=function(normal,constant){this.normal=normal!==undefined?normal:new THREE.Vector3(1,0,0);this.constant=constant!==undefined?constant:0};THREE.Plane.prototype={constructor:THREE.Plane,set:function(normal,constant){this.normal.copy(normal);this.constant=constant;return this},setComponents:function(x,y,z,w){this.normal.set(x,y,z);this.constant=w;return this},setFromNormalAndCoplanarPoint:function(normal,point){this.normal.copy(normal);this.constant=-point.dot(this.normal);return this},setFromCoplanarPoints:function(){var v1=new THREE.Vector3;var v2=new THREE.Vector3;return function(a,b,c){var normal=v1.subVectors(c,b).cross(v2.subVectors(a,b)).normalize();this.setFromNormalAndCoplanarPoint(normal,a);return this}}(),copy:function(plane){this.normal.copy(plane.normal);this.constant=plane.constant;return this},normalize:function(){var inverseNormalLength=1/this.normal.length();this.normal.multiplyScalar(inverseNormalLength);this.constant*=inverseNormalLength;return this},negate:function(){this.constant*=-1;this.normal.negate();return this},distanceToPoint:function(point){return this.normal.dot(point)+this.constant},distanceToSphere:function(sphere){return this.distanceToPoint(sphere.center)-sphere.radius},projectPoint:function(point,optionalTarget){return this.orthoPoint(point,optionalTarget).sub(point).negate()},orthoPoint:function(point,optionalTarget){var perpendicularMagnitude=this.distanceToPoint(point);var result=optionalTarget||new THREE.Vector3;return result.copy(this.normal).multiplyScalar(perpendicularMagnitude)},isIntersectionLine:function(line){var startSign=this.distanceToPoint(line.start);var endSign=this.distanceToPoint(line.end);return startSign<0&&endSign>0||endSign<0&&startSign>0},intersectLine:function(){var v1=new THREE.Vector3;return function(line,optionalTarget){var result=optionalTarget||new THREE.Vector3;var direction=line.delta(v1);var denominator=this.normal.dot(direction);if(denominator==0){if(this.distanceToPoint(line.start)==0){return result.copy(line.start)}return undefined}var t=-(line.start.dot(this.normal)+this.constant)/denominator;if(t<0||t>1){return undefined}return result.copy(direction).multiplyScalar(t).add(line.start)}}(),coplanarPoint:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var v1=new THREE.Vector3;var v2=new THREE.Vector3;return function(matrix,optionalNormalMatrix){optionalNormalMatrix=optionalNormalMatrix||(new THREE.Matrix3).getNormalMatrix(matrix);var newNormal=v1.copy(this.normal).applyMatrix3(optionalNormalMatrix);var newCoplanarPoint=this.coplanarPoint(v2);newCoplanarPoint.applyMatrix4(matrix);this.setFromNormalAndCoplanarPoint(newNormal,newCoplanarPoint);return this}}(),translate:function(offset){this.constant=this.constant-offset.dot(this.normal);return this},equals:function(plane){return plane.normal.equals(this.normal)&&plane.constant==this.constant},clone:function(){return(new THREE.Plane).copy(this)}};THREE.Math={clamp:function(x,a,b){return x<a?a:x>b?b:x},clampBottom:function(x,a){return x<a?a:x},mapLinear:function(x,a1,a2,b1,b2){return b1+(x-a1)*(b2-b1)/(a2-a1)},smoothstep:function(x,min,max){if(x<=min)return 0;if(x>=max)return 1;x=(x-min)/(max-min);return x*x*(3-2*x)},smootherstep:function(x,min,max){if(x<=min)return 0;if(x>=max)return 1;x=(x-min)/(max-min);return x*x*x*(x*(x*6-15)+10)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(low,high){return low+Math.floor(Math.random()*(high-low+1))},randFloat:function(low,high){return low+Math.random()*(high-low)},randFloatSpread:function(range){return range*(.5-Math.random())},sign:function(x){return x<0?-1:x>0?1:0},degToRad:function(){var degreeToRadiansFactor=Math.PI/180;return function(degrees){return degrees*degreeToRadiansFactor}}(),radToDeg:function(){var radianToDegreesFactor=180/Math.PI;return function(radians){return radians*radianToDegreesFactor}}()};THREE.Spline=function(points){this.points=points;var c=[],v3={x:0,y:0,z:0},point,intPoint,weight,w2,w3,pa,pb,pc,pd;this.initFromArray=function(a){this.points=[];for(var i=0;i<a.length;i++){this.points[i]={x:a[i][0],y:a[i][1],z:a[i][2]}}};this.getPoint=function(k){point=(this.points.length-1)*k;intPoint=Math.floor(point);weight=point-intPoint;c[0]=intPoint===0?intPoint:intPoint-1;c[1]=intPoint;c[2]=intPoint>this.points.length-2?this.points.length-1:intPoint+1;c[3]=intPoint>this.points.length-3?this.points.length-1:intPoint+2;pa=this.points[c[0]];pb=this.points[c[1]];pc=this.points[c[2]];pd=this.points[c[3]];w2=weight*weight;w3=weight*w2;v3.x=interpolate(pa.x,pb.x,pc.x,pd.x,weight,w2,w3);v3.y=interpolate(pa.y,pb.y,pc.y,pd.y,weight,w2,w3);v3.z=interpolate(pa.z,pb.z,pc.z,pd.z,weight,w2,w3);return v3};this.getControlPointsArray=function(){var i,p,l=this.points.length,coords=[];for(i=0;i<l;i++){p=this.points[i];coords[i]=[p.x,p.y,p.z]}return coords};this.getLength=function(nSubDivisions){var i,index,nSamples,position,point=0,intPoint=0,oldIntPoint=0,oldPosition=new THREE.Vector3,tmpVec=new THREE.Vector3,chunkLengths=[],totalLength=0;chunkLengths[0]=0;if(!nSubDivisions)nSubDivisions=100;nSamples=this.points.length*nSubDivisions;oldPosition.copy(this.points[0]);for(i=1;i<nSamples;i++){index=i/nSamples;position=this.getPoint(index);tmpVec.copy(position);totalLength+=tmpVec.distanceTo(oldPosition);oldPosition.copy(position);point=(this.points.length-1)*index;intPoint=Math.floor(point);if(intPoint!=oldIntPoint){chunkLengths[intPoint]=totalLength;oldIntPoint=intPoint}}chunkLengths[chunkLengths.length]=totalLength;return{chunks:chunkLengths,total:totalLength}};this.reparametrizeByArcLength=function(samplingCoef){var i,j,index,indexCurrent,indexNext,linearDistance,realDistance,sampling,position,newpoints=[],tmpVec=new THREE.Vector3,sl=this.getLength();newpoints.push(tmpVec.copy(this.points[0]).clone());for(i=1;i<this.points.length;i++){realDistance=sl.chunks[i]-sl.chunks[i-1];sampling=Math.ceil(samplingCoef*realDistance/sl.total);indexCurrent=(i-1)/(this.points.length-1);indexNext=i/(this.points.length-1);for(j=1;j<sampling-1;j++){index=indexCurrent+j*(1/sampling)*(indexNext-indexCurrent);position=this.getPoint(index);newpoints.push(tmpVec.copy(position).clone())}newpoints.push(tmpVec.copy(this.points[i]).clone())}this.points=newpoints};function interpolate(p0,p1,p2,p3,t,t2,t3){var v0=(p2-p0)*.5,v1=(p3-p1)*.5;return(2*(p1-p2)+v0+v1)*t3+(-3*(p1-p2)-2*v0-v1)*t2+v0*t+p1}};THREE.Triangle=function(a,b,c){this.a=a!==undefined?a:new THREE.Vector3;this.b=b!==undefined?b:new THREE.Vector3;this.c=c!==undefined?c:new THREE.Vector3};THREE.Triangle.normal=function(){var v0=new THREE.Vector3;return function(a,b,c,optionalTarget){var result=optionalTarget||new THREE.Vector3;result.subVectors(c,b);v0.subVectors(a,b);result.cross(v0);var resultLengthSq=result.lengthSq();if(resultLengthSq>0){return result.multiplyScalar(1/Math.sqrt(resultLengthSq))}return result.set(0,0,0)}}();THREE.Triangle.barycoordFromPoint=function(){var v0=new THREE.Vector3;var v1=new THREE.Vector3;var v2=new THREE.Vector3;return function(point,a,b,c,optionalTarget){v0.subVectors(c,a);v1.subVectors(b,a);v2.subVectors(point,a);var dot00=v0.dot(v0);var dot01=v0.dot(v1);var dot02=v0.dot(v2);var dot11=v1.dot(v1);var dot12=v1.dot(v2);var denom=dot00*dot11-dot01*dot01;var result=optionalTarget||new THREE.Vector3;if(denom==0){return result.set(-2,-1,-1)}var invDenom=1/denom;var u=(dot11*dot02-dot01*dot12)*invDenom;var v=(dot00*dot12-dot01*dot02)*invDenom;return result.set(1-u-v,v,u)}}();THREE.Triangle.containsPoint=function(){var v1=new THREE.Vector3;return function(point,a,b,c){var result=THREE.Triangle.barycoordFromPoint(point,a,b,c,v1);return result.x>=0&&result.y>=0&&result.x+result.y<=1}}();THREE.Triangle.prototype={constructor:THREE.Triangle,set:function(a,b,c){this.a.copy(a);this.b.copy(b);this.c.copy(c);return this},setFromPointsAndIndices:function(points,i0,i1,i2){this.a.copy(points[i0]);this.b.copy(points[i1]);this.c.copy(points[i2]);return this},copy:function(triangle){this.a.copy(triangle.a);this.b.copy(triangle.b);this.c.copy(triangle.c);return this},area:function(){var v0=new THREE.Vector3;var v1=new THREE.Vector3;return function(){v0.subVectors(this.c,this.b);v1.subVectors(this.a,this.b);return v0.cross(v1).length()*.5}}(),midpoint:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(optionalTarget){return THREE.Triangle.normal(this.a,this.b,this.c,optionalTarget)},plane:function(optionalTarget){var result=optionalTarget||new THREE.Plane;return result.setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(point,optionalTarget){return THREE.Triangle.barycoordFromPoint(point,this.a,this.b,this.c,optionalTarget)},containsPoint:function(point){return THREE.Triangle.containsPoint(point,this.a,this.b,this.c)},equals:function(triangle){return triangle.a.equals(this.a)&&triangle.b.equals(this.b)&&triangle.c.equals(this.c)},clone:function(){return(new THREE.Triangle).copy(this)}};THREE.Vertex=function(v){console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead.");return v};THREE.UV=function(u,v){console.warn("THREE.UV has been DEPRECATED. Use THREE.Vector2 instead.");return new THREE.Vector2(u,v)};THREE.Clock=function(autoStart){this.autoStart=autoStart!==undefined?autoStart:true;this.startTime=0;this.oldTime=0;this.elapsedTime=0;this.running=false};THREE.Clock.prototype={constructor:THREE.Clock,start:function(){this.startTime=self.performance!==undefined&&self.performance.now!==undefined?self.performance.now():Date.now();this.oldTime=this.startTime;this.running=true},stop:function(){this.getElapsedTime();this.running=false},getElapsedTime:function(){this.getDelta();return this.elapsedTime},getDelta:function(){var diff=0;if(this.autoStart&&!this.running){this.start()}if(this.running){var newTime=self.performance!==undefined&&self.performance.now!==undefined?self.performance.now():Date.now();diff=.001*(newTime-this.oldTime);this.oldTime=newTime;this.elapsedTime+=diff}return diff}};THREE.EventDispatcher=function(){};THREE.EventDispatcher.prototype={constructor:THREE.EventDispatcher,addEventListener:function(type,listener){if(this._listeners===undefined)this._listeners={};var listeners=this._listeners;if(listeners[type]===undefined){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}},hasEventListener:function(type,listener){if(this._listeners===undefined)return false;var listeners=this._listeners;if(listeners[type]!==undefined&&listeners[type].indexOf(listener)!==-1){return true}return false},removeEventListener:function(type,listener){if(this._listeners===undefined)return;var listeners=this._listeners;var index=listeners[type].indexOf(listener);if(index!==-1){listeners[type].splice(index,1)}},dispatchEvent:function(event){if(this._listeners===undefined)return;var listeners=this._listeners;var listenerArray=listeners[event.type];if(listenerArray!==undefined){event.target=this;for(var i=0,l=listenerArray.length;i<l;i++){listenerArray[i].call(this,event)}}}};(function(THREE){THREE.Raycaster=function(origin,direction,near,far){this.ray=new THREE.Ray(origin,direction);if(this.ray.direction.lengthSq()>0){this.ray.direction.normalize()}this.near=near||0;this.far=far||Infinity};var sphere=new THREE.Sphere;var localRay=new THREE.Ray;var facePlane=new THREE.Plane;var intersectPoint=new THREE.Vector3;var matrixPosition=new THREE.Vector3;var inverseMatrix=new THREE.Matrix4;var descSort=function(a,b){return a.distance-b.distance};var intersectObject=function(object,raycaster,intersects){if(object instanceof THREE.Particle){matrixPosition.getPositionFromMatrix(object.matrixWorld);var distance=raycaster.ray.distanceToPoint(matrixPosition);if(distance>object.scale.x){return intersects}intersects.push({distance:distance,point:object.position,face:null,object:object})}else if(object instanceof THREE.LOD){matrixPosition.getPositionFromMatrix(object.matrixWorld);var distance=raycaster.ray.origin.distanceTo(matrixPosition);intersectObject(object.getObjectForDistance(distance),raycaster,intersects)}else if(object instanceof THREE.Mesh){matrixPosition.getPositionFromMatrix(object.matrixWorld);sphere.set(matrixPosition,object.geometry.boundingSphere.radius*object.matrixWorld.getMaxScaleOnAxis());if(!raycaster.ray.isIntersectionSphere(sphere)){return intersects}var geometry=object.geometry;var vertices=geometry.vertices;var isFaceMaterial=object.material instanceof THREE.MeshFaceMaterial;var objectMaterials=isFaceMaterial===true?object.material.materials:null;var side=object.material.side;var a,b,c,d;var precision=raycaster.precision;inverseMatrix.getInverse(object.matrixWorld);localRay.copy(raycaster.ray).applyMatrix4(inverseMatrix);for(var f=0,fl=geometry.faces.length;f<fl;f++){var face=geometry.faces[f];var material=isFaceMaterial===true?objectMaterials[face.materialIndex]:object.material;if(material===undefined)continue;facePlane.setFromNormalAndCoplanarPoint(face.normal,vertices[face.a]);var planeDistance=localRay.distanceToPlane(facePlane);if(Math.abs(planeDistance)<precision)continue;if(planeDistance<0)continue;side=material.side;if(side!==THREE.DoubleSide){var planeSign=localRay.direction.dot(facePlane.normal);if(!(side===THREE.FrontSide?planeSign<0:planeSign>0))continue}if(planeDistance<raycaster.near||planeDistance>raycaster.far)continue;intersectPoint=localRay.at(planeDistance,intersectPoint);if(face instanceof THREE.Face3){a=vertices[face.a];b=vertices[face.b];c=vertices[face.c];if(!THREE.Triangle.containsPoint(intersectPoint,a,b,c))continue}else if(face instanceof THREE.Face4){a=vertices[face.a];b=vertices[face.b];c=vertices[face.c];d=vertices[face.d];if(!THREE.Triangle.containsPoint(intersectPoint,a,b,d)&&!THREE.Triangle.containsPoint(intersectPoint,b,c,d))continue}else{throw Error("face type not supported")}intersects.push({distance:planeDistance,point:raycaster.ray.at(planeDistance),face:face,faceIndex:f,object:object})}}};var intersectDescendants=function(object,raycaster,intersects){var descendants=object.getDescendants();for(var i=0,l=descendants.length;i<l;i++){intersectObject(descendants[i],raycaster,intersects)}};THREE.Raycaster.prototype.precision=1e-4;THREE.Raycaster.prototype.set=function(origin,direction){this.ray.set(origin,direction);if(this.ray.direction.length()>0){this.ray.direction.normalize()}};THREE.Raycaster.prototype.intersectObject=function(object,recursive){var intersects=[];if(recursive===true){intersectDescendants(object,this,intersects)}intersectObject(object,this,intersects);intersects.sort(descSort);return intersects};THREE.Raycaster.prototype.intersectObjects=function(objects,recursive){var intersects=[];for(var i=0,l=objects.length;i<l;i++){intersectObject(objects[i],this,intersects);if(recursive===true){intersectDescendants(objects[i],this,intersects)}}intersects.sort(descSort);return intersects}})(THREE);THREE.Object3D=function(){this.id=THREE.Object3DIdCount++;this.name="";this.parent=undefined;this.children=[];this.up=new THREE.Vector3(0,1,0);this.position=new THREE.Vector3;this.rotation=new THREE.Vector3;this.eulerOrder=THREE.Object3D.defaultEulerOrder;this.scale=new THREE.Vector3(1,1,1);this.renderDepth=null;this.rotationAutoUpdate=true;this.matrix=new THREE.Matrix4;this.matrixWorld=new THREE.Matrix4;this.matrixAutoUpdate=true;this.matrixWorldNeedsUpdate=true;this.quaternion=new THREE.Quaternion;this.useQuaternion=false;this.visible=true;this.castShadow=false;this.receiveShadow=false;this.frustumCulled=true;this.userData={}};THREE.Object3D.prototype={constructor:THREE.Object3D,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,applyMatrix:function(){var m1=new THREE.Matrix4;return function(matrix){this.matrix.multiplyMatrices(matrix,this.matrix);this.position.getPositionFromMatrix(this.matrix);this.scale.getScaleFromMatrix(this.matrix);m1.extractRotation(this.matrix);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(m1)}else{this.rotation.setEulerFromRotationMatrix(m1,this.eulerOrder)}}}(),rotateOnAxis:function(){var q1=new THREE.Quaternion;var q2=new THREE.Quaternion;return function(axis,angle){q1.setFromAxisAngle(axis,angle);if(this.useQuaternion===true){this.quaternion.multiply(q1)}else{q2.setFromEuler(this.rotation,this.eulerOrder);q2.multiply(q1);this.rotation.setEulerFromQuaternion(q2,this.eulerOrder)}return this}}(),translateOnAxis:function(){var v1=new THREE.Vector3;return function(axis,distance){v1.copy(axis);if(this.useQuaternion===true){v1.applyQuaternion(this.quaternion)}else{v1.applyEuler(this.rotation,this.eulerOrder)}this.position.add(v1.multiplyScalar(distance));return this}}(),translate:function(distance,axis){console.warn("DEPRECATED: Object3D's .translate() has been removed. Use .translateOnAxis( axis, distance ) instead. Note args have been changed.");return this.translateOnAxis(axis,distance)},translateX:function(){var v1=new THREE.Vector3(1,0,0);return function(distance){return this.translateOnAxis(v1,distance)}}(),translateY:function(){var v1=new THREE.Vector3(0,1,0);return function(distance){return this.translateOnAxis(v1,distance)}}(),translateZ:function(){var v1=new THREE.Vector3(0,0,1);return function(distance){return this.translateOnAxis(v1,distance)}}(),localToWorld:function(vector){return vector.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var m1=new THREE.Matrix4;return function(vector){return vector.applyMatrix4(m1.getInverse(this.matrixWorld))}}(),lookAt:function(){var m1=new THREE.Matrix4;return function(vector){m1.lookAt(vector,this.position,this.up);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(m1)}else{this.rotation.setEulerFromRotationMatrix(m1,this.eulerOrder)}}}(),add:function(object){if(object===this){console.warn("THREE.Object3D.add: An object can't be added as a child of itself.");return}if(object instanceof THREE.Object3D){if(object.parent!==undefined){object.parent.remove(object)}object.parent=this;this.children.push(object);var scene=this;while(scene.parent!==undefined){scene=scene.parent}if(scene!==undefined&&scene instanceof THREE.Scene){scene.__addObject(object)}}},remove:function(object){var index=this.children.indexOf(object);if(index!==-1){object.parent=undefined;this.children.splice(index,1);var scene=this;while(scene.parent!==undefined){scene=scene.parent}if(scene!==undefined&&scene instanceof THREE.Scene){scene.__removeObject(object)}}},traverse:function(callback){callback(this);for(var i=0,l=this.children.length;i<l;i++){this.children[i].traverse(callback)}},getObjectById:function(id,recursive){for(var i=0,l=this.children.length;i<l;i++){var child=this.children[i];if(child.id===id){return child}if(recursive===true){child=child.getObjectById(id,recursive);if(child!==undefined){return child}}}return undefined},getObjectByName:function(name,recursive){for(var i=0,l=this.children.length;i<l;i++){var child=this.children[i];if(child.name===name){return child}if(recursive===true){child=child.getObjectByName(name,recursive);if(child!==undefined){return child}}}return undefined},getChildByName:function(name,recursive){console.warn("DEPRECATED: Object3D's .getChildByName() has been renamed to .getObjectByName().");return this.getObjectByName(name,recursive)},getDescendants:function(array){if(array===undefined)array=[];Array.prototype.push.apply(array,this.children);for(var i=0,l=this.children.length;i<l;i++){this.children[i].getDescendants(array)}return array},updateMatrix:function(){if(this.useQuaternion===false){this.matrix.makeFromPositionEulerScale(this.position,this.rotation,this.eulerOrder,this.scale)}else{this.matrix.makeFromPositionQuaternionScale(this.position,this.quaternion,this.scale)}this.matrixWorldNeedsUpdate=true},updateMatrixWorld:function(force){if(this.matrixAutoUpdate===true)this.updateMatrix();if(this.matrixWorldNeedsUpdate===true||force===true){if(this.parent===undefined){this.matrixWorld.copy(this.matrix)}else{this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)}this.matrixWorldNeedsUpdate=false;force=true}for(var i=0,l=this.children.length;i<l;i++){this.children[i].updateMatrixWorld(force)}},clone:function(object){if(object===undefined)object=new THREE.Object3D;object.name=this.name;object.up.copy(this.up);object.position.copy(this.position);if(object.rotation instanceof THREE.Vector3)object.rotation.copy(this.rotation);object.eulerOrder=this.eulerOrder;object.scale.copy(this.scale);object.renderDepth=this.renderDepth;object.rotationAutoUpdate=this.rotationAutoUpdate;object.matrix.copy(this.matrix);object.matrixWorld.copy(this.matrixWorld);object.matrixAutoUpdate=this.matrixAutoUpdate;object.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate;object.quaternion.copy(this.quaternion);object.useQuaternion=this.useQuaternion;object.visible=this.visible;object.castShadow=this.castShadow;object.receiveShadow=this.receiveShadow;object.frustumCulled=this.frustumCulled;object.userData=JSON.parse(JSON.stringify(this.userData));for(var i=0;i<this.children.length;i++){var child=this.children[i];object.add(child.clone())}return object}};THREE.Object3D.defaultEulerOrder="XYZ",THREE.Object3DIdCount=0;THREE.Projector=function(){var _object,_objectCount,_objectPool=[],_objectPoolLength=0,_vertex,_vertexCount,_vertexPool=[],_vertexPoolLength=0,_face,_face3Count,_face3Pool=[],_face3PoolLength=0,_face4Count,_face4Pool=[],_face4PoolLength=0,_line,_lineCount,_linePool=[],_linePoolLength=0,_particle,_particleCount,_particlePool=[],_particlePoolLength=0,_renderData={objects:[],sprites:[],lights:[],elements:[]},_vector3=new THREE.Vector3,_vector4=new THREE.Vector4,_clipBox=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),_boundingBox=new THREE.Box3,_points3=new Array(3),_points4=new Array(4),_viewMatrix=new THREE.Matrix4,_viewProjectionMatrix=new THREE.Matrix4,_modelMatrix,_modelViewProjectionMatrix=new THREE.Matrix4,_normalMatrix=new THREE.Matrix3,_normalViewMatrix=new THREE.Matrix3,_centroid=new THREE.Vector3,_frustum=new THREE.Frustum,_clippedVertex1PositionScreen=new THREE.Vector4,_clippedVertex2PositionScreen=new THREE.Vector4;this.projectVector=function(vector,camera){camera.matrixWorldInverse.getInverse(camera.matrixWorld);_viewProjectionMatrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse);return vector.applyProjection(_viewProjectionMatrix)};this.unprojectVector=function(vector,camera){camera.projectionMatrixInverse.getInverse(camera.projectionMatrix);_viewProjectionMatrix.multiplyMatrices(camera.matrixWorld,camera.projectionMatrixInverse);return vector.applyProjection(_viewProjectionMatrix)};this.pickingRay=function(vector,camera){vector.z=-1;var end=new THREE.Vector3(vector.x,vector.y,1);this.unprojectVector(vector,camera);this.unprojectVector(end,camera);end.sub(vector).normalize();return new THREE.Raycaster(vector,end)};var getObject=function(object){_object=getNextObjectInPool();_object.object=object;if(object.renderDepth!==null){_object.z=object.renderDepth}else{_vector3.getPositionFromMatrix(object.matrixWorld);_vector3.applyProjection(_viewProjectionMatrix);_object.z=_vector3.z}return _object};var projectObject=function(object){if(object.visible===false)return;if(object instanceof THREE.Light){_renderData.lights.push(object)}else if(object instanceof THREE.Mesh||object instanceof THREE.Line){if(object.frustumCulled===false||_frustum.intersectsObject(object)===true){_renderData.objects.push(getObject(object))}}else if(object instanceof THREE.Sprite||object instanceof THREE.Particle){_renderData.sprites.push(getObject(object))}for(var i=0,l=object.children.length;i<l;i++){projectObject(object.children[i])}};var projectGraph=function(root,sortObjects){_objectCount=0;_renderData.objects.length=0;_renderData.sprites.length=0;_renderData.lights.length=0;projectObject(root);if(sortObjects===true){_renderData.objects.sort(painterSort)}};this.projectScene=function(scene,camera,sortObjects,sortElements){var visible=false,o,ol,v,vl,f,fl,n,nl,c,cl,u,ul,object,geometry,vertices,faces,face,faceVertexNormals,faceVertexUvs,uvs,v1,v2,v3,v4,isFaceMaterial,objectMaterials;_face3Count=0;_face4Count=0;_lineCount=0;_particleCount=0;_renderData.elements.length=0;if(scene.autoUpdate===true)scene.updateMatrixWorld();if(camera.parent===undefined)camera.updateMatrixWorld();_viewMatrix.copy(camera.matrixWorldInverse.getInverse(camera.matrixWorld));_viewProjectionMatrix.multiplyMatrices(camera.projectionMatrix,_viewMatrix);_normalViewMatrix.getNormalMatrix(_viewMatrix);_frustum.setFromMatrix(_viewProjectionMatrix);projectGraph(scene,sortObjects);for(o=0,ol=_renderData.objects.length;o<ol;o++){object=_renderData.objects[o].object;_modelMatrix=object.matrixWorld;_vertexCount=0;if(object instanceof THREE.Mesh){geometry=object.geometry;vertices=geometry.vertices;faces=geometry.faces;faceVertexUvs=geometry.faceVertexUvs;_normalMatrix.getNormalMatrix(_modelMatrix);isFaceMaterial=object.material instanceof THREE.MeshFaceMaterial;objectMaterials=isFaceMaterial===true?object.material:null;for(v=0,vl=vertices.length;v<vl;v++){_vertex=getNextVertexInPool();_vertex.positionWorld.copy(vertices[v]).applyMatrix4(_modelMatrix);_vertex.positionScreen.copy(_vertex.positionWorld).applyMatrix4(_viewProjectionMatrix);_vertex.positionScreen.x/=_vertex.positionScreen.w;_vertex.positionScreen.y/=_vertex.positionScreen.w;_vertex.positionScreen.z/=_vertex.positionScreen.w;_vertex.visible=!(_vertex.positionScreen.x<-1||_vertex.positionScreen.x>1||_vertex.positionScreen.y<-1||_vertex.positionScreen.y>1||_vertex.positionScreen.z<-1||_vertex.positionScreen.z>1)}for(f=0,fl=faces.length;f<fl;f++){face=faces[f];var material=isFaceMaterial===true?objectMaterials.materials[face.materialIndex]:object.material;if(material===undefined)continue;var side=material.side;if(face instanceof THREE.Face3){v1=_vertexPool[face.a];v2=_vertexPool[face.b];v3=_vertexPool[face.c];_points3[0]=v1.positionScreen;_points3[1]=v2.positionScreen;_points3[2]=v3.positionScreen;if(v1.visible===true||v2.visible===true||v3.visible===true||_clipBox.isIntersectionBox(_boundingBox.setFromPoints(_points3))){visible=(v3.positionScreen.x-v1.positionScreen.x)*(v2.positionScreen.y-v1.positionScreen.y)-(v3.positionScreen.y-v1.positionScreen.y)*(v2.positionScreen.x-v1.positionScreen.x)<0;if(side===THREE.DoubleSide||visible===(side===THREE.FrontSide)){_face=getNextFace3InPool();_face.v1.copy(v1);_face.v2.copy(v2);_face.v3.copy(v3)}else{continue}}else{continue}}else if(face instanceof THREE.Face4){v1=_vertexPool[face.a];v2=_vertexPool[face.b];v3=_vertexPool[face.c];v4=_vertexPool[face.d];_points4[0]=v1.positionScreen;_points4[1]=v2.positionScreen;_points4[2]=v3.positionScreen;_points4[3]=v4.positionScreen;if(v1.visible===true||v2.visible===true||v3.visible===true||v4.visible===true||_clipBox.isIntersectionBox(_boundingBox.setFromPoints(_points4))){visible=(v4.positionScreen.x-v1.positionScreen.x)*(v2.positionScreen.y-v1.positionScreen.y)-(v4.positionScreen.y-v1.positionScreen.y)*(v2.positionScreen.x-v1.positionScreen.x)<0||(v2.positionScreen.x-v3.positionScreen.x)*(v4.positionScreen.y-v3.positionScreen.y)-(v2.positionScreen.y-v3.positionScreen.y)*(v4.positionScreen.x-v3.positionScreen.x)<0;if(side===THREE.DoubleSide||visible===(side===THREE.FrontSide)){_face=getNextFace4InPool();_face.v1.copy(v1);_face.v2.copy(v2);_face.v3.copy(v3);_face.v4.copy(v4)}else{continue}}else{continue}}_face.normalModel.copy(face.normal);if(visible===false&&(side===THREE.BackSide||side===THREE.DoubleSide)){_face.normalModel.negate()}_face.normalModel.applyMatrix3(_normalMatrix).normalize();_face.normalModelView.copy(_face.normalModel).applyMatrix3(_normalViewMatrix);_face.centroidModel.copy(face.centroid).applyMatrix4(_modelMatrix);faceVertexNormals=face.vertexNormals;for(n=0,nl=faceVertexNormals.length;n<nl;n++){var normalModel=_face.vertexNormalsModel[n];normalModel.copy(faceVertexNormals[n]);if(visible===false&&(side===THREE.BackSide||side===THREE.DoubleSide)){normalModel.negate()
}normalModel.applyMatrix3(_normalMatrix).normalize();var normalModelView=_face.vertexNormalsModelView[n];normalModelView.copy(normalModel).applyMatrix3(_normalViewMatrix)}_face.vertexNormalsLength=faceVertexNormals.length;for(c=0,cl=faceVertexUvs.length;c<cl;c++){uvs=faceVertexUvs[c][f];if(uvs===undefined)continue;for(u=0,ul=uvs.length;u<ul;u++){_face.uvs[c][u]=uvs[u]}}_face.color=face.color;_face.material=material;_centroid.copy(_face.centroidModel).applyProjection(_viewProjectionMatrix);_face.z=_centroid.z;_renderData.elements.push(_face)}}else if(object instanceof THREE.Line){_modelViewProjectionMatrix.multiplyMatrices(_viewProjectionMatrix,_modelMatrix);vertices=object.geometry.vertices;v1=getNextVertexInPool();v1.positionScreen.copy(vertices[0]).applyMatrix4(_modelViewProjectionMatrix);var step=object.type===THREE.LinePieces?2:1;for(v=1,vl=vertices.length;v<vl;v++){v1=getNextVertexInPool();v1.positionScreen.copy(vertices[v]).applyMatrix4(_modelViewProjectionMatrix);if((v+1)%step>0)continue;v2=_vertexPool[_vertexCount-2];_clippedVertex1PositionScreen.copy(v1.positionScreen);_clippedVertex2PositionScreen.copy(v2.positionScreen);if(clipLine(_clippedVertex1PositionScreen,_clippedVertex2PositionScreen)===true){_clippedVertex1PositionScreen.multiplyScalar(1/_clippedVertex1PositionScreen.w);_clippedVertex2PositionScreen.multiplyScalar(1/_clippedVertex2PositionScreen.w);_line=getNextLineInPool();_line.v1.positionScreen.copy(_clippedVertex1PositionScreen);_line.v2.positionScreen.copy(_clippedVertex2PositionScreen);_line.z=Math.max(_clippedVertex1PositionScreen.z,_clippedVertex2PositionScreen.z);_line.material=object.material;if(object.material.vertexColors===THREE.VertexColors){_line.vertexColors[0].copy(object.geometry.colors[v]);_line.vertexColors[1].copy(object.geometry.colors[v-1])}_renderData.elements.push(_line)}}}}for(o=0,ol=_renderData.sprites.length;o<ol;o++){object=_renderData.sprites[o].object;_modelMatrix=object.matrixWorld;if(object instanceof THREE.Particle){_vector4.set(_modelMatrix.elements[12],_modelMatrix.elements[13],_modelMatrix.elements[14],1);_vector4.applyMatrix4(_viewProjectionMatrix);_vector4.z/=_vector4.w;if(_vector4.z>0&&_vector4.z<1){_particle=getNextParticleInPool();_particle.object=object;_particle.x=_vector4.x/_vector4.w;_particle.y=_vector4.y/_vector4.w;_particle.z=_vector4.z;_particle.rotation=object.rotation.z;_particle.scale.x=object.scale.x*Math.abs(_particle.x-(_vector4.x+camera.projectionMatrix.elements[0])/(_vector4.w+camera.projectionMatrix.elements[12]));_particle.scale.y=object.scale.y*Math.abs(_particle.y-(_vector4.y+camera.projectionMatrix.elements[5])/(_vector4.w+camera.projectionMatrix.elements[13]));_particle.material=object.material;_renderData.elements.push(_particle)}}}if(sortElements===true)_renderData.elements.sort(painterSort);return _renderData};function getNextObjectInPool(){if(_objectCount===_objectPoolLength){var object=new THREE.RenderableObject;_objectPool.push(object);_objectPoolLength++;_objectCount++;return object}return _objectPool[_objectCount++]}function getNextVertexInPool(){if(_vertexCount===_vertexPoolLength){var vertex=new THREE.RenderableVertex;_vertexPool.push(vertex);_vertexPoolLength++;_vertexCount++;return vertex}return _vertexPool[_vertexCount++]}function getNextFace3InPool(){if(_face3Count===_face3PoolLength){var face=new THREE.RenderableFace3;_face3Pool.push(face);_face3PoolLength++;_face3Count++;return face}return _face3Pool[_face3Count++]}function getNextFace4InPool(){if(_face4Count===_face4PoolLength){var face=new THREE.RenderableFace4;_face4Pool.push(face);_face4PoolLength++;_face4Count++;return face}return _face4Pool[_face4Count++]}function getNextLineInPool(){if(_lineCount===_linePoolLength){var line=new THREE.RenderableLine;_linePool.push(line);_linePoolLength++;_lineCount++;return line}return _linePool[_lineCount++]}function getNextParticleInPool(){if(_particleCount===_particlePoolLength){var particle=new THREE.RenderableParticle;_particlePool.push(particle);_particlePoolLength++;_particleCount++;return particle}return _particlePool[_particleCount++]}function painterSort(a,b){return b.z-a.z}function clipLine(s1,s2){var alpha1=0,alpha2=1,bc1near=s1.z+s1.w,bc2near=s2.z+s2.w,bc1far=-s1.z+s1.w,bc2far=-s2.z+s2.w;if(bc1near>=0&&bc2near>=0&&bc1far>=0&&bc2far>=0){return true}else if(bc1near<0&&bc2near<0||bc1far<0&&bc2far<0){return false}else{if(bc1near<0){alpha1=Math.max(alpha1,bc1near/(bc1near-bc2near))}else if(bc2near<0){alpha2=Math.min(alpha2,bc1near/(bc1near-bc2near))}if(bc1far<0){alpha1=Math.max(alpha1,bc1far/(bc1far-bc2far))}else if(bc2far<0){alpha2=Math.min(alpha2,bc1far/(bc1far-bc2far))}if(alpha2<alpha1){return false}else{s1.lerp(s2,alpha1);s2.lerp(s1,1-alpha2);return true}}}};THREE.Face3=function(a,b,c,normal,color,materialIndex){this.a=a;this.b=b;this.c=c;this.normal=normal instanceof THREE.Vector3?normal:new THREE.Vector3;this.vertexNormals=normal instanceof Array?normal:[];this.color=color instanceof THREE.Color?color:new THREE.Color;this.vertexColors=color instanceof Array?color:[];this.vertexTangents=[];this.materialIndex=materialIndex!==undefined?materialIndex:0;this.centroid=new THREE.Vector3};THREE.Face3.prototype={constructor:THREE.Face3,clone:function(){var face=new THREE.Face3(this.a,this.b,this.c);face.normal.copy(this.normal);face.color.copy(this.color);face.centroid.copy(this.centroid);face.materialIndex=this.materialIndex;var i,il;for(i=0,il=this.vertexNormals.length;i<il;i++)face.vertexNormals[i]=this.vertexNormals[i].clone();for(i=0,il=this.vertexColors.length;i<il;i++)face.vertexColors[i]=this.vertexColors[i].clone();for(i=0,il=this.vertexTangents.length;i<il;i++)face.vertexTangents[i]=this.vertexTangents[i].clone();return face}};THREE.Face4=function(a,b,c,d,normal,color,materialIndex){this.a=a;this.b=b;this.c=c;this.d=d;this.normal=normal instanceof THREE.Vector3?normal:new THREE.Vector3;this.vertexNormals=normal instanceof Array?normal:[];this.color=color instanceof THREE.Color?color:new THREE.Color;this.vertexColors=color instanceof Array?color:[];this.vertexTangents=[];this.materialIndex=materialIndex!==undefined?materialIndex:0;this.centroid=new THREE.Vector3};THREE.Face4.prototype={constructor:THREE.Face4,clone:function(){var face=new THREE.Face4(this.a,this.b,this.c,this.d);face.normal.copy(this.normal);face.color.copy(this.color);face.centroid.copy(this.centroid);face.materialIndex=this.materialIndex;var i,il;for(i=0,il=this.vertexNormals.length;i<il;i++)face.vertexNormals[i]=this.vertexNormals[i].clone();for(i=0,il=this.vertexColors.length;i<il;i++)face.vertexColors[i]=this.vertexColors[i].clone();for(i=0,il=this.vertexTangents.length;i<il;i++)face.vertexTangents[i]=this.vertexTangents[i].clone();return face}};THREE.Geometry=function(){this.id=THREE.GeometryIdCount++;this.name="";this.vertices=[];this.colors=[];this.normals=[];this.faces=[];this.faceUvs=[[]];this.faceVertexUvs=[[]];this.morphTargets=[];this.morphColors=[];this.morphNormals=[];this.skinWeights=[];this.skinIndices=[];this.lineDistances=[];this.boundingBox=null;this.boundingSphere=null;this.hasTangents=false;this.dynamic=true;this.verticesNeedUpdate=false;this.elementsNeedUpdate=false;this.uvsNeedUpdate=false;this.normalsNeedUpdate=false;this.tangentsNeedUpdate=false;this.colorsNeedUpdate=false;this.lineDistancesNeedUpdate=false;this.buffersNeedUpdate=false};THREE.Geometry.prototype={constructor:THREE.Geometry,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,applyMatrix:function(matrix){var normalMatrix=(new THREE.Matrix3).getNormalMatrix(matrix);for(var i=0,il=this.vertices.length;i<il;i++){var vertex=this.vertices[i];vertex.applyMatrix4(matrix)}for(var i=0,il=this.faces.length;i<il;i++){var face=this.faces[i];face.normal.applyMatrix3(normalMatrix).normalize();for(var j=0,jl=face.vertexNormals.length;j<jl;j++){face.vertexNormals[j].applyMatrix3(normalMatrix).normalize()}face.centroid.applyMatrix4(matrix)}},computeCentroids:function(){var f,fl,face;for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];face.centroid.set(0,0,0);if(face instanceof THREE.Face3){face.centroid.add(this.vertices[face.a]);face.centroid.add(this.vertices[face.b]);face.centroid.add(this.vertices[face.c]);face.centroid.divideScalar(3)}else if(face instanceof THREE.Face4){face.centroid.add(this.vertices[face.a]);face.centroid.add(this.vertices[face.b]);face.centroid.add(this.vertices[face.c]);face.centroid.add(this.vertices[face.d]);face.centroid.divideScalar(4)}}},computeFaceNormals:function(){var cb=new THREE.Vector3,ab=new THREE.Vector3;for(var f=0,fl=this.faces.length;f<fl;f++){var face=this.faces[f];var vA=this.vertices[face.a];var vB=this.vertices[face.b];var vC=this.vertices[face.c];cb.subVectors(vC,vB);ab.subVectors(vA,vB);cb.cross(ab);cb.normalize();face.normal.copy(cb)}},computeVertexNormals:function(areaWeighted){var v,vl,f,fl,face,vertices;if(this.__tmpVertices===undefined){this.__tmpVertices=new Array(this.vertices.length);vertices=this.__tmpVertices;for(v=0,vl=this.vertices.length;v<vl;v++){vertices[v]=new THREE.Vector3}for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];if(face instanceof THREE.Face3){face.vertexNormals=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3]}else if(face instanceof THREE.Face4){face.vertexNormals=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3]}}}else{vertices=this.__tmpVertices;for(v=0,vl=this.vertices.length;v<vl;v++){vertices[v].set(0,0,0)}}if(areaWeighted){var vA,vB,vC,vD;var cb=new THREE.Vector3,ab=new THREE.Vector3,db=new THREE.Vector3,dc=new THREE.Vector3,bc=new THREE.Vector3;for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];if(face instanceof THREE.Face3){vA=this.vertices[face.a];vB=this.vertices[face.b];vC=this.vertices[face.c];cb.subVectors(vC,vB);ab.subVectors(vA,vB);cb.cross(ab);vertices[face.a].add(cb);vertices[face.b].add(cb);vertices[face.c].add(cb)}else if(face instanceof THREE.Face4){vA=this.vertices[face.a];vB=this.vertices[face.b];vC=this.vertices[face.c];vD=this.vertices[face.d];db.subVectors(vD,vB);ab.subVectors(vA,vB);db.cross(ab);vertices[face.a].add(db);vertices[face.b].add(db);vertices[face.d].add(db);dc.subVectors(vD,vC);bc.subVectors(vB,vC);dc.cross(bc);vertices[face.b].add(dc);vertices[face.c].add(dc);vertices[face.d].add(dc)}}}else{for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];if(face instanceof THREE.Face3){vertices[face.a].add(face.normal);vertices[face.b].add(face.normal);vertices[face.c].add(face.normal)}else if(face instanceof THREE.Face4){vertices[face.a].add(face.normal);vertices[face.b].add(face.normal);vertices[face.c].add(face.normal);vertices[face.d].add(face.normal)}}}for(v=0,vl=this.vertices.length;v<vl;v++){vertices[v].normalize()}for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];if(face instanceof THREE.Face3){face.vertexNormals[0].copy(vertices[face.a]);face.vertexNormals[1].copy(vertices[face.b]);face.vertexNormals[2].copy(vertices[face.c])}else if(face instanceof THREE.Face4){face.vertexNormals[0].copy(vertices[face.a]);face.vertexNormals[1].copy(vertices[face.b]);face.vertexNormals[2].copy(vertices[face.c]);face.vertexNormals[3].copy(vertices[face.d])}}},computeMorphNormals:function(){var i,il,f,fl,face;for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];if(!face.__originalFaceNormal){face.__originalFaceNormal=face.normal.clone()}else{face.__originalFaceNormal.copy(face.normal)}if(!face.__originalVertexNormals)face.__originalVertexNormals=[];for(i=0,il=face.vertexNormals.length;i<il;i++){if(!face.__originalVertexNormals[i]){face.__originalVertexNormals[i]=face.vertexNormals[i].clone()}else{face.__originalVertexNormals[i].copy(face.vertexNormals[i])}}}var tmpGeo=new THREE.Geometry;tmpGeo.faces=this.faces;for(i=0,il=this.morphTargets.length;i<il;i++){if(!this.morphNormals[i]){this.morphNormals[i]={};this.morphNormals[i].faceNormals=[];this.morphNormals[i].vertexNormals=[];var dstNormalsFace=this.morphNormals[i].faceNormals;var dstNormalsVertex=this.morphNormals[i].vertexNormals;var faceNormal,vertexNormals;for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];faceNormal=new THREE.Vector3;if(face instanceof THREE.Face3){vertexNormals={a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3}}else{vertexNormals={a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3,d:new THREE.Vector3}}dstNormalsFace.push(faceNormal);dstNormalsVertex.push(vertexNormals)}}var morphNormals=this.morphNormals[i];tmpGeo.vertices=this.morphTargets[i].vertices;tmpGeo.computeFaceNormals();tmpGeo.computeVertexNormals();var faceNormal,vertexNormals;for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];faceNormal=morphNormals.faceNormals[f];vertexNormals=morphNormals.vertexNormals[f];faceNormal.copy(face.normal);if(face instanceof THREE.Face3){vertexNormals.a.copy(face.vertexNormals[0]);vertexNormals.b.copy(face.vertexNormals[1]);vertexNormals.c.copy(face.vertexNormals[2])}else{vertexNormals.a.copy(face.vertexNormals[0]);vertexNormals.b.copy(face.vertexNormals[1]);vertexNormals.c.copy(face.vertexNormals[2]);vertexNormals.d.copy(face.vertexNormals[3])}}}for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];face.normal=face.__originalFaceNormal;face.vertexNormals=face.__originalVertexNormals}},computeTangents:function(){var f,fl,v,vl,i,il,vertexIndex,face,uv,vA,vB,vC,uvA,uvB,uvC,x1,x2,y1,y2,z1,z2,s1,s2,t1,t2,r,t,test,tan1=[],tan2=[],sdir=new THREE.Vector3,tdir=new THREE.Vector3,tmp=new THREE.Vector3,tmp2=new THREE.Vector3,n=new THREE.Vector3,w;for(v=0,vl=this.vertices.length;v<vl;v++){tan1[v]=new THREE.Vector3;tan2[v]=new THREE.Vector3}function handleTriangle(context,a,b,c,ua,ub,uc){vA=context.vertices[a];vB=context.vertices[b];vC=context.vertices[c];uvA=uv[ua];uvB=uv[ub];uvC=uv[uc];x1=vB.x-vA.x;x2=vC.x-vA.x;y1=vB.y-vA.y;y2=vC.y-vA.y;z1=vB.z-vA.z;z2=vC.z-vA.z;s1=uvB.x-uvA.x;s2=uvC.x-uvA.x;t1=uvB.y-uvA.y;t2=uvC.y-uvA.y;r=1/(s1*t2-s2*t1);sdir.set((t2*x1-t1*x2)*r,(t2*y1-t1*y2)*r,(t2*z1-t1*z2)*r);tdir.set((s1*x2-s2*x1)*r,(s1*y2-s2*y1)*r,(s1*z2-s2*z1)*r);tan1[a].add(sdir);tan1[b].add(sdir);tan1[c].add(sdir);tan2[a].add(tdir);tan2[b].add(tdir);tan2[c].add(tdir)}for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];uv=this.faceVertexUvs[0][f];if(face instanceof THREE.Face3){handleTriangle(this,face.a,face.b,face.c,0,1,2)}else if(face instanceof THREE.Face4){handleTriangle(this,face.a,face.b,face.d,0,1,3);handleTriangle(this,face.b,face.c,face.d,1,2,3)}}var faceIndex=["a","b","c","d"];for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];for(i=0;i<face.vertexNormals.length;i++){n.copy(face.vertexNormals[i]);vertexIndex=face[faceIndex[i]];t=tan1[vertexIndex];tmp.copy(t);tmp.sub(n.multiplyScalar(n.dot(t))).normalize();tmp2.crossVectors(face.vertexNormals[i],t);test=tmp2.dot(tan2[vertexIndex]);w=test<0?-1:1;face.vertexTangents[i]=new THREE.Vector4(tmp.x,tmp.y,tmp.z,w)}}this.hasTangents=true},computeLineDistances:function(){var d=0;var vertices=this.vertices;for(var i=0,il=vertices.length;i<il;i++){if(i>0){d+=vertices[i].distanceTo(vertices[i-1])}this.lineDistances[i]=d}},computeBoundingBox:function(){if(this.boundingBox===null){this.boundingBox=new THREE.Box3}this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){if(this.boundingSphere===null){this.boundingSphere=new THREE.Sphere}this.boundingSphere.setFromCenterAndPoints(this.boundingSphere.center,this.vertices)},mergeVertices:function(){var verticesMap={};var unique=[],changes=[];var v,key;var precisionPoints=4;var precision=Math.pow(10,precisionPoints);var i,il,face;var indices,k,j,jl,u;this.__tmpVertices=undefined;for(i=0,il=this.vertices.length;i<il;i++){v=this.vertices[i];key=Math.round(v.x*precision)+"_"+Math.round(v.y*precision)+"_"+Math.round(v.z*precision);if(verticesMap[key]===undefined){verticesMap[key]=i;unique.push(this.vertices[i]);changes[i]=unique.length-1}else{changes[i]=changes[verticesMap[key]]}}var faceIndicesToRemove=[];for(i=0,il=this.faces.length;i<il;i++){face=this.faces[i];if(face instanceof THREE.Face3){face.a=changes[face.a];face.b=changes[face.b];face.c=changes[face.c];indices=[face.a,face.b,face.c];var dupIndex=-1;for(var n=0;n<3;n++){if(indices[n]==indices[(n+1)%3]){dupIndex=n;faceIndicesToRemove.push(i);break}}}else if(face instanceof THREE.Face4){face.a=changes[face.a];face.b=changes[face.b];face.c=changes[face.c];face.d=changes[face.d];indices=[face.a,face.b,face.c,face.d];var dupIndex=-1;for(var n=0;n<4;n++){if(indices[n]==indices[(n+1)%4]){if(dupIndex>=0){faceIndicesToRemove.push(i)}dupIndex=n}}if(dupIndex>=0){indices.splice(dupIndex,1);var newFace=new THREE.Face3(indices[0],indices[1],indices[2],face.normal,face.color,face.materialIndex);for(j=0,jl=this.faceVertexUvs.length;j<jl;j++){u=this.faceVertexUvs[j][i];if(u){u.splice(dupIndex,1)}}if(face.vertexNormals&&face.vertexNormals.length>0){newFace.vertexNormals=face.vertexNormals;newFace.vertexNormals.splice(dupIndex,1)}if(face.vertexColors&&face.vertexColors.length>0){newFace.vertexColors=face.vertexColors;newFace.vertexColors.splice(dupIndex,1)}this.faces[i]=newFace}}}for(i=faceIndicesToRemove.length-1;i>=0;i--){this.faces.splice(i,1);for(j=0,jl=this.faceVertexUvs.length;j<jl;j++){this.faceVertexUvs[j].splice(i,1)}}var diff=this.vertices.length-unique.length;this.vertices=unique;return diff},clone:function(){var geometry=new THREE.Geometry;var vertices=this.vertices;for(var i=0,il=vertices.length;i<il;i++){geometry.vertices.push(vertices[i].clone())}var faces=this.faces;for(var i=0,il=faces.length;i<il;i++){geometry.faces.push(faces[i].clone())}var uvs=this.faceVertexUvs[0];for(var i=0,il=uvs.length;i<il;i++){var uv=uvs[i],uvCopy=[];for(var j=0,jl=uv.length;j<jl;j++){uvCopy.push(new THREE.Vector2(uv[j].x,uv[j].y))}geometry.faceVertexUvs[0].push(uvCopy)}return geometry},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.GeometryIdCount=0;THREE.BufferGeometry=function(){this.id=THREE.GeometryIdCount++;this.attributes={};this.dynamic=false;this.offsets=[];this.boundingBox=null;this.boundingSphere=null;this.hasTangents=false;this.morphTargets=[]};THREE.BufferGeometry.prototype={constructor:THREE.BufferGeometry,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,applyMatrix:function(matrix){var positionArray;var normalArray;if(this.attributes["position"])positionArray=this.attributes["position"].array;if(this.attributes["normal"])normalArray=this.attributes["normal"].array;if(positionArray!==undefined){matrix.multiplyVector3Array(positionArray);this.verticesNeedUpdate=true}if(normalArray!==undefined){var normalMatrix=(new THREE.Matrix3).getNormalMatrix(matrix);normalMatrix.multiplyVector3Array(normalArray);this.normalizeNormals();this.normalsNeedUpdate=true}},computeBoundingBox:function(){if(this.boundingBox===null){this.boundingBox=new THREE.Box3}var positions=this.attributes["position"].array;if(positions){var bb=this.boundingBox;var x,y,z;if(positions.length>=3){bb.min.x=bb.max.x=positions[0];bb.min.y=bb.max.y=positions[1];bb.min.z=bb.max.z=positions[2]}for(var i=3,il=positions.length;i<il;i+=3){x=positions[i];y=positions[i+1];z=positions[i+2];if(x<bb.min.x){bb.min.x=x}else if(x>bb.max.x){bb.max.x=x}if(y<bb.min.y){bb.min.y=y}else if(y>bb.max.y){bb.max.y=y}if(z<bb.min.z){bb.min.z=z}else if(z>bb.max.z){bb.max.z=z}}}if(positions===undefined||positions.length===0){this.boundingBox.min.set(0,0,0);this.boundingBox.max.set(0,0,0)}},computeBoundingSphere:function(){if(this.boundingSphere===null){this.boundingSphere=new THREE.Sphere}var positions=this.attributes["position"].array;if(positions){var radiusSq,maxRadiusSq=0;var x,y,z;for(var i=0,il=positions.length;i<il;i+=3){x=positions[i];y=positions[i+1];z=positions[i+2];radiusSq=x*x+y*y+z*z;if(radiusSq>maxRadiusSq)maxRadiusSq=radiusSq}this.boundingSphere.radius=Math.sqrt(maxRadiusSq)}},computeVertexNormals:function(){if(this.attributes["position"]){var i,il;var j,jl;var nVertexElements=this.attributes["position"].array.length;if(this.attributes["normal"]===undefined){this.attributes["normal"]={itemSize:3,array:new Float32Array(nVertexElements),numItems:nVertexElements}}else{for(i=0,il=this.attributes["normal"].array.length;i<il;i++){this.attributes["normal"].array[i]=0}}var positions=this.attributes["position"].array;var normals=this.attributes["normal"].array;var vA,vB,vC,x,y,z,pA=new THREE.Vector3,pB=new THREE.Vector3,pC=new THREE.Vector3,cb=new THREE.Vector3,ab=new THREE.Vector3;if(this.attributes["index"]){var indices=this.attributes["index"].array;var offsets=this.offsets;for(j=0,jl=offsets.length;j<jl;++j){var start=offsets[j].start;var count=offsets[j].count;var index=offsets[j].index;for(i=start,il=start+count;i<il;i+=3){vA=index+indices[i];vB=index+indices[i+1];vC=index+indices[i+2];x=positions[vA*3];y=positions[vA*3+1];z=positions[vA*3+2];pA.set(x,y,z);x=positions[vB*3];y=positions[vB*3+1];z=positions[vB*3+2];pB.set(x,y,z);x=positions[vC*3];y=positions[vC*3+1];z=positions[vC*3+2];pC.set(x,y,z);cb.subVectors(pC,pB);ab.subVectors(pA,pB);cb.cross(ab);normals[vA*3]+=cb.x;normals[vA*3+1]+=cb.y;normals[vA*3+2]+=cb.z;normals[vB*3]+=cb.x;normals[vB*3+1]+=cb.y;normals[vB*3+2]+=cb.z;normals[vC*3]+=cb.x;normals[vC*3+1]+=cb.y;normals[vC*3+2]+=cb.z}}}else{for(i=0,il=positions.length;i<il;i+=9){x=positions[i];y=positions[i+1];z=positions[i+2];pA.set(x,y,z);x=positions[i+3];y=positions[i+4];z=positions[i+5];pB.set(x,y,z);x=positions[i+6];y=positions[i+7];z=positions[i+8];pC.set(x,y,z);cb.subVectors(pC,pB);ab.subVectors(pA,pB);cb.cross(ab);normals[i]=cb.x;normals[i+1]=cb.y;normals[i+2]=cb.z;normals[i+3]=cb.x;normals[i+4]=cb.y;normals[i+5]=cb.z;normals[i+6]=cb.x;normals[i+7]=cb.y;normals[i+8]=cb.z}}this.normalizeNormals();this.normalsNeedUpdate=true}},normalizeNormals:function(){var normals=this.attributes["normal"].array;var x,y,z,n;for(var i=0,il=normals.length;i<il;i+=3){x=normals[i];y=normals[i+1];z=normals[i+2];n=1/Math.sqrt(x*x+y*y+z*z);normals[i]*=n;normals[i+1]*=n;normals[i+2]*=n}},computeTangents:function(){if(this.attributes["index"]===undefined||this.attributes["position"]===undefined||this.attributes["normal"]===undefined||this.attributes["uv"]===undefined){console.warn("Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");return}var indices=this.attributes["index"].array;var positions=this.attributes["position"].array;var normals=this.attributes["normal"].array;var uvs=this.attributes["uv"].array;var nVertices=positions.length/3;if(this.attributes["tangent"]===undefined){var nTangentElements=4*nVertices;this.attributes["tangent"]={itemSize:4,array:new Float32Array(nTangentElements),numItems:nTangentElements}}var tangents=this.attributes["tangent"].array;var tan1=[],tan2=[];for(var k=0;k<nVertices;k++){tan1[k]=new THREE.Vector3;tan2[k]=new THREE.Vector3}var xA,yA,zA,xB,yB,zB,xC,yC,zC,uA,vA,uB,vB,uC,vC,x1,x2,y1,y2,z1,z2,s1,s2,t1,t2,r;var sdir=new THREE.Vector3,tdir=new THREE.Vector3;function handleTriangle(a,b,c){xA=positions[a*3];yA=positions[a*3+1];zA=positions[a*3+2];xB=positions[b*3];yB=positions[b*3+1];zB=positions[b*3+2];xC=positions[c*3];yC=positions[c*3+1];zC=positions[c*3+2];uA=uvs[a*2];vA=uvs[a*2+1];uB=uvs[b*2];vB=uvs[b*2+1];uC=uvs[c*2];vC=uvs[c*2+1];x1=xB-xA;x2=xC-xA;y1=yB-yA;y2=yC-yA;z1=zB-zA;z2=zC-zA;s1=uB-uA;s2=uC-uA;t1=vB-vA;t2=vC-vA;r=1/(s1*t2-s2*t1);sdir.set((t2*x1-t1*x2)*r,(t2*y1-t1*y2)*r,(t2*z1-t1*z2)*r);tdir.set((s1*x2-s2*x1)*r,(s1*y2-s2*y1)*r,(s1*z2-s2*z1)*r);tan1[a].add(sdir);tan1[b].add(sdir);tan1[c].add(sdir);tan2[a].add(tdir);tan2[b].add(tdir);tan2[c].add(tdir)}var i,il;var j,jl;var iA,iB,iC;var offsets=this.offsets;for(j=0,jl=offsets.length;j<jl;++j){var start=offsets[j].start;var count=offsets[j].count;var index=offsets[j].index;for(i=start,il=start+count;i<il;i+=3){iA=index+indices[i];iB=index+indices[i+1];iC=index+indices[i+2];handleTriangle(iA,iB,iC)}}var tmp=new THREE.Vector3,tmp2=new THREE.Vector3;var n=new THREE.Vector3,n2=new THREE.Vector3;var w,t,test;function handleVertex(v){n.x=normals[v*3];n.y=normals[v*3+1];n.z=normals[v*3+2];n2.copy(n);t=tan1[v];tmp.copy(t);tmp.sub(n.multiplyScalar(n.dot(t))).normalize();tmp2.crossVectors(n2,t);test=tmp2.dot(tan2[v]);w=test<0?-1:1;tangents[v*4]=tmp.x;tangents[v*4+1]=tmp.y;tangents[v*4+2]=tmp.z;tangents[v*4+3]=w}for(j=0,jl=offsets.length;j<jl;++j){var start=offsets[j].start;var count=offsets[j].count;var index=offsets[j].index;for(i=start,il=start+count;i<il;i+=3){iA=index+indices[i];iB=index+indices[i+1];iC=index+indices[i+2];handleVertex(iA);handleVertex(iB);handleVertex(iC)}}this.hasTangents=true;this.tangentsNeedUpdate=true},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.Camera=function(){THREE.Object3D.call(this);this.matrixWorldInverse=new THREE.Matrix4;this.projectionMatrix=new THREE.Matrix4;this.projectionMatrixInverse=new THREE.Matrix4};THREE.Camera.prototype=Object.create(THREE.Object3D.prototype);THREE.Camera.prototype.lookAt=function(){var m1=new THREE.Matrix4;return function(vector){m1.lookAt(this.position,vector,this.up);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(m1)}else{this.rotation.setEulerFromRotationMatrix(m1,this.eulerOrder)}}}();THREE.OrthographicCamera=function(left,right,top,bottom,near,far){THREE.Camera.call(this);this.left=left;this.right=right;this.top=top;this.bottom=bottom;this.near=near!==undefined?near:.1;this.far=far!==undefined?far:2e3;this.updateProjectionMatrix()};THREE.OrthographicCamera.prototype=Object.create(THREE.Camera.prototype);THREE.OrthographicCamera.prototype.updateProjectionMatrix=function(){this.projectionMatrix.makeOrthographic(this.left,this.right,this.top,this.bottom,this.near,this.far)};THREE.PerspectiveCamera=function(fov,aspect,near,far){THREE.Camera.call(this);this.fov=fov!==undefined?fov:50;this.aspect=aspect!==undefined?aspect:1;this.near=near!==undefined?near:.1;this.far=far!==undefined?far:2e3;this.updateProjectionMatrix()};THREE.PerspectiveCamera.prototype=Object.create(THREE.Camera.prototype);THREE.PerspectiveCamera.prototype.setLens=function(focalLength,frameHeight){if(frameHeight===undefined)frameHeight=24;this.fov=2*THREE.Math.radToDeg(Math.atan(frameHeight/(focalLength*2)));this.updateProjectionMatrix()};THREE.PerspectiveCamera.prototype.setViewOffset=function(fullWidth,fullHeight,x,y,width,height){this.fullWidth=fullWidth;this.fullHeight=fullHeight;this.x=x;this.y=y;this.width=width;this.height=height;this.updateProjectionMatrix()};THREE.PerspectiveCamera.prototype.updateProjectionMatrix=function(){if(this.fullWidth){var aspect=this.fullWidth/this.fullHeight;var top=Math.tan(THREE.Math.degToRad(this.fov*.5))*this.near;var bottom=-top;var left=aspect*bottom;var right=aspect*top;var width=Math.abs(right-left);var height=Math.abs(top-bottom);this.projectionMatrix.makeFrustum(left+this.x*width/this.fullWidth,left+(this.x+this.width)*width/this.fullWidth,top-(this.y+this.height)*height/this.fullHeight,top-this.y*height/this.fullHeight,this.near,this.far)}else{this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far)}};THREE.Light=function(hex){THREE.Object3D.call(this);this.color=new THREE.Color(hex)};THREE.Light.prototype=Object.create(THREE.Object3D.prototype);THREE.Light.prototype.clone=function(light){if(light===undefined)light=new THREE.Light;THREE.Object3D.prototype.clone.call(this,light);light.color.copy(this.color);return light};THREE.AmbientLight=function(hex){THREE.Light.call(this,hex)};THREE.AmbientLight.prototype=Object.create(THREE.Light.prototype);THREE.AmbientLight.prototype.clone=function(){var light=new THREE.AmbientLight;THREE.Light.prototype.clone.call(this,light);return light};THREE.AreaLight=function(hex,intensity){THREE.Light.call(this,hex);this.normal=new THREE.Vector3(0,-1,0);this.right=new THREE.Vector3(1,0,0);this.intensity=intensity!==undefined?intensity:1;this.width=1;this.height=1;this.constantAttenuation=1.5;this.linearAttenuation=.5;this.quadraticAttenuation=.1};THREE.AreaLight.prototype=Object.create(THREE.Light.prototype);THREE.DirectionalLight=function(hex,intensity){THREE.Light.call(this,hex);this.position.set(0,1,0);this.target=new THREE.Object3D;this.intensity=intensity!==undefined?intensity:1;this.castShadow=false;this.onlyShadow=false;this.shadowCameraNear=50;this.shadowCameraFar=5e3;this.shadowCameraLeft=-500;this.shadowCameraRight=500;this.shadowCameraTop=500;this.shadowCameraBottom=-500;this.shadowCameraVisible=false;this.shadowBias=0;this.shadowDarkness=.5;this.shadowMapWidth=512;this.shadowMapHeight=512;this.shadowCascade=false;this.shadowCascadeOffset=new THREE.Vector3(0,0,-1e3);this.shadowCascadeCount=2;this.shadowCascadeBias=[0,0,0];this.shadowCascadeWidth=[512,512,512];this.shadowCascadeHeight=[512,512,512];this.shadowCascadeNearZ=[-1,.99,.998];this.shadowCascadeFarZ=[.99,.998,1];this.shadowCascadeArray=[];this.shadowMap=null;this.shadowMapSize=null;this.shadowCamera=null;this.shadowMatrix=null};THREE.DirectionalLight.prototype=Object.create(THREE.Light.prototype);THREE.DirectionalLight.prototype.clone=function(){var light=new THREE.DirectionalLight;THREE.Light.prototype.clone.call(this,light);light.target=this.target.clone();light.intensity=this.intensity;light.castShadow=this.castShadow;light.onlyShadow=this.onlyShadow;return light};THREE.HemisphereLight=function(skyColorHex,groundColorHex,intensity){THREE.Light.call(this,skyColorHex);this.position.set(0,100,0);this.groundColor=new THREE.Color(groundColorHex);this.intensity=intensity!==undefined?intensity:1};THREE.HemisphereLight.prototype=Object.create(THREE.Light.prototype);THREE.HemisphereLight.prototype.clone=function(){var light=new THREE.PointLight;THREE.Light.prototype.clone.call(this,light);light.groundColor.copy(this.groundColor);light.intensity=this.intensity;return light};THREE.PointLight=function(hex,intensity,distance){THREE.Light.call(this,hex);this.intensity=intensity!==undefined?intensity:1;this.distance=distance!==undefined?distance:0};THREE.PointLight.prototype=Object.create(THREE.Light.prototype);THREE.PointLight.prototype.clone=function(){var light=new THREE.PointLight;THREE.Light.prototype.clone.call(this,light);light.intensity=this.intensity;light.distance=this.distance;return light};THREE.SpotLight=function(hex,intensity,distance,angle,exponent){THREE.Light.call(this,hex);this.position.set(0,1,0);this.target=new THREE.Object3D;this.intensity=intensity!==undefined?intensity:1;this.distance=distance!==undefined?distance:0;this.angle=angle!==undefined?angle:Math.PI/3;this.exponent=exponent!==undefined?exponent:10;this.castShadow=false;this.onlyShadow=false;this.shadowCameraNear=50;this.shadowCameraFar=5e3;this.shadowCameraFov=50;this.shadowCameraVisible=false;this.shadowBias=0;this.shadowDarkness=.5;this.shadowMapWidth=512;this.shadowMapHeight=512;this.shadowMap=null;this.shadowMapSize=null;this.shadowCamera=null;this.shadowMatrix=null};THREE.SpotLight.prototype=Object.create(THREE.Light.prototype);THREE.SpotLight.prototype.clone=function(){var light=new THREE.SpotLight;THREE.Light.prototype.clone.call(this,light);light.target=this.target.clone();light.intensity=this.intensity;light.distance=this.distance;light.angle=this.angle;light.exponent=this.exponent;light.castShadow=this.castShadow;light.onlyShadow=this.onlyShadow;return light};THREE.Loader=function(showStatus){this.showStatus=showStatus;this.statusDomElement=showStatus?THREE.Loader.prototype.addStatusElement():null;this.onLoadStart=function(){};this.onLoadProgress=function(){};this.onLoadComplete=function(){}};THREE.Loader.prototype={constructor:THREE.Loader,crossOrigin:"anonymous",addStatusElement:function(){var e=document.createElement("div");
e.style.position="absolute";e.style.right="0px";e.style.top="0px";e.style.fontSize="0.8em";e.style.textAlign="left";e.style.background="rgba(0,0,0,0.25)";e.style.color="#fff";e.style.width="120px";e.style.padding="0.5em 0.5em 0.5em 0.5em";e.style.zIndex=1e3;e.innerHTML="Loading ...";return e},updateProgress:function(progress){var message="Loaded ";if(progress.total){message+=(100*progress.loaded/progress.total).toFixed(0)+"%"}else{message+=(progress.loaded/1e3).toFixed(2)+" KB"}this.statusDomElement.innerHTML=message},extractUrlBase:function(url){var parts=url.split("/");parts.pop();return(parts.length<1?".":parts.join("/"))+"/"},initMaterials:function(materials,texturePath){var array=[];for(var i=0;i<materials.length;++i){array[i]=THREE.Loader.prototype.createMaterial(materials[i],texturePath)}return array},needsTangents:function(materials){for(var i=0,il=materials.length;i<il;i++){var m=materials[i];if(m instanceof THREE.ShaderMaterial)return true}return false},createMaterial:function(m,texturePath){var _this=this;function is_pow2(n){var l=Math.log(n)/Math.LN2;return Math.floor(l)==l}function nearest_pow2(n){var l=Math.log(n)/Math.LN2;return Math.pow(2,Math.round(l))}function load_image(where,url){var image=new Image;image.onload=function(){if(!is_pow2(this.width)||!is_pow2(this.height)){var width=nearest_pow2(this.width);var height=nearest_pow2(this.height);where.image.width=width;where.image.height=height;where.image.getContext("2d").drawImage(this,0,0,width,height)}else{where.image=this}where.needsUpdate=true};image.crossOrigin=_this.crossOrigin;image.src=url}function create_texture(where,name,sourceFile,repeat,offset,wrap,anisotropy){var isCompressed=/\.dds$/i.test(sourceFile);var fullPath=texturePath+"/"+sourceFile;if(isCompressed){var texture=THREE.ImageUtils.loadCompressedTexture(fullPath);where[name]=texture}else{var texture=document.createElement("canvas");where[name]=new THREE.Texture(texture)}where[name].sourceFile=sourceFile;if(repeat){where[name].repeat.set(repeat[0],repeat[1]);if(repeat[0]!==1)where[name].wrapS=THREE.RepeatWrapping;if(repeat[1]!==1)where[name].wrapT=THREE.RepeatWrapping}if(offset){where[name].offset.set(offset[0],offset[1])}if(wrap){var wrapMap={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};if(wrapMap[wrap[0]]!==undefined)where[name].wrapS=wrapMap[wrap[0]];if(wrapMap[wrap[1]]!==undefined)where[name].wrapT=wrapMap[wrap[1]]}if(anisotropy){where[name].anisotropy=anisotropy}if(!isCompressed){load_image(where[name],fullPath)}}function rgb2hex(rgb){return(rgb[0]*255<<16)+(rgb[1]*255<<8)+rgb[2]*255}var mtype="MeshLambertMaterial";var mpars={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,bumpMap:null,wireframe:false};if(m.shading){var shading=m.shading.toLowerCase();if(shading==="phong")mtype="MeshPhongMaterial";else if(shading==="basic")mtype="MeshBasicMaterial"}if(m.blending!==undefined&&THREE[m.blending]!==undefined){mpars.blending=THREE[m.blending]}if(m.transparent!==undefined||m.opacity<1){mpars.transparent=m.transparent}if(m.depthTest!==undefined){mpars.depthTest=m.depthTest}if(m.depthWrite!==undefined){mpars.depthWrite=m.depthWrite}if(m.visible!==undefined){mpars.visible=m.visible}if(m.flipSided!==undefined){mpars.side=THREE.BackSide}if(m.doubleSided!==undefined){mpars.side=THREE.DoubleSide}if(m.wireframe!==undefined){mpars.wireframe=m.wireframe}if(m.vertexColors!==undefined){if(m.vertexColors==="face"){mpars.vertexColors=THREE.FaceColors}else if(m.vertexColors){mpars.vertexColors=THREE.VertexColors}}if(m.colorDiffuse){mpars.color=rgb2hex(m.colorDiffuse)}else if(m.DbgColor){mpars.color=m.DbgColor}if(m.colorSpecular){mpars.specular=rgb2hex(m.colorSpecular)}if(m.colorAmbient){mpars.ambient=rgb2hex(m.colorAmbient)}if(m.transparency){mpars.opacity=m.transparency}if(m.specularCoef){mpars.shininess=m.specularCoef}if(m.mapDiffuse&&texturePath){create_texture(mpars,"map",m.mapDiffuse,m.mapDiffuseRepeat,m.mapDiffuseOffset,m.mapDiffuseWrap,m.mapDiffuseAnisotropy)}if(m.mapLight&&texturePath){create_texture(mpars,"lightMap",m.mapLight,m.mapLightRepeat,m.mapLightOffset,m.mapLightWrap,m.mapLightAnisotropy)}if(m.mapBump&&texturePath){create_texture(mpars,"bumpMap",m.mapBump,m.mapBumpRepeat,m.mapBumpOffset,m.mapBumpWrap,m.mapBumpAnisotropy)}if(m.mapNormal&&texturePath){create_texture(mpars,"normalMap",m.mapNormal,m.mapNormalRepeat,m.mapNormalOffset,m.mapNormalWrap,m.mapNormalAnisotropy)}if(m.mapSpecular&&texturePath){create_texture(mpars,"specularMap",m.mapSpecular,m.mapSpecularRepeat,m.mapSpecularOffset,m.mapSpecularWrap,m.mapSpecularAnisotropy)}if(m.mapBumpScale){mpars.bumpScale=m.mapBumpScale}if(m.mapNormal){var shader=THREE.ShaderLib["normalmap"];var uniforms=THREE.UniformsUtils.clone(shader.uniforms);uniforms["tNormal"].value=mpars.normalMap;if(m.mapNormalFactor){uniforms["uNormalScale"].value.set(m.mapNormalFactor,m.mapNormalFactor)}if(mpars.map){uniforms["tDiffuse"].value=mpars.map;uniforms["enableDiffuse"].value=true}if(mpars.specularMap){uniforms["tSpecular"].value=mpars.specularMap;uniforms["enableSpecular"].value=true}if(mpars.lightMap){uniforms["tAO"].value=mpars.lightMap;uniforms["enableAO"].value=true}uniforms["uDiffuseColor"].value.setHex(mpars.color);uniforms["uSpecularColor"].value.setHex(mpars.specular);uniforms["uAmbientColor"].value.setHex(mpars.ambient);uniforms["uShininess"].value=mpars.shininess;if(mpars.opacity!==undefined){uniforms["uOpacity"].value=mpars.opacity}var parameters={fragmentShader:shader.fragmentShader,vertexShader:shader.vertexShader,uniforms:uniforms,lights:true,fog:true};var material=new THREE.ShaderMaterial(parameters);if(mpars.transparent){material.transparent=true}}else{var material=new THREE[mtype](mpars)}if(m.DbgName!==undefined)material.name=m.DbgName;return material}};THREE.ImageLoader=function(){this.crossOrigin=null};THREE.ImageLoader.prototype={constructor:THREE.ImageLoader,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,load:function(url,image){var scope=this;if(image===undefined)image=new Image;image.addEventListener("load",function(){scope.dispatchEvent({type:"load",content:image})},false);image.addEventListener("error",function(){scope.dispatchEvent({type:"error",message:"Couldn't load URL ["+url+"]"})},false);if(scope.crossOrigin)image.crossOrigin=scope.crossOrigin;image.src=url}};THREE.JSONLoader=function(showStatus){THREE.Loader.call(this,showStatus);this.withCredentials=false};THREE.JSONLoader.prototype=Object.create(THREE.Loader.prototype);THREE.JSONLoader.prototype.load=function(url,callback,texturePath){var scope=this;texturePath=texturePath&&typeof texturePath==="string"?texturePath:this.extractUrlBase(url);this.onLoadStart();this.loadAjaxJSON(this,url,callback,texturePath)};THREE.JSONLoader.prototype.loadAjaxJSON=function(context,url,callback,texturePath,callbackProgress){var xhr=new XMLHttpRequest;var length=0;xhr.onreadystatechange=function(){if(xhr.readyState===xhr.DONE){if(xhr.status===200||xhr.status===0){if(xhr.responseText){var json=JSON.parse(xhr.responseText);var result=context.parse(json,texturePath);callback(result.geometry,result.materials)}else{console.warn("THREE.JSONLoader: ["+url+"] seems to be unreachable or file there is empty")}context.onLoadComplete()}else{console.error("THREE.JSONLoader: Couldn't load ["+url+"] ["+xhr.status+"]")}}else if(xhr.readyState===xhr.LOADING){if(callbackProgress){if(length===0){length=xhr.getResponseHeader("Content-Length")}callbackProgress({total:length,loaded:xhr.responseText.length})}}else if(xhr.readyState===xhr.HEADERS_RECEIVED){if(callbackProgress!==undefined){length=xhr.getResponseHeader("Content-Length")}}};xhr.open("GET",url,true);xhr.withCredentials=this.withCredentials;xhr.send(null)};THREE.JSONLoader.prototype.parse=function(json,texturePath){var scope=this,geometry=new THREE.Geometry,scale=json.scale!==undefined?1/json.scale:1;parseModel(scale);parseSkin();parseMorphing(scale);geometry.computeCentroids();geometry.computeFaceNormals();function parseModel(scale){function isBitSet(value,position){return value&1<<position}var i,j,fi,offset,zLength,nVertices,colorIndex,normalIndex,uvIndex,materialIndex,type,isQuad,hasMaterial,hasFaceUv,hasFaceVertexUv,hasFaceNormal,hasFaceVertexNormal,hasFaceColor,hasFaceVertexColor,vertex,face,color,normal,uvLayer,uvs,u,v,faces=json.faces,vertices=json.vertices,normals=json.normals,colors=json.colors,nUvLayers=0;for(i=0;i<json.uvs.length;i++){if(json.uvs[i].length)nUvLayers++}for(i=0;i<nUvLayers;i++){geometry.faceUvs[i]=[];geometry.faceVertexUvs[i]=[]}offset=0;zLength=vertices.length;while(offset<zLength){vertex=new THREE.Vector3;vertex.x=vertices[offset++]*scale;vertex.y=vertices[offset++]*scale;vertex.z=vertices[offset++]*scale;geometry.vertices.push(vertex)}offset=0;zLength=faces.length;while(offset<zLength){type=faces[offset++];isQuad=isBitSet(type,0);hasMaterial=isBitSet(type,1);hasFaceUv=isBitSet(type,2);hasFaceVertexUv=isBitSet(type,3);hasFaceNormal=isBitSet(type,4);hasFaceVertexNormal=isBitSet(type,5);hasFaceColor=isBitSet(type,6);hasFaceVertexColor=isBitSet(type,7);if(isQuad){face=new THREE.Face4;face.a=faces[offset++];face.b=faces[offset++];face.c=faces[offset++];face.d=faces[offset++];nVertices=4}else{face=new THREE.Face3;face.a=faces[offset++];face.b=faces[offset++];face.c=faces[offset++];nVertices=3}if(hasMaterial){materialIndex=faces[offset++];face.materialIndex=materialIndex}fi=geometry.faces.length;if(hasFaceUv){for(i=0;i<nUvLayers;i++){uvLayer=json.uvs[i];uvIndex=faces[offset++];u=uvLayer[uvIndex*2];v=uvLayer[uvIndex*2+1];geometry.faceUvs[i][fi]=new THREE.Vector2(u,v)}}if(hasFaceVertexUv){for(i=0;i<nUvLayers;i++){uvLayer=json.uvs[i];uvs=[];for(j=0;j<nVertices;j++){uvIndex=faces[offset++];u=uvLayer[uvIndex*2];v=uvLayer[uvIndex*2+1];uvs[j]=new THREE.Vector2(u,v)}geometry.faceVertexUvs[i][fi]=uvs}}if(hasFaceNormal){normalIndex=faces[offset++]*3;normal=new THREE.Vector3;normal.x=normals[normalIndex++];normal.y=normals[normalIndex++];normal.z=normals[normalIndex];face.normal=normal}if(hasFaceVertexNormal){for(i=0;i<nVertices;i++){normalIndex=faces[offset++]*3;normal=new THREE.Vector3;normal.x=normals[normalIndex++];normal.y=normals[normalIndex++];normal.z=normals[normalIndex];face.vertexNormals.push(normal)}}if(hasFaceColor){colorIndex=faces[offset++];color=new THREE.Color(colors[colorIndex]);face.color=color}if(hasFaceVertexColor){for(i=0;i<nVertices;i++){colorIndex=faces[offset++];color=new THREE.Color(colors[colorIndex]);face.vertexColors.push(color)}}geometry.faces.push(face)}}function parseSkin(){var i,l,x,y,z,w,a,b,c,d;if(json.skinWeights){for(i=0,l=json.skinWeights.length;i<l;i+=2){x=json.skinWeights[i];y=json.skinWeights[i+1];z=0;w=0;geometry.skinWeights.push(new THREE.Vector4(x,y,z,w))}}if(json.skinIndices){for(i=0,l=json.skinIndices.length;i<l;i+=2){a=json.skinIndices[i];b=json.skinIndices[i+1];c=0;d=0;geometry.skinIndices.push(new THREE.Vector4(a,b,c,d))}}geometry.bones=json.bones;geometry.animation=json.animation}function parseMorphing(scale){if(json.morphTargets!==undefined){var i,l,v,vl,dstVertices,srcVertices;for(i=0,l=json.morphTargets.length;i<l;i++){geometry.morphTargets[i]={};geometry.morphTargets[i].name=json.morphTargets[i].name;geometry.morphTargets[i].vertices=[];dstVertices=geometry.morphTargets[i].vertices;srcVertices=json.morphTargets[i].vertices;for(v=0,vl=srcVertices.length;v<vl;v+=3){var vertex=new THREE.Vector3;vertex.x=srcVertices[v]*scale;vertex.y=srcVertices[v+1]*scale;vertex.z=srcVertices[v+2]*scale;dstVertices.push(vertex)}}}if(json.morphColors!==undefined){var i,l,c,cl,dstColors,srcColors,color;for(i=0,l=json.morphColors.length;i<l;i++){geometry.morphColors[i]={};geometry.morphColors[i].name=json.morphColors[i].name;geometry.morphColors[i].colors=[];dstColors=geometry.morphColors[i].colors;srcColors=json.morphColors[i].colors;for(c=0,cl=srcColors.length;c<cl;c+=3){color=new THREE.Color(16755200);color.setRGB(srcColors[c],srcColors[c+1],srcColors[c+2]);dstColors.push(color)}}}}if(json.materials===undefined){return{geometry:geometry}}else{var materials=this.initMaterials(json.materials,texturePath);if(this.needsTangents(materials)){geometry.computeTangents()}return{geometry:geometry,materials:materials}}};THREE.LoadingMonitor=function(){var scope=this;var loaded=0;var total=0;var onLoad=function(event){loaded++;scope.dispatchEvent({type:"progress",loaded:loaded,total:total});if(loaded===total){scope.dispatchEvent({type:"load"})}};this.add=function(loader){total++;loader.addEventListener("load",onLoad,false)}};THREE.LoadingMonitor.prototype={constructor:THREE.LoadingMonitor,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent};THREE.GeometryLoader=function(){};THREE.GeometryLoader.prototype={constructor:THREE.GeometryLoader,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,load:function(url){var scope=this;var request=new XMLHttpRequest;request.addEventListener("load",function(event){var response=scope.parse(JSON.parse(event.target.responseText));scope.dispatchEvent({type:"load",content:response})},false);request.addEventListener("progress",function(event){scope.dispatchEvent({type:"progress",loaded:event.loaded,total:event.total})},false);request.addEventListener("error",function(){scope.dispatchEvent({type:"error",message:"Couldn't load URL ["+url+"]"})},false);request.open("GET",url,true);request.send(null)},parse:function(json){}};THREE.MaterialLoader=function(){};THREE.MaterialLoader.prototype={constructor:THREE.MaterialLoader,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,load:function(url){var scope=this;var request=new XMLHttpRequest;request.addEventListener("load",function(event){var response=scope.parse(JSON.parse(event.target.responseText));scope.dispatchEvent({type:"load",content:response})},false);request.addEventListener("progress",function(event){scope.dispatchEvent({type:"progress",loaded:event.loaded,total:event.total})},false);request.addEventListener("error",function(){scope.dispatchEvent({type:"error",message:"Couldn't load URL ["+url+"]"})},false);request.open("GET",url,true);request.send(null)},parse:function(json){var material;switch(json.type){case"MeshBasicMaterial":material=new THREE.MeshBasicMaterial({color:json.color,opacity:json.opacity,transparent:json.transparent,wireframe:json.wireframe});break;case"MeshLambertMaterial":material=new THREE.MeshLambertMaterial({color:json.color,ambient:json.ambient,emissive:json.emissive,opacity:json.opacity,transparent:json.transparent,wireframe:json.wireframe});break;case"MeshPhongMaterial":material=new THREE.MeshPhongMaterial({color:json.color,ambient:json.ambient,emissive:json.emissive,specular:json.specular,shininess:json.shininess,opacity:json.opacity,transparent:json.transparent,wireframe:json.wireframe});break;case"MeshNormalMaterial":material=new THREE.MeshNormalMaterial({opacity:json.opacity,transparent:json.transparent,wireframe:json.wireframe});break;case"MeshDepthMaterial":material=new THREE.MeshDepthMaterial({opacity:json.opacity,transparent:json.transparent,wireframe:json.wireframe});break}return material}};THREE.SceneLoader=function(){this.onLoadStart=function(){};this.onLoadProgress=function(){};this.onLoadComplete=function(){};this.callbackSync=function(){};this.callbackProgress=function(){};this.geometryHandlerMap={};this.hierarchyHandlerMap={};this.addGeometryHandler("ascii",THREE.JSONLoader)};THREE.SceneLoader.prototype.constructor=THREE.SceneLoader;THREE.SceneLoader.prototype.load=function(url,callbackFinished){var scope=this;var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200||xhr.status===0){var json=JSON.parse(xhr.responseText);scope.parse(json,callbackFinished,url)}else{console.error("THREE.SceneLoader: Couldn't load ["+url+"] ["+xhr.status+"]")}}};xhr.open("GET",url,true);xhr.send(null)};THREE.SceneLoader.prototype.addGeometryHandler=function(typeID,loaderClass){this.geometryHandlerMap[typeID]={loaderClass:loaderClass}};THREE.SceneLoader.prototype.addHierarchyHandler=function(typeID,loaderClass){this.hierarchyHandlerMap[typeID]={loaderClass:loaderClass}};THREE.SceneLoader.prototype.parse=function(json,callbackFinished,url){var scope=this;var urlBase=THREE.Loader.prototype.extractUrlBase(url);var geometry,material,camera,fog,texture,images,color,light,hex,intensity,counter_models,counter_textures,total_models,total_textures,result;var target_array=[];var data=json;for(var typeID in this.geometryHandlerMap){var loaderClass=this.geometryHandlerMap[typeID]["loaderClass"];this.geometryHandlerMap[typeID]["loaderObject"]=new loaderClass}for(var typeID in this.hierarchyHandlerMap){var loaderClass=this.hierarchyHandlerMap[typeID]["loaderClass"];this.hierarchyHandlerMap[typeID]["loaderObject"]=new loaderClass}counter_models=0;counter_textures=0;result={scene:new THREE.Scene,geometries:{},face_materials:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},empties:{},groups:{}};if(data.transform){var position=data.transform.position,rotation=data.transform.rotation,scale=data.transform.scale;if(position){result.scene.position.fromArray(position)}if(rotation){result.scene.rotation.fromArray(rotation)}if(scale){result.scene.scale.fromArray(scale)}if(position||rotation||scale){result.scene.updateMatrix();result.scene.updateMatrixWorld()}}function get_url(source_url,url_type){if(url_type=="relativeToHTML"){return source_url}else{return urlBase+"/"+source_url}}function handle_objects(){handle_children(result.scene,data.objects)}function handle_children(parent,children){var mat,dst,pos,rot,scl,quat;for(var objID in children){var object=result.objects[objID];var objJSON=children[objID];if(object===undefined){if(objJSON.type&&objJSON.type in scope.hierarchyHandlerMap){if(objJSON.loading===undefined){var reservedTypes={type:1,url:1,material:1,position:1,rotation:1,scale:1,visible:1,children:1,userData:1,skin:1,morph:1,mirroredLoop:1,duration:1};var loaderParameters={};for(var parType in objJSON){if(!(parType in reservedTypes)){loaderParameters[parType]=objJSON[parType]}}material=result.materials[objJSON.material];objJSON.loading=true;var loader=scope.hierarchyHandlerMap[objJSON.type]["loaderObject"];if(loader.options){loader.load(get_url(objJSON.url,data.urlBaseType),create_callback_hierachy(objID,parent,material,objJSON))}else{loader.load(get_url(objJSON.url,data.urlBaseType),create_callback_hierachy(objID,parent,material,objJSON),loaderParameters)}}}else if(objJSON.geometry!==undefined){geometry=result.geometries[objJSON.geometry];if(geometry){var needsTangents=false;material=result.materials[objJSON.material];needsTangents=material instanceof THREE.ShaderMaterial;pos=objJSON.position;rot=objJSON.rotation;scl=objJSON.scale;mat=objJSON.matrix;quat=objJSON.quaternion;if(!objJSON.material){material=new THREE.MeshFaceMaterial(result.face_materials[objJSON.geometry])}if(material instanceof THREE.MeshFaceMaterial&&material.materials.length===0){material=new THREE.MeshFaceMaterial(result.face_materials[objJSON.geometry])}if(material instanceof THREE.MeshFaceMaterial){for(var i=0;i<material.materials.length;i++){needsTangents=needsTangents||material.materials[i]instanceof THREE.ShaderMaterial}}if(needsTangents){geometry.computeTangents()}if(objJSON.skin){object=new THREE.SkinnedMesh(geometry,material)}else if(objJSON.morph){object=new THREE.MorphAnimMesh(geometry,material);if(objJSON.duration!==undefined){object.duration=objJSON.duration}if(objJSON.time!==undefined){object.time=objJSON.time}if(objJSON.mirroredLoop!==undefined){object.mirroredLoop=objJSON.mirroredLoop}if(material.morphNormals){geometry.computeMorphNormals()}}else{object=new THREE.Mesh(geometry,material)}object.name=objID;if(mat){object.matrixAutoUpdate=false;object.matrix.set(mat[0],mat[1],mat[2],mat[3],mat[4],mat[5],mat[6],mat[7],mat[8],mat[9],mat[10],mat[11],mat[12],mat[13],mat[14],mat[15])}else{object.position.fromArray(pos);if(quat){object.quaternion.fromArray(quat);object.useQuaternion=true}else{object.rotation.fromArray(rot)}object.scale.fromArray(scl)}object.visible=objJSON.visible;object.castShadow=objJSON.castShadow;object.receiveShadow=objJSON.receiveShadow;parent.add(object);result.objects[objID]=object}}else if(objJSON.type==="DirectionalLight"||objJSON.type==="PointLight"||objJSON.type==="AmbientLight"){hex=objJSON.color!==undefined?objJSON.color:16777215;intensity=objJSON.intensity!==undefined?objJSON.intensity:1;if(objJSON.type==="DirectionalLight"){pos=objJSON.direction;light=new THREE.DirectionalLight(hex,intensity);light.position.fromArray(pos);if(objJSON.target){target_array.push({object:light,targetName:objJSON.target});light.target=null}}else if(objJSON.type==="PointLight"){pos=objJSON.position;dst=objJSON.distance;light=new THREE.PointLight(hex,intensity,dst);light.position.fromArray(pos)}else if(objJSON.type==="AmbientLight"){light=new THREE.AmbientLight(hex)}parent.add(light);light.name=objID;result.lights[objID]=light;result.objects[objID]=light}else if(objJSON.type==="PerspectiveCamera"||objJSON.type==="OrthographicCamera"){pos=objJSON.position;rot=objJSON.rotation;quat=objJSON.quaternion;if(objJSON.type==="PerspectiveCamera"){camera=new THREE.PerspectiveCamera(objJSON.fov,objJSON.aspect,objJSON.near,objJSON.far)}else if(objJSON.type==="OrthographicCamera"){camera=new THREE.OrthographicCamera(objJSON.left,objJSON.right,objJSON.top,objJSON.bottom,objJSON.near,objJSON.far)}camera.name=objID;camera.position.fromArray(pos);if(quat!==undefined){camera.quaternion.fromArray(quat);camera.useQuaternion=true}else if(rot!==undefined){camera.rotation.fromArray(rot)}parent.add(camera);result.cameras[objID]=camera;result.objects[objID]=camera}else{pos=objJSON.position;rot=objJSON.rotation;scl=objJSON.scale;quat=objJSON.quaternion;object=new THREE.Object3D;object.name=objID;object.position.fromArray(pos);if(quat){object.quaternion.fromArray(quat);object.useQuaternion=true}else{object.rotation.fromArray(rot)}object.scale.fromArray(scl);object.visible=objJSON.visible!==undefined?objJSON.visible:false;parent.add(object);result.objects[objID]=object;result.empties[objID]=object}if(object){if(objJSON.userData!==undefined){for(var key in objJSON.userData){var value=objJSON.userData[key];object.userData[key]=value}}if(objJSON.groups!==undefined){for(var i=0;i<objJSON.groups.length;i++){var groupID=objJSON.groups[i];if(result.groups[groupID]===undefined){result.groups[groupID]=[]}result.groups[groupID].push(objID)}}}}if(object!==undefined&&objJSON.children!==undefined){handle_children(object,objJSON.children)}}}function handle_mesh(geo,mat,id){result.geometries[id]=geo;result.face_materials[id]=mat;handle_objects()}function handle_hierarchy(node,id,parent,material,obj){var p=obj.position;var r=obj.rotation;var q=obj.quaternion;var s=obj.scale;node.position.fromArray(p);if(q){node.quaternion.fromArray(q);node.useQuaternion=true}else{node.rotation.fromArray(r)}node.scale.fromArray(s);if(material){node.traverse(function(child){child.material=material})}var visible=obj.visible!==undefined?obj.visible:true;node.traverse(function(child){child.visible=visible});parent.add(node);node.name=id;result.objects[id]=node;handle_objects()}function create_callback_geometry(id){return function(geo,mat){geo.name=id;handle_mesh(geo,mat,id);counter_models-=1;scope.onLoadComplete();async_callback_gate()}}function create_callback_hierachy(id,parent,material,obj){return function(event){var result;if(event.content){result=event.content}else if(event.dae){result=event.scene}else{result=event}handle_hierarchy(result,id,parent,material,obj);counter_models-=1;scope.onLoadComplete();async_callback_gate()}}function create_callback_embed(id){return function(geo,mat){geo.name=id;result.geometries[id]=geo;result.face_materials[id]=mat}}function async_callback_gate(){var progress={totalModels:total_models,totalTextures:total_textures,loadedModels:total_models-counter_models,loadedTextures:total_textures-counter_textures};scope.callbackProgress(progress,result);scope.onLoadProgress();if(counter_models===0&&counter_textures===0){finalize();callbackFinished(result)}}function finalize(){for(var i=0;i<target_array.length;i++){var ta=target_array[i];var target=result.objects[ta.targetName];if(target){ta.object.target=target}else{ta.object.target=new THREE.Object3D;result.scene.add(ta.object.target)}ta.object.target.userData.targetInverse=ta.object}}var callbackTexture=function(count){counter_textures-=count;async_callback_gate();scope.onLoadComplete()};var generateTextureCallback=function(count){return function(){callbackTexture(count)}};function traverse_json_hierarchy(objJSON,callback){callback(objJSON);if(objJSON.children!==undefined){for(var objChildID in objJSON.children){traverse_json_hierarchy(objJSON.children[objChildID],callback)}}}var fogID,fogJSON;for(fogID in data.fogs){fogJSON=data.fogs[fogID];if(fogJSON.type==="linear"){fog=new THREE.Fog(0,fogJSON.near,fogJSON.far)}else if(fogJSON.type==="exp2"){fog=new THREE.FogExp2(0,fogJSON.density)}color=fogJSON.color;fog.color.setRGB(color[0],color[1],color[2]);result.fogs[fogID]=fog}var geoID,geoJSON;for(geoID in data.geometries){geoJSON=data.geometries[geoID];if(geoJSON.type in this.geometryHandlerMap){counter_models+=1;scope.onLoadStart()}}for(var objID in data.objects){traverse_json_hierarchy(data.objects[objID],function(objJSON){if(objJSON.type&&objJSON.type in scope.hierarchyHandlerMap){counter_models+=1;scope.onLoadStart()}})}total_models=counter_models;for(geoID in data.geometries){geoJSON=data.geometries[geoID];if(geoJSON.type==="cube"){geometry=new THREE.CubeGeometry(geoJSON.width,geoJSON.height,geoJSON.depth,geoJSON.widthSegments,geoJSON.heightSegments,geoJSON.depthSegments);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="plane"){geometry=new THREE.PlaneGeometry(geoJSON.width,geoJSON.height,geoJSON.widthSegments,geoJSON.heightSegments);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="sphere"){geometry=new THREE.SphereGeometry(geoJSON.radius,geoJSON.widthSegments,geoJSON.heightSegments);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="cylinder"){geometry=new THREE.CylinderGeometry(geoJSON.topRad,geoJSON.botRad,geoJSON.height,geoJSON.radSegs,geoJSON.heightSegs);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="torus"){geometry=new THREE.TorusGeometry(geoJSON.radius,geoJSON.tube,geoJSON.segmentsR,geoJSON.segmentsT);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="icosahedron"){geometry=new THREE.IcosahedronGeometry(geoJSON.radius,geoJSON.subdivisions);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type in this.geometryHandlerMap){var loaderParameters={};for(var parType in geoJSON){if(parType!=="type"&&parType!=="url"){loaderParameters[parType]=geoJSON[parType]}}var loader=this.geometryHandlerMap[geoJSON.type]["loaderObject"];loader.load(get_url(geoJSON.url,data.urlBaseType),create_callback_geometry(geoID),loaderParameters)}else if(geoJSON.type==="embedded"){var modelJson=data.embeds[geoJSON.id],texture_path="";modelJson.metadata=data.metadata;if(modelJson){var jsonLoader=this.geometryHandlerMap["ascii"]["loaderObject"];var model=jsonLoader.parse(modelJson,texture_path);create_callback_embed(geoID)(model.geometry,model.materials)}}}var textureID,textureJSON;for(textureID in data.textures){textureJSON=data.textures[textureID];if(textureJSON.url instanceof Array){counter_textures+=textureJSON.url.length;for(var n=0;n<textureJSON.url.length;n++){scope.onLoadStart()}}else{counter_textures+=1;scope.onLoadStart()}}total_textures=counter_textures;for(textureID in data.textures){textureJSON=data.textures[textureID];if(textureJSON.mapping!==undefined&&THREE[textureJSON.mapping]!==undefined){textureJSON.mapping=new THREE[textureJSON.mapping]}if(textureJSON.url instanceof Array){var count=textureJSON.url.length;var url_array=[];for(var i=0;i<count;i++){url_array[i]=get_url(textureJSON.url[i],data.urlBaseType)}var isCompressed=/\.dds$/i.test(url_array[0]);if(isCompressed){texture=THREE.ImageUtils.loadCompressedTextureCube(url_array,textureJSON.mapping,generateTextureCallback(count))}else{texture=THREE.ImageUtils.loadTextureCube(url_array,textureJSON.mapping,generateTextureCallback(count))}}else{var isCompressed=/\.dds$/i.test(textureJSON.url);var fullUrl=get_url(textureJSON.url,data.urlBaseType);var textureCallback=generateTextureCallback(1);if(isCompressed){texture=THREE.ImageUtils.loadCompressedTexture(fullUrl,textureJSON.mapping,textureCallback)}else{texture=THREE.ImageUtils.loadTexture(fullUrl,textureJSON.mapping,textureCallback)}if(THREE[textureJSON.minFilter]!==undefined)texture.minFilter=THREE[textureJSON.minFilter];if(THREE[textureJSON.magFilter]!==undefined)texture.magFilter=THREE[textureJSON.magFilter];if(textureJSON.anisotropy)texture.anisotropy=textureJSON.anisotropy;if(textureJSON.repeat){texture.repeat.set(textureJSON.repeat[0],textureJSON.repeat[1]);if(textureJSON.repeat[0]!==1)texture.wrapS=THREE.RepeatWrapping;if(textureJSON.repeat[1]!==1)texture.wrapT=THREE.RepeatWrapping}if(textureJSON.offset){texture.offset.set(textureJSON.offset[0],textureJSON.offset[1])}if(textureJSON.wrap){var wrapMap={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};if(wrapMap[textureJSON.wrap[0]]!==undefined)texture.wrapS=wrapMap[textureJSON.wrap[0]];if(wrapMap[textureJSON.wrap[1]]!==undefined)texture.wrapT=wrapMap[textureJSON.wrap[1]]}}result.textures[textureID]=texture}var matID,matJSON;var parID;for(matID in data.materials){matJSON=data.materials[matID];for(parID in matJSON.parameters){if(parID==="envMap"||parID==="map"||parID==="lightMap"||parID==="bumpMap"){matJSON.parameters[parID]=result.textures[matJSON.parameters[parID]]}else if(parID==="shading"){matJSON.parameters[parID]=matJSON.parameters[parID]==="flat"?THREE.FlatShading:THREE.SmoothShading}else if(parID==="side"){if(matJSON.parameters[parID]=="double"){matJSON.parameters[parID]=THREE.DoubleSide}else if(matJSON.parameters[parID]=="back"){matJSON.parameters[parID]=THREE.BackSide}else{matJSON.parameters[parID]=THREE.FrontSide}}else if(parID==="blending"){matJSON.parameters[parID]=matJSON.parameters[parID]in THREE?THREE[matJSON.parameters[parID]]:THREE.NormalBlending}else if(parID==="combine"){matJSON.parameters[parID]=matJSON.parameters[parID]in THREE?THREE[matJSON.parameters[parID]]:THREE.MultiplyOperation}else if(parID==="vertexColors"){if(matJSON.parameters[parID]=="face"){matJSON.parameters[parID]=THREE.FaceColors}else if(matJSON.parameters[parID]){matJSON.parameters[parID]=THREE.VertexColors}}else if(parID==="wrapRGB"){var v3=matJSON.parameters[parID];matJSON.parameters[parID]=new THREE.Vector3(v3[0],v3[1],v3[2])}}if(matJSON.parameters.opacity!==undefined&&matJSON.parameters.opacity<1){matJSON.parameters.transparent=true}if(matJSON.parameters.normalMap){var shader=THREE.ShaderLib["normalmap"];var uniforms=THREE.UniformsUtils.clone(shader.uniforms);var diffuse=matJSON.parameters.color;var specular=matJSON.parameters.specular;var ambient=matJSON.parameters.ambient;var shininess=matJSON.parameters.shininess;uniforms["tNormal"].value=result.textures[matJSON.parameters.normalMap];
if(matJSON.parameters.normalScale){uniforms["uNormalScale"].value.set(matJSON.parameters.normalScale[0],matJSON.parameters.normalScale[1])}if(matJSON.parameters.map){uniforms["tDiffuse"].value=matJSON.parameters.map;uniforms["enableDiffuse"].value=true}if(matJSON.parameters.envMap){uniforms["tCube"].value=matJSON.parameters.envMap;uniforms["enableReflection"].value=true;uniforms["uReflectivity"].value=matJSON.parameters.reflectivity}if(matJSON.parameters.lightMap){uniforms["tAO"].value=matJSON.parameters.lightMap;uniforms["enableAO"].value=true}if(matJSON.parameters.specularMap){uniforms["tSpecular"].value=result.textures[matJSON.parameters.specularMap];uniforms["enableSpecular"].value=true}if(matJSON.parameters.displacementMap){uniforms["tDisplacement"].value=result.textures[matJSON.parameters.displacementMap];uniforms["enableDisplacement"].value=true;uniforms["uDisplacementBias"].value=matJSON.parameters.displacementBias;uniforms["uDisplacementScale"].value=matJSON.parameters.displacementScale}uniforms["uDiffuseColor"].value.setHex(diffuse);uniforms["uSpecularColor"].value.setHex(specular);uniforms["uAmbientColor"].value.setHex(ambient);uniforms["uShininess"].value=shininess;if(matJSON.parameters.opacity){uniforms["uOpacity"].value=matJSON.parameters.opacity}var parameters={fragmentShader:shader.fragmentShader,vertexShader:shader.vertexShader,uniforms:uniforms,lights:true,fog:true};material=new THREE.ShaderMaterial(parameters)}else{material=new THREE[matJSON.type](matJSON.parameters)}material.name=matID;result.materials[matID]=material}for(matID in data.materials){matJSON=data.materials[matID];if(matJSON.parameters.materials){var materialArray=[];for(var i=0;i<matJSON.parameters.materials.length;i++){var label=matJSON.parameters.materials[i];materialArray.push(result.materials[label])}result.materials[matID].materials=materialArray}}handle_objects();if(result.cameras&&data.defaults.camera){result.currentCamera=result.cameras[data.defaults.camera]}if(result.fogs&&data.defaults.fog){result.scene.fog=result.fogs[data.defaults.fog]}scope.callbackSync(result);async_callback_gate()};THREE.TextureLoader=function(){this.crossOrigin=null};THREE.TextureLoader.prototype={constructor:THREE.TextureLoader,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,load:function(url){var scope=this;var image=new Image;image.addEventListener("load",function(){var texture=new THREE.Texture(image);texture.needsUpdate=true;scope.dispatchEvent({type:"load",content:texture})},false);image.addEventListener("error",function(){scope.dispatchEvent({type:"error",message:"Couldn't load URL ["+url+"]"})},false);if(scope.crossOrigin)image.crossOrigin=scope.crossOrigin;image.src=url}};THREE.Material=function(){this.id=THREE.MaterialIdCount++;this.name="";this.side=THREE.FrontSide;this.opacity=1;this.transparent=false;this.blending=THREE.NormalBlending;this.blendSrc=THREE.SrcAlphaFactor;this.blendDst=THREE.OneMinusSrcAlphaFactor;this.blendEquation=THREE.AddEquation;this.depthTest=true;this.depthWrite=true;this.polygonOffset=false;this.polygonOffsetFactor=0;this.polygonOffsetUnits=0;this.alphaTest=0;this.overdraw=0;this.visible=true;this.needsUpdate=true};THREE.Material.prototype={constructor:THREE.Material,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,setValues:function(values){if(values===undefined)return;for(var key in values){var newValue=values[key];if(newValue===undefined){console.warn("THREE.Material: '"+key+"' parameter is undefined.");continue}if(key in this){var currentValue=this[key];if(currentValue instanceof THREE.Color){currentValue.set(newValue)}else if(currentValue instanceof THREE.Vector3&&newValue instanceof THREE.Vector3){currentValue.copy(newValue)}else if(key=="overdraw"){this[key]=Number(newValue)}else{this[key]=newValue}}}},clone:function(material){if(material===undefined)material=new THREE.Material;material.name=this.name;material.side=this.side;material.opacity=this.opacity;material.transparent=this.transparent;material.blending=this.blending;material.blendSrc=this.blendSrc;material.blendDst=this.blendDst;material.blendEquation=this.blendEquation;material.depthTest=this.depthTest;material.depthWrite=this.depthWrite;material.polygonOffset=this.polygonOffset;material.polygonOffsetFactor=this.polygonOffsetFactor;material.polygonOffsetUnits=this.polygonOffsetUnits;material.alphaTest=this.alphaTest;material.overdraw=this.overdraw;material.visible=this.visible;return material},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.MaterialIdCount=0;THREE.LineBasicMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.linewidth=1;this.linecap="round";this.linejoin="round";this.vertexColors=false;this.fog=true;this.setValues(parameters)};THREE.LineBasicMaterial.prototype=Object.create(THREE.Material.prototype);THREE.LineBasicMaterial.prototype.clone=function(){var material=new THREE.LineBasicMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.linewidth=this.linewidth;material.linecap=this.linecap;material.linejoin=this.linejoin;material.vertexColors=this.vertexColors;material.fog=this.fog;return material};THREE.LineDashedMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.linewidth=1;this.scale=1;this.dashSize=3;this.gapSize=1;this.vertexColors=false;this.fog=true;this.setValues(parameters)};THREE.LineDashedMaterial.prototype=Object.create(THREE.Material.prototype);THREE.LineDashedMaterial.prototype.clone=function(){var material=new THREE.LineDashedMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.linewidth=this.linewidth;material.scale=this.scale;material.dashSize=this.dashSize;material.gapSize=this.gapSize;material.vertexColors=this.vertexColors;material.fog=this.fog;return material};THREE.MeshBasicMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.map=null;this.lightMap=null;this.specularMap=null;this.envMap=null;this.combine=THREE.MultiplyOperation;this.reflectivity=1;this.refractionRatio=.98;this.fog=true;this.shading=THREE.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=THREE.NoColors;this.skinning=false;this.morphTargets=false;this.setValues(parameters)};THREE.MeshBasicMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshBasicMaterial.prototype.clone=function(){var material=new THREE.MeshBasicMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.map=this.map;material.lightMap=this.lightMap;material.specularMap=this.specularMap;material.envMap=this.envMap;material.combine=this.combine;material.reflectivity=this.reflectivity;material.refractionRatio=this.refractionRatio;material.fog=this.fog;material.shading=this.shading;material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;material.wireframeLinecap=this.wireframeLinecap;material.wireframeLinejoin=this.wireframeLinejoin;material.vertexColors=this.vertexColors;material.skinning=this.skinning;material.morphTargets=this.morphTargets;return material};THREE.MeshLambertMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.ambient=new THREE.Color(16777215);this.emissive=new THREE.Color(0);this.wrapAround=false;this.wrapRGB=new THREE.Vector3(1,1,1);this.map=null;this.lightMap=null;this.specularMap=null;this.envMap=null;this.combine=THREE.MultiplyOperation;this.reflectivity=1;this.refractionRatio=.98;this.fog=true;this.shading=THREE.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=THREE.NoColors;this.skinning=false;this.morphTargets=false;this.morphNormals=false;this.setValues(parameters)};THREE.MeshLambertMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshLambertMaterial.prototype.clone=function(){var material=new THREE.MeshLambertMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.ambient.copy(this.ambient);material.emissive.copy(this.emissive);material.wrapAround=this.wrapAround;material.wrapRGB.copy(this.wrapRGB);material.map=this.map;material.lightMap=this.lightMap;material.specularMap=this.specularMap;material.envMap=this.envMap;material.combine=this.combine;material.reflectivity=this.reflectivity;material.refractionRatio=this.refractionRatio;material.fog=this.fog;material.shading=this.shading;material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;material.wireframeLinecap=this.wireframeLinecap;material.wireframeLinejoin=this.wireframeLinejoin;material.vertexColors=this.vertexColors;material.skinning=this.skinning;material.morphTargets=this.morphTargets;material.morphNormals=this.morphNormals;return material};THREE.MeshPhongMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.ambient=new THREE.Color(16777215);this.emissive=new THREE.Color(0);this.specular=new THREE.Color(1118481);this.shininess=30;this.metal=false;this.perPixel=true;this.wrapAround=false;this.wrapRGB=new THREE.Vector3(1,1,1);this.map=null;this.lightMap=null;this.bumpMap=null;this.bumpScale=1;this.normalMap=null;this.normalScale=new THREE.Vector2(1,1);this.specularMap=null;this.envMap=null;this.combine=THREE.MultiplyOperation;this.reflectivity=1;this.refractionRatio=.98;this.fog=true;this.shading=THREE.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=THREE.NoColors;this.skinning=false;this.morphTargets=false;this.morphNormals=false;this.setValues(parameters)};THREE.MeshPhongMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshPhongMaterial.prototype.clone=function(){var material=new THREE.MeshPhongMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.ambient.copy(this.ambient);material.emissive.copy(this.emissive);material.specular.copy(this.specular);material.shininess=this.shininess;material.metal=this.metal;material.perPixel=this.perPixel;material.wrapAround=this.wrapAround;material.wrapRGB.copy(this.wrapRGB);material.map=this.map;material.lightMap=this.lightMap;material.bumpMap=this.bumpMap;material.bumpScale=this.bumpScale;material.normalMap=this.normalMap;material.normalScale.copy(this.normalScale);material.specularMap=this.specularMap;material.envMap=this.envMap;material.combine=this.combine;material.reflectivity=this.reflectivity;material.refractionRatio=this.refractionRatio;material.fog=this.fog;material.shading=this.shading;material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;material.wireframeLinecap=this.wireframeLinecap;material.wireframeLinejoin=this.wireframeLinejoin;material.vertexColors=this.vertexColors;material.skinning=this.skinning;material.morphTargets=this.morphTargets;material.morphNormals=this.morphNormals;return material};THREE.MeshDepthMaterial=function(parameters){THREE.Material.call(this);this.wireframe=false;this.wireframeLinewidth=1;this.setValues(parameters)};THREE.MeshDepthMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshDepthMaterial.prototype.clone=function(){var material=new THREE.MeshDepthMaterial;THREE.Material.prototype.clone.call(this,material);material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;return material};THREE.MeshNormalMaterial=function(parameters){THREE.Material.call(this,parameters);this.shading=THREE.FlatShading;this.wireframe=false;this.wireframeLinewidth=1;this.morphTargets=false;this.setValues(parameters)};THREE.MeshNormalMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshNormalMaterial.prototype.clone=function(){var material=new THREE.MeshNormalMaterial;THREE.Material.prototype.clone.call(this,material);material.shading=this.shading;material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;return material};THREE.MeshFaceMaterial=function(materials){this.materials=materials instanceof Array?materials:[]};THREE.MeshFaceMaterial.prototype.clone=function(){return new THREE.MeshFaceMaterial(this.materials.slice(0))};THREE.ParticleBasicMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.map=null;this.size=1;this.sizeAttenuation=true;this.vertexColors=false;this.fog=true;this.setValues(parameters)};THREE.ParticleBasicMaterial.prototype=Object.create(THREE.Material.prototype);THREE.ParticleBasicMaterial.prototype.clone=function(){var material=new THREE.ParticleBasicMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.map=this.map;material.size=this.size;material.sizeAttenuation=this.sizeAttenuation;material.vertexColors=this.vertexColors;material.fog=this.fog;return material};THREE.ParticleCanvasMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.program=function(context,color){};this.setValues(parameters)};THREE.ParticleCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.ParticleCanvasMaterial.prototype.clone=function(){var material=new THREE.ParticleCanvasMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.program=this.program;return material};THREE.ShaderMaterial=function(parameters){THREE.Material.call(this);this.fragmentShader="void main() {}";this.vertexShader="void main() {}";this.uniforms={};this.defines={};this.attributes=null;this.shading=THREE.SmoothShading;this.linewidth=1;this.wireframe=false;this.wireframeLinewidth=1;this.fog=false;this.lights=false;this.vertexColors=THREE.NoColors;this.skinning=false;this.morphTargets=false;this.morphNormals=false;this.setValues(parameters)};THREE.ShaderMaterial.prototype=Object.create(THREE.Material.prototype);THREE.ShaderMaterial.prototype.clone=function(){var material=new THREE.ShaderMaterial;THREE.Material.prototype.clone.call(this,material);material.fragmentShader=this.fragmentShader;material.vertexShader=this.vertexShader;material.uniforms=THREE.UniformsUtils.clone(this.uniforms);material.attributes=this.attributes;material.defines=this.defines;material.shading=this.shading;material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;material.fog=this.fog;material.lights=this.lights;material.vertexColors=this.vertexColors;material.skinning=this.skinning;material.morphTargets=this.morphTargets;material.morphNormals=this.morphNormals;return material};THREE.SpriteMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.map=new THREE.Texture;this.useScreenCoordinates=true;this.depthTest=!this.useScreenCoordinates;this.sizeAttenuation=!this.useScreenCoordinates;this.scaleByViewport=!this.sizeAttenuation;this.alignment=THREE.SpriteAlignment.center.clone();this.fog=false;this.uvOffset=new THREE.Vector2(0,0);this.uvScale=new THREE.Vector2(1,1);this.setValues(parameters);parameters=parameters||{};if(parameters.depthTest===undefined)this.depthTest=!this.useScreenCoordinates;if(parameters.sizeAttenuation===undefined)this.sizeAttenuation=!this.useScreenCoordinates;if(parameters.scaleByViewport===undefined)this.scaleByViewport=!this.sizeAttenuation};THREE.SpriteMaterial.prototype=Object.create(THREE.Material.prototype);THREE.SpriteMaterial.prototype.clone=function(){var material=new THREE.SpriteMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.map=this.map;material.useScreenCoordinates=this.useScreenCoordinates;material.sizeAttenuation=this.sizeAttenuation;material.scaleByViewport=this.scaleByViewport;material.alignment.copy(this.alignment);material.uvOffset.copy(this.uvOffset);material.uvScale.copy(this.uvScale);material.fog=this.fog;return material};THREE.SpriteAlignment={};THREE.SpriteAlignment.topLeft=new THREE.Vector2(1,-1);THREE.SpriteAlignment.topCenter=new THREE.Vector2(0,-1);THREE.SpriteAlignment.topRight=new THREE.Vector2(-1,-1);THREE.SpriteAlignment.centerLeft=new THREE.Vector2(1,0);THREE.SpriteAlignment.center=new THREE.Vector2(0,0);THREE.SpriteAlignment.centerRight=new THREE.Vector2(-1,0);THREE.SpriteAlignment.bottomLeft=new THREE.Vector2(1,1);THREE.SpriteAlignment.bottomCenter=new THREE.Vector2(0,1);THREE.SpriteAlignment.bottomRight=new THREE.Vector2(-1,1);THREE.Texture=function(image,mapping,wrapS,wrapT,magFilter,minFilter,format,type,anisotropy){this.id=THREE.TextureIdCount++;this.name="";this.image=image;this.mipmaps=[];this.mapping=mapping!==undefined?mapping:new THREE.UVMapping;this.wrapS=wrapS!==undefined?wrapS:THREE.ClampToEdgeWrapping;this.wrapT=wrapT!==undefined?wrapT:THREE.ClampToEdgeWrapping;this.magFilter=magFilter!==undefined?magFilter:THREE.LinearFilter;this.minFilter=minFilter!==undefined?minFilter:THREE.LinearMipMapLinearFilter;this.anisotropy=anisotropy!==undefined?anisotropy:1;this.format=format!==undefined?format:THREE.RGBAFormat;this.type=type!==undefined?type:THREE.UnsignedByteType;this.offset=new THREE.Vector2(0,0);this.repeat=new THREE.Vector2(1,1);this.generateMipmaps=true;this.premultiplyAlpha=false;this.flipY=true;this.unpackAlignment=4;this.needsUpdate=false;this.onUpdate=null};THREE.Texture.prototype={constructor:THREE.Texture,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,clone:function(texture){if(texture===undefined)texture=new THREE.Texture;texture.image=this.image;texture.mipmaps=this.mipmaps.slice(0);texture.mapping=this.mapping;texture.wrapS=this.wrapS;texture.wrapT=this.wrapT;texture.magFilter=this.magFilter;texture.minFilter=this.minFilter;texture.anisotropy=this.anisotropy;texture.format=this.format;texture.type=this.type;texture.offset.copy(this.offset);texture.repeat.copy(this.repeat);texture.generateMipmaps=this.generateMipmaps;texture.premultiplyAlpha=this.premultiplyAlpha;texture.flipY=this.flipY;texture.unpackAlignment=this.unpackAlignment;return texture},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.TextureIdCount=0;THREE.CompressedTexture=function(mipmaps,width,height,format,type,mapping,wrapS,wrapT,magFilter,minFilter,anisotropy){THREE.Texture.call(this,null,mapping,wrapS,wrapT,magFilter,minFilter,format,type,anisotropy);this.image={width:width,height:height};this.mipmaps=mipmaps;this.generateMipmaps=false};THREE.CompressedTexture.prototype=Object.create(THREE.Texture.prototype);THREE.CompressedTexture.prototype.clone=function(){var texture=new THREE.CompressedTexture;THREE.Texture.prototype.clone.call(this,texture);return texture};THREE.DataTexture=function(data,width,height,format,type,mapping,wrapS,wrapT,magFilter,minFilter,anisotropy){THREE.Texture.call(this,null,mapping,wrapS,wrapT,magFilter,minFilter,format,type,anisotropy);this.image={data:data,width:width,height:height}};THREE.DataTexture.prototype=Object.create(THREE.Texture.prototype);THREE.DataTexture.prototype.clone=function(){var texture=new THREE.DataTexture;THREE.Texture.prototype.clone.call(this,texture);return texture};THREE.Particle=function(material){THREE.Object3D.call(this);this.material=material};THREE.Particle.prototype=Object.create(THREE.Object3D.prototype);THREE.Particle.prototype.clone=function(object){if(object===undefined)object=new THREE.Particle(this.material);THREE.Object3D.prototype.clone.call(this,object);return object};THREE.ParticleSystem=function(geometry,material){THREE.Object3D.call(this);this.geometry=geometry;this.material=material!==undefined?material:new THREE.ParticleBasicMaterial({color:Math.random()*16777215});this.sortParticles=false;if(this.geometry){if(this.geometry.boundingSphere===null){this.geometry.computeBoundingSphere()}}this.frustumCulled=false};THREE.ParticleSystem.prototype=Object.create(THREE.Object3D.prototype);THREE.ParticleSystem.prototype.clone=function(object){if(object===undefined)object=new THREE.ParticleSystem(this.geometry,this.material);object.sortParticles=this.sortParticles;THREE.Object3D.prototype.clone.call(this,object);return object};THREE.Line=function(geometry,material,type){THREE.Object3D.call(this);this.geometry=geometry;this.material=material!==undefined?material:new THREE.LineBasicMaterial({color:Math.random()*16777215});this.type=type!==undefined?type:THREE.LineStrip;if(this.geometry){if(!this.geometry.boundingSphere){this.geometry.computeBoundingSphere()}}};THREE.LineStrip=0;THREE.LinePieces=1;THREE.Line.prototype=Object.create(THREE.Object3D.prototype);THREE.Line.prototype.clone=function(object){if(object===undefined)object=new THREE.Line(this.geometry,this.material,this.type);THREE.Object3D.prototype.clone.call(this,object);return object};THREE.Mesh=function(geometry,material){THREE.Object3D.call(this);this.geometry=null;this.material=null;this.setGeometry(geometry);this.setMaterial(material)};THREE.Mesh.prototype=Object.create(THREE.Object3D.prototype);THREE.Mesh.prototype.setGeometry=function(geometry){if(geometry!==undefined){this.geometry=geometry;if(this.geometry.boundingSphere===null){this.geometry.computeBoundingSphere()}this.updateMorphTargets()}};THREE.Mesh.prototype.setMaterial=function(material){if(material!==undefined){this.material=material}else{this.material=new THREE.MeshBasicMaterial({color:Math.random()*16777215,wireframe:true})}};THREE.Mesh.prototype.updateMorphTargets=function(){if(this.geometry.morphTargets.length>0){this.morphTargetBase=-1;this.morphTargetForcedOrder=[];this.morphTargetInfluences=[];this.morphTargetDictionary={};for(var m=0,ml=this.geometry.morphTargets.length;m<ml;m++){this.morphTargetInfluences.push(0);this.morphTargetDictionary[this.geometry.morphTargets[m].name]=m}}};THREE.Mesh.prototype.getMorphTargetIndexByName=function(name){if(this.morphTargetDictionary[name]!==undefined){return this.morphTargetDictionary[name]}console.log("THREE.Mesh.getMorphTargetIndexByName: morph target "+name+" does not exist. Returning 0.");return 0};THREE.Mesh.prototype.clone=function(object){if(object===undefined)object=new THREE.Mesh(this.geometry,this.material);THREE.Object3D.prototype.clone.call(this,object);return object};THREE.Bone=function(belongsToSkin){THREE.Object3D.call(this);this.skin=belongsToSkin;this.skinMatrix=new THREE.Matrix4};THREE.Bone.prototype=Object.create(THREE.Object3D.prototype);THREE.Bone.prototype.update=function(parentSkinMatrix,forceUpdate){if(this.matrixAutoUpdate){forceUpdate|=this.updateMatrix()}if(forceUpdate||this.matrixWorldNeedsUpdate){if(parentSkinMatrix){this.skinMatrix.multiplyMatrices(parentSkinMatrix,this.matrix)}else{this.skinMatrix.copy(this.matrix)}this.matrixWorldNeedsUpdate=false;forceUpdate=true}var child,i,l=this.children.length;for(i=0;i<l;i++){this.children[i].update(this.skinMatrix,forceUpdate)}};THREE.SkinnedMesh=function(geometry,material,useVertexTexture){THREE.Mesh.call(this,geometry,material);this.useVertexTexture=useVertexTexture!==undefined?useVertexTexture:true;this.identityMatrix=new THREE.Matrix4;this.bones=[];this.boneMatrices=[];var b,bone,gbone,p,q,s;if(this.geometry&&this.geometry.bones!==undefined){for(b=0;b<this.geometry.bones.length;b++){gbone=this.geometry.bones[b];p=gbone.pos;q=gbone.rotq;s=gbone.scl;bone=this.addBone();bone.name=gbone.name;bone.position.set(p[0],p[1],p[2]);bone.quaternion.set(q[0],q[1],q[2],q[3]);bone.useQuaternion=true;if(s!==undefined){bone.scale.set(s[0],s[1],s[2])}else{bone.scale.set(1,1,1)}}for(b=0;b<this.bones.length;b++){gbone=this.geometry.bones[b];bone=this.bones[b];if(gbone.parent===-1){this.add(bone)}else{this.bones[gbone.parent].add(bone)}}var nBones=this.bones.length;if(this.useVertexTexture){var size;if(nBones>256)size=64;else if(nBones>64)size=32;else if(nBones>16)size=16;else size=8;this.boneTextureWidth=size;this.boneTextureHeight=size;this.boneMatrices=new Float32Array(this.boneTextureWidth*this.boneTextureHeight*4);this.boneTexture=new THREE.DataTexture(this.boneMatrices,this.boneTextureWidth,this.boneTextureHeight,THREE.RGBAFormat,THREE.FloatType);this.boneTexture.minFilter=THREE.NearestFilter;this.boneTexture.magFilter=THREE.NearestFilter;this.boneTexture.generateMipmaps=false;this.boneTexture.flipY=false}else{this.boneMatrices=new Float32Array(16*nBones)}this.pose()}};THREE.SkinnedMesh.prototype=Object.create(THREE.Mesh.prototype);THREE.SkinnedMesh.prototype.addBone=function(bone){if(bone===undefined){bone=new THREE.Bone(this)}this.bones.push(bone);return bone};THREE.SkinnedMesh.prototype.updateMatrixWorld=function(force){this.matrixAutoUpdate&&this.updateMatrix();if(this.matrixWorldNeedsUpdate||force){if(this.parent){this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)}else{this.matrixWorld.copy(this.matrix)}this.matrixWorldNeedsUpdate=false;force=true}for(var i=0,l=this.children.length;i<l;i++){var child=this.children[i];if(child instanceof THREE.Bone){child.update(this.identityMatrix,false)}else{child.updateMatrixWorld(true)}}if(this.boneInverses==undefined){this.boneInverses=[];for(var b=0,bl=this.bones.length;b<bl;b++){var inverse=new THREE.Matrix4;inverse.getInverse(this.bones[b].skinMatrix);this.boneInverses.push(inverse)}}for(var b=0,bl=this.bones.length;b<bl;b++){THREE.SkinnedMesh.offsetMatrix.multiplyMatrices(this.bones[b].skinMatrix,this.boneInverses[b]);THREE.SkinnedMesh.offsetMatrix.flattenToArrayOffset(this.boneMatrices,b*16)}if(this.useVertexTexture){this.boneTexture.needsUpdate=true}};THREE.SkinnedMesh.prototype.pose=function(){this.updateMatrixWorld(true);for(var i=0;i<this.geometry.skinIndices.length;i++){var sw=this.geometry.skinWeights[i];var scale=1/sw.lengthManhattan();if(scale!==Infinity){sw.multiplyScalar(scale)}else{sw.set(1)}}};THREE.SkinnedMesh.prototype.clone=function(object){if(object===undefined)object=new THREE.SkinnedMesh(this.geometry,this.material,this.useVertexTexture);THREE.Mesh.prototype.clone.call(this,object);return object};THREE.SkinnedMesh.offsetMatrix=new THREE.Matrix4;THREE.MorphAnimMesh=function(geometry,material){THREE.Mesh.call(this,geometry,material);this.duration=1e3;this.mirroredLoop=false;this.time=0;this.lastKeyframe=0;this.currentKeyframe=0;this.direction=1;this.directionBackwards=false;this.setFrameRange(0,this.geometry.morphTargets.length-1)};THREE.MorphAnimMesh.prototype=Object.create(THREE.Mesh.prototype);THREE.MorphAnimMesh.prototype.setFrameRange=function(start,end){this.startKeyframe=start;this.endKeyframe=end;this.length=this.endKeyframe-this.startKeyframe+1};THREE.MorphAnimMesh.prototype.setDirectionForward=function(){this.direction=1;this.directionBackwards=false};THREE.MorphAnimMesh.prototype.setDirectionBackward=function(){this.direction=-1;this.directionBackwards=true};THREE.MorphAnimMesh.prototype.parseAnimations=function(){var geometry=this.geometry;if(!geometry.animations)geometry.animations={};var firstAnimation,animations=geometry.animations;var pattern=/([a-z]+)(\d+)/;for(var i=0,il=geometry.morphTargets.length;i<il;i++){var morph=geometry.morphTargets[i];var parts=morph.name.match(pattern);if(parts&&parts.length>1){var label=parts[1];var num=parts[2];if(!animations[label])animations[label]={start:Infinity,end:-Infinity};var animation=animations[label];if(i<animation.start)animation.start=i;if(i>animation.end)animation.end=i;if(!firstAnimation)firstAnimation=label}}geometry.firstAnimation=firstAnimation};THREE.MorphAnimMesh.prototype.setAnimationLabel=function(label,start,end){if(!this.geometry.animations)this.geometry.animations={};this.geometry.animations[label]={start:start,end:end}};THREE.MorphAnimMesh.prototype.playAnimation=function(label,fps){var animation=this.geometry.animations[label];if(animation){this.setFrameRange(animation.start,animation.end);this.duration=1e3*((animation.end-animation.start)/fps);this.time=0}else{console.warn("animation["+label+"] undefined")}};THREE.MorphAnimMesh.prototype.updateAnimation=function(delta){var frameTime=this.duration/this.length;this.time+=this.direction*delta;if(this.mirroredLoop){if(this.time>this.duration||this.time<0){this.direction*=-1;if(this.time>this.duration){this.time=this.duration;this.directionBackwards=true}if(this.time<0){this.time=0;this.directionBackwards=false}}}else{this.time=this.time%this.duration;if(this.time<0)this.time+=this.duration}var keyframe=this.startKeyframe+THREE.Math.clamp(Math.floor(this.time/frameTime),0,this.length-1);if(keyframe!==this.currentKeyframe){this.morphTargetInfluences[this.lastKeyframe]=0;this.morphTargetInfluences[this.currentKeyframe]=1;this.morphTargetInfluences[keyframe]=0;this.lastKeyframe=this.currentKeyframe;this.currentKeyframe=keyframe}var mix=this.time%frameTime/frameTime;if(this.directionBackwards){mix=1-mix}this.morphTargetInfluences[this.currentKeyframe]=mix;this.morphTargetInfluences[this.lastKeyframe]=1-mix};THREE.MorphAnimMesh.prototype.clone=function(object){if(object===undefined)object=new THREE.MorphAnimMesh(this.geometry,this.material);object.duration=this.duration;object.mirroredLoop=this.mirroredLoop;object.time=this.time;object.lastKeyframe=this.lastKeyframe;object.currentKeyframe=this.currentKeyframe;object.direction=this.direction;object.directionBackwards=this.directionBackwards;THREE.Mesh.prototype.clone.call(this,object);return object};THREE.Ribbon=function(geometry,material){THREE.Object3D.call(this);this.geometry=geometry;this.material=material};THREE.Ribbon.prototype=Object.create(THREE.Object3D.prototype);THREE.Ribbon.prototype.clone=function(object){if(object===undefined)object=new THREE.Ribbon(this.geometry,this.material);THREE.Object3D.prototype.clone.call(this,object);return object};THREE.LOD=function(){THREE.Object3D.call(this);this.objects=[]};THREE.LOD.prototype=Object.create(THREE.Object3D.prototype);THREE.LOD.prototype.addLevel=function(object,distance){if(distance===undefined)distance=0;distance=Math.abs(distance);for(var l=0;l<this.objects.length;l++){if(distance<this.objects[l].distance){break}}this.objects.splice(l,0,{distance:distance,object:object});this.add(object)};THREE.LOD.prototype.getObjectForDistance=function(distance){for(var i=1,l=this.objects.length;i<l;i++){if(distance<this.objects[i].distance){break}}return this.objects[i-1].object};THREE.LOD.prototype.update=function(){var v1=new THREE.Vector3;var v2=new THREE.Vector3;return function(camera){if(this.objects.length>1){v1.getPositionFromMatrix(camera.matrixWorld);v2.getPositionFromMatrix(this.matrixWorld);var distance=v1.distanceTo(v2);this.objects[0].object.visible=true;for(var i=1,l=this.objects.length;i<l;i++){if(distance>=this.objects[i].distance){this.objects[i-1].object.visible=false;this.objects[i].object.visible=true}else{break}}for(;i<l;i++){this.objects[i].object.visible=false}}}}();THREE.LOD.prototype.clone=function(){};THREE.Sprite=function(material){THREE.Object3D.call(this);this.material=material!==undefined?material:new THREE.SpriteMaterial;this.rotation3d=this.rotation;this.rotation=0};THREE.Sprite.prototype=Object.create(THREE.Object3D.prototype);THREE.Sprite.prototype.updateMatrix=function(){this.rotation3d.set(0,0,this.rotation);this.quaternion.setFromEuler(this.rotation3d,this.eulerOrder);this.matrix.makeFromPositionQuaternionScale(this.position,this.quaternion,this.scale);this.matrixWorldNeedsUpdate=true};THREE.Sprite.prototype.clone=function(object){if(object===undefined)object=new THREE.Sprite(this.material);
THREE.Object3D.prototype.clone.call(this,object);return object};THREE.Scene=function(){THREE.Object3D.call(this);this.fog=null;this.overrideMaterial=null;this.autoUpdate=true;this.matrixAutoUpdate=false;this.__objects=[];this.__lights=[];this.__objectsAdded=[];this.__objectsRemoved=[]};THREE.Scene.prototype=Object.create(THREE.Object3D.prototype);THREE.Scene.prototype.__addObject=function(object){if(object instanceof THREE.Light){if(this.__lights.indexOf(object)===-1){this.__lights.push(object)}if(object.target&&object.target.parent===undefined){this.add(object.target)}}else if(!(object instanceof THREE.Camera||object instanceof THREE.Bone)){if(this.__objects.indexOf(object)===-1){this.__objects.push(object);this.__objectsAdded.push(object);var i=this.__objectsRemoved.indexOf(object);if(i!==-1){this.__objectsRemoved.splice(i,1)}}}for(var c=0;c<object.children.length;c++){this.__addObject(object.children[c])}};THREE.Scene.prototype.__removeObject=function(object){if(object instanceof THREE.Light){var i=this.__lights.indexOf(object);if(i!==-1){this.__lights.splice(i,1)}}else if(!(object instanceof THREE.Camera)){var i=this.__objects.indexOf(object);if(i!==-1){this.__objects.splice(i,1);this.__objectsRemoved.push(object);var ai=this.__objectsAdded.indexOf(object);if(ai!==-1){this.__objectsAdded.splice(ai,1)}}}for(var c=0;c<object.children.length;c++){this.__removeObject(object.children[c])}};THREE.Fog=function(hex,near,far){this.name="";this.color=new THREE.Color(hex);this.near=near!==undefined?near:1;this.far=far!==undefined?far:1e3};THREE.Fog.prototype.clone=function(){return new THREE.Fog(this.color.getHex(),this.near,this.far)};THREE.FogExp2=function(hex,density){this.name="";this.color=new THREE.Color(hex);this.density=density!==undefined?density:25e-5};THREE.FogExp2.prototype.clone=function(){return new THREE.FogExp2(this.color.getHex(),this.density)};THREE.CanvasRenderer=function(parameters){console.log("THREE.CanvasRenderer",THREE.REVISION);var smoothstep=THREE.Math.smoothstep;parameters=parameters||{};var _this=this,_renderData,_elements,_lights,_projector=new THREE.Projector,_canvas=parameters.canvas!==undefined?parameters.canvas:document.createElement("canvas"),_canvasWidth,_canvasHeight,_canvasWidthHalf,_canvasHeightHalf,_context=_canvas.getContext("2d"),_clearColor=new THREE.Color(0),_clearAlpha=0,_contextGlobalAlpha=1,_contextGlobalCompositeOperation=0,_contextStrokeStyle=null,_contextFillStyle=null,_contextLineWidth=null,_contextLineCap=null,_contextLineJoin=null,_contextDashSize=null,_contextGapSize=0,_camera,_v1,_v2,_v3,_v4,_v5=new THREE.RenderableVertex,_v6=new THREE.RenderableVertex,_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_v4x,_v4y,_v5x,_v5y,_v6x,_v6y,_color=new THREE.Color,_color1=new THREE.Color,_color2=new THREE.Color,_color3=new THREE.Color,_color4=new THREE.Color,_diffuseColor=new THREE.Color,_emissiveColor=new THREE.Color,_lightColor=new THREE.Color,_patterns={},_imagedatas={},_near,_far,_image,_uvs,_uv1x,_uv1y,_uv2x,_uv2y,_uv3x,_uv3y,_clipBox=new THREE.Box2,_clearBox=new THREE.Box2,_elemBox=new THREE.Box2,_ambientLight=new THREE.Color,_directionalLights=new THREE.Color,_pointLights=new THREE.Color,_vector3=new THREE.Vector3,_pixelMap,_pixelMapContext,_pixelMapImage,_pixelMapData,_gradientMap,_gradientMapContext,_gradientMapQuality=16;_pixelMap=document.createElement("canvas");_pixelMap.width=_pixelMap.height=2;_pixelMapContext=_pixelMap.getContext("2d");_pixelMapContext.fillStyle="rgba(0,0,0,1)";_pixelMapContext.fillRect(0,0,2,2);_pixelMapImage=_pixelMapContext.getImageData(0,0,2,2);_pixelMapData=_pixelMapImage.data;_gradientMap=document.createElement("canvas");_gradientMap.width=_gradientMap.height=_gradientMapQuality;_gradientMapContext=_gradientMap.getContext("2d");_gradientMapContext.translate(-_gradientMapQuality/2,-_gradientMapQuality/2);_gradientMapContext.scale(_gradientMapQuality,_gradientMapQuality);_gradientMapQuality--;if(_context.setLineDash===undefined){if(_context.mozDash!==undefined){_context.setLineDash=function(values){_context.mozDash=values[0]!==null?values:null}}else{_context.setLineDash=function(){}}}this.domElement=_canvas;this.devicePixelRatio=parameters.devicePixelRatio!==undefined?parameters.devicePixelRatio:window.devicePixelRatio!==undefined?window.devicePixelRatio:1;this.autoClear=true;this.sortObjects=true;this.sortElements=true;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.setSize=function(width,height,updateStyle){_canvasWidth=width*this.devicePixelRatio;_canvasHeight=height*this.devicePixelRatio;_canvasWidthHalf=Math.floor(_canvasWidth/2);_canvasHeightHalf=Math.floor(_canvasHeight/2);_canvas.width=_canvasWidth;_canvas.height=_canvasHeight;if(this.devicePixelRatio!==1&&updateStyle!==false){_canvas.style.width=width+"px";_canvas.style.height=height+"px"}_clipBox.set(new THREE.Vector2(-_canvasWidthHalf,-_canvasHeightHalf),new THREE.Vector2(_canvasWidthHalf,_canvasHeightHalf));_clearBox.set(new THREE.Vector2(-_canvasWidthHalf,-_canvasHeightHalf),new THREE.Vector2(_canvasWidthHalf,_canvasHeightHalf));_contextGlobalAlpha=1;_contextGlobalCompositeOperation=0;_contextStrokeStyle=null;_contextFillStyle=null;_contextLineWidth=null;_contextLineCap=null;_contextLineJoin=null};this.setClearColor=function(color,alpha){_clearColor.set(color);_clearAlpha=alpha!==undefined?alpha:1;_clearBox.set(new THREE.Vector2(-_canvasWidthHalf,-_canvasHeightHalf),new THREE.Vector2(_canvasWidthHalf,_canvasHeightHalf))};this.setClearColorHex=function(hex,alpha){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(hex,alpha)};this.getMaxAnisotropy=function(){return 0};this.clear=function(){_context.setTransform(1,0,0,-1,_canvasWidthHalf,_canvasHeightHalf);if(_clearBox.empty()===false){_clearBox.intersect(_clipBox);_clearBox.expandByScalar(2);if(_clearAlpha<1){_context.clearRect(_clearBox.min.x|0,_clearBox.min.y|0,_clearBox.max.x-_clearBox.min.x|0,_clearBox.max.y-_clearBox.min.y|0)}if(_clearAlpha>0){setBlending(THREE.NormalBlending);setOpacity(1);setFillStyle("rgba("+Math.floor(_clearColor.r*255)+","+Math.floor(_clearColor.g*255)+","+Math.floor(_clearColor.b*255)+","+_clearAlpha+")");_context.fillRect(_clearBox.min.x|0,_clearBox.min.y|0,_clearBox.max.x-_clearBox.min.x|0,_clearBox.max.y-_clearBox.min.y|0)}_clearBox.makeEmpty()}};this.render=function(scene,camera){if(camera instanceof THREE.Camera===false){console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");return}if(this.autoClear===true)this.clear();_context.setTransform(1,0,0,-1,_canvasWidthHalf,_canvasHeightHalf);_this.info.render.vertices=0;_this.info.render.faces=0;_renderData=_projector.projectScene(scene,camera,this.sortObjects,this.sortElements);_elements=_renderData.elements;_lights=_renderData.lights;_camera=camera;calculateLights();for(var e=0,el=_elements.length;e<el;e++){var element=_elements[e];var material=element.material;if(material===undefined||material.visible===false)continue;_elemBox.makeEmpty();if(element instanceof THREE.RenderableParticle){_v1=element;_v1.x*=_canvasWidthHalf;_v1.y*=_canvasHeightHalf;renderParticle(_v1,element,material)}else if(element instanceof THREE.RenderableLine){_v1=element.v1;_v2=element.v2;_v1.positionScreen.x*=_canvasWidthHalf;_v1.positionScreen.y*=_canvasHeightHalf;_v2.positionScreen.x*=_canvasWidthHalf;_v2.positionScreen.y*=_canvasHeightHalf;_elemBox.setFromPoints([_v1.positionScreen,_v2.positionScreen]);if(_clipBox.isIntersectionBox(_elemBox)===true){renderLine(_v1,_v2,element,material)}}else if(element instanceof THREE.RenderableFace3){_v1=element.v1;_v2=element.v2;_v3=element.v3;if(_v1.positionScreen.z<-1||_v1.positionScreen.z>1)continue;if(_v2.positionScreen.z<-1||_v2.positionScreen.z>1)continue;if(_v3.positionScreen.z<-1||_v3.positionScreen.z>1)continue;_v1.positionScreen.x*=_canvasWidthHalf;_v1.positionScreen.y*=_canvasHeightHalf;_v2.positionScreen.x*=_canvasWidthHalf;_v2.positionScreen.y*=_canvasHeightHalf;_v3.positionScreen.x*=_canvasWidthHalf;_v3.positionScreen.y*=_canvasHeightHalf;if(material.overdraw>0){expand(_v1.positionScreen,_v2.positionScreen,material.overdraw);expand(_v2.positionScreen,_v3.positionScreen,material.overdraw);expand(_v3.positionScreen,_v1.positionScreen,material.overdraw)}_elemBox.setFromPoints([_v1.positionScreen,_v2.positionScreen,_v3.positionScreen]);if(_clipBox.isIntersectionBox(_elemBox)===true){renderFace3(_v1,_v2,_v3,0,1,2,element,material)}}else if(element instanceof THREE.RenderableFace4){_v1=element.v1;_v2=element.v2;_v3=element.v3;_v4=element.v4;if(_v1.positionScreen.z<-1||_v1.positionScreen.z>1)continue;if(_v2.positionScreen.z<-1||_v2.positionScreen.z>1)continue;if(_v3.positionScreen.z<-1||_v3.positionScreen.z>1)continue;if(_v4.positionScreen.z<-1||_v4.positionScreen.z>1)continue;_v1.positionScreen.x*=_canvasWidthHalf;_v1.positionScreen.y*=_canvasHeightHalf;_v2.positionScreen.x*=_canvasWidthHalf;_v2.positionScreen.y*=_canvasHeightHalf;_v3.positionScreen.x*=_canvasWidthHalf;_v3.positionScreen.y*=_canvasHeightHalf;_v4.positionScreen.x*=_canvasWidthHalf;_v4.positionScreen.y*=_canvasHeightHalf;_v5.positionScreen.copy(_v2.positionScreen);_v6.positionScreen.copy(_v4.positionScreen);if(material.overdraw>0){expand(_v1.positionScreen,_v2.positionScreen,material.overdraw);expand(_v2.positionScreen,_v4.positionScreen,material.overdraw);expand(_v4.positionScreen,_v1.positionScreen,material.overdraw);expand(_v3.positionScreen,_v5.positionScreen,material.overdraw);expand(_v3.positionScreen,_v6.positionScreen,material.overdraw)}_elemBox.setFromPoints([_v1.positionScreen,_v2.positionScreen,_v3.positionScreen,_v4.positionScreen]);if(_clipBox.isIntersectionBox(_elemBox)===true){renderFace4(_v1,_v2,_v3,_v4,_v5,_v6,element,material)}}_clearBox.union(_elemBox)}_context.setTransform(1,0,0,1,0,0)};function calculateLights(){_ambientLight.setRGB(0,0,0);_directionalLights.setRGB(0,0,0);_pointLights.setRGB(0,0,0);for(var l=0,ll=_lights.length;l<ll;l++){var light=_lights[l];var lightColor=light.color;if(light instanceof THREE.AmbientLight){_ambientLight.add(lightColor)}else if(light instanceof THREE.DirectionalLight){_directionalLights.add(lightColor)}else if(light instanceof THREE.PointLight){_pointLights.add(lightColor)}}}function calculateLight(position,normal,color){for(var l=0,ll=_lights.length;l<ll;l++){var light=_lights[l];_lightColor.copy(light.color);if(light instanceof THREE.DirectionalLight){var lightPosition=_vector3.getPositionFromMatrix(light.matrixWorld).normalize();var amount=normal.dot(lightPosition);if(amount<=0)continue;amount*=light.intensity;color.add(_lightColor.multiplyScalar(amount))}else if(light instanceof THREE.PointLight){var lightPosition=_vector3.getPositionFromMatrix(light.matrixWorld);var amount=normal.dot(_vector3.subVectors(lightPosition,position).normalize());if(amount<=0)continue;amount*=light.distance==0?1:1-Math.min(position.distanceTo(lightPosition)/light.distance,1);if(amount==0)continue;amount*=light.intensity;color.add(_lightColor.multiplyScalar(amount))}}}function renderParticle(v1,element,material){setOpacity(material.opacity);setBlending(material.blending);var width,height,scaleX,scaleY,bitmap,bitmapWidth,bitmapHeight;if(material instanceof THREE.ParticleBasicMaterial){if(material.map===null){scaleX=element.object.scale.x;scaleY=element.object.scale.y;scaleX*=element.scale.x*_canvasWidthHalf;scaleY*=element.scale.y*_canvasHeightHalf;_elemBox.min.set(v1.x-scaleX,v1.y-scaleY);_elemBox.max.set(v1.x+scaleX,v1.y+scaleY);if(_clipBox.isIntersectionBox(_elemBox)===false){_elemBox.makeEmpty();return}setFillStyle(material.color.getStyle());_context.save();_context.translate(v1.x,v1.y);_context.rotate(-element.rotation);_context.scale(scaleX,scaleY);_context.fillRect(-1,-1,2,2);_context.restore()}else{bitmap=material.map.image;bitmapWidth=bitmap.width>>1;bitmapHeight=bitmap.height>>1;scaleX=element.scale.x*_canvasWidthHalf;scaleY=element.scale.y*_canvasHeightHalf;width=scaleX*bitmapWidth;height=scaleY*bitmapHeight;_elemBox.min.set(v1.x-width,v1.y-height);_elemBox.max.set(v1.x+width,v1.y+height);if(_clipBox.isIntersectionBox(_elemBox)===false){_elemBox.makeEmpty();return}_context.save();_context.translate(v1.x,v1.y);_context.rotate(-element.rotation);_context.scale(scaleX,-scaleY);_context.translate(-bitmapWidth,-bitmapHeight);_context.drawImage(bitmap,0,0);_context.restore()}}else if(material instanceof THREE.ParticleCanvasMaterial){width=element.scale.x*_canvasWidthHalf;height=element.scale.y*_canvasHeightHalf;_elemBox.min.set(v1.x-width,v1.y-height);_elemBox.max.set(v1.x+width,v1.y+height);if(_clipBox.isIntersectionBox(_elemBox)===false){_elemBox.makeEmpty();return}setStrokeStyle(material.color.getStyle());setFillStyle(material.color.getStyle());_context.save();_context.translate(v1.x,v1.y);_context.rotate(-element.rotation);_context.scale(width,height);material.program(_context);_context.restore()}}function renderLine(v1,v2,element,material){setOpacity(material.opacity);setBlending(material.blending);_context.beginPath();_context.moveTo(v1.positionScreen.x,v1.positionScreen.y);_context.lineTo(v2.positionScreen.x,v2.positionScreen.y);if(material instanceof THREE.LineBasicMaterial){setLineWidth(material.linewidth);setLineCap(material.linecap);setLineJoin(material.linejoin);if(material.vertexColors!==THREE.VertexColors){setStrokeStyle(material.color.getStyle())}else{var colorStyle1=element.vertexColors[0].getStyle();var colorStyle2=element.vertexColors[1].getStyle();if(colorStyle1===colorStyle2){setStrokeStyle(colorStyle1)}else{try{var grad=_context.createLinearGradient(v1.positionScreen.x,v1.positionScreen.y,v2.positionScreen.x,v2.positionScreen.y);grad.addColorStop(0,colorStyle1);grad.addColorStop(1,colorStyle2)}catch(exception){grad=colorStyle1}setStrokeStyle(grad)}}_context.stroke();_elemBox.expandByScalar(material.linewidth*2)}else if(material instanceof THREE.LineDashedMaterial){setLineWidth(material.linewidth);setLineCap(material.linecap);setLineJoin(material.linejoin);setStrokeStyle(material.color.getStyle());setDashAndGap(material.dashSize,material.gapSize);_context.stroke();_elemBox.expandByScalar(material.linewidth*2);setDashAndGap(null,null)}}function renderFace3(v1,v2,v3,uv1,uv2,uv3,element,material){_this.info.render.vertices+=3;_this.info.render.faces++;setOpacity(material.opacity);setBlending(material.blending);_v1x=v1.positionScreen.x;_v1y=v1.positionScreen.y;_v2x=v2.positionScreen.x;_v2y=v2.positionScreen.y;_v3x=v3.positionScreen.x;_v3y=v3.positionScreen.y;drawTriangle(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y);if((material instanceof THREE.MeshLambertMaterial||material instanceof THREE.MeshPhongMaterial)&&material.map===null){_diffuseColor.copy(material.color);_emissiveColor.copy(material.emissive);if(material.vertexColors===THREE.FaceColors){_diffuseColor.multiply(element.color)}if(material.wireframe===false&&material.shading==THREE.SmoothShading&&element.vertexNormalsLength==3){_color1.copy(_ambientLight);_color2.copy(_ambientLight);_color3.copy(_ambientLight);calculateLight(element.v1.positionWorld,element.vertexNormalsModel[0],_color1);calculateLight(element.v2.positionWorld,element.vertexNormalsModel[1],_color2);calculateLight(element.v3.positionWorld,element.vertexNormalsModel[2],_color3);_color1.multiply(_diffuseColor).add(_emissiveColor);_color2.multiply(_diffuseColor).add(_emissiveColor);_color3.multiply(_diffuseColor).add(_emissiveColor);_color4.addColors(_color2,_color3).multiplyScalar(.5);_image=getGradientTexture(_color1,_color2,_color3,_color4);clipImage(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,0,0,1,0,0,1,_image)}else{_color.copy(_ambientLight);calculateLight(element.centroidModel,element.normalModel,_color);_color.multiply(_diffuseColor).add(_emissiveColor);material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}}else if(material instanceof THREE.MeshBasicMaterial||material instanceof THREE.MeshLambertMaterial||material instanceof THREE.MeshPhongMaterial){if(material.map!==null){if(material.map.mapping instanceof THREE.UVMapping){_uvs=element.uvs[0];patternPath(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_uvs[uv1].x,_uvs[uv1].y,_uvs[uv2].x,_uvs[uv2].y,_uvs[uv3].x,_uvs[uv3].y,material.map)}}else if(material.envMap!==null){if(material.envMap.mapping instanceof THREE.SphericalReflectionMapping){_vector3.copy(element.vertexNormalsModelView[uv1]);_uv1x=.5*_vector3.x+.5;_uv1y=.5*_vector3.y+.5;_vector3.copy(element.vertexNormalsModelView[uv2]);_uv2x=.5*_vector3.x+.5;_uv2y=.5*_vector3.y+.5;_vector3.copy(element.vertexNormalsModelView[uv3]);_uv3x=.5*_vector3.x+.5;_uv3y=.5*_vector3.y+.5;patternPath(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_uv1x,_uv1y,_uv2x,_uv2y,_uv3x,_uv3y,material.envMap)}}else{_color.copy(material.color);if(material.vertexColors===THREE.FaceColors){_color.multiply(element.color)}material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}}else if(material instanceof THREE.MeshDepthMaterial){_near=_camera.near;_far=_camera.far;_color1.r=_color1.g=_color1.b=1-smoothstep(v1.positionScreen.z*v1.positionScreen.w,_near,_far);_color2.r=_color2.g=_color2.b=1-smoothstep(v2.positionScreen.z*v2.positionScreen.w,_near,_far);_color3.r=_color3.g=_color3.b=1-smoothstep(v3.positionScreen.z*v3.positionScreen.w,_near,_far);_color4.addColors(_color2,_color3).multiplyScalar(.5);_image=getGradientTexture(_color1,_color2,_color3,_color4);clipImage(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,0,0,1,0,0,1,_image)}else if(material instanceof THREE.MeshNormalMaterial){var normal;if(material.shading==THREE.FlatShading){normal=element.normalModelView;_color.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}else if(material.shading==THREE.SmoothShading){normal=element.vertexNormalsModelView[uv1];_color1.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);normal=element.vertexNormalsModelView[uv2];_color2.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);normal=element.vertexNormalsModelView[uv3];_color3.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);_color4.addColors(_color2,_color3).multiplyScalar(.5);_image=getGradientTexture(_color1,_color2,_color3,_color4);clipImage(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,0,0,1,0,0,1,_image)}}}function renderFace4(v1,v2,v3,v4,v5,v6,element,material){_this.info.render.vertices+=4;_this.info.render.faces++;setOpacity(material.opacity);setBlending(material.blending);if(material.map!==undefined&&material.map!==null||material.envMap!==undefined&&material.envMap!==null){renderFace3(v1,v2,v4,0,1,3,element,material);renderFace3(v5,v3,v6,1,2,3,element,material);return}_v1x=v1.positionScreen.x;_v1y=v1.positionScreen.y;_v2x=v2.positionScreen.x;_v2y=v2.positionScreen.y;_v3x=v3.positionScreen.x;_v3y=v3.positionScreen.y;_v4x=v4.positionScreen.x;_v4y=v4.positionScreen.y;_v5x=v5.positionScreen.x;_v5y=v5.positionScreen.y;_v6x=v6.positionScreen.x;_v6y=v6.positionScreen.y;if(material instanceof THREE.MeshLambertMaterial||material instanceof THREE.MeshPhongMaterial){_diffuseColor.copy(material.color);_emissiveColor.copy(material.emissive);if(material.vertexColors===THREE.FaceColors){_diffuseColor.multiply(element.color)}if(material.wireframe===false&&material.shading==THREE.SmoothShading&&element.vertexNormalsLength==4){_color1.copy(_ambientLight);_color2.copy(_ambientLight);_color3.copy(_ambientLight);_color4.copy(_ambientLight);calculateLight(element.v1.positionWorld,element.vertexNormalsModel[0],_color1);calculateLight(element.v2.positionWorld,element.vertexNormalsModel[1],_color2);calculateLight(element.v4.positionWorld,element.vertexNormalsModel[3],_color3);calculateLight(element.v3.positionWorld,element.vertexNormalsModel[2],_color4);_color1.multiply(_diffuseColor).add(_emissiveColor);_color2.multiply(_diffuseColor).add(_emissiveColor);_color3.multiply(_diffuseColor).add(_emissiveColor);_color4.multiply(_diffuseColor).add(_emissiveColor);_image=getGradientTexture(_color1,_color2,_color3,_color4);drawTriangle(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y);clipImage(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y,0,0,1,0,0,1,_image);drawTriangle(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y);clipImage(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y,1,0,1,1,0,1,_image)}else{_color.copy(_ambientLight);calculateLight(element.centroidModel,element.normalModel,_color);_color.multiply(_diffuseColor).add(_emissiveColor);drawQuad(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_v4x,_v4y);material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}}else if(material instanceof THREE.MeshBasicMaterial){_color.copy(material.color);if(material.vertexColors===THREE.FaceColors){_color.multiply(element.color)}drawQuad(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_v4x,_v4y);material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}else if(material instanceof THREE.MeshNormalMaterial){var normal;if(material.shading==THREE.FlatShading){normal=element.normalModelView;_color.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);drawQuad(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_v4x,_v4y);material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}else if(material.shading==THREE.SmoothShading){normal=element.vertexNormalsModelView[0];_color1.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);normal=element.vertexNormalsModelView[1];_color2.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);normal=element.vertexNormalsModelView[3];_color3.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);normal=element.vertexNormalsModelView[2];_color4.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);_image=getGradientTexture(_color1,_color2,_color3,_color4);drawTriangle(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y);clipImage(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y,0,0,1,0,0,1,_image);drawTriangle(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y);clipImage(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y,1,0,1,1,0,1,_image)}}else if(material instanceof THREE.MeshDepthMaterial){_near=_camera.near;_far=_camera.far;_color1.r=_color1.g=_color1.b=1-smoothstep(v1.positionScreen.z*v1.positionScreen.w,_near,_far);_color2.r=_color2.g=_color2.b=1-smoothstep(v2.positionScreen.z*v2.positionScreen.w,_near,_far);_color3.r=_color3.g=_color3.b=1-smoothstep(v4.positionScreen.z*v4.positionScreen.w,_near,_far);_color4.r=_color4.g=_color4.b=1-smoothstep(v3.positionScreen.z*v3.positionScreen.w,_near,_far);_image=getGradientTexture(_color1,_color2,_color3,_color4);drawTriangle(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y);clipImage(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y,0,0,1,0,0,1,_image);drawTriangle(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y);clipImage(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y,1,0,1,1,0,1,_image)}}function drawTriangle(x0,y0,x1,y1,x2,y2){_context.beginPath();_context.moveTo(x0,y0);_context.lineTo(x1,y1);_context.lineTo(x2,y2);_context.closePath()}function drawQuad(x0,y0,x1,y1,x2,y2,x3,y3){_context.beginPath();_context.moveTo(x0,y0);_context.lineTo(x1,y1);_context.lineTo(x2,y2);_context.lineTo(x3,y3);_context.closePath()}function strokePath(color,linewidth,linecap,linejoin){setLineWidth(linewidth);setLineCap(linecap);setLineJoin(linejoin);setStrokeStyle(color.getStyle());_context.stroke();_elemBox.expandByScalar(linewidth*2)}function fillPath(color){setFillStyle(color.getStyle());_context.fill()}function patternPath(x0,y0,x1,y1,x2,y2,u0,v0,u1,v1,u2,v2,texture){if(texture instanceof THREE.DataTexture||texture.image===undefined||texture.image.width==0)return;if(texture.needsUpdate===true){var repeatX=texture.wrapS==THREE.RepeatWrapping;var repeatY=texture.wrapT==THREE.RepeatWrapping;_patterns[texture.id]=_context.createPattern(texture.image,repeatX===true&&repeatY===true?"repeat":repeatX===true&&repeatY===false?"repeat-x":repeatX===false&&repeatY===true?"repeat-y":"no-repeat");texture.needsUpdate=false}_patterns[texture.id]===undefined?setFillStyle("rgba(0,0,0,1)"):setFillStyle(_patterns[texture.id]);var a,b,c,d,e,f,det,idet,offsetX=texture.offset.x/texture.repeat.x,offsetY=texture.offset.y/texture.repeat.y,width=texture.image.width*texture.repeat.x,height=texture.image.height*texture.repeat.y;u0=(u0+offsetX)*width;v0=(1-v0+offsetY)*height;u1=(u1+offsetX)*width;v1=(1-v1+offsetY)*height;u2=(u2+offsetX)*width;v2=(1-v2+offsetY)*height;x1-=x0;y1-=y0;x2-=x0;y2-=y0;u1-=u0;v1-=v0;u2-=u0;v2-=v0;det=u1*v2-u2*v1;if(det===0){if(_imagedatas[texture.id]===undefined){var canvas=document.createElement("canvas");canvas.width=texture.image.width;canvas.height=texture.image.height;var context=canvas.getContext("2d");context.drawImage(texture.image,0,0);_imagedatas[texture.id]=context.getImageData(0,0,texture.image.width,texture.image.height).data}var data=_imagedatas[texture.id];var index=(Math.floor(u0)+Math.floor(v0)*texture.image.width)*4;_color.setRGB(data[index]/255,data[index+1]/255,data[index+2]/255);fillPath(_color);return}idet=1/det;a=(v2*x1-v1*x2)*idet;b=(v2*y1-v1*y2)*idet;c=(u1*x2-u2*x1)*idet;d=(u1*y2-u2*y1)*idet;e=x0-a*u0-c*v0;f=y0-b*u0-d*v0;_context.save();_context.transform(a,b,c,d,e,f);_context.fill();_context.restore()}function clipImage(x0,y0,x1,y1,x2,y2,u0,v0,u1,v1,u2,v2,image){var a,b,c,d,e,f,det,idet,width=image.width-1,height=image.height-1;u0*=width;v0*=height;u1*=width;v1*=height;u2*=width;v2*=height;x1-=x0;y1-=y0;x2-=x0;y2-=y0;u1-=u0;v1-=v0;u2-=u0;v2-=v0;det=u1*v2-u2*v1;idet=1/det;a=(v2*x1-v1*x2)*idet;b=(v2*y1-v1*y2)*idet;c=(u1*x2-u2*x1)*idet;d=(u1*y2-u2*y1)*idet;e=x0-a*u0-c*v0;f=y0-b*u0-d*v0;_context.save();_context.transform(a,b,c,d,e,f);_context.clip();_context.drawImage(image,0,0);_context.restore()}function getGradientTexture(color1,color2,color3,color4){_pixelMapData[0]=color1.r*255|0;_pixelMapData[1]=color1.g*255|0;_pixelMapData[2]=color1.b*255|0;_pixelMapData[4]=color2.r*255|0;_pixelMapData[5]=color2.g*255|0;_pixelMapData[6]=color2.b*255|0;_pixelMapData[8]=color3.r*255|0;_pixelMapData[9]=color3.g*255|0;_pixelMapData[10]=color3.b*255|0;_pixelMapData[12]=color4.r*255|0;_pixelMapData[13]=color4.g*255|0;_pixelMapData[14]=color4.b*255|0;_pixelMapContext.putImageData(_pixelMapImage,0,0);_gradientMapContext.drawImage(_pixelMap,0,0);return _gradientMap}function expand(v1,v2,pixels){var x=v2.x-v1.x,y=v2.y-v1.y,det=x*x+y*y,idet;if(det===0)return;idet=pixels/Math.sqrt(det);x*=idet;y*=idet;v2.x+=x;v2.y+=y;v1.x-=x;v1.y-=y}function setOpacity(value){if(_contextGlobalAlpha!==value){_context.globalAlpha=value;_contextGlobalAlpha=value}}function setBlending(value){if(_contextGlobalCompositeOperation!==value){if(value===THREE.NormalBlending){_context.globalCompositeOperation="source-over"}else if(value===THREE.AdditiveBlending){_context.globalCompositeOperation="lighter"}else if(value===THREE.SubtractiveBlending){_context.globalCompositeOperation="darker"}_contextGlobalCompositeOperation=value}}function setLineWidth(value){if(_contextLineWidth!==value){_context.lineWidth=value;_contextLineWidth=value}}function setLineCap(value){if(_contextLineCap!==value){_context.lineCap=value;_contextLineCap=value}}function setLineJoin(value){if(_contextLineJoin!==value){_context.lineJoin=value;_contextLineJoin=value}}function setStrokeStyle(value){if(_contextStrokeStyle!==value){_context.strokeStyle=value;_contextStrokeStyle=value}}function setFillStyle(value){if(_contextFillStyle!==value){_context.fillStyle=value;_contextFillStyle=value}}function setDashAndGap(dashSizeValue,gapSizeValue){if(_contextDashSize!==dashSizeValue||_contextGapSize!==gapSizeValue){_context.setLineDash([dashSizeValue,gapSizeValue]);_contextDashSize=dashSizeValue;_contextGapSize=gapSizeValue}}};THREE.ShaderChunk={fog_pars_fragment:["#ifdef USE_FOG","uniform vec3 fogColor;","#ifdef FOG_EXP2","uniform float fogDensity;","#else","uniform float fogNear;","uniform float fogFar;","#endif","#endif"].join("\n"),fog_fragment:["#ifdef USE_FOG","float depth = gl_FragCoord.z / gl_FragCoord.w;","#ifdef FOG_EXP2","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","#else","float fogFactor = smoothstep( fogNear, fogFar, depth );","#endif","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","#endif"].join("\n"),envmap_pars_fragment:["#ifdef USE_ENVMAP","uniform float reflectivity;","uniform samplerCube envMap;","uniform float flipEnvMap;","uniform int combine;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","uniform bool useRefract;","uniform float refractionRatio;","#else","varying vec3 vReflect;","#endif","#endif"].join("\n"),envmap_fragment:["#ifdef USE_ENVMAP","vec3 reflectVec;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","reflectVec = refract( cameraToVertex, normal, refractionRatio );","} else { ","reflectVec = reflect( cameraToVertex, normal );","}","#else","reflectVec = vReflect;","#endif","#ifdef DOUBLE_SIDED","float flipNormal = ( -1.0 + 2.0 * float( gl_FrontFacing ) );","vec4 cubeColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );","#else","vec4 cubeColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );","#endif","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n"),envmap_pars_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )","varying vec3 vReflect;","uniform float refractionRatio;","uniform bool useRefract;","#endif"].join("\n"),worldpos_vertex:["#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )","#ifdef USE_SKINNING","vec4 worldPosition = modelMatrix * skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","#endif","#endif"].join("\n"),envmap_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormal = normalize( worldNormal );","vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","if ( useRefract ) {","vReflect = refract( cameraToVertex, worldNormal, refractionRatio );","} else {","vReflect = reflect( cameraToVertex, worldNormal );","}","#endif"].join("\n"),map_particle_pars_fragment:["#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_particle_fragment:["#ifdef USE_MAP","gl_FragColor = gl_FragColor * texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );","#endif"].join("\n"),map_pars_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )","varying vec2 vUv;","uniform vec4 offsetRepeat;","#endif"].join("\n"),map_pars_fragment:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )","varying vec2 vUv;","#endif","#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )","vUv = uv * offsetRepeat.zw + offsetRepeat.xy;","#endif"].join("\n"),map_fragment:["#ifdef USE_MAP","vec4 texelColor = texture2D( map, vUv );","#ifdef GAMMA_INPUT","texelColor.xyz *= texelColor.xyz;","#endif","gl_FragColor = gl_FragColor * texelColor;","#endif"].join("\n"),lightmap_pars_fragment:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","uniform sampler2D lightMap;","#endif"].join("\n"),lightmap_pars_vertex:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","#endif"].join("\n"),lightmap_fragment:["#ifdef USE_LIGHTMAP","gl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );","#endif"].join("\n"),lightmap_vertex:["#ifdef USE_LIGHTMAP","vUv2 = uv2;","#endif"].join("\n"),bumpmap_pars_fragment:["#ifdef USE_BUMPMAP","uniform sampler2D bumpMap;","uniform float bumpScale;","vec2 dHdxy_fwd() {","vec2 dSTdx = dFdx( vUv );","vec2 dSTdy = dFdy( vUv );","float Hll = bumpScale * texture2D( bumpMap, vUv ).x;","float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 R1 = cross( vSigmaY, vN );","vec3 R2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, R1 );","vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","return normalize( abs( fDet ) * surf_norm - vGrad );","}","#endif"].join("\n"),normalmap_pars_fragment:["#ifdef USE_NORMALMAP","uniform sampler2D normalMap;","uniform vec2 normalScale;","vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {","vec3 q0 = dFdx( eye_pos.xyz );","vec3 q1 = dFdy( eye_pos.xyz );","vec2 st0 = dFdx( vUv.st );","vec2 st1 = dFdy( vUv.st );","vec3 S = normalize(  q0 * st1.t - q1 * st0.t );","vec3 T = normalize( -q0 * st1.s + q1 * st0.s );","vec3 N = normalize( surf_norm );","vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;","mapN.xy = normalScale * mapN.xy;","mat3 tsn = mat3( S, T, N );","return normalize( tsn * mapN );","}","#endif"].join("\n"),specularmap_pars_fragment:["#ifdef USE_SPECULARMAP","uniform sampler2D specularMap;","#endif"].join("\n"),specularmap_fragment:["float specularStrength;","#ifdef USE_SPECULARMAP","vec4 texelSpecular = texture2D( specularMap, vUv );","specularStrength = texelSpecular.r;","#else","specularStrength = 1.0;","#endif"].join("\n"),lights_lambert_pars_vertex:["uniform vec3 ambient;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif"].join("\n"),lights_lambert_vertex:["vLightFront = vec3( 0.0 );","#ifdef DOUBLE_SIDED","vLightBack = vec3( 0.0 );","#endif","transformedNormal = normalize( transformedNormal );","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, dirVector );","vec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","directionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","directionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += directionalLightColor[ i ] * directionalLightWeighting;","#ifdef DOUBLE_SIDED","vLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;","#endif","}","#endif","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","pointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","pointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;","#ifdef DOUBLE_SIDED","vLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","spotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","spotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;","#ifdef DOUBLE_SIDED","vLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_HEMI_LIGHTS > 0","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","float hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;","vLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","#ifdef DOUBLE_SIDED","vLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );","#endif","}","#endif","vLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;","#ifdef DOUBLE_SIDED","vLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;","#endif"].join("\n"),lights_phong_pars_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","varying vec3 vWorldPosition;","#endif"].join("\n"),lights_phong_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","vWorldPosition = worldPosition.xyz;","#endif"].join("\n"),lights_phong_pars_fragment:["uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","varying vec3 vWorldPosition;","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),lights_phong_fragment:["vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );","#ifdef DOUBLE_SIDED","normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -vViewPosition, normal );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lDistance = vPointLight[ i ].w;","#endif","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dotProduct, 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dotProduct, 0.0 );","#endif","pointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization;","#else","pointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lDistance = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dotProduct, 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dotProduct, 0.0 );","#endif","spotDiffuse += diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;","vec3 spotHalfVector = normalize( lVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect;","#else","spotSpecular += specular * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += diffuse * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, shininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotProductGround = dot( normal, lVectorGround );","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlickSky = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );","vec3 schlickGround = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );","hemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );","#else","hemiSpecular += specular * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif"].join("\n"),color_pars_fragment:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_fragment:["#ifdef USE_COLOR","gl_FragColor = gl_FragColor * vec4( vColor, opacity );","#endif"].join("\n"),color_pars_vertex:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_vertex:["#ifdef USE_COLOR","#ifdef GAMMA_INPUT","vColor = color * color;","#else","vColor = color;","#endif","#endif"].join("\n"),skinning_pars_vertex:["#ifdef USE_SKINNING","#ifdef BONE_TEXTURE","uniform sampler2D boneTexture;","mat4 getBoneMatrix( const in float i ) {","float j = i * 4.0;","float x = mod( j, N_BONE_PIXEL_X );","float y = floor( j / N_BONE_PIXEL_X );","const float dx = 1.0 / N_BONE_PIXEL_X;","const float dy = 1.0 / N_BONE_PIXEL_Y;","y = dy * ( y + 0.5 );","vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );","vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );","vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );","vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );","mat4 bone = mat4( v1, v2, v3, v4 );","return bone;","}","#else","uniform mat4 boneGlobalMatrices[ MAX_BONES ];","mat4 getBoneMatrix( const in float i ) {","mat4 bone = boneGlobalMatrices[ int(i) ];","return bone;","}","#endif","#endif"].join("\n"),skinbase_vertex:["#ifdef USE_SKINNING","mat4 boneMatX = getBoneMatrix( skinIndex.x );","mat4 boneMatY = getBoneMatrix( skinIndex.y );","#endif"].join("\n"),skinning_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHTARGETS","vec4 skinVertex = vec4( morphed, 1.0 );","#else","vec4 skinVertex = vec4( position, 1.0 );","#endif","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","#endif"].join("\n"),morphtarget_pars_vertex:["#ifdef USE_MORPHTARGETS","#ifndef USE_MORPHNORMALS","uniform float morphTargetInfluences[ 8 ];","#else","uniform float morphTargetInfluences[ 4 ];","#endif","#endif"].join("\n"),morphtarget_vertex:["#ifdef USE_MORPHTARGETS","vec3 morphed = vec3( 0.0 );","morphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];","morphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];","morphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];","morphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];","#ifndef USE_MORPHNORMALS","morphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];","morphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];","morphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];","morphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];","#endif","morphed += position;","#endif"].join("\n"),default_vertex:["vec4 mvPosition;","#ifdef USE_SKINNING","mvPosition = modelViewMatrix * skinned;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( morphed, 1.0 );","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( position, 1.0 );","#endif","gl_Position = projectionMatrix * mvPosition;"].join("\n"),morphnormal_vertex:["#ifdef USE_MORPHNORMALS","vec3 morphedNormal = vec3( 0.0 );","morphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];","morphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];","morphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];","morphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];","morphedNormal += normal;","#endif"].join("\n"),skinnormal_vertex:["#ifdef USE_SKINNING","mat4 skinMatrix = skinWeight.x * boneMatX;","skinMatrix 	+= skinWeight.y * boneMatY;","#ifdef USE_MORPHNORMALS","vec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );","#else","vec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );","#endif","#endif"].join("\n"),defaultnormal_vertex:["vec3 objectNormal;","#ifdef USE_SKINNING","objectNormal = skinnedNormal.xyz;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS )","objectNormal = morphedNormal;","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS )","objectNormal = normal;","#endif","#ifdef FLIP_SIDED","objectNormal = -objectNormal;","#endif","vec3 transformedNormal = normalMatrix * objectNormal;"].join("\n"),shadowmap_pars_fragment:["#ifdef USE_SHADOWMAP","uniform sampler2D shadowMap[ MAX_SHADOWS ];","uniform vec2 shadowMapSize[ MAX_SHADOWS ];","uniform float shadowDarkness[ MAX_SHADOWS ];","uniform float shadowBias[ MAX_SHADOWS ];","varying vec4 vShadowCoord[ MAX_SHADOWS ];","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","#endif"].join("\n"),shadowmap_fragment:["#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","#ifdef SHADOWMAP_CASCADE","int inFrustumCount = 0;","#endif","float fDepth;","vec3 shadowColor = vec3( 1.0 );","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","#ifdef SHADOWMAP_CASCADE","inFrustumCount += int( inFrustum );","bvec3 frustumTestVec = bvec3( inFrustum, inFrustumCount == 1, shadowCoord.z <= 1.0 );","#else","bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","#endif","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","shadowCoord.z += shadowBias[ i ];","#if defined( SHADOWMAP_TYPE_PCF )","float shadow = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","mat3 depthKernel;","depthKernel[0][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","depthKernel[0][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","depthKernel[0][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","depthKernel[1][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","depthKernel[1][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","depthKernel[1][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","depthKernel[2][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","depthKernel[2][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","depthKernel[2][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","vec3 shadowZ = vec3( shadowCoord.z );","shadowKernel[0] = vec3(lessThan(depthKernel[0], shadowZ ));","shadowKernel[0] *= vec3(0.25);","shadowKernel[1] = vec3(lessThan(depthKernel[1], shadowZ ));","shadowKernel[1] *= vec3(0.25);","shadowKernel[2] = vec3(lessThan(depthKernel[2], shadowZ ));","shadowKernel[2] *= vec3(0.25);","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize[i].xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadow = dot( shadowValues, vec4( 1.0 ) );","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#else","vec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );","float fDepth = unpackDepth( rgbaDepth );","if ( fDepth < shadowCoord.z )","shadowColor = shadowColor * vec3( 1.0 - shadowDarkness[ i ] );","#endif","}","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( inFrustum && inFrustumCount == 1 ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","#ifdef GAMMA_OUTPUT","shadowColor *= shadowColor;","#endif","gl_FragColor.xyz = gl_FragColor.xyz * shadowColor;","#endif"].join("\n"),shadowmap_pars_vertex:["#ifdef USE_SHADOWMAP","varying vec4 vShadowCoord[ MAX_SHADOWS ];","uniform mat4 shadowMatrix[ MAX_SHADOWS ];","#endif"].join("\n"),shadowmap_vertex:["#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;","}","#endif"].join("\n"),alphatest_fragment:["#ifdef ALPHATEST","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif"].join("\n"),linear_to_gamma_fragment:["#ifdef GAMMA_OUTPUT","gl_FragColor.xyz = sqrt( gl_FragColor.xyz );","#endif"].join("\n")};
THREE.UniformsUtils={merge:function(uniforms){var u,p,tmp,merged={};for(u=0;u<uniforms.length;u++){tmp=this.clone(uniforms[u]);for(p in tmp){merged[p]=tmp[p]}}return merged},clone:function(uniforms_src){var u,p,parameter,parameter_src,uniforms_dst={};for(u in uniforms_src){uniforms_dst[u]={};for(p in uniforms_src[u]){parameter_src=uniforms_src[u][p];if(parameter_src instanceof THREE.Color||parameter_src instanceof THREE.Vector2||parameter_src instanceof THREE.Vector3||parameter_src instanceof THREE.Vector4||parameter_src instanceof THREE.Matrix4||parameter_src instanceof THREE.Texture){uniforms_dst[u][p]=parameter_src.clone()}else if(parameter_src instanceof Array){uniforms_dst[u][p]=parameter_src.slice()}else{uniforms_dst[u][p]=parameter_src}}}return uniforms_dst}};THREE.UniformsLib={common:{diffuse:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:null},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)},lightMap:{type:"t",value:null},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},flipEnvMap:{type:"f",value:-1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new THREE.Vector2(1,1)}},fog:{fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new THREE.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},hemisphereLightDirection:{type:"fv",value:[]},hemisphereLightSkyColor:{type:"fv",value:[]},hemisphereLightGroundColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngleCos:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]}},particle:{psColor:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new THREE.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]}}};THREE.ShaderLib={basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["common"],THREE.UniformsLib["fog"],THREE.UniformsLib["shadowmap"]]),vertexShader:[THREE.ShaderChunk["map_pars_vertex"],THREE.ShaderChunk["lightmap_pars_vertex"],THREE.ShaderChunk["envmap_pars_vertex"],THREE.ShaderChunk["color_pars_vertex"],THREE.ShaderChunk["morphtarget_pars_vertex"],THREE.ShaderChunk["skinning_pars_vertex"],THREE.ShaderChunk["shadowmap_pars_vertex"],"void main() {",THREE.ShaderChunk["map_vertex"],THREE.ShaderChunk["lightmap_vertex"],THREE.ShaderChunk["color_vertex"],THREE.ShaderChunk["skinbase_vertex"],"#ifdef USE_ENVMAP",THREE.ShaderChunk["morphnormal_vertex"],THREE.ShaderChunk["skinnormal_vertex"],THREE.ShaderChunk["defaultnormal_vertex"],"#endif",THREE.ShaderChunk["morphtarget_vertex"],THREE.ShaderChunk["skinning_vertex"],THREE.ShaderChunk["default_vertex"],THREE.ShaderChunk["worldpos_vertex"],THREE.ShaderChunk["envmap_vertex"],THREE.ShaderChunk["shadowmap_vertex"],"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;",THREE.ShaderChunk["color_pars_fragment"],THREE.ShaderChunk["map_pars_fragment"],THREE.ShaderChunk["lightmap_pars_fragment"],THREE.ShaderChunk["envmap_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],THREE.ShaderChunk["shadowmap_pars_fragment"],THREE.ShaderChunk["specularmap_pars_fragment"],"void main() {","gl_FragColor = vec4( diffuse, opacity );",THREE.ShaderChunk["map_fragment"],THREE.ShaderChunk["alphatest_fragment"],THREE.ShaderChunk["specularmap_fragment"],THREE.ShaderChunk["lightmap_fragment"],THREE.ShaderChunk["color_fragment"],THREE.ShaderChunk["envmap_fragment"],THREE.ShaderChunk["shadowmap_fragment"],THREE.ShaderChunk["linear_to_gamma_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n")},lambert:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["common"],THREE.UniformsLib["fog"],THREE.UniformsLib["lights"],THREE.UniformsLib["shadowmap"],{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk["map_pars_vertex"],THREE.ShaderChunk["lightmap_pars_vertex"],THREE.ShaderChunk["envmap_pars_vertex"],THREE.ShaderChunk["lights_lambert_pars_vertex"],THREE.ShaderChunk["color_pars_vertex"],THREE.ShaderChunk["morphtarget_pars_vertex"],THREE.ShaderChunk["skinning_pars_vertex"],THREE.ShaderChunk["shadowmap_pars_vertex"],"void main() {",THREE.ShaderChunk["map_vertex"],THREE.ShaderChunk["lightmap_vertex"],THREE.ShaderChunk["color_vertex"],THREE.ShaderChunk["morphnormal_vertex"],THREE.ShaderChunk["skinbase_vertex"],THREE.ShaderChunk["skinnormal_vertex"],THREE.ShaderChunk["defaultnormal_vertex"],THREE.ShaderChunk["morphtarget_vertex"],THREE.ShaderChunk["skinning_vertex"],THREE.ShaderChunk["default_vertex"],THREE.ShaderChunk["worldpos_vertex"],THREE.ShaderChunk["envmap_vertex"],THREE.ShaderChunk["lights_lambert_vertex"],THREE.ShaderChunk["shadowmap_vertex"],"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk["color_pars_fragment"],THREE.ShaderChunk["map_pars_fragment"],THREE.ShaderChunk["lightmap_pars_fragment"],THREE.ShaderChunk["envmap_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],THREE.ShaderChunk["shadowmap_pars_fragment"],THREE.ShaderChunk["specularmap_pars_fragment"],"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk["map_fragment"],THREE.ShaderChunk["alphatest_fragment"],THREE.ShaderChunk["specularmap_fragment"],"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",THREE.ShaderChunk["lightmap_fragment"],THREE.ShaderChunk["color_fragment"],THREE.ShaderChunk["envmap_fragment"],THREE.ShaderChunk["shadowmap_fragment"],THREE.ShaderChunk["linear_to_gamma_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n")},phong:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["common"],THREE.UniformsLib["bump"],THREE.UniformsLib["normalmap"],THREE.UniformsLib["fog"],THREE.UniformsLib["lights"],THREE.UniformsLib["shadowmap"],{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},specular:{type:"c",value:new THREE.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;",THREE.ShaderChunk["map_pars_vertex"],THREE.ShaderChunk["lightmap_pars_vertex"],THREE.ShaderChunk["envmap_pars_vertex"],THREE.ShaderChunk["lights_phong_pars_vertex"],THREE.ShaderChunk["color_pars_vertex"],THREE.ShaderChunk["morphtarget_pars_vertex"],THREE.ShaderChunk["skinning_pars_vertex"],THREE.ShaderChunk["shadowmap_pars_vertex"],"void main() {",THREE.ShaderChunk["map_vertex"],THREE.ShaderChunk["lightmap_vertex"],THREE.ShaderChunk["color_vertex"],THREE.ShaderChunk["morphnormal_vertex"],THREE.ShaderChunk["skinbase_vertex"],THREE.ShaderChunk["skinnormal_vertex"],THREE.ShaderChunk["defaultnormal_vertex"],"vNormal = normalize( transformedNormal );",THREE.ShaderChunk["morphtarget_vertex"],THREE.ShaderChunk["skinning_vertex"],THREE.ShaderChunk["default_vertex"],"vViewPosition = -mvPosition.xyz;",THREE.ShaderChunk["worldpos_vertex"],THREE.ShaderChunk["envmap_vertex"],THREE.ShaderChunk["lights_phong_vertex"],THREE.ShaderChunk["shadowmap_vertex"],"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;",THREE.ShaderChunk["color_pars_fragment"],THREE.ShaderChunk["map_pars_fragment"],THREE.ShaderChunk["lightmap_pars_fragment"],THREE.ShaderChunk["envmap_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],THREE.ShaderChunk["lights_phong_pars_fragment"],THREE.ShaderChunk["shadowmap_pars_fragment"],THREE.ShaderChunk["bumpmap_pars_fragment"],THREE.ShaderChunk["normalmap_pars_fragment"],THREE.ShaderChunk["specularmap_pars_fragment"],"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk["map_fragment"],THREE.ShaderChunk["alphatest_fragment"],THREE.ShaderChunk["specularmap_fragment"],THREE.ShaderChunk["lights_phong_fragment"],THREE.ShaderChunk["lightmap_fragment"],THREE.ShaderChunk["color_fragment"],THREE.ShaderChunk["envmap_fragment"],THREE.ShaderChunk["shadowmap_fragment"],THREE.ShaderChunk["linear_to_gamma_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n")},particle_basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["particle"],THREE.UniformsLib["shadowmap"]]),vertexShader:["uniform float size;","uniform float scale;",THREE.ShaderChunk["color_pars_vertex"],THREE.ShaderChunk["shadowmap_pars_vertex"],"void main() {",THREE.ShaderChunk["color_vertex"],"vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif","gl_Position = projectionMatrix * mvPosition;",THREE.ShaderChunk["worldpos_vertex"],THREE.ShaderChunk["shadowmap_vertex"],"}"].join("\n"),fragmentShader:["uniform vec3 psColor;","uniform float opacity;",THREE.ShaderChunk["color_pars_fragment"],THREE.ShaderChunk["map_particle_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],THREE.ShaderChunk["shadowmap_pars_fragment"],"void main() {","gl_FragColor = vec4( psColor, opacity );",THREE.ShaderChunk["map_particle_fragment"],THREE.ShaderChunk["alphatest_fragment"],THREE.ShaderChunk["color_fragment"],THREE.ShaderChunk["shadowmap_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n")},dashed:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["common"],THREE.UniformsLib["fog"],{scale:{type:"f",value:1},dashSize:{type:"f",value:1},totalSize:{type:"f",value:2}}]),vertexShader:["uniform float scale;","attribute float lineDistance;","varying float vLineDistance;",THREE.ShaderChunk["color_pars_vertex"],"void main() {",THREE.ShaderChunk["color_vertex"],"vLineDistance = scale * lineDistance;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform float dashSize;","uniform float totalSize;","varying float vLineDistance;",THREE.ShaderChunk["color_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],"void main() {","if ( mod( vLineDistance, totalSize ) > dashSize ) {","discard;","}","gl_FragColor = vec4( diffuse, opacity );",THREE.ShaderChunk["color_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n")},depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2e3},opacity:{type:"f",value:1}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float mNear;","uniform float mFar;","uniform float opacity;","void main() {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float color = 1.0 - smoothstep( mNear, mFar, depth );","gl_FragColor = vec4( vec3( color ), opacity );","}"].join("\n")},normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:["varying vec3 vNormal;",THREE.ShaderChunk["morphtarget_pars_vertex"],"void main() {","vNormal = normalize( normalMatrix * normal );",THREE.ShaderChunk["morphtarget_vertex"],THREE.ShaderChunk["default_vertex"],"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vNormal;","void main() {","gl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );","}"].join("\n")},normalmap:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["fog"],THREE.UniformsLib["lights"],THREE.UniformsLib["shadowmap"],{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},enableDisplacement:{type:"i",value:0},tDisplacement:{type:"t",value:null},tDiffuse:{type:"t",value:null},tCube:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tAO:{type:"t",value:null},uNormalScale:{type:"v2",value:new THREE.Vector2(1,1)},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new THREE.Color(16777215)},uSpecularColor:{type:"c",value:new THREE.Color(1118481)},uAmbientColor:{type:"c",value:new THREE.Color(16777215)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},useRefract:{type:"i",value:0},uRefractionRatio:{type:"f",value:.98},uReflectivity:{type:"f",value:.5},uOffset:{type:"v2",value:new THREE.Vector2(0,0)},uRepeat:{type:"v2",value:new THREE.Vector2(1,1)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),fragmentShader:["uniform vec3 uAmbientColor;","uniform vec3 uDiffuseColor;","uniform vec3 uSpecularColor;","uniform float uShininess;","uniform float uOpacity;","uniform bool enableDiffuse;","uniform bool enableSpecular;","uniform bool enableAO;","uniform bool enableReflection;","uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform sampler2D tSpecular;","uniform sampler2D tAO;","uniform samplerCube tCube;","uniform vec2 uNormalScale;","uniform bool useRefract;","uniform float uRefractionRatio;","uniform float uReflectivity;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",THREE.ShaderChunk["shadowmap_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],"void main() {","gl_FragColor = vec4( vec3( 1.0 ), uOpacity );","vec3 specularTex = vec3( 1.0 );","vec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","if( enableDiffuse ) {","#ifdef GAMMA_INPUT","vec4 texelColor = texture2D( tDiffuse, vUv );","texelColor.xyz *= texelColor.xyz;","gl_FragColor = gl_FragColor * texelColor;","#else","gl_FragColor = gl_FragColor * texture2D( tDiffuse, vUv );","#endif","}","if( enableAO ) {","#ifdef GAMMA_INPUT","vec4 aoColor = texture2D( tAO, vUv );","aoColor.xyz *= aoColor.xyz;","gl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;","#else","gl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, vUv ).xyz;","#endif","}","if( enableSpecular )","specularTex = texture2D( tSpecular, vUv ).xyz;","mat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );","vec3 finalNormal = tsb * normalTex;","#ifdef FLIP_SIDED","finalNormal = -finalNormal;","#endif","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 pointVector = lPosition.xyz + vViewPosition.xyz;","float pointDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","pointDistance = 1.0 - min( ( length( pointVector ) / pointLightDistance[ i ] ), 1.0 );","pointVector = normalize( pointVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );","#endif","pointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;","vec3 pointHalfVector = normalize( pointVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( pointVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * pointDistance * specularNormalization;","#else","pointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 spotVector = lPosition.xyz + vViewPosition.xyz;","float spotDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","spotDistance = 1.0 - min( ( length( spotVector ) / spotLightDistance[ i ] ), 1.0 );","spotVector = normalize( spotVector );","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dot( normal, spotVector ), 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dot( normal, spotVector ) + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dot( normal, spotVector ), 0.0 );","#endif","spotDiffuse += spotDistance * spotLightColor[ i ] * uDiffuseColor * spotDiffuseWeight * spotEffect;","vec3 spotHalfVector = normalize( spotVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularTex.r * max( pow( spotDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( spotVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * spotDistance * specularNormalization * spotEffect;","#else","spotSpecular += spotDistance * spotLightColor[ i ] * uSpecularColor * spotSpecularWeight * spotDiffuseWeight * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","#ifdef WRAP_AROUND","float directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );","float directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","#endif","dirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += uDiffuseColor * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularTex.r * max( pow( hemiDotNormalHalfSky, uShininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularTex.r * max( pow( hemiDotNormalHalfGround, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotProductGround = dot( normal, lVectorGround );","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlickSky = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );","vec3 schlickGround = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );","hemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );","#else","hemiSpecular += uSpecularColor * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor ) + totalSpecular;","#endif","if ( enableReflection ) {","vec3 vReflect;","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","vReflect = refract( cameraToVertex, normal, uRefractionRatio );","} else {","vReflect = reflect( cameraToVertex, normal );","}","vec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * uReflectivity );","}",THREE.ShaderChunk["shadowmap_fragment"],THREE.ShaderChunk["linear_to_gamma_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n"),vertexShader:["attribute vec4 tangent;","uniform vec2 uOffset;","uniform vec2 uRepeat;","uniform bool enableDisplacement;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",THREE.ShaderChunk["skinning_pars_vertex"],THREE.ShaderChunk["shadowmap_pars_vertex"],"void main() {",THREE.ShaderChunk["skinbase_vertex"],THREE.ShaderChunk["skinnormal_vertex"],"#ifdef USE_SKINNING","vNormal = normalize( normalMatrix * skinnedNormal.xyz );","vec4 skinnedTangent = skinMatrix * vec4( tangent.xyz, 0.0 );","vTangent = normalize( normalMatrix * skinnedTangent.xyz );","#else","vNormal = normalize( normalMatrix * normal );","vTangent = normalize( normalMatrix * tangent.xyz );","#endif","vBinormal = normalize( cross( vNormal, vTangent ) * tangent.w );","vUv = uv * uRepeat + uOffset;","vec3 displacedPosition;","#ifdef VERTEX_TEXTURES","if ( enableDisplacement ) {","vec3 dv = texture2D( tDisplacement, uv ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","displacedPosition = position + normalize( normal ) * df;","} else {","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","}","#else","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","#endif","vec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );","vec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );","gl_Position = projectionMatrix * mvPosition;","vWorldPosition = worldPosition.xyz;","vViewPosition = -mvPosition.xyz;","#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;","}","#endif","}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","uniform float tFlip;","varying vec3 vWorldPosition;","void main() {","gl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );","}"].join("\n")},depthRGBA:{uniforms:{},vertexShader:[THREE.ShaderChunk["morphtarget_pars_vertex"],THREE.ShaderChunk["skinning_pars_vertex"],"void main() {",THREE.ShaderChunk["skinbase_vertex"],THREE.ShaderChunk["morphtarget_vertex"],THREE.ShaderChunk["skinning_vertex"],THREE.ShaderChunk["default_vertex"],"}"].join("\n"),fragmentShader:["vec4 pack_depth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = fract( depth * bit_shift );","res -= res.xxyz * bit_mask;","return res;","}","void main() {","gl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );","}"].join("\n")}};THREE.WebGLRenderer=function(parameters){console.log("THREE.WebGLRenderer",THREE.REVISION);parameters=parameters||{};var _canvas=parameters.canvas!==undefined?parameters.canvas:document.createElement("canvas"),_precision=parameters.precision!==undefined?parameters.precision:"highp",_alpha=parameters.alpha!==undefined?parameters.alpha:true,_premultipliedAlpha=parameters.premultipliedAlpha!==undefined?parameters.premultipliedAlpha:true,_antialias=parameters.antialias!==undefined?parameters.antialias:false,_stencil=parameters.stencil!==undefined?parameters.stencil:true,_preserveDrawingBuffer=parameters.preserveDrawingBuffer!==undefined?parameters.preserveDrawingBuffer:false,_clearColor=new THREE.Color(0),_clearAlpha=0;if(parameters.clearColor!==undefined){console.warn("DEPRECATED: clearColor in WebGLRenderer constructor parameters is being removed. Use .setClearColor() instead.");_clearColor.setHex(parameters.clearColor)}if(parameters.clearAlpha!==undefined){console.warn("DEPRECATED: clearAlpha in WebGLRenderer constructor parameters is being removed. Use .setClearColor() instead.");_clearAlpha=parameters.clearAlpha}this.domElement=_canvas;this.context=null;this.devicePixelRatio=parameters.devicePixelRatio!==undefined?parameters.devicePixelRatio:window.devicePixelRatio!==undefined?window.devicePixelRatio:1;this.autoClear=true;this.autoClearColor=true;this.autoClearDepth=true;this.autoClearStencil=true;this.sortObjects=true;this.autoUpdateObjects=true;this.gammaInput=false;this.gammaOutput=false;this.physicallyBasedShading=false;this.shadowMapEnabled=false;this.shadowMapAutoUpdate=true;this.shadowMapType=THREE.PCFShadowMap;this.shadowMapCullFace=THREE.CullFaceFront;this.shadowMapDebug=false;this.shadowMapCascade=false;this.maxMorphTargets=8;this.maxMorphNormals=4;this.autoScaleCubemaps=true;this.renderPluginsPre=[];this.renderPluginsPost=[];this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}};var _this=this,_programs=[],_programs_counter=0,_currentProgram=null,_currentFramebuffer=null,_currentMaterialId=-1,_currentGeometryGroupHash=null,_currentCamera=null,_geometryGroupCounter=0,_usedTextureUnits=0,_oldDoubleSided=-1,_oldFlipSided=-1,_oldBlending=-1,_oldBlendEquation=-1,_oldBlendSrc=-1,_oldBlendDst=-1,_oldDepthTest=-1,_oldDepthWrite=-1,_oldPolygonOffset=null,_oldPolygonOffsetFactor=null,_oldPolygonOffsetUnits=null,_oldLineWidth=null,_viewportX=0,_viewportY=0,_viewportWidth=0,_viewportHeight=0,_currentWidth=0,_currentHeight=0,_enabledAttributes={},_frustum=new THREE.Frustum,_projScreenMatrix=new THREE.Matrix4,_projScreenMatrixPS=new THREE.Matrix4,_vector3=new THREE.Vector3,_direction=new THREE.Vector3,_lightsNeedUpdate=true,_lights={ambient:[0,0,0],directional:{length:0,colors:new Array,positions:new Array},point:{length:0,colors:new Array,positions:new Array,distances:new Array},spot:{length:0,colors:new Array,positions:new Array,distances:new Array,directions:new Array,anglesCos:new Array,exponents:new Array},hemi:{length:0,skyColors:new Array,groundColors:new Array,positions:new Array}};var _gl;var _glExtensionTextureFloat;var _glExtensionStandardDerivatives;var _glExtensionTextureFilterAnisotropic;var _glExtensionCompressedTextureS3TC;initGL();setDefaultGLState();this.context=_gl;var _maxTextures=_gl.getParameter(_gl.MAX_TEXTURE_IMAGE_UNITS);var _maxVertexTextures=_gl.getParameter(_gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS);var _maxTextureSize=_gl.getParameter(_gl.MAX_TEXTURE_SIZE);var _maxCubemapSize=_gl.getParameter(_gl.MAX_CUBE_MAP_TEXTURE_SIZE);var _maxAnisotropy=_glExtensionTextureFilterAnisotropic?_gl.getParameter(_glExtensionTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0;var _supportsVertexTextures=_maxVertexTextures>0;var _supportsBoneTextures=_supportsVertexTextures&&_glExtensionTextureFloat;var _compressedTextureFormats=_glExtensionCompressedTextureS3TC?_gl.getParameter(_gl.COMPRESSED_TEXTURE_FORMATS):[];var _vertexShaderPrecisionHighpFloat=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.HIGH_FLOAT);
var _vertexShaderPrecisionMediumpFloat=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.MEDIUM_FLOAT);var _vertexShaderPrecisionLowpFloat=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.LOW_FLOAT);var _fragmentShaderPrecisionHighpFloat=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.HIGH_FLOAT);var _fragmentShaderPrecisionMediumpFloat=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.MEDIUM_FLOAT);var _fragmentShaderPrecisionLowpFloat=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.LOW_FLOAT);var _vertexShaderPrecisionHighpInt=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.HIGH_INT);var _vertexShaderPrecisionMediumpInt=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.MEDIUM_INT);var _vertexShaderPrecisionLowpInt=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.LOW_INT);var _fragmentShaderPrecisionHighpInt=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.HIGH_INT);var _fragmentShaderPrecisionMediumpInt=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.MEDIUM_INT);var _fragmentShaderPrecisionLowpInt=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.LOW_INT);var highpAvailable=_vertexShaderPrecisionHighpFloat.precision>0&&_fragmentShaderPrecisionHighpFloat.precision>0;var mediumpAvailable=_vertexShaderPrecisionMediumpFloat.precision>0&&_fragmentShaderPrecisionMediumpFloat.precision>0;if(_precision==="highp"&&!highpAvailable){if(mediumpAvailable){_precision="mediump";console.warn("WebGLRenderer: highp not supported, using mediump")}else{_precision="lowp";console.warn("WebGLRenderer: highp and mediump not supported, using lowp")}}if(_precision==="mediump"&&!mediumpAvailable){_precision="lowp";console.warn("WebGLRenderer: mediump not supported, using lowp")}this.getContext=function(){return _gl};this.supportsVertexTextures=function(){return _supportsVertexTextures};this.supportsFloatTextures=function(){return _glExtensionTextureFloat};this.supportsStandardDerivatives=function(){return _glExtensionStandardDerivatives};this.supportsCompressedTextureS3TC=function(){return _glExtensionCompressedTextureS3TC};this.getMaxAnisotropy=function(){return _maxAnisotropy};this.getPrecision=function(){return _precision};this.setSize=function(width,height,updateStyle){_canvas.width=width*this.devicePixelRatio;_canvas.height=height*this.devicePixelRatio;if(this.devicePixelRatio!==1&&updateStyle!==false){_canvas.style.width=width+"px";_canvas.style.height=height+"px"}this.setViewport(0,0,_canvas.width,_canvas.height)};this.setViewport=function(x,y,width,height){_viewportX=x!==undefined?x:0;_viewportY=y!==undefined?y:0;_viewportWidth=width!==undefined?width:_canvas.width;_viewportHeight=height!==undefined?height:_canvas.height;_gl.viewport(_viewportX,_viewportY,_viewportWidth,_viewportHeight)};this.setScissor=function(x,y,width,height){_gl.scissor(x,y,width,height)};this.enableScissorTest=function(enable){enable?_gl.enable(_gl.SCISSOR_TEST):_gl.disable(_gl.SCISSOR_TEST)};this.setClearColor=function(color,alpha){_clearColor.set(color);_clearAlpha=alpha!==undefined?alpha:1;_gl.clearColor(_clearColor.r,_clearColor.g,_clearColor.b,_clearAlpha)};this.setClearColorHex=function(hex,alpha){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(hex,alpha)};this.getClearColor=function(){return _clearColor};this.getClearAlpha=function(){return _clearAlpha};this.clear=function(color,depth,stencil){var bits=0;if(color===undefined||color)bits|=_gl.COLOR_BUFFER_BIT;if(depth===undefined||depth)bits|=_gl.DEPTH_BUFFER_BIT;if(stencil===undefined||stencil)bits|=_gl.STENCIL_BUFFER_BIT;_gl.clear(bits)};this.clearTarget=function(renderTarget,color,depth,stencil){this.setRenderTarget(renderTarget);this.clear(color,depth,stencil)};this.addPostPlugin=function(plugin){plugin.init(this);this.renderPluginsPost.push(plugin)};this.addPrePlugin=function(plugin){plugin.init(this);this.renderPluginsPre.push(plugin)};this.updateShadowMap=function(scene,camera){_currentProgram=null;_oldBlending=-1;_oldDepthTest=-1;_oldDepthWrite=-1;_currentGeometryGroupHash=-1;_currentMaterialId=-1;_lightsNeedUpdate=true;_oldDoubleSided=-1;_oldFlipSided=-1;this.shadowMapPlugin.update(scene,camera)};function createParticleBuffers(geometry){geometry.__webglVertexBuffer=_gl.createBuffer();geometry.__webglColorBuffer=_gl.createBuffer();_this.info.memory.geometries++}function createLineBuffers(geometry){geometry.__webglVertexBuffer=_gl.createBuffer();geometry.__webglColorBuffer=_gl.createBuffer();geometry.__webglLineDistanceBuffer=_gl.createBuffer();_this.info.memory.geometries++}function createRibbonBuffers(geometry){geometry.__webglVertexBuffer=_gl.createBuffer();geometry.__webglColorBuffer=_gl.createBuffer();geometry.__webglNormalBuffer=_gl.createBuffer();_this.info.memory.geometries++}function createMeshBuffers(geometryGroup){geometryGroup.__webglVertexBuffer=_gl.createBuffer();geometryGroup.__webglNormalBuffer=_gl.createBuffer();geometryGroup.__webglTangentBuffer=_gl.createBuffer();geometryGroup.__webglColorBuffer=_gl.createBuffer();geometryGroup.__webglUVBuffer=_gl.createBuffer();geometryGroup.__webglUV2Buffer=_gl.createBuffer();geometryGroup.__webglSkinIndicesBuffer=_gl.createBuffer();geometryGroup.__webglSkinWeightsBuffer=_gl.createBuffer();geometryGroup.__webglFaceBuffer=_gl.createBuffer();geometryGroup.__webglLineBuffer=_gl.createBuffer();var m,ml;if(geometryGroup.numMorphTargets){geometryGroup.__webglMorphTargetsBuffers=[];for(m=0,ml=geometryGroup.numMorphTargets;m<ml;m++){geometryGroup.__webglMorphTargetsBuffers.push(_gl.createBuffer())}}if(geometryGroup.numMorphNormals){geometryGroup.__webglMorphNormalsBuffers=[];for(m=0,ml=geometryGroup.numMorphNormals;m<ml;m++){geometryGroup.__webglMorphNormalsBuffers.push(_gl.createBuffer())}}_this.info.memory.geometries++}var onGeometryDispose=function(event){var geometry=event.target;geometry.removeEventListener("dispose",onGeometryDispose);deallocateGeometry(geometry);_this.info.memory.geometries--};var onTextureDispose=function(event){var texture=event.target;texture.removeEventListener("dispose",onTextureDispose);deallocateTexture(texture);_this.info.memory.textures--};var onRenderTargetDispose=function(event){var renderTarget=event.target;renderTarget.removeEventListener("dispose",onRenderTargetDispose);deallocateRenderTarget(renderTarget);_this.info.memory.textures--};var onMaterialDispose=function(event){var material=event.target;material.removeEventListener("dispose",onMaterialDispose);deallocateMaterial(material)};var deallocateGeometry=function(geometry){geometry.__webglInit=undefined;if(geometry.__webglVertexBuffer!==undefined)_gl.deleteBuffer(geometry.__webglVertexBuffer);if(geometry.__webglNormalBuffer!==undefined)_gl.deleteBuffer(geometry.__webglNormalBuffer);if(geometry.__webglTangentBuffer!==undefined)_gl.deleteBuffer(geometry.__webglTangentBuffer);if(geometry.__webglColorBuffer!==undefined)_gl.deleteBuffer(geometry.__webglColorBuffer);if(geometry.__webglUVBuffer!==undefined)_gl.deleteBuffer(geometry.__webglUVBuffer);if(geometry.__webglUV2Buffer!==undefined)_gl.deleteBuffer(geometry.__webglUV2Buffer);if(geometry.__webglSkinIndicesBuffer!==undefined)_gl.deleteBuffer(geometry.__webglSkinIndicesBuffer);if(geometry.__webglSkinWeightsBuffer!==undefined)_gl.deleteBuffer(geometry.__webglSkinWeightsBuffer);if(geometry.__webglFaceBuffer!==undefined)_gl.deleteBuffer(geometry.__webglFaceBuffer);if(geometry.__webglLineBuffer!==undefined)_gl.deleteBuffer(geometry.__webglLineBuffer);if(geometry.__webglLineDistanceBuffer!==undefined)_gl.deleteBuffer(geometry.__webglLineDistanceBuffer);if(geometry.geometryGroups!==undefined){for(var g in geometry.geometryGroups){var geometryGroup=geometry.geometryGroups[g];if(geometryGroup.numMorphTargets!==undefined){for(var m=0,ml=geometryGroup.numMorphTargets;m<ml;m++){_gl.deleteBuffer(geometryGroup.__webglMorphTargetsBuffers[m])}}if(geometryGroup.numMorphNormals!==undefined){for(var m=0,ml=geometryGroup.numMorphNormals;m<ml;m++){_gl.deleteBuffer(geometryGroup.__webglMorphNormalsBuffers[m])}}deleteCustomAttributesBuffers(geometryGroup)}}deleteCustomAttributesBuffers(geometry)};var deallocateTexture=function(texture){if(texture.image&&texture.image.__webglTextureCube){_gl.deleteTexture(texture.image.__webglTextureCube)}else{if(!texture.__webglInit)return;texture.__webglInit=false;_gl.deleteTexture(texture.__webglTexture)}};var deallocateRenderTarget=function(renderTarget){if(!renderTarget||!renderTarget.__webglTexture)return;_gl.deleteTexture(renderTarget.__webglTexture);if(renderTarget instanceof THREE.WebGLRenderTargetCube){for(var i=0;i<6;i++){_gl.deleteFramebuffer(renderTarget.__webglFramebuffer[i]);_gl.deleteRenderbuffer(renderTarget.__webglRenderbuffer[i])}}else{_gl.deleteFramebuffer(renderTarget.__webglFramebuffer);_gl.deleteRenderbuffer(renderTarget.__webglRenderbuffer)}};var deallocateMaterial=function(material){var program=material.program;if(program===undefined)return;material.program=undefined;var i,il,programInfo;var deleteProgram=false;for(i=0,il=_programs.length;i<il;i++){programInfo=_programs[i];if(programInfo.program===program){programInfo.usedTimes--;if(programInfo.usedTimes===0){deleteProgram=true}break}}if(deleteProgram===true){var newPrograms=[];for(i=0,il=_programs.length;i<il;i++){programInfo=_programs[i];if(programInfo.program!==program){newPrograms.push(programInfo)}}_programs=newPrograms;_gl.deleteProgram(program);_this.info.memory.programs--}};function deleteCustomAttributesBuffers(geometry){if(geometry.__webglCustomAttributesList){for(var id in geometry.__webglCustomAttributesList){_gl.deleteBuffer(geometry.__webglCustomAttributesList[id].buffer)}}}function initCustomAttributes(geometry,object){var nvertices=geometry.vertices.length;var material=object.material;if(material.attributes){if(geometry.__webglCustomAttributesList===undefined){geometry.__webglCustomAttributesList=[]}for(var a in material.attributes){var attribute=material.attributes[a];if(!attribute.__webglInitialized||attribute.createUniqueBuffers){attribute.__webglInitialized=true;var size=1;if(attribute.type==="v2")size=2;else if(attribute.type==="v3")size=3;else if(attribute.type==="v4")size=4;else if(attribute.type==="c")size=3;attribute.size=size;attribute.array=new Float32Array(nvertices*size);attribute.buffer=_gl.createBuffer();attribute.buffer.belongsToAttribute=a;attribute.needsUpdate=true}geometry.__webglCustomAttributesList.push(attribute)}}}function initParticleBuffers(geometry,object){var nvertices=geometry.vertices.length;geometry.__vertexArray=new Float32Array(nvertices*3);geometry.__colorArray=new Float32Array(nvertices*3);geometry.__sortArray=[];geometry.__webglParticleCount=nvertices;initCustomAttributes(geometry,object)}function initLineBuffers(geometry,object){var nvertices=geometry.vertices.length;geometry.__vertexArray=new Float32Array(nvertices*3);geometry.__colorArray=new Float32Array(nvertices*3);geometry.__lineDistanceArray=new Float32Array(nvertices*1);geometry.__webglLineCount=nvertices;initCustomAttributes(geometry,object)}function initRibbonBuffers(geometry,object){var nvertices=geometry.vertices.length;geometry.__vertexArray=new Float32Array(nvertices*3);geometry.__colorArray=new Float32Array(nvertices*3);geometry.__normalArray=new Float32Array(nvertices*3);geometry.__webglVertexCount=nvertices;initCustomAttributes(geometry,object)}function initMeshBuffers(geometryGroup,object){var geometry=object.geometry,faces3=geometryGroup.faces3,faces4=geometryGroup.faces4,nvertices=faces3.length*3+faces4.length*4,ntris=faces3.length*1+faces4.length*2,nlines=faces3.length*3+faces4.length*4,material=getBufferMaterial(object,geometryGroup),uvType=bufferGuessUVType(material),normalType=bufferGuessNormalType(material),vertexColorType=bufferGuessVertexColorType(material);geometryGroup.__vertexArray=new Float32Array(nvertices*3);if(normalType){geometryGroup.__normalArray=new Float32Array(nvertices*3)}if(geometry.hasTangents){geometryGroup.__tangentArray=new Float32Array(nvertices*4)}if(vertexColorType){geometryGroup.__colorArray=new Float32Array(nvertices*3)}if(uvType){if(geometry.faceUvs.length>0||geometry.faceVertexUvs.length>0){geometryGroup.__uvArray=new Float32Array(nvertices*2)}if(geometry.faceUvs.length>1||geometry.faceVertexUvs.length>1){geometryGroup.__uv2Array=new Float32Array(nvertices*2)}}if(object.geometry.skinWeights.length&&object.geometry.skinIndices.length){geometryGroup.__skinIndexArray=new Float32Array(nvertices*4);geometryGroup.__skinWeightArray=new Float32Array(nvertices*4)}geometryGroup.__faceArray=new Uint16Array(ntris*3);geometryGroup.__lineArray=new Uint16Array(nlines*2);var m,ml;if(geometryGroup.numMorphTargets){geometryGroup.__morphTargetsArrays=[];for(m=0,ml=geometryGroup.numMorphTargets;m<ml;m++){geometryGroup.__morphTargetsArrays.push(new Float32Array(nvertices*3))}}if(geometryGroup.numMorphNormals){geometryGroup.__morphNormalsArrays=[];for(m=0,ml=geometryGroup.numMorphNormals;m<ml;m++){geometryGroup.__morphNormalsArrays.push(new Float32Array(nvertices*3))}}geometryGroup.__webglFaceCount=ntris*3;geometryGroup.__webglLineCount=nlines*2;if(material.attributes){if(geometryGroup.__webglCustomAttributesList===undefined){geometryGroup.__webglCustomAttributesList=[]}for(var a in material.attributes){var originalAttribute=material.attributes[a];var attribute={};for(var property in originalAttribute){attribute[property]=originalAttribute[property]}if(!attribute.__webglInitialized||attribute.createUniqueBuffers){attribute.__webglInitialized=true;var size=1;if(attribute.type==="v2")size=2;else if(attribute.type==="v3")size=3;else if(attribute.type==="v4")size=4;else if(attribute.type==="c")size=3;attribute.size=size;attribute.array=new Float32Array(nvertices*size);attribute.buffer=_gl.createBuffer();attribute.buffer.belongsToAttribute=a;originalAttribute.needsUpdate=true;attribute.__original=originalAttribute}geometryGroup.__webglCustomAttributesList.push(attribute)}}geometryGroup.__inittedArrays=true}function getBufferMaterial(object,geometryGroup){return object.material instanceof THREE.MeshFaceMaterial?object.material.materials[geometryGroup.materialIndex]:object.material}function materialNeedsSmoothNormals(material){return material&&material.shading!==undefined&&material.shading===THREE.SmoothShading}function bufferGuessNormalType(material){if(material instanceof THREE.MeshBasicMaterial&&!material.envMap||material instanceof THREE.MeshDepthMaterial){return false}if(materialNeedsSmoothNormals(material)){return THREE.SmoothShading}else{return THREE.FlatShading}}function bufferGuessVertexColorType(material){if(material.vertexColors){return material.vertexColors}return false}function bufferGuessUVType(material){if(material.map||material.lightMap||material.bumpMap||material.normalMap||material.specularMap||material instanceof THREE.ShaderMaterial){return true}return false}function initDirectBuffers(geometry){var a,attribute,type;for(a in geometry.attributes){if(a==="index"){type=_gl.ELEMENT_ARRAY_BUFFER}else{type=_gl.ARRAY_BUFFER}attribute=geometry.attributes[a];attribute.buffer=_gl.createBuffer();_gl.bindBuffer(type,attribute.buffer);_gl.bufferData(type,attribute.array,_gl.STATIC_DRAW)}}function setParticleBuffers(geometry,hint,object){var v,c,vertex,offset,index,color,vertices=geometry.vertices,vl=vertices.length,colors=geometry.colors,cl=colors.length,vertexArray=geometry.__vertexArray,colorArray=geometry.__colorArray,sortArray=geometry.__sortArray,dirtyVertices=geometry.verticesNeedUpdate,dirtyElements=geometry.elementsNeedUpdate,dirtyColors=geometry.colorsNeedUpdate,customAttributes=geometry.__webglCustomAttributesList,i,il,a,ca,cal,value,customAttribute;if(object.sortParticles){_projScreenMatrixPS.copy(_projScreenMatrix);_projScreenMatrixPS.multiply(object.matrixWorld);for(v=0;v<vl;v++){vertex=vertices[v];_vector3.copy(vertex);_vector3.applyProjection(_projScreenMatrixPS);sortArray[v]=[_vector3.z,v]}sortArray.sort(numericalSort);for(v=0;v<vl;v++){vertex=vertices[sortArray[v][1]];offset=v*3;vertexArray[offset]=vertex.x;vertexArray[offset+1]=vertex.y;vertexArray[offset+2]=vertex.z}for(c=0;c<cl;c++){offset=c*3;color=colors[sortArray[c][1]];colorArray[offset]=color.r;colorArray[offset+1]=color.g;colorArray[offset+2]=color.b}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(!(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices"))continue;offset=0;cal=customAttribute.value.length;if(customAttribute.size===1){for(ca=0;ca<cal;ca++){index=sortArray[ca][1];customAttribute.array[ca]=customAttribute.value[index]}}else if(customAttribute.size===2){for(ca=0;ca<cal;ca++){index=sortArray[ca][1];value=customAttribute.value[index];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;offset+=2}}else if(customAttribute.size===3){if(customAttribute.type==="c"){for(ca=0;ca<cal;ca++){index=sortArray[ca][1];value=customAttribute.value[index];customAttribute.array[offset]=value.r;customAttribute.array[offset+1]=value.g;customAttribute.array[offset+2]=value.b;offset+=3}}else{for(ca=0;ca<cal;ca++){index=sortArray[ca][1];value=customAttribute.value[index];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;offset+=3}}}else if(customAttribute.size===4){for(ca=0;ca<cal;ca++){index=sortArray[ca][1];value=customAttribute.value[index];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;customAttribute.array[offset+3]=value.w;offset+=4}}}}}else{if(dirtyVertices){for(v=0;v<vl;v++){vertex=vertices[v];offset=v*3;vertexArray[offset]=vertex.x;vertexArray[offset+1]=vertex.y;vertexArray[offset+2]=vertex.z}}if(dirtyColors){for(c=0;c<cl;c++){color=colors[c];offset=c*3;colorArray[offset]=color.r;colorArray[offset+1]=color.g;colorArray[offset+2]=color.b}}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(customAttribute.needsUpdate&&(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices")){cal=customAttribute.value.length;offset=0;if(customAttribute.size===1){for(ca=0;ca<cal;ca++){customAttribute.array[ca]=customAttribute.value[ca]}}else if(customAttribute.size===2){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;offset+=2}}else if(customAttribute.size===3){if(customAttribute.type==="c"){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.r;customAttribute.array[offset+1]=value.g;customAttribute.array[offset+2]=value.b;offset+=3}}else{for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;offset+=3}}}else if(customAttribute.size===4){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;customAttribute.array[offset+3]=value.w;offset+=4}}}}}}if(dirtyVertices||object.sortParticles){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglVertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,vertexArray,hint)}if(dirtyColors||object.sortParticles){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglColorBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,colorArray,hint)}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(customAttribute.needsUpdate||object.sortParticles){_gl.bindBuffer(_gl.ARRAY_BUFFER,customAttribute.buffer);_gl.bufferData(_gl.ARRAY_BUFFER,customAttribute.array,hint)}}}}function setLineBuffers(geometry,hint){var v,c,d,vertex,offset,color,vertices=geometry.vertices,colors=geometry.colors,lineDistances=geometry.lineDistances,vl=vertices.length,cl=colors.length,dl=lineDistances.length,vertexArray=geometry.__vertexArray,colorArray=geometry.__colorArray,lineDistanceArray=geometry.__lineDistanceArray,dirtyVertices=geometry.verticesNeedUpdate,dirtyColors=geometry.colorsNeedUpdate,dirtyLineDistances=geometry.lineDistancesNeedUpdate,customAttributes=geometry.__webglCustomAttributesList,i,il,a,ca,cal,value,customAttribute;if(dirtyVertices){for(v=0;v<vl;v++){vertex=vertices[v];offset=v*3;vertexArray[offset]=vertex.x;vertexArray[offset+1]=vertex.y;vertexArray[offset+2]=vertex.z}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglVertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,vertexArray,hint)}if(dirtyColors){for(c=0;c<cl;c++){color=colors[c];offset=c*3;colorArray[offset]=color.r;colorArray[offset+1]=color.g;colorArray[offset+2]=color.b}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglColorBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,colorArray,hint)}if(dirtyLineDistances){for(d=0;d<dl;d++){lineDistanceArray[d]=lineDistances[d]}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglLineDistanceBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,lineDistanceArray,hint)}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(customAttribute.needsUpdate&&(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices")){offset=0;cal=customAttribute.value.length;if(customAttribute.size===1){for(ca=0;ca<cal;ca++){customAttribute.array[ca]=customAttribute.value[ca]}}else if(customAttribute.size===2){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;offset+=2}}else if(customAttribute.size===3){if(customAttribute.type==="c"){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.r;customAttribute.array[offset+1]=value.g;customAttribute.array[offset+2]=value.b;offset+=3}}else{for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;offset+=3}}}else if(customAttribute.size===4){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;customAttribute.array[offset+3]=value.w;offset+=4}}_gl.bindBuffer(_gl.ARRAY_BUFFER,customAttribute.buffer);_gl.bufferData(_gl.ARRAY_BUFFER,customAttribute.array,hint)}}}}function setRibbonBuffers(geometry,hint){var v,c,n,vertex,offset,color,normal,i,il,ca,cal,customAttribute,value,vertices=geometry.vertices,colors=geometry.colors,normals=geometry.normals,vl=vertices.length,cl=colors.length,nl=normals.length,vertexArray=geometry.__vertexArray,colorArray=geometry.__colorArray,normalArray=geometry.__normalArray,dirtyVertices=geometry.verticesNeedUpdate,dirtyColors=geometry.colorsNeedUpdate,dirtyNormals=geometry.normalsNeedUpdate,customAttributes=geometry.__webglCustomAttributesList;if(dirtyVertices){for(v=0;v<vl;v++){vertex=vertices[v];offset=v*3;vertexArray[offset]=vertex.x;vertexArray[offset+1]=vertex.y;vertexArray[offset+2]=vertex.z}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglVertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,vertexArray,hint)}if(dirtyColors){for(c=0;c<cl;c++){color=colors[c];offset=c*3;colorArray[offset]=color.r;colorArray[offset+1]=color.g;colorArray[offset+2]=color.b}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglColorBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,colorArray,hint)}if(dirtyNormals){for(n=0;n<nl;n++){normal=normals[n];offset=n*3;normalArray[offset]=normal.x;normalArray[offset+1]=normal.y;normalArray[offset+2]=normal.z}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglNormalBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,normalArray,hint)}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(customAttribute.needsUpdate&&(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices")){offset=0;cal=customAttribute.value.length;if(customAttribute.size===1){for(ca=0;ca<cal;ca++){customAttribute.array[ca]=customAttribute.value[ca]}}else if(customAttribute.size===2){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;offset+=2}}else if(customAttribute.size===3){if(customAttribute.type==="c"){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.r;customAttribute.array[offset+1]=value.g;customAttribute.array[offset+2]=value.b;offset+=3}}else{for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;offset+=3}}}else if(customAttribute.size===4){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;customAttribute.array[offset+3]=value.w;offset+=4}}_gl.bindBuffer(_gl.ARRAY_BUFFER,customAttribute.buffer);_gl.bufferData(_gl.ARRAY_BUFFER,customAttribute.array,hint)}}}}function setMeshBuffers(geometryGroup,object,hint,dispose,material){if(!geometryGroup.__inittedArrays){return}var normalType=bufferGuessNormalType(material),vertexColorType=bufferGuessVertexColorType(material),uvType=bufferGuessUVType(material),needsSmoothNormals=normalType===THREE.SmoothShading;var f,fl,fi,face,vertexNormals,faceNormal,normal,vertexColors,faceColor,vertexTangents,uv,uv2,v1,v2,v3,v4,t1,t2,t3,t4,n1,n2,n3,n4,c1,c2,c3,c4,sw1,sw2,sw3,sw4,si1,si2,si3,si4,sa1,sa2,sa3,sa4,sb1,sb2,sb3,sb4,m,ml,i,il,vn,uvi,uv2i,vk,vkl,vka,nka,chf,faceVertexNormals,a,vertexIndex=0,offset=0,offset_uv=0,offset_uv2=0,offset_face=0,offset_normal=0,offset_tangent=0,offset_line=0,offset_color=0,offset_skin=0,offset_morphTarget=0,offset_custom=0,offset_customSrc=0,value,vertexArray=geometryGroup.__vertexArray,uvArray=geometryGroup.__uvArray,uv2Array=geometryGroup.__uv2Array,normalArray=geometryGroup.__normalArray,tangentArray=geometryGroup.__tangentArray,colorArray=geometryGroup.__colorArray,skinIndexArray=geometryGroup.__skinIndexArray,skinWeightArray=geometryGroup.__skinWeightArray,morphTargetsArrays=geometryGroup.__morphTargetsArrays,morphNormalsArrays=geometryGroup.__morphNormalsArrays,customAttributes=geometryGroup.__webglCustomAttributesList,customAttribute,faceArray=geometryGroup.__faceArray,lineArray=geometryGroup.__lineArray,geometry=object.geometry,dirtyVertices=geometry.verticesNeedUpdate,dirtyElements=geometry.elementsNeedUpdate,dirtyUvs=geometry.uvsNeedUpdate,dirtyNormals=geometry.normalsNeedUpdate,dirtyTangents=geometry.tangentsNeedUpdate,dirtyColors=geometry.colorsNeedUpdate,dirtyMorphTargets=geometry.morphTargetsNeedUpdate,vertices=geometry.vertices,chunk_faces3=geometryGroup.faces3,chunk_faces4=geometryGroup.faces4,obj_faces=geometry.faces,obj_uvs=geometry.faceVertexUvs[0],obj_uvs2=geometry.faceVertexUvs[1],obj_colors=geometry.colors,obj_skinIndices=geometry.skinIndices,obj_skinWeights=geometry.skinWeights,morphTargets=geometry.morphTargets,morphNormals=geometry.morphNormals;if(dirtyVertices){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];v1=vertices[face.a];v2=vertices[face.b];v3=vertices[face.c];vertexArray[offset]=v1.x;vertexArray[offset+1]=v1.y;vertexArray[offset+2]=v1.z;vertexArray[offset+3]=v2.x;vertexArray[offset+4]=v2.y;vertexArray[offset+5]=v2.z;vertexArray[offset+6]=v3.x;vertexArray[offset+7]=v3.y;vertexArray[offset+8]=v3.z;offset+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];v1=vertices[face.a];v2=vertices[face.b];v3=vertices[face.c];v4=vertices[face.d];vertexArray[offset]=v1.x;vertexArray[offset+1]=v1.y;vertexArray[offset+2]=v1.z;vertexArray[offset+3]=v2.x;vertexArray[offset+4]=v2.y;vertexArray[offset+5]=v2.z;vertexArray[offset+6]=v3.x;vertexArray[offset+7]=v3.y;vertexArray[offset+8]=v3.z;vertexArray[offset+9]=v4.x;vertexArray[offset+10]=v4.y;vertexArray[offset+11]=v4.z;offset+=12}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglVertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,vertexArray,hint)}if(dirtyMorphTargets){for(vk=0,vkl=morphTargets.length;vk<vkl;vk++){offset_morphTarget=0;for(f=0,fl=chunk_faces3.length;f<fl;f++){chf=chunk_faces3[f];face=obj_faces[chf];v1=morphTargets[vk].vertices[face.a];v2=morphTargets[vk].vertices[face.b];v3=morphTargets[vk].vertices[face.c];vka=morphTargetsArrays[vk];vka[offset_morphTarget]=v1.x;vka[offset_morphTarget+1]=v1.y;vka[offset_morphTarget+2]=v1.z;vka[offset_morphTarget+3]=v2.x;vka[offset_morphTarget+4]=v2.y;vka[offset_morphTarget+5]=v2.z;vka[offset_morphTarget+6]=v3.x;vka[offset_morphTarget+7]=v3.y;vka[offset_morphTarget+8]=v3.z;if(material.morphNormals){if(needsSmoothNormals){faceVertexNormals=morphNormals[vk].vertexNormals[chf];n1=faceVertexNormals.a;n2=faceVertexNormals.b;n3=faceVertexNormals.c}else{n1=morphNormals[vk].faceNormals[chf];n2=n1;n3=n1}nka=morphNormalsArrays[vk];nka[offset_morphTarget]=n1.x;nka[offset_morphTarget+1]=n1.y;nka[offset_morphTarget+2]=n1.z;nka[offset_morphTarget+3]=n2.x;nka[offset_morphTarget+4]=n2.y;nka[offset_morphTarget+5]=n2.z;nka[offset_morphTarget+6]=n3.x;nka[offset_morphTarget+7]=n3.y;nka[offset_morphTarget+8]=n3.z}offset_morphTarget+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){chf=chunk_faces4[f];face=obj_faces[chf];v1=morphTargets[vk].vertices[face.a];v2=morphTargets[vk].vertices[face.b];v3=morphTargets[vk].vertices[face.c];v4=morphTargets[vk].vertices[face.d];vka=morphTargetsArrays[vk];vka[offset_morphTarget]=v1.x;vka[offset_morphTarget+1]=v1.y;vka[offset_morphTarget+2]=v1.z;vka[offset_morphTarget+3]=v2.x;vka[offset_morphTarget+4]=v2.y;vka[offset_morphTarget+5]=v2.z;vka[offset_morphTarget+6]=v3.x;vka[offset_morphTarget+7]=v3.y;vka[offset_morphTarget+8]=v3.z;vka[offset_morphTarget+9]=v4.x;vka[offset_morphTarget+10]=v4.y;vka[offset_morphTarget+11]=v4.z;if(material.morphNormals){if(needsSmoothNormals){faceVertexNormals=morphNormals[vk].vertexNormals[chf];n1=faceVertexNormals.a;n2=faceVertexNormals.b;n3=faceVertexNormals.c;n4=faceVertexNormals.d}else{n1=morphNormals[vk].faceNormals[chf];n2=n1;n3=n1;n4=n1}nka=morphNormalsArrays[vk];nka[offset_morphTarget]=n1.x;nka[offset_morphTarget+1]=n1.y;nka[offset_morphTarget+2]=n1.z;nka[offset_morphTarget+3]=n2.x;nka[offset_morphTarget+4]=n2.y;nka[offset_morphTarget+5]=n2.z;nka[offset_morphTarget+6]=n3.x;nka[offset_morphTarget+7]=n3.y;nka[offset_morphTarget+8]=n3.z;nka[offset_morphTarget+9]=n4.x;nka[offset_morphTarget+10]=n4.y;nka[offset_morphTarget+11]=n4.z}offset_morphTarget+=12}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphTargetsBuffers[vk]);_gl.bufferData(_gl.ARRAY_BUFFER,morphTargetsArrays[vk],hint);if(material.morphNormals){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphNormalsBuffers[vk]);_gl.bufferData(_gl.ARRAY_BUFFER,morphNormalsArrays[vk],hint)}}}if(obj_skinWeights.length){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];sw1=obj_skinWeights[face.a];sw2=obj_skinWeights[face.b];sw3=obj_skinWeights[face.c];skinWeightArray[offset_skin]=sw1.x;skinWeightArray[offset_skin+1]=sw1.y;skinWeightArray[offset_skin+2]=sw1.z;skinWeightArray[offset_skin+3]=sw1.w;skinWeightArray[offset_skin+4]=sw2.x;skinWeightArray[offset_skin+5]=sw2.y;skinWeightArray[offset_skin+6]=sw2.z;skinWeightArray[offset_skin+7]=sw2.w;skinWeightArray[offset_skin+8]=sw3.x;skinWeightArray[offset_skin+9]=sw3.y;skinWeightArray[offset_skin+10]=sw3.z;skinWeightArray[offset_skin+11]=sw3.w;si1=obj_skinIndices[face.a];si2=obj_skinIndices[face.b];si3=obj_skinIndices[face.c];skinIndexArray[offset_skin]=si1.x;skinIndexArray[offset_skin+1]=si1.y;skinIndexArray[offset_skin+2]=si1.z;skinIndexArray[offset_skin+3]=si1.w;skinIndexArray[offset_skin+4]=si2.x;skinIndexArray[offset_skin+5]=si2.y;skinIndexArray[offset_skin+6]=si2.z;skinIndexArray[offset_skin+7]=si2.w;skinIndexArray[offset_skin+8]=si3.x;skinIndexArray[offset_skin+9]=si3.y;skinIndexArray[offset_skin+10]=si3.z;skinIndexArray[offset_skin+11]=si3.w;offset_skin+=12}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];sw1=obj_skinWeights[face.a];
sw2=obj_skinWeights[face.b];sw3=obj_skinWeights[face.c];sw4=obj_skinWeights[face.d];skinWeightArray[offset_skin]=sw1.x;skinWeightArray[offset_skin+1]=sw1.y;skinWeightArray[offset_skin+2]=sw1.z;skinWeightArray[offset_skin+3]=sw1.w;skinWeightArray[offset_skin+4]=sw2.x;skinWeightArray[offset_skin+5]=sw2.y;skinWeightArray[offset_skin+6]=sw2.z;skinWeightArray[offset_skin+7]=sw2.w;skinWeightArray[offset_skin+8]=sw3.x;skinWeightArray[offset_skin+9]=sw3.y;skinWeightArray[offset_skin+10]=sw3.z;skinWeightArray[offset_skin+11]=sw3.w;skinWeightArray[offset_skin+12]=sw4.x;skinWeightArray[offset_skin+13]=sw4.y;skinWeightArray[offset_skin+14]=sw4.z;skinWeightArray[offset_skin+15]=sw4.w;si1=obj_skinIndices[face.a];si2=obj_skinIndices[face.b];si3=obj_skinIndices[face.c];si4=obj_skinIndices[face.d];skinIndexArray[offset_skin]=si1.x;skinIndexArray[offset_skin+1]=si1.y;skinIndexArray[offset_skin+2]=si1.z;skinIndexArray[offset_skin+3]=si1.w;skinIndexArray[offset_skin+4]=si2.x;skinIndexArray[offset_skin+5]=si2.y;skinIndexArray[offset_skin+6]=si2.z;skinIndexArray[offset_skin+7]=si2.w;skinIndexArray[offset_skin+8]=si3.x;skinIndexArray[offset_skin+9]=si3.y;skinIndexArray[offset_skin+10]=si3.z;skinIndexArray[offset_skin+11]=si3.w;skinIndexArray[offset_skin+12]=si4.x;skinIndexArray[offset_skin+13]=si4.y;skinIndexArray[offset_skin+14]=si4.z;skinIndexArray[offset_skin+15]=si4.w;offset_skin+=16}if(offset_skin>0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglSkinIndicesBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,skinIndexArray,hint);_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglSkinWeightsBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,skinWeightArray,hint)}}if(dirtyColors&&vertexColorType){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];vertexColors=face.vertexColors;faceColor=face.color;if(vertexColors.length===3&&vertexColorType===THREE.VertexColors){c1=vertexColors[0];c2=vertexColors[1];c3=vertexColors[2]}else{c1=faceColor;c2=faceColor;c3=faceColor}colorArray[offset_color]=c1.r;colorArray[offset_color+1]=c1.g;colorArray[offset_color+2]=c1.b;colorArray[offset_color+3]=c2.r;colorArray[offset_color+4]=c2.g;colorArray[offset_color+5]=c2.b;colorArray[offset_color+6]=c3.r;colorArray[offset_color+7]=c3.g;colorArray[offset_color+8]=c3.b;offset_color+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];vertexColors=face.vertexColors;faceColor=face.color;if(vertexColors.length===4&&vertexColorType===THREE.VertexColors){c1=vertexColors[0];c2=vertexColors[1];c3=vertexColors[2];c4=vertexColors[3]}else{c1=faceColor;c2=faceColor;c3=faceColor;c4=faceColor}colorArray[offset_color]=c1.r;colorArray[offset_color+1]=c1.g;colorArray[offset_color+2]=c1.b;colorArray[offset_color+3]=c2.r;colorArray[offset_color+4]=c2.g;colorArray[offset_color+5]=c2.b;colorArray[offset_color+6]=c3.r;colorArray[offset_color+7]=c3.g;colorArray[offset_color+8]=c3.b;colorArray[offset_color+9]=c4.r;colorArray[offset_color+10]=c4.g;colorArray[offset_color+11]=c4.b;offset_color+=12}if(offset_color>0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglColorBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,colorArray,hint)}}if(dirtyTangents&&geometry.hasTangents){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];vertexTangents=face.vertexTangents;t1=vertexTangents[0];t2=vertexTangents[1];t3=vertexTangents[2];tangentArray[offset_tangent]=t1.x;tangentArray[offset_tangent+1]=t1.y;tangentArray[offset_tangent+2]=t1.z;tangentArray[offset_tangent+3]=t1.w;tangentArray[offset_tangent+4]=t2.x;tangentArray[offset_tangent+5]=t2.y;tangentArray[offset_tangent+6]=t2.z;tangentArray[offset_tangent+7]=t2.w;tangentArray[offset_tangent+8]=t3.x;tangentArray[offset_tangent+9]=t3.y;tangentArray[offset_tangent+10]=t3.z;tangentArray[offset_tangent+11]=t3.w;offset_tangent+=12}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];vertexTangents=face.vertexTangents;t1=vertexTangents[0];t2=vertexTangents[1];t3=vertexTangents[2];t4=vertexTangents[3];tangentArray[offset_tangent]=t1.x;tangentArray[offset_tangent+1]=t1.y;tangentArray[offset_tangent+2]=t1.z;tangentArray[offset_tangent+3]=t1.w;tangentArray[offset_tangent+4]=t2.x;tangentArray[offset_tangent+5]=t2.y;tangentArray[offset_tangent+6]=t2.z;tangentArray[offset_tangent+7]=t2.w;tangentArray[offset_tangent+8]=t3.x;tangentArray[offset_tangent+9]=t3.y;tangentArray[offset_tangent+10]=t3.z;tangentArray[offset_tangent+11]=t3.w;tangentArray[offset_tangent+12]=t4.x;tangentArray[offset_tangent+13]=t4.y;tangentArray[offset_tangent+14]=t4.z;tangentArray[offset_tangent+15]=t4.w;offset_tangent+=16}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglTangentBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,tangentArray,hint)}if(dirtyNormals&&normalType){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];vertexNormals=face.vertexNormals;faceNormal=face.normal;if(vertexNormals.length===3&&needsSmoothNormals){for(i=0;i<3;i++){vn=vertexNormals[i];normalArray[offset_normal]=vn.x;normalArray[offset_normal+1]=vn.y;normalArray[offset_normal+2]=vn.z;offset_normal+=3}}else{for(i=0;i<3;i++){normalArray[offset_normal]=faceNormal.x;normalArray[offset_normal+1]=faceNormal.y;normalArray[offset_normal+2]=faceNormal.z;offset_normal+=3}}}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];vertexNormals=face.vertexNormals;faceNormal=face.normal;if(vertexNormals.length===4&&needsSmoothNormals){for(i=0;i<4;i++){vn=vertexNormals[i];normalArray[offset_normal]=vn.x;normalArray[offset_normal+1]=vn.y;normalArray[offset_normal+2]=vn.z;offset_normal+=3}}else{for(i=0;i<4;i++){normalArray[offset_normal]=faceNormal.x;normalArray[offset_normal+1]=faceNormal.y;normalArray[offset_normal+2]=faceNormal.z;offset_normal+=3}}}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglNormalBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,normalArray,hint)}if(dirtyUvs&&obj_uvs&&uvType){for(f=0,fl=chunk_faces3.length;f<fl;f++){fi=chunk_faces3[f];uv=obj_uvs[fi];if(uv===undefined)continue;for(i=0;i<3;i++){uvi=uv[i];uvArray[offset_uv]=uvi.x;uvArray[offset_uv+1]=uvi.y;offset_uv+=2}}for(f=0,fl=chunk_faces4.length;f<fl;f++){fi=chunk_faces4[f];uv=obj_uvs[fi];if(uv===undefined)continue;for(i=0;i<4;i++){uvi=uv[i];uvArray[offset_uv]=uvi.x;uvArray[offset_uv+1]=uvi.y;offset_uv+=2}}if(offset_uv>0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglUVBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,uvArray,hint)}}if(dirtyUvs&&obj_uvs2&&uvType){for(f=0,fl=chunk_faces3.length;f<fl;f++){fi=chunk_faces3[f];uv2=obj_uvs2[fi];if(uv2===undefined)continue;for(i=0;i<3;i++){uv2i=uv2[i];uv2Array[offset_uv2]=uv2i.x;uv2Array[offset_uv2+1]=uv2i.y;offset_uv2+=2}}for(f=0,fl=chunk_faces4.length;f<fl;f++){fi=chunk_faces4[f];uv2=obj_uvs2[fi];if(uv2===undefined)continue;for(i=0;i<4;i++){uv2i=uv2[i];uv2Array[offset_uv2]=uv2i.x;uv2Array[offset_uv2+1]=uv2i.y;offset_uv2+=2}}if(offset_uv2>0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglUV2Buffer);_gl.bufferData(_gl.ARRAY_BUFFER,uv2Array,hint)}}if(dirtyElements){for(f=0,fl=chunk_faces3.length;f<fl;f++){faceArray[offset_face]=vertexIndex;faceArray[offset_face+1]=vertexIndex+1;faceArray[offset_face+2]=vertexIndex+2;offset_face+=3;lineArray[offset_line]=vertexIndex;lineArray[offset_line+1]=vertexIndex+1;lineArray[offset_line+2]=vertexIndex;lineArray[offset_line+3]=vertexIndex+2;lineArray[offset_line+4]=vertexIndex+1;lineArray[offset_line+5]=vertexIndex+2;offset_line+=6;vertexIndex+=3}for(f=0,fl=chunk_faces4.length;f<fl;f++){faceArray[offset_face]=vertexIndex;faceArray[offset_face+1]=vertexIndex+1;faceArray[offset_face+2]=vertexIndex+3;faceArray[offset_face+3]=vertexIndex+1;faceArray[offset_face+4]=vertexIndex+2;faceArray[offset_face+5]=vertexIndex+3;offset_face+=6;lineArray[offset_line]=vertexIndex;lineArray[offset_line+1]=vertexIndex+1;lineArray[offset_line+2]=vertexIndex;lineArray[offset_line+3]=vertexIndex+3;lineArray[offset_line+4]=vertexIndex+1;lineArray[offset_line+5]=vertexIndex+2;lineArray[offset_line+6]=vertexIndex+2;lineArray[offset_line+7]=vertexIndex+3;offset_line+=8;vertexIndex+=4}_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglFaceBuffer);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,faceArray,hint);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglLineBuffer);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,lineArray,hint)}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(!customAttribute.__original.needsUpdate)continue;offset_custom=0;offset_customSrc=0;if(customAttribute.size===1){if(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];customAttribute.array[offset_custom]=customAttribute.value[face.a];customAttribute.array[offset_custom+1]=customAttribute.value[face.b];customAttribute.array[offset_custom+2]=customAttribute.value[face.c];offset_custom+=3}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];customAttribute.array[offset_custom]=customAttribute.value[face.a];customAttribute.array[offset_custom+1]=customAttribute.value[face.b];customAttribute.array[offset_custom+2]=customAttribute.value[face.c];customAttribute.array[offset_custom+3]=customAttribute.value[face.d];offset_custom+=4}}else if(customAttribute.boundTo==="faces"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];customAttribute.array[offset_custom]=value;customAttribute.array[offset_custom+1]=value;customAttribute.array[offset_custom+2]=value;offset_custom+=3}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];customAttribute.array[offset_custom]=value;customAttribute.array[offset_custom+1]=value;customAttribute.array[offset_custom+2]=value;customAttribute.array[offset_custom+3]=value;offset_custom+=4}}}else if(customAttribute.size===2){if(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v2.x;customAttribute.array[offset_custom+3]=v2.y;customAttribute.array[offset_custom+4]=v3.x;customAttribute.array[offset_custom+5]=v3.y;offset_custom+=6}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];v4=customAttribute.value[face.d];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v2.x;customAttribute.array[offset_custom+3]=v2.y;customAttribute.array[offset_custom+4]=v3.x;customAttribute.array[offset_custom+5]=v3.y;customAttribute.array[offset_custom+6]=v4.x;customAttribute.array[offset_custom+7]=v4.y;offset_custom+=8}}else if(customAttribute.boundTo==="faces"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];v1=value;v2=value;v3=value;customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v2.x;customAttribute.array[offset_custom+3]=v2.y;customAttribute.array[offset_custom+4]=v3.x;customAttribute.array[offset_custom+5]=v3.y;offset_custom+=6}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];v1=value;v2=value;v3=value;v4=value;customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v2.x;customAttribute.array[offset_custom+3]=v2.y;customAttribute.array[offset_custom+4]=v3.x;customAttribute.array[offset_custom+5]=v3.y;customAttribute.array[offset_custom+6]=v4.x;customAttribute.array[offset_custom+7]=v4.y;offset_custom+=8}}}else if(customAttribute.size===3){var pp;if(customAttribute.type==="c"){pp=["r","g","b"]}else{pp=["x","y","z"]}if(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];offset_custom+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];v4=customAttribute.value[face.d];customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];customAttribute.array[offset_custom+9]=v4[pp[0]];customAttribute.array[offset_custom+10]=v4[pp[1]];customAttribute.array[offset_custom+11]=v4[pp[2]];offset_custom+=12}}else if(customAttribute.boundTo==="faces"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];v1=value;v2=value;v3=value;customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];offset_custom+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];v1=value;v2=value;v3=value;v4=value;customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];customAttribute.array[offset_custom+9]=v4[pp[0]];customAttribute.array[offset_custom+10]=v4[pp[1]];customAttribute.array[offset_custom+11]=v4[pp[2]];offset_custom+=12}}else if(customAttribute.boundTo==="faceVertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];v1=value[0];v2=value[1];v3=value[2];customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];offset_custom+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];v1=value[0];v2=value[1];v3=value[2];v4=value[3];customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];customAttribute.array[offset_custom+9]=v4[pp[0]];customAttribute.array[offset_custom+10]=v4[pp[1]];customAttribute.array[offset_custom+11]=v4[pp[2]];offset_custom+=12}}}else if(customAttribute.size===4){if(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;offset_custom+=12}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];v4=customAttribute.value[face.d];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;customAttribute.array[offset_custom+12]=v4.x;customAttribute.array[offset_custom+13]=v4.y;customAttribute.array[offset_custom+14]=v4.z;customAttribute.array[offset_custom+15]=v4.w;offset_custom+=16}}else if(customAttribute.boundTo==="faces"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];v1=value;v2=value;v3=value;customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;offset_custom+=12}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];v1=value;v2=value;v3=value;v4=value;customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;customAttribute.array[offset_custom+12]=v4.x;customAttribute.array[offset_custom+13]=v4.y;customAttribute.array[offset_custom+14]=v4.z;customAttribute.array[offset_custom+15]=v4.w;offset_custom+=16}}else if(customAttribute.boundTo==="faceVertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];v1=value[0];v2=value[1];v3=value[2];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;offset_custom+=12}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];v1=value[0];v2=value[1];v3=value[2];v4=value[3];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;customAttribute.array[offset_custom+12]=v4.x;customAttribute.array[offset_custom+13]=v4.y;customAttribute.array[offset_custom+14]=v4.z;customAttribute.array[offset_custom+15]=v4.w;offset_custom+=16}}}_gl.bindBuffer(_gl.ARRAY_BUFFER,customAttribute.buffer);_gl.bufferData(_gl.ARRAY_BUFFER,customAttribute.array,hint)}}if(dispose){delete geometryGroup.__inittedArrays;delete geometryGroup.__colorArray;delete geometryGroup.__normalArray;delete geometryGroup.__tangentArray;delete geometryGroup.__uvArray;delete geometryGroup.__uv2Array;delete geometryGroup.__faceArray;delete geometryGroup.__vertexArray;delete geometryGroup.__lineArray;delete geometryGroup.__skinIndexArray;delete geometryGroup.__skinWeightArray}}function setDirectBuffers(geometry,hint,dispose){var attributes=geometry.attributes;var attributeName,attributeItem;for(attributeName in attributes){attributeItem=attributes[attributeName];if(attributeItem.needsUpdate){if(attributeName==="index"){_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,attributeItem.buffer);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,attributeItem.array,hint)}else{_gl.bindBuffer(_gl.ARRAY_BUFFER,attributeItem.buffer);_gl.bufferData(_gl.ARRAY_BUFFER,attributeItem.array,hint)}attributeItem.needsUpdate=false}if(dispose&&!attributeItem.dynamic){delete attributeItem.array}}}this.renderBufferImmediate=function(object,program,material){if(object.hasPositions&&!object.__webglVertexBuffer)object.__webglVertexBuffer=_gl.createBuffer();if(object.hasNormals&&!object.__webglNormalBuffer)object.__webglNormalBuffer=_gl.createBuffer();if(object.hasUvs&&!object.__webglUvBuffer)object.__webglUvBuffer=_gl.createBuffer();if(object.hasColors&&!object.__webglColorBuffer)object.__webglColorBuffer=_gl.createBuffer();if(object.hasPositions){_gl.bindBuffer(_gl.ARRAY_BUFFER,object.__webglVertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,object.positionArray,_gl.DYNAMIC_DRAW);_gl.enableVertexAttribArray(program.attributes.position);_gl.vertexAttribPointer(program.attributes.position,3,_gl.FLOAT,false,0,0)}if(object.hasNormals){_gl.bindBuffer(_gl.ARRAY_BUFFER,object.__webglNormalBuffer);if(material.shading===THREE.FlatShading){var nx,ny,nz,nax,nbx,ncx,nay,nby,ncy,naz,nbz,ncz,normalArray,i,il=object.count*3;for(i=0;i<il;i+=9){normalArray=object.normalArray;nax=normalArray[i];nay=normalArray[i+1];naz=normalArray[i+2];nbx=normalArray[i+3];nby=normalArray[i+4];nbz=normalArray[i+5];ncx=normalArray[i+6];ncy=normalArray[i+7];ncz=normalArray[i+8];nx=(nax+nbx+ncx)/3;ny=(nay+nby+ncy)/3;nz=(naz+nbz+ncz)/3;normalArray[i]=nx;normalArray[i+1]=ny;normalArray[i+2]=nz;normalArray[i+3]=nx;normalArray[i+4]=ny;normalArray[i+5]=nz;normalArray[i+6]=nx;normalArray[i+7]=ny;normalArray[i+8]=nz}}_gl.bufferData(_gl.ARRAY_BUFFER,object.normalArray,_gl.DYNAMIC_DRAW);_gl.enableVertexAttribArray(program.attributes.normal);_gl.vertexAttribPointer(program.attributes.normal,3,_gl.FLOAT,false,0,0)}if(object.hasUvs&&material.map){_gl.bindBuffer(_gl.ARRAY_BUFFER,object.__webglUvBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,object.uvArray,_gl.DYNAMIC_DRAW);_gl.enableVertexAttribArray(program.attributes.uv);_gl.vertexAttribPointer(program.attributes.uv,2,_gl.FLOAT,false,0,0)}if(object.hasColors&&material.vertexColors!==THREE.NoColors){_gl.bindBuffer(_gl.ARRAY_BUFFER,object.__webglColorBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,object.colorArray,_gl.DYNAMIC_DRAW);_gl.enableVertexAttribArray(program.attributes.color);_gl.vertexAttribPointer(program.attributes.color,3,_gl.FLOAT,false,0,0)}_gl.drawArrays(_gl.TRIANGLES,0,object.count);object.count=0};this.renderBufferDirect=function(camera,lights,fog,material,geometry,object){if(material.visible===false)return;var program,programAttributes,linewidth,primitives,a,attribute,geometryAttributes;var attributeItem,attributeName,attributePointer,attributeSize;program=setProgram(camera,lights,fog,material,object);programAttributes=program.attributes;geometryAttributes=geometry.attributes;var updateBuffers=false,wireframeBit=material.wireframe?1:0,geometryHash=geometry.id*16777215+program.id*2+wireframeBit;if(geometryHash!==_currentGeometryGroupHash){_currentGeometryGroupHash=geometryHash;updateBuffers=true}if(updateBuffers){disableAttributes()}if(object instanceof THREE.Mesh){var index=geometryAttributes["index"];if(index){var offsets=geometry.offsets;if(offsets.length>1)updateBuffers=true;for(var i=0,il=offsets.length;i<il;i++){var startIndex=offsets[i].index;if(updateBuffers){for(attributeName in geometryAttributes){if(attributeName==="index")continue;attributePointer=programAttributes[attributeName];attributeItem=geometryAttributes[attributeName];attributeSize=attributeItem.itemSize;if(attributePointer>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,attributeItem.buffer);enableAttribute(attributePointer);_gl.vertexAttribPointer(attributePointer,attributeSize,_gl.FLOAT,false,0,startIndex*attributeSize*4)}}_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,index.buffer)}_gl.drawElements(_gl.TRIANGLES,offsets[i].count,_gl.UNSIGNED_SHORT,offsets[i].start*2);_this.info.render.calls++;_this.info.render.vertices+=offsets[i].count;_this.info.render.faces+=offsets[i].count/3}}else{if(updateBuffers){for(attributeName in geometryAttributes){if(attributeName==="index")continue;attributePointer=programAttributes[attributeName];attributeItem=geometryAttributes[attributeName];attributeSize=attributeItem.itemSize;if(attributePointer>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,attributeItem.buffer);enableAttribute(attributePointer);_gl.vertexAttribPointer(attributePointer,attributeSize,_gl.FLOAT,false,0,0)}}}var position=geometry.attributes["position"];_gl.drawArrays(_gl.TRIANGLES,0,position.numItems/3);_this.info.render.calls++;_this.info.render.vertices+=position.numItems/3;_this.info.render.faces+=position.numItems/3/3}}else if(object instanceof THREE.ParticleSystem){if(updateBuffers){for(attributeName in geometryAttributes){attributePointer=programAttributes[attributeName];attributeItem=geometryAttributes[attributeName];attributeSize=attributeItem.itemSize;if(attributePointer>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,attributeItem.buffer);enableAttribute(attributePointer);_gl.vertexAttribPointer(attributePointer,attributeSize,_gl.FLOAT,false,0,0)}}var position=geometryAttributes["position"];_gl.drawArrays(_gl.POINTS,0,position.numItems/3);_this.info.render.calls++;_this.info.render.points+=position.numItems/3}}else if(object instanceof THREE.Line){if(updateBuffers){for(attributeName in geometryAttributes){attributePointer=programAttributes[attributeName];attributeItem=geometryAttributes[attributeName];attributeSize=attributeItem.itemSize;if(attributePointer>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,attributeItem.buffer);enableAttribute(attributePointer);_gl.vertexAttribPointer(attributePointer,attributeSize,_gl.FLOAT,false,0,0)}}setLineWidth(material.linewidth);var position=geometryAttributes["position"];_gl.drawArrays(_gl.LINE_STRIP,0,position.numItems/3);_this.info.render.calls++;_this.info.render.points+=position.numItems}}};this.renderBuffer=function(camera,lights,fog,material,geometryGroup,object){if(material.visible===false)return;var program,attributes,linewidth,primitives,a,attribute,i,il;program=setProgram(camera,lights,fog,material,object);attributes=program.attributes;var updateBuffers=false,wireframeBit=material.wireframe?1:0,geometryGroupHash=geometryGroup.id*16777215+program.id*2+wireframeBit;if(geometryGroupHash!==_currentGeometryGroupHash){_currentGeometryGroupHash=geometryGroupHash;updateBuffers=true}if(updateBuffers){disableAttributes()}if(!material.morphTargets&&attributes.position>=0){if(updateBuffers){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglVertexBuffer);enableAttribute(attributes.position);_gl.vertexAttribPointer(attributes.position,3,_gl.FLOAT,false,0,0)}}else{if(object.morphTargetBase){setupMorphTargets(material,geometryGroup,object)}}if(updateBuffers){if(geometryGroup.__webglCustomAttributesList){for(i=0,il=geometryGroup.__webglCustomAttributesList.length;i<il;i++){attribute=geometryGroup.__webglCustomAttributesList[i];if(attributes[attribute.buffer.belongsToAttribute]>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,attribute.buffer);enableAttribute(attributes[attribute.buffer.belongsToAttribute]);_gl.vertexAttribPointer(attributes[attribute.buffer.belongsToAttribute],attribute.size,_gl.FLOAT,false,0,0)}}}if(attributes.color>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglColorBuffer);enableAttribute(attributes.color);_gl.vertexAttribPointer(attributes.color,3,_gl.FLOAT,false,0,0)}if(attributes.normal>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglNormalBuffer);enableAttribute(attributes.normal);_gl.vertexAttribPointer(attributes.normal,3,_gl.FLOAT,false,0,0)}if(attributes.tangent>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglTangentBuffer);enableAttribute(attributes.tangent);_gl.vertexAttribPointer(attributes.tangent,4,_gl.FLOAT,false,0,0)}if(attributes.uv>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglUVBuffer);enableAttribute(attributes.uv);_gl.vertexAttribPointer(attributes.uv,2,_gl.FLOAT,false,0,0)}if(attributes.uv2>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglUV2Buffer);enableAttribute(attributes.uv2);_gl.vertexAttribPointer(attributes.uv2,2,_gl.FLOAT,false,0,0)}if(material.skinning&&attributes.skinIndex>=0&&attributes.skinWeight>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglSkinIndicesBuffer);enableAttribute(attributes.skinIndex);_gl.vertexAttribPointer(attributes.skinIndex,4,_gl.FLOAT,false,0,0);_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglSkinWeightsBuffer);enableAttribute(attributes.skinWeight);_gl.vertexAttribPointer(attributes.skinWeight,4,_gl.FLOAT,false,0,0)}if(attributes.lineDistance>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglLineDistanceBuffer);enableAttribute(attributes.lineDistance);_gl.vertexAttribPointer(attributes.lineDistance,1,_gl.FLOAT,false,0,0)}}if(object instanceof THREE.Mesh){if(material.wireframe){setLineWidth(material.wireframeLinewidth);if(updateBuffers)_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglLineBuffer);_gl.drawElements(_gl.LINES,geometryGroup.__webglLineCount,_gl.UNSIGNED_SHORT,0)}else{if(updateBuffers)_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglFaceBuffer);_gl.drawElements(_gl.TRIANGLES,geometryGroup.__webglFaceCount,_gl.UNSIGNED_SHORT,0)}_this.info.render.calls++;_this.info.render.vertices+=geometryGroup.__webglFaceCount;_this.info.render.faces+=geometryGroup.__webglFaceCount/3}else if(object instanceof THREE.Line){primitives=object.type===THREE.LineStrip?_gl.LINE_STRIP:_gl.LINES;setLineWidth(material.linewidth);_gl.drawArrays(primitives,0,geometryGroup.__webglLineCount);_this.info.render.calls++}else if(object instanceof THREE.ParticleSystem){_gl.drawArrays(_gl.POINTS,0,geometryGroup.__webglParticleCount);_this.info.render.calls++;_this.info.render.points+=geometryGroup.__webglParticleCount}else if(object instanceof THREE.Ribbon){_gl.drawArrays(_gl.TRIANGLE_STRIP,0,geometryGroup.__webglVertexCount);_this.info.render.calls++}};function enableAttribute(attribute){if(!_enabledAttributes[attribute]){_gl.enableVertexAttribArray(attribute);
_enabledAttributes[attribute]=true}}function disableAttributes(){for(var attribute in _enabledAttributes){if(_enabledAttributes[attribute]){_gl.disableVertexAttribArray(attribute);_enabledAttributes[attribute]=false}}}function setupMorphTargets(material,geometryGroup,object){var attributes=material.program.attributes;if(object.morphTargetBase!==-1&&attributes.position>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphTargetsBuffers[object.morphTargetBase]);enableAttribute(attributes.position);_gl.vertexAttribPointer(attributes.position,3,_gl.FLOAT,false,0,0)}else if(attributes.position>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglVertexBuffer);enableAttribute(attributes.position);_gl.vertexAttribPointer(attributes.position,3,_gl.FLOAT,false,0,0)}if(object.morphTargetForcedOrder.length){var m=0;var order=object.morphTargetForcedOrder;var influences=object.morphTargetInfluences;while(m<material.numSupportedMorphTargets&&m<order.length){if(attributes["morphTarget"+m]>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphTargetsBuffers[order[m]]);enableAttribute(attributes["morphTarget"+m]);_gl.vertexAttribPointer(attributes["morphTarget"+m],3,_gl.FLOAT,false,0,0)}if(attributes["morphNormal"+m]>=0&&material.morphNormals){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphNormalsBuffers[order[m]]);enableAttribute(attributes["morphNormal"+m]);_gl.vertexAttribPointer(attributes["morphNormal"+m],3,_gl.FLOAT,false,0,0)}object.__webglMorphTargetInfluences[m]=influences[order[m]];m++}}else{var influence,activeInfluenceIndices=[];var influences=object.morphTargetInfluences;var i,il=influences.length;for(i=0;i<il;i++){influence=influences[i];if(influence>0){activeInfluenceIndices.push([influence,i])}}if(activeInfluenceIndices.length>material.numSupportedMorphTargets){activeInfluenceIndices.sort(numericalSort);activeInfluenceIndices.length=material.numSupportedMorphTargets}else if(activeInfluenceIndices.length>material.numSupportedMorphNormals){activeInfluenceIndices.sort(numericalSort)}else if(activeInfluenceIndices.length===0){activeInfluenceIndices.push([0,0])}var influenceIndex,m=0;while(m<material.numSupportedMorphTargets){if(activeInfluenceIndices[m]){influenceIndex=activeInfluenceIndices[m][1];if(attributes["morphTarget"+m]>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphTargetsBuffers[influenceIndex]);enableAttribute(attributes["morphTarget"+m]);_gl.vertexAttribPointer(attributes["morphTarget"+m],3,_gl.FLOAT,false,0,0)}if(attributes["morphNormal"+m]>=0&&material.morphNormals){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphNormalsBuffers[influenceIndex]);enableAttribute(attributes["morphNormal"+m]);_gl.vertexAttribPointer(attributes["morphNormal"+m],3,_gl.FLOAT,false,0,0)}object.__webglMorphTargetInfluences[m]=influences[influenceIndex]}else{object.__webglMorphTargetInfluences[m]=0}m++}}if(material.program.uniforms.morphTargetInfluences!==null){_gl.uniform1fv(material.program.uniforms.morphTargetInfluences,object.__webglMorphTargetInfluences)}}function painterSortStable(a,b){if(a.z!==b.z){return b.z-a.z}else{return a.id-b.id}}function numericalSort(a,b){return b[0]-a[0]}this.render=function(scene,camera,renderTarget,forceClear){if(camera instanceof THREE.Camera===false){console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");return}var i,il,webglObject,object,renderList,lights=scene.__lights,fog=scene.fog;_currentMaterialId=-1;_lightsNeedUpdate=true;if(scene.autoUpdate===true)scene.updateMatrixWorld();if(camera.parent===undefined)camera.updateMatrixWorld();camera.matrixWorldInverse.getInverse(camera.matrixWorld);_projScreenMatrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse);_frustum.setFromMatrix(_projScreenMatrix);if(this.autoUpdateObjects)this.initWebGLObjects(scene);renderPlugins(this.renderPluginsPre,scene,camera);_this.info.render.calls=0;_this.info.render.vertices=0;_this.info.render.faces=0;_this.info.render.points=0;this.setRenderTarget(renderTarget);if(this.autoClear||forceClear){this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil)}renderList=scene.__webglObjects;for(i=0,il=renderList.length;i<il;i++){webglObject=renderList[i];object=webglObject.object;webglObject.id=i;webglObject.render=false;if(object.visible){if(!(object instanceof THREE.Mesh||object instanceof THREE.ParticleSystem)||!object.frustumCulled||_frustum.intersectsObject(object)){setupMatrices(object,camera);unrollBufferMaterial(webglObject);webglObject.render=true;if(this.sortObjects===true){if(object.renderDepth!==null){webglObject.z=object.renderDepth}else{_vector3.getPositionFromMatrix(object.matrixWorld);_vector3.applyProjection(_projScreenMatrix);webglObject.z=_vector3.z}}}}}if(this.sortObjects){renderList.sort(painterSortStable)}renderList=scene.__webglObjectsImmediate;for(i=0,il=renderList.length;i<il;i++){webglObject=renderList[i];object=webglObject.object;if(object.visible){setupMatrices(object,camera);unrollImmediateBufferMaterial(webglObject)}}if(scene.overrideMaterial){var material=scene.overrideMaterial;this.setBlending(material.blending,material.blendEquation,material.blendSrc,material.blendDst);this.setDepthTest(material.depthTest);this.setDepthWrite(material.depthWrite);setPolygonOffset(material.polygonOffset,material.polygonOffsetFactor,material.polygonOffsetUnits);renderObjects(scene.__webglObjects,false,"",camera,lights,fog,true,material);renderObjectsImmediate(scene.__webglObjectsImmediate,"",camera,lights,fog,false,material)}else{var material=null;this.setBlending(THREE.NoBlending);renderObjects(scene.__webglObjects,true,"opaque",camera,lights,fog,false,material);renderObjectsImmediate(scene.__webglObjectsImmediate,"opaque",camera,lights,fog,false,material);renderObjects(scene.__webglObjects,false,"transparent",camera,lights,fog,true,material);renderObjectsImmediate(scene.__webglObjectsImmediate,"transparent",camera,lights,fog,true,material)}renderPlugins(this.renderPluginsPost,scene,camera);if(renderTarget&&renderTarget.generateMipmaps&&renderTarget.minFilter!==THREE.NearestFilter&&renderTarget.minFilter!==THREE.LinearFilter){updateRenderTargetMipmap(renderTarget)}this.setDepthTest(true);this.setDepthWrite(true)};function renderPlugins(plugins,scene,camera){if(!plugins.length)return;for(var i=0,il=plugins.length;i<il;i++){_currentProgram=null;_currentCamera=null;_oldBlending=-1;_oldDepthTest=-1;_oldDepthWrite=-1;_oldDoubleSided=-1;_oldFlipSided=-1;_currentGeometryGroupHash=-1;_currentMaterialId=-1;_lightsNeedUpdate=true;plugins[i].render(scene,camera,_currentWidth,_currentHeight);_currentProgram=null;_currentCamera=null;_oldBlending=-1;_oldDepthTest=-1;_oldDepthWrite=-1;_oldDoubleSided=-1;_oldFlipSided=-1;_currentGeometryGroupHash=-1;_currentMaterialId=-1;_lightsNeedUpdate=true}}function renderObjects(renderList,reverse,materialType,camera,lights,fog,useBlending,overrideMaterial){var webglObject,object,buffer,material,start,end,delta;if(reverse){start=renderList.length-1;end=-1;delta=-1}else{start=0;end=renderList.length;delta=1}for(var i=start;i!==end;i+=delta){webglObject=renderList[i];if(webglObject.render){object=webglObject.object;buffer=webglObject.buffer;if(overrideMaterial){material=overrideMaterial}else{material=webglObject[materialType];if(!material)continue;if(useBlending)_this.setBlending(material.blending,material.blendEquation,material.blendSrc,material.blendDst);_this.setDepthTest(material.depthTest);_this.setDepthWrite(material.depthWrite);setPolygonOffset(material.polygonOffset,material.polygonOffsetFactor,material.polygonOffsetUnits)}_this.setMaterialFaces(material);if(buffer instanceof THREE.BufferGeometry){_this.renderBufferDirect(camera,lights,fog,material,buffer,object)}else{_this.renderBuffer(camera,lights,fog,material,buffer,object)}}}}function renderObjectsImmediate(renderList,materialType,camera,lights,fog,useBlending,overrideMaterial){var webglObject,object,material,program;for(var i=0,il=renderList.length;i<il;i++){webglObject=renderList[i];object=webglObject.object;if(object.visible){if(overrideMaterial){material=overrideMaterial}else{material=webglObject[materialType];if(!material)continue;if(useBlending)_this.setBlending(material.blending,material.blendEquation,material.blendSrc,material.blendDst);_this.setDepthTest(material.depthTest);_this.setDepthWrite(material.depthWrite);setPolygonOffset(material.polygonOffset,material.polygonOffsetFactor,material.polygonOffsetUnits)}_this.renderImmediateObject(camera,lights,fog,material,object)}}}this.renderImmediateObject=function(camera,lights,fog,material,object){var program=setProgram(camera,lights,fog,material,object);_currentGeometryGroupHash=-1;_this.setMaterialFaces(material);if(object.immediateRenderCallback){object.immediateRenderCallback(program,_gl,_frustum)}else{object.render(function(object){_this.renderBufferImmediate(object,program,material)})}};function unrollImmediateBufferMaterial(globject){var object=globject.object,material=object.material;if(material.transparent){globject.transparent=material;globject.opaque=null}else{globject.opaque=material;globject.transparent=null}}function unrollBufferMaterial(globject){var object=globject.object,buffer=globject.buffer,material,materialIndex,meshMaterial;meshMaterial=object.material;if(meshMaterial instanceof THREE.MeshFaceMaterial){materialIndex=buffer.materialIndex;material=meshMaterial.materials[materialIndex];if(material.transparent){globject.transparent=material;globject.opaque=null}else{globject.opaque=material;globject.transparent=null}}else{material=meshMaterial;if(material){if(material.transparent){globject.transparent=material;globject.opaque=null}else{globject.opaque=material;globject.transparent=null}}}}function sortFacesByMaterial(geometry,material){var f,fl,face,materialIndex,vertices,groupHash,hash_map={};var numMorphTargets=geometry.morphTargets.length;var numMorphNormals=geometry.morphNormals.length;var usesFaceMaterial=material instanceof THREE.MeshFaceMaterial;geometry.geometryGroups={};for(f=0,fl=geometry.faces.length;f<fl;f++){face=geometry.faces[f];materialIndex=usesFaceMaterial?face.materialIndex:0;if(hash_map[materialIndex]===undefined){hash_map[materialIndex]={hash:materialIndex,counter:0}}groupHash=hash_map[materialIndex].hash+"_"+hash_map[materialIndex].counter;if(geometry.geometryGroups[groupHash]===undefined){geometry.geometryGroups[groupHash]={faces3:[],faces4:[],materialIndex:materialIndex,vertices:0,numMorphTargets:numMorphTargets,numMorphNormals:numMorphNormals}}vertices=face instanceof THREE.Face3?3:4;if(geometry.geometryGroups[groupHash].vertices+vertices>65535){hash_map[materialIndex].counter+=1;groupHash=hash_map[materialIndex].hash+"_"+hash_map[materialIndex].counter;if(geometry.geometryGroups[groupHash]===undefined){geometry.geometryGroups[groupHash]={faces3:[],faces4:[],materialIndex:materialIndex,vertices:0,numMorphTargets:numMorphTargets,numMorphNormals:numMorphNormals}}}if(face instanceof THREE.Face3){geometry.geometryGroups[groupHash].faces3.push(f)}else{geometry.geometryGroups[groupHash].faces4.push(f)}geometry.geometryGroups[groupHash].vertices+=vertices}geometry.geometryGroupsList=[];for(var g in geometry.geometryGroups){geometry.geometryGroups[g].id=_geometryGroupCounter++;geometry.geometryGroupsList.push(geometry.geometryGroups[g])}}this.initWebGLObjects=function(scene){if(!scene.__webglObjects){scene.__webglObjects=[];scene.__webglObjectsImmediate=[];scene.__webglSprites=[];scene.__webglFlares=[]}while(scene.__objectsAdded.length){addObject(scene.__objectsAdded[0],scene);scene.__objectsAdded.splice(0,1)}while(scene.__objectsRemoved.length){removeObject(scene.__objectsRemoved[0],scene);scene.__objectsRemoved.splice(0,1)}for(var o=0,ol=scene.__webglObjects.length;o<ol;o++){var object=scene.__webglObjects[o].object;if(object.__webglInit===undefined){if(object.__webglActive!==undefined){removeObject(object,scene)}addObject(object,scene)}updateObject(object)}};function addObject(object,scene){var g,geometry,material,geometryGroup;if(object.__webglInit===undefined){object.__webglInit=true;object._modelViewMatrix=new THREE.Matrix4;object._normalMatrix=new THREE.Matrix3;if(object.geometry!==undefined&&object.geometry.__webglInit===undefined){object.geometry.__webglInit=true;object.geometry.addEventListener("dispose",onGeometryDispose)}geometry=object.geometry;if(geometry===undefined){}else if(geometry instanceof THREE.BufferGeometry){initDirectBuffers(geometry)}else if(object instanceof THREE.Mesh){material=object.material;if(geometry.geometryGroups===undefined){sortFacesByMaterial(geometry,material)}for(g in geometry.geometryGroups){geometryGroup=geometry.geometryGroups[g];if(!geometryGroup.__webglVertexBuffer){createMeshBuffers(geometryGroup);initMeshBuffers(geometryGroup,object);geometry.verticesNeedUpdate=true;geometry.morphTargetsNeedUpdate=true;geometry.elementsNeedUpdate=true;geometry.uvsNeedUpdate=true;geometry.normalsNeedUpdate=true;geometry.tangentsNeedUpdate=true;geometry.colorsNeedUpdate=true}}}else if(object instanceof THREE.Ribbon){if(!geometry.__webglVertexBuffer){createRibbonBuffers(geometry);initRibbonBuffers(geometry,object);geometry.verticesNeedUpdate=true;geometry.colorsNeedUpdate=true;geometry.normalsNeedUpdate=true}}else if(object instanceof THREE.Line){if(!geometry.__webglVertexBuffer){createLineBuffers(geometry);initLineBuffers(geometry,object);geometry.verticesNeedUpdate=true;geometry.colorsNeedUpdate=true;geometry.lineDistancesNeedUpdate=true}}else if(object instanceof THREE.ParticleSystem){if(!geometry.__webglVertexBuffer){createParticleBuffers(geometry);initParticleBuffers(geometry,object);geometry.verticesNeedUpdate=true;geometry.colorsNeedUpdate=true}}}if(object.__webglActive===undefined){if(object instanceof THREE.Mesh){geometry=object.geometry;if(geometry instanceof THREE.BufferGeometry){addBuffer(scene.__webglObjects,geometry,object)}else if(geometry instanceof THREE.Geometry){for(g in geometry.geometryGroups){geometryGroup=geometry.geometryGroups[g];addBuffer(scene.__webglObjects,geometryGroup,object)}}}else if(object instanceof THREE.Ribbon||object instanceof THREE.Line||object instanceof THREE.ParticleSystem){geometry=object.geometry;addBuffer(scene.__webglObjects,geometry,object)}else if(object instanceof THREE.ImmediateRenderObject||object.immediateRenderCallback){addBufferImmediate(scene.__webglObjectsImmediate,object)}else if(object instanceof THREE.Sprite){scene.__webglSprites.push(object)}else if(object instanceof THREE.LensFlare){scene.__webglFlares.push(object)}object.__webglActive=true}}function addBuffer(objlist,buffer,object){objlist.push({buffer:buffer,object:object,opaque:null,transparent:null})}function addBufferImmediate(objlist,object){objlist.push({object:object,opaque:null,transparent:null})}function updateObject(object){var geometry=object.geometry,geometryGroup,customAttributesDirty,material;if(geometry instanceof THREE.BufferGeometry){setDirectBuffers(geometry,_gl.DYNAMIC_DRAW,!geometry.dynamic)}else if(object instanceof THREE.Mesh){for(var i=0,il=geometry.geometryGroupsList.length;i<il;i++){geometryGroup=geometry.geometryGroupsList[i];material=getBufferMaterial(object,geometryGroup);if(geometry.buffersNeedUpdate){initMeshBuffers(geometryGroup,object)}customAttributesDirty=material.attributes&&areCustomAttributesDirty(material);if(geometry.verticesNeedUpdate||geometry.morphTargetsNeedUpdate||geometry.elementsNeedUpdate||geometry.uvsNeedUpdate||geometry.normalsNeedUpdate||geometry.colorsNeedUpdate||geometry.tangentsNeedUpdate||customAttributesDirty){setMeshBuffers(geometryGroup,object,_gl.DYNAMIC_DRAW,!geometry.dynamic,material)}}geometry.verticesNeedUpdate=false;geometry.morphTargetsNeedUpdate=false;geometry.elementsNeedUpdate=false;geometry.uvsNeedUpdate=false;geometry.normalsNeedUpdate=false;geometry.colorsNeedUpdate=false;geometry.tangentsNeedUpdate=false;geometry.buffersNeedUpdate=false;material.attributes&&clearCustomAttributes(material)}else if(object instanceof THREE.Ribbon){material=getBufferMaterial(object,geometry);customAttributesDirty=material.attributes&&areCustomAttributesDirty(material);if(geometry.verticesNeedUpdate||geometry.colorsNeedUpdate||geometry.normalsNeedUpdate||customAttributesDirty){setRibbonBuffers(geometry,_gl.DYNAMIC_DRAW)}geometry.verticesNeedUpdate=false;geometry.colorsNeedUpdate=false;geometry.normalsNeedUpdate=false;material.attributes&&clearCustomAttributes(material)}else if(object instanceof THREE.Line){material=getBufferMaterial(object,geometry);customAttributesDirty=material.attributes&&areCustomAttributesDirty(material);if(geometry.verticesNeedUpdate||geometry.colorsNeedUpdate||geometry.lineDistancesNeedUpdate||customAttributesDirty){setLineBuffers(geometry,_gl.DYNAMIC_DRAW)}geometry.verticesNeedUpdate=false;geometry.colorsNeedUpdate=false;geometry.lineDistancesNeedUpdate=false;material.attributes&&clearCustomAttributes(material)}else if(object instanceof THREE.ParticleSystem){material=getBufferMaterial(object,geometry);customAttributesDirty=material.attributes&&areCustomAttributesDirty(material);if(geometry.verticesNeedUpdate||geometry.colorsNeedUpdate||object.sortParticles||customAttributesDirty){setParticleBuffers(geometry,_gl.DYNAMIC_DRAW,object)}geometry.verticesNeedUpdate=false;geometry.colorsNeedUpdate=false;material.attributes&&clearCustomAttributes(material)}}function areCustomAttributesDirty(material){for(var a in material.attributes){if(material.attributes[a].needsUpdate)return true}return false}function clearCustomAttributes(material){for(var a in material.attributes){material.attributes[a].needsUpdate=false}}function removeObject(object,scene){if(object instanceof THREE.Mesh||object instanceof THREE.ParticleSystem||object instanceof THREE.Ribbon||object instanceof THREE.Line){removeInstances(scene.__webglObjects,object)}else if(object instanceof THREE.Sprite){removeInstancesDirect(scene.__webglSprites,object)}else if(object instanceof THREE.LensFlare){removeInstancesDirect(scene.__webglFlares,object)}else if(object instanceof THREE.ImmediateRenderObject||object.immediateRenderCallback){removeInstances(scene.__webglObjectsImmediate,object)}delete object.__webglActive}function removeInstances(objlist,object){for(var o=objlist.length-1;o>=0;o--){if(objlist[o].object===object){objlist.splice(o,1)}}}function removeInstancesDirect(objlist,object){for(var o=objlist.length-1;o>=0;o--){if(objlist[o]===object){objlist.splice(o,1)}}}this.initMaterial=function(material,lights,fog,object){material.addEventListener("dispose",onMaterialDispose);var u,a,identifiers,i,parameters,maxLightCount,maxBones,maxShadows,shaderID;if(material instanceof THREE.MeshDepthMaterial){shaderID="depth"}else if(material instanceof THREE.MeshNormalMaterial){shaderID="normal"}else if(material instanceof THREE.MeshBasicMaterial){shaderID="basic"}else if(material instanceof THREE.MeshLambertMaterial){shaderID="lambert"}else if(material instanceof THREE.MeshPhongMaterial){shaderID="phong"}else if(material instanceof THREE.LineBasicMaterial){shaderID="basic"}else if(material instanceof THREE.LineDashedMaterial){shaderID="dashed"}else if(material instanceof THREE.ParticleBasicMaterial){shaderID="particle_basic"}if(shaderID){setMaterialShaders(material,THREE.ShaderLib[shaderID])}maxLightCount=allocateLights(lights);maxShadows=allocateShadows(lights);maxBones=allocateBones(object);parameters={map:!!material.map,envMap:!!material.envMap,lightMap:!!material.lightMap,bumpMap:!!material.bumpMap,normalMap:!!material.normalMap,specularMap:!!material.specularMap,vertexColors:material.vertexColors,fog:fog,useFog:material.fog,fogExp:fog instanceof THREE.FogExp2,sizeAttenuation:material.sizeAttenuation,skinning:material.skinning,maxBones:maxBones,useVertexTexture:_supportsBoneTextures&&object&&object.useVertexTexture,boneTextureWidth:object&&object.boneTextureWidth,boneTextureHeight:object&&object.boneTextureHeight,morphTargets:material.morphTargets,morphNormals:material.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,maxDirLights:maxLightCount.directional,maxPointLights:maxLightCount.point,maxSpotLights:maxLightCount.spot,maxHemiLights:maxLightCount.hemi,maxShadows:maxShadows,shadowMapEnabled:this.shadowMapEnabled&&object.receiveShadow,shadowMapType:this.shadowMapType,shadowMapDebug:this.shadowMapDebug,shadowMapCascade:this.shadowMapCascade,alphaTest:material.alphaTest,metal:material.metal,perPixel:material.perPixel,wrapAround:material.wrapAround,doubleSided:material.side===THREE.DoubleSide,flipSided:material.side===THREE.BackSide};material.program=buildProgram(shaderID,material.fragmentShader,material.vertexShader,material.uniforms,material.attributes,material.defines,parameters);var attributes=material.program.attributes;if(material.morphTargets){material.numSupportedMorphTargets=0;var id,base="morphTarget";for(i=0;i<this.maxMorphTargets;i++){id=base+i;if(attributes[id]>=0){material.numSupportedMorphTargets++}}}if(material.morphNormals){material.numSupportedMorphNormals=0;var id,base="morphNormal";for(i=0;i<this.maxMorphNormals;i++){id=base+i;if(attributes[id]>=0){material.numSupportedMorphNormals++}}}material.uniformsList=[];for(u in material.uniforms){material.uniformsList.push([material.uniforms[u],u])}};function setMaterialShaders(material,shaders){material.uniforms=THREE.UniformsUtils.clone(shaders.uniforms);material.vertexShader=shaders.vertexShader;material.fragmentShader=shaders.fragmentShader}function setProgram(camera,lights,fog,material,object){_usedTextureUnits=0;if(material.needsUpdate){if(material.program)deallocateMaterial(material);_this.initMaterial(material,lights,fog,object);material.needsUpdate=false}if(material.morphTargets){if(!object.__webglMorphTargetInfluences){object.__webglMorphTargetInfluences=new Float32Array(_this.maxMorphTargets)}}var refreshMaterial=false;var program=material.program,p_uniforms=program.uniforms,m_uniforms=material.uniforms;if(program!==_currentProgram){_gl.useProgram(program);_currentProgram=program;refreshMaterial=true}if(material.id!==_currentMaterialId){_currentMaterialId=material.id;refreshMaterial=true}if(refreshMaterial||camera!==_currentCamera){_gl.uniformMatrix4fv(p_uniforms.projectionMatrix,false,camera.projectionMatrix.elements);if(camera!==_currentCamera)_currentCamera=camera}if(material.skinning){if(_supportsBoneTextures&&object.useVertexTexture){if(p_uniforms.boneTexture!==null){var textureUnit=getTextureUnit();_gl.uniform1i(p_uniforms.boneTexture,textureUnit);_this.setTexture(object.boneTexture,textureUnit)}}else{if(p_uniforms.boneGlobalMatrices!==null){_gl.uniformMatrix4fv(p_uniforms.boneGlobalMatrices,false,object.boneMatrices)}}}if(refreshMaterial){if(fog&&material.fog){refreshUniformsFog(m_uniforms,fog)}if(material instanceof THREE.MeshPhongMaterial||material instanceof THREE.MeshLambertMaterial||material.lights){if(_lightsNeedUpdate){setupLights(program,lights);_lightsNeedUpdate=false}refreshUniformsLights(m_uniforms,_lights)}if(material instanceof THREE.MeshBasicMaterial||material instanceof THREE.MeshLambertMaterial||material instanceof THREE.MeshPhongMaterial){refreshUniformsCommon(m_uniforms,material)}if(material instanceof THREE.LineBasicMaterial){refreshUniformsLine(m_uniforms,material)}else if(material instanceof THREE.LineDashedMaterial){refreshUniformsLine(m_uniforms,material);refreshUniformsDash(m_uniforms,material)}else if(material instanceof THREE.ParticleBasicMaterial){refreshUniformsParticle(m_uniforms,material)}else if(material instanceof THREE.MeshPhongMaterial){refreshUniformsPhong(m_uniforms,material)}else if(material instanceof THREE.MeshLambertMaterial){refreshUniformsLambert(m_uniforms,material)}else if(material instanceof THREE.MeshDepthMaterial){m_uniforms.mNear.value=camera.near;m_uniforms.mFar.value=camera.far;m_uniforms.opacity.value=material.opacity}else if(material instanceof THREE.MeshNormalMaterial){m_uniforms.opacity.value=material.opacity}if(object.receiveShadow&&!material._shadowPass){refreshUniformsShadow(m_uniforms,lights)}loadUniformsGeneric(program,material.uniformsList);if(material instanceof THREE.ShaderMaterial||material instanceof THREE.MeshPhongMaterial||material.envMap){if(p_uniforms.cameraPosition!==null){_vector3.getPositionFromMatrix(camera.matrixWorld);_gl.uniform3f(p_uniforms.cameraPosition,_vector3.x,_vector3.y,_vector3.z)}}if(material instanceof THREE.MeshPhongMaterial||material instanceof THREE.MeshLambertMaterial||material instanceof THREE.ShaderMaterial||material.skinning){if(p_uniforms.viewMatrix!==null){_gl.uniformMatrix4fv(p_uniforms.viewMatrix,false,camera.matrixWorldInverse.elements)}}}loadUniformsMatrices(p_uniforms,object);if(p_uniforms.modelMatrix!==null){_gl.uniformMatrix4fv(p_uniforms.modelMatrix,false,object.matrixWorld.elements)}return program}function refreshUniformsCommon(uniforms,material){uniforms.opacity.value=material.opacity;if(_this.gammaInput){uniforms.diffuse.value.copyGammaToLinear(material.color)}else{uniforms.diffuse.value=material.color}uniforms.map.value=material.map;uniforms.lightMap.value=material.lightMap;uniforms.specularMap.value=material.specularMap;if(material.bumpMap){uniforms.bumpMap.value=material.bumpMap;uniforms.bumpScale.value=material.bumpScale}if(material.normalMap){uniforms.normalMap.value=material.normalMap;uniforms.normalScale.value.copy(material.normalScale)}var uvScaleMap;if(material.map){uvScaleMap=material.map}else if(material.specularMap){uvScaleMap=material.specularMap}else if(material.normalMap){uvScaleMap=material.normalMap}else if(material.bumpMap){uvScaleMap=material.bumpMap}if(uvScaleMap!==undefined){var offset=uvScaleMap.offset;var repeat=uvScaleMap.repeat;uniforms.offsetRepeat.value.set(offset.x,offset.y,repeat.x,repeat.y)}uniforms.envMap.value=material.envMap;uniforms.flipEnvMap.value=material.envMap instanceof THREE.WebGLRenderTargetCube?1:-1;if(_this.gammaInput){uniforms.reflectivity.value=material.reflectivity}else{uniforms.reflectivity.value=material.reflectivity}uniforms.refractionRatio.value=material.refractionRatio;uniforms.combine.value=material.combine;uniforms.useRefract.value=material.envMap&&material.envMap.mapping instanceof THREE.CubeRefractionMapping}function refreshUniformsLine(uniforms,material){uniforms.diffuse.value=material.color;uniforms.opacity.value=material.opacity}function refreshUniformsDash(uniforms,material){uniforms.dashSize.value=material.dashSize;uniforms.totalSize.value=material.dashSize+material.gapSize;uniforms.scale.value=material.scale}function refreshUniformsParticle(uniforms,material){uniforms.psColor.value=material.color;uniforms.opacity.value=material.opacity;uniforms.size.value=material.size;uniforms.scale.value=_canvas.height/2;uniforms.map.value=material.map}function refreshUniformsFog(uniforms,fog){uniforms.fogColor.value=fog.color;if(fog instanceof THREE.Fog){uniforms.fogNear.value=fog.near;uniforms.fogFar.value=fog.far}else if(fog instanceof THREE.FogExp2){uniforms.fogDensity.value=fog.density}}function refreshUniformsPhong(uniforms,material){uniforms.shininess.value=material.shininess;if(_this.gammaInput){uniforms.ambient.value.copyGammaToLinear(material.ambient);uniforms.emissive.value.copyGammaToLinear(material.emissive);uniforms.specular.value.copyGammaToLinear(material.specular)}else{uniforms.ambient.value=material.ambient;uniforms.emissive.value=material.emissive;uniforms.specular.value=material.specular}if(material.wrapAround){uniforms.wrapRGB.value.copy(material.wrapRGB)}}function refreshUniformsLambert(uniforms,material){if(_this.gammaInput){uniforms.ambient.value.copyGammaToLinear(material.ambient);uniforms.emissive.value.copyGammaToLinear(material.emissive)}else{uniforms.ambient.value=material.ambient;uniforms.emissive.value=material.emissive}if(material.wrapAround){uniforms.wrapRGB.value.copy(material.wrapRGB)}}function refreshUniformsLights(uniforms,lights){uniforms.ambientLightColor.value=lights.ambient;uniforms.directionalLightColor.value=lights.directional.colors;uniforms.directionalLightDirection.value=lights.directional.positions;uniforms.pointLightColor.value=lights.point.colors;uniforms.pointLightPosition.value=lights.point.positions;uniforms.pointLightDistance.value=lights.point.distances;uniforms.spotLightColor.value=lights.spot.colors;uniforms.spotLightPosition.value=lights.spot.positions;uniforms.spotLightDistance.value=lights.spot.distances;uniforms.spotLightDirection.value=lights.spot.directions;uniforms.spotLightAngleCos.value=lights.spot.anglesCos;uniforms.spotLightExponent.value=lights.spot.exponents;uniforms.hemisphereLightSkyColor.value=lights.hemi.skyColors;uniforms.hemisphereLightGroundColor.value=lights.hemi.groundColors;uniforms.hemisphereLightDirection.value=lights.hemi.positions}function refreshUniformsShadow(uniforms,lights){if(uniforms.shadowMatrix){var j=0;for(var i=0,il=lights.length;i<il;i++){var light=lights[i];if(!light.castShadow)continue;if(light instanceof THREE.SpotLight||light instanceof THREE.DirectionalLight&&!light.shadowCascade){uniforms.shadowMap.value[j]=light.shadowMap;uniforms.shadowMapSize.value[j]=light.shadowMapSize;uniforms.shadowMatrix.value[j]=light.shadowMatrix;uniforms.shadowDarkness.value[j]=light.shadowDarkness;uniforms.shadowBias.value[j]=light.shadowBias;j++}}}}function loadUniformsMatrices(uniforms,object){_gl.uniformMatrix4fv(uniforms.modelViewMatrix,false,object._modelViewMatrix.elements);if(uniforms.normalMatrix){_gl.uniformMatrix3fv(uniforms.normalMatrix,false,object._normalMatrix.elements)}}function getTextureUnit(){var textureUnit=_usedTextureUnits;if(textureUnit>=_maxTextures){console.warn("WebGLRenderer: trying to use "+textureUnit+" texture units while this GPU supports only "+_maxTextures)}_usedTextureUnits+=1;return textureUnit}function loadUniformsGeneric(program,uniforms){var uniform,value,type,location,texture,textureUnit,i,il,j,jl,offset;for(j=0,jl=uniforms.length;j<jl;j++){location=program.uniforms[uniforms[j][1]];if(!location)continue;uniform=uniforms[j][0];type=uniform.type;value=uniform.value;if(type==="i"){_gl.uniform1i(location,value)}else if(type==="f"){_gl.uniform1f(location,value)}else if(type==="v2"){_gl.uniform2f(location,value.x,value.y)}else if(type==="v3"){_gl.uniform3f(location,value.x,value.y,value.z)}else if(type==="v4"){_gl.uniform4f(location,value.x,value.y,value.z,value.w)}else if(type==="c"){_gl.uniform3f(location,value.r,value.g,value.b)}else if(type==="iv1"){_gl.uniform1iv(location,value)}else if(type==="iv"){_gl.uniform3iv(location,value)}else if(type==="fv1"){_gl.uniform1fv(location,value)}else if(type==="fv"){_gl.uniform3fv(location,value)}else if(type==="v2v"){if(uniform._array===undefined){uniform._array=new Float32Array(2*value.length)}for(i=0,il=value.length;i<il;i++){offset=i*2;uniform._array[offset]=value[i].x;uniform._array[offset+1]=value[i].y}_gl.uniform2fv(location,uniform._array)}else if(type==="v3v"){if(uniform._array===undefined){uniform._array=new Float32Array(3*value.length)}for(i=0,il=value.length;i<il;i++){offset=i*3;uniform._array[offset]=value[i].x;uniform._array[offset+1]=value[i].y;uniform._array[offset+2]=value[i].z}_gl.uniform3fv(location,uniform._array)}else if(type==="v4v"){if(uniform._array===undefined){uniform._array=new Float32Array(4*value.length)}for(i=0,il=value.length;i<il;i++){offset=i*4;uniform._array[offset]=value[i].x;uniform._array[offset+1]=value[i].y;uniform._array[offset+2]=value[i].z;uniform._array[offset+3]=value[i].w}_gl.uniform4fv(location,uniform._array)}else if(type==="m4"){if(uniform._array===undefined){uniform._array=new Float32Array(16)}value.flattenToArray(uniform._array);_gl.uniformMatrix4fv(location,false,uniform._array)}else if(type==="m4v"){if(uniform._array===undefined){uniform._array=new Float32Array(16*value.length)}for(i=0,il=value.length;i<il;i++){value[i].flattenToArrayOffset(uniform._array,i*16)}_gl.uniformMatrix4fv(location,false,uniform._array)}else if(type==="t"){texture=value;textureUnit=getTextureUnit();
_gl.uniform1i(location,textureUnit);if(!texture)continue;if(texture.image instanceof Array&&texture.image.length===6){setCubeTexture(texture,textureUnit)}else if(texture instanceof THREE.WebGLRenderTargetCube){setCubeTextureDynamic(texture,textureUnit)}else{_this.setTexture(texture,textureUnit)}}else if(type==="tv"){if(uniform._array===undefined){uniform._array=[]}for(i=0,il=uniform.value.length;i<il;i++){uniform._array[i]=getTextureUnit()}_gl.uniform1iv(location,uniform._array);for(i=0,il=uniform.value.length;i<il;i++){texture=uniform.value[i];textureUnit=uniform._array[i];if(!texture)continue;_this.setTexture(texture,textureUnit)}}}}function setupMatrices(object,camera){object._modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld);object._normalMatrix.getNormalMatrix(object._modelViewMatrix)}function setColorGamma(array,offset,color,intensitySq){array[offset]=color.r*color.r*intensitySq;array[offset+1]=color.g*color.g*intensitySq;array[offset+2]=color.b*color.b*intensitySq}function setColorLinear(array,offset,color,intensity){array[offset]=color.r*intensity;array[offset+1]=color.g*intensity;array[offset+2]=color.b*intensity}function setupLights(program,lights){var l,ll,light,n,r=0,g=0,b=0,color,skyColor,groundColor,intensity,intensitySq,position,distance,zlights=_lights,dirColors=zlights.directional.colors,dirPositions=zlights.directional.positions,pointColors=zlights.point.colors,pointPositions=zlights.point.positions,pointDistances=zlights.point.distances,spotColors=zlights.spot.colors,spotPositions=zlights.spot.positions,spotDistances=zlights.spot.distances,spotDirections=zlights.spot.directions,spotAnglesCos=zlights.spot.anglesCos,spotExponents=zlights.spot.exponents,hemiSkyColors=zlights.hemi.skyColors,hemiGroundColors=zlights.hemi.groundColors,hemiPositions=zlights.hemi.positions,dirLength=0,pointLength=0,spotLength=0,hemiLength=0,dirCount=0,pointCount=0,spotCount=0,hemiCount=0,dirOffset=0,pointOffset=0,spotOffset=0,hemiOffset=0;for(l=0,ll=lights.length;l<ll;l++){light=lights[l];if(light.onlyShadow)continue;color=light.color;intensity=light.intensity;distance=light.distance;if(light instanceof THREE.AmbientLight){if(!light.visible)continue;if(_this.gammaInput){r+=color.r*color.r;g+=color.g*color.g;b+=color.b*color.b}else{r+=color.r;g+=color.g;b+=color.b}}else if(light instanceof THREE.DirectionalLight){dirCount+=1;if(!light.visible)continue;_direction.getPositionFromMatrix(light.matrixWorld);_vector3.getPositionFromMatrix(light.target.matrixWorld);_direction.sub(_vector3);_direction.normalize();if(_direction.x===0&&_direction.y===0&&_direction.z===0)continue;dirOffset=dirLength*3;dirPositions[dirOffset]=_direction.x;dirPositions[dirOffset+1]=_direction.y;dirPositions[dirOffset+2]=_direction.z;if(_this.gammaInput){setColorGamma(dirColors,dirOffset,color,intensity*intensity)}else{setColorLinear(dirColors,dirOffset,color,intensity)}dirLength+=1}else if(light instanceof THREE.PointLight){pointCount+=1;if(!light.visible)continue;pointOffset=pointLength*3;if(_this.gammaInput){setColorGamma(pointColors,pointOffset,color,intensity*intensity)}else{setColorLinear(pointColors,pointOffset,color,intensity)}_vector3.getPositionFromMatrix(light.matrixWorld);pointPositions[pointOffset]=_vector3.x;pointPositions[pointOffset+1]=_vector3.y;pointPositions[pointOffset+2]=_vector3.z;pointDistances[pointLength]=distance;pointLength+=1}else if(light instanceof THREE.SpotLight){spotCount+=1;if(!light.visible)continue;spotOffset=spotLength*3;if(_this.gammaInput){setColorGamma(spotColors,spotOffset,color,intensity*intensity)}else{setColorLinear(spotColors,spotOffset,color,intensity)}_vector3.getPositionFromMatrix(light.matrixWorld);spotPositions[spotOffset]=_vector3.x;spotPositions[spotOffset+1]=_vector3.y;spotPositions[spotOffset+2]=_vector3.z;spotDistances[spotLength]=distance;_direction.copy(_vector3);_vector3.getPositionFromMatrix(light.target.matrixWorld);_direction.sub(_vector3);_direction.normalize();spotDirections[spotOffset]=_direction.x;spotDirections[spotOffset+1]=_direction.y;spotDirections[spotOffset+2]=_direction.z;spotAnglesCos[spotLength]=Math.cos(light.angle);spotExponents[spotLength]=light.exponent;spotLength+=1}else if(light instanceof THREE.HemisphereLight){hemiCount+=1;if(!light.visible)continue;_direction.getPositionFromMatrix(light.matrixWorld);_direction.normalize();if(_direction.x===0&&_direction.y===0&&_direction.z===0)continue;hemiOffset=hemiLength*3;hemiPositions[hemiOffset]=_direction.x;hemiPositions[hemiOffset+1]=_direction.y;hemiPositions[hemiOffset+2]=_direction.z;skyColor=light.color;groundColor=light.groundColor;if(_this.gammaInput){intensitySq=intensity*intensity;setColorGamma(hemiSkyColors,hemiOffset,skyColor,intensitySq);setColorGamma(hemiGroundColors,hemiOffset,groundColor,intensitySq)}else{setColorLinear(hemiSkyColors,hemiOffset,skyColor,intensity);setColorLinear(hemiGroundColors,hemiOffset,groundColor,intensity)}hemiLength+=1}}for(l=dirLength*3,ll=Math.max(dirColors.length,dirCount*3);l<ll;l++)dirColors[l]=0;for(l=pointLength*3,ll=Math.max(pointColors.length,pointCount*3);l<ll;l++)pointColors[l]=0;for(l=spotLength*3,ll=Math.max(spotColors.length,spotCount*3);l<ll;l++)spotColors[l]=0;for(l=hemiLength*3,ll=Math.max(hemiSkyColors.length,hemiCount*3);l<ll;l++)hemiSkyColors[l]=0;for(l=hemiLength*3,ll=Math.max(hemiGroundColors.length,hemiCount*3);l<ll;l++)hemiGroundColors[l]=0;zlights.directional.length=dirLength;zlights.point.length=pointLength;zlights.spot.length=spotLength;zlights.hemi.length=hemiLength;zlights.ambient[0]=r;zlights.ambient[1]=g;zlights.ambient[2]=b}this.setFaceCulling=function(cullFace,frontFaceDirection){if(cullFace===THREE.CullFaceNone){_gl.disable(_gl.CULL_FACE)}else{if(frontFaceDirection===THREE.FrontFaceDirectionCW){_gl.frontFace(_gl.CW)}else{_gl.frontFace(_gl.CCW)}if(cullFace===THREE.CullFaceBack){_gl.cullFace(_gl.BACK)}else if(cullFace===THREE.CullFaceFront){_gl.cullFace(_gl.FRONT)}else{_gl.cullFace(_gl.FRONT_AND_BACK)}_gl.enable(_gl.CULL_FACE)}};this.setMaterialFaces=function(material){var doubleSided=material.side===THREE.DoubleSide;var flipSided=material.side===THREE.BackSide;if(_oldDoubleSided!==doubleSided){if(doubleSided){_gl.disable(_gl.CULL_FACE)}else{_gl.enable(_gl.CULL_FACE)}_oldDoubleSided=doubleSided}if(_oldFlipSided!==flipSided){if(flipSided){_gl.frontFace(_gl.CW)}else{_gl.frontFace(_gl.CCW)}_oldFlipSided=flipSided}};this.setDepthTest=function(depthTest){if(_oldDepthTest!==depthTest){if(depthTest){_gl.enable(_gl.DEPTH_TEST)}else{_gl.disable(_gl.DEPTH_TEST)}_oldDepthTest=depthTest}};this.setDepthWrite=function(depthWrite){if(_oldDepthWrite!==depthWrite){_gl.depthMask(depthWrite);_oldDepthWrite=depthWrite}};function setLineWidth(width){if(width!==_oldLineWidth){_gl.lineWidth(width);_oldLineWidth=width}}function setPolygonOffset(polygonoffset,factor,units){if(_oldPolygonOffset!==polygonoffset){if(polygonoffset){_gl.enable(_gl.POLYGON_OFFSET_FILL)}else{_gl.disable(_gl.POLYGON_OFFSET_FILL)}_oldPolygonOffset=polygonoffset}if(polygonoffset&&(_oldPolygonOffsetFactor!==factor||_oldPolygonOffsetUnits!==units)){_gl.polygonOffset(factor,units);_oldPolygonOffsetFactor=factor;_oldPolygonOffsetUnits=units}}this.setBlending=function(blending,blendEquation,blendSrc,blendDst){if(blending!==_oldBlending){if(blending===THREE.NoBlending){_gl.disable(_gl.BLEND)}else if(blending===THREE.AdditiveBlending){_gl.enable(_gl.BLEND);_gl.blendEquation(_gl.FUNC_ADD);_gl.blendFunc(_gl.SRC_ALPHA,_gl.ONE)}else if(blending===THREE.SubtractiveBlending){_gl.enable(_gl.BLEND);_gl.blendEquation(_gl.FUNC_ADD);_gl.blendFunc(_gl.ZERO,_gl.ONE_MINUS_SRC_COLOR)}else if(blending===THREE.MultiplyBlending){_gl.enable(_gl.BLEND);_gl.blendEquation(_gl.FUNC_ADD);_gl.blendFunc(_gl.ZERO,_gl.SRC_COLOR)}else if(blending===THREE.CustomBlending){_gl.enable(_gl.BLEND)}else{_gl.enable(_gl.BLEND);_gl.blendEquationSeparate(_gl.FUNC_ADD,_gl.FUNC_ADD);_gl.blendFuncSeparate(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA,_gl.ONE,_gl.ONE_MINUS_SRC_ALPHA)}_oldBlending=blending}if(blending===THREE.CustomBlending){if(blendEquation!==_oldBlendEquation){_gl.blendEquation(paramThreeToGL(blendEquation));_oldBlendEquation=blendEquation}if(blendSrc!==_oldBlendSrc||blendDst!==_oldBlendDst){_gl.blendFunc(paramThreeToGL(blendSrc),paramThreeToGL(blendDst));_oldBlendSrc=blendSrc;_oldBlendDst=blendDst}}else{_oldBlendEquation=null;_oldBlendSrc=null;_oldBlendDst=null}};function generateDefines(defines){var value,chunk,chunks=[];for(var d in defines){value=defines[d];if(value===false)continue;chunk="#define "+d+" "+value;chunks.push(chunk)}return chunks.join("\n")}function buildProgram(shaderID,fragmentShader,vertexShader,uniforms,attributes,defines,parameters){var p,pl,d,program,code;var chunks=[];if(shaderID){chunks.push(shaderID)}else{chunks.push(fragmentShader);chunks.push(vertexShader)}for(d in defines){chunks.push(d);chunks.push(defines[d])}for(p in parameters){chunks.push(p);chunks.push(parameters[p])}code=chunks.join();for(p=0,pl=_programs.length;p<pl;p++){var programInfo=_programs[p];if(programInfo.code===code){programInfo.usedTimes++;return programInfo.program}}var shadowMapTypeDefine="SHADOWMAP_TYPE_BASIC";if(parameters.shadowMapType===THREE.PCFShadowMap){shadowMapTypeDefine="SHADOWMAP_TYPE_PCF"}else if(parameters.shadowMapType===THREE.PCFSoftShadowMap){shadowMapTypeDefine="SHADOWMAP_TYPE_PCF_SOFT"}var customDefines=generateDefines(defines);program=_gl.createProgram();var prefix_vertex=["precision "+_precision+" float;",customDefines,_supportsVertexTextures?"#define VERTEX_TEXTURES":"",_this.gammaInput?"#define GAMMA_INPUT":"",_this.gammaOutput?"#define GAMMA_OUTPUT":"",_this.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"","#define MAX_DIR_LIGHTS "+parameters.maxDirLights,"#define MAX_POINT_LIGHTS "+parameters.maxPointLights,"#define MAX_SPOT_LIGHTS "+parameters.maxSpotLights,"#define MAX_HEMI_LIGHTS "+parameters.maxHemiLights,"#define MAX_SHADOWS "+parameters.maxShadows,"#define MAX_BONES "+parameters.maxBones,parameters.map?"#define USE_MAP":"",parameters.envMap?"#define USE_ENVMAP":"",parameters.lightMap?"#define USE_LIGHTMAP":"",parameters.bumpMap?"#define USE_BUMPMAP":"",parameters.normalMap?"#define USE_NORMALMAP":"",parameters.specularMap?"#define USE_SPECULARMAP":"",parameters.vertexColors?"#define USE_COLOR":"",parameters.skinning?"#define USE_SKINNING":"",parameters.useVertexTexture?"#define BONE_TEXTURE":"",parameters.boneTextureWidth?"#define N_BONE_PIXEL_X "+parameters.boneTextureWidth.toFixed(1):"",parameters.boneTextureHeight?"#define N_BONE_PIXEL_Y "+parameters.boneTextureHeight.toFixed(1):"",parameters.morphTargets?"#define USE_MORPHTARGETS":"",parameters.morphNormals?"#define USE_MORPHNORMALS":"",parameters.perPixel?"#define PHONG_PER_PIXEL":"",parameters.wrapAround?"#define WRAP_AROUND":"",parameters.doubleSided?"#define DOUBLE_SIDED":"",parameters.flipSided?"#define FLIP_SIDED":"",parameters.shadowMapEnabled?"#define USE_SHADOWMAP":"",parameters.shadowMapEnabled?"#define "+shadowMapTypeDefine:"",parameters.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",parameters.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",parameters.sizeAttenuation?"#define USE_SIZEATTENUATION":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","attribute vec2 uv2;","#ifdef USE_COLOR","attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#else","attribute vec3 morphTarget4;","attribute vec3 morphTarget5;","attribute vec3 morphTarget6;","attribute vec3 morphTarget7;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif",""].join("\n");var prefix_fragment=["precision "+_precision+" float;",parameters.bumpMap||parameters.normalMap?"#extension GL_OES_standard_derivatives : enable":"",customDefines,"#define MAX_DIR_LIGHTS "+parameters.maxDirLights,"#define MAX_POINT_LIGHTS "+parameters.maxPointLights,"#define MAX_SPOT_LIGHTS "+parameters.maxSpotLights,"#define MAX_HEMI_LIGHTS "+parameters.maxHemiLights,"#define MAX_SHADOWS "+parameters.maxShadows,parameters.alphaTest?"#define ALPHATEST "+parameters.alphaTest:"",_this.gammaInput?"#define GAMMA_INPUT":"",_this.gammaOutput?"#define GAMMA_OUTPUT":"",_this.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"",parameters.useFog&&parameters.fog?"#define USE_FOG":"",parameters.useFog&&parameters.fogExp?"#define FOG_EXP2":"",parameters.map?"#define USE_MAP":"",parameters.envMap?"#define USE_ENVMAP":"",parameters.lightMap?"#define USE_LIGHTMAP":"",parameters.bumpMap?"#define USE_BUMPMAP":"",parameters.normalMap?"#define USE_NORMALMAP":"",parameters.specularMap?"#define USE_SPECULARMAP":"",parameters.vertexColors?"#define USE_COLOR":"",parameters.metal?"#define METAL":"",parameters.perPixel?"#define PHONG_PER_PIXEL":"",parameters.wrapAround?"#define WRAP_AROUND":"",parameters.doubleSided?"#define DOUBLE_SIDED":"",parameters.flipSided?"#define FLIP_SIDED":"",parameters.shadowMapEnabled?"#define USE_SHADOWMAP":"",parameters.shadowMapEnabled?"#define "+shadowMapTypeDefine:"",parameters.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",parameters.shadowMapCascade?"#define SHADOWMAP_CASCADE":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",""].join("\n");var glVertexShader=getShader("vertex",prefix_vertex+vertexShader);var glFragmentShader=getShader("fragment",prefix_fragment+fragmentShader);_gl.attachShader(program,glVertexShader);_gl.attachShader(program,glFragmentShader);_gl.linkProgram(program);if(!_gl.getProgramParameter(program,_gl.LINK_STATUS)){console.error("Could not initialise shader\n"+"VALIDATE_STATUS: "+_gl.getProgramParameter(program,_gl.VALIDATE_STATUS)+", gl error ["+_gl.getError()+"]")}_gl.deleteShader(glFragmentShader);_gl.deleteShader(glVertexShader);program.uniforms={};program.attributes={};var identifiers,u,a,i;identifiers=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","cameraPosition","morphTargetInfluences"];if(parameters.useVertexTexture){identifiers.push("boneTexture")}else{identifiers.push("boneGlobalMatrices")}for(u in uniforms){identifiers.push(u)}cacheUniformLocations(program,identifiers);identifiers=["position","normal","uv","uv2","tangent","color","skinIndex","skinWeight","lineDistance"];for(i=0;i<parameters.maxMorphTargets;i++){identifiers.push("morphTarget"+i)}for(i=0;i<parameters.maxMorphNormals;i++){identifiers.push("morphNormal"+i)}for(a in attributes){identifiers.push(a)}cacheAttributeLocations(program,identifiers);program.id=_programs_counter++;_programs.push({program:program,code:code,usedTimes:1});_this.info.memory.programs=_programs.length;return program}function cacheUniformLocations(program,identifiers){var i,l,id;for(i=0,l=identifiers.length;i<l;i++){id=identifiers[i];program.uniforms[id]=_gl.getUniformLocation(program,id)}}function cacheAttributeLocations(program,identifiers){var i,l,id;for(i=0,l=identifiers.length;i<l;i++){id=identifiers[i];program.attributes[id]=_gl.getAttribLocation(program,id)}}function addLineNumbers(string){var chunks=string.split("\n");for(var i=0,il=chunks.length;i<il;i++){chunks[i]=i+1+": "+chunks[i]}return chunks.join("\n")}function getShader(type,string){var shader;if(type==="fragment"){shader=_gl.createShader(_gl.FRAGMENT_SHADER)}else if(type==="vertex"){shader=_gl.createShader(_gl.VERTEX_SHADER)}_gl.shaderSource(shader,string);_gl.compileShader(shader);if(!_gl.getShaderParameter(shader,_gl.COMPILE_STATUS)){console.error(_gl.getShaderInfoLog(shader));console.error(addLineNumbers(string));return null}return shader}function isPowerOfTwo(value){return(value&value-1)===0}function setTextureParameters(textureType,texture,isImagePowerOfTwo){if(isImagePowerOfTwo){_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_S,paramThreeToGL(texture.wrapS));_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_T,paramThreeToGL(texture.wrapT));_gl.texParameteri(textureType,_gl.TEXTURE_MAG_FILTER,paramThreeToGL(texture.magFilter));_gl.texParameteri(textureType,_gl.TEXTURE_MIN_FILTER,paramThreeToGL(texture.minFilter))}else{_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.texParameteri(textureType,_gl.TEXTURE_MAG_FILTER,filterFallback(texture.magFilter));_gl.texParameteri(textureType,_gl.TEXTURE_MIN_FILTER,filterFallback(texture.minFilter))}if(_glExtensionTextureFilterAnisotropic&&texture.type!==THREE.FloatType){if(texture.anisotropy>1||texture.__oldAnisotropy){_gl.texParameterf(textureType,_glExtensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(texture.anisotropy,_maxAnisotropy));texture.__oldAnisotropy=texture.anisotropy}}}this.setTexture=function(texture,slot){if(texture.needsUpdate){if(!texture.__webglInit){texture.__webglInit=true;texture.addEventListener("dispose",onTextureDispose);texture.__webglTexture=_gl.createTexture();_this.info.memory.textures++}_gl.activeTexture(_gl.TEXTURE0+slot);_gl.bindTexture(_gl.TEXTURE_2D,texture.__webglTexture);_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,texture.flipY);_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,texture.premultiplyAlpha);_gl.pixelStorei(_gl.UNPACK_ALIGNMENT,texture.unpackAlignment);var image=texture.image,isImagePowerOfTwo=isPowerOfTwo(image.width)&&isPowerOfTwo(image.height),glFormat=paramThreeToGL(texture.format),glType=paramThreeToGL(texture.type);setTextureParameters(_gl.TEXTURE_2D,texture,isImagePowerOfTwo);var mipmap,mipmaps=texture.mipmaps;if(texture instanceof THREE.DataTexture){if(mipmaps.length>0&&isImagePowerOfTwo){for(var i=0,il=mipmaps.length;i<il;i++){mipmap=mipmaps[i];_gl.texImage2D(_gl.TEXTURE_2D,i,glFormat,mipmap.width,mipmap.height,0,glFormat,glType,mipmap.data)}texture.generateMipmaps=false}else{_gl.texImage2D(_gl.TEXTURE_2D,0,glFormat,image.width,image.height,0,glFormat,glType,image.data)}}else if(texture instanceof THREE.CompressedTexture){for(var i=0,il=mipmaps.length;i<il;i++){mipmap=mipmaps[i];_gl.compressedTexImage2D(_gl.TEXTURE_2D,i,glFormat,mipmap.width,mipmap.height,0,mipmap.data)}}else{if(mipmaps.length>0&&isImagePowerOfTwo){for(var i=0,il=mipmaps.length;i<il;i++){mipmap=mipmaps[i];_gl.texImage2D(_gl.TEXTURE_2D,i,glFormat,glFormat,glType,mipmap)}texture.generateMipmaps=false}else{_gl.texImage2D(_gl.TEXTURE_2D,0,glFormat,glFormat,glType,texture.image)}}if(texture.generateMipmaps&&isImagePowerOfTwo)_gl.generateMipmap(_gl.TEXTURE_2D);texture.needsUpdate=false;if(texture.onUpdate)texture.onUpdate()}else{_gl.activeTexture(_gl.TEXTURE0+slot);_gl.bindTexture(_gl.TEXTURE_2D,texture.__webglTexture)}};function clampToMaxSize(image,maxSize){if(image.width<=maxSize&&image.height<=maxSize){return image}var maxDimension=Math.max(image.width,image.height);var newWidth=Math.floor(image.width*maxSize/maxDimension);var newHeight=Math.floor(image.height*maxSize/maxDimension);var canvas=document.createElement("canvas");canvas.width=newWidth;canvas.height=newHeight;var ctx=canvas.getContext("2d");ctx.drawImage(image,0,0,image.width,image.height,0,0,newWidth,newHeight);return canvas}function setCubeTexture(texture,slot){if(texture.image.length===6){if(texture.needsUpdate){if(!texture.image.__webglTextureCube){texture.image.__webglTextureCube=_gl.createTexture();_this.info.memory.textures++}_gl.activeTexture(_gl.TEXTURE0+slot);_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture.image.__webglTextureCube);_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,texture.flipY);var isCompressed=texture instanceof THREE.CompressedTexture;var cubeImage=[];for(var i=0;i<6;i++){if(_this.autoScaleCubemaps&&!isCompressed){cubeImage[i]=clampToMaxSize(texture.image[i],_maxCubemapSize)}else{cubeImage[i]=texture.image[i]}}var image=cubeImage[0],isImagePowerOfTwo=isPowerOfTwo(image.width)&&isPowerOfTwo(image.height),glFormat=paramThreeToGL(texture.format),glType=paramThreeToGL(texture.type);setTextureParameters(_gl.TEXTURE_CUBE_MAP,texture,isImagePowerOfTwo);for(var i=0;i<6;i++){if(isCompressed){var mipmap,mipmaps=cubeImage[i].mipmaps;for(var j=0,jl=mipmaps.length;j<jl;j++){mipmap=mipmaps[j];_gl.compressedTexImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,j,glFormat,mipmap.width,mipmap.height,0,mipmap.data)}}else{_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,glFormat,glFormat,glType,cubeImage[i])}}if(texture.generateMipmaps&&isImagePowerOfTwo){_gl.generateMipmap(_gl.TEXTURE_CUBE_MAP)}texture.needsUpdate=false;if(texture.onUpdate)texture.onUpdate()}else{_gl.activeTexture(_gl.TEXTURE0+slot);_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture.image.__webglTextureCube)}}}function setCubeTextureDynamic(texture,slot){_gl.activeTexture(_gl.TEXTURE0+slot);_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture.__webglTexture)}function setupFrameBuffer(framebuffer,renderTarget,textureTarget){_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,textureTarget,renderTarget.__webglTexture,0)}function setupRenderBuffer(renderbuffer,renderTarget){_gl.bindRenderbuffer(_gl.RENDERBUFFER,renderbuffer);if(renderTarget.depthBuffer&&!renderTarget.stencilBuffer){_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_COMPONENT16,renderTarget.width,renderTarget.height);_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,renderbuffer)}else if(renderTarget.depthBuffer&&renderTarget.stencilBuffer){_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_STENCIL,renderTarget.width,renderTarget.height);_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_STENCIL_ATTACHMENT,_gl.RENDERBUFFER,renderbuffer)}else{_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.RGBA4,renderTarget.width,renderTarget.height)}}this.setRenderTarget=function(renderTarget){var isCube=renderTarget instanceof THREE.WebGLRenderTargetCube;if(renderTarget&&!renderTarget.__webglFramebuffer){if(renderTarget.depthBuffer===undefined)renderTarget.depthBuffer=true;if(renderTarget.stencilBuffer===undefined)renderTarget.stencilBuffer=true;renderTarget.addEventListener("dispose",onRenderTargetDispose);renderTarget.__webglTexture=_gl.createTexture();_this.info.memory.textures++;var isTargetPowerOfTwo=isPowerOfTwo(renderTarget.width)&&isPowerOfTwo(renderTarget.height),glFormat=paramThreeToGL(renderTarget.format),glType=paramThreeToGL(renderTarget.type);if(isCube){renderTarget.__webglFramebuffer=[];renderTarget.__webglRenderbuffer=[];_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,renderTarget.__webglTexture);setTextureParameters(_gl.TEXTURE_CUBE_MAP,renderTarget,isTargetPowerOfTwo);for(var i=0;i<6;i++){renderTarget.__webglFramebuffer[i]=_gl.createFramebuffer();renderTarget.__webglRenderbuffer[i]=_gl.createRenderbuffer();_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,glFormat,renderTarget.width,renderTarget.height,0,glFormat,glType,null);setupFrameBuffer(renderTarget.__webglFramebuffer[i],renderTarget,_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i);setupRenderBuffer(renderTarget.__webglRenderbuffer[i],renderTarget)}if(isTargetPowerOfTwo)_gl.generateMipmap(_gl.TEXTURE_CUBE_MAP)}else{renderTarget.__webglFramebuffer=_gl.createFramebuffer();if(renderTarget.shareDepthFrom){renderTarget.__webglRenderbuffer=renderTarget.shareDepthFrom.__webglRenderbuffer}else{renderTarget.__webglRenderbuffer=_gl.createRenderbuffer()}_gl.bindTexture(_gl.TEXTURE_2D,renderTarget.__webglTexture);setTextureParameters(_gl.TEXTURE_2D,renderTarget,isTargetPowerOfTwo);_gl.texImage2D(_gl.TEXTURE_2D,0,glFormat,renderTarget.width,renderTarget.height,0,glFormat,glType,null);setupFrameBuffer(renderTarget.__webglFramebuffer,renderTarget,_gl.TEXTURE_2D);if(renderTarget.shareDepthFrom){if(renderTarget.depthBuffer&&!renderTarget.stencilBuffer){_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,renderTarget.__webglRenderbuffer)}else if(renderTarget.depthBuffer&&renderTarget.stencilBuffer){_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_STENCIL_ATTACHMENT,_gl.RENDERBUFFER,renderTarget.__webglRenderbuffer)}}else{setupRenderBuffer(renderTarget.__webglRenderbuffer,renderTarget)}if(isTargetPowerOfTwo)_gl.generateMipmap(_gl.TEXTURE_2D)}if(isCube){_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,null)}else{_gl.bindTexture(_gl.TEXTURE_2D,null)}_gl.bindRenderbuffer(_gl.RENDERBUFFER,null);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)}var framebuffer,width,height,vx,vy;if(renderTarget){if(isCube){framebuffer=renderTarget.__webglFramebuffer[renderTarget.activeCubeFace]}else{framebuffer=renderTarget.__webglFramebuffer}width=renderTarget.width;height=renderTarget.height;vx=0;vy=0}else{framebuffer=null;width=_viewportWidth;height=_viewportHeight;vx=_viewportX;vy=_viewportY}if(framebuffer!==_currentFramebuffer){_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);_gl.viewport(vx,vy,width,height);_currentFramebuffer=framebuffer}_currentWidth=width;_currentHeight=height};function updateRenderTargetMipmap(renderTarget){if(renderTarget instanceof THREE.WebGLRenderTargetCube){_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,renderTarget.__webglTexture);_gl.generateMipmap(_gl.TEXTURE_CUBE_MAP);_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,null)}else{_gl.bindTexture(_gl.TEXTURE_2D,renderTarget.__webglTexture);_gl.generateMipmap(_gl.TEXTURE_2D);_gl.bindTexture(_gl.TEXTURE_2D,null)}}function filterFallback(f){if(f===THREE.NearestFilter||f===THREE.NearestMipMapNearestFilter||f===THREE.NearestMipMapLinearFilter){return _gl.NEAREST}return _gl.LINEAR}function paramThreeToGL(p){if(p===THREE.RepeatWrapping)return _gl.REPEAT;if(p===THREE.ClampToEdgeWrapping)return _gl.CLAMP_TO_EDGE;if(p===THREE.MirroredRepeatWrapping)return _gl.MIRRORED_REPEAT;if(p===THREE.NearestFilter)return _gl.NEAREST;if(p===THREE.NearestMipMapNearestFilter)return _gl.NEAREST_MIPMAP_NEAREST;if(p===THREE.NearestMipMapLinearFilter)return _gl.NEAREST_MIPMAP_LINEAR;if(p===THREE.LinearFilter)return _gl.LINEAR;if(p===THREE.LinearMipMapNearestFilter)return _gl.LINEAR_MIPMAP_NEAREST;if(p===THREE.LinearMipMapLinearFilter)return _gl.LINEAR_MIPMAP_LINEAR;if(p===THREE.UnsignedByteType)return _gl.UNSIGNED_BYTE;if(p===THREE.UnsignedShort4444Type)return _gl.UNSIGNED_SHORT_4_4_4_4;if(p===THREE.UnsignedShort5551Type)return _gl.UNSIGNED_SHORT_5_5_5_1;if(p===THREE.UnsignedShort565Type)return _gl.UNSIGNED_SHORT_5_6_5;if(p===THREE.ByteType)return _gl.BYTE;if(p===THREE.ShortType)return _gl.SHORT;if(p===THREE.UnsignedShortType)return _gl.UNSIGNED_SHORT;if(p===THREE.IntType)return _gl.INT;if(p===THREE.UnsignedIntType)return _gl.UNSIGNED_INT;if(p===THREE.FloatType)return _gl.FLOAT;if(p===THREE.AlphaFormat)return _gl.ALPHA;if(p===THREE.RGBFormat)return _gl.RGB;if(p===THREE.RGBAFormat)return _gl.RGBA;if(p===THREE.LuminanceFormat)return _gl.LUMINANCE;if(p===THREE.LuminanceAlphaFormat)return _gl.LUMINANCE_ALPHA;if(p===THREE.AddEquation)return _gl.FUNC_ADD;if(p===THREE.SubtractEquation)return _gl.FUNC_SUBTRACT;if(p===THREE.ReverseSubtractEquation)return _gl.FUNC_REVERSE_SUBTRACT;if(p===THREE.ZeroFactor)return _gl.ZERO;if(p===THREE.OneFactor)return _gl.ONE;if(p===THREE.SrcColorFactor)return _gl.SRC_COLOR;if(p===THREE.OneMinusSrcColorFactor)return _gl.ONE_MINUS_SRC_COLOR;if(p===THREE.SrcAlphaFactor)return _gl.SRC_ALPHA;if(p===THREE.OneMinusSrcAlphaFactor)return _gl.ONE_MINUS_SRC_ALPHA;if(p===THREE.DstAlphaFactor)return _gl.DST_ALPHA;if(p===THREE.OneMinusDstAlphaFactor)return _gl.ONE_MINUS_DST_ALPHA;if(p===THREE.DstColorFactor)return _gl.DST_COLOR;if(p===THREE.OneMinusDstColorFactor)return _gl.ONE_MINUS_DST_COLOR;if(p===THREE.SrcAlphaSaturateFactor)return _gl.SRC_ALPHA_SATURATE;if(_glExtensionCompressedTextureS3TC!==undefined){if(p===THREE.RGB_S3TC_DXT1_Format)return _glExtensionCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;if(p===THREE.RGBA_S3TC_DXT1_Format)return _glExtensionCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(p===THREE.RGBA_S3TC_DXT3_Format)return _glExtensionCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(p===THREE.RGBA_S3TC_DXT5_Format)return _glExtensionCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT}return 0}function allocateBones(object){if(_supportsBoneTextures&&object&&object.useVertexTexture){return 1024}else{var nVertexUniforms=_gl.getParameter(_gl.MAX_VERTEX_UNIFORM_VECTORS);var nVertexMatrices=Math.floor((nVertexUniforms-20)/4);var maxBones=nVertexMatrices;if(object!==undefined&&object instanceof THREE.SkinnedMesh){maxBones=Math.min(object.bones.length,maxBones);if(maxBones<object.bones.length){console.warn("WebGLRenderer: too many bones - "+object.bones.length+", this GPU supports just "+maxBones+" (try OpenGL instead of ANGLE)")}}return maxBones}}function allocateLights(lights){var l,ll,light,dirLights,pointLights,spotLights,hemiLights;dirLights=pointLights=spotLights=hemiLights=0;for(l=0,ll=lights.length;l<ll;l++){light=lights[l];if(light.onlyShadow)continue;if(light instanceof THREE.DirectionalLight)dirLights++;if(light instanceof THREE.PointLight)pointLights++;if(light instanceof THREE.SpotLight)spotLights++;if(light instanceof THREE.HemisphereLight)hemiLights++}return{directional:dirLights,point:pointLights,spot:spotLights,hemi:hemiLights}}function allocateShadows(lights){var l,ll,light,maxShadows=0;for(l=0,ll=lights.length;l<ll;l++){light=lights[l];if(!light.castShadow)continue;if(light instanceof THREE.SpotLight)maxShadows++;if(light instanceof THREE.DirectionalLight&&!light.shadowCascade)maxShadows++}return maxShadows}function initGL(){try{if(!(_gl=_canvas.getContext("experimental-webgl",{alpha:_alpha,premultipliedAlpha:_premultipliedAlpha,antialias:_antialias,stencil:_stencil,preserveDrawingBuffer:_preserveDrawingBuffer}))){throw"Error creating WebGL context."}}catch(error){console.error(error)}_glExtensionTextureFloat=_gl.getExtension("OES_texture_float");_glExtensionStandardDerivatives=_gl.getExtension("OES_standard_derivatives");_glExtensionTextureFilterAnisotropic=_gl.getExtension("EXT_texture_filter_anisotropic")||_gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||_gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");_glExtensionCompressedTextureS3TC=_gl.getExtension("WEBGL_compressed_texture_s3tc")||_gl.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||_gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");if(!_glExtensionTextureFloat){console.log("THREE.WebGLRenderer: Float textures not supported.")}if(!_glExtensionStandardDerivatives){console.log("THREE.WebGLRenderer: Standard derivatives not supported.")}if(!_glExtensionTextureFilterAnisotropic){console.log("THREE.WebGLRenderer: Anisotropic texture filtering not supported.")}if(!_glExtensionCompressedTextureS3TC){console.log("THREE.WebGLRenderer: S3TC compressed textures not supported.")}if(_gl.getShaderPrecisionFormat===undefined){_gl.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}}}function setDefaultGLState(){_gl.clearColor(0,0,0,1);_gl.clearDepth(1);_gl.clearStencil(0);_gl.enable(_gl.DEPTH_TEST);_gl.depthFunc(_gl.LEQUAL);_gl.frontFace(_gl.CCW);_gl.cullFace(_gl.BACK);_gl.enable(_gl.CULL_FACE);_gl.enable(_gl.BLEND);_gl.blendEquation(_gl.FUNC_ADD);_gl.blendFunc(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA);_gl.clearColor(_clearColor.r,_clearColor.g,_clearColor.b,_clearAlpha)}this.shadowMapPlugin=new THREE.ShadowMapPlugin;this.addPrePlugin(this.shadowMapPlugin);this.addPostPlugin(new THREE.SpritePlugin);this.addPostPlugin(new THREE.LensFlarePlugin)};THREE.WebGLRenderTarget=function(width,height,options){this.width=width;this.height=height;options=options||{};this.wrapS=options.wrapS!==undefined?options.wrapS:THREE.ClampToEdgeWrapping;this.wrapT=options.wrapT!==undefined?options.wrapT:THREE.ClampToEdgeWrapping;this.magFilter=options.magFilter!==undefined?options.magFilter:THREE.LinearFilter;this.minFilter=options.minFilter!==undefined?options.minFilter:THREE.LinearMipMapLinearFilter;
this.anisotropy=options.anisotropy!==undefined?options.anisotropy:1;this.offset=new THREE.Vector2(0,0);this.repeat=new THREE.Vector2(1,1);this.format=options.format!==undefined?options.format:THREE.RGBAFormat;this.type=options.type!==undefined?options.type:THREE.UnsignedByteType;this.depthBuffer=options.depthBuffer!==undefined?options.depthBuffer:true;this.stencilBuffer=options.stencilBuffer!==undefined?options.stencilBuffer:true;this.generateMipmaps=true;this.shareDepthFrom=null};THREE.WebGLRenderTarget.prototype={constructor:THREE.WebGLRenderTarget,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,clone:function(){var tmp=new THREE.WebGLRenderTarget(this.width,this.height);tmp.wrapS=this.wrapS;tmp.wrapT=this.wrapT;tmp.magFilter=this.magFilter;tmp.minFilter=this.minFilter;tmp.anisotropy=this.anisotropy;tmp.offset.copy(this.offset);tmp.repeat.copy(this.repeat);tmp.format=this.format;tmp.type=this.type;tmp.depthBuffer=this.depthBuffer;tmp.stencilBuffer=this.stencilBuffer;tmp.generateMipmaps=this.generateMipmaps;tmp.shareDepthFrom=this.shareDepthFrom;return tmp},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.WebGLRenderTargetCube=function(width,height,options){THREE.WebGLRenderTarget.call(this,width,height,options);this.activeCubeFace=0};THREE.WebGLRenderTargetCube.prototype=Object.create(THREE.WebGLRenderTarget.prototype);THREE.RenderableVertex=function(){this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=true};THREE.RenderableVertex.prototype.copy=function(vertex){this.positionWorld.copy(vertex.positionWorld);this.positionScreen.copy(vertex.positionScreen)};THREE.RenderableFace3=function(){this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.centroidModel=new THREE.Vector3;this.normalModel=new THREE.Vector3;this.normalModelView=new THREE.Vector3;this.vertexNormalsLength=0;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsModelView=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.color=null;this.material=null;this.uvs=[[]];this.z=null};THREE.RenderableFace4=function(){this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.v4=new THREE.RenderableVertex;this.centroidModel=new THREE.Vector3;this.normalModel=new THREE.Vector3;this.normalModelView=new THREE.Vector3;this.vertexNormalsLength=0;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsModelView=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.color=null;this.material=null;this.uvs=[[]];this.z=null};THREE.RenderableObject=function(){this.object=null;this.z=null};THREE.RenderableParticle=function(){this.object=null;this.x=null;this.y=null;this.z=null;this.rotation=null;this.scale=new THREE.Vector2;this.material=null};THREE.RenderableLine=function(){this.z=null;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null};THREE.GeometryUtils={merge:function(geometry1,object2,materialIndexOffset){var matrix,normalMatrix,vertexOffset=geometry1.vertices.length,uvPosition=geometry1.faceVertexUvs[0].length,geometry2=object2 instanceof THREE.Mesh?object2.geometry:object2,vertices1=geometry1.vertices,vertices2=geometry2.vertices,faces1=geometry1.faces,faces2=geometry2.faces,uvs1=geometry1.faceVertexUvs[0],uvs2=geometry2.faceVertexUvs[0];if(materialIndexOffset===undefined)materialIndexOffset=0;if(object2 instanceof THREE.Mesh){object2.matrixAutoUpdate&&object2.updateMatrix();matrix=object2.matrix;normalMatrix=(new THREE.Matrix3).getNormalMatrix(matrix)}for(var i=0,il=vertices2.length;i<il;i++){var vertex=vertices2[i];var vertexCopy=vertex.clone();if(matrix)vertexCopy.applyMatrix4(matrix);vertices1.push(vertexCopy)}for(i=0,il=faces2.length;i<il;i++){var face=faces2[i],faceCopy,normal,color,faceVertexNormals=face.vertexNormals,faceVertexColors=face.vertexColors;if(face instanceof THREE.Face3){faceCopy=new THREE.Face3(face.a+vertexOffset,face.b+vertexOffset,face.c+vertexOffset)}else if(face instanceof THREE.Face4){faceCopy=new THREE.Face4(face.a+vertexOffset,face.b+vertexOffset,face.c+vertexOffset,face.d+vertexOffset)}faceCopy.normal.copy(face.normal);if(normalMatrix){faceCopy.normal.applyMatrix3(normalMatrix).normalize()}for(var j=0,jl=faceVertexNormals.length;j<jl;j++){normal=faceVertexNormals[j].clone();if(normalMatrix){normal.applyMatrix3(normalMatrix).normalize()}faceCopy.vertexNormals.push(normal)}faceCopy.color.copy(face.color);for(var j=0,jl=faceVertexColors.length;j<jl;j++){color=faceVertexColors[j];faceCopy.vertexColors.push(color.clone())}faceCopy.materialIndex=face.materialIndex+materialIndexOffset;faceCopy.centroid.copy(face.centroid);if(matrix){faceCopy.centroid.applyMatrix4(matrix)}faces1.push(faceCopy)}for(i=0,il=uvs2.length;i<il;i++){var uv=uvs2[i],uvCopy=[];for(var j=0,jl=uv.length;j<jl;j++){uvCopy.push(new THREE.Vector2(uv[j].x,uv[j].y))}uvs1.push(uvCopy)}},removeMaterials:function(geometry,materialIndexArray){var materialIndexMap={};for(var i=0,il=materialIndexArray.length;i<il;i++){materialIndexMap[materialIndexArray[i]]=true}var face,newFaces=[];for(var i=0,il=geometry.faces.length;i<il;i++){face=geometry.faces[i];if(!(face.materialIndex in materialIndexMap))newFaces.push(face)}geometry.faces=newFaces},randomPointInTriangle:function(vectorA,vectorB,vectorC){var a,b,c,point=new THREE.Vector3,tmp=THREE.GeometryUtils.__v1;a=THREE.GeometryUtils.random();b=THREE.GeometryUtils.random();if(a+b>1){a=1-a;b=1-b}c=1-a-b;point.copy(vectorA);point.multiplyScalar(a);tmp.copy(vectorB);tmp.multiplyScalar(b);point.add(tmp);tmp.copy(vectorC);tmp.multiplyScalar(c);point.add(tmp);return point},randomPointInFace:function(face,geometry,useCachedAreas){var vA,vB,vC,vD;if(face instanceof THREE.Face3){vA=geometry.vertices[face.a];vB=geometry.vertices[face.b];vC=geometry.vertices[face.c];return THREE.GeometryUtils.randomPointInTriangle(vA,vB,vC)}else if(face instanceof THREE.Face4){vA=geometry.vertices[face.a];vB=geometry.vertices[face.b];vC=geometry.vertices[face.c];vD=geometry.vertices[face.d];var area1,area2;if(useCachedAreas){if(face._area1&&face._area2){area1=face._area1;area2=face._area2}else{area1=THREE.GeometryUtils.triangleArea(vA,vB,vD);area2=THREE.GeometryUtils.triangleArea(vB,vC,vD);face._area1=area1;face._area2=area2}}else{area1=THREE.GeometryUtils.triangleArea(vA,vB,vD),area2=THREE.GeometryUtils.triangleArea(vB,vC,vD)}var r=THREE.GeometryUtils.random()*(area1+area2);if(r<area1){return THREE.GeometryUtils.randomPointInTriangle(vA,vB,vD)}else{return THREE.GeometryUtils.randomPointInTriangle(vB,vC,vD)}}},randomPointsInGeometry:function(geometry,n){var face,i,faces=geometry.faces,vertices=geometry.vertices,il=faces.length,totalArea=0,cumulativeAreas=[],vA,vB,vC,vD;for(i=0;i<il;i++){face=faces[i];if(face instanceof THREE.Face3){vA=vertices[face.a];vB=vertices[face.b];vC=vertices[face.c];face._area=THREE.GeometryUtils.triangleArea(vA,vB,vC)}else if(face instanceof THREE.Face4){vA=vertices[face.a];vB=vertices[face.b];vC=vertices[face.c];vD=vertices[face.d];face._area1=THREE.GeometryUtils.triangleArea(vA,vB,vD);face._area2=THREE.GeometryUtils.triangleArea(vB,vC,vD);face._area=face._area1+face._area2}totalArea+=face._area;cumulativeAreas[i]=totalArea}function binarySearchIndices(value){function binarySearch(start,end){if(end<start)return start;var mid=start+Math.floor((end-start)/2);if(cumulativeAreas[mid]>value){return binarySearch(start,mid-1)}else if(cumulativeAreas[mid]<value){return binarySearch(mid+1,end)}else{return mid}}var result=binarySearch(0,cumulativeAreas.length-1);return result}var r,index,result=[];var stats={};for(i=0;i<n;i++){r=THREE.GeometryUtils.random()*totalArea;index=binarySearchIndices(r);result[i]=THREE.GeometryUtils.randomPointInFace(faces[index],geometry,true);if(!stats[index]){stats[index]=1}else{stats[index]+=1}}return result},triangleArea:function(vectorA,vectorB,vectorC){var tmp1=THREE.GeometryUtils.__v1,tmp2=THREE.GeometryUtils.__v2;tmp1.subVectors(vectorB,vectorA);tmp2.subVectors(vectorC,vectorA);tmp1.cross(tmp2);return.5*tmp1.length()},center:function(geometry){geometry.computeBoundingBox();var bb=geometry.boundingBox;var offset=new THREE.Vector3;offset.addVectors(bb.min,bb.max);offset.multiplyScalar(-.5);geometry.applyMatrix((new THREE.Matrix4).makeTranslation(offset.x,offset.y,offset.z));geometry.computeBoundingBox();return offset},normalizeUVs:function(geometry){var uvSet=geometry.faceVertexUvs[0];for(var i=0,il=uvSet.length;i<il;i++){var uvs=uvSet[i];for(var j=0,jl=uvs.length;j<jl;j++){if(uvs[j].x!==1)uvs[j].x=uvs[j].x-Math.floor(uvs[j].x);if(uvs[j].y!==1)uvs[j].y=uvs[j].y-Math.floor(uvs[j].y)}}},triangulateQuads:function(geometry){var i,il,j,jl;var faces=[];var faceUvs=[];var faceVertexUvs=[];for(i=0,il=geometry.faceUvs.length;i<il;i++){faceUvs[i]=[]}for(i=0,il=geometry.faceVertexUvs.length;i<il;i++){faceVertexUvs[i]=[]}for(i=0,il=geometry.faces.length;i<il;i++){var face=geometry.faces[i];if(face instanceof THREE.Face4){var a=face.a;var b=face.b;var c=face.c;var d=face.d;var triA=new THREE.Face3;var triB=new THREE.Face3;triA.color.copy(face.color);triB.color.copy(face.color);triA.materialIndex=face.materialIndex;triB.materialIndex=face.materialIndex;triA.a=a;triA.b=b;triA.c=d;triB.a=b;triB.b=c;triB.c=d;if(face.vertexColors.length===4){triA.vertexColors[0]=face.vertexColors[0].clone();triA.vertexColors[1]=face.vertexColors[1].clone();triA.vertexColors[2]=face.vertexColors[3].clone();triB.vertexColors[0]=face.vertexColors[1].clone();triB.vertexColors[1]=face.vertexColors[2].clone();triB.vertexColors[2]=face.vertexColors[3].clone()}faces.push(triA,triB);for(j=0,jl=geometry.faceVertexUvs.length;j<jl;j++){if(geometry.faceVertexUvs[j].length){var uvs=geometry.faceVertexUvs[j][i];var uvA=uvs[0];var uvB=uvs[1];var uvC=uvs[2];var uvD=uvs[3];var uvsTriA=[uvA.clone(),uvB.clone(),uvD.clone()];var uvsTriB=[uvB.clone(),uvC.clone(),uvD.clone()];faceVertexUvs[j].push(uvsTriA,uvsTriB)}}for(j=0,jl=geometry.faceUvs.length;j<jl;j++){if(geometry.faceUvs[j].length){var faceUv=geometry.faceUvs[j][i];faceUvs[j].push(faceUv,faceUv)}}}else{faces.push(face);for(j=0,jl=geometry.faceUvs.length;j<jl;j++){faceUvs[j].push(geometry.faceUvs[j][i])}for(j=0,jl=geometry.faceVertexUvs.length;j<jl;j++){faceVertexUvs[j].push(geometry.faceVertexUvs[j][i])}}}geometry.faces=faces;geometry.faceUvs=faceUvs;geometry.faceVertexUvs=faceVertexUvs;geometry.computeCentroids();geometry.computeFaceNormals();geometry.computeVertexNormals();if(geometry.hasTangents)geometry.computeTangents()},setMaterialIndex:function(geometry,index,startFace,endFace){var faces=geometry.faces;var start=startFace||0;var end=endFace||faces.length-1;for(var i=start;i<=end;i++){faces[i].materialIndex=index}}};THREE.GeometryUtils.random=THREE.Math.random16;THREE.GeometryUtils.__v1=new THREE.Vector3;THREE.GeometryUtils.__v2=new THREE.Vector3;THREE.ImageUtils={crossOrigin:"anonymous",loadTexture:function(url,mapping,onLoad,onError){var image=new Image;var texture=new THREE.Texture(image,mapping);var loader=new THREE.ImageLoader;loader.addEventListener("load",function(event){texture.image=event.content;texture.needsUpdate=true;if(onLoad)onLoad(texture)});loader.addEventListener("error",function(event){if(onError)onError(event.message)});loader.crossOrigin=this.crossOrigin;loader.load(url,image);texture.sourceFile=url;return texture},loadCompressedTexture:function(url,mapping,onLoad,onError){var texture=new THREE.CompressedTexture;texture.mapping=mapping;var request=new XMLHttpRequest;request.onload=function(){var buffer=request.response;var dds=THREE.ImageUtils.parseDDS(buffer,true);texture.format=dds.format;texture.mipmaps=dds.mipmaps;texture.image.width=dds.width;texture.image.height=dds.height;texture.generateMipmaps=false;texture.needsUpdate=true;if(onLoad)onLoad(texture)};request.onerror=onError;request.open("GET",url,true);request.responseType="arraybuffer";request.send(null);return texture},loadTextureCube:function(array,mapping,onLoad,onError){var images=[];images.loadCount=0;var texture=new THREE.Texture;texture.image=images;if(mapping!==undefined)texture.mapping=mapping;texture.flipY=false;for(var i=0,il=array.length;i<il;++i){var cubeImage=new Image;images[i]=cubeImage;cubeImage.onload=function(){images.loadCount+=1;if(images.loadCount===6){texture.needsUpdate=true;if(onLoad)onLoad(texture)}};cubeImage.onerror=onError;cubeImage.crossOrigin=this.crossOrigin;cubeImage.src=array[i]}return texture},loadCompressedTextureCube:function(array,mapping,onLoad,onError){var images=[];images.loadCount=0;var texture=new THREE.CompressedTexture;texture.image=images;if(mapping!==undefined)texture.mapping=mapping;texture.flipY=false;texture.generateMipmaps=false;var generateCubeFaceCallback=function(rq,img){return function(){var buffer=rq.response;var dds=THREE.ImageUtils.parseDDS(buffer,true);img.format=dds.format;img.mipmaps=dds.mipmaps;img.width=dds.width;img.height=dds.height;images.loadCount+=1;if(images.loadCount===6){texture.format=dds.format;texture.needsUpdate=true;if(onLoad)onLoad(texture)}}};if(array instanceof Array){for(var i=0,il=array.length;i<il;++i){var cubeImage={};images[i]=cubeImage;var request=new XMLHttpRequest;request.onload=generateCubeFaceCallback(request,cubeImage);request.onerror=onError;var url=array[i];request.open("GET",url,true);request.responseType="arraybuffer";request.send(null)}}else{var url=array;var request=new XMLHttpRequest;request.onload=function(){var buffer=request.response;var dds=THREE.ImageUtils.parseDDS(buffer,true);if(dds.isCubemap){var faces=dds.mipmaps.length/dds.mipmapCount;for(var f=0;f<faces;f++){images[f]={mipmaps:[]};for(var i=0;i<dds.mipmapCount;i++){images[f].mipmaps.push(dds.mipmaps[f*dds.mipmapCount+i]);images[f].format=dds.format;images[f].width=dds.width;images[f].height=dds.height}}texture.format=dds.format;texture.needsUpdate=true;if(onLoad)onLoad(texture)}};request.onerror=onError;request.open("GET",url,true);request.responseType="arraybuffer";request.send(null)}return texture},parseDDS:function(buffer,loadMipmaps){var dds={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};var DDS_MAGIC=542327876;var DDSD_CAPS=1,DDSD_HEIGHT=2,DDSD_WIDTH=4,DDSD_PITCH=8,DDSD_PIXELFORMAT=4096,DDSD_MIPMAPCOUNT=131072,DDSD_LINEARSIZE=524288,DDSD_DEPTH=8388608;var DDSCAPS_COMPLEX=8,DDSCAPS_MIPMAP=4194304,DDSCAPS_TEXTURE=4096;var DDSCAPS2_CUBEMAP=512,DDSCAPS2_CUBEMAP_POSITIVEX=1024,DDSCAPS2_CUBEMAP_NEGATIVEX=2048,DDSCAPS2_CUBEMAP_POSITIVEY=4096,DDSCAPS2_CUBEMAP_NEGATIVEY=8192,DDSCAPS2_CUBEMAP_POSITIVEZ=16384,DDSCAPS2_CUBEMAP_NEGATIVEZ=32768,DDSCAPS2_VOLUME=2097152;var DDPF_ALPHAPIXELS=1,DDPF_ALPHA=2,DDPF_FOURCC=4,DDPF_RGB=64,DDPF_YUV=512,DDPF_LUMINANCE=131072;function fourCCToInt32(value){return value.charCodeAt(0)+(value.charCodeAt(1)<<8)+(value.charCodeAt(2)<<16)+(value.charCodeAt(3)<<24)}function int32ToFourCC(value){return String.fromCharCode(value&255,value>>8&255,value>>16&255,value>>24&255)}var FOURCC_DXT1=fourCCToInt32("DXT1");var FOURCC_DXT3=fourCCToInt32("DXT3");var FOURCC_DXT5=fourCCToInt32("DXT5");var headerLengthInt=31;var off_magic=0;var off_size=1;var off_flags=2;var off_height=3;var off_width=4;var off_mipmapCount=7;var off_pfFlags=20;var off_pfFourCC=21;var off_caps=27;var off_caps2=28;var off_caps3=29;var off_caps4=30;var header=new Int32Array(buffer,0,headerLengthInt);if(header[off_magic]!==DDS_MAGIC){console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header");return dds}if(!header[off_pfFlags]&DDPF_FOURCC){console.error("ImageUtils.parseDDS(): Unsupported format, must contain a FourCC code");return dds}var blockBytes;var fourCC=header[off_pfFourCC];switch(fourCC){case FOURCC_DXT1:blockBytes=8;dds.format=THREE.RGB_S3TC_DXT1_Format;break;case FOURCC_DXT3:blockBytes=16;dds.format=THREE.RGBA_S3TC_DXT3_Format;break;case FOURCC_DXT5:blockBytes=16;dds.format=THREE.RGBA_S3TC_DXT5_Format;break;default:console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",int32ToFourCC(fourCC));return dds}dds.mipmapCount=1;if(header[off_flags]&DDSD_MIPMAPCOUNT&&loadMipmaps!==false){dds.mipmapCount=Math.max(1,header[off_mipmapCount])}dds.isCubemap=header[off_caps2]&DDSCAPS2_CUBEMAP?true:false;dds.width=header[off_width];dds.height=header[off_height];var dataOffset=header[off_size]+4;var width=dds.width;var height=dds.height;var faces=dds.isCubemap?6:1;for(var face=0;face<faces;face++){for(var i=0;i<dds.mipmapCount;i++){var dataLength=Math.max(4,width)/4*Math.max(4,height)/4*blockBytes;var byteArray=new Uint8Array(buffer,dataOffset,dataLength);var mipmap={data:byteArray,width:width,height:height};dds.mipmaps.push(mipmap);dataOffset+=dataLength;width=Math.max(width*.5,1);height=Math.max(height*.5,1)}width=dds.width;height=dds.height}return dds},getNormalMap:function(image,depth){var cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};var subtract=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};var normalize=function(a){var l=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return[a[0]/l,a[1]/l,a[2]/l]};depth=depth|1;var width=image.width;var height=image.height;var canvas=document.createElement("canvas");canvas.width=width;canvas.height=height;var context=canvas.getContext("2d");context.drawImage(image,0,0);var data=context.getImageData(0,0,width,height).data;var imageData=context.createImageData(width,height);var output=imageData.data;for(var x=0;x<width;x++){for(var y=0;y<height;y++){var ly=y-1<0?0:y-1;var uy=y+1>height-1?height-1:y+1;var lx=x-1<0?0:x-1;var ux=x+1>width-1?width-1:x+1;var points=[];var origin=[0,0,data[(y*width+x)*4]/255*depth];points.push([-1,0,data[(y*width+lx)*4]/255*depth]);points.push([-1,-1,data[(ly*width+lx)*4]/255*depth]);points.push([0,-1,data[(ly*width+x)*4]/255*depth]);points.push([1,-1,data[(ly*width+ux)*4]/255*depth]);points.push([1,0,data[(y*width+ux)*4]/255*depth]);points.push([1,1,data[(uy*width+ux)*4]/255*depth]);points.push([0,1,data[(uy*width+x)*4]/255*depth]);points.push([-1,1,data[(uy*width+lx)*4]/255*depth]);var normals=[];var num_points=points.length;for(var i=0;i<num_points;i++){var v1=points[i];var v2=points[(i+1)%num_points];v1=subtract(v1,origin);v2=subtract(v2,origin);normals.push(normalize(cross(v1,v2)))}var normal=[0,0,0];for(var i=0;i<normals.length;i++){normal[0]+=normals[i][0];normal[1]+=normals[i][1];normal[2]+=normals[i][2]}normal[0]/=normals.length;normal[1]/=normals.length;normal[2]/=normals.length;var idx=(y*width+x)*4;output[idx]=(normal[0]+1)/2*255|0;output[idx+1]=(normal[1]+1)/2*255|0;output[idx+2]=normal[2]*255|0;output[idx+3]=255}}context.putImageData(imageData,0,0);return canvas},generateDataTexture:function(width,height,color){var size=width*height;var data=new Uint8Array(3*size);var r=Math.floor(color.r*255);var g=Math.floor(color.g*255);var b=Math.floor(color.b*255);for(var i=0;i<size;i++){data[i*3]=r;data[i*3+1]=g;data[i*3+2]=b}var texture=new THREE.DataTexture(data,width,height,THREE.RGBFormat);texture.needsUpdate=true;return texture}};THREE.SceneUtils={createMultiMaterialObject:function(geometry,materials){var group=new THREE.Object3D;for(var i=0,l=materials.length;i<l;i++){group.add(new THREE.Mesh(geometry,materials[i]))}return group},detach:function(child,parent,scene){child.applyMatrix(parent.matrixWorld);parent.remove(child);scene.add(child)},attach:function(child,scene,parent){var matrixWorldInverse=new THREE.Matrix4;matrixWorldInverse.getInverse(parent.matrixWorld);child.applyMatrix(matrixWorldInverse);scene.remove(child);parent.add(child)}};THREE.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(data){var family=data.familyName.toLowerCase();var ThreeFont=this;ThreeFont.faces[family]=ThreeFont.faces[family]||{};ThreeFont.faces[family][data.cssFontWeight]=ThreeFont.faces[family][data.cssFontWeight]||{};ThreeFont.faces[family][data.cssFontWeight][data.cssFontStyle]=data;var face=ThreeFont.faces[family][data.cssFontWeight][data.cssFontStyle]=data;return data},drawText:function(text){var characterPts=[],allPts=[];var i,p,face=this.getFace(),scale=this.size/face.resolution,offset=0,chars=String(text).split(""),length=chars.length;var fontPaths=[];for(i=0;i<length;i++){var path=new THREE.Path;var ret=this.extractGlyphPoints(chars[i],face,scale,offset,path);offset+=ret.offset;fontPaths.push(ret.path)}var width=offset/2;return{paths:fontPaths,offset:width}},extractGlyphPoints:function(c,face,scale,offset,path){var pts=[];var i,i2,divisions,outline,action,length,scaleX,scaleY,x,y,cpx,cpy,cpx0,cpy0,cpx1,cpy1,cpx2,cpy2,laste,glyph=face.glyphs[c]||face.glyphs["?"];if(!glyph)return;if(glyph.o){outline=glyph._cachedOutline||(glyph._cachedOutline=glyph.o.split(" "));length=outline.length;scaleX=scale;scaleY=scale;for(i=0;i<length;){action=outline[i++];switch(action){case"m":x=outline[i++]*scaleX+offset;y=outline[i++]*scaleY;path.moveTo(x,y);break;case"l":x=outline[i++]*scaleX+offset;y=outline[i++]*scaleY;path.lineTo(x,y);break;case"q":cpx=outline[i++]*scaleX+offset;cpy=outline[i++]*scaleY;cpx1=outline[i++]*scaleX+offset;cpy1=outline[i++]*scaleY;path.quadraticCurveTo(cpx1,cpy1,cpx,cpy);laste=pts[pts.length-1];if(laste){cpx0=laste.x;cpy0=laste.y;for(i2=1,divisions=this.divisions;i2<=divisions;i2++){var t=i2/divisions;var tx=THREE.Shape.Utils.b2(t,cpx0,cpx1,cpx);var ty=THREE.Shape.Utils.b2(t,cpy0,cpy1,cpy)}}break;case"b":cpx=outline[i++]*scaleX+offset;cpy=outline[i++]*scaleY;cpx1=outline[i++]*scaleX+offset;cpy1=outline[i++]*-scaleY;cpx2=outline[i++]*scaleX+offset;cpy2=outline[i++]*-scaleY;path.bezierCurveTo(cpx,cpy,cpx1,cpy1,cpx2,cpy2);laste=pts[pts.length-1];if(laste){cpx0=laste.x;cpy0=laste.y;for(i2=1,divisions=this.divisions;i2<=divisions;i2++){var t=i2/divisions;var tx=THREE.Shape.Utils.b3(t,cpx0,cpx1,cpx2,cpx);var ty=THREE.Shape.Utils.b3(t,cpy0,cpy1,cpy2,cpy)}}break}}}return{offset:glyph.ha*scale,path:path}}};THREE.FontUtils.generateShapes=function(text,parameters){parameters=parameters||{};var size=parameters.size!==undefined?parameters.size:100;var curveSegments=parameters.curveSegments!==undefined?parameters.curveSegments:4;var font=parameters.font!==undefined?parameters.font:"helvetiker";var weight=parameters.weight!==undefined?parameters.weight:"normal";var style=parameters.style!==undefined?parameters.style:"normal";THREE.FontUtils.size=size;THREE.FontUtils.divisions=curveSegments;THREE.FontUtils.face=font;THREE.FontUtils.weight=weight;THREE.FontUtils.style=style;var data=THREE.FontUtils.drawText(text);var paths=data.paths;var shapes=[];for(var p=0,pl=paths.length;p<pl;p++){Array.prototype.push.apply(shapes,paths[p].toShapes())}return shapes};(function(namespace){var EPSILON=1e-10;var process=function(contour,indices){var n=contour.length;if(n<3)return null;var result=[],verts=[],vertIndices=[];var u,v,w;if(area(contour)>0){for(v=0;v<n;v++)verts[v]=v}else{for(v=0;v<n;v++)verts[v]=n-1-v}var nv=n;var count=2*nv;for(v=nv-1;nv>2;){if(count--<=0){console.log("Warning, unable to triangulate polygon!");if(indices)return vertIndices;return result}u=v;if(nv<=u)u=0;v=u+1;if(nv<=v)v=0;w=v+1;if(nv<=w)w=0;if(snip(contour,u,v,w,nv,verts)){var a,b,c,s,t;a=verts[u];b=verts[v];c=verts[w];result.push([contour[a],contour[b],contour[c]]);vertIndices.push([verts[u],verts[v],verts[w]]);for(s=v,t=v+1;t<nv;s++,t++){verts[s]=verts[t]}nv--;count=2*nv}}if(indices)return vertIndices;return result};var area=function(contour){var n=contour.length;var a=0;for(var p=n-1,q=0;q<n;p=q++){a+=contour[p].x*contour[q].y-contour[q].x*contour[p].y}return a*.5};var snip=function(contour,u,v,w,n,verts){var p;var ax,ay,bx,by;var cx,cy,px,py;ax=contour[verts[u]].x;ay=contour[verts[u]].y;bx=contour[verts[v]].x;by=contour[verts[v]].y;cx=contour[verts[w]].x;cy=contour[verts[w]].y;if(EPSILON>(bx-ax)*(cy-ay)-(by-ay)*(cx-ax))return false;var aX,aY,bX,bY,cX,cY;var apx,apy,bpx,bpy,cpx,cpy;var cCROSSap,bCROSScp,aCROSSbp;aX=cx-bx;aY=cy-by;bX=ax-cx;bY=ay-cy;cX=bx-ax;cY=by-ay;for(p=0;p<n;p++){if(p===u||p===v||p===w)continue;px=contour[verts[p]].x;py=contour[verts[p]].y;apx=px-ax;apy=py-ay;bpx=px-bx;bpy=py-by;cpx=px-cx;cpy=py-cy;aCROSSbp=aX*bpy-aY*bpx;cCROSSap=cX*apy-cY*apx;bCROSScp=bX*cpy-bY*cpx;if(aCROSSbp>=0&&bCROSScp>=0&&cCROSSap>=0)return false}return true};namespace.Triangulate=process;namespace.Triangulate.area=area;return namespace})(THREE.FontUtils);self._typeface_js={faces:THREE.FontUtils.faces,loadFace:THREE.FontUtils.loadFace};THREE.typeface_js=self._typeface_js;THREE.Curve=function(){};THREE.Curve.prototype.getPoint=function(t){console.log("Warning, getPoint() not implemented!");return null};THREE.Curve.prototype.getPointAt=function(u){var t=this.getUtoTmapping(u);return this.getPoint(t)};THREE.Curve.prototype.getPoints=function(divisions){if(!divisions)divisions=5;var d,pts=[];for(d=0;d<=divisions;d++){pts.push(this.getPoint(d/divisions))}return pts};THREE.Curve.prototype.getSpacedPoints=function(divisions){if(!divisions)divisions=5;var d,pts=[];for(d=0;d<=divisions;d++){pts.push(this.getPointAt(d/divisions))}return pts};THREE.Curve.prototype.getLength=function(){var lengths=this.getLengths();return lengths[lengths.length-1]};THREE.Curve.prototype.getLengths=function(divisions){if(!divisions)divisions=this.__arcLengthDivisions?this.__arcLengthDivisions:200;if(this.cacheArcLengths&&this.cacheArcLengths.length==divisions+1&&!this.needsUpdate){return this.cacheArcLengths}this.needsUpdate=false;var cache=[];var current,last=this.getPoint(0);var p,sum=0;cache.push(0);for(p=1;p<=divisions;p++){current=this.getPoint(p/divisions);sum+=current.distanceTo(last);cache.push(sum);last=current}this.cacheArcLengths=cache;return cache};THREE.Curve.prototype.updateArcLengths=function(){this.needsUpdate=true;this.getLengths()};THREE.Curve.prototype.getUtoTmapping=function(u,distance){var arcLengths=this.getLengths();var i=0,il=arcLengths.length;var targetArcLength;if(distance){targetArcLength=distance}else{targetArcLength=u*arcLengths[il-1]}var low=0,high=il-1,comparison;while(low<=high){i=Math.floor(low+(high-low)/2);comparison=arcLengths[i]-targetArcLength;if(comparison<0){low=i+1;continue}else if(comparison>0){high=i-1;continue}else{high=i;break}}i=high;if(arcLengths[i]==targetArcLength){var t=i/(il-1);return t}var lengthBefore=arcLengths[i];var lengthAfter=arcLengths[i+1];var segmentLength=lengthAfter-lengthBefore;var segmentFraction=(targetArcLength-lengthBefore)/segmentLength;var t=(i+segmentFraction)/(il-1);return t};THREE.Curve.prototype.getTangent=function(t){var delta=1e-4;var t1=t-delta;var t2=t+delta;if(t1<0)t1=0;if(t2>1)t2=1;var pt1=this.getPoint(t1);var pt2=this.getPoint(t2);var vec=pt2.clone().sub(pt1);return vec.normalize()};THREE.Curve.prototype.getTangentAt=function(u){var t=this.getUtoTmapping(u);return this.getTangent(t)};THREE.LineCurve=function(v1,v2){this.v1=v1;this.v2=v2};THREE.LineCurve.prototype=Object.create(THREE.Curve.prototype);THREE.LineCurve.prototype.getPoint=function(t){var point=this.v2.clone().sub(this.v1);point.multiplyScalar(t).add(this.v1);return point};THREE.LineCurve.prototype.getPointAt=function(u){return this.getPoint(u)};THREE.LineCurve.prototype.getTangent=function(t){var tangent=this.v2.clone().sub(this.v1);return tangent.normalize()};THREE.QuadraticBezierCurve=function(v0,v1,v2){this.v0=v0;this.v1=v1;this.v2=v2};THREE.QuadraticBezierCurve.prototype=Object.create(THREE.Curve.prototype);THREE.QuadraticBezierCurve.prototype.getPoint=function(t){var tx,ty;tx=THREE.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x);ty=THREE.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y);return new THREE.Vector2(tx,ty)};THREE.QuadraticBezierCurve.prototype.getTangent=function(t){var tx,ty;tx=THREE.Curve.Utils.tangentQuadraticBezier(t,this.v0.x,this.v1.x,this.v2.x);ty=THREE.Curve.Utils.tangentQuadraticBezier(t,this.v0.y,this.v1.y,this.v2.y);var tangent=new THREE.Vector2(tx,ty);tangent.normalize();return tangent};THREE.CubicBezierCurve=function(v0,v1,v2,v3){this.v0=v0;this.v1=v1;this.v2=v2;this.v3=v3};THREE.CubicBezierCurve.prototype=Object.create(THREE.Curve.prototype);THREE.CubicBezierCurve.prototype.getPoint=function(t){var tx,ty;tx=THREE.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x);ty=THREE.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y);return new THREE.Vector2(tx,ty)};THREE.CubicBezierCurve.prototype.getTangent=function(t){var tx,ty;tx=THREE.Curve.Utils.tangentCubicBezier(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x);ty=THREE.Curve.Utils.tangentCubicBezier(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y);var tangent=new THREE.Vector2(tx,ty);tangent.normalize();return tangent};THREE.SplineCurve=function(points){this.points=points==undefined?[]:points};THREE.SplineCurve.prototype=Object.create(THREE.Curve.prototype);THREE.SplineCurve.prototype.getPoint=function(t){var v=new THREE.Vector2;var c=[];var points=this.points,point,intPoint,weight;point=(points.length-1)*t;intPoint=Math.floor(point);weight=point-intPoint;c[0]=intPoint==0?intPoint:intPoint-1;c[1]=intPoint;c[2]=intPoint>points.length-2?points.length-1:intPoint+1;c[3]=intPoint>points.length-3?points.length-1:intPoint+2;v.x=THREE.Curve.Utils.interpolate(points[c[0]].x,points[c[1]].x,points[c[2]].x,points[c[3]].x,weight);v.y=THREE.Curve.Utils.interpolate(points[c[0]].y,points[c[1]].y,points[c[2]].y,points[c[3]].y,weight);return v};THREE.EllipseCurve=function(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise){this.aX=aX;this.aY=aY;this.xRadius=xRadius;this.yRadius=yRadius;this.aStartAngle=aStartAngle;this.aEndAngle=aEndAngle;this.aClockwise=aClockwise};THREE.EllipseCurve.prototype=Object.create(THREE.Curve.prototype);THREE.EllipseCurve.prototype.getPoint=function(t){var deltaAngle=this.aEndAngle-this.aStartAngle;if(!this.aClockwise){t=1-t}var angle=this.aStartAngle+t*deltaAngle;var tx=this.aX+this.xRadius*Math.cos(angle);var ty=this.aY+this.yRadius*Math.sin(angle);return new THREE.Vector2(tx,ty)};THREE.ArcCurve=function(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){THREE.EllipseCurve.call(this,aX,aY,aRadius,aRadius,aStartAngle,aEndAngle,aClockwise)};THREE.ArcCurve.prototype=Object.create(THREE.EllipseCurve.prototype);THREE.Curve.Utils={tangentQuadraticBezier:function(t,p0,p1,p2){return 2*(1-t)*(p1-p0)+2*t*(p2-p1)},tangentCubicBezier:function(t,p0,p1,p2,p3){return-3*p0*(1-t)*(1-t)+3*p1*(1-t)*(1-t)-6*t*p1*(1-t)+6*t*p2*(1-t)-3*t*t*p2+3*t*t*p3},tangentSpline:function(t,p0,p1,p2,p3){var h00=6*t*t-6*t;var h10=3*t*t-4*t+1;var h01=-6*t*t+6*t;var h11=3*t*t-2*t;return h00+h10+h01+h11},interpolate:function(p0,p1,p2,p3,t){var v0=(p2-p0)*.5;var v1=(p3-p1)*.5;var t2=t*t;var t3=t*t2;return(2*p1-2*p2+v0+v1)*t3+(-3*p1+3*p2-2*v0-v1)*t2+v0*t+p1}};THREE.Curve.create=function(constructor,getPointFunc){constructor.prototype=Object.create(THREE.Curve.prototype);constructor.prototype.getPoint=getPointFunc;return constructor};THREE.LineCurve3=THREE.Curve.create(function(v1,v2){this.v1=v1;this.v2=v2},function(t){var r=new THREE.Vector3;r.subVectors(this.v2,this.v1);r.multiplyScalar(t);r.add(this.v1);return r});THREE.QuadraticBezierCurve3=THREE.Curve.create(function(v0,v1,v2){this.v0=v0;this.v1=v1;this.v2=v2},function(t){var tx,ty,tz;tx=THREE.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x);ty=THREE.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y);tz=THREE.Shape.Utils.b2(t,this.v0.z,this.v1.z,this.v2.z);return new THREE.Vector3(tx,ty,tz)});THREE.CubicBezierCurve3=THREE.Curve.create(function(v0,v1,v2,v3){this.v0=v0;this.v1=v1;this.v2=v2;this.v3=v3},function(t){var tx,ty,tz;tx=THREE.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x);ty=THREE.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y);
tz=THREE.Shape.Utils.b3(t,this.v0.z,this.v1.z,this.v2.z,this.v3.z);return new THREE.Vector3(tx,ty,tz)});THREE.SplineCurve3=THREE.Curve.create(function(points){this.points=points==undefined?[]:points},function(t){var v=new THREE.Vector3;var c=[];var points=this.points,point,intPoint,weight;point=(points.length-1)*t;intPoint=Math.floor(point);weight=point-intPoint;c[0]=intPoint==0?intPoint:intPoint-1;c[1]=intPoint;c[2]=intPoint>points.length-2?points.length-1:intPoint+1;c[3]=intPoint>points.length-3?points.length-1:intPoint+2;var pt0=points[c[0]],pt1=points[c[1]],pt2=points[c[2]],pt3=points[c[3]];v.x=THREE.Curve.Utils.interpolate(pt0.x,pt1.x,pt2.x,pt3.x,weight);v.y=THREE.Curve.Utils.interpolate(pt0.y,pt1.y,pt2.y,pt3.y,weight);v.z=THREE.Curve.Utils.interpolate(pt0.z,pt1.z,pt2.z,pt3.z,weight);return v});THREE.ClosedSplineCurve3=THREE.Curve.create(function(points){this.points=points==undefined?[]:points},function(t){var v=new THREE.Vector3;var c=[];var points=this.points,point,intPoint,weight;point=(points.length-0)*t;intPoint=Math.floor(point);weight=point-intPoint;intPoint+=intPoint>0?0:(Math.floor(Math.abs(intPoint)/points.length)+1)*points.length;c[0]=(intPoint-1)%points.length;c[1]=intPoint%points.length;c[2]=(intPoint+1)%points.length;c[3]=(intPoint+2)%points.length;v.x=THREE.Curve.Utils.interpolate(points[c[0]].x,points[c[1]].x,points[c[2]].x,points[c[3]].x,weight);v.y=THREE.Curve.Utils.interpolate(points[c[0]].y,points[c[1]].y,points[c[2]].y,points[c[3]].y,weight);v.z=THREE.Curve.Utils.interpolate(points[c[0]].z,points[c[1]].z,points[c[2]].z,points[c[3]].z,weight);return v});THREE.CurvePath=function(){this.curves=[];this.bends=[];this.autoClose=false};THREE.CurvePath.prototype=Object.create(THREE.Curve.prototype);THREE.CurvePath.prototype.add=function(curve){this.curves.push(curve)};THREE.CurvePath.prototype.checkConnection=function(){};THREE.CurvePath.prototype.closePath=function(){var startPoint=this.curves[0].getPoint(0);var endPoint=this.curves[this.curves.length-1].getPoint(1);if(!startPoint.equals(endPoint)){this.curves.push(new THREE.LineCurve(endPoint,startPoint))}};THREE.CurvePath.prototype.getPoint=function(t){var d=t*this.getLength();var curveLengths=this.getCurveLengths();var i=0,diff,curve;while(i<curveLengths.length){if(curveLengths[i]>=d){diff=curveLengths[i]-d;curve=this.curves[i];var u=1-diff/curve.getLength();return curve.getPointAt(u);break}i++}return null};THREE.CurvePath.prototype.getLength=function(){var lens=this.getCurveLengths();return lens[lens.length-1]};THREE.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length){return this.cacheLengths}var lengths=[],sums=0;var i,il=this.curves.length;for(i=0;i<il;i++){sums+=this.curves[i].getLength();lengths.push(sums)}this.cacheLengths=lengths;return lengths};THREE.CurvePath.prototype.getBoundingBox=function(){var points=this.getPoints();var maxX,maxY,maxZ;var minX,minY,minZ;maxX=maxY=Number.NEGATIVE_INFINITY;minX=minY=Number.POSITIVE_INFINITY;var p,i,il,sum;var v3=points[0]instanceof THREE.Vector3;sum=v3?new THREE.Vector3:new THREE.Vector2;for(i=0,il=points.length;i<il;i++){p=points[i];if(p.x>maxX)maxX=p.x;else if(p.x<minX)minX=p.x;if(p.y>maxY)maxY=p.y;else if(p.y<minY)minY=p.y;if(v3){if(p.z>maxZ)maxZ=p.z;else if(p.z<minZ)minZ=p.z}sum.add(p)}var ret={minX:minX,minY:minY,maxX:maxX,maxY:maxY,centroid:sum.divideScalar(il)};if(v3){ret.maxZ=maxZ;ret.minZ=minZ}return ret};THREE.CurvePath.prototype.createPointsGeometry=function(divisions){var pts=this.getPoints(divisions,true);return this.createGeometry(pts)};THREE.CurvePath.prototype.createSpacedPointsGeometry=function(divisions){var pts=this.getSpacedPoints(divisions,true);return this.createGeometry(pts)};THREE.CurvePath.prototype.createGeometry=function(points){var geometry=new THREE.Geometry;for(var i=0;i<points.length;i++){geometry.vertices.push(new THREE.Vector3(points[i].x,points[i].y,points[i].z||0))}return geometry};THREE.CurvePath.prototype.addWrapPath=function(bendpath){this.bends.push(bendpath)};THREE.CurvePath.prototype.getTransformedPoints=function(segments,bends){var oldPts=this.getPoints(segments);var i,il;if(!bends){bends=this.bends}for(i=0,il=bends.length;i<il;i++){oldPts=this.getWrapPoints(oldPts,bends[i])}return oldPts};THREE.CurvePath.prototype.getTransformedSpacedPoints=function(segments,bends){var oldPts=this.getSpacedPoints(segments);var i,il;if(!bends){bends=this.bends}for(i=0,il=bends.length;i<il;i++){oldPts=this.getWrapPoints(oldPts,bends[i])}return oldPts};THREE.CurvePath.prototype.getWrapPoints=function(oldPts,path){var bounds=this.getBoundingBox();var i,il,p,oldX,oldY,xNorm;for(i=0,il=oldPts.length;i<il;i++){p=oldPts[i];oldX=p.x;oldY=p.y;xNorm=oldX/bounds.maxX;xNorm=path.getUtoTmapping(xNorm,oldX);var pathPt=path.getPoint(xNorm);var normal=path.getNormalVector(xNorm).multiplyScalar(oldY);p.x=pathPt.x+normal.x;p.y=pathPt.y+normal.y}return oldPts};THREE.Gyroscope=function(){THREE.Object3D.call(this)};THREE.Gyroscope.prototype=Object.create(THREE.Object3D.prototype);THREE.Gyroscope.prototype.updateMatrixWorld=function(force){this.matrixAutoUpdate&&this.updateMatrix();if(this.matrixWorldNeedsUpdate||force){if(this.parent){this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix);this.matrixWorld.decompose(this.translationWorld,this.rotationWorld,this.scaleWorld);this.matrix.decompose(this.translationObject,this.rotationObject,this.scaleObject);this.matrixWorld.makeFromPositionQuaternionScale(this.translationWorld,this.rotationObject,this.scaleWorld)}else{this.matrixWorld.copy(this.matrix)}this.matrixWorldNeedsUpdate=false;force=true}for(var i=0,l=this.children.length;i<l;i++){this.children[i].updateMatrixWorld(force)}};THREE.Gyroscope.prototype.translationWorld=new THREE.Vector3;THREE.Gyroscope.prototype.translationObject=new THREE.Vector3;THREE.Gyroscope.prototype.rotationWorld=new THREE.Quaternion;THREE.Gyroscope.prototype.rotationObject=new THREE.Quaternion;THREE.Gyroscope.prototype.scaleWorld=new THREE.Vector3;THREE.Gyroscope.prototype.scaleObject=new THREE.Vector3;THREE.Path=function(points){THREE.CurvePath.call(this);this.actions=[];if(points){this.fromPoints(points)}};THREE.Path.prototype=Object.create(THREE.CurvePath.prototype);THREE.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"};THREE.Path.prototype.fromPoints=function(vectors){this.moveTo(vectors[0].x,vectors[0].y);for(var v=1,vlen=vectors.length;v<vlen;v++){this.lineTo(vectors[v].x,vectors[v].y)}};THREE.Path.prototype.moveTo=function(x,y){var args=Array.prototype.slice.call(arguments);this.actions.push({action:THREE.PathActions.MOVE_TO,args:args})};THREE.Path.prototype.lineTo=function(x,y){var args=Array.prototype.slice.call(arguments);var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];var curve=new THREE.LineCurve(new THREE.Vector2(x0,y0),new THREE.Vector2(x,y));this.curves.push(curve);this.actions.push({action:THREE.PathActions.LINE_TO,args:args})};THREE.Path.prototype.quadraticCurveTo=function(aCPx,aCPy,aX,aY){var args=Array.prototype.slice.call(arguments);var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];var curve=new THREE.QuadraticBezierCurve(new THREE.Vector2(x0,y0),new THREE.Vector2(aCPx,aCPy),new THREE.Vector2(aX,aY));this.curves.push(curve);this.actions.push({action:THREE.PathActions.QUADRATIC_CURVE_TO,args:args})};THREE.Path.prototype.bezierCurveTo=function(aCP1x,aCP1y,aCP2x,aCP2y,aX,aY){var args=Array.prototype.slice.call(arguments);var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];var curve=new THREE.CubicBezierCurve(new THREE.Vector2(x0,y0),new THREE.Vector2(aCP1x,aCP1y),new THREE.Vector2(aCP2x,aCP2y),new THREE.Vector2(aX,aY));this.curves.push(curve);this.actions.push({action:THREE.PathActions.BEZIER_CURVE_TO,args:args})};THREE.Path.prototype.splineThru=function(pts){var args=Array.prototype.slice.call(arguments);var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];var npts=[new THREE.Vector2(x0,y0)];Array.prototype.push.apply(npts,pts);var curve=new THREE.SplineCurve(npts);this.curves.push(curve);this.actions.push({action:THREE.PathActions.CSPLINE_THRU,args:args})};THREE.Path.prototype.arc=function(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];this.absarc(aX+x0,aY+y0,aRadius,aStartAngle,aEndAngle,aClockwise)};THREE.Path.prototype.absarc=function(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){this.absellipse(aX,aY,aRadius,aRadius,aStartAngle,aEndAngle,aClockwise)};THREE.Path.prototype.ellipse=function(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise){var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];this.absellipse(aX+x0,aY+y0,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise)};THREE.Path.prototype.absellipse=function(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise){var args=Array.prototype.slice.call(arguments);var curve=new THREE.EllipseCurve(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise);this.curves.push(curve);var lastPoint=curve.getPoint(aClockwise?1:0);args.push(lastPoint.x);args.push(lastPoint.y);this.actions.push({action:THREE.PathActions.ELLIPSE,args:args})};THREE.Path.prototype.getSpacedPoints=function(divisions,closedPath){if(!divisions)divisions=40;var points=[];for(var i=0;i<divisions;i++){points.push(this.getPoint(i/divisions))}return points};THREE.Path.prototype.getPoints=function(divisions,closedPath){if(this.useSpacedPoints){console.log("tata");return this.getSpacedPoints(divisions,closedPath)}divisions=divisions||12;var points=[];var i,il,item,action,args;var cpx,cpy,cpx2,cpy2,cpx1,cpy1,cpx0,cpy0,laste,j,t,tx,ty;for(i=0,il=this.actions.length;i<il;i++){item=this.actions[i];action=item.action;args=item.args;switch(action){case THREE.PathActions.MOVE_TO:points.push(new THREE.Vector2(args[0],args[1]));break;case THREE.PathActions.LINE_TO:points.push(new THREE.Vector2(args[0],args[1]));break;case THREE.PathActions.QUADRATIC_CURVE_TO:cpx=args[2];cpy=args[3];cpx1=args[0];cpy1=args[1];if(points.length>0){laste=points[points.length-1];cpx0=laste.x;cpy0=laste.y}else{laste=this.actions[i-1].args;cpx0=laste[laste.length-2];cpy0=laste[laste.length-1]}for(j=1;j<=divisions;j++){t=j/divisions;tx=THREE.Shape.Utils.b2(t,cpx0,cpx1,cpx);ty=THREE.Shape.Utils.b2(t,cpy0,cpy1,cpy);points.push(new THREE.Vector2(tx,ty))}break;case THREE.PathActions.BEZIER_CURVE_TO:cpx=args[4];cpy=args[5];cpx1=args[0];cpy1=args[1];cpx2=args[2];cpy2=args[3];if(points.length>0){laste=points[points.length-1];cpx0=laste.x;cpy0=laste.y}else{laste=this.actions[i-1].args;cpx0=laste[laste.length-2];cpy0=laste[laste.length-1]}for(j=1;j<=divisions;j++){t=j/divisions;tx=THREE.Shape.Utils.b3(t,cpx0,cpx1,cpx2,cpx);ty=THREE.Shape.Utils.b3(t,cpy0,cpy1,cpy2,cpy);points.push(new THREE.Vector2(tx,ty))}break;case THREE.PathActions.CSPLINE_THRU:laste=this.actions[i-1].args;var last=new THREE.Vector2(laste[laste.length-2],laste[laste.length-1]);var spts=[last];var n=divisions*args[0].length;spts=spts.concat(args[0]);var spline=new THREE.SplineCurve(spts);for(j=1;j<=n;j++){points.push(spline.getPointAt(j/n))}break;case THREE.PathActions.ARC:var aX=args[0],aY=args[1],aRadius=args[2],aStartAngle=args[3],aEndAngle=args[4],aClockwise=!!args[5];var deltaAngle=aEndAngle-aStartAngle;var angle;var tdivisions=divisions*2;for(j=1;j<=tdivisions;j++){t=j/tdivisions;if(!aClockwise){t=1-t}angle=aStartAngle+t*deltaAngle;tx=aX+aRadius*Math.cos(angle);ty=aY+aRadius*Math.sin(angle);points.push(new THREE.Vector2(tx,ty))}break;case THREE.PathActions.ELLIPSE:var aX=args[0],aY=args[1],xRadius=args[2],yRadius=args[3],aStartAngle=args[4],aEndAngle=args[5],aClockwise=!!args[6];var deltaAngle=aEndAngle-aStartAngle;var angle;var tdivisions=divisions*2;for(j=1;j<=tdivisions;j++){t=j/tdivisions;if(!aClockwise){t=1-t}angle=aStartAngle+t*deltaAngle;tx=aX+xRadius*Math.cos(angle);ty=aY+yRadius*Math.sin(angle);points.push(new THREE.Vector2(tx,ty))}break}}var lastPoint=points[points.length-1];var EPSILON=1e-10;if(Math.abs(lastPoint.x-points[0].x)<EPSILON&&Math.abs(lastPoint.y-points[0].y)<EPSILON)points.splice(points.length-1,1);if(closedPath){points.push(points[0])}return points};THREE.Path.prototype.toShapes=function(){var i,il,item,action,args;var subPaths=[],lastPath=new THREE.Path;for(i=0,il=this.actions.length;i<il;i++){item=this.actions[i];args=item.args;action=item.action;if(action==THREE.PathActions.MOVE_TO){if(lastPath.actions.length!=0){subPaths.push(lastPath);lastPath=new THREE.Path}}lastPath[action].apply(lastPath,args)}if(lastPath.actions.length!=0){subPaths.push(lastPath)}if(subPaths.length==0)return[];var tmpPath,tmpShape,shapes=[];var holesFirst=!THREE.Shape.Utils.isClockWise(subPaths[0].getPoints());if(subPaths.length==1){tmpPath=subPaths[0];tmpShape=new THREE.Shape;tmpShape.actions=tmpPath.actions;tmpShape.curves=tmpPath.curves;shapes.push(tmpShape);return shapes}if(holesFirst){tmpShape=new THREE.Shape;for(i=0,il=subPaths.length;i<il;i++){tmpPath=subPaths[i];if(THREE.Shape.Utils.isClockWise(tmpPath.getPoints())){tmpShape.actions=tmpPath.actions;tmpShape.curves=tmpPath.curves;shapes.push(tmpShape);tmpShape=new THREE.Shape}else{tmpShape.holes.push(tmpPath)}}}else{for(i=0,il=subPaths.length;i<il;i++){tmpPath=subPaths[i];if(THREE.Shape.Utils.isClockWise(tmpPath.getPoints())){if(tmpShape)shapes.push(tmpShape);tmpShape=new THREE.Shape;tmpShape.actions=tmpPath.actions;tmpShape.curves=tmpPath.curves}else{tmpShape.holes.push(tmpPath)}}shapes.push(tmpShape)}return shapes};THREE.Shape=function(){THREE.Path.apply(this,arguments);this.holes=[]};THREE.Shape.prototype=Object.create(THREE.Path.prototype);THREE.Shape.prototype.extrude=function(options){var extruded=new THREE.ExtrudeGeometry(this,options);return extruded};THREE.Shape.prototype.makeGeometry=function(options){var geometry=new THREE.ShapeGeometry(this,options);return geometry};THREE.Shape.prototype.getPointsHoles=function(divisions){var i,il=this.holes.length,holesPts=[];for(i=0;i<il;i++){holesPts[i]=this.holes[i].getTransformedPoints(divisions,this.bends)}return holesPts};THREE.Shape.prototype.getSpacedPointsHoles=function(divisions){var i,il=this.holes.length,holesPts=[];for(i=0;i<il;i++){holesPts[i]=this.holes[i].getTransformedSpacedPoints(divisions,this.bends)}return holesPts};THREE.Shape.prototype.extractAllPoints=function(divisions){return{shape:this.getTransformedPoints(divisions),holes:this.getPointsHoles(divisions)}};THREE.Shape.prototype.extractPoints=function(divisions){if(this.useSpacedPoints){return this.extractAllSpacedPoints(divisions)}return this.extractAllPoints(divisions)};THREE.Shape.prototype.extractAllSpacedPoints=function(divisions){return{shape:this.getTransformedSpacedPoints(divisions),holes:this.getSpacedPointsHoles(divisions)}};THREE.Shape.Utils={removeHoles:function(contour,holes){var shape=contour.concat();var allpoints=shape.concat();var prevShapeVert,nextShapeVert,prevHoleVert,nextHoleVert,holeIndex,shapeIndex,shapeId,shapeGroup,h,h2,hole,shortest,d,p,pts1,pts2,tmpShape1,tmpShape2,tmpHole1,tmpHole2,verts=[];for(h=0;h<holes.length;h++){hole=holes[h];Array.prototype.push.apply(allpoints,hole);shortest=Number.POSITIVE_INFINITY;for(h2=0;h2<hole.length;h2++){pts1=hole[h2];var dist=[];for(p=0;p<shape.length;p++){pts2=shape[p];d=pts1.distanceToSquared(pts2);dist.push(d);if(d<shortest){shortest=d;holeIndex=h2;shapeIndex=p}}}prevShapeVert=shapeIndex-1>=0?shapeIndex-1:shape.length-1;prevHoleVert=holeIndex-1>=0?holeIndex-1:hole.length-1;var areaapts=[hole[holeIndex],shape[shapeIndex],shape[prevShapeVert]];var areaa=THREE.FontUtils.Triangulate.area(areaapts);var areabpts=[hole[holeIndex],hole[prevHoleVert],shape[shapeIndex]];var areab=THREE.FontUtils.Triangulate.area(areabpts);var shapeOffset=1;var holeOffset=-1;var oldShapeIndex=shapeIndex,oldHoleIndex=holeIndex;shapeIndex+=shapeOffset;holeIndex+=holeOffset;if(shapeIndex<0){shapeIndex+=shape.length}shapeIndex%=shape.length;if(holeIndex<0){holeIndex+=hole.length}holeIndex%=hole.length;prevShapeVert=shapeIndex-1>=0?shapeIndex-1:shape.length-1;prevHoleVert=holeIndex-1>=0?holeIndex-1:hole.length-1;areaapts=[hole[holeIndex],shape[shapeIndex],shape[prevShapeVert]];var areaa2=THREE.FontUtils.Triangulate.area(areaapts);areabpts=[hole[holeIndex],hole[prevHoleVert],shape[shapeIndex]];var areab2=THREE.FontUtils.Triangulate.area(areabpts);if(areaa+areab>areaa2+areab2){shapeIndex=oldShapeIndex;holeIndex=oldHoleIndex;if(shapeIndex<0){shapeIndex+=shape.length}shapeIndex%=shape.length;if(holeIndex<0){holeIndex+=hole.length}holeIndex%=hole.length;prevShapeVert=shapeIndex-1>=0?shapeIndex-1:shape.length-1;prevHoleVert=holeIndex-1>=0?holeIndex-1:hole.length-1}else{}tmpShape1=shape.slice(0,shapeIndex);tmpShape2=shape.slice(shapeIndex);tmpHole1=hole.slice(holeIndex);tmpHole2=hole.slice(0,holeIndex);var trianglea=[hole[holeIndex],shape[shapeIndex],shape[prevShapeVert]];var triangleb=[hole[holeIndex],hole[prevHoleVert],shape[shapeIndex]];verts.push(trianglea);verts.push(triangleb);shape=tmpShape1.concat(tmpHole1).concat(tmpHole2).concat(tmpShape2)}return{shape:shape,isolatedPts:verts,allpoints:allpoints}},triangulateShape:function(contour,holes){var shapeWithoutHoles=THREE.Shape.Utils.removeHoles(contour,holes);var shape=shapeWithoutHoles.shape,allpoints=shapeWithoutHoles.allpoints,isolatedPts=shapeWithoutHoles.isolatedPts;var triangles=THREE.FontUtils.Triangulate(shape,false);var i,il,f,face,key,index,allPointsMap={},isolatedPointsMap={};for(i=0,il=allpoints.length;i<il;i++){key=allpoints[i].x+":"+allpoints[i].y;if(allPointsMap[key]!==undefined){console.log("Duplicate point",key)}allPointsMap[key]=i}for(i=0,il=triangles.length;i<il;i++){face=triangles[i];for(f=0;f<3;f++){key=face[f].x+":"+face[f].y;index=allPointsMap[key];if(index!==undefined){face[f]=index}}}for(i=0,il=isolatedPts.length;i<il;i++){face=isolatedPts[i];for(f=0;f<3;f++){key=face[f].x+":"+face[f].y;index=allPointsMap[key];if(index!==undefined){face[f]=index}}}return triangles.concat(isolatedPts)},isClockWise:function(pts){return THREE.FontUtils.Triangulate.area(pts)<0},b2p0:function(t,p){var k=1-t;return k*k*p},b2p1:function(t,p){return 2*(1-t)*t*p},b2p2:function(t,p){return t*t*p},b2:function(t,p0,p1,p2){return this.b2p0(t,p0)+this.b2p1(t,p1)+this.b2p2(t,p2)},b3p0:function(t,p){var k=1-t;return k*k*k*p},b3p1:function(t,p){var k=1-t;return 3*k*k*t*p},b3p2:function(t,p){var k=1-t;return 3*k*t*t*p},b3p3:function(t,p){return t*t*t*p},b3:function(t,p0,p1,p2,p3){return this.b3p0(t,p0)+this.b3p1(t,p1)+this.b3p2(t,p2)+this.b3p3(t,p3)}};THREE.AnimationHandler=function(){var playing=[];var library={};var that={};that.update=function(deltaTimeMS){for(var i=0;i<playing.length;i++)playing[i].update(deltaTimeMS)};that.addToUpdate=function(animation){if(playing.indexOf(animation)===-1)playing.push(animation)};that.removeFromUpdate=function(animation){var index=playing.indexOf(animation);if(index!==-1)playing.splice(index,1)};that.add=function(data){if(library[data.name]!==undefined)console.log("THREE.AnimationHandler.add: Warning! "+data.name+" already exists in library. Overwriting.");library[data.name]=data;initData(data)};that.get=function(name){if(typeof name==="string"){if(library[name]){return library[name]}else{console.log("THREE.AnimationHandler.get: Couldn't find animation "+name);return null}}else{}};that.parse=function(root){var hierarchy=[];if(root instanceof THREE.SkinnedMesh){for(var b=0;b<root.bones.length;b++){hierarchy.push(root.bones[b])}}else{parseRecurseHierarchy(root,hierarchy)}return hierarchy};var parseRecurseHierarchy=function(root,hierarchy){hierarchy.push(root);for(var c=0;c<root.children.length;c++)parseRecurseHierarchy(root.children[c],hierarchy)};var initData=function(data){if(data.initialized===true)return;for(var h=0;h<data.hierarchy.length;h++){for(var k=0;k<data.hierarchy[h].keys.length;k++){if(data.hierarchy[h].keys[k].time<0)data.hierarchy[h].keys[k].time=0;if(data.hierarchy[h].keys[k].rot!==undefined&&!(data.hierarchy[h].keys[k].rot instanceof THREE.Quaternion)){var quat=data.hierarchy[h].keys[k].rot;data.hierarchy[h].keys[k].rot=new THREE.Quaternion(quat[0],quat[1],quat[2],quat[3])}}if(data.hierarchy[h].keys.length&&data.hierarchy[h].keys[0].morphTargets!==undefined){var usedMorphTargets={};for(var k=0;k<data.hierarchy[h].keys.length;k++){for(var m=0;m<data.hierarchy[h].keys[k].morphTargets.length;m++){var morphTargetName=data.hierarchy[h].keys[k].morphTargets[m];usedMorphTargets[morphTargetName]=-1}}data.hierarchy[h].usedMorphTargets=usedMorphTargets;for(var k=0;k<data.hierarchy[h].keys.length;k++){var influences={};for(var morphTargetName in usedMorphTargets){for(var m=0;m<data.hierarchy[h].keys[k].morphTargets.length;m++){if(data.hierarchy[h].keys[k].morphTargets[m]===morphTargetName){influences[morphTargetName]=data.hierarchy[h].keys[k].morphTargetsInfluences[m];break}}if(m===data.hierarchy[h].keys[k].morphTargets.length){influences[morphTargetName]=0}}data.hierarchy[h].keys[k].morphTargetsInfluences=influences}}for(var k=1;k<data.hierarchy[h].keys.length;k++){if(data.hierarchy[h].keys[k].time===data.hierarchy[h].keys[k-1].time){data.hierarchy[h].keys.splice(k,1);k--}}for(var k=0;k<data.hierarchy[h].keys.length;k++){data.hierarchy[h].keys[k].index=k}}var lengthInFrames=parseInt(data.length*data.fps,10);data.JIT={};data.JIT.hierarchy=[];for(var h=0;h<data.hierarchy.length;h++)data.JIT.hierarchy.push(new Array(lengthInFrames));data.initialized=true};that.LINEAR=0;that.CATMULLROM=1;that.CATMULLROM_FORWARD=2;return that}();THREE.Animation=function(root,name,interpolationType){this.root=root;this.data=THREE.AnimationHandler.get(name);this.hierarchy=THREE.AnimationHandler.parse(root);this.currentTime=0;this.timeScale=1;this.isPlaying=false;this.isPaused=true;this.loop=true;this.interpolationType=interpolationType!==undefined?interpolationType:THREE.AnimationHandler.LINEAR;this.points=[];this.target=new THREE.Vector3};THREE.Animation.prototype.play=function(loop,startTimeMS){if(this.isPlaying===false){this.isPlaying=true;this.loop=loop!==undefined?loop:true;this.currentTime=startTimeMS!==undefined?startTimeMS:0;var h,hl=this.hierarchy.length,object;for(h=0;h<hl;h++){object=this.hierarchy[h];if(this.interpolationType!==THREE.AnimationHandler.CATMULLROM_FORWARD){object.useQuaternion=true}object.matrixAutoUpdate=true;if(object.animationCache===undefined){object.animationCache={};object.animationCache.prevKey={pos:0,rot:0,scl:0};object.animationCache.nextKey={pos:0,rot:0,scl:0};object.animationCache.originalMatrix=object instanceof THREE.Bone?object.skinMatrix:object.matrix}var prevKey=object.animationCache.prevKey;var nextKey=object.animationCache.nextKey;prevKey.pos=this.data.hierarchy[h].keys[0];prevKey.rot=this.data.hierarchy[h].keys[0];prevKey.scl=this.data.hierarchy[h].keys[0];nextKey.pos=this.getNextKeyWith("pos",h,1);nextKey.rot=this.getNextKeyWith("rot",h,1);nextKey.scl=this.getNextKeyWith("scl",h,1)}this.update(0)}this.isPaused=false;THREE.AnimationHandler.addToUpdate(this)};THREE.Animation.prototype.pause=function(){if(this.isPaused===true){THREE.AnimationHandler.addToUpdate(this)}else{THREE.AnimationHandler.removeFromUpdate(this)}this.isPaused=!this.isPaused};THREE.Animation.prototype.stop=function(){this.isPlaying=false;this.isPaused=false;THREE.AnimationHandler.removeFromUpdate(this)};THREE.Animation.prototype.update=function(deltaTimeMS){if(this.isPlaying===false)return;var types=["pos","rot","scl"];var type;var scale;var vector;var prevXYZ,nextXYZ;var prevKey,nextKey;var object;var animationCache;var frame;var JIThierarchy=this.data.JIT.hierarchy;var currentTime,unloopedCurrentTime;var currentPoint,forwardPoint,angle;this.currentTime+=deltaTimeMS*this.timeScale;unloopedCurrentTime=this.currentTime;currentTime=this.currentTime=this.currentTime%this.data.length;frame=parseInt(Math.min(currentTime*this.data.fps,this.data.length*this.data.fps),10);for(var h=0,hl=this.hierarchy.length;h<hl;h++){object=this.hierarchy[h];animationCache=object.animationCache;for(var t=0;t<3;t++){type=types[t];prevKey=animationCache.prevKey[type];nextKey=animationCache.nextKey[type];if(nextKey.time<=unloopedCurrentTime){if(currentTime<unloopedCurrentTime){if(this.loop){prevKey=this.data.hierarchy[h].keys[0];nextKey=this.getNextKeyWith(type,h,1);while(nextKey.time<currentTime){prevKey=nextKey;nextKey=this.getNextKeyWith(type,h,nextKey.index+1)}}else{this.stop();return}}else{do{prevKey=nextKey;nextKey=this.getNextKeyWith(type,h,nextKey.index+1)}while(nextKey.time<currentTime)}animationCache.prevKey[type]=prevKey;animationCache.nextKey[type]=nextKey}object.matrixAutoUpdate=true;object.matrixWorldNeedsUpdate=true;scale=(currentTime-prevKey.time)/(nextKey.time-prevKey.time);prevXYZ=prevKey[type];nextXYZ=nextKey[type];if(scale<0||scale>1){console.log("THREE.Animation.update: Warning! Scale out of bounds:"+scale+" on bone "+h);scale=scale<0?0:1}if(type==="pos"){vector=object.position;if(this.interpolationType===THREE.AnimationHandler.LINEAR){vector.x=prevXYZ[0]+(nextXYZ[0]-prevXYZ[0])*scale;vector.y=prevXYZ[1]+(nextXYZ[1]-prevXYZ[1])*scale;vector.z=prevXYZ[2]+(nextXYZ[2]-prevXYZ[2])*scale}else if(this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD){this.points[0]=this.getPrevKeyWith("pos",h,prevKey.index-1)["pos"];this.points[1]=prevXYZ;this.points[2]=nextXYZ;this.points[3]=this.getNextKeyWith("pos",h,nextKey.index+1)["pos"];scale=scale*.33+.33;currentPoint=this.interpolateCatmullRom(this.points,scale);vector.x=currentPoint[0];vector.y=currentPoint[1];vector.z=currentPoint[2];if(this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD){forwardPoint=this.interpolateCatmullRom(this.points,scale*1.01);this.target.set(forwardPoint[0],forwardPoint[1],forwardPoint[2]);this.target.sub(vector);this.target.y=0;this.target.normalize();angle=Math.atan2(this.target.x,this.target.z);object.rotation.set(0,angle,0)}}}else if(type==="rot"){THREE.Quaternion.slerp(prevXYZ,nextXYZ,object.quaternion,scale)}else if(type==="scl"){vector=object.scale;vector.x=prevXYZ[0]+(nextXYZ[0]-prevXYZ[0])*scale;vector.y=prevXYZ[1]+(nextXYZ[1]-prevXYZ[1])*scale;vector.z=prevXYZ[2]+(nextXYZ[2]-prevXYZ[2])*scale}}}};THREE.Animation.prototype.interpolateCatmullRom=function(points,scale){var c=[],v3=[],point,intPoint,weight,w2,w3,pa,pb,pc,pd;point=(points.length-1)*scale;intPoint=Math.floor(point);weight=point-intPoint;c[0]=intPoint===0?intPoint:intPoint-1;c[1]=intPoint;c[2]=intPoint>points.length-2?intPoint:intPoint+1;c[3]=intPoint>points.length-3?intPoint:intPoint+2;pa=points[c[0]];pb=points[c[1]];pc=points[c[2]];pd=points[c[3]];w2=weight*weight;w3=weight*w2;v3[0]=this.interpolate(pa[0],pb[0],pc[0],pd[0],weight,w2,w3);v3[1]=this.interpolate(pa[1],pb[1],pc[1],pd[1],weight,w2,w3);v3[2]=this.interpolate(pa[2],pb[2],pc[2],pd[2],weight,w2,w3);return v3};THREE.Animation.prototype.interpolate=function(p0,p1,p2,p3,t,t2,t3){var v0=(p2-p0)*.5,v1=(p3-p1)*.5;return(2*(p1-p2)+v0+v1)*t3+(-3*(p1-p2)-2*v0-v1)*t2+v0*t+p1};THREE.Animation.prototype.getNextKeyWith=function(type,h,key){var keys=this.data.hierarchy[h].keys;if(this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD){key=key<keys.length-1?key:keys.length-1}else{key=key%keys.length}for(;key<keys.length;key++){if(keys[key][type]!==undefined){return keys[key]}}return this.data.hierarchy[h].keys[0]};THREE.Animation.prototype.getPrevKeyWith=function(type,h,key){var keys=this.data.hierarchy[h].keys;if(this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD){key=key>0?key:0}else{key=key>=0?key:key+keys.length}for(;key>=0;key--){if(keys[key][type]!==undefined){return keys[key]}}return this.data.hierarchy[h].keys[keys.length-1]};THREE.KeyFrameAnimation=function(root,data,JITCompile){this.root=root;this.data=THREE.AnimationHandler.get(data);this.hierarchy=THREE.AnimationHandler.parse(root);this.currentTime=0;this.timeScale=.001;this.isPlaying=false;this.isPaused=true;this.loop=true;this.JITCompile=JITCompile!==undefined?JITCompile:true;for(var h=0,hl=this.hierarchy.length;h<hl;h++){var keys=this.data.hierarchy[h].keys,sids=this.data.hierarchy[h].sids,obj=this.hierarchy[h];if(keys.length&&sids){for(var s=0;s<sids.length;s++){var sid=sids[s],next=this.getNextKeyWith(sid,h,0);if(next){next.apply(sid)}}obj.matrixAutoUpdate=false;this.data.hierarchy[h].node.updateMatrix();obj.matrixWorldNeedsUpdate=true}}};THREE.KeyFrameAnimation.prototype.play=function(loop,startTimeMS){if(!this.isPlaying){this.isPlaying=true;this.loop=loop!==undefined?loop:true;this.currentTime=startTimeMS!==undefined?startTimeMS:0;this.startTimeMs=startTimeMS;this.startTime=1e7;this.endTime=-this.startTime;var h,hl=this.hierarchy.length,object,node;for(h=0;h<hl;h++){object=this.hierarchy[h];node=this.data.hierarchy[h];object.useQuaternion=true;if(node.animationCache===undefined){node.animationCache={};node.animationCache.prevKey=null;node.animationCache.nextKey=null;node.animationCache.originalMatrix=object instanceof THREE.Bone?object.skinMatrix:object.matrix}var keys=this.data.hierarchy[h].keys;if(keys.length){node.animationCache.prevKey=keys[0];node.animationCache.nextKey=keys[1];this.startTime=Math.min(keys[0].time,this.startTime);this.endTime=Math.max(keys[keys.length-1].time,this.endTime)}}this.update(0)}this.isPaused=false;THREE.AnimationHandler.addToUpdate(this)};THREE.KeyFrameAnimation.prototype.pause=function(){if(this.isPaused){THREE.AnimationHandler.addToUpdate(this)}else{THREE.AnimationHandler.removeFromUpdate(this)}this.isPaused=!this.isPaused};THREE.KeyFrameAnimation.prototype.stop=function(){this.isPlaying=false;this.isPaused=false;THREE.AnimationHandler.removeFromUpdate(this);for(var h=0;h<this.data.hierarchy.length;h++){var obj=this.hierarchy[h];var node=this.data.hierarchy[h];if(node.animationCache!==undefined){var original=node.animationCache.originalMatrix;if(obj instanceof THREE.Bone){original.copy(obj.skinMatrix);obj.skinMatrix=original}else{original.copy(obj.matrix);obj.matrix=original}delete node.animationCache}}};THREE.KeyFrameAnimation.prototype.update=function(deltaTimeMS){if(!this.isPlaying)return;var prevKey,nextKey;var object;var node;var frame;var JIThierarchy=this.data.JIT.hierarchy;var currentTime,unloopedCurrentTime;var looped;this.currentTime+=deltaTimeMS*this.timeScale;unloopedCurrentTime=this.currentTime;currentTime=this.currentTime=this.currentTime%this.data.length;if(currentTime<this.startTimeMs){currentTime=this.currentTime=this.startTimeMs+currentTime}frame=parseInt(Math.min(currentTime*this.data.fps,this.data.length*this.data.fps),10);looped=currentTime<unloopedCurrentTime;if(looped&&!this.loop){for(var h=0,hl=this.hierarchy.length;h<hl;h++){var keys=this.data.hierarchy[h].keys,sids=this.data.hierarchy[h].sids,end=keys.length-1,obj=this.hierarchy[h];if(keys.length){for(var s=0;s<sids.length;s++){var sid=sids[s],prev=this.getPrevKeyWith(sid,h,end);if(prev){prev.apply(sid)}}this.data.hierarchy[h].node.updateMatrix();obj.matrixWorldNeedsUpdate=true}}this.stop();return}if(currentTime<this.startTime){return}for(var h=0,hl=this.hierarchy.length;h<hl;h++){object=this.hierarchy[h];node=this.data.hierarchy[h];var keys=node.keys,animationCache=node.animationCache;if(this.JITCompile&&JIThierarchy[h][frame]!==undefined){if(object instanceof THREE.Bone){object.skinMatrix=JIThierarchy[h][frame];object.matrixWorldNeedsUpdate=false}else{object.matrix=JIThierarchy[h][frame];
object.matrixWorldNeedsUpdate=true}}else if(keys.length){if(this.JITCompile&&animationCache){if(object instanceof THREE.Bone){object.skinMatrix=animationCache.originalMatrix}else{object.matrix=animationCache.originalMatrix}}prevKey=animationCache.prevKey;nextKey=animationCache.nextKey;if(prevKey&&nextKey){if(nextKey.time<=unloopedCurrentTime){if(looped&&this.loop){prevKey=keys[0];nextKey=keys[1];while(nextKey.time<currentTime){prevKey=nextKey;nextKey=keys[prevKey.index+1]}}else if(!looped){var lastIndex=keys.length-1;while(nextKey.time<currentTime&&nextKey.index!==lastIndex){prevKey=nextKey;nextKey=keys[prevKey.index+1]}}animationCache.prevKey=prevKey;animationCache.nextKey=nextKey}if(nextKey.time>=currentTime)prevKey.interpolate(nextKey,currentTime);else prevKey.interpolate(nextKey,nextKey.time)}this.data.hierarchy[h].node.updateMatrix();object.matrixWorldNeedsUpdate=true}}if(this.JITCompile){if(JIThierarchy[0][frame]===undefined){this.hierarchy[0].updateMatrixWorld(true);for(var h=0;h<this.hierarchy.length;h++){if(this.hierarchy[h]instanceof THREE.Bone){JIThierarchy[h][frame]=this.hierarchy[h].skinMatrix.clone()}else{JIThierarchy[h][frame]=this.hierarchy[h].matrix.clone()}}}}};THREE.KeyFrameAnimation.prototype.getNextKeyWith=function(sid,h,key){var keys=this.data.hierarchy[h].keys;key=key%keys.length;for(;key<keys.length;key++){if(keys[key].hasTarget(sid)){return keys[key]}}return keys[0]};THREE.KeyFrameAnimation.prototype.getPrevKeyWith=function(sid,h,key){var keys=this.data.hierarchy[h].keys;key=key>=0?key:key+keys.length;for(;key>=0;key--){if(keys[key].hasTarget(sid)){return keys[key]}}return keys[keys.length-1]};THREE.CubeCamera=function(near,far,cubeResolution){THREE.Object3D.call(this);var fov=90,aspect=1;var cameraPX=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraPX.up.set(0,-1,0);cameraPX.lookAt(new THREE.Vector3(1,0,0));this.add(cameraPX);var cameraNX=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraNX.up.set(0,-1,0);cameraNX.lookAt(new THREE.Vector3(-1,0,0));this.add(cameraNX);var cameraPY=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraPY.up.set(0,0,1);cameraPY.lookAt(new THREE.Vector3(0,1,0));this.add(cameraPY);var cameraNY=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraNY.up.set(0,0,-1);cameraNY.lookAt(new THREE.Vector3(0,-1,0));this.add(cameraNY);var cameraPZ=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraPZ.up.set(0,-1,0);cameraPZ.lookAt(new THREE.Vector3(0,0,1));this.add(cameraPZ);var cameraNZ=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraNZ.up.set(0,-1,0);cameraNZ.lookAt(new THREE.Vector3(0,0,-1));this.add(cameraNZ);this.renderTarget=new THREE.WebGLRenderTargetCube(cubeResolution,cubeResolution,{format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter});this.updateCubeMap=function(renderer,scene){var renderTarget=this.renderTarget;var generateMipmaps=renderTarget.generateMipmaps;renderTarget.generateMipmaps=false;renderTarget.activeCubeFace=0;renderer.render(scene,cameraPX,renderTarget);renderTarget.activeCubeFace=1;renderer.render(scene,cameraNX,renderTarget);renderTarget.activeCubeFace=2;renderer.render(scene,cameraPY,renderTarget);renderTarget.activeCubeFace=3;renderer.render(scene,cameraNY,renderTarget);renderTarget.activeCubeFace=4;renderer.render(scene,cameraPZ,renderTarget);renderTarget.generateMipmaps=generateMipmaps;renderTarget.activeCubeFace=5;renderer.render(scene,cameraNZ,renderTarget)}};THREE.CubeCamera.prototype=Object.create(THREE.Object3D.prototype);THREE.CombinedCamera=function(width,height,fov,near,far,orthoNear,orthoFar){THREE.Camera.call(this);this.fov=fov;this.left=-width/2;this.right=width/2;this.top=height/2;this.bottom=-height/2;this.cameraO=new THREE.OrthographicCamera(width/-2,width/2,height/2,height/-2,orthoNear,orthoFar);this.cameraP=new THREE.PerspectiveCamera(fov,width/height,near,far);this.zoom=1;this.toPerspective();var aspect=width/height};THREE.CombinedCamera.prototype=Object.create(THREE.Camera.prototype);THREE.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraP.near;this.far=this.cameraP.far;this.cameraP.fov=this.fov/this.zoom;this.cameraP.updateProjectionMatrix();this.projectionMatrix=this.cameraP.projectionMatrix;this.inPerspectiveMode=true;this.inOrthographicMode=false};THREE.CombinedCamera.prototype.toOrthographic=function(){var fov=this.fov;var aspect=this.cameraP.aspect;var near=this.cameraP.near;var far=this.cameraP.far;var hyperfocus=(near+far)/2;var halfHeight=Math.tan(fov/2)*hyperfocus;var planeHeight=2*halfHeight;var planeWidth=planeHeight*aspect;var halfWidth=planeWidth/2;halfHeight/=this.zoom;halfWidth/=this.zoom;this.cameraO.left=-halfWidth;this.cameraO.right=halfWidth;this.cameraO.top=halfHeight;this.cameraO.bottom=-halfHeight;this.cameraO.updateProjectionMatrix();this.near=this.cameraO.near;this.far=this.cameraO.far;this.projectionMatrix=this.cameraO.projectionMatrix;this.inPerspectiveMode=false;this.inOrthographicMode=true};THREE.CombinedCamera.prototype.setSize=function(width,height){this.cameraP.aspect=width/height;this.left=-width/2;this.right=width/2;this.top=height/2;this.bottom=-height/2};THREE.CombinedCamera.prototype.setFov=function(fov){this.fov=fov;if(this.inPerspectiveMode){this.toPerspective()}else{this.toOrthographic()}};THREE.CombinedCamera.prototype.updateProjectionMatrix=function(){if(this.inPerspectiveMode){this.toPerspective()}else{this.toPerspective();this.toOrthographic()}};THREE.CombinedCamera.prototype.setLens=function(focalLength,frameHeight){if(frameHeight===undefined)frameHeight=24;var fov=2*THREE.Math.radToDeg(Math.atan(frameHeight/(focalLength*2)));this.setFov(fov);return fov};THREE.CombinedCamera.prototype.setZoom=function(zoom){this.zoom=zoom;if(this.inPerspectiveMode){this.toPerspective()}else{this.toOrthographic()}};THREE.CombinedCamera.prototype.toFrontView=function(){this.rotation.x=0;this.rotation.y=0;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CombinedCamera.prototype.toBackView=function(){this.rotation.x=0;this.rotation.y=Math.PI;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CombinedCamera.prototype.toLeftView=function(){this.rotation.x=0;this.rotation.y=-Math.PI/2;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CombinedCamera.prototype.toRightView=function(){this.rotation.x=0;this.rotation.y=Math.PI/2;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CombinedCamera.prototype.toTopView=function(){this.rotation.x=-Math.PI/2;this.rotation.y=0;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CombinedCamera.prototype.toBottomView=function(){this.rotation.x=Math.PI/2;this.rotation.y=0;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CircleGeometry=function(radius,segments,thetaStart,thetaLength){THREE.Geometry.call(this);radius=radius||50;thetaStart=thetaStart!==undefined?thetaStart:0;thetaLength=thetaLength!==undefined?thetaLength:Math.PI*2;segments=segments!==undefined?Math.max(3,segments):8;var i,uvs=[],center=new THREE.Vector3,centerUV=new THREE.Vector2(.5,.5);this.vertices.push(center);uvs.push(centerUV);for(i=0;i<=segments;i++){var vertex=new THREE.Vector3;var segment=thetaStart+i/segments*thetaLength;vertex.x=radius*Math.cos(segment);vertex.y=radius*Math.sin(segment);this.vertices.push(vertex);uvs.push(new THREE.Vector2((vertex.x/radius+1)/2,(vertex.y/radius+1)/2))}var n=new THREE.Vector3(0,0,1);for(i=1;i<=segments;i++){var v1=i;var v2=i+1;var v3=0;this.faces.push(new THREE.Face3(v1,v2,v3,[n,n,n]));this.faceVertexUvs[0].push([uvs[i],uvs[i+1],centerUV])}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,radius)};THREE.CircleGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.CubeGeometry=function(width,height,depth,widthSegments,heightSegments,depthSegments){THREE.Geometry.call(this);var scope=this;this.width=width;this.height=height;this.depth=depth;this.widthSegments=widthSegments||1;this.heightSegments=heightSegments||1;this.depthSegments=depthSegments||1;var width_half=this.width/2;var height_half=this.height/2;var depth_half=this.depth/2;buildPlane("z","y",-1,-1,this.depth,this.height,width_half,0);buildPlane("z","y",1,-1,this.depth,this.height,-width_half,1);buildPlane("x","z",1,1,this.width,this.depth,height_half,2);buildPlane("x","z",1,-1,this.width,this.depth,-height_half,3);buildPlane("x","y",1,-1,this.width,this.height,depth_half,4);buildPlane("x","y",-1,-1,this.width,this.height,-depth_half,5);function buildPlane(u,v,udir,vdir,width,height,depth,materialIndex){var w,ix,iy,gridX=scope.widthSegments,gridY=scope.heightSegments,width_half=width/2,height_half=height/2,offset=scope.vertices.length;if(u==="x"&&v==="y"||u==="y"&&v==="x"){w="z"}else if(u==="x"&&v==="z"||u==="z"&&v==="x"){w="y";gridY=scope.depthSegments}else if(u==="z"&&v==="y"||u==="y"&&v==="z"){w="x";gridX=scope.depthSegments}var gridX1=gridX+1,gridY1=gridY+1,segment_width=width/gridX,segment_height=height/gridY,normal=new THREE.Vector3;normal[w]=depth>0?1:-1;for(iy=0;iy<gridY1;iy++){for(ix=0;ix<gridX1;ix++){var vector=new THREE.Vector3;vector[u]=(ix*segment_width-width_half)*udir;vector[v]=(iy*segment_height-height_half)*vdir;vector[w]=depth;scope.vertices.push(vector)}}for(iy=0;iy<gridY;iy++){for(ix=0;ix<gridX;ix++){var a=ix+gridX1*iy;var b=ix+gridX1*(iy+1);var c=ix+1+gridX1*(iy+1);var d=ix+1+gridX1*iy;var face=new THREE.Face4(a+offset,b+offset,c+offset,d+offset);face.normal.copy(normal);face.vertexNormals.push(normal.clone(),normal.clone(),normal.clone(),normal.clone());face.materialIndex=materialIndex;scope.faces.push(face);scope.faceVertexUvs[0].push([new THREE.Vector2(ix/gridX,1-iy/gridY),new THREE.Vector2(ix/gridX,1-(iy+1)/gridY),new THREE.Vector2((ix+1)/gridX,1-(iy+1)/gridY),new THREE.Vector2((ix+1)/gridX,1-iy/gridY)])}}}this.computeCentroids();this.mergeVertices()};THREE.CubeGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.CylinderGeometry=function(radiusTop,radiusBottom,height,radiusSegments,heightSegments,openEnded){THREE.Geometry.call(this);this.radiusTop=radiusTop=radiusTop!==undefined?radiusTop:20;this.radiusBottom=radiusBottom=radiusBottom!==undefined?radiusBottom:20;this.height=height=height!==undefined?height:100;this.radiusSegments=radiusSegments=radiusSegments||8;this.heightSegments=heightSegments=heightSegments||1;this.openEnded=openEnded=openEnded!==undefined?openEnded:false;var heightHalf=height/2;var x,y,vertices=[],uvs=[];for(y=0;y<=heightSegments;y++){var verticesRow=[];var uvsRow=[];var v=y/heightSegments;var radius=v*(radiusBottom-radiusTop)+radiusTop;for(x=0;x<=radiusSegments;x++){var u=x/radiusSegments;var vertex=new THREE.Vector3;vertex.x=radius*Math.sin(u*Math.PI*2);vertex.y=-v*height+heightHalf;vertex.z=radius*Math.cos(u*Math.PI*2);this.vertices.push(vertex);verticesRow.push(this.vertices.length-1);uvsRow.push(new THREE.Vector2(u,1-v))}vertices.push(verticesRow);uvs.push(uvsRow)}var tanTheta=(radiusBottom-radiusTop)/height;var na,nb;for(x=0;x<radiusSegments;x++){if(radiusTop!==0){na=this.vertices[vertices[0][x]].clone();nb=this.vertices[vertices[0][x+1]].clone()}else{na=this.vertices[vertices[1][x]].clone();nb=this.vertices[vertices[1][x+1]].clone()}na.setY(Math.sqrt(na.x*na.x+na.z*na.z)*tanTheta).normalize();nb.setY(Math.sqrt(nb.x*nb.x+nb.z*nb.z)*tanTheta).normalize();for(y=0;y<heightSegments;y++){var v1=vertices[y][x];var v2=vertices[y+1][x];var v3=vertices[y+1][x+1];var v4=vertices[y][x+1];var n1=na.clone();var n2=na.clone();var n3=nb.clone();var n4=nb.clone();var uv1=uvs[y][x].clone();var uv2=uvs[y+1][x].clone();var uv3=uvs[y+1][x+1].clone();var uv4=uvs[y][x+1].clone();this.faces.push(new THREE.Face4(v1,v2,v3,v4,[n1,n2,n3,n4]));this.faceVertexUvs[0].push([uv1,uv2,uv3,uv4])}}if(openEnded===false&&radiusTop>0){this.vertices.push(new THREE.Vector3(0,heightHalf,0));for(x=0;x<radiusSegments;x++){var v1=vertices[0][x];var v2=vertices[0][x+1];var v3=this.vertices.length-1;var n1=new THREE.Vector3(0,1,0);var n2=new THREE.Vector3(0,1,0);var n3=new THREE.Vector3(0,1,0);var uv1=uvs[0][x].clone();var uv2=uvs[0][x+1].clone();var uv3=new THREE.Vector2(uv2.u,0);this.faces.push(new THREE.Face3(v1,v2,v3,[n1,n2,n3]));this.faceVertexUvs[0].push([uv1,uv2,uv3])}}if(openEnded===false&&radiusBottom>0){this.vertices.push(new THREE.Vector3(0,-heightHalf,0));for(x=0;x<radiusSegments;x++){var v1=vertices[y][x+1];var v2=vertices[y][x];var v3=this.vertices.length-1;var n1=new THREE.Vector3(0,-1,0);var n2=new THREE.Vector3(0,-1,0);var n3=new THREE.Vector3(0,-1,0);var uv1=uvs[y][x+1].clone();var uv2=uvs[y][x].clone();var uv3=new THREE.Vector2(uv2.u,1);this.faces.push(new THREE.Face3(v1,v2,v3,[n1,n2,n3]));this.faceVertexUvs[0].push([uv1,uv2,uv3])}}this.computeCentroids();this.computeFaceNormals()};THREE.CylinderGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ExtrudeGeometry=function(shapes,options){if(typeof shapes==="undefined"){shapes=[];return}THREE.Geometry.call(this);shapes=shapes instanceof Array?shapes:[shapes];this.shapebb=shapes[shapes.length-1].getBoundingBox();this.addShapeList(shapes,options);this.computeCentroids();this.computeFaceNormals()};THREE.ExtrudeGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ExtrudeGeometry.prototype.addShapeList=function(shapes,options){var sl=shapes.length;for(var s=0;s<sl;s++){var shape=shapes[s];this.addShape(shape,options)}};THREE.ExtrudeGeometry.prototype.addShape=function(shape,options){var amount=options.amount!==undefined?options.amount:100;var bevelThickness=options.bevelThickness!==undefined?options.bevelThickness:6;var bevelSize=options.bevelSize!==undefined?options.bevelSize:bevelThickness-2;var bevelSegments=options.bevelSegments!==undefined?options.bevelSegments:3;var bevelEnabled=options.bevelEnabled!==undefined?options.bevelEnabled:true;var curveSegments=options.curveSegments!==undefined?options.curveSegments:12;var steps=options.steps!==undefined?options.steps:1;var extrudePath=options.extrudePath;var extrudePts,extrudeByPath=false;var material=options.material;var extrudeMaterial=options.extrudeMaterial;var uvgen=options.UVGenerator!==undefined?options.UVGenerator:THREE.ExtrudeGeometry.WorldUVGenerator;var shapebb=this.shapebb;var splineTube,binormal,normal,position2;if(extrudePath){extrudePts=extrudePath.getSpacedPoints(steps);extrudeByPath=true;bevelEnabled=false;splineTube=options.frames!==undefined?options.frames:new THREE.TubeGeometry.FrenetFrames(extrudePath,steps,false);binormal=new THREE.Vector3;normal=new THREE.Vector3;position2=new THREE.Vector3}if(!bevelEnabled){bevelSegments=0;bevelThickness=0;bevelSize=0}var ahole,h,hl;var scope=this;var bevelPoints=[];var shapesOffset=this.vertices.length;var shapePoints=shape.extractPoints(curveSegments);var vertices=shapePoints.shape;var holes=shapePoints.holes;var reverse=!THREE.Shape.Utils.isClockWise(vertices);if(reverse){vertices=vertices.reverse();for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];if(THREE.Shape.Utils.isClockWise(ahole)){holes[h]=ahole.reverse()}}reverse=false}var faces=THREE.Shape.Utils.triangulateShape(vertices,holes);var contour=vertices;for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];vertices=vertices.concat(ahole)}function scalePt2(pt,vec,size){if(!vec)console.log("die");return vec.clone().multiplyScalar(size).add(pt)}var b,bs,t,z,vert,vlen=vertices.length,face,flen=faces.length,cont,clen=contour.length;var RAD_TO_DEGREES=180/Math.PI;function getBevelVec(pt_i,pt_j,pt_k){return getBevelVec2(pt_i,pt_j,pt_k)}function getBevelVec1(pt_i,pt_j,pt_k){var anglea=Math.atan2(pt_j.y-pt_i.y,pt_j.x-pt_i.x);var angleb=Math.atan2(pt_k.y-pt_i.y,pt_k.x-pt_i.x);if(anglea>angleb){angleb+=Math.PI*2}var anglec=(anglea+angleb)/2;var x=-Math.cos(anglec);var y=-Math.sin(anglec);var vec=new THREE.Vector2(x,y);return vec}function getBevelVec2(pt_i,pt_j,pt_k){var a=THREE.ExtrudeGeometry.__v1,b=THREE.ExtrudeGeometry.__v2,v_hat=THREE.ExtrudeGeometry.__v3,w_hat=THREE.ExtrudeGeometry.__v4,p=THREE.ExtrudeGeometry.__v5,q=THREE.ExtrudeGeometry.__v6,v,w,v_dot_w_hat,q_sub_p_dot_w_hat,s,intersection;a.set(pt_i.x-pt_j.x,pt_i.y-pt_j.y);b.set(pt_i.x-pt_k.x,pt_i.y-pt_k.y);v=a.normalize();w=b.normalize();v_hat.set(-v.y,v.x);w_hat.set(w.y,-w.x);p.copy(pt_i).add(v_hat);q.copy(pt_i).add(w_hat);if(p.equals(q)){return w_hat.clone()}p.copy(pt_j).add(v_hat);q.copy(pt_k).add(w_hat);v_dot_w_hat=v.dot(w_hat);q_sub_p_dot_w_hat=q.sub(p).dot(w_hat);if(v_dot_w_hat===0){console.log("Either infinite or no solutions!");if(q_sub_p_dot_w_hat===0){console.log("Its finite solutions.")}else{console.log("Too bad, no solutions.")}}s=q_sub_p_dot_w_hat/v_dot_w_hat;if(s<0){return getBevelVec1(pt_i,pt_j,pt_k)}intersection=v.multiplyScalar(s).add(p);return intersection.sub(pt_i).clone()}var contourMovements=[];for(var i=0,il=contour.length,j=il-1,k=i+1;i<il;i++,j++,k++){if(j===il)j=0;if(k===il)k=0;var pt_i=contour[i];var pt_j=contour[j];var pt_k=contour[k];contourMovements[i]=getBevelVec(contour[i],contour[j],contour[k])}var holesMovements=[],oneHoleMovements,verticesMovements=contourMovements.concat();for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];oneHoleMovements=[];for(i=0,il=ahole.length,j=il-1,k=i+1;i<il;i++,j++,k++){if(j===il)j=0;if(k===il)k=0;oneHoleMovements[i]=getBevelVec(ahole[i],ahole[j],ahole[k])}holesMovements.push(oneHoleMovements);verticesMovements=verticesMovements.concat(oneHoleMovements)}for(b=0;b<bevelSegments;b++){t=b/bevelSegments;z=bevelThickness*(1-t);bs=bevelSize*Math.sin(t*Math.PI/2);for(i=0,il=contour.length;i<il;i++){vert=scalePt2(contour[i],contourMovements[i],bs);v(vert.x,vert.y,-z)}for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];oneHoleMovements=holesMovements[h];for(i=0,il=ahole.length;i<il;i++){vert=scalePt2(ahole[i],oneHoleMovements[i],bs);v(vert.x,vert.y,-z)}}}bs=bevelSize;for(i=0;i<vlen;i++){vert=bevelEnabled?scalePt2(vertices[i],verticesMovements[i],bs):vertices[i];if(!extrudeByPath){v(vert.x,vert.y,0)}else{normal.copy(splineTube.normals[0]).multiplyScalar(vert.x);binormal.copy(splineTube.binormals[0]).multiplyScalar(vert.y);position2.copy(extrudePts[0]).add(normal).add(binormal);v(position2.x,position2.y,position2.z)}}var s;for(s=1;s<=steps;s++){for(i=0;i<vlen;i++){vert=bevelEnabled?scalePt2(vertices[i],verticesMovements[i],bs):vertices[i];if(!extrudeByPath){v(vert.x,vert.y,amount/steps*s)}else{normal.copy(splineTube.normals[s]).multiplyScalar(vert.x);binormal.copy(splineTube.binormals[s]).multiplyScalar(vert.y);position2.copy(extrudePts[s]).add(normal).add(binormal);v(position2.x,position2.y,position2.z)}}}for(b=bevelSegments-1;b>=0;b--){t=b/bevelSegments;z=bevelThickness*(1-t);bs=bevelSize*Math.sin(t*Math.PI/2);for(i=0,il=contour.length;i<il;i++){vert=scalePt2(contour[i],contourMovements[i],bs);v(vert.x,vert.y,amount+z)}for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];oneHoleMovements=holesMovements[h];for(i=0,il=ahole.length;i<il;i++){vert=scalePt2(ahole[i],oneHoleMovements[i],bs);if(!extrudeByPath){v(vert.x,vert.y,amount+z)}else{v(vert.x,vert.y+extrudePts[steps-1].y,extrudePts[steps-1].x+z)}}}}buildLidFaces();buildSideFaces();function buildLidFaces(){if(bevelEnabled){var layer=0;var offset=vlen*layer;for(i=0;i<flen;i++){face=faces[i];f3(face[2]+offset,face[1]+offset,face[0]+offset,true)}layer=steps+bevelSegments*2;offset=vlen*layer;for(i=0;i<flen;i++){face=faces[i];f3(face[0]+offset,face[1]+offset,face[2]+offset,false)}}else{for(i=0;i<flen;i++){face=faces[i];f3(face[2],face[1],face[0],true)}for(i=0;i<flen;i++){face=faces[i];f3(face[0]+vlen*steps,face[1]+vlen*steps,face[2]+vlen*steps,false)}}}function buildSideFaces(){var layeroffset=0;sidewalls(contour,layeroffset);layeroffset+=contour.length;for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];sidewalls(ahole,layeroffset);layeroffset+=ahole.length}}function sidewalls(contour,layeroffset){var j,k;i=contour.length;while(--i>=0){j=i;k=i-1;if(k<0)k=contour.length-1;var s=0,sl=steps+bevelSegments*2;for(s=0;s<sl;s++){var slen1=vlen*s;var slen2=vlen*(s+1);var a=layeroffset+j+slen1,b=layeroffset+k+slen1,c=layeroffset+k+slen2,d=layeroffset+j+slen2;f4(a,b,c,d,contour,s,sl,j,k)}}}function v(x,y,z){scope.vertices.push(new THREE.Vector3(x,y,z))}function f3(a,b,c,isBottom){a+=shapesOffset;b+=shapesOffset;c+=shapesOffset;scope.faces.push(new THREE.Face3(a,b,c,null,null,material));var uvs=isBottom?uvgen.generateBottomUV(scope,shape,options,a,b,c):uvgen.generateTopUV(scope,shape,options,a,b,c);scope.faceVertexUvs[0].push(uvs)}function f4(a,b,c,d,wallContour,stepIndex,stepsLength,contourIndex1,contourIndex2){a+=shapesOffset;b+=shapesOffset;c+=shapesOffset;d+=shapesOffset;scope.faces.push(new THREE.Face4(a,b,c,d,null,null,extrudeMaterial));var uvs=uvgen.generateSideWallUV(scope,shape,wallContour,options,a,b,c,d,stepIndex,stepsLength,contourIndex1,contourIndex2);scope.faceVertexUvs[0].push(uvs)}};THREE.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(geometry,extrudedShape,extrudeOptions,indexA,indexB,indexC){var ax=geometry.vertices[indexA].x,ay=geometry.vertices[indexA].y,bx=geometry.vertices[indexB].x,by=geometry.vertices[indexB].y,cx=geometry.vertices[indexC].x,cy=geometry.vertices[indexC].y;return[new THREE.Vector2(ax,ay),new THREE.Vector2(bx,by),new THREE.Vector2(cx,cy)]},generateBottomUV:function(geometry,extrudedShape,extrudeOptions,indexA,indexB,indexC){return this.generateTopUV(geometry,extrudedShape,extrudeOptions,indexA,indexB,indexC)},generateSideWallUV:function(geometry,extrudedShape,wallContour,extrudeOptions,indexA,indexB,indexC,indexD,stepIndex,stepsLength,contourIndex1,contourIndex2){var ax=geometry.vertices[indexA].x,ay=geometry.vertices[indexA].y,az=geometry.vertices[indexA].z,bx=geometry.vertices[indexB].x,by=geometry.vertices[indexB].y,bz=geometry.vertices[indexB].z,cx=geometry.vertices[indexC].x,cy=geometry.vertices[indexC].y,cz=geometry.vertices[indexC].z,dx=geometry.vertices[indexD].x,dy=geometry.vertices[indexD].y,dz=geometry.vertices[indexD].z;if(Math.abs(ay-by)<.01){return[new THREE.Vector2(ax,1-az),new THREE.Vector2(bx,1-bz),new THREE.Vector2(cx,1-cz),new THREE.Vector2(dx,1-dz)]}else{return[new THREE.Vector2(ay,1-az),new THREE.Vector2(by,1-bz),new THREE.Vector2(cy,1-cz),new THREE.Vector2(dy,1-dz)]}}};THREE.ExtrudeGeometry.__v1=new THREE.Vector2;THREE.ExtrudeGeometry.__v2=new THREE.Vector2;THREE.ExtrudeGeometry.__v3=new THREE.Vector2;THREE.ExtrudeGeometry.__v4=new THREE.Vector2;THREE.ExtrudeGeometry.__v5=new THREE.Vector2;THREE.ExtrudeGeometry.__v6=new THREE.Vector2;THREE.ShapeGeometry=function(shapes,options){THREE.Geometry.call(this);if(shapes instanceof Array===false)shapes=[shapes];this.shapebb=shapes[shapes.length-1].getBoundingBox();this.addShapeList(shapes,options);this.computeCentroids();this.computeFaceNormals()};THREE.ShapeGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ShapeGeometry.prototype.addShapeList=function(shapes,options){for(var i=0,l=shapes.length;i<l;i++){this.addShape(shapes[i],options)}return this};THREE.ShapeGeometry.prototype.addShape=function(shape,options){if(options===undefined)options={};var curveSegments=options.curveSegments!==undefined?options.curveSegments:12;var material=options.material;var uvgen=options.UVGenerator===undefined?THREE.ExtrudeGeometry.WorldUVGenerator:options.UVGenerator;var shapebb=this.shapebb;var i,l,hole,s;var shapesOffset=this.vertices.length;var shapePoints=shape.extractPoints(curveSegments);var vertices=shapePoints.shape;var holes=shapePoints.holes;var reverse=!THREE.Shape.Utils.isClockWise(vertices);if(reverse){vertices=vertices.reverse();for(i=0,l=holes.length;i<l;i++){hole=holes[i];if(THREE.Shape.Utils.isClockWise(hole)){holes[i]=hole.reverse()}}reverse=false}var faces=THREE.Shape.Utils.triangulateShape(vertices,holes);var contour=vertices;for(i=0,l=holes.length;i<l;i++){hole=holes[i];vertices=vertices.concat(hole)}var vert,vlen=vertices.length;var face,flen=faces.length;var cont,clen=contour.length;for(i=0;i<vlen;i++){vert=vertices[i];this.vertices.push(new THREE.Vector3(vert.x,vert.y,0))}for(i=0;i<flen;i++){face=faces[i];var a=face[0]+shapesOffset;var b=face[1]+shapesOffset;var c=face[2]+shapesOffset;this.faces.push(new THREE.Face3(a,b,c,null,null,material));this.faceVertexUvs[0].push(uvgen.generateBottomUV(this,shape,options,a,b,c))}};THREE.LatheGeometry=function(points,segments,phiStart,phiLength){THREE.Geometry.call(this);segments=segments||12;phiStart=phiStart||0;phiLength=phiLength||2*Math.PI;var inversePointLength=1/(points.length-1);var inverseSegments=1/segments;for(var i=0,il=segments;i<=il;i++){var phi=phiStart+i*inverseSegments*phiLength;var c=Math.cos(phi),s=Math.sin(phi);for(var j=0,jl=points.length;j<jl;j++){var pt=points[j];var vertex=new THREE.Vector3;vertex.x=c*pt.x-s*pt.y;vertex.y=s*pt.x+c*pt.y;vertex.z=pt.z;this.vertices.push(vertex)}}var np=points.length;for(var i=0,il=segments;i<il;i++){for(var j=0,jl=points.length-1;j<jl;j++){var base=j+np*i;var a=base;var b=base+np;var c=base+1+np;var d=base+1;this.faces.push(new THREE.Face4(a,b,c,d));var u0=i*inverseSegments;var v0=j*inversePointLength;var u1=u0+inverseSegments;var v1=v0+inversePointLength;this.faceVertexUvs[0].push([new THREE.Vector2(u0,v0),new THREE.Vector2(u1,v0),new THREE.Vector2(u1,v1),new THREE.Vector2(u0,v1)])}}this.mergeVertices();this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.LatheGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.PlaneGeometry=function(width,height,widthSegments,heightSegments){THREE.Geometry.call(this);this.width=width;this.height=height;this.widthSegments=widthSegments||1;this.heightSegments=heightSegments||1;var ix,iz;var width_half=width/2;var height_half=height/2;var gridX=this.widthSegments;var gridZ=this.heightSegments;var gridX1=gridX+1;var gridZ1=gridZ+1;var segment_width=this.width/gridX;var segment_height=this.height/gridZ;var normal=new THREE.Vector3(0,0,1);for(iz=0;iz<gridZ1;iz++){for(ix=0;ix<gridX1;ix++){var x=ix*segment_width-width_half;var y=iz*segment_height-height_half;this.vertices.push(new THREE.Vector3(x,-y,0))}}for(iz=0;iz<gridZ;iz++){for(ix=0;ix<gridX;ix++){var a=ix+gridX1*iz;var b=ix+gridX1*(iz+1);var c=ix+1+gridX1*(iz+1);var d=ix+1+gridX1*iz;var face=new THREE.Face4(a,b,c,d);face.normal.copy(normal);face.vertexNormals.push(normal.clone(),normal.clone(),normal.clone(),normal.clone());this.faces.push(face);this.faceVertexUvs[0].push([new THREE.Vector2(ix/gridX,1-iz/gridZ),new THREE.Vector2(ix/gridX,1-(iz+1)/gridZ),new THREE.Vector2((ix+1)/gridX,1-(iz+1)/gridZ),new THREE.Vector2((ix+1)/gridX,1-iz/gridZ)])}}this.computeCentroids()};THREE.PlaneGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.RingGeometry=function(innerRadius,outerRadius,thetaSegments,phiSegments,thetaStart,thetaLength){THREE.Geometry.call(this);innerRadius=innerRadius||0;outerRadius=outerRadius||50;thetaStart=thetaStart!==undefined?thetaStart:0;thetaLength=thetaLength!==undefined?thetaLength:Math.PI*2;thetaSegments=thetaSegments!==undefined?Math.max(3,thetaSegments):8;phiSegments=phiSegments!==undefined?Math.max(3,phiSegments):8;var i,o,uvs=[],radius=innerRadius,radiusStep=(outerRadius-innerRadius)/phiSegments;for(i=0;i<=phiSegments;i++){for(o=0;o<=thetaSegments;o++){var vertex=new THREE.Vector3;var segment=thetaStart+o/thetaSegments*thetaLength;vertex.x=radius*Math.cos(segment);vertex.y=radius*Math.sin(segment);this.vertices.push(vertex);uvs.push(new THREE.Vector2((vertex.x/radius+1)/2,-(vertex.y/radius+1)/2+1))}radius+=radiusStep}var n=new THREE.Vector3(0,0,1);for(i=0;i<phiSegments;i++){var thetaSegment=i*thetaSegments;for(o=0;o<=thetaSegments;o++){var segment=o+thetaSegment;var v1=segment+i;var v2=segment+thetaSegments+i;var v3=segment+thetaSegments+1+i;this.faces.push(new THREE.Face3(v1,v2,v3,[n,n,n]));this.faceVertexUvs[0].push([uvs[v1],uvs[v2],uvs[v3]]);v1=segment+i;v2=segment+thetaSegments+1+i;v3=segment+1+i;this.faces.push(new THREE.Face3(v1,v2,v3,[n,n,n]));this.faceVertexUvs[0].push([uvs[v1],uvs[v2],uvs[v3]])}}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,radius)};THREE.RingGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.SphereGeometry=function(radius,widthSegments,heightSegments,phiStart,phiLength,thetaStart,thetaLength){THREE.Geometry.call(this);this.radius=radius=radius||50;this.widthSegments=widthSegments=Math.max(3,Math.floor(widthSegments)||8);this.heightSegments=heightSegments=Math.max(2,Math.floor(heightSegments)||6);this.phiStart=phiStart=phiStart!==undefined?phiStart:0;this.phiLength=phiLength=phiLength!==undefined?phiLength:Math.PI*2;this.thetaStart=thetaStart=thetaStart!==undefined?thetaStart:0;this.thetaLength=thetaLength=thetaLength!==undefined?thetaLength:Math.PI;var x,y,vertices=[],uvs=[];for(y=0;y<=heightSegments;y++){var verticesRow=[];var uvsRow=[];for(x=0;x<=widthSegments;x++){var u=x/widthSegments;var v=y/heightSegments;var vertex=new THREE.Vector3;vertex.x=-radius*Math.cos(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength);vertex.y=radius*Math.cos(thetaStart+v*thetaLength);vertex.z=radius*Math.sin(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength);this.vertices.push(vertex);verticesRow.push(this.vertices.length-1);uvsRow.push(new THREE.Vector2(u,1-v))}vertices.push(verticesRow);uvs.push(uvsRow)}for(y=0;y<this.heightSegments;y++){for(x=0;x<this.widthSegments;x++){var v1=vertices[y][x+1];var v2=vertices[y][x];var v3=vertices[y+1][x];var v4=vertices[y+1][x+1];var n1=this.vertices[v1].clone().normalize();var n2=this.vertices[v2].clone().normalize();var n3=this.vertices[v3].clone().normalize();var n4=this.vertices[v4].clone().normalize();var uv1=uvs[y][x+1].clone();var uv2=uvs[y][x].clone();var uv3=uvs[y+1][x].clone();var uv4=uvs[y+1][x+1].clone();if(Math.abs(this.vertices[v1].y)===this.radius){this.faces.push(new THREE.Face3(v1,v3,v4,[n1,n3,n4]));this.faceVertexUvs[0].push([uv1,uv3,uv4])}else if(Math.abs(this.vertices[v3].y)===this.radius){this.faces.push(new THREE.Face3(v1,v2,v3,[n1,n2,n3]));this.faceVertexUvs[0].push([uv1,uv2,uv3])}else{this.faces.push(new THREE.Face4(v1,v2,v3,v4,[n1,n2,n3,n4]));this.faceVertexUvs[0].push([uv1,uv2,uv3,uv4])}}}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,radius)};THREE.SphereGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TextGeometry=function(text,parameters){parameters=parameters||{};var textShapes=THREE.FontUtils.generateShapes(text,parameters);parameters.amount=parameters.height!==undefined?parameters.height:50;if(parameters.bevelThickness===undefined)parameters.bevelThickness=10;if(parameters.bevelSize===undefined)parameters.bevelSize=8;if(parameters.bevelEnabled===undefined)parameters.bevelEnabled=false;THREE.ExtrudeGeometry.call(this,textShapes,parameters)};THREE.TextGeometry.prototype=Object.create(THREE.ExtrudeGeometry.prototype);THREE.TorusGeometry=function(radius,tube,radialSegments,tubularSegments,arc){THREE.Geometry.call(this);var scope=this;this.radius=radius||100;this.tube=tube||40;this.radialSegments=radialSegments||8;this.tubularSegments=tubularSegments||6;this.arc=arc||Math.PI*2;var center=new THREE.Vector3,uvs=[],normals=[];for(var j=0;j<=this.radialSegments;j++){for(var i=0;i<=this.tubularSegments;i++){var u=i/this.tubularSegments*this.arc;var v=j/this.radialSegments*Math.PI*2;center.x=this.radius*Math.cos(u);center.y=this.radius*Math.sin(u);var vertex=new THREE.Vector3;vertex.x=(this.radius+this.tube*Math.cos(v))*Math.cos(u);vertex.y=(this.radius+this.tube*Math.cos(v))*Math.sin(u);vertex.z=this.tube*Math.sin(v);this.vertices.push(vertex);uvs.push(new THREE.Vector2(i/this.tubularSegments,j/this.radialSegments));normals.push(vertex.clone().sub(center).normalize())}}for(var j=1;j<=this.radialSegments;j++){for(var i=1;i<=this.tubularSegments;i++){var a=(this.tubularSegments+1)*j+i-1;var b=(this.tubularSegments+1)*(j-1)+i-1;var c=(this.tubularSegments+1)*(j-1)+i;var d=(this.tubularSegments+1)*j+i;var face=new THREE.Face4(a,b,c,d,[normals[a],normals[b],normals[c],normals[d]]);face.normal.add(normals[a]);face.normal.add(normals[b]);
face.normal.add(normals[c]);face.normal.add(normals[d]);face.normal.normalize();this.faces.push(face);this.faceVertexUvs[0].push([uvs[a].clone(),uvs[b].clone(),uvs[c].clone(),uvs[d].clone()])}}this.computeCentroids()};THREE.TorusGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TorusKnotGeometry=function(radius,tube,radialSegments,tubularSegments,p,q,heightScale){THREE.Geometry.call(this);var scope=this;this.radius=radius||100;this.tube=tube||40;this.radialSegments=radialSegments||64;this.tubularSegments=tubularSegments||8;this.p=p||2;this.q=q||3;this.heightScale=heightScale||1;this.grid=new Array(this.radialSegments);var tang=new THREE.Vector3;var n=new THREE.Vector3;var bitan=new THREE.Vector3;for(var i=0;i<this.radialSegments;++i){this.grid[i]=new Array(this.tubularSegments);for(var j=0;j<this.tubularSegments;++j){var u=i/this.radialSegments*2*this.p*Math.PI;var v=j/this.tubularSegments*2*Math.PI;var p1=getPos(u,v,this.q,this.p,this.radius,this.heightScale);var p2=getPos(u+.01,v,this.q,this.p,this.radius,this.heightScale);var cx,cy;tang.subVectors(p2,p1);n.addVectors(p2,p1);bitan.crossVectors(tang,n);n.crossVectors(bitan,tang);bitan.normalize();n.normalize();cx=-this.tube*Math.cos(v);cy=this.tube*Math.sin(v);p1.x+=cx*n.x+cy*bitan.x;p1.y+=cx*n.y+cy*bitan.y;p1.z+=cx*n.z+cy*bitan.z;this.grid[i][j]=vert(p1.x,p1.y,p1.z)}}for(var i=0;i<this.radialSegments;++i){for(var j=0;j<this.tubularSegments;++j){var ip=(i+1)%this.radialSegments;var jp=(j+1)%this.tubularSegments;var a=this.grid[i][j];var b=this.grid[ip][j];var c=this.grid[ip][jp];var d=this.grid[i][jp];var uva=new THREE.Vector2(i/this.radialSegments,j/this.tubularSegments);var uvb=new THREE.Vector2((i+1)/this.radialSegments,j/this.tubularSegments);var uvc=new THREE.Vector2((i+1)/this.radialSegments,(j+1)/this.tubularSegments);var uvd=new THREE.Vector2(i/this.radialSegments,(j+1)/this.tubularSegments);this.faces.push(new THREE.Face4(a,b,c,d));this.faceVertexUvs[0].push([uva,uvb,uvc,uvd])}}this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals();function vert(x,y,z){return scope.vertices.push(new THREE.Vector3(x,y,z))-1}function getPos(u,v,in_q,in_p,radius,heightScale){var cu=Math.cos(u);var cv=Math.cos(v);var su=Math.sin(u);var quOverP=in_q/in_p*u;var cs=Math.cos(quOverP);var tx=radius*(2+cs)*.5*cu;var ty=radius*(2+cs)*su*.5;var tz=heightScale*radius*Math.sin(quOverP)*.5;return new THREE.Vector3(tx,ty,tz)}};THREE.TorusKnotGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TubeGeometry=function(path,segments,radius,radiusSegments,closed,debug){THREE.Geometry.call(this);this.path=path;this.segments=segments||64;this.radius=radius||1;this.radiusSegments=radiusSegments||8;this.closed=closed||false;if(debug)this.debug=new THREE.Object3D;this.grid=[];var scope=this,tangent,normal,binormal,numpoints=this.segments+1,x,y,z,tx,ty,tz,u,v,cx,cy,pos,pos2=new THREE.Vector3,i,j,ip,jp,a,b,c,d,uva,uvb,uvc,uvd;var frames=new THREE.TubeGeometry.FrenetFrames(this.path,this.segments,this.closed),tangents=frames.tangents,normals=frames.normals,binormals=frames.binormals;this.tangents=tangents;this.normals=normals;this.binormals=binormals;function vert(x,y,z){return scope.vertices.push(new THREE.Vector3(x,y,z))-1}for(i=0;i<numpoints;i++){this.grid[i]=[];u=i/(numpoints-1);pos=path.getPointAt(u);tangent=tangents[i];normal=normals[i];binormal=binormals[i];if(this.debug){this.debug.add(new THREE.ArrowHelper(tangent,pos,radius,255));this.debug.add(new THREE.ArrowHelper(normal,pos,radius,16711680));this.debug.add(new THREE.ArrowHelper(binormal,pos,radius,65280))}for(j=0;j<this.radiusSegments;j++){v=j/this.radiusSegments*2*Math.PI;cx=-this.radius*Math.cos(v);cy=this.radius*Math.sin(v);pos2.copy(pos);pos2.x+=cx*normal.x+cy*binormal.x;pos2.y+=cx*normal.y+cy*binormal.y;pos2.z+=cx*normal.z+cy*binormal.z;this.grid[i][j]=vert(pos2.x,pos2.y,pos2.z)}}for(i=0;i<this.segments;i++){for(j=0;j<this.radiusSegments;j++){ip=this.closed?(i+1)%this.segments:i+1;jp=(j+1)%this.radiusSegments;a=this.grid[i][j];b=this.grid[ip][j];c=this.grid[ip][jp];d=this.grid[i][jp];uva=new THREE.Vector2(i/this.segments,j/this.radiusSegments);uvb=new THREE.Vector2((i+1)/this.segments,j/this.radiusSegments);uvc=new THREE.Vector2((i+1)/this.segments,(j+1)/this.radiusSegments);uvd=new THREE.Vector2(i/this.segments,(j+1)/this.radiusSegments);this.faces.push(new THREE.Face4(a,b,c,d));this.faceVertexUvs[0].push([uva,uvb,uvc,uvd])}}this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.TubeGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TubeGeometry.FrenetFrames=function(path,segments,closed){var tangent=new THREE.Vector3,normal=new THREE.Vector3,binormal=new THREE.Vector3,tangents=[],normals=[],binormals=[],vec=new THREE.Vector3,mat=new THREE.Matrix4,numpoints=segments+1,theta,epsilon=1e-4,smallest,tx,ty,tz,i,u,v;this.tangents=tangents;this.normals=normals;this.binormals=binormals;for(i=0;i<numpoints;i++){u=i/(numpoints-1);tangents[i]=path.getTangentAt(u);tangents[i].normalize()}initialNormal3();function initialNormal1(lastBinormal){normals[0]=new THREE.Vector3;binormals[0]=new THREE.Vector3;if(lastBinormal===undefined)lastBinormal=new THREE.Vector3(0,0,1);normals[0].crossVectors(lastBinormal,tangents[0]).normalize();binormals[0].crossVectors(tangents[0],normals[0]).normalize()}function initialNormal2(){var t2=path.getTangentAt(epsilon);normals[0]=(new THREE.Vector3).subVectors(t2,tangents[0]).normalize();binormals[0]=(new THREE.Vector3).crossVectors(tangents[0],normals[0]);normals[0].crossVectors(binormals[0],tangents[0]).normalize();binormals[0].crossVectors(tangents[0],normals[0]).normalize()}function initialNormal3(){normals[0]=new THREE.Vector3;binormals[0]=new THREE.Vector3;smallest=Number.MAX_VALUE;tx=Math.abs(tangents[0].x);ty=Math.abs(tangents[0].y);tz=Math.abs(tangents[0].z);if(tx<=smallest){smallest=tx;normal.set(1,0,0)}if(ty<=smallest){smallest=ty;normal.set(0,1,0)}if(tz<=smallest){normal.set(0,0,1)}vec.crossVectors(tangents[0],normal).normalize();normals[0].crossVectors(tangents[0],vec);binormals[0].crossVectors(tangents[0],normals[0])}for(i=1;i<numpoints;i++){normals[i]=normals[i-1].clone();binormals[i]=binormals[i-1].clone();vec.crossVectors(tangents[i-1],tangents[i]);if(vec.length()>epsilon){vec.normalize();theta=Math.acos(tangents[i-1].dot(tangents[i]));normals[i].applyMatrix4(mat.makeRotationAxis(vec,theta))}binormals[i].crossVectors(tangents[i],normals[i])}if(closed){theta=Math.acos(normals[0].dot(normals[numpoints-1]));theta/=numpoints-1;if(tangents[0].dot(vec.crossVectors(normals[0],normals[numpoints-1]))>0){theta=-theta}for(i=1;i<numpoints;i++){normals[i].applyMatrix4(mat.makeRotationAxis(tangents[i],theta*i));binormals[i].crossVectors(tangents[i],normals[i])}}};THREE.PolyhedronGeometry=function(vertices,faces,radius,detail){THREE.Geometry.call(this);radius=radius||1;detail=detail||0;var that=this;for(var i=0,l=vertices.length;i<l;i++){prepare(new THREE.Vector3(vertices[i][0],vertices[i][1],vertices[i][2]))}var midpoints=[],p=this.vertices;var f=[];for(var i=0,l=faces.length;i<l;i++){var v1=p[faces[i][0]];var v2=p[faces[i][1]];var v3=p[faces[i][2]];f[i]=new THREE.Face3(v1.index,v2.index,v3.index,[v1.clone(),v2.clone(),v3.clone()])}for(var i=0,l=f.length;i<l;i++){subdivide(f[i],detail)}for(var i=0,l=this.faceVertexUvs[0].length;i<l;i++){var uvs=this.faceVertexUvs[0][i];var x0=uvs[0].x;var x1=uvs[1].x;var x2=uvs[2].x;var max=Math.max(x0,Math.max(x1,x2));var min=Math.min(x0,Math.min(x1,x2));if(max>.9&&min<.1){if(x0<.2)uvs[0].x+=1;if(x1<.2)uvs[1].x+=1;if(x2<.2)uvs[2].x+=1}}for(var i=0,l=this.vertices.length;i<l;i++){this.vertices[i].multiplyScalar(radius)}this.mergeVertices();this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,radius);function prepare(vector){var vertex=vector.normalize().clone();vertex.index=that.vertices.push(vertex)-1;var u=azimuth(vector)/2/Math.PI+.5;var v=inclination(vector)/Math.PI+.5;vertex.uv=new THREE.Vector2(u,1-v);return vertex}function make(v1,v2,v3){var face=new THREE.Face3(v1.index,v2.index,v3.index,[v1.clone(),v2.clone(),v3.clone()]);face.centroid.add(v1).add(v2).add(v3).divideScalar(3);that.faces.push(face);var azi=azimuth(face.centroid);that.faceVertexUvs[0].push([correctUV(v1.uv,v1,azi),correctUV(v2.uv,v2,azi),correctUV(v3.uv,v3,azi)])}function subdivide(face,detail){var cols=Math.pow(2,detail);var cells=Math.pow(4,detail);var a=prepare(that.vertices[face.a]);var b=prepare(that.vertices[face.b]);var c=prepare(that.vertices[face.c]);var v=[];for(var i=0;i<=cols;i++){v[i]=[];var aj=prepare(a.clone().lerp(c,i/cols));var bj=prepare(b.clone().lerp(c,i/cols));var rows=cols-i;for(var j=0;j<=rows;j++){if(j==0&&i==cols){v[i][j]=aj}else{v[i][j]=prepare(aj.clone().lerp(bj,j/rows))}}}for(var i=0;i<cols;i++){for(var j=0;j<2*(cols-i)-1;j++){var k=Math.floor(j/2);if(j%2==0){make(v[i][k+1],v[i+1][k],v[i][k])}else{make(v[i][k+1],v[i+1][k+1],v[i+1][k])}}}}function azimuth(vector){return Math.atan2(vector.z,-vector.x)}function inclination(vector){return Math.atan2(-vector.y,Math.sqrt(vector.x*vector.x+vector.z*vector.z))}function correctUV(uv,vector,azimuth){if(azimuth<0&&uv.x===1)uv=new THREE.Vector2(uv.x-1,uv.y);if(vector.x===0&&vector.z===0)uv=new THREE.Vector2(azimuth/2/Math.PI+.5,uv.y);return uv.clone()}};THREE.PolyhedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.IcosahedronGeometry=function(radius,detail){this.radius=radius;this.detail=detail;var t=(1+Math.sqrt(5))/2;var vertices=[[-1,t,0],[1,t,0],[-1,-t,0],[1,-t,0],[0,-1,t],[0,1,t],[0,-1,-t],[0,1,-t],[t,0,-1],[t,0,1],[-t,0,-1],[-t,0,1]];var faces=[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]];THREE.PolyhedronGeometry.call(this,vertices,faces,radius,detail)};THREE.IcosahedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.OctahedronGeometry=function(radius,detail){var vertices=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]];var faces=[[0,2,4],[0,4,3],[0,3,5],[0,5,2],[1,2,5],[1,5,3],[1,3,4],[1,4,2]];THREE.PolyhedronGeometry.call(this,vertices,faces,radius,detail)};THREE.OctahedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TetrahedronGeometry=function(radius,detail){var vertices=[[1,1,1],[-1,-1,1],[-1,1,-1],[1,-1,-1]];var faces=[[2,1,0],[0,3,2],[1,3,0],[2,3,1]];THREE.PolyhedronGeometry.call(this,vertices,faces,radius,detail)};THREE.TetrahedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ParametricGeometry=function(func,slices,stacks,useTris){THREE.Geometry.call(this);var verts=this.vertices;var faces=this.faces;var uvs=this.faceVertexUvs[0];useTris=useTris===undefined?false:useTris;var i,il,j,p;var u,v;var stackCount=stacks+1;var sliceCount=slices+1;for(i=0;i<=stacks;i++){v=i/stacks;for(j=0;j<=slices;j++){u=j/slices;p=func(u,v);verts.push(p)}}var a,b,c,d;var uva,uvb,uvc,uvd;for(i=0;i<stacks;i++){for(j=0;j<slices;j++){a=i*sliceCount+j;b=i*sliceCount+j+1;c=(i+1)*sliceCount+j;d=(i+1)*sliceCount+j+1;uva=new THREE.Vector2(j/slices,i/stacks);uvb=new THREE.Vector2((j+1)/slices,i/stacks);uvc=new THREE.Vector2(j/slices,(i+1)/stacks);uvd=new THREE.Vector2((j+1)/slices,(i+1)/stacks);if(useTris){faces.push(new THREE.Face3(a,b,c));faces.push(new THREE.Face3(b,d,c));uvs.push([uva,uvb,uvc]);uvs.push([uvb,uvd,uvc])}else{faces.push(new THREE.Face4(a,b,d,c));uvs.push([uva,uvb,uvd,uvc])}}}this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.ParametricGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ConvexGeometry=function(vertices){THREE.Geometry.call(this);var faces=[[0,1,2],[0,2,1]];for(var i=3;i<vertices.length;i++){addPoint(i)}function addPoint(vertexId){var vertex=vertices[vertexId].clone();var mag=vertex.length();vertex.x+=mag*randomOffset();vertex.y+=mag*randomOffset();vertex.z+=mag*randomOffset();var hole=[];for(var f=0;f<faces.length;){var face=faces[f];if(visible(face,vertex)){for(var e=0;e<3;e++){var edge=[face[e],face[(e+1)%3]];var boundary=true;for(var h=0;h<hole.length;h++){if(equalEdge(hole[h],edge)){hole[h]=hole[hole.length-1];hole.pop();boundary=false;break}}if(boundary){hole.push(edge)}}faces[f]=faces[faces.length-1];faces.pop()}else{f++}}for(var h=0;h<hole.length;h++){faces.push([hole[h][0],hole[h][1],vertexId])}}function visible(face,vertex){var va=vertices[face[0]];var vb=vertices[face[1]];var vc=vertices[face[2]];var n=normal(va,vb,vc);var dist=n.dot(va);return n.dot(vertex)>=dist}function normal(va,vb,vc){var cb=new THREE.Vector3;var ab=new THREE.Vector3;cb.subVectors(vc,vb);ab.subVectors(va,vb);cb.cross(ab);cb.normalize();return cb}function equalEdge(ea,eb){return ea[0]===eb[1]&&ea[1]===eb[0]}function randomOffset(){return(Math.random()-.5)*2*1e-6}function vertexUv(vertex){var mag=vertex.length();return new THREE.Vector2(vertex.x/mag,vertex.y/mag)}var id=0;var newId=new Array(vertices.length);for(var i=0;i<faces.length;i++){var face=faces[i];for(var j=0;j<3;j++){if(newId[face[j]]===undefined){newId[face[j]]=id++;this.vertices.push(vertices[face[j]])}face[j]=newId[face[j]]}}for(var i=0;i<faces.length;i++){this.faces.push(new THREE.Face3(faces[i][0],faces[i][1],faces[i][2]))}for(var i=0;i<this.faces.length;i++){var face=this.faces[i];this.faceVertexUvs[0].push([vertexUv(this.vertices[face.a]),vertexUv(this.vertices[face.b]),vertexUv(this.vertices[face.c])])}this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.ConvexGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.AxisHelper=function(size){size=size||1;var geometry=new THREE.Geometry;geometry.vertices.push(new THREE.Vector3,new THREE.Vector3(size,0,0),new THREE.Vector3,new THREE.Vector3(0,size,0),new THREE.Vector3,new THREE.Vector3(0,0,size));geometry.colors.push(new THREE.Color(16711680),new THREE.Color(16755200),new THREE.Color(65280),new THREE.Color(11206400),new THREE.Color(255),new THREE.Color(43775));var material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});THREE.Line.call(this,geometry,material,THREE.LinePieces)};THREE.AxisHelper.prototype=Object.create(THREE.Line.prototype);THREE.ArrowHelper=function(dir,origin,length,hex){THREE.Object3D.call(this);if(hex===undefined)hex=16776960;if(length===undefined)length=1;this.position=origin;this.useQuaternion=true;var lineGeometry=new THREE.Geometry;lineGeometry.vertices.push(new THREE.Vector3(0,0,0));lineGeometry.vertices.push(new THREE.Vector3(0,1,0));this.line=new THREE.Line(lineGeometry,new THREE.LineBasicMaterial({color:hex}));this.line.matrixAutoUpdate=false;this.add(this.line);var coneGeometry=new THREE.CylinderGeometry(0,.05,.25,5,1);coneGeometry.applyMatrix((new THREE.Matrix4).makeTranslation(0,.875,0));this.cone=new THREE.Mesh(coneGeometry,new THREE.MeshBasicMaterial({color:hex}));this.cone.matrixAutoUpdate=false;this.add(this.cone);this.setDirection(dir);this.setLength(length)};THREE.ArrowHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.ArrowHelper.prototype.setDirection=function(){var axis=new THREE.Vector3;var radians;return function(dir){if(dir.y>.999){this.quaternion.set(0,0,0,1)}else if(dir.y<-.999){this.quaternion.set(1,0,0,0)}else{axis.set(dir.z,0,-dir.x).normalize();radians=Math.acos(dir.y);this.quaternion.setFromAxisAngle(axis,radians)}}}();THREE.ArrowHelper.prototype.setLength=function(length){this.scale.set(length,length,length)};THREE.ArrowHelper.prototype.setColor=function(hex){this.line.material.color.setHex(hex);this.cone.material.color.setHex(hex)};THREE.BoxHelper=function(size){size=size||1;var geometry=new THREE.Geometry;var vertices=[new THREE.Vector3(size,size,size),new THREE.Vector3(-size,size,size),new THREE.Vector3(-size,-size,size),new THREE.Vector3(size,-size,size),new THREE.Vector3(size,size,-size),new THREE.Vector3(-size,size,-size),new THREE.Vector3(-size,-size,-size),new THREE.Vector3(size,-size,-size)];geometry.vertices.push(vertices[0],vertices[1],vertices[1],vertices[2],vertices[2],vertices[3],vertices[3],vertices[0],vertices[4],vertices[5],vertices[5],vertices[6],vertices[6],vertices[7],vertices[7],vertices[4],vertices[0],vertices[4],vertices[1],vertices[5],vertices[2],vertices[6],vertices[3],vertices[7]);this.vertices=vertices;THREE.Line.call(this,geometry,new THREE.LineBasicMaterial,THREE.LinePieces)};THREE.BoxHelper.prototype=Object.create(THREE.Line.prototype);THREE.BoxHelper.prototype.update=function(object){var geometry=object.geometry;if(geometry.boundingBox===null){geometry.computeBoundingBox()}var min=geometry.boundingBox.min;var max=geometry.boundingBox.max;var vertices=this.vertices;vertices[0].set(max.x,max.y,max.z);vertices[1].set(min.x,max.y,max.z);vertices[2].set(min.x,min.y,max.z);vertices[3].set(max.x,min.y,max.z);vertices[4].set(max.x,max.y,min.z);vertices[5].set(min.x,max.y,min.z);vertices[6].set(min.x,min.y,min.z);vertices[7].set(max.x,min.y,min.z);this.geometry.computeBoundingSphere();this.geometry.verticesNeedUpdate=true;this.matrixAutoUpdate=false;this.matrixWorld=object.matrixWorld};THREE.CameraHelper=function(camera){THREE.Line.call(this);var geometry=new THREE.Geometry;var material=new THREE.LineBasicMaterial({color:16777215,vertexColors:THREE.FaceColors});var pointMap={};var hexFrustum=16755200;var hexCone=16711680;var hexUp=43775;var hexTarget=16777215;var hexCross=3355443;addLine("n1","n2",hexFrustum);addLine("n2","n4",hexFrustum);addLine("n4","n3",hexFrustum);addLine("n3","n1",hexFrustum);addLine("f1","f2",hexFrustum);addLine("f2","f4",hexFrustum);addLine("f4","f3",hexFrustum);addLine("f3","f1",hexFrustum);addLine("n1","f1",hexFrustum);addLine("n2","f2",hexFrustum);addLine("n3","f3",hexFrustum);addLine("n4","f4",hexFrustum);addLine("p","n1",hexCone);addLine("p","n2",hexCone);addLine("p","n3",hexCone);addLine("p","n4",hexCone);addLine("u1","u2",hexUp);addLine("u2","u3",hexUp);addLine("u3","u1",hexUp);addLine("c","t",hexTarget);addLine("p","c",hexCross);addLine("cn1","cn2",hexCross);addLine("cn3","cn4",hexCross);addLine("cf1","cf2",hexCross);addLine("cf3","cf4",hexCross);function addLine(a,b,hex){addPoint(a,hex);addPoint(b,hex)}function addPoint(id,hex){geometry.vertices.push(new THREE.Vector3);geometry.colors.push(new THREE.Color(hex));if(pointMap[id]===undefined){pointMap[id]=[]}pointMap[id].push(geometry.vertices.length-1)}THREE.Line.call(this,geometry,material,THREE.LinePieces);this.camera=camera;this.matrixWorld=camera.matrixWorld;this.matrixAutoUpdate=false;this.pointMap=pointMap;this.update()};THREE.CameraHelper.prototype=Object.create(THREE.Line.prototype);THREE.CameraHelper.prototype.update=function(){var vector=new THREE.Vector3;var camera=new THREE.Camera;var projector=new THREE.Projector;return function(){var scope=this;var w=1,h=1;camera.projectionMatrix.copy(this.camera.projectionMatrix);setPoint("c",0,0,-1);setPoint("t",0,0,1);setPoint("n1",-w,-h,-1);setPoint("n2",w,-h,-1);setPoint("n3",-w,h,-1);setPoint("n4",w,h,-1);setPoint("f1",-w,-h,1);setPoint("f2",w,-h,1);setPoint("f3",-w,h,1);setPoint("f4",w,h,1);setPoint("u1",w*.7,h*1.1,-1);setPoint("u2",-w*.7,h*1.1,-1);setPoint("u3",0,h*2,-1);setPoint("cf1",-w,0,1);setPoint("cf2",w,0,1);setPoint("cf3",0,-h,1);setPoint("cf4",0,h,1);setPoint("cn1",-w,0,-1);setPoint("cn2",w,0,-1);setPoint("cn3",0,-h,-1);setPoint("cn4",0,h,-1);function setPoint(point,x,y,z){vector.set(x,y,z);projector.unprojectVector(vector,camera);var points=scope.pointMap[point];if(points!==undefined){for(var i=0,il=points.length;i<il;i++){scope.geometry.vertices[points[i]].copy(vector)}}}this.geometry.verticesNeedUpdate=true}}();THREE.DirectionalLightHelper=function(light,sphereSize){THREE.Object3D.call(this);this.matrixAutoUpdate=false;this.light=light;var geometry=new THREE.SphereGeometry(sphereSize,4,2);var material=new THREE.MeshBasicMaterial({fog:false,wireframe:true});material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightSphere=new THREE.Mesh(geometry,material);this.lightSphere.matrixWorld=this.light.matrixWorld;this.lightSphere.matrixAutoUpdate=false;this.add(this.lightSphere);geometry=new THREE.Geometry;geometry.vertices.push(this.light.position);geometry.vertices.push(this.light.target.position);geometry.computeLineDistances();material=new THREE.LineDashedMaterial({dashSize:4,gapSize:4,opacity:.75,transparent:true,fog:false});material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.targetLine=new THREE.Line(geometry,material);this.add(this.targetLine)};THREE.DirectionalLightHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.DirectionalLightHelper.prototype.update=function(){this.lightSphere.material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.targetLine.geometry.computeLineDistances();this.targetLine.geometry.verticesNeedUpdate=true;this.targetLine.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)};THREE.FaceNormalsHelper=function(object,size){size=size||20;var geometry=new THREE.Geometry;for(var i=0,l=object.geometry.faces.length;i<l;i++){var face=object.geometry.faces[i];geometry.vertices.push(face.centroid);geometry.vertices.push(face.normal.clone().multiplyScalar(size).add(face.centroid))}THREE.Line.call(this,geometry,new THREE.LineBasicMaterial({color:255}),THREE.LinePieces);this.matrixAutoUpdate=false;this.matrixWorld=object.matrixWorld};THREE.FaceNormalsHelper.prototype=Object.create(THREE.Line.prototype);THREE.GridHelper=function(size,step){var geometry=new THREE.Geometry;var material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});var color1=new THREE.Color(4473924),color2=new THREE.Color(8947848);for(var i=-size;i<=size;i+=step){geometry.vertices.push(new THREE.Vector3(-size,0,i),new THREE.Vector3(size,0,i),new THREE.Vector3(i,0,-size),new THREE.Vector3(i,0,size));var color=i===0?color1:color2;geometry.colors.push(color,color,color,color)}THREE.Line.call(this,geometry,material,THREE.LinePieces)};THREE.GridHelper.prototype=Object.create(THREE.Line.prototype);THREE.HemisphereLightHelper=function(light,sphereSize,arrowLength,domeSize){THREE.Object3D.call(this);this.light=light;var geometry=new THREE.SphereGeometry(sphereSize,4,2);geometry.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));for(var i=0,il=8;i<il;i++){geometry.faces[i].materialIndex=i<4?0:1}var materialSky=new THREE.MeshBasicMaterial({fog:false,wireframe:true});materialSky.color.copy(light.color).multiplyScalar(light.intensity);var materialGround=new THREE.MeshBasicMaterial({fog:false,wireframe:true});materialGround.color.copy(light.groundColor).multiplyScalar(light.intensity);this.lightSphere=new THREE.Mesh(geometry,new THREE.MeshFaceMaterial([materialSky,materialGround]));this.lightSphere.position=light.position;this.lightSphere.lookAt(new THREE.Vector3);this.add(this.lightSphere)};THREE.HemisphereLightHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.HemisphereLightHelper.prototype.update=function(){this.lightSphere.lookAt(new THREE.Vector3);this.lightSphere.material.materials[0].color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightSphere.material.materials[1].color.copy(this.light.groundColor).multiplyScalar(this.light.intensity)};THREE.PointLightHelper=function(light,sphereSize){THREE.Object3D.call(this);this.matrixAutoUpdate=false;this.light=light;var geometry=new THREE.SphereGeometry(sphereSize,4,2);var material=new THREE.MeshBasicMaterial({fog:false,wireframe:true});material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightSphere=new THREE.Mesh(geometry,material);this.lightSphere.matrixWorld=this.light.matrixWorld;this.lightSphere.matrixAutoUpdate=false;this.add(this.lightSphere)};THREE.PointLightHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.PointLightHelper.prototype.update=function(){this.lightSphere.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)};THREE.SpotLightHelper=function(light,sphereSize){THREE.Object3D.call(this);this.matrixAutoUpdate=false;this.light=light;var geometry=new THREE.SphereGeometry(sphereSize,4,2);var material=new THREE.MeshBasicMaterial({fog:false,wireframe:true});material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightSphere=new THREE.Mesh(geometry,material);this.lightSphere.matrixWorld=this.light.matrixWorld;this.lightSphere.matrixAutoUpdate=false;this.add(this.lightSphere);geometry=new THREE.CylinderGeometry(1e-4,1,1,8,1,true);geometry.applyMatrix((new THREE.Matrix4).makeTranslation(0,-.5,0));geometry.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));material=new THREE.MeshBasicMaterial({fog:false,wireframe:true,opacity:.3,transparent:true});material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightCone=new THREE.Mesh(geometry,material);this.lightCone.position=this.light.position;var coneLength=light.distance?light.distance:1e4;var coneWidth=coneLength*Math.tan(light.angle);this.lightCone.scale.set(coneWidth,coneWidth,coneLength);this.lightCone.lookAt(this.light.target.position);this.add(this.lightCone)};THREE.SpotLightHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.SpotLightHelper.prototype.update=function(){var coneLength=this.light.distance?this.light.distance:1e4;var coneWidth=coneLength*Math.tan(this.light.angle);this.lightCone.scale.set(coneWidth,coneWidth,coneLength);this.lightCone.lookAt(this.light.target.position);this.lightSphere.material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightCone.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)};THREE.ImmediateRenderObject=function(){THREE.Object3D.call(this);this.render=function(renderCallback){}};THREE.ImmediateRenderObject.prototype=Object.create(THREE.Object3D.prototype);THREE.LensFlare=function(texture,size,distance,blending,color){THREE.Object3D.call(this);this.lensFlares=[];this.positionScreen=new THREE.Vector3;this.customUpdateCallback=undefined;if(texture!==undefined){this.add(texture,size,distance,blending,color)}};THREE.LensFlare.prototype=Object.create(THREE.Object3D.prototype);THREE.LensFlare.prototype.add=function(texture,size,distance,blending,color,opacity){if(size===undefined)size=-1;if(distance===undefined)distance=0;if(opacity===undefined)opacity=1;if(color===undefined)color=new THREE.Color(16777215);if(blending===undefined)blending=THREE.NormalBlending;distance=Math.min(distance,Math.max(0,distance));this.lensFlares.push({texture:texture,size:size,distance:distance,x:0,y:0,z:0,scale:1,rotation:1,opacity:opacity,color:color,blending:blending})};THREE.LensFlare.prototype.updateLensFlares=function(){var f,fl=this.lensFlares.length;var flare;var vecX=-this.positionScreen.x*2;var vecY=-this.positionScreen.y*2;for(f=0;f<fl;f++){flare=this.lensFlares[f];flare.x=this.positionScreen.x+vecX*flare.distance;flare.y=this.positionScreen.y+vecY*flare.distance;flare.wantedRotation=flare.x*Math.PI*.25;flare.rotation+=(flare.wantedRotation-flare.rotation)*.25}};THREE.MorphBlendMesh=function(geometry,material){THREE.Mesh.call(this,geometry,material);this.animationsMap={};this.animationsList=[];var numFrames=this.geometry.morphTargets.length;var name="__default";var startFrame=0;var endFrame=numFrames-1;var fps=numFrames/1;this.createAnimation(name,startFrame,endFrame,fps);this.setAnimationWeight(name,1)};THREE.MorphBlendMesh.prototype=Object.create(THREE.Mesh.prototype);THREE.MorphBlendMesh.prototype.createAnimation=function(name,start,end,fps){var animation={startFrame:start,endFrame:end,length:end-start+1,fps:fps,duration:(end-start)/fps,lastFrame:0,currentFrame:0,active:false,time:0,direction:1,weight:1,directionBackwards:false,mirroredLoop:false};this.animationsMap[name]=animation;this.animationsList.push(animation)};THREE.MorphBlendMesh.prototype.autoCreateAnimations=function(fps){var pattern=/([a-z]+)(\d+)/;var firstAnimation,frameRanges={};var geometry=this.geometry;for(var i=0,il=geometry.morphTargets.length;i<il;i++){var morph=geometry.morphTargets[i];var chunks=morph.name.match(pattern);if(chunks&&chunks.length>1){var name=chunks[1];var num=chunks[2];if(!frameRanges[name])frameRanges[name]={start:Infinity,end:-Infinity};var range=frameRanges[name];if(i<range.start)range.start=i;if(i>range.end)range.end=i;if(!firstAnimation)firstAnimation=name}}for(var name in frameRanges){var range=frameRanges[name];this.createAnimation(name,range.start,range.end,fps)}this.firstAnimation=firstAnimation};THREE.MorphBlendMesh.prototype.setAnimationDirectionForward=function(name){var animation=this.animationsMap[name];if(animation){animation.direction=1;animation.directionBackwards=false}};THREE.MorphBlendMesh.prototype.setAnimationDirectionBackward=function(name){var animation=this.animationsMap[name];if(animation){animation.direction=-1;animation.directionBackwards=true}};THREE.MorphBlendMesh.prototype.setAnimationFPS=function(name,fps){var animation=this.animationsMap[name];if(animation){animation.fps=fps;animation.duration=(animation.end-animation.start)/animation.fps}};THREE.MorphBlendMesh.prototype.setAnimationDuration=function(name,duration){var animation=this.animationsMap[name];if(animation){animation.duration=duration;animation.fps=(animation.end-animation.start)/animation.duration}};THREE.MorphBlendMesh.prototype.setAnimationWeight=function(name,weight){var animation=this.animationsMap[name];if(animation){animation.weight=weight}};THREE.MorphBlendMesh.prototype.setAnimationTime=function(name,time){var animation=this.animationsMap[name];if(animation){animation.time=time}};THREE.MorphBlendMesh.prototype.getAnimationTime=function(name){var time=0;var animation=this.animationsMap[name];if(animation){time=animation.time}return time};THREE.MorphBlendMesh.prototype.getAnimationDuration=function(name){var duration=-1;var animation=this.animationsMap[name];if(animation){duration=animation.duration}return duration};THREE.MorphBlendMesh.prototype.playAnimation=function(name){var animation=this.animationsMap[name];if(animation){animation.time=0;animation.active=true}else{console.warn("animation["+name+"] undefined")}};THREE.MorphBlendMesh.prototype.stopAnimation=function(name){var animation=this.animationsMap[name];if(animation){animation.active=false}};THREE.MorphBlendMesh.prototype.update=function(delta){for(var i=0,il=this.animationsList.length;i<il;i++){var animation=this.animationsList[i];if(!animation.active)continue;var frameTime=animation.duration/animation.length;animation.time+=animation.direction*delta;if(animation.mirroredLoop){if(animation.time>animation.duration||animation.time<0){animation.direction*=-1;if(animation.time>animation.duration){animation.time=animation.duration;animation.directionBackwards=true}if(animation.time<0){animation.time=0;animation.directionBackwards=false}}}else{animation.time=animation.time%animation.duration;if(animation.time<0)animation.time+=animation.duration}var keyframe=animation.startFrame+THREE.Math.clamp(Math.floor(animation.time/frameTime),0,animation.length-1);var weight=animation.weight;if(keyframe!==animation.currentFrame){this.morphTargetInfluences[animation.lastFrame]=0;this.morphTargetInfluences[animation.currentFrame]=1*weight;this.morphTargetInfluences[keyframe]=0;animation.lastFrame=animation.currentFrame;animation.currentFrame=keyframe}var mix=animation.time%frameTime/frameTime;if(animation.directionBackwards)mix=1-mix;this.morphTargetInfluences[animation.currentFrame]=mix*weight;this.morphTargetInfluences[animation.lastFrame]=(1-mix)*weight}};THREE.LensFlarePlugin=function(){var _gl,_renderer,_precision,_lensFlare={};this.init=function(renderer){_gl=renderer.context;_renderer=renderer;_precision=renderer.getPrecision();_lensFlare.vertices=new Float32Array(8+8);_lensFlare.faces=new Uint16Array(6);var i=0;_lensFlare.vertices[i++]=-1;_lensFlare.vertices[i++]=-1;_lensFlare.vertices[i++]=0;_lensFlare.vertices[i++]=0;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=-1;
_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=0;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=-1;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=0;_lensFlare.vertices[i++]=1;i=0;_lensFlare.faces[i++]=0;_lensFlare.faces[i++]=1;_lensFlare.faces[i++]=2;_lensFlare.faces[i++]=0;_lensFlare.faces[i++]=2;_lensFlare.faces[i++]=3;_lensFlare.vertexBuffer=_gl.createBuffer();_lensFlare.elementBuffer=_gl.createBuffer();_gl.bindBuffer(_gl.ARRAY_BUFFER,_lensFlare.vertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,_lensFlare.vertices,_gl.STATIC_DRAW);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,_lensFlare.elementBuffer);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,_lensFlare.faces,_gl.STATIC_DRAW);_lensFlare.tempTexture=_gl.createTexture();_lensFlare.occlusionTexture=_gl.createTexture();_gl.bindTexture(_gl.TEXTURE_2D,_lensFlare.tempTexture);_gl.texImage2D(_gl.TEXTURE_2D,0,_gl.RGB,16,16,0,_gl.RGB,_gl.UNSIGNED_BYTE,null);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MAG_FILTER,_gl.NEAREST);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,_gl.NEAREST);_gl.bindTexture(_gl.TEXTURE_2D,_lensFlare.occlusionTexture);_gl.texImage2D(_gl.TEXTURE_2D,0,_gl.RGBA,16,16,0,_gl.RGBA,_gl.UNSIGNED_BYTE,null);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MAG_FILTER,_gl.NEAREST);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,_gl.NEAREST);if(_gl.getParameter(_gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)<=0){_lensFlare.hasVertexTexture=false;_lensFlare.program=createProgram(THREE.ShaderFlares["lensFlare"],_precision)}else{_lensFlare.hasVertexTexture=true;_lensFlare.program=createProgram(THREE.ShaderFlares["lensFlareVertexTexture"],_precision)}_lensFlare.attributes={};_lensFlare.uniforms={};_lensFlare.attributes.vertex=_gl.getAttribLocation(_lensFlare.program,"position");_lensFlare.attributes.uv=_gl.getAttribLocation(_lensFlare.program,"uv");_lensFlare.uniforms.renderType=_gl.getUniformLocation(_lensFlare.program,"renderType");_lensFlare.uniforms.map=_gl.getUniformLocation(_lensFlare.program,"map");_lensFlare.uniforms.occlusionMap=_gl.getUniformLocation(_lensFlare.program,"occlusionMap");_lensFlare.uniforms.opacity=_gl.getUniformLocation(_lensFlare.program,"opacity");_lensFlare.uniforms.color=_gl.getUniformLocation(_lensFlare.program,"color");_lensFlare.uniforms.scale=_gl.getUniformLocation(_lensFlare.program,"scale");_lensFlare.uniforms.rotation=_gl.getUniformLocation(_lensFlare.program,"rotation");_lensFlare.uniforms.screenPosition=_gl.getUniformLocation(_lensFlare.program,"screenPosition")};this.render=function(scene,camera,viewportWidth,viewportHeight){var flares=scene.__webglFlares,nFlares=flares.length;if(!nFlares)return;var tempPosition=new THREE.Vector3;var invAspect=viewportHeight/viewportWidth,halfViewportWidth=viewportWidth*.5,halfViewportHeight=viewportHeight*.5;var size=16/viewportHeight,scale=new THREE.Vector2(size*invAspect,size);var screenPosition=new THREE.Vector3(1,1,0),screenPositionPixels=new THREE.Vector2(1,1);var uniforms=_lensFlare.uniforms,attributes=_lensFlare.attributes;_gl.useProgram(_lensFlare.program);_gl.enableVertexAttribArray(_lensFlare.attributes.vertex);_gl.enableVertexAttribArray(_lensFlare.attributes.uv);_gl.uniform1i(uniforms.occlusionMap,0);_gl.uniform1i(uniforms.map,1);_gl.bindBuffer(_gl.ARRAY_BUFFER,_lensFlare.vertexBuffer);_gl.vertexAttribPointer(attributes.vertex,2,_gl.FLOAT,false,2*8,0);_gl.vertexAttribPointer(attributes.uv,2,_gl.FLOAT,false,2*8,8);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,_lensFlare.elementBuffer);_gl.disable(_gl.CULL_FACE);_gl.depthMask(false);var i,j,jl,flare,sprite;for(i=0;i<nFlares;i++){size=16/viewportHeight;scale.set(size*invAspect,size);flare=flares[i];tempPosition.set(flare.matrixWorld.elements[12],flare.matrixWorld.elements[13],flare.matrixWorld.elements[14]);tempPosition.applyMatrix4(camera.matrixWorldInverse);tempPosition.applyProjection(camera.projectionMatrix);screenPosition.copy(tempPosition);screenPositionPixels.x=screenPosition.x*halfViewportWidth+halfViewportWidth;screenPositionPixels.y=screenPosition.y*halfViewportHeight+halfViewportHeight;if(_lensFlare.hasVertexTexture||screenPositionPixels.x>0&&screenPositionPixels.x<viewportWidth&&screenPositionPixels.y>0&&screenPositionPixels.y<viewportHeight){_gl.activeTexture(_gl.TEXTURE1);_gl.bindTexture(_gl.TEXTURE_2D,_lensFlare.tempTexture);_gl.copyTexImage2D(_gl.TEXTURE_2D,0,_gl.RGB,screenPositionPixels.x-8,screenPositionPixels.y-8,16,16,0);_gl.uniform1i(uniforms.renderType,0);_gl.uniform2f(uniforms.scale,scale.x,scale.y);_gl.uniform3f(uniforms.screenPosition,screenPosition.x,screenPosition.y,screenPosition.z);_gl.disable(_gl.BLEND);_gl.enable(_gl.DEPTH_TEST);_gl.drawElements(_gl.TRIANGLES,6,_gl.UNSIGNED_SHORT,0);_gl.activeTexture(_gl.TEXTURE0);_gl.bindTexture(_gl.TEXTURE_2D,_lensFlare.occlusionTexture);_gl.copyTexImage2D(_gl.TEXTURE_2D,0,_gl.RGBA,screenPositionPixels.x-8,screenPositionPixels.y-8,16,16,0);_gl.uniform1i(uniforms.renderType,1);_gl.disable(_gl.DEPTH_TEST);_gl.activeTexture(_gl.TEXTURE1);_gl.bindTexture(_gl.TEXTURE_2D,_lensFlare.tempTexture);_gl.drawElements(_gl.TRIANGLES,6,_gl.UNSIGNED_SHORT,0);flare.positionScreen.copy(screenPosition);if(flare.customUpdateCallback){flare.customUpdateCallback(flare)}else{flare.updateLensFlares()}_gl.uniform1i(uniforms.renderType,2);_gl.enable(_gl.BLEND);for(j=0,jl=flare.lensFlares.length;j<jl;j++){sprite=flare.lensFlares[j];if(sprite.opacity>.001&&sprite.scale>.001){screenPosition.x=sprite.x;screenPosition.y=sprite.y;screenPosition.z=sprite.z;size=sprite.size*sprite.scale/viewportHeight;scale.x=size*invAspect;scale.y=size;_gl.uniform3f(uniforms.screenPosition,screenPosition.x,screenPosition.y,screenPosition.z);_gl.uniform2f(uniforms.scale,scale.x,scale.y);_gl.uniform1f(uniforms.rotation,sprite.rotation);_gl.uniform1f(uniforms.opacity,sprite.opacity);_gl.uniform3f(uniforms.color,sprite.color.r,sprite.color.g,sprite.color.b);_renderer.setBlending(sprite.blending,sprite.blendEquation,sprite.blendSrc,sprite.blendDst);_renderer.setTexture(sprite.texture,1);_gl.drawElements(_gl.TRIANGLES,6,_gl.UNSIGNED_SHORT,0)}}}}_gl.enable(_gl.CULL_FACE);_gl.enable(_gl.DEPTH_TEST);_gl.depthMask(true)};function createProgram(shader,precision){var program=_gl.createProgram();var fragmentShader=_gl.createShader(_gl.FRAGMENT_SHADER);var vertexShader=_gl.createShader(_gl.VERTEX_SHADER);var prefix="precision "+precision+" float;\n";_gl.shaderSource(fragmentShader,prefix+shader.fragmentShader);_gl.shaderSource(vertexShader,prefix+shader.vertexShader);_gl.compileShader(fragmentShader);_gl.compileShader(vertexShader);_gl.attachShader(program,fragmentShader);_gl.attachShader(program,vertexShader);_gl.linkProgram(program);return program}};THREE.ShadowMapPlugin=function(){var _gl,_renderer,_depthMaterial,_depthMaterialMorph,_depthMaterialSkin,_depthMaterialMorphSkin,_frustum=new THREE.Frustum,_projScreenMatrix=new THREE.Matrix4,_min=new THREE.Vector3,_max=new THREE.Vector3,_matrixPosition=new THREE.Vector3;this.init=function(renderer){_gl=renderer.context;_renderer=renderer;var depthShader=THREE.ShaderLib["depthRGBA"];var depthUniforms=THREE.UniformsUtils.clone(depthShader.uniforms);_depthMaterial=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms});_depthMaterialMorph=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,morphTargets:true});_depthMaterialSkin=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,skinning:true});_depthMaterialMorphSkin=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,morphTargets:true,skinning:true});_depthMaterial._shadowPass=true;_depthMaterialMorph._shadowPass=true;_depthMaterialSkin._shadowPass=true;_depthMaterialMorphSkin._shadowPass=true};this.render=function(scene,camera){if(!(_renderer.shadowMapEnabled&&_renderer.shadowMapAutoUpdate))return;this.update(scene,camera)};this.update=function(scene,camera){var i,il,j,jl,n,shadowMap,shadowMatrix,shadowCamera,program,buffer,material,webglObject,object,light,renderList,lights=[],k=0,fog=null;_gl.clearColor(1,1,1,1);_gl.disable(_gl.BLEND);_gl.enable(_gl.CULL_FACE);_gl.frontFace(_gl.CCW);if(_renderer.shadowMapCullFace===THREE.CullFaceFront){_gl.cullFace(_gl.FRONT)}else{_gl.cullFace(_gl.BACK)}_renderer.setDepthTest(true);for(i=0,il=scene.__lights.length;i<il;i++){light=scene.__lights[i];if(!light.castShadow)continue;if(light instanceof THREE.DirectionalLight&&light.shadowCascade){for(n=0;n<light.shadowCascadeCount;n++){var virtualLight;if(!light.shadowCascadeArray[n]){virtualLight=createVirtualLight(light,n);virtualLight.originalCamera=camera;var gyro=new THREE.Gyroscope;gyro.position=light.shadowCascadeOffset;gyro.add(virtualLight);gyro.add(virtualLight.target);camera.add(gyro);light.shadowCascadeArray[n]=virtualLight;console.log("Created virtualLight",virtualLight)}else{virtualLight=light.shadowCascadeArray[n]}updateVirtualLight(light,n);lights[k]=virtualLight;k++}}else{lights[k]=light;k++}}for(i=0,il=lights.length;i<il;i++){light=lights[i];if(!light.shadowMap){var shadowFilter=THREE.LinearFilter;if(_renderer.shadowMapType===THREE.PCFSoftShadowMap){shadowFilter=THREE.NearestFilter}var pars={minFilter:shadowFilter,magFilter:shadowFilter,format:THREE.RGBAFormat};light.shadowMap=new THREE.WebGLRenderTarget(light.shadowMapWidth,light.shadowMapHeight,pars);light.shadowMapSize=new THREE.Vector2(light.shadowMapWidth,light.shadowMapHeight);light.shadowMatrix=new THREE.Matrix4}if(!light.shadowCamera){if(light instanceof THREE.SpotLight){light.shadowCamera=new THREE.PerspectiveCamera(light.shadowCameraFov,light.shadowMapWidth/light.shadowMapHeight,light.shadowCameraNear,light.shadowCameraFar)}else if(light instanceof THREE.DirectionalLight){light.shadowCamera=new THREE.OrthographicCamera(light.shadowCameraLeft,light.shadowCameraRight,light.shadowCameraTop,light.shadowCameraBottom,light.shadowCameraNear,light.shadowCameraFar)}else{console.error("Unsupported light type for shadow");continue}scene.add(light.shadowCamera);if(scene.autoUpdate===true)scene.updateMatrixWorld()}if(light.shadowCameraVisible&&!light.cameraHelper){light.cameraHelper=new THREE.CameraHelper(light.shadowCamera);light.shadowCamera.add(light.cameraHelper)}if(light.isVirtual&&virtualLight.originalCamera==camera){updateShadowCamera(camera,light)}shadowMap=light.shadowMap;shadowMatrix=light.shadowMatrix;shadowCamera=light.shadowCamera;shadowCamera.position.getPositionFromMatrix(light.matrixWorld);_matrixPosition.getPositionFromMatrix(light.target.matrixWorld);shadowCamera.lookAt(_matrixPosition);shadowCamera.updateMatrixWorld();shadowCamera.matrixWorldInverse.getInverse(shadowCamera.matrixWorld);if(light.cameraHelper)light.cameraHelper.visible=light.shadowCameraVisible;if(light.shadowCameraVisible)light.cameraHelper.update();shadowMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1);shadowMatrix.multiply(shadowCamera.projectionMatrix);shadowMatrix.multiply(shadowCamera.matrixWorldInverse);_projScreenMatrix.multiplyMatrices(shadowCamera.projectionMatrix,shadowCamera.matrixWorldInverse);_frustum.setFromMatrix(_projScreenMatrix);_renderer.setRenderTarget(shadowMap);_renderer.clear();renderList=scene.__webglObjects;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];object=webglObject.object;webglObject.render=false;if(object.visible&&object.castShadow){if(!(object instanceof THREE.Mesh||object instanceof THREE.ParticleSystem)||!object.frustumCulled||_frustum.intersectsObject(object)){object._modelViewMatrix.multiplyMatrices(shadowCamera.matrixWorldInverse,object.matrixWorld);webglObject.render=true}}}var objectMaterial,useMorphing,useSkinning;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];if(webglObject.render){object=webglObject.object;buffer=webglObject.buffer;objectMaterial=getObjectMaterial(object);useMorphing=object.geometry.morphTargets.length>0&&objectMaterial.morphTargets;useSkinning=object instanceof THREE.SkinnedMesh&&objectMaterial.skinning;if(object.customDepthMaterial){material=object.customDepthMaterial}else if(useSkinning){material=useMorphing?_depthMaterialMorphSkin:_depthMaterialSkin}else if(useMorphing){material=_depthMaterialMorph}else{material=_depthMaterial}if(buffer instanceof THREE.BufferGeometry){_renderer.renderBufferDirect(shadowCamera,scene.__lights,fog,material,buffer,object)}else{_renderer.renderBuffer(shadowCamera,scene.__lights,fog,material,buffer,object)}}}renderList=scene.__webglObjectsImmediate;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];object=webglObject.object;if(object.visible&&object.castShadow){object._modelViewMatrix.multiplyMatrices(shadowCamera.matrixWorldInverse,object.matrixWorld);_renderer.renderImmediateObject(shadowCamera,scene.__lights,fog,_depthMaterial,object)}}}var clearColor=_renderer.getClearColor(),clearAlpha=_renderer.getClearAlpha();_gl.clearColor(clearColor.r,clearColor.g,clearColor.b,clearAlpha);_gl.enable(_gl.BLEND);if(_renderer.shadowMapCullFace===THREE.CullFaceFront){_gl.cullFace(_gl.BACK)}};function createVirtualLight(light,cascade){var virtualLight=new THREE.DirectionalLight;virtualLight.isVirtual=true;virtualLight.onlyShadow=true;virtualLight.castShadow=true;virtualLight.shadowCameraNear=light.shadowCameraNear;virtualLight.shadowCameraFar=light.shadowCameraFar;virtualLight.shadowCameraLeft=light.shadowCameraLeft;virtualLight.shadowCameraRight=light.shadowCameraRight;virtualLight.shadowCameraBottom=light.shadowCameraBottom;virtualLight.shadowCameraTop=light.shadowCameraTop;virtualLight.shadowCameraVisible=light.shadowCameraVisible;virtualLight.shadowDarkness=light.shadowDarkness;virtualLight.shadowBias=light.shadowCascadeBias[cascade];virtualLight.shadowMapWidth=light.shadowCascadeWidth[cascade];virtualLight.shadowMapHeight=light.shadowCascadeHeight[cascade];virtualLight.pointsWorld=[];virtualLight.pointsFrustum=[];var pointsWorld=virtualLight.pointsWorld,pointsFrustum=virtualLight.pointsFrustum;for(var i=0;i<8;i++){pointsWorld[i]=new THREE.Vector3;pointsFrustum[i]=new THREE.Vector3}var nearZ=light.shadowCascadeNearZ[cascade];var farZ=light.shadowCascadeFarZ[cascade];pointsFrustum[0].set(-1,-1,nearZ);pointsFrustum[1].set(1,-1,nearZ);pointsFrustum[2].set(-1,1,nearZ);pointsFrustum[3].set(1,1,nearZ);pointsFrustum[4].set(-1,-1,farZ);pointsFrustum[5].set(1,-1,farZ);pointsFrustum[6].set(-1,1,farZ);pointsFrustum[7].set(1,1,farZ);return virtualLight}function updateVirtualLight(light,cascade){var virtualLight=light.shadowCascadeArray[cascade];virtualLight.position.copy(light.position);virtualLight.target.position.copy(light.target.position);virtualLight.lookAt(virtualLight.target);virtualLight.shadowCameraVisible=light.shadowCameraVisible;virtualLight.shadowDarkness=light.shadowDarkness;virtualLight.shadowBias=light.shadowCascadeBias[cascade];var nearZ=light.shadowCascadeNearZ[cascade];var farZ=light.shadowCascadeFarZ[cascade];var pointsFrustum=virtualLight.pointsFrustum;pointsFrustum[0].z=nearZ;pointsFrustum[1].z=nearZ;pointsFrustum[2].z=nearZ;pointsFrustum[3].z=nearZ;pointsFrustum[4].z=farZ;pointsFrustum[5].z=farZ;pointsFrustum[6].z=farZ;pointsFrustum[7].z=farZ}function updateShadowCamera(camera,light){var shadowCamera=light.shadowCamera,pointsFrustum=light.pointsFrustum,pointsWorld=light.pointsWorld;_min.set(Infinity,Infinity,Infinity);_max.set(-Infinity,-Infinity,-Infinity);for(var i=0;i<8;i++){var p=pointsWorld[i];p.copy(pointsFrustum[i]);THREE.ShadowMapPlugin.__projector.unprojectVector(p,camera);p.applyMatrix4(shadowCamera.matrixWorldInverse);if(p.x<_min.x)_min.x=p.x;if(p.x>_max.x)_max.x=p.x;if(p.y<_min.y)_min.y=p.y;if(p.y>_max.y)_max.y=p.y;if(p.z<_min.z)_min.z=p.z;if(p.z>_max.z)_max.z=p.z}shadowCamera.left=_min.x;shadowCamera.right=_max.x;shadowCamera.top=_max.y;shadowCamera.bottom=_min.y;shadowCamera.updateProjectionMatrix()}function getObjectMaterial(object){return object.material instanceof THREE.MeshFaceMaterial?object.material.materials[0]:object.material}};THREE.ShadowMapPlugin.__projector=new THREE.Projector;THREE.SpritePlugin=function(){var _gl,_renderer,_precision,_sprite={};this.init=function(renderer){_gl=renderer.context;_renderer=renderer;_precision=renderer.getPrecision();_sprite.vertices=new Float32Array(8+8);_sprite.faces=new Uint16Array(6);var i=0;_sprite.vertices[i++]=-1;_sprite.vertices[i++]=-1;_sprite.vertices[i++]=0;_sprite.vertices[i++]=0;_sprite.vertices[i++]=1;_sprite.vertices[i++]=-1;_sprite.vertices[i++]=1;_sprite.vertices[i++]=0;_sprite.vertices[i++]=1;_sprite.vertices[i++]=1;_sprite.vertices[i++]=1;_sprite.vertices[i++]=1;_sprite.vertices[i++]=-1;_sprite.vertices[i++]=1;_sprite.vertices[i++]=0;_sprite.vertices[i++]=1;i=0;_sprite.faces[i++]=0;_sprite.faces[i++]=1;_sprite.faces[i++]=2;_sprite.faces[i++]=0;_sprite.faces[i++]=2;_sprite.faces[i++]=3;_sprite.vertexBuffer=_gl.createBuffer();_sprite.elementBuffer=_gl.createBuffer();_gl.bindBuffer(_gl.ARRAY_BUFFER,_sprite.vertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,_sprite.vertices,_gl.STATIC_DRAW);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,_sprite.elementBuffer);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,_sprite.faces,_gl.STATIC_DRAW);_sprite.program=createProgram(THREE.ShaderSprite["sprite"],_precision);_sprite.attributes={};_sprite.uniforms={};_sprite.attributes.position=_gl.getAttribLocation(_sprite.program,"position");_sprite.attributes.uv=_gl.getAttribLocation(_sprite.program,"uv");_sprite.uniforms.uvOffset=_gl.getUniformLocation(_sprite.program,"uvOffset");_sprite.uniforms.uvScale=_gl.getUniformLocation(_sprite.program,"uvScale");_sprite.uniforms.rotation=_gl.getUniformLocation(_sprite.program,"rotation");_sprite.uniforms.scale=_gl.getUniformLocation(_sprite.program,"scale");_sprite.uniforms.alignment=_gl.getUniformLocation(_sprite.program,"alignment");_sprite.uniforms.color=_gl.getUniformLocation(_sprite.program,"color");_sprite.uniforms.map=_gl.getUniformLocation(_sprite.program,"map");_sprite.uniforms.opacity=_gl.getUniformLocation(_sprite.program,"opacity");_sprite.uniforms.useScreenCoordinates=_gl.getUniformLocation(_sprite.program,"useScreenCoordinates");_sprite.uniforms.sizeAttenuation=_gl.getUniformLocation(_sprite.program,"sizeAttenuation");_sprite.uniforms.screenPosition=_gl.getUniformLocation(_sprite.program,"screenPosition");_sprite.uniforms.modelViewMatrix=_gl.getUniformLocation(_sprite.program,"modelViewMatrix");_sprite.uniforms.projectionMatrix=_gl.getUniformLocation(_sprite.program,"projectionMatrix");_sprite.uniforms.fogType=_gl.getUniformLocation(_sprite.program,"fogType");_sprite.uniforms.fogDensity=_gl.getUniformLocation(_sprite.program,"fogDensity");_sprite.uniforms.fogNear=_gl.getUniformLocation(_sprite.program,"fogNear");_sprite.uniforms.fogFar=_gl.getUniformLocation(_sprite.program,"fogFar");_sprite.uniforms.fogColor=_gl.getUniformLocation(_sprite.program,"fogColor");_sprite.uniforms.alphaTest=_gl.getUniformLocation(_sprite.program,"alphaTest")};this.render=function(scene,camera,viewportWidth,viewportHeight){var sprites=scene.__webglSprites,nSprites=sprites.length;if(!nSprites)return;var attributes=_sprite.attributes,uniforms=_sprite.uniforms;var invAspect=viewportHeight/viewportWidth;var halfViewportWidth=viewportWidth*.5,halfViewportHeight=viewportHeight*.5;_gl.useProgram(_sprite.program);_gl.enableVertexAttribArray(attributes.position);_gl.enableVertexAttribArray(attributes.uv);_gl.disable(_gl.CULL_FACE);_gl.enable(_gl.BLEND);_gl.bindBuffer(_gl.ARRAY_BUFFER,_sprite.vertexBuffer);_gl.vertexAttribPointer(attributes.position,2,_gl.FLOAT,false,2*8,0);_gl.vertexAttribPointer(attributes.uv,2,_gl.FLOAT,false,2*8,8);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,_sprite.elementBuffer);_gl.uniformMatrix4fv(uniforms.projectionMatrix,false,camera.projectionMatrix.elements);_gl.activeTexture(_gl.TEXTURE0);_gl.uniform1i(uniforms.map,0);var oldFogType=0;var sceneFogType=0;var fog=scene.fog;if(fog){_gl.uniform3f(uniforms.fogColor,fog.color.r,fog.color.g,fog.color.b);if(fog instanceof THREE.Fog){_gl.uniform1f(uniforms.fogNear,fog.near);_gl.uniform1f(uniforms.fogFar,fog.far);_gl.uniform1i(uniforms.fogType,1);oldFogType=1;sceneFogType=1}else if(fog instanceof THREE.FogExp2){_gl.uniform1f(uniforms.fogDensity,fog.density);_gl.uniform1i(uniforms.fogType,2);oldFogType=2;sceneFogType=2}}else{_gl.uniform1i(uniforms.fogType,0);oldFogType=0;sceneFogType=0}var i,sprite,material,screenPosition,size,fogType,scale=[];for(i=0;i<nSprites;i++){sprite=sprites[i];material=sprite.material;if(!sprite.visible||material.opacity===0)continue;if(!material.useScreenCoordinates){sprite._modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,sprite.matrixWorld);sprite.z=-sprite._modelViewMatrix.elements[14]}else{sprite.z=-sprite.position.z}}sprites.sort(painterSortStable);for(i=0;i<nSprites;i++){sprite=sprites[i];material=sprite.material;if(!sprite.visible||material.opacity===0)continue;if(material.map&&material.map.image&&material.map.image.width){_gl.uniform1f(uniforms.alphaTest,material.alphaTest);if(material.useScreenCoordinates===true){_gl.uniform1i(uniforms.useScreenCoordinates,1);_gl.uniform3f(uniforms.screenPosition,(sprite.position.x*_renderer.devicePixelRatio-halfViewportWidth)/halfViewportWidth,(halfViewportHeight-sprite.position.y*_renderer.devicePixelRatio)/halfViewportHeight,Math.max(0,Math.min(1,sprite.position.z)));scale[0]=_renderer.devicePixelRatio;scale[1]=_renderer.devicePixelRatio}else{_gl.uniform1i(uniforms.useScreenCoordinates,0);_gl.uniform1i(uniforms.sizeAttenuation,material.sizeAttenuation?1:0);_gl.uniformMatrix4fv(uniforms.modelViewMatrix,false,sprite._modelViewMatrix.elements);scale[0]=1;scale[1]=1}if(scene.fog&&material.fog){fogType=sceneFogType}else{fogType=0}if(oldFogType!==fogType){_gl.uniform1i(uniforms.fogType,fogType);oldFogType=fogType}size=1/(material.scaleByViewport?viewportHeight:1);scale[0]*=size*invAspect*sprite.scale.x;scale[1]*=size*sprite.scale.y;_gl.uniform2f(uniforms.uvScale,material.uvScale.x,material.uvScale.y);_gl.uniform2f(uniforms.uvOffset,material.uvOffset.x,material.uvOffset.y);_gl.uniform2f(uniforms.alignment,material.alignment.x,material.alignment.y);_gl.uniform1f(uniforms.opacity,material.opacity);_gl.uniform3f(uniforms.color,material.color.r,material.color.g,material.color.b);_gl.uniform1f(uniforms.rotation,sprite.rotation);_gl.uniform2fv(uniforms.scale,scale);_renderer.setBlending(material.blending,material.blendEquation,material.blendSrc,material.blendDst);_renderer.setDepthTest(material.depthTest);_renderer.setDepthWrite(material.depthWrite);_renderer.setTexture(material.map,0);_gl.drawElements(_gl.TRIANGLES,6,_gl.UNSIGNED_SHORT,0)}}_gl.enable(_gl.CULL_FACE)};function createProgram(shader,precision){var program=_gl.createProgram();var fragmentShader=_gl.createShader(_gl.FRAGMENT_SHADER);var vertexShader=_gl.createShader(_gl.VERTEX_SHADER);var prefix="precision "+precision+" float;\n";_gl.shaderSource(fragmentShader,prefix+shader.fragmentShader);_gl.shaderSource(vertexShader,prefix+shader.vertexShader);_gl.compileShader(fragmentShader);_gl.compileShader(vertexShader);_gl.attachShader(program,fragmentShader);_gl.attachShader(program,vertexShader);_gl.linkProgram(program);return program}function painterSortStable(a,b){if(a.z!==b.z){return b.z-a.z}else{return b.id-a.id}}};THREE.DepthPassPlugin=function(){this.enabled=false;this.renderTarget=null;var _gl,_renderer,_depthMaterial,_depthMaterialMorph,_depthMaterialSkin,_depthMaterialMorphSkin,_frustum=new THREE.Frustum,_projScreenMatrix=new THREE.Matrix4;this.init=function(renderer){_gl=renderer.context;_renderer=renderer;var depthShader=THREE.ShaderLib["depthRGBA"];var depthUniforms=THREE.UniformsUtils.clone(depthShader.uniforms);_depthMaterial=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms});_depthMaterialMorph=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,morphTargets:true});_depthMaterialSkin=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,skinning:true});_depthMaterialMorphSkin=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,morphTargets:true,skinning:true});_depthMaterial._shadowPass=true;_depthMaterialMorph._shadowPass=true;_depthMaterialSkin._shadowPass=true;_depthMaterialMorphSkin._shadowPass=true};this.render=function(scene,camera){if(!this.enabled)return;this.update(scene,camera)};this.update=function(scene,camera){var i,il,j,jl,n,program,buffer,material,webglObject,object,light,renderList,fog=null;_gl.clearColor(1,1,1,1);_gl.disable(_gl.BLEND);_renderer.setDepthTest(true);if(scene.autoUpdate===true)scene.updateMatrixWorld();camera.matrixWorldInverse.getInverse(camera.matrixWorld);_projScreenMatrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse);_frustum.setFromMatrix(_projScreenMatrix);_renderer.setRenderTarget(this.renderTarget);_renderer.clear();renderList=scene.__webglObjects;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];object=webglObject.object;webglObject.render=false;if(object.visible){if(!(object instanceof THREE.Mesh||object instanceof THREE.ParticleSystem)||!object.frustumCulled||_frustum.intersectsObject(object)){object._modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld);webglObject.render=true}}}var objectMaterial,useMorphing,useSkinning;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];if(webglObject.render){object=webglObject.object;buffer=webglObject.buffer;if(object instanceof THREE.ParticleSystem&&!object.customDepthMaterial)continue;objectMaterial=getObjectMaterial(object);if(objectMaterial)_renderer.setMaterialFaces(object.material);useMorphing=object.geometry.morphTargets.length>0&&objectMaterial.morphTargets;useSkinning=object instanceof THREE.SkinnedMesh&&objectMaterial.skinning;if(object.customDepthMaterial){material=object.customDepthMaterial}else if(useSkinning){material=useMorphing?_depthMaterialMorphSkin:_depthMaterialSkin}else if(useMorphing){material=_depthMaterialMorph}else{material=_depthMaterial}if(buffer instanceof THREE.BufferGeometry){_renderer.renderBufferDirect(camera,scene.__lights,fog,material,buffer,object)}else{_renderer.renderBuffer(camera,scene.__lights,fog,material,buffer,object)}}}renderList=scene.__webglObjectsImmediate;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];object=webglObject.object;if(object.visible){object._modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld);_renderer.renderImmediateObject(camera,scene.__lights,fog,_depthMaterial,object)}}var clearColor=_renderer.getClearColor(),clearAlpha=_renderer.getClearAlpha();_gl.clearColor(clearColor.r,clearColor.g,clearColor.b,clearAlpha);_gl.enable(_gl.BLEND)};function getObjectMaterial(object){return object.material instanceof THREE.MeshFaceMaterial?object.material.materials[0]:object.material}};THREE.ShaderFlares={lensFlareVertexTexture:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.5 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.1, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.1, 0.5 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility = (       visibility.r / 9.0 ) *","( 1.0 - visibility.g / 9.0 ) *","(       visibility.b / 9.0 ) *","( 1.0 - visibility.a / 9.0 );","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},lensFlare:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision mediump float;","uniform lowp int renderType;","uniform sampler2D map;","uniform sampler2D occlusionMap;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( texture2D( map, vUV ).rgb, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","float visibility = texture2D( occlusionMap, vec2( 0.5, 0.1 ) ).a +","texture2D( occlusionMap, vec2( 0.9, 0.5 ) ).a +","texture2D( occlusionMap, vec2( 0.5, 0.9 ) ).a +","texture2D( occlusionMap, vec2( 0.1, 0.5 ) ).a;","visibility = ( 1.0 - visibility / 4.0 );","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")}};THREE.ShaderSprite={sprite:{vertexShader:["uniform int useScreenCoordinates;","uniform int sizeAttenuation;","uniform vec3 screenPosition;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 alignment;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position + alignment;","vec2 rotatedPosition;","rotatedPosition.x = ( cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y ) * scale.x;","rotatedPosition.y = ( sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y ) * scale.y;","vec4 finalPosition;","if( useScreenCoordinates != 0 ) {","finalPosition = vec4( screenPosition.xy + rotatedPosition, screenPosition.z, 1.0 );","} else {","finalPosition = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition * ( sizeAttenuation == 1 ? 1.0 : finalPosition.z );","}","gl_Position = finalPosition;","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")}};
if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=THREE}exports.THREE=THREE}else{this["THREE"]=THREE}},{}],155:[function(require,module,exports){function Tic(){this._things=[]}module.exports=function(){return new Tic};Tic.prototype._stack=function(thing){var self=this;self._things.push(thing);var i=self._things.length-1;return function(){delete self._things[i]}};Tic.prototype.interval=Tic.prototype.setInterval=function(fn,at){return this._stack({fn:fn,at:at,args:Array.prototype.slice.call(arguments,2),elapsed:0,once:false})};Tic.prototype.timeout=Tic.prototype.setTimeout=function(fn,at){return this._stack({fn:fn,at:at,args:Array.prototype.slice.call(arguments,2),elapsed:0,once:true})};Tic.prototype.tick=function(dt){var self=this;self._things.forEach(function(thing,i){thing.elapsed+=dt;if(thing.elapsed>thing.at){thing.elapsed-=thing.at;thing.fn.apply(thing.fn,thing.args||[]);if(thing.once){delete self._things[i]}}})}},{}],156:[function(require,module,exports){module.exports=control;var Stream=require("stream").Stream;function control(control_state,opts){return new Control(control_state,opts)}function Control(state,opts){Stream.call(this);opts=opts||{};this.state=state;this._pitch_target=this._yaw_target=this._roll_target=this._target=null;this.speed=opts.speed||.0032;this.walk_max_speed=opts.walkMaxSpeed||.0056;this.run_max_speed=opts.runMaxSpeed||.0112;this.sneak_max_speed=opts.sneakMaxSpeed||.0014;this.jump_max_speed=opts.jumpMaxSpeed||.016;this.jump_max_timer=opts.jumpTimer||200;this.jump_speed=opts.jumpSpeed||.004;this.jump_speed_move=opts.jumpSpeedMove||.1;this.jump_timer=0;this.jumping=false;this.acceleration=opts.accelerationCurve||this.acceleration;this.fire_rate=opts.fireRate||0;this.needs_discrete_fire=opts.discreteFire||false;this.onfire=opts.onfire||this.onfire;this.firing=0;this.x_rotation_per_ms=opts.rotationXMax||opts.rotationMax||33;this.y_rotation_per_ms=opts.rotationYMax||opts.rotationMax||33;this.z_rotation_per_ms=opts.rotationZMax||opts.rotationMax||33;this.x_rotation_clamp=opts.rotationXClamp||Math.PI/2;this.y_rotation_clamp=opts.rotationYClamp||Infinity;this.z_rotation_clamp=opts.rotationZClamp||0;this.rotation_scale=opts.rotationScale||.002;this.air_control="airControl"in opts?opts.airControl:true;this.state.x_rotation_accum=this.state.y_rotation_accum=this.state.z_rotation_accum=0;this.accel_max_timer=opts.accelTimer||200;this.x_accel_timer=this.accel_max_timer+0;this.z_accel_timer=this.accel_max_timer+0;this.readable=this.writable=true;this.buffer=[];this.paused=false}var cons=Control,proto=cons.prototype=new Stream;proto.constructor=cons;var max=Math.max,min=Math.min,sin=Math.sin,abs=Math.abs,floor=Math.floor,PI=Math.PI;proto.tick=function(dt){if(!this._target){return}var state=this.state,target=this._target,speed=this.speed,jump_speed=this.jump_speed,jump_speed_move=this.jump_speed_move,max_speed=this.state.sprint?this.run_max_speed:this.state.crouch?this.sneak_max_speed:this.walk_max_speed,okay_z=abs(target.velocity.z)<max_speed,okay_x=abs(target.velocity.x)<max_speed,at_rest=target.atRestY();if(!this._target)return;var move_speed=speed;if(target.velocity.y!==0)move_speed=move_speed*jump_speed_move;if(state.forward||state.backward){this.z_accel_timer=max(0,this.z_accel_timer-dt)}if(state.backward){if(target.velocity.z<max_speed)target.velocity.z=max(min(max_speed,move_speed*dt*this.acceleration(this.z_accel_timer,this.accel_max_timer)),target.velocity.z)}else if(state.forward){if(target.velocity.z>-max_speed)target.velocity.z=min(max(-max_speed,-move_speed*dt*this.acceleration(this.z_accel_timer,this.accel_max_timer)),target.velocity.z)}else{this.z_accel_timer=this.accel_max_timer}if(state.left||state.right){this.x_accel_timer=max(0,this.x_accel_timer-dt)}if(state.right){if(target.velocity.x<max_speed)target.velocity.x=max(min(max_speed,move_speed*dt*this.acceleration(this.x_accel_timer,this.accel_max_timer)),target.velocity.x)}else if(state.left){if(target.velocity.x>-max_speed)target.velocity.x=min(max(-max_speed,-move_speed*dt*this.acceleration(this.x_accel_timer,this.accel_max_timer)),target.velocity.x)}else{this.x_accel_timer=this.accel_max_timer}if(state.jump){if(!this.jumping&&!at_rest){}else if(at_rest>0){this.jumping=false}else{this.jumping=true;if(this.jump_timer>0){target.velocity.y=min(target.velocity.y+jump_speed*min(dt,this.jump_timer),this.jump_max_speed)}this.jump_timer=max(this.jump_timer-dt,0)}}else{this.jumping=false}this.jump_timer=at_rest<0?this.jump_max_timer:this.jump_timer;var can_fire=true;if(state.fire||state.firealt){if(this.firing&&this.needs_discrete_fire){this.firing+=dt}else{if(!this.fire_rate||floor(this.firing/this.fire_rate)!==floor((this.firing+dt)/this.fire_rate)){this.onfire(state)}this.firing+=dt}}else{this.firing=0}var x_rotation=this.state.x_rotation_accum*this.rotation_scale,y_rotation=this.state.y_rotation_accum*this.rotation_scale,z_rotation=this.state.z_rotation_accum*this.rotation_scale,pitch_target=this._pitch_target,yaw_target=this._yaw_target,roll_target=this._roll_target;if(pitch_target===yaw_target&&yaw_target===roll_target){pitch_target.eulerOrder="YXZ"}pitch_target.rotation.x=clamp(pitch_target.rotation.x+clamp(x_rotation,this.x_rotation_per_ms),this.x_rotation_clamp);yaw_target.rotation.y=clamp(yaw_target.rotation.y+clamp(y_rotation,this.y_rotation_per_ms),this.y_rotation_clamp);roll_target.rotation.z=clamp(roll_target.rotation.z+clamp(z_rotation,this.z_rotation_per_ms),this.z_rotation_clamp);if(this.listeners("data").length){this.emitUpdate()}this.state.x_rotation_accum=this.state.y_rotation_accum=this.state.z_rotation_accum=0};proto.write=function(changes){for(var key in changes){this.state[key]=changes[key]}};proto.end=function(deltas){if(deltas){this.write(deltas)}};proto.createWriteRotationStream=function(){var state=this.state,stream=new Stream;state.x_rotation_accum=state.y_rotation_accum=state.z_rotation_accum=0;stream.writable=true;stream.write=write;stream.end=end;return stream;function write(changes){state.x_rotation_accum-=changes.dy||0;state.y_rotation_accum-=changes.dx||0;state.z_rotation_accum+=changes.dz||0}function end(deltas){if(deltas){stream.write(deltas)}}};proto.emitUpdate=function(){return this.queue({x_rotation_accum:this.state.x_rotation_accum,y_rotation_accum:this.state.y_rotation_accum,z_rotation_accum:this.state.z_rotation_accum,forward:this.state.forward,backward:this.state.backward,left:this.state.left,right:this.state.right,fire:this.state.fire,firealt:this.state.firealt,jump:this.state.jump})};proto.drain=function(){var buf=this.buffer,data;while(buf.length&&!this.paused){data=buf.shift();if(null===data){return this.emit("end")}this.emit("data",data)}};proto.resume=function(){this.paused=false;this.drain();if(!this.paused){this.emit("drain")}return this};proto.pause=function(){if(this.paused)return;this.paused=true;this.emit("pause");return this};proto.queue=function(data){this.buffer.push(data);this.drain();return this};proto.acceleration=function(current,max){var pct=(max-current)/max;return sin(PI/2*pct)};proto.target=function(target){if(target){this._target=target;this._yaw_target=target.yaw||target;this._pitch_target=target.pitch||target;this._roll_target=target.roll||target}return this._target};proto.onfire=function(_){};function clamp(value,to){return isFinite(to)?max(min(value,to),-to):value}},{stream:520}],157:[function(require,module,exports){var THREE=require("three");module.exports=function(data,mesher,scaleFactor,three,mesherExtraData){return new Mesh(data,mesher,scaleFactor,three,mesherExtraData)};module.exports.Mesh=Mesh;function Mesh(data,mesher,scaleFactor,three,mesherExtraData){this.THREE=three||THREE;this.data=data;var geometry=this.geometry=new this.THREE.Geometry;this.scale=scaleFactor||new this.THREE.Vector3(10,10,10);var result=mesher(data.voxels,data.dims,mesherExtraData);this.meshed=result;geometry.vertices.length=0;geometry.faces.length=0;for(var i=0;i<result.vertices.length;++i){var q=result.vertices[i];geometry.vertices.push(new this.THREE.Vector3(q[0],q[1],q[2]))}for(var i=0;i<result.faces.length;++i){geometry.faceVertexUvs[0].push(this.faceVertexUv(i));var q=result.faces[i];if(q.length===5){var f=new this.THREE.Face4(q[0],q[1],q[2],q[3]);f.color=new this.THREE.Color(q[4]);geometry.faces.push(f)}else if(q.length==4){var f=new this.THREE.Face3(q[0],q[1],q[2]);f.color=new this.THREE.Color(q[3]);geometry.faces.push(f)}}geometry.computeFaceNormals();geometry.verticesNeedUpdate=true;geometry.elementsNeedUpdate=true;geometry.normalsNeedUpdate=true;geometry.computeBoundingBox();geometry.computeBoundingSphere()}Mesh.prototype.createWireMesh=function(hexColor){var wireMaterial=new this.THREE.MeshBasicMaterial({color:hexColor||16777215,wireframe:true});wireMesh=new this.THREE.Mesh(this.geometry,wireMaterial);wireMesh.scale=this.scale;wireMesh.doubleSided=true;this.wireMesh=wireMesh;return wireMesh};Mesh.prototype.createSurfaceMesh=function(material){material=material||new this.THREE.MeshNormalMaterial;var surfaceMesh=new this.THREE.Mesh(this.geometry,material);surfaceMesh.scale=this.scale;surfaceMesh.doubleSided=false;this.surfaceMesh=surfaceMesh;return surfaceMesh};Mesh.prototype.addToScene=function(scene){if(this.wireMesh)scene.add(this.wireMesh);if(this.surfaceMesh)scene.add(this.surfaceMesh)};Mesh.prototype.setPosition=function(x,y,z){if(this.wireMesh)this.wireMesh.position=new this.THREE.Vector3(x,y,z);if(this.surfaceMesh)this.surfaceMesh.position=new this.THREE.Vector3(x,y,z)};Mesh.prototype.faceVertexUv=function(i){var vs=[this.meshed.vertices[i*4+0],this.meshed.vertices[i*4+1],this.meshed.vertices[i*4+2],this.meshed.vertices[i*4+3]];var spans={x0:vs[0][0]-vs[1][0],x1:vs[1][0]-vs[2][0],y0:vs[0][1]-vs[1][1],y1:vs[1][1]-vs[2][1],z0:vs[0][2]-vs[1][2],z1:vs[1][2]-vs[2][2]};var size={x:Math.max(Math.abs(spans.x0),Math.abs(spans.x1)),y:Math.max(Math.abs(spans.y0),Math.abs(spans.y1)),z:Math.max(Math.abs(spans.z0),Math.abs(spans.z1))};if(size.x===0){if(spans.y0>spans.y1){var width=size.y;var height=size.z}else{var width=size.z;var height=size.y}}if(size.y===0){if(spans.x0>spans.x1){var width=size.x;var height=size.z}else{var width=size.z;var height=size.x}}if(size.z===0){if(spans.x0>spans.x1){var width=size.x;var height=size.y}else{var width=size.y;var height=size.x}}if(size.z===0&&spans.x0<spans.x1||size.x===0&&spans.y0>spans.y1){return[new this.THREE.Vector2(height,0),new this.THREE.Vector2(0,0),new this.THREE.Vector2(0,width),new this.THREE.Vector2(height,width)]}else{return[new this.THREE.Vector2(0,0),new this.THREE.Vector2(0,height),new this.THREE.Vector2(width,height),new this.THREE.Vector2(width,0)]}}},{three:154}],158:[function(require,module,exports){module.exports=physical;var aabb=require("aabb-3d"),THREE=require("three");function physical(avatar,collidables,dimensions,terminal){return new Physical(avatar,collidables,dimensions,terminal)}function Physical(avatar,collidables,dimensions,terminal){this.avatar=avatar;this.terminal=terminal||new THREE.Vector3(.9,.1,.9);this.dimensions=dimensions=dimensions||[1,1,1];this._aabb=aabb([0,0,0],dimensions);this.resting={x:false,y:false,z:false};this.collidables=collidables;this.friction=new THREE.Vector3(1,1,1);this.rotation=this.avatar.rotation;this.default_friction=1;this.fell=undefined;this.yaw=this.pitch=this.roll=avatar;this.forces=new THREE.Vector3(0,0,0);this.attractors=[];this.acceleration=new THREE.Vector3(0,0,0);this.velocity=new THREE.Vector3(0,0,0)}var cons=Physical,proto=cons.prototype,axes=["x","y","z"],abs=Math.abs;var WORLD_DESIRED=new THREE.Vector3(0,0,0),DESIRED=new THREE.Vector3(0,0,0),START=new THREE.Vector3(0,0,0),END=new THREE.Vector3(0,0,0),DIRECTION=new THREE.Vector3,LOCAL_ATTRACTOR=new THREE.Vector3,TOTAL_FORCES=new THREE.Vector3;proto.applyWorldAcceleration=applyTo("acceleration");proto.applyWorldVelocity=applyTo("velocity");function applyTo(which){return function(world){var local=this.avatar.worldToLocal(world);this[which].x+=local.x;this[which].y+=local.y;this[which].z+=local.z}}proto.tick=function(dt){var forces=this.forces,acceleration=this.acceleration,velocity=this.velocity,terminal=this.terminal,friction=this.friction,desired=DESIRED,world_desired=WORLD_DESIRED,bbox,pcs;TOTAL_FORCES.multiplyScalar(0);desired.x=desired.y=desired.z=world_desired.x=world_desired.y=world_desired.z=0;for(var i=0;i<this.attractors.length;i++){var distance_factor=this.avatar.position.distanceToSquared(this.attractors[i]);LOCAL_ATTRACTOR.copy(this.attractors[i]);LOCAL_ATTRACTOR=this.avatar.worldToLocal(LOCAL_ATTRACTOR);DIRECTION.sub(LOCAL_ATTRACTOR,this.avatar.position);DIRECTION.divideScalar(DIRECTION.length()*distance_factor);DIRECTION.multiplyScalar(this.attractors[i].mass);TOTAL_FORCES.addSelf(DIRECTION)}if(!this.resting.x){acceleration.x/=8*dt;acceleration.x+=TOTAL_FORCES.x*dt;acceleration.x+=forces.x*dt;velocity.x+=acceleration.x*dt;velocity.x*=friction.x;if(abs(velocity.x)<terminal.x){desired.x=velocity.x*dt}else if(velocity.x!==0){desired.x=velocity.x/abs(velocity.x)*terminal.x}}else{acceleration.x=velocity.x=0}if(!this.resting.y){acceleration.y/=8*dt;acceleration.y+=TOTAL_FORCES.y*dt;acceleration.y+=forces.y*dt;velocity.y+=acceleration.y*dt;velocity.y*=friction.y;if(abs(velocity.y)<terminal.y){desired.y=velocity.y*dt}else if(velocity.y!==0){desired.y=velocity.y/abs(velocity.y)*terminal.y}}else{acceleration.y=velocity.y=0}if(!this.resting.z){acceleration.z/=8*dt;acceleration.z+=TOTAL_FORCES.z*dt;acceleration.z+=forces.z*dt;velocity.z+=acceleration.z*dt;velocity.z*=friction.z;if(abs(velocity.z)<terminal.z){desired.z=velocity.z*dt}else if(velocity.z!==0){desired.z=velocity.z/abs(velocity.z)*terminal.z}}else{acceleration.z=velocity.z=0}START.copy(this.avatar.position);this.avatar.translateX(desired.x);this.avatar.translateY(desired.y);this.avatar.translateZ(desired.z);END.copy(this.avatar.position);this.avatar.position.copy(START);world_desired.x=END.x-START.x;world_desired.y=END.y-START.y;world_desired.z=END.z-START.z;this.friction.x=this.friction.y=this.friction.z=this.default_friction;this.old_old_resting_y=this.old_resting_y;this.old_resting_y=this.resting.y;this.resting.x=this.resting.y=this.resting.z=false;bbox=this.aabb();pcs=this.collidables;for(var i=0,len=pcs.length;i<len;++i){if(pcs[i]!==this){pcs[i].collide(this,bbox,world_desired,this.resting)}}if(this.old_old_resting_y!==this.resting.y){if(!this.resting.y){this.lastRestY=this.avatar.position.y}else if(this.lastRestY!==undefined){if(this.fell)this.fell(this.lastRestY-this.avatar.position.y)}}this.avatar.position.x+=world_desired.x;this.avatar.position.y+=world_desired.y;this.avatar.position.z+=world_desired.z};proto.subjectTo=function(force){this.forces.x+=force[0];this.forces.y+=force[1];this.forces.z+=force[2];return this};proto.removeForce=function(force){this.forces.x-=force[0];this.forces.y-=force[1];this.forces.z-=force[2];return this};proto.attractTo=function(vector,mass){vector.mass=mass;this.attractors.push(vector)};proto.aabb=function(){var pos=this.avatar.position;var d=this.dimensions;return aabb([pos.x-d[0]/2,pos.y,pos.z-d[2]/2],this.dimensions)};proto.collide=function(other,bbox,world_vec,resting){return};proto.atRestX=function(){return this.resting.x};proto.atRestY=function(){return this.resting.y};proto.atRestZ=function(){return this.resting.z}},{"aabb-3d":159,three:161}],159:[function(require,module,exports){module.exports=require(132)},{"gl-matrix":160}],160:[function(require,module,exports){module.exports=require(134)},{}],161:[function(require,module,exports){var process=require("__browserify_process");var self=self||{};if(self.performance===undefined){self.performance={}}if(self.performance.now===undefined){if(process!==undefined&&process.hrtime!==undefined){self.performance.now=function(){var time=process.hrtime();return(time[0]+time[1]/1e9)*1e3}}else{self.performance.now=function(){return(new Date).getTime()}}}var THREE=THREE||{REVISION:"59dev"};self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}};self.Int32Array=self.Int32Array||Array;self.Float32Array=self.Float32Array||Array;String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};THREE.extend=function(obj,source){if(Object.keys){var keys=Object.keys(source);for(var i=0,il=keys.length;i<il;i++){var prop=keys[i];Object.defineProperty(obj,prop,Object.getOwnPropertyDescriptor(source,prop))}}else{var safeHasOwnProperty={}.hasOwnProperty;for(var prop in source){if(safeHasOwnProperty.call(source,prop)){obj[prop]=source[prop]}}}return obj};(function(){var lastTime=0;var vendors=["ms","moz","webkit","o"];for(var x=0;x<vendors.length&&!self.requestAnimationFrame;++x){self.requestAnimationFrame=self[vendors[x]+"RequestAnimationFrame"];self.cancelAnimationFrame=self[vendors[x]+"CancelAnimationFrame"]||self[vendors[x]+"CancelRequestAnimationFrame"]}if(self.requestAnimationFrame===undefined&&self["setTimeout"]!==undefined){self.requestAnimationFrame=function(callback){var currTime=Date.now(),timeToCall=Math.max(0,16-(currTime-lastTime));var id=self.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id}}if(self.cancelAnimationFrame===undefined&&self["clearTimeout"]!==undefined){self.cancelAnimationFrame=function(id){self.clearTimeout(id)}}})();THREE.CullFaceNone=0;THREE.CullFaceBack=1;THREE.CullFaceFront=2;THREE.CullFaceFrontBack=3;THREE.FrontFaceDirectionCW=0;THREE.FrontFaceDirectionCCW=1;THREE.BasicShadowMap=0;THREE.PCFShadowMap=1;THREE.PCFSoftShadowMap=2;THREE.FrontSide=0;THREE.BackSide=1;THREE.DoubleSide=2;THREE.NoShading=0;THREE.FlatShading=1;THREE.SmoothShading=2;THREE.NoColors=0;THREE.FaceColors=1;THREE.VertexColors=2;THREE.NoBlending=0;THREE.NormalBlending=1;THREE.AdditiveBlending=2;THREE.SubtractiveBlending=3;THREE.MultiplyBlending=4;THREE.CustomBlending=5;THREE.AddEquation=100;THREE.SubtractEquation=101;THREE.ReverseSubtractEquation=102;THREE.ZeroFactor=200;THREE.OneFactor=201;THREE.SrcColorFactor=202;THREE.OneMinusSrcColorFactor=203;THREE.SrcAlphaFactor=204;THREE.OneMinusSrcAlphaFactor=205;THREE.DstAlphaFactor=206;THREE.OneMinusDstAlphaFactor=207;THREE.DstColorFactor=208;THREE.OneMinusDstColorFactor=209;THREE.SrcAlphaSaturateFactor=210;THREE.MultiplyOperation=0;THREE.MixOperation=1;THREE.AddOperation=2;THREE.UVMapping=function(){};THREE.CubeReflectionMapping=function(){};THREE.CubeRefractionMapping=function(){};THREE.SphericalReflectionMapping=function(){};THREE.SphericalRefractionMapping=function(){};THREE.RepeatWrapping=1e3;THREE.ClampToEdgeWrapping=1001;THREE.MirroredRepeatWrapping=1002;THREE.NearestFilter=1003;THREE.NearestMipMapNearestFilter=1004;THREE.NearestMipMapLinearFilter=1005;THREE.LinearFilter=1006;THREE.LinearMipMapNearestFilter=1007;THREE.LinearMipMapLinearFilter=1008;THREE.UnsignedByteType=1009;THREE.ByteType=1010;THREE.ShortType=1011;THREE.UnsignedShortType=1012;THREE.IntType=1013;THREE.UnsignedIntType=1014;THREE.FloatType=1015;THREE.UnsignedShort4444Type=1016;THREE.UnsignedShort5551Type=1017;THREE.UnsignedShort565Type=1018;THREE.AlphaFormat=1019;THREE.RGBFormat=1020;THREE.RGBAFormat=1021;THREE.LuminanceFormat=1022;THREE.LuminanceAlphaFormat=1023;THREE.RGB_S3TC_DXT1_Format=2001;THREE.RGBA_S3TC_DXT1_Format=2002;THREE.RGBA_S3TC_DXT3_Format=2003;THREE.RGBA_S3TC_DXT5_Format=2004;THREE.Color=function(value){if(value!==undefined)this.set(value);return this};THREE.Color.prototype={constructor:THREE.Color,r:1,g:1,b:1,set:function(value){if(value instanceof THREE.Color){this.copy(value)}else if(typeof value==="number"){this.setHex(value)}else if(typeof value==="string"){this.setStyle(value)}return this},setHex:function(hex){hex=Math.floor(hex);this.r=(hex>>16&255)/255;this.g=(hex>>8&255)/255;this.b=(hex&255)/255;return this},setRGB:function(r,g,b){this.r=r;this.g=g;this.b=b;return this},setHSL:function(h,s,l){if(s===0){this.r=this.g=this.b=l}else{var hue2rgb=function(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*6*(2/3-t);return p};var p=l<=.5?l*(1+s):l+s-l*s;var q=2*l-p;this.r=hue2rgb(q,p,h+1/3);this.g=hue2rgb(q,p,h);this.b=hue2rgb(q,p,h-1/3)}return this},setStyle:function(style){if(/^rgb\((\d+),(\d+),(\d+)\)$/i.test(style)){var color=/^rgb\((\d+),(\d+),(\d+)\)$/i.exec(style);this.r=Math.min(255,parseInt(color[1],10))/255;this.g=Math.min(255,parseInt(color[2],10))/255;this.b=Math.min(255,parseInt(color[3],10))/255;return this}if(/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.test(style)){var color=/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.exec(style);this.r=Math.min(100,parseInt(color[1],10))/100;this.g=Math.min(100,parseInt(color[2],10))/100;this.b=Math.min(100,parseInt(color[3],10))/100;return this}if(/^\#([0-9a-f]{6})$/i.test(style)){var color=/^\#([0-9a-f]{6})$/i.exec(style);this.setHex(parseInt(color[1],16));return this}if(/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(style)){var color=/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(style);this.setHex(parseInt(color[1]+color[1]+color[2]+color[2]+color[3]+color[3],16));return this}if(/^(\w+)$/i.test(style)){this.setHex(THREE.ColorKeywords[style]);return this}},copy:function(color){this.r=color.r;this.g=color.g;this.b=color.b;return this},copyGammaToLinear:function(color){this.r=color.r*color.r;this.g=color.g*color.g;this.b=color.b*color.b;return this},copyLinearToGamma:function(color){this.r=Math.sqrt(color.r);this.g=Math.sqrt(color.g);this.b=Math.sqrt(color.b);return this},convertGammaToLinear:function(){var r=this.r,g=this.g,b=this.b;this.r=r*r;this.g=g*g;this.b=b*b;return this},convertLinearToGamma:function(){this.r=Math.sqrt(this.r);this.g=Math.sqrt(this.g);this.b=Math.sqrt(this.b);return this},getHex:function(){return this.r*255<<16^this.g*255<<8^this.b*255<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(){var hsl={h:0,s:0,l:0};return function(){var r=this.r,g=this.g,b=this.b;var max=Math.max(r,g,b);var min=Math.min(r,g,b);var hue,saturation;var lightness=(min+max)/2;if(min===max){hue=0;saturation=0}else{var delta=max-min;saturation=lightness<=.5?delta/(max+min):delta/(2-max-min);switch(max){case r:hue=(g-b)/delta+(g<b?6:0);break;case g:hue=(b-r)/delta+2;break;case b:hue=(r-g)/delta+4;break}hue/=6}hsl.h=hue;hsl.s=saturation;hsl.l=lightness;return hsl}}(),getStyle:function(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+","+(this.b*255|0)+")"},offsetHSL:function(h,s,l){var hsl=this.getHSL();hsl.h+=h;hsl.s+=s;hsl.l+=l;this.setHSL(hsl.h,hsl.s,hsl.l);return this},add:function(color){this.r+=color.r;this.g+=color.g;this.b+=color.b;return this},addColors:function(color1,color2){this.r=color1.r+color2.r;this.g=color1.g+color2.g;this.b=color1.b+color2.b;return this},addScalar:function(s){this.r+=s;this.g+=s;this.b+=s;return this},multiply:function(color){this.r*=color.r;this.g*=color.g;this.b*=color.b;return this},multiplyScalar:function(s){this.r*=s;this.g*=s;this.b*=s;return this},lerp:function(color,alpha){this.r+=(color.r-this.r)*alpha;this.g+=(color.g-this.g)*alpha;this.b+=(color.b-this.b)*alpha;return this},equals:function(c){return c.r===this.r&&c.g===this.g&&c.b===this.b},clone:function(){return(new THREE.Color).setRGB(this.r,this.g,this.b)}};THREE.ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};THREE.Quaternion=function(x,y,z,w){this.x=x||0;this.y=y||0;this.z=z||0;this.w=w!==undefined?w:1};THREE.Quaternion.prototype={constructor:THREE.Quaternion,set:function(x,y,z,w){this.x=x;this.y=y;this.z=z;this.w=w;return this},copy:function(q){this.x=q.x;this.y=q.y;this.z=q.z;this.w=q.w;return this},setFromEuler:function(v,order){var c1=Math.cos(v.x/2);var c2=Math.cos(v.y/2);var c3=Math.cos(v.z/2);var s1=Math.sin(v.x/2);var s2=Math.sin(v.y/2);var s3=Math.sin(v.z/2);if(order===undefined||order==="XYZ"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="YXZ"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}else if(order==="ZXY"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="ZYX"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}else if(order==="YZX"){this.x=s1*c2*c3+c1*s2*s3;this.y=c1*s2*c3+s1*c2*s3;this.z=c1*c2*s3-s1*s2*c3;this.w=c1*c2*c3-s1*s2*s3}else if(order==="XZY"){this.x=s1*c2*c3-c1*s2*s3;this.y=c1*s2*c3-s1*c2*s3;this.z=c1*c2*s3+s1*s2*c3;this.w=c1*c2*c3+s1*s2*s3}return this},setFromAxisAngle:function(axis,angle){var halfAngle=angle/2,s=Math.sin(halfAngle);this.x=axis.x*s;this.y=axis.y*s;this.z=axis.z*s;this.w=Math.cos(halfAngle);return this},setFromRotationMatrix:function(m){var te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10],trace=m11+m22+m33,s;if(trace>0){s=.5/Math.sqrt(trace+1);this.w=.25/s;this.x=(m32-m23)*s;this.y=(m13-m31)*s;this.z=(m21-m12)*s}else if(m11>m22&&m11>m33){s=2*Math.sqrt(1+m11-m22-m33);this.w=(m32-m23)/s;this.x=.25*s;this.y=(m12+m21)/s;this.z=(m13+m31)/s}else if(m22>m33){s=2*Math.sqrt(1+m22-m11-m33);this.w=(m13-m31)/s;this.x=(m12+m21)/s;this.y=.25*s;this.z=(m23+m32)/s}else{s=2*Math.sqrt(1+m33-m11-m22);this.w=(m21-m12)/s;this.x=(m13+m31)/s;this.y=(m23+m32)/s;this.z=.25*s}return this},inverse:function(){this.conjugate().normalize();return this},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var l=this.length();if(l===0){this.x=0;this.y=0;this.z=0;this.w=1}else{l=1/l;this.x=this.x*l;this.y=this.y*l;this.z=this.z*l;this.w=this.w*l}return this},multiply:function(q,p){if(p!==undefined){console.warn("DEPRECATED: Quaternion's .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead.");return this.multiplyQuaternions(q,p)}return this.multiplyQuaternions(this,q)},multiplyQuaternions:function(a,b){var qax=a.x,qay=a.y,qaz=a.z,qaw=a.w;var qbx=b.x,qby=b.y,qbz=b.z,qbw=b.w;this.x=qax*qbw+qaw*qbx+qay*qbz-qaz*qby;this.y=qay*qbw+qaw*qby+qaz*qbx-qax*qbz;this.z=qaz*qbw+qaw*qbz+qax*qby-qay*qbx;this.w=qaw*qbw-qax*qbx-qay*qby-qaz*qbz;return this},multiplyVector3:function(vector){console.warn("DEPRECATED: Quaternion's .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead.");return vector.applyQuaternion(this)},slerp:function(qb,t){var x=this.x,y=this.y,z=this.z,w=this.w;var cosHalfTheta=w*qb.w+x*qb.x+y*qb.y+z*qb.z;if(cosHalfTheta<0){this.w=-qb.w;this.x=-qb.x;this.y=-qb.y;this.z=-qb.z;cosHalfTheta=-cosHalfTheta}else{this.copy(qb)}if(cosHalfTheta>=1){this.w=w;this.x=x;this.y=y;this.z=z;return this}var halfTheta=Math.acos(cosHalfTheta);var sinHalfTheta=Math.sqrt(1-cosHalfTheta*cosHalfTheta);if(Math.abs(sinHalfTheta)<.001){this.w=.5*(w+this.w);this.x=.5*(x+this.x);this.y=.5*(y+this.y);this.z=.5*(z+this.z);return this}var ratioA=Math.sin((1-t)*halfTheta)/sinHalfTheta,ratioB=Math.sin(t*halfTheta)/sinHalfTheta;this.w=w*ratioA+this.w*ratioB;this.x=x*ratioA+this.x*ratioB;this.y=y*ratioA+this.y*ratioB;this.z=z*ratioA+this.z*ratioB;return this},equals:function(v){return v.x===this.x&&v.y===this.y&&v.z===this.z&&v.w===this.w},fromArray:function(array){this.x=array[0];this.y=array[1];this.z=array[2];this.w=array[3];return this},toArray:function(){return[this.x,this.y,this.z,this.w]},clone:function(){return new THREE.Quaternion(this.x,this.y,this.z,this.w)}};THREE.Quaternion.slerp=function(qa,qb,qm,t){return qm.copy(qa).slerp(qb,t)};THREE.Vector2=function(x,y){this.x=x||0;this.y=y||0};THREE.Vector2.prototype={constructor:THREE.Vector2,set:function(x,y){this.x=x;this.y=y;return this},setX:function(x){this.x=x;return this},setY:function(y){this.y=y;return this},setComponent:function(index,value){switch(index){case 0:this.x=value;break;case 1:this.y=value;break;default:throw new Error("index is out of range: "+index)}},getComponent:function(index){switch(index){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+index)}},copy:function(v){this.x=v.x;this.y=v.y;return this},add:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector2's .add() now only accepts one argument. Use .addVectors( a, b ) instead.");return this.addVectors(v,w)}this.x+=v.x;this.y+=v.y;return this},addVectors:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;return this},addScalar:function(s){this.x+=s;this.y+=s;return this},sub:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector2's .sub() now only accepts one argument. Use .subVectors( a, b ) instead.");return this.subVectors(v,w)}this.x-=v.x;this.y-=v.y;return this},subVectors:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;return this},multiplyScalar:function(s){this.x*=s;this.y*=s;return this},divideScalar:function(s){if(s!==0){this.x/=s;this.y/=s}else{this.set(0,0)}return this},min:function(v){if(this.x>v.x){this.x=v.x}if(this.y>v.y){this.y=v.y}return this},max:function(v){if(this.x<v.x){this.x=v.x}if(this.y<v.y){this.y=v.y}return this},clamp:function(min,max){if(this.x<min.x){this.x=min.x}else if(this.x>max.x){this.x=max.x}if(this.y<min.y){this.y=min.y}else if(this.y>max.y){this.y=max.y}return this
},negate:function(){return this.multiplyScalar(-1)},dot:function(v){return this.x*v.x+this.y*v.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(v){return Math.sqrt(this.distanceToSquared(v))},distanceToSquared:function(v){var dx=this.x-v.x,dy=this.y-v.y;return dx*dx+dy*dy},setLength:function(l){var oldLength=this.length();if(oldLength!==0&&l!==oldLength){this.multiplyScalar(l/oldLength)}return this},lerp:function(v,alpha){this.x+=(v.x-this.x)*alpha;this.y+=(v.y-this.y)*alpha;return this},equals:function(v){return v.x===this.x&&v.y===this.y},fromArray:function(array){this.x=array[0];this.y=array[1];return this},toArray:function(){return[this.x,this.y]},clone:function(){return new THREE.Vector2(this.x,this.y)}};THREE.Vector3=function(x,y,z){this.x=x||0;this.y=y||0;this.z=z||0};THREE.Vector3.prototype={constructor:THREE.Vector3,set:function(x,y,z){this.x=x;this.y=y;this.z=z;return this},setX:function(x){this.x=x;return this},setY:function(y){this.y=y;return this},setZ:function(z){this.z=z;return this},setComponent:function(index,value){switch(index){case 0:this.x=value;break;case 1:this.y=value;break;case 2:this.z=value;break;default:throw new Error("index is out of range: "+index)}},getComponent:function(index){switch(index){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+index)}},copy:function(v){this.x=v.x;this.y=v.y;this.z=v.z;return this},add:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector3's .add() now only accepts one argument. Use .addVectors( a, b ) instead.");return this.addVectors(v,w)}this.x+=v.x;this.y+=v.y;this.z+=v.z;return this},addScalar:function(s){this.x+=s;this.y+=s;this.z+=s;return this},addVectors:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;return this},sub:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector3's .sub() now only accepts one argument. Use .subVectors( a, b ) instead.");return this.subVectors(v,w)}this.x-=v.x;this.y-=v.y;this.z-=v.z;return this},subVectors:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;return this},multiply:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector3's .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead.");return this.multiplyVectors(v,w)}this.x*=v.x;this.y*=v.y;this.z*=v.z;return this},multiplyScalar:function(s){this.x*=s;this.y*=s;this.z*=s;return this},multiplyVectors:function(a,b){this.x=a.x*b.x;this.y=a.y*b.y;this.z=a.z*b.z;return this},applyMatrix3:function(m){var x=this.x;var y=this.y;var z=this.z;var e=m.elements;this.x=e[0]*x+e[3]*y+e[6]*z;this.y=e[1]*x+e[4]*y+e[7]*z;this.z=e[2]*x+e[5]*y+e[8]*z;return this},applyMatrix4:function(m){var x=this.x,y=this.y,z=this.z;var e=m.elements;this.x=e[0]*x+e[4]*y+e[8]*z+e[12];this.y=e[1]*x+e[5]*y+e[9]*z+e[13];this.z=e[2]*x+e[6]*y+e[10]*z+e[14];return this},applyProjection:function(m){var x=this.x,y=this.y,z=this.z;var e=m.elements;var d=1/(e[3]*x+e[7]*y+e[11]*z+e[15]);this.x=(e[0]*x+e[4]*y+e[8]*z+e[12])*d;this.y=(e[1]*x+e[5]*y+e[9]*z+e[13])*d;this.z=(e[2]*x+e[6]*y+e[10]*z+e[14])*d;return this},applyQuaternion:function(q){var x=this.x;var y=this.y;var z=this.z;var qx=q.x;var qy=q.y;var qz=q.z;var qw=q.w;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;this.x=ix*qw+iw*-qx+iy*-qz-iz*-qy;this.y=iy*qw+iw*-qy+iz*-qx-ix*-qz;this.z=iz*qw+iw*-qz+ix*-qy-iy*-qx;return this},transformDirection:function(m){var x=this.x,y=this.y,z=this.z;var e=m.elements;this.x=e[0]*x+e[4]*y+e[8]*z;this.y=e[1]*x+e[5]*y+e[9]*z;this.z=e[2]*x+e[6]*y+e[10]*z;this.normalize();return this},divide:function(v){this.x/=v.x;this.y/=v.y;this.z/=v.z;return this},divideScalar:function(s){if(s!==0){this.x/=s;this.y/=s;this.z/=s}else{this.x=0;this.y=0;this.z=0}return this},min:function(v){if(this.x>v.x){this.x=v.x}if(this.y>v.y){this.y=v.y}if(this.z>v.z){this.z=v.z}return this},max:function(v){if(this.x<v.x){this.x=v.x}if(this.y<v.y){this.y=v.y}if(this.z<v.z){this.z=v.z}return this},clamp:function(min,max){if(this.x<min.x){this.x=min.x}else if(this.x>max.x){this.x=max.x}if(this.y<min.y){this.y=min.y}else if(this.y>max.y){this.y=max.y}if(this.z<min.z){this.z=min.z}else if(this.z>max.z){this.z=max.z}return this},negate:function(){return this.multiplyScalar(-1)},dot:function(v){return this.x*v.x+this.y*v.y+this.z*v.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(l){var oldLength=this.length();if(oldLength!==0&&l!==oldLength){this.multiplyScalar(l/oldLength)}return this},lerp:function(v,alpha){this.x+=(v.x-this.x)*alpha;this.y+=(v.y-this.y)*alpha;this.z+=(v.z-this.z)*alpha;return this},cross:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector3's .cross() now only accepts one argument. Use .crossVectors( a, b ) instead.");return this.crossVectors(v,w)}var x=this.x,y=this.y,z=this.z;this.x=y*v.z-z*v.y;this.y=z*v.x-x*v.z;this.z=x*v.y-y*v.x;return this},crossVectors:function(a,b){this.x=a.y*b.z-a.z*b.y;this.y=a.z*b.x-a.x*b.z;this.z=a.x*b.y-a.y*b.x;return this},angleTo:function(v){var theta=this.dot(v)/(this.length()*v.length());return Math.acos(THREE.Math.clamp(theta,-1,1))},distanceTo:function(v){return Math.sqrt(this.distanceToSquared(v))},distanceToSquared:function(v){var dx=this.x-v.x;var dy=this.y-v.y;var dz=this.z-v.z;return dx*dx+dy*dy+dz*dz},setEulerFromRotationMatrix:function(m,order){function clamp(x){return Math.min(Math.max(x,-1),1)}var te=m.elements;var m11=te[0],m12=te[4],m13=te[8];var m21=te[1],m22=te[5],m23=te[9];var m31=te[2],m32=te[6],m33=te[10];if(order===undefined||order==="XYZ"){this.y=Math.asin(clamp(m13));if(Math.abs(m13)<.99999){this.x=Math.atan2(-m23,m33);this.z=Math.atan2(-m12,m11)}else{this.x=Math.atan2(m32,m22);this.z=0}}else if(order==="YXZ"){this.x=Math.asin(-clamp(m23));if(Math.abs(m23)<.99999){this.y=Math.atan2(m13,m33);this.z=Math.atan2(m21,m22)}else{this.y=Math.atan2(-m31,m11);this.z=0}}else if(order==="ZXY"){this.x=Math.asin(clamp(m32));if(Math.abs(m32)<.99999){this.y=Math.atan2(-m31,m33);this.z=Math.atan2(-m12,m22)}else{this.y=0;this.z=Math.atan2(m21,m11)}}else if(order==="ZYX"){this.y=Math.asin(-clamp(m31));if(Math.abs(m31)<.99999){this.x=Math.atan2(m32,m33);this.z=Math.atan2(m21,m11)}else{this.x=0;this.z=Math.atan2(-m12,m22)}}else if(order==="YZX"){this.z=Math.asin(clamp(m21));if(Math.abs(m21)<.99999){this.x=Math.atan2(-m23,m22);this.y=Math.atan2(-m31,m11)}else{this.x=0;this.y=Math.atan2(m13,m33)}}else if(order==="XZY"){this.z=Math.asin(-clamp(m12));if(Math.abs(m12)<.99999){this.x=Math.atan2(m32,m22);this.y=Math.atan2(m13,m11)}else{this.x=Math.atan2(-m23,m33);this.y=0}}return this},setEulerFromQuaternion:function(q,order){function clamp(x){return Math.min(Math.max(x,-1),1)}var sqx=q.x*q.x;var sqy=q.y*q.y;var sqz=q.z*q.z;var sqw=q.w*q.w;if(order===undefined||order==="XYZ"){this.x=Math.atan2(2*(q.x*q.w-q.y*q.z),sqw-sqx-sqy+sqz);this.y=Math.asin(clamp(2*(q.x*q.z+q.y*q.w)));this.z=Math.atan2(2*(q.z*q.w-q.x*q.y),sqw+sqx-sqy-sqz)}else if(order==="YXZ"){this.x=Math.asin(clamp(2*(q.x*q.w-q.y*q.z)));this.y=Math.atan2(2*(q.x*q.z+q.y*q.w),sqw-sqx-sqy+sqz);this.z=Math.atan2(2*(q.x*q.y+q.z*q.w),sqw-sqx+sqy-sqz)}else if(order==="ZXY"){this.x=Math.asin(clamp(2*(q.x*q.w+q.y*q.z)));this.y=Math.atan2(2*(q.y*q.w-q.z*q.x),sqw-sqx-sqy+sqz);this.z=Math.atan2(2*(q.z*q.w-q.x*q.y),sqw-sqx+sqy-sqz)}else if(order==="ZYX"){this.x=Math.atan2(2*(q.x*q.w+q.z*q.y),sqw-sqx-sqy+sqz);this.y=Math.asin(clamp(2*(q.y*q.w-q.x*q.z)));this.z=Math.atan2(2*(q.x*q.y+q.z*q.w),sqw+sqx-sqy-sqz)}else if(order==="YZX"){this.x=Math.atan2(2*(q.x*q.w-q.z*q.y),sqw-sqx+sqy-sqz);this.y=Math.atan2(2*(q.y*q.w-q.x*q.z),sqw+sqx-sqy-sqz);this.z=Math.asin(clamp(2*(q.x*q.y+q.z*q.w)))}else if(order==="XZY"){this.x=Math.atan2(2*(q.x*q.w+q.y*q.z),sqw-sqx+sqy-sqz);this.y=Math.atan2(2*(q.x*q.z+q.y*q.w),sqw+sqx-sqy-sqz);this.z=Math.asin(clamp(2*(q.z*q.w-q.x*q.y)))}return this},getPositionFromMatrix:function(m){this.x=m.elements[12];this.y=m.elements[13];this.z=m.elements[14];return this},getScaleFromMatrix:function(m){var sx=this.set(m.elements[0],m.elements[1],m.elements[2]).length();var sy=this.set(m.elements[4],m.elements[5],m.elements[6]).length();var sz=this.set(m.elements[8],m.elements[9],m.elements[10]).length();this.x=sx;this.y=sy;this.z=sz;return this},getColumnFromMatrix:function(index,matrix){var offset=index*4;var me=matrix.elements;this.x=me[offset];this.y=me[offset+1];this.z=me[offset+2];return this},equals:function(v){return v.x===this.x&&v.y===this.y&&v.z===this.z},fromArray:function(array){this.x=array[0];this.y=array[1];this.z=array[2];return this},toArray:function(){return[this.x,this.y,this.z]},clone:function(){return new THREE.Vector3(this.x,this.y,this.z)}};THREE.extend(THREE.Vector3.prototype,{applyEuler:function(){var q1=new THREE.Quaternion;return function(v,eulerOrder){var quaternion=q1.setFromEuler(v,eulerOrder);this.applyQuaternion(quaternion);return this}}(),applyAxisAngle:function(){var q1=new THREE.Quaternion;return function(axis,angle){var quaternion=q1.setFromAxisAngle(axis,angle);this.applyQuaternion(quaternion);return this}}(),projectOnVector:function(){var v1=new THREE.Vector3;return function(vector){v1.copy(vector).normalize();var d=this.dot(v1);return this.copy(v1).multiplyScalar(d)}}(),projectOnPlane:function(){var v1=new THREE.Vector3;return function(planeNormal){v1.copy(this).projectOnVector(planeNormal);return this.sub(v1)}}(),reflect:function(){var v1=new THREE.Vector3;return function(vector){v1.copy(this).projectOnVector(vector).multiplyScalar(2);return this.subVectors(v1,this)}}()});THREE.Vector4=function(x,y,z,w){this.x=x||0;this.y=y||0;this.z=z||0;this.w=w!==undefined?w:1};THREE.Vector4.prototype={constructor:THREE.Vector4,set:function(x,y,z,w){this.x=x;this.y=y;this.z=z;this.w=w;return this},setX:function(x){this.x=x;return this},setY:function(y){this.y=y;return this},setZ:function(z){this.z=z;return this},setW:function(w){this.w=w;return this},setComponent:function(index,value){switch(index){case 0:this.x=value;break;case 1:this.y=value;break;case 2:this.z=value;break;case 3:this.w=value;break;default:throw new Error("index is out of range: "+index)}},getComponent:function(index){switch(index){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+index)}},copy:function(v){this.x=v.x;this.y=v.y;this.z=v.z;this.w=v.w!==undefined?v.w:1;return this},add:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector4's .add() now only accepts one argument. Use .addVectors( a, b ) instead.");return this.addVectors(v,w)}this.x+=v.x;this.y+=v.y;this.z+=v.z;this.w+=v.w;return this},addScalar:function(s){this.x+=s;this.y+=s;this.z+=s;this.w+=s;return this},addVectors:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;this.w=a.w+b.w;return this},sub:function(v,w){if(w!==undefined){console.warn("DEPRECATED: Vector4's .sub() now only accepts one argument. Use .subVectors( a, b ) instead.");return this.subVectors(v,w)}this.x-=v.x;this.y-=v.y;this.z-=v.z;this.w-=v.w;return this},subVectors:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;this.w=a.w-b.w;return this},multiplyScalar:function(s){this.x*=s;this.y*=s;this.z*=s;this.w*=s;return this},applyMatrix4:function(m){var x=this.x;var y=this.y;var z=this.z;var w=this.w;var e=m.elements;this.x=e[0]*x+e[4]*y+e[8]*z+e[12]*w;this.y=e[1]*x+e[5]*y+e[9]*z+e[13]*w;this.z=e[2]*x+e[6]*y+e[10]*z+e[14]*w;this.w=e[3]*x+e[7]*y+e[11]*z+e[15]*w;return this},divideScalar:function(s){if(s!==0){this.x/=s;this.y/=s;this.z/=s;this.w/=s}else{this.x=0;this.y=0;this.z=0;this.w=1}return this},setAxisAngleFromQuaternion:function(q){this.w=2*Math.acos(q.w);var s=Math.sqrt(1-q.w*q.w);if(s<1e-4){this.x=1;this.y=0;this.z=0}else{this.x=q.x/s;this.y=q.y/s;this.z=q.z/s}return this},setAxisAngleFromRotationMatrix:function(m){var angle,x,y,z,epsilon=.01,epsilon2=.1,te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10];if(Math.abs(m12-m21)<epsilon&&Math.abs(m13-m31)<epsilon&&Math.abs(m23-m32)<epsilon){if(Math.abs(m12+m21)<epsilon2&&Math.abs(m13+m31)<epsilon2&&Math.abs(m23+m32)<epsilon2&&Math.abs(m11+m22+m33-3)<epsilon2){this.set(1,0,0,0);return this}angle=Math.PI;var xx=(m11+1)/2;var yy=(m22+1)/2;var zz=(m33+1)/2;var xy=(m12+m21)/4;var xz=(m13+m31)/4;var yz=(m23+m32)/4;if(xx>yy&&xx>zz){if(xx<epsilon){x=0;y=.707106781;z=.707106781}else{x=Math.sqrt(xx);y=xy/x;z=xz/x}}else if(yy>zz){if(yy<epsilon){x=.707106781;y=0;z=.707106781}else{y=Math.sqrt(yy);x=xy/y;z=yz/y}}else{if(zz<epsilon){x=.707106781;y=.707106781;z=0}else{z=Math.sqrt(zz);x=xz/z;y=yz/z}}this.set(x,y,z,angle);return this}var s=Math.sqrt((m32-m23)*(m32-m23)+(m13-m31)*(m13-m31)+(m21-m12)*(m21-m12));if(Math.abs(s)<.001)s=1;this.x=(m32-m23)/s;this.y=(m13-m31)/s;this.z=(m21-m12)/s;this.w=Math.acos((m11+m22+m33-1)/2);return this},min:function(v){if(this.x>v.x){this.x=v.x}if(this.y>v.y){this.y=v.y}if(this.z>v.z){this.z=v.z}if(this.w>v.w){this.w=v.w}return this},max:function(v){if(this.x<v.x){this.x=v.x}if(this.y<v.y){this.y=v.y}if(this.z<v.z){this.z=v.z}if(this.w<v.w){this.w=v.w}return this},clamp:function(min,max){if(this.x<min.x){this.x=min.x}else if(this.x>max.x){this.x=max.x}if(this.y<min.y){this.y=min.y}else if(this.y>max.y){this.y=max.y}if(this.z<min.z){this.z=min.z}else if(this.z>max.z){this.z=max.z}if(this.w<min.w){this.w=min.w}else if(this.w>max.w){this.w=max.w}return this},negate:function(){return this.multiplyScalar(-1)},dot:function(v){return this.x*v.x+this.y*v.y+this.z*v.z+this.w*v.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(l){var oldLength=this.length();if(oldLength!==0&&l!==oldLength){this.multiplyScalar(l/oldLength)}return this},lerp:function(v,alpha){this.x+=(v.x-this.x)*alpha;this.y+=(v.y-this.y)*alpha;this.z+=(v.z-this.z)*alpha;this.w+=(v.w-this.w)*alpha;return this},equals:function(v){return v.x===this.x&&v.y===this.y&&v.z===this.z&&v.w===this.w},fromArray:function(array){this.x=array[0];this.y=array[1];this.z=array[2];this.w=array[3];return this},toArray:function(){return[this.x,this.y,this.z,this.w]},clone:function(){return new THREE.Vector4(this.x,this.y,this.z,this.w)}};THREE.Line3=function(start,end){this.start=start!==undefined?start:new THREE.Vector3;this.end=end!==undefined?end:new THREE.Vector3};THREE.Line3.prototype={constructor:THREE.Line3,set:function(start,end){this.start.copy(start);this.end.copy(end);return this},copy:function(line){this.start.copy(line.start);this.end.copy(line.end);return this},center:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(t,optionalTarget){var result=optionalTarget||new THREE.Vector3;return this.delta(result).multiplyScalar(t).add(this.start)},closestPointToPointParameter:function(){var startP=new THREE.Vector3;var startEnd=new THREE.Vector3;return function(point,clampToLine){startP.subVectors(point,this.start);startEnd.subVectors(this.end,this.start);var startEnd2=startEnd.dot(startEnd);var startEnd_startP=startEnd.dot(startP);var t=startEnd_startP/startEnd2;if(clampToLine){t=THREE.Math.clamp(t,0,1)}return t}}(),closestPointToPoint:function(point,clampToLine,optionalTarget){var t=this.closestPointToPointParameter(point,clampToLine);var result=optionalTarget||new THREE.Vector3;return this.delta(result).multiplyScalar(t).add(this.start)},applyMatrix4:function(matrix){this.start.applyMatrix4(matrix);this.end.applyMatrix4(matrix);return this},equals:function(line){return line.start.equals(this.start)&&line.end.equals(this.end)},clone:function(){return(new THREE.Line3).copy(this)}};THREE.Box2=function(min,max){this.min=min!==undefined?min:new THREE.Vector2(Infinity,Infinity);this.max=max!==undefined?max:new THREE.Vector2(-Infinity,-Infinity)};THREE.Box2.prototype={constructor:THREE.Box2,set:function(min,max){this.min.copy(min);this.max.copy(max);return this},setFromPoints:function(points){if(points.length>0){var point=points[0];this.min.copy(point);this.max.copy(point);for(var i=1,il=points.length;i<il;i++){point=points[i];if(point.x<this.min.x){this.min.x=point.x}else if(point.x>this.max.x){this.max.x=point.x}if(point.y<this.min.y){this.min.y=point.y}else if(point.y>this.max.y){this.max.y=point.y}}}else{this.makeEmpty()}return this},setFromCenterAndSize:function(){var v1=new THREE.Vector2;return function(center,size){var halfSize=v1.copy(size).multiplyScalar(.5);this.min.copy(center).sub(halfSize);this.max.copy(center).add(halfSize);return this}}(),copy:function(box){this.min.copy(box.min);this.max.copy(box.max);return this},makeEmpty:function(){this.min.x=this.min.y=Infinity;this.max.x=this.max.y=-Infinity;return this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},center:function(optionalTarget){var result=optionalTarget||new THREE.Vector2;return result.addVectors(this.min,this.max).multiplyScalar(.5)},size:function(optionalTarget){var result=optionalTarget||new THREE.Vector2;return result.subVectors(this.max,this.min)},expandByPoint:function(point){this.min.min(point);this.max.max(point);return this},expandByVector:function(vector){this.min.sub(vector);this.max.add(vector);return this},expandByScalar:function(scalar){this.min.addScalar(-scalar);this.max.addScalar(scalar);return this},containsPoint:function(point){if(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y){return false}return true},containsBox:function(box){if(this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y){return true}return false},getParameter:function(point){return new THREE.Vector2((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(box){if(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y){return false}return true},clampPoint:function(point,optionalTarget){var result=optionalTarget||new THREE.Vector2;return result.copy(point).clamp(this.min,this.max)},distanceToPoint:function(){var v1=new THREE.Vector2;return function(point){var clampedPoint=v1.copy(point).clamp(this.min,this.max);return clampedPoint.sub(point).length()}}(),intersect:function(box){this.min.max(box.min);this.max.min(box.max);return this},union:function(box){this.min.min(box.min);this.max.max(box.max);return this},translate:function(offset){this.min.add(offset);this.max.add(offset);return this},equals:function(box){return box.min.equals(this.min)&&box.max.equals(this.max)},clone:function(){return(new THREE.Box2).copy(this)}};THREE.Box3=function(min,max){this.min=min!==undefined?min:new THREE.Vector3(Infinity,Infinity,Infinity);this.max=max!==undefined?max:new THREE.Vector3(-Infinity,-Infinity,-Infinity)};THREE.Box3.prototype={constructor:THREE.Box3,set:function(min,max){this.min.copy(min);this.max.copy(max);return this},setFromPoints:function(points){if(points.length>0){var point=points[0];this.min.copy(point);this.max.copy(point);for(var i=1,il=points.length;i<il;i++){point=points[i];if(point.x<this.min.x){this.min.x=point.x}else if(point.x>this.max.x){this.max.x=point.x}if(point.y<this.min.y){this.min.y=point.y}else if(point.y>this.max.y){this.max.y=point.y}if(point.z<this.min.z){this.min.z=point.z}else if(point.z>this.max.z){this.max.z=point.z}}}else{this.makeEmpty()}return this},setFromCenterAndSize:function(){var v1=new THREE.Vector3;return function(center,size){var halfSize=v1.copy(size).multiplyScalar(.5);this.min.copy(center).sub(halfSize);this.max.copy(center).add(halfSize);return this}}(),copy:function(box){this.min.copy(box.min);this.max.copy(box.max);return this},makeEmpty:function(){this.min.x=this.min.y=this.min.z=Infinity;this.max.x=this.max.y=this.max.z=-Infinity;return this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},center:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.addVectors(this.min,this.max).multiplyScalar(.5)},size:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.subVectors(this.max,this.min)},expandByPoint:function(point){this.min.min(point);this.max.max(point);return this},expandByVector:function(vector){this.min.sub(vector);this.max.add(vector);return this},expandByScalar:function(scalar){this.min.addScalar(-scalar);this.max.addScalar(scalar);return this},containsPoint:function(point){if(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y||point.z<this.min.z||point.z>this.max.z){return false}return true},containsBox:function(box){if(this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y&&this.min.z<=box.min.z&&box.max.z<=this.max.z){return true}return false},getParameter:function(point){return new THREE.Vector3((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y),(point.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(box){if(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y||box.max.z<this.min.z||box.min.z>this.max.z){return false}return true},clampPoint:function(point,optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.copy(point).clamp(this.min,this.max)},distanceToPoint:function(){var v1=new THREE.Vector3;return function(point){var clampedPoint=v1.copy(point).clamp(this.min,this.max);return clampedPoint.sub(point).length()}}(),getBoundingSphere:function(){var v1=new THREE.Vector3;return function(optionalTarget){var result=optionalTarget||new THREE.Sphere;result.center=this.center();result.radius=this.size(v1).length()*.5;return result}}(),intersect:function(box){this.min.max(box.min);this.max.min(box.max);return this},union:function(box){this.min.min(box.min);this.max.max(box.max);return this},applyMatrix4:function(){var points=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];return function(matrix){points[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(matrix);points[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(matrix);points[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(matrix);points[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(matrix);points[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(matrix);points[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(matrix);points[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(matrix);points[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(matrix);this.makeEmpty();this.setFromPoints(points);return this}}(),translate:function(offset){this.min.add(offset);this.max.add(offset);return this},equals:function(box){return box.min.equals(this.min)&&box.max.equals(this.max)},clone:function(){return(new THREE.Box3).copy(this)}};THREE.Matrix3=function(n11,n12,n13,n21,n22,n23,n31,n32,n33){this.elements=new Float32Array(9);this.set(n11!==undefined?n11:1,n12||0,n13||0,n21||0,n22!==undefined?n22:1,n23||0,n31||0,n32||0,n33!==undefined?n33:1)};THREE.Matrix3.prototype={constructor:THREE.Matrix3,set:function(n11,n12,n13,n21,n22,n23,n31,n32,n33){var te=this.elements;te[0]=n11;te[3]=n12;te[6]=n13;te[1]=n21;te[4]=n22;te[7]=n23;te[2]=n31;te[5]=n32;te[8]=n33;return this},identity:function(){this.set(1,0,0,0,1,0,0,0,1);return this},copy:function(m){var me=m.elements;this.set(me[0],me[3],me[6],me[1],me[4],me[7],me[2],me[5],me[8]);return this},multiplyVector3:function(vector){console.warn("DEPRECATED: Matrix3's .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead.");return vector.applyMatrix3(this)},multiplyVector3Array:function(){var v1=new THREE.Vector3;return function(a){for(var i=0,il=a.length;i<il;i+=3){v1.x=a[i];v1.y=a[i+1];v1.z=a[i+2];v1.applyMatrix3(this);a[i]=v1.x;a[i+1]=v1.y;a[i+2]=v1.z}return a}}(),multiplyScalar:function(s){var te=this.elements;te[0]*=s;te[3]*=s;te[6]*=s;te[1]*=s;te[4]*=s;te[7]*=s;te[2]*=s;te[5]*=s;te[8]*=s;return this},determinant:function(){var te=this.elements;var a=te[0],b=te[1],c=te[2],d=te[3],e=te[4],f=te[5],g=te[6],h=te[7],i=te[8];return a*e*i-a*f*h-b*d*i+b*f*g+c*d*h-c*e*g},getInverse:function(matrix,throwOnInvertible){var me=matrix.elements;var te=this.elements;te[0]=me[10]*me[5]-me[6]*me[9];te[1]=-me[10]*me[1]+me[2]*me[9];te[2]=me[6]*me[1]-me[2]*me[5];te[3]=-me[10]*me[4]+me[6]*me[8];te[4]=me[10]*me[0]-me[2]*me[8];te[5]=-me[6]*me[0]+me[2]*me[4];te[6]=me[9]*me[4]-me[5]*me[8];te[7]=-me[9]*me[0]+me[1]*me[8];te[8]=me[5]*me[0]-me[1]*me[4];var det=me[0]*te[0]+me[1]*te[3]+me[2]*te[6];if(det===0){var msg="Matrix3.getInverse(): can't invert matrix, determinant is 0";if(throwOnInvertible||false){throw new Error(msg)}else{console.warn(msg)}this.identity();return this}this.multiplyScalar(1/det);return this},transpose:function(){var tmp,m=this.elements;tmp=m[1];m[1]=m[3];m[3]=tmp;tmp=m[2];m[2]=m[6];m[6]=tmp;tmp=m[5];m[5]=m[7];m[7]=tmp;return this},getNormalMatrix:function(m){this.getInverse(m).transpose();return this},transposeIntoArray:function(r){var m=this.elements;r[0]=m[0];r[1]=m[3];r[2]=m[6];r[3]=m[1];r[4]=m[4];r[5]=m[7];r[6]=m[2];r[7]=m[5];r[8]=m[8];return this},clone:function(){var te=this.elements;return new THREE.Matrix3(te[0],te[3],te[6],te[1],te[4],te[7],te[2],te[5],te[8])}};THREE.Matrix4=function(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){var te=this.elements=new Float32Array(16);te[0]=n11!==undefined?n11:1;te[4]=n12||0;te[8]=n13||0;te[12]=n14||0;te[1]=n21||0;te[5]=n22!==undefined?n22:1;te[9]=n23||0;te[13]=n24||0;te[2]=n31||0;te[6]=n32||0;te[10]=n33!==undefined?n33:1;te[14]=n34||0;te[3]=n41||0;te[7]=n42||0;te[11]=n43||0;te[15]=n44!==undefined?n44:1};THREE.Matrix4.prototype={constructor:THREE.Matrix4,set:function(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){var te=this.elements;te[0]=n11;te[4]=n12;te[8]=n13;te[12]=n14;te[1]=n21;te[5]=n22;te[9]=n23;te[13]=n24;te[2]=n31;te[6]=n32;te[10]=n33;te[14]=n34;te[3]=n41;te[7]=n42;te[11]=n43;te[15]=n44;return this},identity:function(){this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return this},copy:function(m){var me=m.elements;this.set(me[0],me[4],me[8],me[12],me[1],me[5],me[9],me[13],me[2],me[6],me[10],me[14],me[3],me[7],me[11],me[15]);return this},extractPosition:function(m){console.warn("DEPRECATED: Matrix4's .extractPosition() has been renamed to .copyPosition().");return this.copyPosition(m)},copyPosition:function(m){var te=this.elements;var me=m.elements;te[12]=me[12];te[13]=me[13];te[14]=me[14];return this},extractRotation:function(){var v1=new THREE.Vector3;return function(m){var te=this.elements;var me=m.elements;var scaleX=1/v1.set(me[0],me[1],me[2]).length();var scaleY=1/v1.set(me[4],me[5],me[6]).length();var scaleZ=1/v1.set(me[8],me[9],me[10]).length();te[0]=me[0]*scaleX;te[1]=me[1]*scaleX;te[2]=me[2]*scaleX;te[4]=me[4]*scaleY;te[5]=me[5]*scaleY;te[6]=me[6]*scaleY;te[8]=me[8]*scaleZ;te[9]=me[9]*scaleZ;te[10]=me[10]*scaleZ;return this}}(),setRotationFromEuler:function(v,order){console.warn("DEPRECATED: Matrix4's .setRotationFromEuler() has been deprecated in favor of makeRotationFromEuler.  Please update your code.");return this.makeRotationFromEuler(v,order)},makeRotationFromEuler:function(v,order){var te=this.elements;var x=v.x,y=v.y,z=v.z;var a=Math.cos(x),b=Math.sin(x);var c=Math.cos(y),d=Math.sin(y);var e=Math.cos(z),f=Math.sin(z);if(order===undefined||order==="XYZ"){var ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e;te[4]=-c*f;te[8]=d;te[1]=af+be*d;te[5]=ae-bf*d;te[9]=-b*c;te[2]=bf-ae*d;te[6]=be+af*d;te[10]=a*c}else if(order==="YXZ"){var ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce+df*b;te[4]=de*b-cf;te[8]=a*d;te[1]=a*f;te[5]=a*e;te[9]=-b;te[2]=cf*b-de;te[6]=df+ce*b;te[10]=a*c}else if(order==="ZXY"){var ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce-df*b;te[4]=-a*f;te[8]=de+cf*b;te[1]=cf+de*b;te[5]=a*e;te[9]=df-ce*b;te[2]=-a*d;te[6]=b;te[10]=a*c}else if(order==="ZYX"){var ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e;te[4]=be*d-af;te[8]=ae*d+bf;te[1]=c*f;te[5]=bf*d+ae;te[9]=af*d-be;te[2]=-d;te[6]=b*c;te[10]=a*c}else if(order==="YZX"){var ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e;te[4]=bd-ac*f;te[8]=bc*f+ad;te[1]=f;te[5]=a*e;te[9]=-b*e;te[2]=-d*e;te[6]=ad*f+bc;te[10]=ac-bd*f}else if(order==="XZY"){var ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e;te[4]=-f;te[8]=d*e;te[1]=ac*f+bd;te[5]=a*e;te[9]=ad*f-bc;te[2]=bc*f-ad;te[6]=b*e;te[10]=bd*f+ac}te[3]=0;te[7]=0;te[11]=0;te[12]=0;te[13]=0;te[14]=0;te[15]=1;return this},setRotationFromQuaternion:function(q){console.warn("DEPRECATED: Matrix4's .setRotationFromQuaternion() has been deprecated in favor of makeRotationFromQuaternion.  Please update your code.");return this.makeRotationFromQuaternion(q)},makeRotationFromQuaternion:function(q){var te=this.elements;var x=q.x,y=q.y,z=q.z,w=q.w;var x2=x+x,y2=y+y,z2=z+z;var xx=x*x2,xy=x*y2,xz=x*z2;var yy=y*y2,yz=y*z2,zz=z*z2;var wx=w*x2,wy=w*y2,wz=w*z2;te[0]=1-(yy+zz);te[4]=xy-wz;te[8]=xz+wy;te[1]=xy+wz;te[5]=1-(xx+zz);te[9]=yz-wx;te[2]=xz-wy;te[6]=yz+wx;te[10]=1-(xx+yy);te[3]=0;te[7]=0;te[11]=0;te[12]=0;te[13]=0;te[14]=0;te[15]=1;return this},lookAt:function(){var x=new THREE.Vector3;var y=new THREE.Vector3;var z=new THREE.Vector3;return function(eye,target,up){var te=this.elements;z.subVectors(eye,target).normalize();if(z.length()===0){z.z=1}x.crossVectors(up,z).normalize();if(x.length()===0){z.x+=1e-4;x.crossVectors(up,z).normalize()}y.crossVectors(z,x);te[0]=x.x;te[4]=y.x;te[8]=z.x;te[1]=x.y;te[5]=y.y;te[9]=z.y;te[2]=x.z;te[6]=y.z;te[10]=z.z;return this}}(),multiply:function(m,n){if(n!==undefined){console.warn("DEPRECATED: Matrix4's .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead.");return this.multiplyMatrices(m,n)}return this.multiplyMatrices(this,m)},multiplyMatrices:function(a,b){var ae=a.elements;var be=b.elements;var te=this.elements;var a11=ae[0],a12=ae[4],a13=ae[8],a14=ae[12];var a21=ae[1],a22=ae[5],a23=ae[9],a24=ae[13];var a31=ae[2],a32=ae[6],a33=ae[10],a34=ae[14];var a41=ae[3],a42=ae[7],a43=ae[11],a44=ae[15];var b11=be[0],b12=be[4],b13=be[8],b14=be[12];var b21=be[1],b22=be[5],b23=be[9],b24=be[13];var b31=be[2],b32=be[6],b33=be[10],b34=be[14];var b41=be[3],b42=be[7],b43=be[11],b44=be[15];te[0]=a11*b11+a12*b21+a13*b31+a14*b41;te[4]=a11*b12+a12*b22+a13*b32+a14*b42;te[8]=a11*b13+a12*b23+a13*b33+a14*b43;te[12]=a11*b14+a12*b24+a13*b34+a14*b44;te[1]=a21*b11+a22*b21+a23*b31+a24*b41;te[5]=a21*b12+a22*b22+a23*b32+a24*b42;te[9]=a21*b13+a22*b23+a23*b33+a24*b43;te[13]=a21*b14+a22*b24+a23*b34+a24*b44;te[2]=a31*b11+a32*b21+a33*b31+a34*b41;te[6]=a31*b12+a32*b22+a33*b32+a34*b42;te[10]=a31*b13+a32*b23+a33*b33+a34*b43;te[14]=a31*b14+a32*b24+a33*b34+a34*b44;te[3]=a41*b11+a42*b21+a43*b31+a44*b41;te[7]=a41*b12+a42*b22+a43*b32+a44*b42;te[11]=a41*b13+a42*b23+a43*b33+a44*b43;te[15]=a41*b14+a42*b24+a43*b34+a44*b44;return this},multiplyToArray:function(a,b,r){var te=this.elements;this.multiplyMatrices(a,b);r[0]=te[0];r[1]=te[1];r[2]=te[2];r[3]=te[3];r[4]=te[4];r[5]=te[5];r[6]=te[6];r[7]=te[7];r[8]=te[8];r[9]=te[9];r[10]=te[10];r[11]=te[11];
r[12]=te[12];r[13]=te[13];r[14]=te[14];r[15]=te[15];return this},multiplyScalar:function(s){var te=this.elements;te[0]*=s;te[4]*=s;te[8]*=s;te[12]*=s;te[1]*=s;te[5]*=s;te[9]*=s;te[13]*=s;te[2]*=s;te[6]*=s;te[10]*=s;te[14]*=s;te[3]*=s;te[7]*=s;te[11]*=s;te[15]*=s;return this},multiplyVector3:function(vector){console.warn("DEPRECATED: Matrix4's .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead.");return vector.applyProjection(this)},multiplyVector4:function(vector){console.warn("DEPRECATED: Matrix4's .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead.");return vector.applyMatrix4(this)},multiplyVector3Array:function(){var v1=new THREE.Vector3;return function(a){for(var i=0,il=a.length;i<il;i+=3){v1.x=a[i];v1.y=a[i+1];v1.z=a[i+2];v1.applyProjection(this);a[i]=v1.x;a[i+1]=v1.y;a[i+2]=v1.z}return a}}(),rotateAxis:function(v){console.warn("DEPRECATED: Matrix4's .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead.");v.transformDirection(this)},crossVector:function(vector){console.warn("DEPRECATED: Matrix4's .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead.");return vector.applyMatrix4(this)},determinant:function(){var te=this.elements;var n11=te[0],n12=te[4],n13=te[8],n14=te[12];var n21=te[1],n22=te[5],n23=te[9],n24=te[13];var n31=te[2],n32=te[6],n33=te[10],n34=te[14];var n41=te[3],n42=te[7],n43=te[11],n44=te[15];return n41*(+n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34)+n42*(+n11*n23*n34-n11*n24*n33+n14*n21*n33-n13*n21*n34+n13*n24*n31-n14*n23*n31)+n43*(+n11*n24*n32-n11*n22*n34-n14*n21*n32+n12*n21*n34+n14*n22*n31-n12*n24*n31)+n44*(-n13*n22*n31-n11*n23*n32+n11*n22*n33+n13*n21*n32-n12*n21*n33+n12*n23*n31)},transpose:function(){var te=this.elements;var tmp;tmp=te[1];te[1]=te[4];te[4]=tmp;tmp=te[2];te[2]=te[8];te[8]=tmp;tmp=te[6];te[6]=te[9];te[9]=tmp;tmp=te[3];te[3]=te[12];te[12]=tmp;tmp=te[7];te[7]=te[13];te[13]=tmp;tmp=te[11];te[11]=te[14];te[14]=tmp;return this},flattenToArray:function(flat){var te=this.elements;flat[0]=te[0];flat[1]=te[1];flat[2]=te[2];flat[3]=te[3];flat[4]=te[4];flat[5]=te[5];flat[6]=te[6];flat[7]=te[7];flat[8]=te[8];flat[9]=te[9];flat[10]=te[10];flat[11]=te[11];flat[12]=te[12];flat[13]=te[13];flat[14]=te[14];flat[15]=te[15];return flat},flattenToArrayOffset:function(flat,offset){var te=this.elements;flat[offset]=te[0];flat[offset+1]=te[1];flat[offset+2]=te[2];flat[offset+3]=te[3];flat[offset+4]=te[4];flat[offset+5]=te[5];flat[offset+6]=te[6];flat[offset+7]=te[7];flat[offset+8]=te[8];flat[offset+9]=te[9];flat[offset+10]=te[10];flat[offset+11]=te[11];flat[offset+12]=te[12];flat[offset+13]=te[13];flat[offset+14]=te[14];flat[offset+15]=te[15];return flat},getPosition:function(){var v1=new THREE.Vector3;return function(){console.warn("DEPRECATED: Matrix4's .getPosition() has been removed. Use Vector3.getPositionFromMatrix( matrix ) instead.");var te=this.elements;return v1.set(te[12],te[13],te[14])}}(),setPosition:function(v){var te=this.elements;te[12]=v.x;te[13]=v.y;te[14]=v.z;return this},getInverse:function(m,throwOnInvertible){var te=this.elements;var me=m.elements;var n11=me[0],n12=me[4],n13=me[8],n14=me[12];var n21=me[1],n22=me[5],n23=me[9],n24=me[13];var n31=me[2],n32=me[6],n33=me[10],n34=me[14];var n41=me[3],n42=me[7],n43=me[11],n44=me[15];te[0]=n23*n34*n42-n24*n33*n42+n24*n32*n43-n22*n34*n43-n23*n32*n44+n22*n33*n44;te[4]=n14*n33*n42-n13*n34*n42-n14*n32*n43+n12*n34*n43+n13*n32*n44-n12*n33*n44;te[8]=n13*n24*n42-n14*n23*n42+n14*n22*n43-n12*n24*n43-n13*n22*n44+n12*n23*n44;te[12]=n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34;te[1]=n24*n33*n41-n23*n34*n41-n24*n31*n43+n21*n34*n43+n23*n31*n44-n21*n33*n44;te[5]=n13*n34*n41-n14*n33*n41+n14*n31*n43-n11*n34*n43-n13*n31*n44+n11*n33*n44;te[9]=n14*n23*n41-n13*n24*n41-n14*n21*n43+n11*n24*n43+n13*n21*n44-n11*n23*n44;te[13]=n13*n24*n31-n14*n23*n31+n14*n21*n33-n11*n24*n33-n13*n21*n34+n11*n23*n34;te[2]=n22*n34*n41-n24*n32*n41+n24*n31*n42-n21*n34*n42-n22*n31*n44+n21*n32*n44;te[6]=n14*n32*n41-n12*n34*n41-n14*n31*n42+n11*n34*n42+n12*n31*n44-n11*n32*n44;te[10]=n12*n24*n41-n14*n22*n41+n14*n21*n42-n11*n24*n42-n12*n21*n44+n11*n22*n44;te[14]=n14*n22*n31-n12*n24*n31-n14*n21*n32+n11*n24*n32+n12*n21*n34-n11*n22*n34;te[3]=n23*n32*n41-n22*n33*n41-n23*n31*n42+n21*n33*n42+n22*n31*n43-n21*n32*n43;te[7]=n12*n33*n41-n13*n32*n41+n13*n31*n42-n11*n33*n42-n12*n31*n43+n11*n32*n43;te[11]=n13*n22*n41-n12*n23*n41-n13*n21*n42+n11*n23*n42+n12*n21*n43-n11*n22*n43;te[15]=n12*n23*n31-n13*n22*n31+n13*n21*n32-n11*n23*n32-n12*n21*n33+n11*n22*n33;var det=n11*te[0]+n21*te[4]+n31*te[8]+n41*te[12];if(det==0){var msg="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(throwOnInvertible||false){throw new Error(msg)}else{console.warn(msg)}this.identity();return this}this.multiplyScalar(1/det);return this},translate:function(v){console.warn("DEPRECATED: Matrix4's .translate() has been removed.")},rotateX:function(angle){console.warn("DEPRECATED: Matrix4's .rotateX() has been removed.")},rotateY:function(angle){console.warn("DEPRECATED: Matrix4's .rotateY() has been removed.")},rotateZ:function(angle){console.warn("DEPRECATED: Matrix4's .rotateZ() has been removed.")},rotateByAxis:function(axis,angle){console.warn("DEPRECATED: Matrix4's .rotateByAxis() has been removed.")},scale:function(v){var te=this.elements;var x=v.x,y=v.y,z=v.z;te[0]*=x;te[4]*=y;te[8]*=z;te[1]*=x;te[5]*=y;te[9]*=z;te[2]*=x;te[6]*=y;te[10]*=z;te[3]*=x;te[7]*=y;te[11]*=z;return this},getMaxScaleOnAxis:function(){var te=this.elements;var scaleXSq=te[0]*te[0]+te[1]*te[1]+te[2]*te[2];var scaleYSq=te[4]*te[4]+te[5]*te[5]+te[6]*te[6];var scaleZSq=te[8]*te[8]+te[9]*te[9]+te[10]*te[10];return Math.sqrt(Math.max(scaleXSq,Math.max(scaleYSq,scaleZSq)))},makeTranslation:function(x,y,z){this.set(1,0,0,x,0,1,0,y,0,0,1,z,0,0,0,1);return this},makeRotationX:function(theta){var c=Math.cos(theta),s=Math.sin(theta);this.set(1,0,0,0,0,c,-s,0,0,s,c,0,0,0,0,1);return this},makeRotationY:function(theta){var c=Math.cos(theta),s=Math.sin(theta);this.set(c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1);return this},makeRotationZ:function(theta){var c=Math.cos(theta),s=Math.sin(theta);this.set(c,-s,0,0,s,c,0,0,0,0,1,0,0,0,0,1);return this},makeRotationAxis:function(axis,angle){var c=Math.cos(angle);var s=Math.sin(angle);var t=1-c;var x=axis.x,y=axis.y,z=axis.z;var tx=t*x,ty=t*y;this.set(tx*x+c,tx*y-s*z,tx*z+s*y,0,tx*y+s*z,ty*y+c,ty*z-s*x,0,tx*z-s*y,ty*z+s*x,t*z*z+c,0,0,0,0,1);return this},makeScale:function(x,y,z){this.set(x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1);return this},compose:function(position,quaternion,scale){console.warn("DEPRECATED: Matrix4's .compose() has been deprecated in favor of makeFromPositionQuaternionScale. Please update your code.");return this.makeFromPositionQuaternionScale(position,quaternion,scale)},makeFromPositionQuaternionScale:function(position,quaternion,scale){this.makeRotationFromQuaternion(quaternion);this.scale(scale);this.setPosition(position);return this},makeFromPositionEulerScale:function(position,rotation,eulerOrder,scale){this.makeRotationFromEuler(rotation,eulerOrder);this.scale(scale);this.setPosition(position);return this},makeFrustum:function(left,right,bottom,top,near,far){var te=this.elements;var x=2*near/(right-left);var y=2*near/(top-bottom);var a=(right+left)/(right-left);var b=(top+bottom)/(top-bottom);var c=-(far+near)/(far-near);var d=-2*far*near/(far-near);te[0]=x;te[4]=0;te[8]=a;te[12]=0;te[1]=0;te[5]=y;te[9]=b;te[13]=0;te[2]=0;te[6]=0;te[10]=c;te[14]=d;te[3]=0;te[7]=0;te[11]=-1;te[15]=0;return this},makePerspective:function(fov,aspect,near,far){var ymax=near*Math.tan(THREE.Math.degToRad(fov*.5));var ymin=-ymax;var xmin=ymin*aspect;var xmax=ymax*aspect;return this.makeFrustum(xmin,xmax,ymin,ymax,near,far)},makeOrthographic:function(left,right,top,bottom,near,far){var te=this.elements;var w=right-left;var h=top-bottom;var p=far-near;var x=(right+left)/w;var y=(top+bottom)/h;var z=(far+near)/p;te[0]=2/w;te[4]=0;te[8]=0;te[12]=-x;te[1]=0;te[5]=2/h;te[9]=0;te[13]=-y;te[2]=0;te[6]=0;te[10]=-2/p;te[14]=-z;te[3]=0;te[7]=0;te[11]=0;te[15]=1;return this},clone:function(){var te=this.elements;return new THREE.Matrix4(te[0],te[4],te[8],te[12],te[1],te[5],te[9],te[13],te[2],te[6],te[10],te[14],te[3],te[7],te[11],te[15])}};THREE.extend(THREE.Matrix4.prototype,{decompose:function(){var x=new THREE.Vector3;var y=new THREE.Vector3;var z=new THREE.Vector3;var matrix=new THREE.Matrix4;return function(position,quaternion,scale){var te=this.elements;x.set(te[0],te[1],te[2]);y.set(te[4],te[5],te[6]);z.set(te[8],te[9],te[10]);position=position instanceof THREE.Vector3?position:new THREE.Vector3;quaternion=quaternion instanceof THREE.Quaternion?quaternion:new THREE.Quaternion;scale=scale instanceof THREE.Vector3?scale:new THREE.Vector3;scale.x=x.length();scale.y=y.length();scale.z=z.length();position.x=te[12];position.y=te[13];position.z=te[14];matrix.copy(this);matrix.elements[0]/=scale.x;matrix.elements[1]/=scale.x;matrix.elements[2]/=scale.x;matrix.elements[4]/=scale.y;matrix.elements[5]/=scale.y;matrix.elements[6]/=scale.y;matrix.elements[8]/=scale.z;matrix.elements[9]/=scale.z;matrix.elements[10]/=scale.z;quaternion.setFromRotationMatrix(matrix);return[position,quaternion,scale]}}()});THREE.Ray=function(origin,direction){this.origin=origin!==undefined?origin:new THREE.Vector3;this.direction=direction!==undefined?direction:new THREE.Vector3};THREE.Ray.prototype={constructor:THREE.Ray,set:function(origin,direction){this.origin.copy(origin);this.direction.copy(direction);return this},copy:function(ray){this.origin.copy(ray.origin);this.direction.copy(ray.direction);return this},at:function(t,optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.copy(this.direction).multiplyScalar(t).add(this.origin)},recast:function(){var v1=new THREE.Vector3;return function(t){this.origin.copy(this.at(t,v1));return this}}(),closestPointToPoint:function(point,optionalTarget){var result=optionalTarget||new THREE.Vector3;result.subVectors(point,this.origin);var directionDistance=result.dot(this.direction);return result.copy(this.direction).multiplyScalar(directionDistance).add(this.origin)},distanceToPoint:function(){var v1=new THREE.Vector3;return function(point){var directionDistance=v1.subVectors(point,this.origin).dot(this.direction);v1.copy(this.direction).multiplyScalar(directionDistance).add(this.origin);return v1.distanceTo(point)}}(),isIntersectionSphere:function(sphere){return this.distanceToPoint(sphere.center)<=sphere.radius},isIntersectionPlane:function(plane){var denominator=plane.normal.dot(this.direction);if(denominator!=0){return true}if(plane.distanceToPoint(this.origin)==0){return true}return false},distanceToPlane:function(plane){var denominator=plane.normal.dot(this.direction);if(denominator==0){if(plane.distanceToPoint(this.origin)==0){return 0}return undefined}var t=-(this.origin.dot(plane.normal)+plane.constant)/denominator;return t},intersectPlane:function(plane,optionalTarget){var t=this.distanceToPlane(plane);if(t===undefined){return undefined}return this.at(t,optionalTarget)},applyMatrix4:function(matrix4){this.direction.add(this.origin).applyMatrix4(matrix4);this.origin.applyMatrix4(matrix4);this.direction.sub(this.origin);return this},equals:function(ray){return ray.origin.equals(this.origin)&&ray.direction.equals(this.direction)},clone:function(){return(new THREE.Ray).copy(this)}};THREE.Sphere=function(center,radius){this.center=center!==undefined?center:new THREE.Vector3;this.radius=radius!==undefined?radius:0};THREE.Sphere.prototype={constructor:THREE.Sphere,set:function(center,radius){this.center.copy(center);this.radius=radius;return this},setFromCenterAndPoints:function(center,points){var maxRadiusSq=0;for(var i=0,il=points.length;i<il;i++){var radiusSq=center.distanceToSquared(points[i]);maxRadiusSq=Math.max(maxRadiusSq,radiusSq)}this.center=center;this.radius=Math.sqrt(maxRadiusSq);return this},copy:function(sphere){this.center.copy(sphere.center);this.radius=sphere.radius;return this},empty:function(){return this.radius<=0},containsPoint:function(point){return point.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(point){return point.distanceTo(this.center)-this.radius},intersectsSphere:function(sphere){var radiusSum=this.radius+sphere.radius;return sphere.center.distanceToSquared(this.center)<=radiusSum*radiusSum},clampPoint:function(point,optionalTarget){var deltaLengthSq=this.center.distanceToSquared(point);var result=optionalTarget||new THREE.Vector3;result.copy(point);if(deltaLengthSq>this.radius*this.radius){result.sub(this.center).normalize();result.multiplyScalar(this.radius).add(this.center)}return result},getBoundingBox:function(optionalTarget){var box=optionalTarget||new THREE.Box3;box.set(this.center,this.center);box.expandByScalar(this.radius);return box},applyMatrix4:function(matrix){this.center.applyMatrix4(matrix);this.radius=this.radius*matrix.getMaxScaleOnAxis();return this},translate:function(offset){this.center.add(offset);return this},equals:function(sphere){return sphere.center.equals(this.center)&&sphere.radius===this.radius},clone:function(){return(new THREE.Sphere).copy(this)}};THREE.Frustum=function(p0,p1,p2,p3,p4,p5){this.planes=[p0!==undefined?p0:new THREE.Plane,p1!==undefined?p1:new THREE.Plane,p2!==undefined?p2:new THREE.Plane,p3!==undefined?p3:new THREE.Plane,p4!==undefined?p4:new THREE.Plane,p5!==undefined?p5:new THREE.Plane]};THREE.Frustum.prototype={constructor:THREE.Frustum,set:function(p0,p1,p2,p3,p4,p5){var planes=this.planes;planes[0].copy(p0);planes[1].copy(p1);planes[2].copy(p2);planes[3].copy(p3);planes[4].copy(p4);planes[5].copy(p5);return this},copy:function(frustum){var planes=this.planes;for(var i=0;i<6;i++){planes[i].copy(frustum.planes[i])}return this},setFromMatrix:function(m){var planes=this.planes;var me=m.elements;var me0=me[0],me1=me[1],me2=me[2],me3=me[3];var me4=me[4],me5=me[5],me6=me[6],me7=me[7];var me8=me[8],me9=me[9],me10=me[10],me11=me[11];var me12=me[12],me13=me[13],me14=me[14],me15=me[15];planes[0].setComponents(me3-me0,me7-me4,me11-me8,me15-me12).normalize();planes[1].setComponents(me3+me0,me7+me4,me11+me8,me15+me12).normalize();planes[2].setComponents(me3+me1,me7+me5,me11+me9,me15+me13).normalize();planes[3].setComponents(me3-me1,me7-me5,me11-me9,me15-me13).normalize();planes[4].setComponents(me3-me2,me7-me6,me11-me10,me15-me14).normalize();planes[5].setComponents(me3+me2,me7+me6,me11+me10,me15+me14).normalize();return this},intersectsObject:function(){var center=new THREE.Vector3;return function(object){var matrix=object.matrixWorld;var planes=this.planes;var negRadius=-object.geometry.boundingSphere.radius*matrix.getMaxScaleOnAxis();center.getPositionFromMatrix(matrix);for(var i=0;i<6;i++){var distance=planes[i].distanceToPoint(center);if(distance<negRadius){return false}}return true}}(),intersectsSphere:function(sphere){var planes=this.planes;var center=sphere.center;var negRadius=-sphere.radius;for(var i=0;i<6;i++){var distance=planes[i].distanceToPoint(center);if(distance<negRadius){return false}}return true},containsPoint:function(point){var planes=this.planes;for(var i=0;i<6;i++){if(planes[i].distanceToPoint(point)<0){return false}}return true},clone:function(){return(new THREE.Frustum).copy(this)}};THREE.Plane=function(normal,constant){this.normal=normal!==undefined?normal:new THREE.Vector3(1,0,0);this.constant=constant!==undefined?constant:0};THREE.Plane.prototype={constructor:THREE.Plane,set:function(normal,constant){this.normal.copy(normal);this.constant=constant;return this},setComponents:function(x,y,z,w){this.normal.set(x,y,z);this.constant=w;return this},setFromNormalAndCoplanarPoint:function(normal,point){this.normal.copy(normal);this.constant=-point.dot(this.normal);return this},setFromCoplanarPoints:function(){var v1=new THREE.Vector3;var v2=new THREE.Vector3;return function(a,b,c){var normal=v1.subVectors(c,b).cross(v2.subVectors(a,b)).normalize();this.setFromNormalAndCoplanarPoint(normal,a);return this}}(),copy:function(plane){this.normal.copy(plane.normal);this.constant=plane.constant;return this},normalize:function(){var inverseNormalLength=1/this.normal.length();this.normal.multiplyScalar(inverseNormalLength);this.constant*=inverseNormalLength;return this},negate:function(){this.constant*=-1;this.normal.negate();return this},distanceToPoint:function(point){return this.normal.dot(point)+this.constant},distanceToSphere:function(sphere){return this.distanceToPoint(sphere.center)-sphere.radius},projectPoint:function(point,optionalTarget){return this.orthoPoint(point,optionalTarget).sub(point).negate()},orthoPoint:function(point,optionalTarget){var perpendicularMagnitude=this.distanceToPoint(point);var result=optionalTarget||new THREE.Vector3;return result.copy(this.normal).multiplyScalar(perpendicularMagnitude)},isIntersectionLine:function(line){var startSign=this.distanceToPoint(line.start);var endSign=this.distanceToPoint(line.end);return startSign<0&&endSign>0||endSign<0&&startSign>0},intersectLine:function(){var v1=new THREE.Vector3;return function(line,optionalTarget){var result=optionalTarget||new THREE.Vector3;var direction=line.delta(v1);var denominator=this.normal.dot(direction);if(denominator==0){if(this.distanceToPoint(line.start)==0){return result.copy(line.start)}return undefined}var t=-(line.start.dot(this.normal)+this.constant)/denominator;if(t<0||t>1){return undefined}return result.copy(direction).multiplyScalar(t).add(line.start)}}(),coplanarPoint:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var v1=new THREE.Vector3;var v2=new THREE.Vector3;return function(matrix,optionalNormalMatrix){optionalNormalMatrix=optionalNormalMatrix||(new THREE.Matrix3).getNormalMatrix(matrix);var newNormal=v1.copy(this.normal).applyMatrix3(optionalNormalMatrix);var newCoplanarPoint=this.coplanarPoint(v2);newCoplanarPoint.applyMatrix4(matrix);this.setFromNormalAndCoplanarPoint(newNormal,newCoplanarPoint);return this}}(),translate:function(offset){this.constant=this.constant-offset.dot(this.normal);return this},equals:function(plane){return plane.normal.equals(this.normal)&&plane.constant==this.constant},clone:function(){return(new THREE.Plane).copy(this)}};THREE.Math={clamp:function(x,a,b){return x<a?a:x>b?b:x},clampBottom:function(x,a){return x<a?a:x},mapLinear:function(x,a1,a2,b1,b2){return b1+(x-a1)*(b2-b1)/(a2-a1)},smoothstep:function(x,min,max){if(x<=min)return 0;if(x>=max)return 1;x=(x-min)/(max-min);return x*x*(3-2*x)},smootherstep:function(x,min,max){if(x<=min)return 0;if(x>=max)return 1;x=(x-min)/(max-min);return x*x*x*(x*(x*6-15)+10)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(low,high){return low+Math.floor(Math.random()*(high-low+1))},randFloat:function(low,high){return low+Math.random()*(high-low)},randFloatSpread:function(range){return range*(.5-Math.random())},sign:function(x){return x<0?-1:x>0?1:0},degToRad:function(){var degreeToRadiansFactor=Math.PI/180;return function(degrees){return degrees*degreeToRadiansFactor}}(),radToDeg:function(){var radianToDegreesFactor=180/Math.PI;return function(radians){return radians*radianToDegreesFactor}}()};THREE.Spline=function(points){this.points=points;var c=[],v3={x:0,y:0,z:0},point,intPoint,weight,w2,w3,pa,pb,pc,pd;this.initFromArray=function(a){this.points=[];for(var i=0;i<a.length;i++){this.points[i]={x:a[i][0],y:a[i][1],z:a[i][2]}}};this.getPoint=function(k){point=(this.points.length-1)*k;intPoint=Math.floor(point);weight=point-intPoint;c[0]=intPoint===0?intPoint:intPoint-1;c[1]=intPoint;c[2]=intPoint>this.points.length-2?this.points.length-1:intPoint+1;c[3]=intPoint>this.points.length-3?this.points.length-1:intPoint+2;pa=this.points[c[0]];pb=this.points[c[1]];pc=this.points[c[2]];pd=this.points[c[3]];w2=weight*weight;w3=weight*w2;v3.x=interpolate(pa.x,pb.x,pc.x,pd.x,weight,w2,w3);v3.y=interpolate(pa.y,pb.y,pc.y,pd.y,weight,w2,w3);v3.z=interpolate(pa.z,pb.z,pc.z,pd.z,weight,w2,w3);return v3};this.getControlPointsArray=function(){var i,p,l=this.points.length,coords=[];for(i=0;i<l;i++){p=this.points[i];coords[i]=[p.x,p.y,p.z]}return coords};this.getLength=function(nSubDivisions){var i,index,nSamples,position,point=0,intPoint=0,oldIntPoint=0,oldPosition=new THREE.Vector3,tmpVec=new THREE.Vector3,chunkLengths=[],totalLength=0;chunkLengths[0]=0;if(!nSubDivisions)nSubDivisions=100;nSamples=this.points.length*nSubDivisions;oldPosition.copy(this.points[0]);for(i=1;i<nSamples;i++){index=i/nSamples;position=this.getPoint(index);tmpVec.copy(position);totalLength+=tmpVec.distanceTo(oldPosition);oldPosition.copy(position);point=(this.points.length-1)*index;intPoint=Math.floor(point);if(intPoint!=oldIntPoint){chunkLengths[intPoint]=totalLength;oldIntPoint=intPoint}}chunkLengths[chunkLengths.length]=totalLength;return{chunks:chunkLengths,total:totalLength}};this.reparametrizeByArcLength=function(samplingCoef){var i,j,index,indexCurrent,indexNext,linearDistance,realDistance,sampling,position,newpoints=[],tmpVec=new THREE.Vector3,sl=this.getLength();newpoints.push(tmpVec.copy(this.points[0]).clone());for(i=1;i<this.points.length;i++){realDistance=sl.chunks[i]-sl.chunks[i-1];sampling=Math.ceil(samplingCoef*realDistance/sl.total);indexCurrent=(i-1)/(this.points.length-1);indexNext=i/(this.points.length-1);for(j=1;j<sampling-1;j++){index=indexCurrent+j*(1/sampling)*(indexNext-indexCurrent);position=this.getPoint(index);newpoints.push(tmpVec.copy(position).clone())}newpoints.push(tmpVec.copy(this.points[i]).clone())}this.points=newpoints};function interpolate(p0,p1,p2,p3,t,t2,t3){var v0=(p2-p0)*.5,v1=(p3-p1)*.5;return(2*(p1-p2)+v0+v1)*t3+(-3*(p1-p2)-2*v0-v1)*t2+v0*t+p1}};THREE.Triangle=function(a,b,c){this.a=a!==undefined?a:new THREE.Vector3;this.b=b!==undefined?b:new THREE.Vector3;this.c=c!==undefined?c:new THREE.Vector3};THREE.Triangle.normal=function(){var v0=new THREE.Vector3;return function(a,b,c,optionalTarget){var result=optionalTarget||new THREE.Vector3;result.subVectors(c,b);v0.subVectors(a,b);result.cross(v0);var resultLengthSq=result.lengthSq();if(resultLengthSq>0){return result.multiplyScalar(1/Math.sqrt(resultLengthSq))}return result.set(0,0,0)}}();THREE.Triangle.barycoordFromPoint=function(){var v0=new THREE.Vector3;var v1=new THREE.Vector3;var v2=new THREE.Vector3;return function(point,a,b,c,optionalTarget){v0.subVectors(c,a);v1.subVectors(b,a);v2.subVectors(point,a);var dot00=v0.dot(v0);var dot01=v0.dot(v1);var dot02=v0.dot(v2);var dot11=v1.dot(v1);var dot12=v1.dot(v2);var denom=dot00*dot11-dot01*dot01;var result=optionalTarget||new THREE.Vector3;if(denom==0){return result.set(-2,-1,-1)}var invDenom=1/denom;var u=(dot11*dot02-dot01*dot12)*invDenom;var v=(dot00*dot12-dot01*dot02)*invDenom;return result.set(1-u-v,v,u)}}();THREE.Triangle.containsPoint=function(){var v1=new THREE.Vector3;return function(point,a,b,c){var result=THREE.Triangle.barycoordFromPoint(point,a,b,c,v1);return result.x>=0&&result.y>=0&&result.x+result.y<=1}}();THREE.Triangle.prototype={constructor:THREE.Triangle,set:function(a,b,c){this.a.copy(a);this.b.copy(b);this.c.copy(c);return this},setFromPointsAndIndices:function(points,i0,i1,i2){this.a.copy(points[i0]);this.b.copy(points[i1]);this.c.copy(points[i2]);return this},copy:function(triangle){this.a.copy(triangle.a);this.b.copy(triangle.b);this.c.copy(triangle.c);return this},area:function(){var v0=new THREE.Vector3;var v1=new THREE.Vector3;return function(){v0.subVectors(this.c,this.b);v1.subVectors(this.a,this.b);return v0.cross(v1).length()*.5}}(),midpoint:function(optionalTarget){var result=optionalTarget||new THREE.Vector3;return result.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(optionalTarget){return THREE.Triangle.normal(this.a,this.b,this.c,optionalTarget)},plane:function(optionalTarget){var result=optionalTarget||new THREE.Plane;return result.setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(point,optionalTarget){return THREE.Triangle.barycoordFromPoint(point,this.a,this.b,this.c,optionalTarget)},containsPoint:function(point){return THREE.Triangle.containsPoint(point,this.a,this.b,this.c)},equals:function(triangle){return triangle.a.equals(this.a)&&triangle.b.equals(this.b)&&triangle.c.equals(this.c)},clone:function(){return(new THREE.Triangle).copy(this)}};THREE.Vertex=function(v){console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead.");return v};THREE.UV=function(u,v){console.warn("THREE.UV has been DEPRECATED. Use THREE.Vector2 instead.");return new THREE.Vector2(u,v)};THREE.Clock=function(autoStart){this.autoStart=autoStart!==undefined?autoStart:true;this.startTime=0;this.oldTime=0;this.elapsedTime=0;this.running=false};THREE.Clock.prototype={constructor:THREE.Clock,start:function(){this.startTime=self.performance!==undefined&&self.performance.now!==undefined?self.performance.now():Date.now();this.oldTime=this.startTime;this.running=true},stop:function(){this.getElapsedTime();this.running=false},getElapsedTime:function(){this.getDelta();return this.elapsedTime},getDelta:function(){var diff=0;if(this.autoStart&&!this.running){this.start()}if(this.running){var newTime=self.performance!==undefined&&self.performance.now!==undefined?self.performance.now():Date.now();diff=.001*(newTime-this.oldTime);this.oldTime=newTime;this.elapsedTime+=diff}return diff}};THREE.EventDispatcher=function(){};THREE.EventDispatcher.prototype={constructor:THREE.EventDispatcher,addEventListener:function(type,listener){if(this._listeners===undefined)this._listeners={};var listeners=this._listeners;if(listeners[type]===undefined){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}},hasEventListener:function(type,listener){if(this._listeners===undefined)return false;var listeners=this._listeners;if(listeners[type]!==undefined&&listeners[type].indexOf(listener)!==-1){return true}return false},removeEventListener:function(type,listener){if(this._listeners===undefined)return;var listeners=this._listeners;var index=listeners[type].indexOf(listener);if(index!==-1){listeners[type].splice(index,1)}},dispatchEvent:function(event){if(this._listeners===undefined)return;var listeners=this._listeners;var listenerArray=listeners[event.type];if(listenerArray!==undefined){event.target=this;for(var i=0,l=listenerArray.length;i<l;i++){listenerArray[i].call(this,event)}}}};(function(THREE){THREE.Raycaster=function(origin,direction,near,far){this.ray=new THREE.Ray(origin,direction);if(this.ray.direction.lengthSq()>0){this.ray.direction.normalize()}this.near=near||0;this.far=far||Infinity};var sphere=new THREE.Sphere;var localRay=new THREE.Ray;var facePlane=new THREE.Plane;var intersectPoint=new THREE.Vector3;var matrixPosition=new THREE.Vector3;var inverseMatrix=new THREE.Matrix4;var descSort=function(a,b){return a.distance-b.distance};var intersectObject=function(object,raycaster,intersects){if(object instanceof THREE.Particle){matrixPosition.getPositionFromMatrix(object.matrixWorld);var distance=raycaster.ray.distanceToPoint(matrixPosition);if(distance>object.scale.x){return intersects}intersects.push({distance:distance,point:object.position,face:null,object:object})}else if(object instanceof THREE.LOD){matrixPosition.getPositionFromMatrix(object.matrixWorld);var distance=raycaster.ray.origin.distanceTo(matrixPosition);intersectObject(object.getObjectForDistance(distance),raycaster,intersects)}else if(object instanceof THREE.Mesh){matrixPosition.getPositionFromMatrix(object.matrixWorld);sphere.set(matrixPosition,object.geometry.boundingSphere.radius*object.matrixWorld.getMaxScaleOnAxis());if(raycaster.ray.isIntersectionSphere(sphere)===false){return intersects}var geometry=object.geometry;var vertices=geometry.vertices;if(geometry instanceof THREE.BufferGeometry){var isFaceMaterial=object.material instanceof THREE.MeshFaceMaterial;var objectMaterials=isFaceMaterial===true?object.material.materials:null;var side=object.material.side;var a,b,c;var precision=raycaster.precision;inverseMatrix.getInverse(object.matrixWorld);localRay.copy(raycaster.ray).applyMatrix4(inverseMatrix);if(!geometry.dynamic)return intersects;var fl;var indexed=false;if(geometry.attributes.index){indexed=true;fl=geometry.attributes.index.numItems/3}else{fl=geometry.attributes.position.numItems/9}for(var f=0;f<fl;f++){if(indexed){a=geometry.attributes.index.array[f*3];b=geometry.attributes.index.array[f*3+1];c=geometry.attributes.index.array[f*3+2]}else{a=f*3;b=f*3+1;c=f*3+2}var v1=[geometry.attributes.position.array[a*3],geometry.attributes.position.array[a*3+1],geometry.attributes.position.array[a*3+2]];var v2=[geometry.attributes.position.array[b*3],geometry.attributes.position.array[b*3+1],geometry.attributes.position.array[b*3+2]];var v3=[geometry.attributes.position.array[c*3],geometry.attributes.position.array[c*3+1],geometry.attributes.position.array[c*3+2]];var material=object.material;if(material===undefined)continue;var cb=new THREE.Vector3,ab=new THREE.Vector3;var vA=new THREE.Vector3(v1[0],v1[1],v1[2]);var vB=new THREE.Vector3(v2[0],v2[1],v2[2]);var vC=new THREE.Vector3(v3[0],v3[1],v3[2]);cb.subVectors(vC,vB);ab.subVectors(vA,vB);cb.cross(ab);cb.normalize();facePlane.setFromNormalAndCoplanarPoint(cb,vA);var planeDistance=localRay.distanceToPlane(facePlane);if(Math.abs(planeDistance)<precision)continue;if(planeDistance<0)continue;side=material.side;if(side!==THREE.DoubleSide){var planeSign=localRay.direction.dot(facePlane.normal);if(!(side===THREE.FrontSide?planeSign<0:planeSign>0))continue}if(planeDistance<raycaster.near||planeDistance>raycaster.far)continue;intersectPoint=localRay.at(planeDistance,intersectPoint);if(!THREE.Triangle.containsPoint(intersectPoint,vA,vB,vC))continue;var face=new THREE.Face3(a,b,c);var colors=geometry.attributes.color.array;face.vertexColors[0]=new THREE.Color(colors[a*3],colors[a*3+1],colors[a*3+2]);face.vertexColors[1]=new THREE.Color(colors[b*3],colors[b*3+1],colors[b*3+2]);face.vertexColors[2]=new THREE.Color(colors[c*3],colors[c*3+1],colors[c*3+2]);intersects.push({distance:planeDistance,point:raycaster.ray.at(planeDistance),face:face,faceIndex:f,object:object})}}else if(geometry instanceof THREE.Geometry){var isFaceMaterial=object.material instanceof THREE.MeshFaceMaterial;var objectMaterials=isFaceMaterial===true?object.material.materials:null;var side=object.material.side;var a,b,c,d;var precision=raycaster.precision;inverseMatrix.getInverse(object.matrixWorld);localRay.copy(raycaster.ray).applyMatrix4(inverseMatrix);for(var f=0,fl=geometry.faces.length;f<fl;f++){var face=geometry.faces[f];var material=isFaceMaterial===true?objectMaterials[face.materialIndex]:object.material;if(material===undefined)continue;facePlane.setFromNormalAndCoplanarPoint(face.normal,vertices[face.a]);var planeDistance=localRay.distanceToPlane(facePlane);if(Math.abs(planeDistance)<precision)continue;if(planeDistance<0)continue;side=material.side;if(side!==THREE.DoubleSide){var planeSign=localRay.direction.dot(facePlane.normal);if(!(side===THREE.FrontSide?planeSign<0:planeSign>0))continue}if(planeDistance<raycaster.near||planeDistance>raycaster.far)continue;intersectPoint=localRay.at(planeDistance,intersectPoint);if(face instanceof THREE.Face3){a=vertices[face.a];b=vertices[face.b];c=vertices[face.c];if(!THREE.Triangle.containsPoint(intersectPoint,a,b,c))continue}else if(face instanceof THREE.Face4){a=vertices[face.a];b=vertices[face.b];c=vertices[face.c];d=vertices[face.d];if(!THREE.Triangle.containsPoint(intersectPoint,a,b,d)&&!THREE.Triangle.containsPoint(intersectPoint,b,c,d))continue}else{throw Error("face type not supported")}intersects.push({distance:planeDistance,point:raycaster.ray.at(planeDistance),face:face,faceIndex:f,object:object})}}}};var intersectDescendants=function(object,raycaster,intersects){var descendants=object.getDescendants();
for(var i=0,l=descendants.length;i<l;i++){intersectObject(descendants[i],raycaster,intersects)}};THREE.Raycaster.prototype.precision=1e-4;THREE.Raycaster.prototype.set=function(origin,direction){this.ray.set(origin,direction);if(this.ray.direction.length()>0){this.ray.direction.normalize()}};THREE.Raycaster.prototype.intersectObject=function(object,recursive){var intersects=[];if(recursive===true){intersectDescendants(object,this,intersects)}intersectObject(object,this,intersects);intersects.sort(descSort);return intersects};THREE.Raycaster.prototype.intersectObjects=function(objects,recursive){var intersects=[];for(var i=0,l=objects.length;i<l;i++){intersectObject(objects[i],this,intersects);if(recursive===true){intersectDescendants(objects[i],this,intersects)}}intersects.sort(descSort);return intersects}})(THREE);THREE.Object3D=function(){this.id=THREE.Object3DIdCount++;this.name="";this.parent=undefined;this.children=[];this.up=new THREE.Vector3(0,1,0);this.position=new THREE.Vector3;this.rotation=new THREE.Vector3;this.eulerOrder=THREE.Object3D.defaultEulerOrder;this.scale=new THREE.Vector3(1,1,1);this.renderDepth=null;this.rotationAutoUpdate=true;this.matrix=new THREE.Matrix4;this.matrixWorld=new THREE.Matrix4;this.matrixAutoUpdate=true;this.matrixWorldNeedsUpdate=true;this.quaternion=new THREE.Quaternion;this.useQuaternion=false;this.visible=true;this.castShadow=false;this.receiveShadow=false;this.frustumCulled=true;this.userData={}};THREE.Object3D.prototype={constructor:THREE.Object3D,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,applyMatrix:function(){var m1=new THREE.Matrix4;return function(matrix){this.matrix.multiplyMatrices(matrix,this.matrix);this.position.getPositionFromMatrix(this.matrix);this.scale.getScaleFromMatrix(this.matrix);m1.extractRotation(this.matrix);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(m1)}else{this.rotation.setEulerFromRotationMatrix(m1,this.eulerOrder)}}}(),rotateOnAxis:function(){var q1=new THREE.Quaternion;var q2=new THREE.Quaternion;return function(axis,angle){q1.setFromAxisAngle(axis,angle);if(this.useQuaternion===true){this.quaternion.multiply(q1)}else{q2.setFromEuler(this.rotation,this.eulerOrder);q2.multiply(q1);this.rotation.setEulerFromQuaternion(q2,this.eulerOrder)}return this}}(),translateOnAxis:function(){var v1=new THREE.Vector3;return function(axis,distance){v1.copy(axis);if(this.useQuaternion===true){v1.applyQuaternion(this.quaternion)}else{v1.applyEuler(this.rotation,this.eulerOrder)}this.position.add(v1.multiplyScalar(distance));return this}}(),translate:function(distance,axis){console.warn("DEPRECATED: Object3D's .translate() has been removed. Use .translateOnAxis( axis, distance ) instead. Note args have been changed.");return this.translateOnAxis(axis,distance)},translateX:function(){var v1=new THREE.Vector3(1,0,0);return function(distance){return this.translateOnAxis(v1,distance)}}(),translateY:function(){var v1=new THREE.Vector3(0,1,0);return function(distance){return this.translateOnAxis(v1,distance)}}(),translateZ:function(){var v1=new THREE.Vector3(0,0,1);return function(distance){return this.translateOnAxis(v1,distance)}}(),localToWorld:function(vector){return vector.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var m1=new THREE.Matrix4;return function(vector){return vector.applyMatrix4(m1.getInverse(this.matrixWorld))}}(),lookAt:function(){var m1=new THREE.Matrix4;return function(vector){m1.lookAt(vector,this.position,this.up);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(m1)}else{this.rotation.setEulerFromRotationMatrix(m1,this.eulerOrder)}}}(),add:function(object){if(object===this){console.warn("THREE.Object3D.add: An object can't be added as a child of itself.");return}if(object instanceof THREE.Object3D){if(object.parent!==undefined){object.parent.remove(object)}object.parent=this;this.children.push(object);var scene=this;while(scene.parent!==undefined){scene=scene.parent}if(scene!==undefined&&scene instanceof THREE.Scene){scene.__addObject(object)}}},remove:function(object){var index=this.children.indexOf(object);if(index!==-1){object.parent=undefined;this.children.splice(index,1);var scene=this;while(scene.parent!==undefined){scene=scene.parent}if(scene!==undefined&&scene instanceof THREE.Scene){scene.__removeObject(object)}}},traverse:function(callback){callback(this);for(var i=0,l=this.children.length;i<l;i++){this.children[i].traverse(callback)}},getObjectById:function(id,recursive){for(var i=0,l=this.children.length;i<l;i++){var child=this.children[i];if(child.id===id){return child}if(recursive===true){child=child.getObjectById(id,recursive);if(child!==undefined){return child}}}return undefined},getObjectByName:function(name,recursive){for(var i=0,l=this.children.length;i<l;i++){var child=this.children[i];if(child.name===name){return child}if(recursive===true){child=child.getObjectByName(name,recursive);if(child!==undefined){return child}}}return undefined},getChildByName:function(name,recursive){console.warn("DEPRECATED: Object3D's .getChildByName() has been renamed to .getObjectByName().");return this.getObjectByName(name,recursive)},getDescendants:function(array){if(array===undefined)array=[];Array.prototype.push.apply(array,this.children);for(var i=0,l=this.children.length;i<l;i++){this.children[i].getDescendants(array)}return array},updateMatrix:function(){if(this.useQuaternion===false){this.matrix.makeFromPositionEulerScale(this.position,this.rotation,this.eulerOrder,this.scale)}else{this.matrix.makeFromPositionQuaternionScale(this.position,this.quaternion,this.scale)}this.matrixWorldNeedsUpdate=true},updateMatrixWorld:function(force){if(this.matrixAutoUpdate===true)this.updateMatrix();if(this.matrixWorldNeedsUpdate===true||force===true){if(this.parent===undefined){this.matrixWorld.copy(this.matrix)}else{this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)}this.matrixWorldNeedsUpdate=false;force=true}for(var i=0,l=this.children.length;i<l;i++){this.children[i].updateMatrixWorld(force)}},clone:function(object){if(object===undefined)object=new THREE.Object3D;object.name=this.name;object.up.copy(this.up);object.position.copy(this.position);if(object.rotation instanceof THREE.Vector3)object.rotation.copy(this.rotation);object.eulerOrder=this.eulerOrder;object.scale.copy(this.scale);object.renderDepth=this.renderDepth;object.rotationAutoUpdate=this.rotationAutoUpdate;object.matrix.copy(this.matrix);object.matrixWorld.copy(this.matrixWorld);object.matrixAutoUpdate=this.matrixAutoUpdate;object.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate;object.quaternion.copy(this.quaternion);object.useQuaternion=this.useQuaternion;object.visible=this.visible;object.castShadow=this.castShadow;object.receiveShadow=this.receiveShadow;object.frustumCulled=this.frustumCulled;object.userData=JSON.parse(JSON.stringify(this.userData));for(var i=0;i<this.children.length;i++){var child=this.children[i];object.add(child.clone())}return object}};THREE.Object3D.defaultEulerOrder="XYZ",THREE.Object3DIdCount=0;THREE.Projector=function(){var _object,_objectCount,_objectPool=[],_objectPoolLength=0,_vertex,_vertexCount,_vertexPool=[],_vertexPoolLength=0,_face,_face3Count,_face3Pool=[],_face3PoolLength=0,_face4Count,_face4Pool=[],_face4PoolLength=0,_line,_lineCount,_linePool=[],_linePoolLength=0,_particle,_particleCount,_particlePool=[],_particlePoolLength=0,_renderData={objects:[],sprites:[],lights:[],elements:[]},_vector3=new THREE.Vector3,_vector4=new THREE.Vector4,_clipBox=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),_boundingBox=new THREE.Box3,_points3=new Array(3),_points4=new Array(4),_viewMatrix=new THREE.Matrix4,_viewProjectionMatrix=new THREE.Matrix4,_modelMatrix,_modelViewProjectionMatrix=new THREE.Matrix4,_normalMatrix=new THREE.Matrix3,_normalViewMatrix=new THREE.Matrix3,_centroid=new THREE.Vector3,_frustum=new THREE.Frustum,_clippedVertex1PositionScreen=new THREE.Vector4,_clippedVertex2PositionScreen=new THREE.Vector4;this.projectVector=function(vector,camera){camera.matrixWorldInverse.getInverse(camera.matrixWorld);_viewProjectionMatrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse);return vector.applyProjection(_viewProjectionMatrix)};this.unprojectVector=function(vector,camera){camera.projectionMatrixInverse.getInverse(camera.projectionMatrix);_viewProjectionMatrix.multiplyMatrices(camera.matrixWorld,camera.projectionMatrixInverse);return vector.applyProjection(_viewProjectionMatrix)};this.pickingRay=function(vector,camera){vector.z=-1;var end=new THREE.Vector3(vector.x,vector.y,1);this.unprojectVector(vector,camera);this.unprojectVector(end,camera);end.sub(vector).normalize();return new THREE.Raycaster(vector,end)};var getObject=function(object){_object=getNextObjectInPool();_object.object=object;if(object.renderDepth!==null){_object.z=object.renderDepth}else{_vector3.getPositionFromMatrix(object.matrixWorld);_vector3.applyProjection(_viewProjectionMatrix);_object.z=_vector3.z}return _object};var projectObject=function(object){if(object.visible===false)return;if(object instanceof THREE.Light){_renderData.lights.push(object)}else if(object instanceof THREE.Mesh||object instanceof THREE.Line){if(object.frustumCulled===false||_frustum.intersectsObject(object)===true){_renderData.objects.push(getObject(object))}}else if(object instanceof THREE.Sprite||object instanceof THREE.Particle){_renderData.sprites.push(getObject(object))}for(var i=0,l=object.children.length;i<l;i++){projectObject(object.children[i])}};var projectGraph=function(root,sortObjects){_objectCount=0;_renderData.objects.length=0;_renderData.sprites.length=0;_renderData.lights.length=0;projectObject(root);if(sortObjects===true){_renderData.objects.sort(painterSort)}};this.projectScene=function(scene,camera,sortObjects,sortElements){var visible=false,o,ol,v,vl,f,fl,n,nl,c,cl,u,ul,object,geometry,vertices,faces,face,faceVertexNormals,faceVertexUvs,uvs,v1,v2,v3,v4,isFaceMaterial,objectMaterials;_face3Count=0;_face4Count=0;_lineCount=0;_particleCount=0;_renderData.elements.length=0;if(scene.autoUpdate===true)scene.updateMatrixWorld();if(camera.parent===undefined)camera.updateMatrixWorld();_viewMatrix.copy(camera.matrixWorldInverse.getInverse(camera.matrixWorld));_viewProjectionMatrix.multiplyMatrices(camera.projectionMatrix,_viewMatrix);_normalViewMatrix.getNormalMatrix(_viewMatrix);_frustum.setFromMatrix(_viewProjectionMatrix);projectGraph(scene,sortObjects);for(o=0,ol=_renderData.objects.length;o<ol;o++){object=_renderData.objects[o].object;_modelMatrix=object.matrixWorld;_vertexCount=0;if(object instanceof THREE.Mesh){geometry=object.geometry;vertices=geometry.vertices;faces=geometry.faces;faceVertexUvs=geometry.faceVertexUvs;_normalMatrix.getNormalMatrix(_modelMatrix);isFaceMaterial=object.material instanceof THREE.MeshFaceMaterial;objectMaterials=isFaceMaterial===true?object.material:null;for(v=0,vl=vertices.length;v<vl;v++){_vertex=getNextVertexInPool();_vertex.positionWorld.copy(vertices[v]).applyMatrix4(_modelMatrix);_vertex.positionScreen.copy(_vertex.positionWorld).applyMatrix4(_viewProjectionMatrix);_vertex.positionScreen.x/=_vertex.positionScreen.w;_vertex.positionScreen.y/=_vertex.positionScreen.w;_vertex.positionScreen.z/=_vertex.positionScreen.w;_vertex.visible=!(_vertex.positionScreen.x<-1||_vertex.positionScreen.x>1||_vertex.positionScreen.y<-1||_vertex.positionScreen.y>1||_vertex.positionScreen.z<-1||_vertex.positionScreen.z>1)}for(f=0,fl=faces.length;f<fl;f++){face=faces[f];var material=isFaceMaterial===true?objectMaterials.materials[face.materialIndex]:object.material;if(material===undefined)continue;var side=material.side;if(face instanceof THREE.Face3){v1=_vertexPool[face.a];v2=_vertexPool[face.b];v3=_vertexPool[face.c];_points3[0]=v1.positionScreen;_points3[1]=v2.positionScreen;_points3[2]=v3.positionScreen;if(v1.visible===true||v2.visible===true||v3.visible===true||_clipBox.isIntersectionBox(_boundingBox.setFromPoints(_points3))){visible=(v3.positionScreen.x-v1.positionScreen.x)*(v2.positionScreen.y-v1.positionScreen.y)-(v3.positionScreen.y-v1.positionScreen.y)*(v2.positionScreen.x-v1.positionScreen.x)<0;if(side===THREE.DoubleSide||visible===(side===THREE.FrontSide)){_face=getNextFace3InPool();_face.v1.copy(v1);_face.v2.copy(v2);_face.v3.copy(v3)}else{continue}}else{continue}}else if(face instanceof THREE.Face4){v1=_vertexPool[face.a];v2=_vertexPool[face.b];v3=_vertexPool[face.c];v4=_vertexPool[face.d];_points4[0]=v1.positionScreen;_points4[1]=v2.positionScreen;_points4[2]=v3.positionScreen;_points4[3]=v4.positionScreen;if(v1.visible===true||v2.visible===true||v3.visible===true||v4.visible===true||_clipBox.isIntersectionBox(_boundingBox.setFromPoints(_points4))){visible=(v4.positionScreen.x-v1.positionScreen.x)*(v2.positionScreen.y-v1.positionScreen.y)-(v4.positionScreen.y-v1.positionScreen.y)*(v2.positionScreen.x-v1.positionScreen.x)<0||(v2.positionScreen.x-v3.positionScreen.x)*(v4.positionScreen.y-v3.positionScreen.y)-(v2.positionScreen.y-v3.positionScreen.y)*(v4.positionScreen.x-v3.positionScreen.x)<0;if(side===THREE.DoubleSide||visible===(side===THREE.FrontSide)){_face=getNextFace4InPool();_face.v1.copy(v1);_face.v2.copy(v2);_face.v3.copy(v3);_face.v4.copy(v4)}else{continue}}else{continue}}_face.normalModel.copy(face.normal);if(visible===false&&(side===THREE.BackSide||side===THREE.DoubleSide)){_face.normalModel.negate()}_face.normalModel.applyMatrix3(_normalMatrix).normalize();_face.normalModelView.copy(_face.normalModel).applyMatrix3(_normalViewMatrix);_face.centroidModel.copy(face.centroid).applyMatrix4(_modelMatrix);faceVertexNormals=face.vertexNormals;for(n=0,nl=faceVertexNormals.length;n<nl;n++){var normalModel=_face.vertexNormalsModel[n];normalModel.copy(faceVertexNormals[n]);if(visible===false&&(side===THREE.BackSide||side===THREE.DoubleSide)){normalModel.negate()}normalModel.applyMatrix3(_normalMatrix).normalize();var normalModelView=_face.vertexNormalsModelView[n];normalModelView.copy(normalModel).applyMatrix3(_normalViewMatrix)}_face.vertexNormalsLength=faceVertexNormals.length;for(c=0,cl=faceVertexUvs.length;c<cl;c++){uvs=faceVertexUvs[c][f];if(uvs===undefined)continue;for(u=0,ul=uvs.length;u<ul;u++){_face.uvs[c][u]=uvs[u]}}_face.color=face.color;_face.material=material;_centroid.copy(_face.centroidModel).applyProjection(_viewProjectionMatrix);_face.z=_centroid.z;_renderData.elements.push(_face)}}else if(object instanceof THREE.Line){_modelViewProjectionMatrix.multiplyMatrices(_viewProjectionMatrix,_modelMatrix);vertices=object.geometry.vertices;v1=getNextVertexInPool();v1.positionScreen.copy(vertices[0]).applyMatrix4(_modelViewProjectionMatrix);var step=object.type===THREE.LinePieces?2:1;for(v=1,vl=vertices.length;v<vl;v++){v1=getNextVertexInPool();v1.positionScreen.copy(vertices[v]).applyMatrix4(_modelViewProjectionMatrix);if((v+1)%step>0)continue;v2=_vertexPool[_vertexCount-2];_clippedVertex1PositionScreen.copy(v1.positionScreen);_clippedVertex2PositionScreen.copy(v2.positionScreen);if(clipLine(_clippedVertex1PositionScreen,_clippedVertex2PositionScreen)===true){_clippedVertex1PositionScreen.multiplyScalar(1/_clippedVertex1PositionScreen.w);_clippedVertex2PositionScreen.multiplyScalar(1/_clippedVertex2PositionScreen.w);_line=getNextLineInPool();_line.v1.positionScreen.copy(_clippedVertex1PositionScreen);_line.v2.positionScreen.copy(_clippedVertex2PositionScreen);_line.z=Math.max(_clippedVertex1PositionScreen.z,_clippedVertex2PositionScreen.z);_line.material=object.material;if(object.material.vertexColors===THREE.VertexColors){_line.vertexColors[0].copy(object.geometry.colors[v]);_line.vertexColors[1].copy(object.geometry.colors[v-1])}_renderData.elements.push(_line)}}}}for(o=0,ol=_renderData.sprites.length;o<ol;o++){object=_renderData.sprites[o].object;_modelMatrix=object.matrixWorld;if(object instanceof THREE.Particle){_vector4.set(_modelMatrix.elements[12],_modelMatrix.elements[13],_modelMatrix.elements[14],1);_vector4.applyMatrix4(_viewProjectionMatrix);_vector4.z/=_vector4.w;if(_vector4.z>0&&_vector4.z<1){_particle=getNextParticleInPool();_particle.object=object;_particle.x=_vector4.x/_vector4.w;_particle.y=_vector4.y/_vector4.w;_particle.z=_vector4.z;_particle.rotation=object.rotation.z;_particle.scale.x=object.scale.x*Math.abs(_particle.x-(_vector4.x+camera.projectionMatrix.elements[0])/(_vector4.w+camera.projectionMatrix.elements[12]));_particle.scale.y=object.scale.y*Math.abs(_particle.y-(_vector4.y+camera.projectionMatrix.elements[5])/(_vector4.w+camera.projectionMatrix.elements[13]));_particle.material=object.material;_renderData.elements.push(_particle)}}}if(sortElements===true)_renderData.elements.sort(painterSort);return _renderData};function getNextObjectInPool(){if(_objectCount===_objectPoolLength){var object=new THREE.RenderableObject;_objectPool.push(object);_objectPoolLength++;_objectCount++;return object}return _objectPool[_objectCount++]}function getNextVertexInPool(){if(_vertexCount===_vertexPoolLength){var vertex=new THREE.RenderableVertex;_vertexPool.push(vertex);_vertexPoolLength++;_vertexCount++;return vertex}return _vertexPool[_vertexCount++]}function getNextFace3InPool(){if(_face3Count===_face3PoolLength){var face=new THREE.RenderableFace3;_face3Pool.push(face);_face3PoolLength++;_face3Count++;return face}return _face3Pool[_face3Count++]}function getNextFace4InPool(){if(_face4Count===_face4PoolLength){var face=new THREE.RenderableFace4;_face4Pool.push(face);_face4PoolLength++;_face4Count++;return face}return _face4Pool[_face4Count++]}function getNextLineInPool(){if(_lineCount===_linePoolLength){var line=new THREE.RenderableLine;_linePool.push(line);_linePoolLength++;_lineCount++;return line}return _linePool[_lineCount++]}function getNextParticleInPool(){if(_particleCount===_particlePoolLength){var particle=new THREE.RenderableParticle;_particlePool.push(particle);_particlePoolLength++;_particleCount++;return particle}return _particlePool[_particleCount++]}function painterSort(a,b){return b.z-a.z}function clipLine(s1,s2){var alpha1=0,alpha2=1,bc1near=s1.z+s1.w,bc2near=s2.z+s2.w,bc1far=-s1.z+s1.w,bc2far=-s2.z+s2.w;if(bc1near>=0&&bc2near>=0&&bc1far>=0&&bc2far>=0){return true}else if(bc1near<0&&bc2near<0||bc1far<0&&bc2far<0){return false}else{if(bc1near<0){alpha1=Math.max(alpha1,bc1near/(bc1near-bc2near))}else if(bc2near<0){alpha2=Math.min(alpha2,bc1near/(bc1near-bc2near))}if(bc1far<0){alpha1=Math.max(alpha1,bc1far/(bc1far-bc2far))}else if(bc2far<0){alpha2=Math.min(alpha2,bc1far/(bc1far-bc2far))}if(alpha2<alpha1){return false}else{s1.lerp(s2,alpha1);s2.lerp(s1,1-alpha2);return true}}}};THREE.Face3=function(a,b,c,normal,color,materialIndex){this.a=a;this.b=b;this.c=c;this.normal=normal instanceof THREE.Vector3?normal:new THREE.Vector3;this.vertexNormals=normal instanceof Array?normal:[];this.color=color instanceof THREE.Color?color:new THREE.Color;this.vertexColors=color instanceof Array?color:[];this.vertexTangents=[];this.materialIndex=materialIndex!==undefined?materialIndex:0;this.centroid=new THREE.Vector3};THREE.Face3.prototype={constructor:THREE.Face3,clone:function(){var face=new THREE.Face3(this.a,this.b,this.c);face.normal.copy(this.normal);face.color.copy(this.color);face.centroid.copy(this.centroid);face.materialIndex=this.materialIndex;var i,il;for(i=0,il=this.vertexNormals.length;i<il;i++)face.vertexNormals[i]=this.vertexNormals[i].clone();for(i=0,il=this.vertexColors.length;i<il;i++)face.vertexColors[i]=this.vertexColors[i].clone();for(i=0,il=this.vertexTangents.length;i<il;i++)face.vertexTangents[i]=this.vertexTangents[i].clone();return face}};THREE.Face4=function(a,b,c,d,normal,color,materialIndex){this.a=a;this.b=b;this.c=c;this.d=d;this.normal=normal instanceof THREE.Vector3?normal:new THREE.Vector3;this.vertexNormals=normal instanceof Array?normal:[];this.color=color instanceof THREE.Color?color:new THREE.Color;this.vertexColors=color instanceof Array?color:[];this.vertexTangents=[];this.materialIndex=materialIndex!==undefined?materialIndex:0;this.centroid=new THREE.Vector3};THREE.Face4.prototype={constructor:THREE.Face4,clone:function(){var face=new THREE.Face4(this.a,this.b,this.c,this.d);face.normal.copy(this.normal);face.color.copy(this.color);face.centroid.copy(this.centroid);face.materialIndex=this.materialIndex;var i,il;for(i=0,il=this.vertexNormals.length;i<il;i++)face.vertexNormals[i]=this.vertexNormals[i].clone();for(i=0,il=this.vertexColors.length;i<il;i++)face.vertexColors[i]=this.vertexColors[i].clone();for(i=0,il=this.vertexTangents.length;i<il;i++)face.vertexTangents[i]=this.vertexTangents[i].clone();return face}};THREE.Geometry=function(){this.id=THREE.GeometryIdCount++;this.name="";this.vertices=[];this.colors=[];this.normals=[];this.faces=[];this.faceUvs=[[]];this.faceVertexUvs=[[]];this.morphTargets=[];this.morphColors=[];this.morphNormals=[];this.skinWeights=[];this.skinIndices=[];this.lineDistances=[];this.boundingBox=null;this.boundingSphere=null;this.hasTangents=false;this.dynamic=true;this.verticesNeedUpdate=false;this.elementsNeedUpdate=false;this.uvsNeedUpdate=false;this.normalsNeedUpdate=false;this.tangentsNeedUpdate=false;this.colorsNeedUpdate=false;this.lineDistancesNeedUpdate=false;this.buffersNeedUpdate=false};THREE.Geometry.prototype={constructor:THREE.Geometry,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,applyMatrix:function(matrix){var normalMatrix=(new THREE.Matrix3).getNormalMatrix(matrix);for(var i=0,il=this.vertices.length;i<il;i++){var vertex=this.vertices[i];vertex.applyMatrix4(matrix)}for(var i=0,il=this.faces.length;i<il;i++){var face=this.faces[i];face.normal.applyMatrix3(normalMatrix).normalize();for(var j=0,jl=face.vertexNormals.length;j<jl;j++){face.vertexNormals[j].applyMatrix3(normalMatrix).normalize()}face.centroid.applyMatrix4(matrix)}},computeCentroids:function(){var f,fl,face;for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];face.centroid.set(0,0,0);if(face instanceof THREE.Face3){face.centroid.add(this.vertices[face.a]);face.centroid.add(this.vertices[face.b]);face.centroid.add(this.vertices[face.c]);face.centroid.divideScalar(3)}else if(face instanceof THREE.Face4){face.centroid.add(this.vertices[face.a]);face.centroid.add(this.vertices[face.b]);face.centroid.add(this.vertices[face.c]);face.centroid.add(this.vertices[face.d]);face.centroid.divideScalar(4)}}},computeFaceNormals:function(){var cb=new THREE.Vector3,ab=new THREE.Vector3;for(var f=0,fl=this.faces.length;f<fl;f++){var face=this.faces[f];var vA=this.vertices[face.a];var vB=this.vertices[face.b];var vC=this.vertices[face.c];cb.subVectors(vC,vB);ab.subVectors(vA,vB);cb.cross(ab);cb.normalize();face.normal.copy(cb)}},computeVertexNormals:function(areaWeighted){var v,vl,f,fl,face,vertices;if(this.__tmpVertices===undefined){this.__tmpVertices=new Array(this.vertices.length);vertices=this.__tmpVertices;for(v=0,vl=this.vertices.length;v<vl;v++){vertices[v]=new THREE.Vector3}for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];if(face instanceof THREE.Face3){face.vertexNormals=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3]}else if(face instanceof THREE.Face4){face.vertexNormals=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3]}}}else{vertices=this.__tmpVertices;for(v=0,vl=this.vertices.length;v<vl;v++){vertices[v].set(0,0,0)}}if(areaWeighted){var vA,vB,vC,vD;var cb=new THREE.Vector3,ab=new THREE.Vector3,db=new THREE.Vector3,dc=new THREE.Vector3,bc=new THREE.Vector3;for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];if(face instanceof THREE.Face3){vA=this.vertices[face.a];vB=this.vertices[face.b];vC=this.vertices[face.c];cb.subVectors(vC,vB);ab.subVectors(vA,vB);cb.cross(ab);vertices[face.a].add(cb);vertices[face.b].add(cb);vertices[face.c].add(cb)}else if(face instanceof THREE.Face4){vA=this.vertices[face.a];vB=this.vertices[face.b];vC=this.vertices[face.c];vD=this.vertices[face.d];db.subVectors(vD,vB);ab.subVectors(vA,vB);db.cross(ab);vertices[face.a].add(db);vertices[face.b].add(db);vertices[face.d].add(db);dc.subVectors(vD,vC);bc.subVectors(vB,vC);dc.cross(bc);vertices[face.b].add(dc);vertices[face.c].add(dc);vertices[face.d].add(dc)}}}else{for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];if(face instanceof THREE.Face3){vertices[face.a].add(face.normal);vertices[face.b].add(face.normal);vertices[face.c].add(face.normal)}else if(face instanceof THREE.Face4){vertices[face.a].add(face.normal);vertices[face.b].add(face.normal);vertices[face.c].add(face.normal);vertices[face.d].add(face.normal)}}}for(v=0,vl=this.vertices.length;v<vl;v++){vertices[v].normalize()}for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];if(face instanceof THREE.Face3){face.vertexNormals[0].copy(vertices[face.a]);face.vertexNormals[1].copy(vertices[face.b]);face.vertexNormals[2].copy(vertices[face.c])}else if(face instanceof THREE.Face4){face.vertexNormals[0].copy(vertices[face.a]);face.vertexNormals[1].copy(vertices[face.b]);face.vertexNormals[2].copy(vertices[face.c]);face.vertexNormals[3].copy(vertices[face.d])}}},computeMorphNormals:function(){var i,il,f,fl,face;for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];if(!face.__originalFaceNormal){face.__originalFaceNormal=face.normal.clone()}else{face.__originalFaceNormal.copy(face.normal)}if(!face.__originalVertexNormals)face.__originalVertexNormals=[];for(i=0,il=face.vertexNormals.length;i<il;i++){if(!face.__originalVertexNormals[i]){face.__originalVertexNormals[i]=face.vertexNormals[i].clone()}else{face.__originalVertexNormals[i].copy(face.vertexNormals[i])}}}var tmpGeo=new THREE.Geometry;tmpGeo.faces=this.faces;for(i=0,il=this.morphTargets.length;i<il;i++){if(!this.morphNormals[i]){this.morphNormals[i]={};this.morphNormals[i].faceNormals=[];this.morphNormals[i].vertexNormals=[];var dstNormalsFace=this.morphNormals[i].faceNormals;var dstNormalsVertex=this.morphNormals[i].vertexNormals;var faceNormal,vertexNormals;for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];faceNormal=new THREE.Vector3;if(face instanceof THREE.Face3){vertexNormals={a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3}}else{vertexNormals={a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3,d:new THREE.Vector3}}dstNormalsFace.push(faceNormal);dstNormalsVertex.push(vertexNormals)}}var morphNormals=this.morphNormals[i];tmpGeo.vertices=this.morphTargets[i].vertices;tmpGeo.computeFaceNormals();tmpGeo.computeVertexNormals();var faceNormal,vertexNormals;for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];faceNormal=morphNormals.faceNormals[f];vertexNormals=morphNormals.vertexNormals[f];faceNormal.copy(face.normal);if(face instanceof THREE.Face3){vertexNormals.a.copy(face.vertexNormals[0]);vertexNormals.b.copy(face.vertexNormals[1]);vertexNormals.c.copy(face.vertexNormals[2])}else{vertexNormals.a.copy(face.vertexNormals[0]);vertexNormals.b.copy(face.vertexNormals[1]);vertexNormals.c.copy(face.vertexNormals[2]);vertexNormals.d.copy(face.vertexNormals[3])}}}for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];face.normal=face.__originalFaceNormal;face.vertexNormals=face.__originalVertexNormals}},computeTangents:function(){var f,fl,v,vl,i,il,vertexIndex,face,uv,vA,vB,vC,uvA,uvB,uvC,x1,x2,y1,y2,z1,z2,s1,s2,t1,t2,r,t,test,tan1=[],tan2=[],sdir=new THREE.Vector3,tdir=new THREE.Vector3,tmp=new THREE.Vector3,tmp2=new THREE.Vector3,n=new THREE.Vector3,w;for(v=0,vl=this.vertices.length;v<vl;v++){tan1[v]=new THREE.Vector3;tan2[v]=new THREE.Vector3}function handleTriangle(context,a,b,c,ua,ub,uc){vA=context.vertices[a];vB=context.vertices[b];vC=context.vertices[c];uvA=uv[ua];uvB=uv[ub];uvC=uv[uc];x1=vB.x-vA.x;x2=vC.x-vA.x;y1=vB.y-vA.y;y2=vC.y-vA.y;z1=vB.z-vA.z;z2=vC.z-vA.z;s1=uvB.x-uvA.x;s2=uvC.x-uvA.x;t1=uvB.y-uvA.y;t2=uvC.y-uvA.y;r=1/(s1*t2-s2*t1);sdir.set((t2*x1-t1*x2)*r,(t2*y1-t1*y2)*r,(t2*z1-t1*z2)*r);tdir.set((s1*x2-s2*x1)*r,(s1*y2-s2*y1)*r,(s1*z2-s2*z1)*r);tan1[a].add(sdir);tan1[b].add(sdir);tan1[c].add(sdir);tan2[a].add(tdir);tan2[b].add(tdir);tan2[c].add(tdir)}for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];uv=this.faceVertexUvs[0][f];if(face instanceof THREE.Face3){handleTriangle(this,face.a,face.b,face.c,0,1,2)}else if(face instanceof THREE.Face4){handleTriangle(this,face.a,face.b,face.d,0,1,3);handleTriangle(this,face.b,face.c,face.d,1,2,3)}}var faceIndex=["a","b","c","d"];for(f=0,fl=this.faces.length;f<fl;f++){face=this.faces[f];for(i=0;i<face.vertexNormals.length;i++){n.copy(face.vertexNormals[i]);vertexIndex=face[faceIndex[i]];t=tan1[vertexIndex];tmp.copy(t);tmp.sub(n.multiplyScalar(n.dot(t))).normalize();tmp2.crossVectors(face.vertexNormals[i],t);test=tmp2.dot(tan2[vertexIndex]);w=test<0?-1:1;face.vertexTangents[i]=new THREE.Vector4(tmp.x,tmp.y,tmp.z,w)}}this.hasTangents=true},computeLineDistances:function(){var d=0;var vertices=this.vertices;for(var i=0,il=vertices.length;i<il;i++){if(i>0){d+=vertices[i].distanceTo(vertices[i-1])}this.lineDistances[i]=d}},computeBoundingBox:function(){if(this.boundingBox===null){this.boundingBox=new THREE.Box3}this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){if(this.boundingSphere===null){this.boundingSphere=new THREE.Sphere}this.boundingSphere.setFromCenterAndPoints(this.boundingSphere.center,this.vertices)},mergeVertices:function(){var verticesMap={};var unique=[],changes=[];var v,key;var precisionPoints=4;var precision=Math.pow(10,precisionPoints);var i,il,face;var indices,k,j,jl,u;this.__tmpVertices=undefined;for(i=0,il=this.vertices.length;i<il;i++){v=this.vertices[i];key=Math.round(v.x*precision)+"_"+Math.round(v.y*precision)+"_"+Math.round(v.z*precision);if(verticesMap[key]===undefined){verticesMap[key]=i;unique.push(this.vertices[i]);changes[i]=unique.length-1}else{changes[i]=changes[verticesMap[key]]}}var faceIndicesToRemove=[];for(i=0,il=this.faces.length;i<il;i++){face=this.faces[i];if(face instanceof THREE.Face3){face.a=changes[face.a];face.b=changes[face.b];face.c=changes[face.c];indices=[face.a,face.b,face.c];var dupIndex=-1;for(var n=0;n<3;n++){if(indices[n]==indices[(n+1)%3]){dupIndex=n;faceIndicesToRemove.push(i);break}}}else if(face instanceof THREE.Face4){face.a=changes[face.a];face.b=changes[face.b];face.c=changes[face.c];face.d=changes[face.d];indices=[face.a,face.b,face.c,face.d];var dupIndex=-1;for(var n=0;n<4;n++){if(indices[n]==indices[(n+1)%4]){if(dupIndex>=0){faceIndicesToRemove.push(i)}dupIndex=n}}if(dupIndex>=0){indices.splice(dupIndex,1);var newFace=new THREE.Face3(indices[0],indices[1],indices[2],face.normal,face.color,face.materialIndex);for(j=0,jl=this.faceVertexUvs.length;j<jl;j++){u=this.faceVertexUvs[j][i];if(u){u.splice(dupIndex,1)}}if(face.vertexNormals&&face.vertexNormals.length>0){newFace.vertexNormals=face.vertexNormals;newFace.vertexNormals.splice(dupIndex,1)}if(face.vertexColors&&face.vertexColors.length>0){newFace.vertexColors=face.vertexColors;newFace.vertexColors.splice(dupIndex,1)}this.faces[i]=newFace}}}for(i=faceIndicesToRemove.length-1;i>=0;i--){this.faces.splice(i,1);for(j=0,jl=this.faceVertexUvs.length;j<jl;j++){this.faceVertexUvs[j].splice(i,1)}}var diff=this.vertices.length-unique.length;this.vertices=unique;return diff},clone:function(){var geometry=new THREE.Geometry;var vertices=this.vertices;for(var i=0,il=vertices.length;i<il;i++){geometry.vertices.push(vertices[i].clone())}var faces=this.faces;for(var i=0,il=faces.length;i<il;i++){geometry.faces.push(faces[i].clone())}var uvs=this.faceVertexUvs[0];for(var i=0,il=uvs.length;i<il;i++){var uv=uvs[i],uvCopy=[];for(var j=0,jl=uv.length;j<jl;j++){uvCopy.push(new THREE.Vector2(uv[j].x,uv[j].y))
}geometry.faceVertexUvs[0].push(uvCopy)}return geometry},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.GeometryIdCount=0;THREE.BufferGeometry=function(){this.id=THREE.GeometryIdCount++;this.attributes={};this.dynamic=false;this.offsets=[];this.boundingBox=null;this.boundingSphere=null;this.hasTangents=false;this.morphTargets=[]};THREE.BufferGeometry.prototype={constructor:THREE.BufferGeometry,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,applyMatrix:function(matrix){var positionArray;var normalArray;if(this.attributes["position"])positionArray=this.attributes["position"].array;if(this.attributes["normal"])normalArray=this.attributes["normal"].array;if(positionArray!==undefined){matrix.multiplyVector3Array(positionArray);this.verticesNeedUpdate=true}if(normalArray!==undefined){var normalMatrix=(new THREE.Matrix3).getNormalMatrix(matrix);normalMatrix.multiplyVector3Array(normalArray);this.normalizeNormals();this.normalsNeedUpdate=true}},computeBoundingBox:function(){if(this.boundingBox===null){this.boundingBox=new THREE.Box3}var positions=this.attributes["position"].array;if(positions){var bb=this.boundingBox;var x,y,z;if(positions.length>=3){bb.min.x=bb.max.x=positions[0];bb.min.y=bb.max.y=positions[1];bb.min.z=bb.max.z=positions[2]}for(var i=3,il=positions.length;i<il;i+=3){x=positions[i];y=positions[i+1];z=positions[i+2];if(x<bb.min.x){bb.min.x=x}else if(x>bb.max.x){bb.max.x=x}if(y<bb.min.y){bb.min.y=y}else if(y>bb.max.y){bb.max.y=y}if(z<bb.min.z){bb.min.z=z}else if(z>bb.max.z){bb.max.z=z}}}if(positions===undefined||positions.length===0){this.boundingBox.min.set(0,0,0);this.boundingBox.max.set(0,0,0)}},computeBoundingSphere:function(){if(this.boundingSphere===null){this.boundingSphere=new THREE.Sphere}var positions=this.attributes["position"].array;if(positions){var radiusSq,maxRadiusSq=0;var x,y,z;for(var i=0,il=positions.length;i<il;i+=3){x=positions[i];y=positions[i+1];z=positions[i+2];radiusSq=x*x+y*y+z*z;if(radiusSq>maxRadiusSq)maxRadiusSq=radiusSq}this.boundingSphere.radius=Math.sqrt(maxRadiusSq)}},computeVertexNormals:function(){if(this.attributes["position"]){var i,il;var j,jl;var nVertexElements=this.attributes["position"].array.length;if(this.attributes["normal"]===undefined){this.attributes["normal"]={itemSize:3,array:new Float32Array(nVertexElements),numItems:nVertexElements}}else{for(i=0,il=this.attributes["normal"].array.length;i<il;i++){this.attributes["normal"].array[i]=0}}var positions=this.attributes["position"].array;var normals=this.attributes["normal"].array;var vA,vB,vC,x,y,z,pA=new THREE.Vector3,pB=new THREE.Vector3,pC=new THREE.Vector3,cb=new THREE.Vector3,ab=new THREE.Vector3;if(this.attributes["index"]){var indices=this.attributes["index"].array;var offsets=this.offsets;for(j=0,jl=offsets.length;j<jl;++j){var start=offsets[j].start;var count=offsets[j].count;var index=offsets[j].index;for(i=start,il=start+count;i<il;i+=3){vA=index+indices[i];vB=index+indices[i+1];vC=index+indices[i+2];x=positions[vA*3];y=positions[vA*3+1];z=positions[vA*3+2];pA.set(x,y,z);x=positions[vB*3];y=positions[vB*3+1];z=positions[vB*3+2];pB.set(x,y,z);x=positions[vC*3];y=positions[vC*3+1];z=positions[vC*3+2];pC.set(x,y,z);cb.subVectors(pC,pB);ab.subVectors(pA,pB);cb.cross(ab);normals[vA*3]+=cb.x;normals[vA*3+1]+=cb.y;normals[vA*3+2]+=cb.z;normals[vB*3]+=cb.x;normals[vB*3+1]+=cb.y;normals[vB*3+2]+=cb.z;normals[vC*3]+=cb.x;normals[vC*3+1]+=cb.y;normals[vC*3+2]+=cb.z}}}else{for(i=0,il=positions.length;i<il;i+=9){x=positions[i];y=positions[i+1];z=positions[i+2];pA.set(x,y,z);x=positions[i+3];y=positions[i+4];z=positions[i+5];pB.set(x,y,z);x=positions[i+6];y=positions[i+7];z=positions[i+8];pC.set(x,y,z);cb.subVectors(pC,pB);ab.subVectors(pA,pB);cb.cross(ab);normals[i]=cb.x;normals[i+1]=cb.y;normals[i+2]=cb.z;normals[i+3]=cb.x;normals[i+4]=cb.y;normals[i+5]=cb.z;normals[i+6]=cb.x;normals[i+7]=cb.y;normals[i+8]=cb.z}}this.normalizeNormals();this.normalsNeedUpdate=true}},normalizeNormals:function(){var normals=this.attributes["normal"].array;var x,y,z,n;for(var i=0,il=normals.length;i<il;i+=3){x=normals[i];y=normals[i+1];z=normals[i+2];n=1/Math.sqrt(x*x+y*y+z*z);normals[i]*=n;normals[i+1]*=n;normals[i+2]*=n}},computeTangents:function(){if(this.attributes["index"]===undefined||this.attributes["position"]===undefined||this.attributes["normal"]===undefined||this.attributes["uv"]===undefined){console.warn("Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");return}var indices=this.attributes["index"].array;var positions=this.attributes["position"].array;var normals=this.attributes["normal"].array;var uvs=this.attributes["uv"].array;var nVertices=positions.length/3;if(this.attributes["tangent"]===undefined){var nTangentElements=4*nVertices;this.attributes["tangent"]={itemSize:4,array:new Float32Array(nTangentElements),numItems:nTangentElements}}var tangents=this.attributes["tangent"].array;var tan1=[],tan2=[];for(var k=0;k<nVertices;k++){tan1[k]=new THREE.Vector3;tan2[k]=new THREE.Vector3}var xA,yA,zA,xB,yB,zB,xC,yC,zC,uA,vA,uB,vB,uC,vC,x1,x2,y1,y2,z1,z2,s1,s2,t1,t2,r;var sdir=new THREE.Vector3,tdir=new THREE.Vector3;function handleTriangle(a,b,c){xA=positions[a*3];yA=positions[a*3+1];zA=positions[a*3+2];xB=positions[b*3];yB=positions[b*3+1];zB=positions[b*3+2];xC=positions[c*3];yC=positions[c*3+1];zC=positions[c*3+2];uA=uvs[a*2];vA=uvs[a*2+1];uB=uvs[b*2];vB=uvs[b*2+1];uC=uvs[c*2];vC=uvs[c*2+1];x1=xB-xA;x2=xC-xA;y1=yB-yA;y2=yC-yA;z1=zB-zA;z2=zC-zA;s1=uB-uA;s2=uC-uA;t1=vB-vA;t2=vC-vA;r=1/(s1*t2-s2*t1);sdir.set((t2*x1-t1*x2)*r,(t2*y1-t1*y2)*r,(t2*z1-t1*z2)*r);tdir.set((s1*x2-s2*x1)*r,(s1*y2-s2*y1)*r,(s1*z2-s2*z1)*r);tan1[a].add(sdir);tan1[b].add(sdir);tan1[c].add(sdir);tan2[a].add(tdir);tan2[b].add(tdir);tan2[c].add(tdir)}var i,il;var j,jl;var iA,iB,iC;var offsets=this.offsets;for(j=0,jl=offsets.length;j<jl;++j){var start=offsets[j].start;var count=offsets[j].count;var index=offsets[j].index;for(i=start,il=start+count;i<il;i+=3){iA=index+indices[i];iB=index+indices[i+1];iC=index+indices[i+2];handleTriangle(iA,iB,iC)}}var tmp=new THREE.Vector3,tmp2=new THREE.Vector3;var n=new THREE.Vector3,n2=new THREE.Vector3;var w,t,test;function handleVertex(v){n.x=normals[v*3];n.y=normals[v*3+1];n.z=normals[v*3+2];n2.copy(n);t=tan1[v];tmp.copy(t);tmp.sub(n.multiplyScalar(n.dot(t))).normalize();tmp2.crossVectors(n2,t);test=tmp2.dot(tan2[v]);w=test<0?-1:1;tangents[v*4]=tmp.x;tangents[v*4+1]=tmp.y;tangents[v*4+2]=tmp.z;tangents[v*4+3]=w}for(j=0,jl=offsets.length;j<jl;++j){var start=offsets[j].start;var count=offsets[j].count;var index=offsets[j].index;for(i=start,il=start+count;i<il;i+=3){iA=index+indices[i];iB=index+indices[i+1];iC=index+indices[i+2];handleVertex(iA);handleVertex(iB);handleVertex(iC)}}this.hasTangents=true;this.tangentsNeedUpdate=true},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.Camera=function(){THREE.Object3D.call(this);this.matrixWorldInverse=new THREE.Matrix4;this.projectionMatrix=new THREE.Matrix4;this.projectionMatrixInverse=new THREE.Matrix4};THREE.Camera.prototype=Object.create(THREE.Object3D.prototype);THREE.Camera.prototype.lookAt=function(){var m1=new THREE.Matrix4;return function(vector){m1.lookAt(this.position,vector,this.up);if(this.useQuaternion===true){this.quaternion.setFromRotationMatrix(m1)}else{this.rotation.setEulerFromRotationMatrix(m1,this.eulerOrder)}}}();THREE.OrthographicCamera=function(left,right,top,bottom,near,far){THREE.Camera.call(this);this.left=left;this.right=right;this.top=top;this.bottom=bottom;this.near=near!==undefined?near:.1;this.far=far!==undefined?far:2e3;this.updateProjectionMatrix()};THREE.OrthographicCamera.prototype=Object.create(THREE.Camera.prototype);THREE.OrthographicCamera.prototype.updateProjectionMatrix=function(){this.projectionMatrix.makeOrthographic(this.left,this.right,this.top,this.bottom,this.near,this.far)};THREE.PerspectiveCamera=function(fov,aspect,near,far){THREE.Camera.call(this);this.fov=fov!==undefined?fov:50;this.aspect=aspect!==undefined?aspect:1;this.near=near!==undefined?near:.1;this.far=far!==undefined?far:2e3;this.updateProjectionMatrix()};THREE.PerspectiveCamera.prototype=Object.create(THREE.Camera.prototype);THREE.PerspectiveCamera.prototype.setLens=function(focalLength,frameHeight){if(frameHeight===undefined)frameHeight=24;this.fov=2*THREE.Math.radToDeg(Math.atan(frameHeight/(focalLength*2)));this.updateProjectionMatrix()};THREE.PerspectiveCamera.prototype.setViewOffset=function(fullWidth,fullHeight,x,y,width,height){this.fullWidth=fullWidth;this.fullHeight=fullHeight;this.x=x;this.y=y;this.width=width;this.height=height;this.updateProjectionMatrix()};THREE.PerspectiveCamera.prototype.updateProjectionMatrix=function(){if(this.fullWidth){var aspect=this.fullWidth/this.fullHeight;var top=Math.tan(THREE.Math.degToRad(this.fov*.5))*this.near;var bottom=-top;var left=aspect*bottom;var right=aspect*top;var width=Math.abs(right-left);var height=Math.abs(top-bottom);this.projectionMatrix.makeFrustum(left+this.x*width/this.fullWidth,left+(this.x+this.width)*width/this.fullWidth,top-(this.y+this.height)*height/this.fullHeight,top-this.y*height/this.fullHeight,this.near,this.far)}else{this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far)}};THREE.Light=function(hex){THREE.Object3D.call(this);this.color=new THREE.Color(hex)};THREE.Light.prototype=Object.create(THREE.Object3D.prototype);THREE.Light.prototype.clone=function(light){if(light===undefined)light=new THREE.Light;THREE.Object3D.prototype.clone.call(this,light);light.color.copy(this.color);return light};THREE.AmbientLight=function(hex){THREE.Light.call(this,hex)};THREE.AmbientLight.prototype=Object.create(THREE.Light.prototype);THREE.AmbientLight.prototype.clone=function(){var light=new THREE.AmbientLight;THREE.Light.prototype.clone.call(this,light);return light};THREE.AreaLight=function(hex,intensity){THREE.Light.call(this,hex);this.normal=new THREE.Vector3(0,-1,0);this.right=new THREE.Vector3(1,0,0);this.intensity=intensity!==undefined?intensity:1;this.width=1;this.height=1;this.constantAttenuation=1.5;this.linearAttenuation=.5;this.quadraticAttenuation=.1};THREE.AreaLight.prototype=Object.create(THREE.Light.prototype);THREE.DirectionalLight=function(hex,intensity){THREE.Light.call(this,hex);this.position.set(0,1,0);this.target=new THREE.Object3D;this.intensity=intensity!==undefined?intensity:1;this.castShadow=false;this.onlyShadow=false;this.shadowCameraNear=50;this.shadowCameraFar=5e3;this.shadowCameraLeft=-500;this.shadowCameraRight=500;this.shadowCameraTop=500;this.shadowCameraBottom=-500;this.shadowCameraVisible=false;this.shadowBias=0;this.shadowDarkness=.5;this.shadowMapWidth=512;this.shadowMapHeight=512;this.shadowCascade=false;this.shadowCascadeOffset=new THREE.Vector3(0,0,-1e3);this.shadowCascadeCount=2;this.shadowCascadeBias=[0,0,0];this.shadowCascadeWidth=[512,512,512];this.shadowCascadeHeight=[512,512,512];this.shadowCascadeNearZ=[-1,.99,.998];this.shadowCascadeFarZ=[.99,.998,1];this.shadowCascadeArray=[];this.shadowMap=null;this.shadowMapSize=null;this.shadowCamera=null;this.shadowMatrix=null};THREE.DirectionalLight.prototype=Object.create(THREE.Light.prototype);THREE.DirectionalLight.prototype.clone=function(){var light=new THREE.DirectionalLight;THREE.Light.prototype.clone.call(this,light);light.target=this.target.clone();light.intensity=this.intensity;light.castShadow=this.castShadow;light.onlyShadow=this.onlyShadow;return light};THREE.HemisphereLight=function(skyColorHex,groundColorHex,intensity){THREE.Light.call(this,skyColorHex);this.position.set(0,100,0);this.groundColor=new THREE.Color(groundColorHex);this.intensity=intensity!==undefined?intensity:1};THREE.HemisphereLight.prototype=Object.create(THREE.Light.prototype);THREE.HemisphereLight.prototype.clone=function(){var light=new THREE.PointLight;THREE.Light.prototype.clone.call(this,light);light.groundColor.copy(this.groundColor);light.intensity=this.intensity;return light};THREE.PointLight=function(hex,intensity,distance){THREE.Light.call(this,hex);this.intensity=intensity!==undefined?intensity:1;this.distance=distance!==undefined?distance:0};THREE.PointLight.prototype=Object.create(THREE.Light.prototype);THREE.PointLight.prototype.clone=function(){var light=new THREE.PointLight;THREE.Light.prototype.clone.call(this,light);light.intensity=this.intensity;light.distance=this.distance;return light};THREE.SpotLight=function(hex,intensity,distance,angle,exponent){THREE.Light.call(this,hex);this.position.set(0,1,0);this.target=new THREE.Object3D;this.intensity=intensity!==undefined?intensity:1;this.distance=distance!==undefined?distance:0;this.angle=angle!==undefined?angle:Math.PI/3;this.exponent=exponent!==undefined?exponent:10;this.castShadow=false;this.onlyShadow=false;this.shadowCameraNear=50;this.shadowCameraFar=5e3;this.shadowCameraFov=50;this.shadowCameraVisible=false;this.shadowBias=0;this.shadowDarkness=.5;this.shadowMapWidth=512;this.shadowMapHeight=512;this.shadowMap=null;this.shadowMapSize=null;this.shadowCamera=null;this.shadowMatrix=null};THREE.SpotLight.prototype=Object.create(THREE.Light.prototype);THREE.SpotLight.prototype.clone=function(){var light=new THREE.SpotLight;THREE.Light.prototype.clone.call(this,light);light.target=this.target.clone();light.intensity=this.intensity;light.distance=this.distance;light.angle=this.angle;light.exponent=this.exponent;light.castShadow=this.castShadow;light.onlyShadow=this.onlyShadow;return light};THREE.Loader=function(showStatus){this.showStatus=showStatus;this.statusDomElement=showStatus?THREE.Loader.prototype.addStatusElement():null;this.onLoadStart=function(){};this.onLoadProgress=function(){};this.onLoadComplete=function(){}};THREE.Loader.prototype={constructor:THREE.Loader,crossOrigin:"anonymous",addStatusElement:function(){var e=document.createElement("div");e.style.position="absolute";e.style.right="0px";e.style.top="0px";e.style.fontSize="0.8em";e.style.textAlign="left";e.style.background="rgba(0,0,0,0.25)";e.style.color="#fff";e.style.width="120px";e.style.padding="0.5em 0.5em 0.5em 0.5em";e.style.zIndex=1e3;e.innerHTML="Loading ...";return e},updateProgress:function(progress){var message="Loaded ";if(progress.total){message+=(100*progress.loaded/progress.total).toFixed(0)+"%"}else{message+=(progress.loaded/1e3).toFixed(2)+" KB"}this.statusDomElement.innerHTML=message},extractUrlBase:function(url){var parts=url.split("/");parts.pop();return(parts.length<1?".":parts.join("/"))+"/"},initMaterials:function(materials,texturePath){var array=[];for(var i=0;i<materials.length;++i){array[i]=THREE.Loader.prototype.createMaterial(materials[i],texturePath)}return array},needsTangents:function(materials){for(var i=0,il=materials.length;i<il;i++){var m=materials[i];if(m instanceof THREE.ShaderMaterial)return true}return false},createMaterial:function(m,texturePath){var _this=this;function is_pow2(n){var l=Math.log(n)/Math.LN2;return Math.floor(l)==l}function nearest_pow2(n){var l=Math.log(n)/Math.LN2;return Math.pow(2,Math.round(l))}function load_image(where,url){var image=new Image;image.onload=function(){if(!is_pow2(this.width)||!is_pow2(this.height)){var width=nearest_pow2(this.width);var height=nearest_pow2(this.height);where.image.width=width;where.image.height=height;where.image.getContext("2d").drawImage(this,0,0,width,height)}else{where.image=this}where.needsUpdate=true};image.crossOrigin=_this.crossOrigin;image.src=url}function create_texture(where,name,sourceFile,repeat,offset,wrap,anisotropy){var isCompressed=/\.dds$/i.test(sourceFile);var fullPath=texturePath+"/"+sourceFile;if(isCompressed){var texture=THREE.ImageUtils.loadCompressedTexture(fullPath);where[name]=texture}else{var texture=document.createElement("canvas");where[name]=new THREE.Texture(texture)}where[name].sourceFile=sourceFile;if(repeat){where[name].repeat.set(repeat[0],repeat[1]);if(repeat[0]!==1)where[name].wrapS=THREE.RepeatWrapping;if(repeat[1]!==1)where[name].wrapT=THREE.RepeatWrapping}if(offset){where[name].offset.set(offset[0],offset[1])}if(wrap){var wrapMap={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};if(wrapMap[wrap[0]]!==undefined)where[name].wrapS=wrapMap[wrap[0]];if(wrapMap[wrap[1]]!==undefined)where[name].wrapT=wrapMap[wrap[1]]}if(anisotropy){where[name].anisotropy=anisotropy}if(!isCompressed){load_image(where[name],fullPath)}}function rgb2hex(rgb){return(rgb[0]*255<<16)+(rgb[1]*255<<8)+rgb[2]*255}var mtype="MeshLambertMaterial";var mpars={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,bumpMap:null,wireframe:false};if(m.shading){var shading=m.shading.toLowerCase();if(shading==="phong")mtype="MeshPhongMaterial";else if(shading==="basic")mtype="MeshBasicMaterial"}if(m.blending!==undefined&&THREE[m.blending]!==undefined){mpars.blending=THREE[m.blending]}if(m.transparent!==undefined||m.opacity<1){mpars.transparent=m.transparent}if(m.depthTest!==undefined){mpars.depthTest=m.depthTest}if(m.depthWrite!==undefined){mpars.depthWrite=m.depthWrite}if(m.visible!==undefined){mpars.visible=m.visible}if(m.flipSided!==undefined){mpars.side=THREE.BackSide}if(m.doubleSided!==undefined){mpars.side=THREE.DoubleSide}if(m.wireframe!==undefined){mpars.wireframe=m.wireframe}if(m.vertexColors!==undefined){if(m.vertexColors==="face"){mpars.vertexColors=THREE.FaceColors}else if(m.vertexColors){mpars.vertexColors=THREE.VertexColors}}if(m.colorDiffuse){mpars.color=rgb2hex(m.colorDiffuse)}else if(m.DbgColor){mpars.color=m.DbgColor}if(m.colorSpecular){mpars.specular=rgb2hex(m.colorSpecular)}if(m.colorAmbient){mpars.ambient=rgb2hex(m.colorAmbient)}if(m.transparency){mpars.opacity=m.transparency}if(m.specularCoef){mpars.shininess=m.specularCoef}if(m.mapDiffuse&&texturePath){create_texture(mpars,"map",m.mapDiffuse,m.mapDiffuseRepeat,m.mapDiffuseOffset,m.mapDiffuseWrap,m.mapDiffuseAnisotropy)}if(m.mapLight&&texturePath){create_texture(mpars,"lightMap",m.mapLight,m.mapLightRepeat,m.mapLightOffset,m.mapLightWrap,m.mapLightAnisotropy)}if(m.mapBump&&texturePath){create_texture(mpars,"bumpMap",m.mapBump,m.mapBumpRepeat,m.mapBumpOffset,m.mapBumpWrap,m.mapBumpAnisotropy)}if(m.mapNormal&&texturePath){create_texture(mpars,"normalMap",m.mapNormal,m.mapNormalRepeat,m.mapNormalOffset,m.mapNormalWrap,m.mapNormalAnisotropy)}if(m.mapSpecular&&texturePath){create_texture(mpars,"specularMap",m.mapSpecular,m.mapSpecularRepeat,m.mapSpecularOffset,m.mapSpecularWrap,m.mapSpecularAnisotropy)}if(m.mapBumpScale){mpars.bumpScale=m.mapBumpScale}if(m.mapNormal){var shader=THREE.ShaderLib["normalmap"];var uniforms=THREE.UniformsUtils.clone(shader.uniforms);uniforms["tNormal"].value=mpars.normalMap;if(m.mapNormalFactor){uniforms["uNormalScale"].value.set(m.mapNormalFactor,m.mapNormalFactor)}if(mpars.map){uniforms["tDiffuse"].value=mpars.map;uniforms["enableDiffuse"].value=true}if(mpars.specularMap){uniforms["tSpecular"].value=mpars.specularMap;uniforms["enableSpecular"].value=true}if(mpars.lightMap){uniforms["tAO"].value=mpars.lightMap;uniforms["enableAO"].value=true}uniforms["uDiffuseColor"].value.setHex(mpars.color);uniforms["uSpecularColor"].value.setHex(mpars.specular);uniforms["uAmbientColor"].value.setHex(mpars.ambient);uniforms["uShininess"].value=mpars.shininess;if(mpars.opacity!==undefined){uniforms["uOpacity"].value=mpars.opacity}var parameters={fragmentShader:shader.fragmentShader,vertexShader:shader.vertexShader,uniforms:uniforms,lights:true,fog:true};var material=new THREE.ShaderMaterial(parameters);if(mpars.transparent){material.transparent=true}}else{var material=new THREE[mtype](mpars)}if(m.DbgName!==undefined)material.name=m.DbgName;return material}};THREE.ImageLoader=function(){this.crossOrigin=null};THREE.ImageLoader.prototype={constructor:THREE.ImageLoader,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,load:function(url,image){var scope=this;if(image===undefined)image=new Image;image.addEventListener("load",function(){scope.dispatchEvent({type:"load",content:image})},false);image.addEventListener("error",function(){scope.dispatchEvent({type:"error",message:"Couldn't load URL ["+url+"]"})},false);if(scope.crossOrigin)image.crossOrigin=scope.crossOrigin;image.src=url}};THREE.JSONLoader=function(showStatus){THREE.Loader.call(this,showStatus);this.withCredentials=false};THREE.JSONLoader.prototype=Object.create(THREE.Loader.prototype);THREE.JSONLoader.prototype.load=function(url,callback,texturePath){var scope=this;texturePath=texturePath&&typeof texturePath==="string"?texturePath:this.extractUrlBase(url);this.onLoadStart();this.loadAjaxJSON(this,url,callback,texturePath)};THREE.JSONLoader.prototype.loadAjaxJSON=function(context,url,callback,texturePath,callbackProgress){var xhr=new XMLHttpRequest;var length=0;xhr.onreadystatechange=function(){if(xhr.readyState===xhr.DONE){if(xhr.status===200||xhr.status===0){if(xhr.responseText){var json=JSON.parse(xhr.responseText);var result=context.parse(json,texturePath);callback(result.geometry,result.materials)}else{console.warn("THREE.JSONLoader: ["+url+"] seems to be unreachable or file there is empty")}context.onLoadComplete()}else{console.error("THREE.JSONLoader: Couldn't load ["+url+"] ["+xhr.status+"]")}}else if(xhr.readyState===xhr.LOADING){if(callbackProgress){if(length===0){length=xhr.getResponseHeader("Content-Length")}callbackProgress({total:length,loaded:xhr.responseText.length})}}else if(xhr.readyState===xhr.HEADERS_RECEIVED){if(callbackProgress!==undefined){length=xhr.getResponseHeader("Content-Length")}}};xhr.open("GET",url,true);xhr.withCredentials=this.withCredentials;xhr.send(null)};THREE.JSONLoader.prototype.parse=function(json,texturePath){var scope=this,geometry=new THREE.Geometry,scale=json.scale!==undefined?1/json.scale:1;parseModel(scale);parseSkin();parseMorphing(scale);geometry.computeCentroids();geometry.computeFaceNormals();function parseModel(scale){function isBitSet(value,position){return value&1<<position}var i,j,fi,offset,zLength,nVertices,colorIndex,normalIndex,uvIndex,materialIndex,type,isQuad,hasMaterial,hasFaceUv,hasFaceVertexUv,hasFaceNormal,hasFaceVertexNormal,hasFaceColor,hasFaceVertexColor,vertex,face,color,normal,uvLayer,uvs,u,v,faces=json.faces,vertices=json.vertices,normals=json.normals,colors=json.colors,nUvLayers=0;for(i=0;i<json.uvs.length;i++){if(json.uvs[i].length)nUvLayers++}for(i=0;i<nUvLayers;i++){geometry.faceUvs[i]=[];geometry.faceVertexUvs[i]=[]}offset=0;zLength=vertices.length;while(offset<zLength){vertex=new THREE.Vector3;vertex.x=vertices[offset++]*scale;vertex.y=vertices[offset++]*scale;vertex.z=vertices[offset++]*scale;geometry.vertices.push(vertex)}offset=0;zLength=faces.length;while(offset<zLength){type=faces[offset++];isQuad=isBitSet(type,0);hasMaterial=isBitSet(type,1);hasFaceUv=isBitSet(type,2);hasFaceVertexUv=isBitSet(type,3);hasFaceNormal=isBitSet(type,4);hasFaceVertexNormal=isBitSet(type,5);hasFaceColor=isBitSet(type,6);hasFaceVertexColor=isBitSet(type,7);if(isQuad){face=new THREE.Face4;face.a=faces[offset++];face.b=faces[offset++];face.c=faces[offset++];face.d=faces[offset++];nVertices=4}else{face=new THREE.Face3;face.a=faces[offset++];face.b=faces[offset++];face.c=faces[offset++];nVertices=3}if(hasMaterial){materialIndex=faces[offset++];face.materialIndex=materialIndex}fi=geometry.faces.length;if(hasFaceUv){for(i=0;i<nUvLayers;i++){uvLayer=json.uvs[i];uvIndex=faces[offset++];u=uvLayer[uvIndex*2];v=uvLayer[uvIndex*2+1];geometry.faceUvs[i][fi]=new THREE.Vector2(u,v)}}if(hasFaceVertexUv){for(i=0;i<nUvLayers;i++){uvLayer=json.uvs[i];uvs=[];for(j=0;j<nVertices;j++){uvIndex=faces[offset++];u=uvLayer[uvIndex*2];v=uvLayer[uvIndex*2+1];uvs[j]=new THREE.Vector2(u,v)}geometry.faceVertexUvs[i][fi]=uvs}}if(hasFaceNormal){normalIndex=faces[offset++]*3;normal=new THREE.Vector3;normal.x=normals[normalIndex++];normal.y=normals[normalIndex++];normal.z=normals[normalIndex];face.normal=normal}if(hasFaceVertexNormal){for(i=0;i<nVertices;i++){normalIndex=faces[offset++]*3;normal=new THREE.Vector3;normal.x=normals[normalIndex++];normal.y=normals[normalIndex++];normal.z=normals[normalIndex];face.vertexNormals.push(normal)}}if(hasFaceColor){colorIndex=faces[offset++];color=new THREE.Color(colors[colorIndex]);face.color=color}if(hasFaceVertexColor){for(i=0;i<nVertices;i++){colorIndex=faces[offset++];color=new THREE.Color(colors[colorIndex]);face.vertexColors.push(color)}}geometry.faces.push(face)}}function parseSkin(){var i,l,x,y,z,w,a,b,c,d;if(json.skinWeights){for(i=0,l=json.skinWeights.length;i<l;i+=2){x=json.skinWeights[i];y=json.skinWeights[i+1];z=0;w=0;geometry.skinWeights.push(new THREE.Vector4(x,y,z,w))}}if(json.skinIndices){for(i=0,l=json.skinIndices.length;i<l;i+=2){a=json.skinIndices[i];b=json.skinIndices[i+1];c=0;d=0;geometry.skinIndices.push(new THREE.Vector4(a,b,c,d))}}geometry.bones=json.bones;geometry.animation=json.animation}function parseMorphing(scale){if(json.morphTargets!==undefined){var i,l,v,vl,dstVertices,srcVertices;for(i=0,l=json.morphTargets.length;i<l;i++){geometry.morphTargets[i]={};geometry.morphTargets[i].name=json.morphTargets[i].name;geometry.morphTargets[i].vertices=[];dstVertices=geometry.morphTargets[i].vertices;srcVertices=json.morphTargets[i].vertices;for(v=0,vl=srcVertices.length;v<vl;v+=3){var vertex=new THREE.Vector3;vertex.x=srcVertices[v]*scale;vertex.y=srcVertices[v+1]*scale;vertex.z=srcVertices[v+2]*scale;dstVertices.push(vertex)}}}if(json.morphColors!==undefined){var i,l,c,cl,dstColors,srcColors,color;for(i=0,l=json.morphColors.length;i<l;i++){geometry.morphColors[i]={};geometry.morphColors[i].name=json.morphColors[i].name;geometry.morphColors[i].colors=[];dstColors=geometry.morphColors[i].colors;srcColors=json.morphColors[i].colors;for(c=0,cl=srcColors.length;c<cl;c+=3){color=new THREE.Color(16755200);color.setRGB(srcColors[c],srcColors[c+1],srcColors[c+2]);dstColors.push(color)}}}}if(json.materials===undefined){return{geometry:geometry}}else{var materials=this.initMaterials(json.materials,texturePath);if(this.needsTangents(materials)){geometry.computeTangents()}return{geometry:geometry,materials:materials}}};THREE.LoadingMonitor=function(){var scope=this;var loaded=0;var total=0;var onLoad=function(event){loaded++;scope.dispatchEvent({type:"progress",loaded:loaded,total:total});if(loaded===total){scope.dispatchEvent({type:"load"})}};this.add=function(loader){total++;loader.addEventListener("load",onLoad,false)}};THREE.LoadingMonitor.prototype={constructor:THREE.LoadingMonitor,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent};THREE.GeometryLoader=function(){};THREE.GeometryLoader.prototype={constructor:THREE.GeometryLoader,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,load:function(url){var scope=this;var request=new XMLHttpRequest;request.addEventListener("load",function(event){var response=scope.parse(JSON.parse(event.target.responseText));scope.dispatchEvent({type:"load",content:response})},false);request.addEventListener("progress",function(event){scope.dispatchEvent({type:"progress",loaded:event.loaded,total:event.total})},false);request.addEventListener("error",function(){scope.dispatchEvent({type:"error",message:"Couldn't load URL ["+url+"]"})},false);request.open("GET",url,true);request.send(null)},parse:function(json){}};THREE.MaterialLoader=function(){};THREE.MaterialLoader.prototype={constructor:THREE.MaterialLoader,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,load:function(url){var scope=this;var request=new XMLHttpRequest;request.addEventListener("load",function(event){var response=scope.parse(JSON.parse(event.target.responseText));scope.dispatchEvent({type:"load",content:response})},false);request.addEventListener("progress",function(event){scope.dispatchEvent({type:"progress",loaded:event.loaded,total:event.total})},false);request.addEventListener("error",function(){scope.dispatchEvent({type:"error",message:"Couldn't load URL ["+url+"]"})},false);request.open("GET",url,true);request.send(null)},parse:function(json){var material;switch(json.type){case"MeshBasicMaterial":material=new THREE.MeshBasicMaterial({color:json.color,opacity:json.opacity,transparent:json.transparent,wireframe:json.wireframe});break;case"MeshLambertMaterial":material=new THREE.MeshLambertMaterial({color:json.color,ambient:json.ambient,emissive:json.emissive,opacity:json.opacity,transparent:json.transparent,wireframe:json.wireframe});break;case"MeshPhongMaterial":material=new THREE.MeshPhongMaterial({color:json.color,ambient:json.ambient,emissive:json.emissive,specular:json.specular,shininess:json.shininess,opacity:json.opacity,transparent:json.transparent,wireframe:json.wireframe});break;case"MeshNormalMaterial":material=new THREE.MeshNormalMaterial({opacity:json.opacity,transparent:json.transparent,wireframe:json.wireframe});break;case"MeshDepthMaterial":material=new THREE.MeshDepthMaterial({opacity:json.opacity,transparent:json.transparent,wireframe:json.wireframe});break}return material}};THREE.SceneLoader=function(){this.onLoadStart=function(){};this.onLoadProgress=function(){};this.onLoadComplete=function(){};this.callbackSync=function(){};this.callbackProgress=function(){};this.geometryHandlerMap={};this.hierarchyHandlerMap={};this.addGeometryHandler("ascii",THREE.JSONLoader)};THREE.SceneLoader.prototype.constructor=THREE.SceneLoader;THREE.SceneLoader.prototype.load=function(url,callbackFinished){var scope=this;var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200||xhr.status===0){var json=JSON.parse(xhr.responseText);scope.parse(json,callbackFinished,url)}else{console.error("THREE.SceneLoader: Couldn't load ["+url+"] ["+xhr.status+"]")}}};xhr.open("GET",url,true);xhr.send(null)};THREE.SceneLoader.prototype.addGeometryHandler=function(typeID,loaderClass){this.geometryHandlerMap[typeID]={loaderClass:loaderClass}};THREE.SceneLoader.prototype.addHierarchyHandler=function(typeID,loaderClass){this.hierarchyHandlerMap[typeID]={loaderClass:loaderClass}};THREE.SceneLoader.prototype.parse=function(json,callbackFinished,url){var scope=this;var urlBase=THREE.Loader.prototype.extractUrlBase(url);var geometry,material,camera,fog,texture,images,color,light,hex,intensity,counter_models,counter_textures,total_models,total_textures,result;var target_array=[];var data=json;for(var typeID in this.geometryHandlerMap){var loaderClass=this.geometryHandlerMap[typeID]["loaderClass"];this.geometryHandlerMap[typeID]["loaderObject"]=new loaderClass}for(var typeID in this.hierarchyHandlerMap){var loaderClass=this.hierarchyHandlerMap[typeID]["loaderClass"];this.hierarchyHandlerMap[typeID]["loaderObject"]=new loaderClass}counter_models=0;counter_textures=0;result={scene:new THREE.Scene,geometries:{},face_materials:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},empties:{},groups:{}};if(data.transform){var position=data.transform.position,rotation=data.transform.rotation,scale=data.transform.scale;if(position){result.scene.position.fromArray(position)
}if(rotation){result.scene.rotation.fromArray(rotation)}if(scale){result.scene.scale.fromArray(scale)}if(position||rotation||scale){result.scene.updateMatrix();result.scene.updateMatrixWorld()}}function get_url(source_url,url_type){if(url_type=="relativeToHTML"){return source_url}else{return urlBase+"/"+source_url}}function handle_objects(){handle_children(result.scene,data.objects)}function handle_children(parent,children){var mat,dst,pos,rot,scl,quat;for(var objID in children){var object=result.objects[objID];var objJSON=children[objID];if(object===undefined){if(objJSON.type&&objJSON.type in scope.hierarchyHandlerMap){if(objJSON.loading===undefined){var reservedTypes={type:1,url:1,material:1,position:1,rotation:1,scale:1,visible:1,children:1,userData:1,skin:1,morph:1,mirroredLoop:1,duration:1};var loaderParameters={};for(var parType in objJSON){if(!(parType in reservedTypes)){loaderParameters[parType]=objJSON[parType]}}material=result.materials[objJSON.material];objJSON.loading=true;var loader=scope.hierarchyHandlerMap[objJSON.type]["loaderObject"];if(loader.options){loader.load(get_url(objJSON.url,data.urlBaseType),create_callback_hierachy(objID,parent,material,objJSON))}else{loader.load(get_url(objJSON.url,data.urlBaseType),create_callback_hierachy(objID,parent,material,objJSON),loaderParameters)}}}else if(objJSON.geometry!==undefined){geometry=result.geometries[objJSON.geometry];if(geometry){var needsTangents=false;material=result.materials[objJSON.material];needsTangents=material instanceof THREE.ShaderMaterial;pos=objJSON.position;rot=objJSON.rotation;scl=objJSON.scale;mat=objJSON.matrix;quat=objJSON.quaternion;if(!objJSON.material){material=new THREE.MeshFaceMaterial(result.face_materials[objJSON.geometry])}if(material instanceof THREE.MeshFaceMaterial&&material.materials.length===0){material=new THREE.MeshFaceMaterial(result.face_materials[objJSON.geometry])}if(material instanceof THREE.MeshFaceMaterial){for(var i=0;i<material.materials.length;i++){needsTangents=needsTangents||material.materials[i]instanceof THREE.ShaderMaterial}}if(needsTangents){geometry.computeTangents()}if(objJSON.skin){object=new THREE.SkinnedMesh(geometry,material)}else if(objJSON.morph){object=new THREE.MorphAnimMesh(geometry,material);if(objJSON.duration!==undefined){object.duration=objJSON.duration}if(objJSON.time!==undefined){object.time=objJSON.time}if(objJSON.mirroredLoop!==undefined){object.mirroredLoop=objJSON.mirroredLoop}if(material.morphNormals){geometry.computeMorphNormals()}}else{object=new THREE.Mesh(geometry,material)}object.name=objID;if(mat){object.matrixAutoUpdate=false;object.matrix.set(mat[0],mat[1],mat[2],mat[3],mat[4],mat[5],mat[6],mat[7],mat[8],mat[9],mat[10],mat[11],mat[12],mat[13],mat[14],mat[15])}else{object.position.fromArray(pos);if(quat){object.quaternion.fromArray(quat);object.useQuaternion=true}else{object.rotation.fromArray(rot)}object.scale.fromArray(scl)}object.visible=objJSON.visible;object.castShadow=objJSON.castShadow;object.receiveShadow=objJSON.receiveShadow;parent.add(object);result.objects[objID]=object}}else if(objJSON.type==="DirectionalLight"||objJSON.type==="PointLight"||objJSON.type==="AmbientLight"){hex=objJSON.color!==undefined?objJSON.color:16777215;intensity=objJSON.intensity!==undefined?objJSON.intensity:1;if(objJSON.type==="DirectionalLight"){pos=objJSON.direction;light=new THREE.DirectionalLight(hex,intensity);light.position.fromArray(pos);if(objJSON.target){target_array.push({object:light,targetName:objJSON.target});light.target=null}}else if(objJSON.type==="PointLight"){pos=objJSON.position;dst=objJSON.distance;light=new THREE.PointLight(hex,intensity,dst);light.position.fromArray(pos)}else if(objJSON.type==="AmbientLight"){light=new THREE.AmbientLight(hex)}parent.add(light);light.name=objID;result.lights[objID]=light;result.objects[objID]=light}else if(objJSON.type==="PerspectiveCamera"||objJSON.type==="OrthographicCamera"){pos=objJSON.position;rot=objJSON.rotation;quat=objJSON.quaternion;if(objJSON.type==="PerspectiveCamera"){camera=new THREE.PerspectiveCamera(objJSON.fov,objJSON.aspect,objJSON.near,objJSON.far)}else if(objJSON.type==="OrthographicCamera"){camera=new THREE.OrthographicCamera(objJSON.left,objJSON.right,objJSON.top,objJSON.bottom,objJSON.near,objJSON.far)}camera.name=objID;camera.position.fromArray(pos);if(quat!==undefined){camera.quaternion.fromArray(quat);camera.useQuaternion=true}else if(rot!==undefined){camera.rotation.fromArray(rot)}parent.add(camera);result.cameras[objID]=camera;result.objects[objID]=camera}else{pos=objJSON.position;rot=objJSON.rotation;scl=objJSON.scale;quat=objJSON.quaternion;object=new THREE.Object3D;object.name=objID;object.position.fromArray(pos);if(quat){object.quaternion.fromArray(quat);object.useQuaternion=true}else{object.rotation.fromArray(rot)}object.scale.fromArray(scl);object.visible=objJSON.visible!==undefined?objJSON.visible:false;parent.add(object);result.objects[objID]=object;result.empties[objID]=object}if(object){if(objJSON.userData!==undefined){for(var key in objJSON.userData){var value=objJSON.userData[key];object.userData[key]=value}}if(objJSON.groups!==undefined){for(var i=0;i<objJSON.groups.length;i++){var groupID=objJSON.groups[i];if(result.groups[groupID]===undefined){result.groups[groupID]=[]}result.groups[groupID].push(objID)}}}}if(object!==undefined&&objJSON.children!==undefined){handle_children(object,objJSON.children)}}}function handle_mesh(geo,mat,id){result.geometries[id]=geo;result.face_materials[id]=mat;handle_objects()}function handle_hierarchy(node,id,parent,material,obj){var p=obj.position;var r=obj.rotation;var q=obj.quaternion;var s=obj.scale;node.position.fromArray(p);if(q){node.quaternion.fromArray(q);node.useQuaternion=true}else{node.rotation.fromArray(r)}node.scale.fromArray(s);if(material){node.traverse(function(child){child.material=material})}var visible=obj.visible!==undefined?obj.visible:true;node.traverse(function(child){child.visible=visible});parent.add(node);node.name=id;result.objects[id]=node;handle_objects()}function create_callback_geometry(id){return function(geo,mat){geo.name=id;handle_mesh(geo,mat,id);counter_models-=1;scope.onLoadComplete();async_callback_gate()}}function create_callback_hierachy(id,parent,material,obj){return function(event){var result;if(event.content){result=event.content}else if(event.dae){result=event.scene}else{result=event}handle_hierarchy(result,id,parent,material,obj);counter_models-=1;scope.onLoadComplete();async_callback_gate()}}function create_callback_embed(id){return function(geo,mat){geo.name=id;result.geometries[id]=geo;result.face_materials[id]=mat}}function async_callback_gate(){var progress={totalModels:total_models,totalTextures:total_textures,loadedModels:total_models-counter_models,loadedTextures:total_textures-counter_textures};scope.callbackProgress(progress,result);scope.onLoadProgress();if(counter_models===0&&counter_textures===0){finalize();callbackFinished(result)}}function finalize(){for(var i=0;i<target_array.length;i++){var ta=target_array[i];var target=result.objects[ta.targetName];if(target){ta.object.target=target}else{ta.object.target=new THREE.Object3D;result.scene.add(ta.object.target)}ta.object.target.userData.targetInverse=ta.object}}var callbackTexture=function(count){counter_textures-=count;async_callback_gate();scope.onLoadComplete()};var generateTextureCallback=function(count){return function(){callbackTexture(count)}};function traverse_json_hierarchy(objJSON,callback){callback(objJSON);if(objJSON.children!==undefined){for(var objChildID in objJSON.children){traverse_json_hierarchy(objJSON.children[objChildID],callback)}}}var fogID,fogJSON;for(fogID in data.fogs){fogJSON=data.fogs[fogID];if(fogJSON.type==="linear"){fog=new THREE.Fog(0,fogJSON.near,fogJSON.far)}else if(fogJSON.type==="exp2"){fog=new THREE.FogExp2(0,fogJSON.density)}color=fogJSON.color;fog.color.setRGB(color[0],color[1],color[2]);result.fogs[fogID]=fog}var geoID,geoJSON;for(geoID in data.geometries){geoJSON=data.geometries[geoID];if(geoJSON.type in this.geometryHandlerMap){counter_models+=1;scope.onLoadStart()}}for(var objID in data.objects){traverse_json_hierarchy(data.objects[objID],function(objJSON){if(objJSON.type&&objJSON.type in scope.hierarchyHandlerMap){counter_models+=1;scope.onLoadStart()}})}total_models=counter_models;for(geoID in data.geometries){geoJSON=data.geometries[geoID];if(geoJSON.type==="cube"){geometry=new THREE.CubeGeometry(geoJSON.width,geoJSON.height,geoJSON.depth,geoJSON.widthSegments,geoJSON.heightSegments,geoJSON.depthSegments);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="plane"){geometry=new THREE.PlaneGeometry(geoJSON.width,geoJSON.height,geoJSON.widthSegments,geoJSON.heightSegments);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="sphere"){geometry=new THREE.SphereGeometry(geoJSON.radius,geoJSON.widthSegments,geoJSON.heightSegments);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="cylinder"){geometry=new THREE.CylinderGeometry(geoJSON.topRad,geoJSON.botRad,geoJSON.height,geoJSON.radSegs,geoJSON.heightSegs);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="torus"){geometry=new THREE.TorusGeometry(geoJSON.radius,geoJSON.tube,geoJSON.segmentsR,geoJSON.segmentsT);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type==="icosahedron"){geometry=new THREE.IcosahedronGeometry(geoJSON.radius,geoJSON.subdivisions);geometry.name=geoID;result.geometries[geoID]=geometry}else if(geoJSON.type in this.geometryHandlerMap){var loaderParameters={};for(var parType in geoJSON){if(parType!=="type"&&parType!=="url"){loaderParameters[parType]=geoJSON[parType]}}var loader=this.geometryHandlerMap[geoJSON.type]["loaderObject"];loader.load(get_url(geoJSON.url,data.urlBaseType),create_callback_geometry(geoID),loaderParameters)}else if(geoJSON.type==="embedded"){var modelJson=data.embeds[geoJSON.id],texture_path="";modelJson.metadata=data.metadata;if(modelJson){var jsonLoader=this.geometryHandlerMap["ascii"]["loaderObject"];var model=jsonLoader.parse(modelJson,texture_path);create_callback_embed(geoID)(model.geometry,model.materials)}}}var textureID,textureJSON;for(textureID in data.textures){textureJSON=data.textures[textureID];if(textureJSON.url instanceof Array){counter_textures+=textureJSON.url.length;for(var n=0;n<textureJSON.url.length;n++){scope.onLoadStart()}}else{counter_textures+=1;scope.onLoadStart()}}total_textures=counter_textures;for(textureID in data.textures){textureJSON=data.textures[textureID];if(textureJSON.mapping!==undefined&&THREE[textureJSON.mapping]!==undefined){textureJSON.mapping=new THREE[textureJSON.mapping]}if(textureJSON.url instanceof Array){var count=textureJSON.url.length;var url_array=[];for(var i=0;i<count;i++){url_array[i]=get_url(textureJSON.url[i],data.urlBaseType)}var isCompressed=/\.dds$/i.test(url_array[0]);if(isCompressed){texture=THREE.ImageUtils.loadCompressedTextureCube(url_array,textureJSON.mapping,generateTextureCallback(count))}else{texture=THREE.ImageUtils.loadTextureCube(url_array,textureJSON.mapping,generateTextureCallback(count))}}else{var isCompressed=/\.dds$/i.test(textureJSON.url);var fullUrl=get_url(textureJSON.url,data.urlBaseType);var textureCallback=generateTextureCallback(1);if(isCompressed){texture=THREE.ImageUtils.loadCompressedTexture(fullUrl,textureJSON.mapping,textureCallback)}else{texture=THREE.ImageUtils.loadTexture(fullUrl,textureJSON.mapping,textureCallback)}if(THREE[textureJSON.minFilter]!==undefined)texture.minFilter=THREE[textureJSON.minFilter];if(THREE[textureJSON.magFilter]!==undefined)texture.magFilter=THREE[textureJSON.magFilter];if(textureJSON.anisotropy)texture.anisotropy=textureJSON.anisotropy;if(textureJSON.repeat){texture.repeat.set(textureJSON.repeat[0],textureJSON.repeat[1]);if(textureJSON.repeat[0]!==1)texture.wrapS=THREE.RepeatWrapping;if(textureJSON.repeat[1]!==1)texture.wrapT=THREE.RepeatWrapping}if(textureJSON.offset){texture.offset.set(textureJSON.offset[0],textureJSON.offset[1])}if(textureJSON.wrap){var wrapMap={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};if(wrapMap[textureJSON.wrap[0]]!==undefined)texture.wrapS=wrapMap[textureJSON.wrap[0]];if(wrapMap[textureJSON.wrap[1]]!==undefined)texture.wrapT=wrapMap[textureJSON.wrap[1]]}}result.textures[textureID]=texture}var matID,matJSON;var parID;for(matID in data.materials){matJSON=data.materials[matID];for(parID in matJSON.parameters){if(parID==="envMap"||parID==="map"||parID==="lightMap"||parID==="bumpMap"){matJSON.parameters[parID]=result.textures[matJSON.parameters[parID]]}else if(parID==="shading"){matJSON.parameters[parID]=matJSON.parameters[parID]==="flat"?THREE.FlatShading:THREE.SmoothShading}else if(parID==="side"){if(matJSON.parameters[parID]=="double"){matJSON.parameters[parID]=THREE.DoubleSide}else if(matJSON.parameters[parID]=="back"){matJSON.parameters[parID]=THREE.BackSide}else{matJSON.parameters[parID]=THREE.FrontSide}}else if(parID==="blending"){matJSON.parameters[parID]=matJSON.parameters[parID]in THREE?THREE[matJSON.parameters[parID]]:THREE.NormalBlending}else if(parID==="combine"){matJSON.parameters[parID]=matJSON.parameters[parID]in THREE?THREE[matJSON.parameters[parID]]:THREE.MultiplyOperation}else if(parID==="vertexColors"){if(matJSON.parameters[parID]=="face"){matJSON.parameters[parID]=THREE.FaceColors}else if(matJSON.parameters[parID]){matJSON.parameters[parID]=THREE.VertexColors}}else if(parID==="wrapRGB"){var v3=matJSON.parameters[parID];matJSON.parameters[parID]=new THREE.Vector3(v3[0],v3[1],v3[2])}}if(matJSON.parameters.opacity!==undefined&&matJSON.parameters.opacity<1){matJSON.parameters.transparent=true}if(matJSON.parameters.normalMap){var shader=THREE.ShaderLib["normalmap"];var uniforms=THREE.UniformsUtils.clone(shader.uniforms);var diffuse=matJSON.parameters.color;var specular=matJSON.parameters.specular;var ambient=matJSON.parameters.ambient;var shininess=matJSON.parameters.shininess;uniforms["tNormal"].value=result.textures[matJSON.parameters.normalMap];if(matJSON.parameters.normalScale){uniforms["uNormalScale"].value.set(matJSON.parameters.normalScale[0],matJSON.parameters.normalScale[1])}if(matJSON.parameters.map){uniforms["tDiffuse"].value=matJSON.parameters.map;uniforms["enableDiffuse"].value=true}if(matJSON.parameters.envMap){uniforms["tCube"].value=matJSON.parameters.envMap;uniforms["enableReflection"].value=true;uniforms["uReflectivity"].value=matJSON.parameters.reflectivity}if(matJSON.parameters.lightMap){uniforms["tAO"].value=matJSON.parameters.lightMap;uniforms["enableAO"].value=true}if(matJSON.parameters.specularMap){uniforms["tSpecular"].value=result.textures[matJSON.parameters.specularMap];uniforms["enableSpecular"].value=true}if(matJSON.parameters.displacementMap){uniforms["tDisplacement"].value=result.textures[matJSON.parameters.displacementMap];uniforms["enableDisplacement"].value=true;uniforms["uDisplacementBias"].value=matJSON.parameters.displacementBias;uniforms["uDisplacementScale"].value=matJSON.parameters.displacementScale}uniforms["uDiffuseColor"].value.setHex(diffuse);uniforms["uSpecularColor"].value.setHex(specular);uniforms["uAmbientColor"].value.setHex(ambient);uniforms["uShininess"].value=shininess;if(matJSON.parameters.opacity){uniforms["uOpacity"].value=matJSON.parameters.opacity}var parameters={fragmentShader:shader.fragmentShader,vertexShader:shader.vertexShader,uniforms:uniforms,lights:true,fog:true};material=new THREE.ShaderMaterial(parameters)}else{material=new THREE[matJSON.type](matJSON.parameters)}material.name=matID;result.materials[matID]=material}for(matID in data.materials){matJSON=data.materials[matID];if(matJSON.parameters.materials){var materialArray=[];for(var i=0;i<matJSON.parameters.materials.length;i++){var label=matJSON.parameters.materials[i];materialArray.push(result.materials[label])}result.materials[matID].materials=materialArray}}handle_objects();if(result.cameras&&data.defaults.camera){result.currentCamera=result.cameras[data.defaults.camera]}if(result.fogs&&data.defaults.fog){result.scene.fog=result.fogs[data.defaults.fog]}scope.callbackSync(result);async_callback_gate()};THREE.TextureLoader=function(){this.crossOrigin=null};THREE.TextureLoader.prototype={constructor:THREE.TextureLoader,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,load:function(url){var scope=this;var image=new Image;image.addEventListener("load",function(){var texture=new THREE.Texture(image);texture.needsUpdate=true;scope.dispatchEvent({type:"load",content:texture})},false);image.addEventListener("error",function(){scope.dispatchEvent({type:"error",message:"Couldn't load URL ["+url+"]"})},false);if(scope.crossOrigin)image.crossOrigin=scope.crossOrigin;image.src=url}};THREE.Material=function(){this.id=THREE.MaterialIdCount++;this.name="";this.side=THREE.FrontSide;this.opacity=1;this.transparent=false;this.blending=THREE.NormalBlending;this.blendSrc=THREE.SrcAlphaFactor;this.blendDst=THREE.OneMinusSrcAlphaFactor;this.blendEquation=THREE.AddEquation;this.depthTest=true;this.depthWrite=true;this.polygonOffset=false;this.polygonOffsetFactor=0;this.polygonOffsetUnits=0;this.alphaTest=0;this.overdraw=0;this.visible=true;this.needsUpdate=true};THREE.Material.prototype={constructor:THREE.Material,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,setValues:function(values){if(values===undefined)return;for(var key in values){var newValue=values[key];if(newValue===undefined){console.warn("THREE.Material: '"+key+"' parameter is undefined.");continue}if(key in this){var currentValue=this[key];if(currentValue instanceof THREE.Color){currentValue.set(newValue)}else if(currentValue instanceof THREE.Vector3&&newValue instanceof THREE.Vector3){currentValue.copy(newValue)}else if(key=="overdraw"){this[key]=Number(newValue)}else{this[key]=newValue}}}},clone:function(material){if(material===undefined)material=new THREE.Material;material.name=this.name;material.side=this.side;material.opacity=this.opacity;material.transparent=this.transparent;material.blending=this.blending;material.blendSrc=this.blendSrc;material.blendDst=this.blendDst;material.blendEquation=this.blendEquation;material.depthTest=this.depthTest;material.depthWrite=this.depthWrite;material.polygonOffset=this.polygonOffset;material.polygonOffsetFactor=this.polygonOffsetFactor;material.polygonOffsetUnits=this.polygonOffsetUnits;material.alphaTest=this.alphaTest;material.overdraw=this.overdraw;material.visible=this.visible;return material},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.MaterialIdCount=0;THREE.LineBasicMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.linewidth=1;this.linecap="round";this.linejoin="round";this.vertexColors=false;this.fog=true;this.setValues(parameters)};THREE.LineBasicMaterial.prototype=Object.create(THREE.Material.prototype);THREE.LineBasicMaterial.prototype.clone=function(){var material=new THREE.LineBasicMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.linewidth=this.linewidth;material.linecap=this.linecap;material.linejoin=this.linejoin;material.vertexColors=this.vertexColors;material.fog=this.fog;return material};THREE.LineDashedMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.linewidth=1;this.scale=1;this.dashSize=3;this.gapSize=1;this.vertexColors=false;this.fog=true;this.setValues(parameters)};THREE.LineDashedMaterial.prototype=Object.create(THREE.Material.prototype);THREE.LineDashedMaterial.prototype.clone=function(){var material=new THREE.LineDashedMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.linewidth=this.linewidth;material.scale=this.scale;material.dashSize=this.dashSize;material.gapSize=this.gapSize;material.vertexColors=this.vertexColors;material.fog=this.fog;return material};THREE.MeshBasicMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.map=null;this.lightMap=null;this.specularMap=null;this.envMap=null;this.combine=THREE.MultiplyOperation;this.reflectivity=1;this.refractionRatio=.98;this.fog=true;this.shading=THREE.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=THREE.NoColors;this.skinning=false;this.morphTargets=false;this.setValues(parameters)};THREE.MeshBasicMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshBasicMaterial.prototype.clone=function(){var material=new THREE.MeshBasicMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.map=this.map;material.lightMap=this.lightMap;material.specularMap=this.specularMap;material.envMap=this.envMap;material.combine=this.combine;material.reflectivity=this.reflectivity;material.refractionRatio=this.refractionRatio;material.fog=this.fog;material.shading=this.shading;material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;material.wireframeLinecap=this.wireframeLinecap;material.wireframeLinejoin=this.wireframeLinejoin;material.vertexColors=this.vertexColors;material.skinning=this.skinning;material.morphTargets=this.morphTargets;return material};THREE.MeshLambertMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.ambient=new THREE.Color(16777215);this.emissive=new THREE.Color(0);this.wrapAround=false;this.wrapRGB=new THREE.Vector3(1,1,1);this.map=null;this.lightMap=null;this.specularMap=null;this.envMap=null;this.combine=THREE.MultiplyOperation;this.reflectivity=1;this.refractionRatio=.98;this.fog=true;this.shading=THREE.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=THREE.NoColors;this.skinning=false;this.morphTargets=false;this.morphNormals=false;this.setValues(parameters)};THREE.MeshLambertMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshLambertMaterial.prototype.clone=function(){var material=new THREE.MeshLambertMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.ambient.copy(this.ambient);material.emissive.copy(this.emissive);material.wrapAround=this.wrapAround;material.wrapRGB.copy(this.wrapRGB);material.map=this.map;material.lightMap=this.lightMap;material.specularMap=this.specularMap;material.envMap=this.envMap;material.combine=this.combine;material.reflectivity=this.reflectivity;material.refractionRatio=this.refractionRatio;material.fog=this.fog;material.shading=this.shading;material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;material.wireframeLinecap=this.wireframeLinecap;material.wireframeLinejoin=this.wireframeLinejoin;material.vertexColors=this.vertexColors;material.skinning=this.skinning;material.morphTargets=this.morphTargets;material.morphNormals=this.morphNormals;return material};THREE.MeshPhongMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.ambient=new THREE.Color(16777215);this.emissive=new THREE.Color(0);this.specular=new THREE.Color(1118481);this.shininess=30;this.metal=false;this.perPixel=true;this.wrapAround=false;this.wrapRGB=new THREE.Vector3(1,1,1);this.map=null;this.lightMap=null;this.bumpMap=null;this.bumpScale=1;this.normalMap=null;this.normalScale=new THREE.Vector2(1,1);this.specularMap=null;this.envMap=null;this.combine=THREE.MultiplyOperation;this.reflectivity=1;this.refractionRatio=.98;this.fog=true;this.shading=THREE.SmoothShading;this.wireframe=false;this.wireframeLinewidth=1;this.wireframeLinecap="round";this.wireframeLinejoin="round";this.vertexColors=THREE.NoColors;this.skinning=false;this.morphTargets=false;this.morphNormals=false;this.setValues(parameters)};THREE.MeshPhongMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshPhongMaterial.prototype.clone=function(){var material=new THREE.MeshPhongMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.ambient.copy(this.ambient);material.emissive.copy(this.emissive);material.specular.copy(this.specular);material.shininess=this.shininess;material.metal=this.metal;material.perPixel=this.perPixel;material.wrapAround=this.wrapAround;material.wrapRGB.copy(this.wrapRGB);material.map=this.map;material.lightMap=this.lightMap;material.bumpMap=this.bumpMap;material.bumpScale=this.bumpScale;material.normalMap=this.normalMap;material.normalScale.copy(this.normalScale);material.specularMap=this.specularMap;material.envMap=this.envMap;material.combine=this.combine;material.reflectivity=this.reflectivity;material.refractionRatio=this.refractionRatio;material.fog=this.fog;material.shading=this.shading;material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;material.wireframeLinecap=this.wireframeLinecap;material.wireframeLinejoin=this.wireframeLinejoin;material.vertexColors=this.vertexColors;material.skinning=this.skinning;material.morphTargets=this.morphTargets;material.morphNormals=this.morphNormals;return material};THREE.MeshDepthMaterial=function(parameters){THREE.Material.call(this);this.wireframe=false;this.wireframeLinewidth=1;this.setValues(parameters)};THREE.MeshDepthMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshDepthMaterial.prototype.clone=function(){var material=new THREE.MeshDepthMaterial;THREE.Material.prototype.clone.call(this,material);material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;return material};THREE.MeshNormalMaterial=function(parameters){THREE.Material.call(this,parameters);this.shading=THREE.FlatShading;this.wireframe=false;this.wireframeLinewidth=1;this.morphTargets=false;this.setValues(parameters)};THREE.MeshNormalMaterial.prototype=Object.create(THREE.Material.prototype);THREE.MeshNormalMaterial.prototype.clone=function(){var material=new THREE.MeshNormalMaterial;THREE.Material.prototype.clone.call(this,material);material.shading=this.shading;material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;return material};THREE.MeshFaceMaterial=function(materials){this.materials=materials instanceof Array?materials:[]};THREE.MeshFaceMaterial.prototype.clone=function(){return new THREE.MeshFaceMaterial(this.materials.slice(0))};THREE.ParticleBasicMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.map=null;this.size=1;this.sizeAttenuation=true;this.vertexColors=false;this.fog=true;this.setValues(parameters)};THREE.ParticleBasicMaterial.prototype=Object.create(THREE.Material.prototype);THREE.ParticleBasicMaterial.prototype.clone=function(){var material=new THREE.ParticleBasicMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.map=this.map;material.size=this.size;material.sizeAttenuation=this.sizeAttenuation;material.vertexColors=this.vertexColors;material.fog=this.fog;return material};THREE.ParticleCanvasMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.program=function(context,color){};this.setValues(parameters)};THREE.ParticleCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.ParticleCanvasMaterial.prototype.clone=function(){var material=new THREE.ParticleCanvasMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.program=this.program;return material};THREE.ShaderMaterial=function(parameters){THREE.Material.call(this);this.fragmentShader="void main() {}";this.vertexShader="void main() {}";this.uniforms={};this.defines={};this.attributes=null;this.shading=THREE.SmoothShading;this.linewidth=1;this.wireframe=false;this.wireframeLinewidth=1;this.fog=false;this.lights=false;this.vertexColors=THREE.NoColors;this.skinning=false;this.morphTargets=false;this.morphNormals=false;this.setValues(parameters)};THREE.ShaderMaterial.prototype=Object.create(THREE.Material.prototype);THREE.ShaderMaterial.prototype.clone=function(){var material=new THREE.ShaderMaterial;THREE.Material.prototype.clone.call(this,material);material.fragmentShader=this.fragmentShader;material.vertexShader=this.vertexShader;material.uniforms=THREE.UniformsUtils.clone(this.uniforms);material.attributes=this.attributes;material.defines=this.defines;material.shading=this.shading;material.wireframe=this.wireframe;material.wireframeLinewidth=this.wireframeLinewidth;material.fog=this.fog;material.lights=this.lights;material.vertexColors=this.vertexColors;material.skinning=this.skinning;material.morphTargets=this.morphTargets;material.morphNormals=this.morphNormals;return material};THREE.SpriteMaterial=function(parameters){THREE.Material.call(this);this.color=new THREE.Color(16777215);this.map=new THREE.Texture;this.useScreenCoordinates=true;this.depthTest=!this.useScreenCoordinates;this.sizeAttenuation=!this.useScreenCoordinates;this.scaleByViewport=!this.sizeAttenuation;this.alignment=THREE.SpriteAlignment.center.clone();this.fog=false;this.uvOffset=new THREE.Vector2(0,0);this.uvScale=new THREE.Vector2(1,1);this.setValues(parameters);parameters=parameters||{};if(parameters.depthTest===undefined)this.depthTest=!this.useScreenCoordinates;if(parameters.sizeAttenuation===undefined)this.sizeAttenuation=!this.useScreenCoordinates;if(parameters.scaleByViewport===undefined)this.scaleByViewport=!this.sizeAttenuation};THREE.SpriteMaterial.prototype=Object.create(THREE.Material.prototype);THREE.SpriteMaterial.prototype.clone=function(){var material=new THREE.SpriteMaterial;THREE.Material.prototype.clone.call(this,material);material.color.copy(this.color);material.map=this.map;material.useScreenCoordinates=this.useScreenCoordinates;material.sizeAttenuation=this.sizeAttenuation;material.scaleByViewport=this.scaleByViewport;material.alignment.copy(this.alignment);material.uvOffset.copy(this.uvOffset);material.uvScale.copy(this.uvScale);material.fog=this.fog;return material};THREE.SpriteAlignment={};THREE.SpriteAlignment.topLeft=new THREE.Vector2(1,-1);THREE.SpriteAlignment.topCenter=new THREE.Vector2(0,-1);THREE.SpriteAlignment.topRight=new THREE.Vector2(-1,-1);THREE.SpriteAlignment.centerLeft=new THREE.Vector2(1,0);THREE.SpriteAlignment.center=new THREE.Vector2(0,0);THREE.SpriteAlignment.centerRight=new THREE.Vector2(-1,0);THREE.SpriteAlignment.bottomLeft=new THREE.Vector2(1,1);THREE.SpriteAlignment.bottomCenter=new THREE.Vector2(0,1);THREE.SpriteAlignment.bottomRight=new THREE.Vector2(-1,1);THREE.Texture=function(image,mapping,wrapS,wrapT,magFilter,minFilter,format,type,anisotropy){this.id=THREE.TextureIdCount++;this.name="";this.image=image;this.mipmaps=[];this.mapping=mapping!==undefined?mapping:new THREE.UVMapping;this.wrapS=wrapS!==undefined?wrapS:THREE.ClampToEdgeWrapping;this.wrapT=wrapT!==undefined?wrapT:THREE.ClampToEdgeWrapping;this.magFilter=magFilter!==undefined?magFilter:THREE.LinearFilter;this.minFilter=minFilter!==undefined?minFilter:THREE.LinearMipMapLinearFilter;this.anisotropy=anisotropy!==undefined?anisotropy:1;this.format=format!==undefined?format:THREE.RGBAFormat;this.type=type!==undefined?type:THREE.UnsignedByteType;this.offset=new THREE.Vector2(0,0);this.repeat=new THREE.Vector2(1,1);this.generateMipmaps=true;this.premultiplyAlpha=false;this.flipY=true;this.unpackAlignment=4;this.needsUpdate=false;this.onUpdate=null};THREE.Texture.prototype={constructor:THREE.Texture,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,clone:function(texture){if(texture===undefined)texture=new THREE.Texture;
texture.image=this.image;texture.mipmaps=this.mipmaps.slice(0);texture.mapping=this.mapping;texture.wrapS=this.wrapS;texture.wrapT=this.wrapT;texture.magFilter=this.magFilter;texture.minFilter=this.minFilter;texture.anisotropy=this.anisotropy;texture.format=this.format;texture.type=this.type;texture.offset.copy(this.offset);texture.repeat.copy(this.repeat);texture.generateMipmaps=this.generateMipmaps;texture.premultiplyAlpha=this.premultiplyAlpha;texture.flipY=this.flipY;texture.unpackAlignment=this.unpackAlignment;return texture},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.TextureIdCount=0;THREE.CompressedTexture=function(mipmaps,width,height,format,type,mapping,wrapS,wrapT,magFilter,minFilter,anisotropy){THREE.Texture.call(this,null,mapping,wrapS,wrapT,magFilter,minFilter,format,type,anisotropy);this.image={width:width,height:height};this.mipmaps=mipmaps;this.generateMipmaps=false};THREE.CompressedTexture.prototype=Object.create(THREE.Texture.prototype);THREE.CompressedTexture.prototype.clone=function(){var texture=new THREE.CompressedTexture;THREE.Texture.prototype.clone.call(this,texture);return texture};THREE.DataTexture=function(data,width,height,format,type,mapping,wrapS,wrapT,magFilter,minFilter,anisotropy){THREE.Texture.call(this,null,mapping,wrapS,wrapT,magFilter,minFilter,format,type,anisotropy);this.image={data:data,width:width,height:height}};THREE.DataTexture.prototype=Object.create(THREE.Texture.prototype);THREE.DataTexture.prototype.clone=function(){var texture=new THREE.DataTexture;THREE.Texture.prototype.clone.call(this,texture);return texture};THREE.Particle=function(material){THREE.Object3D.call(this);this.material=material};THREE.Particle.prototype=Object.create(THREE.Object3D.prototype);THREE.Particle.prototype.clone=function(object){if(object===undefined)object=new THREE.Particle(this.material);THREE.Object3D.prototype.clone.call(this,object);return object};THREE.ParticleSystem=function(geometry,material){THREE.Object3D.call(this);this.geometry=geometry;this.material=material!==undefined?material:new THREE.ParticleBasicMaterial({color:Math.random()*16777215});this.sortParticles=false;if(this.geometry){if(this.geometry.boundingSphere===null){this.geometry.computeBoundingSphere()}}this.frustumCulled=false};THREE.ParticleSystem.prototype=Object.create(THREE.Object3D.prototype);THREE.ParticleSystem.prototype.clone=function(object){if(object===undefined)object=new THREE.ParticleSystem(this.geometry,this.material);object.sortParticles=this.sortParticles;THREE.Object3D.prototype.clone.call(this,object);return object};THREE.Line=function(geometry,material,type){THREE.Object3D.call(this);this.geometry=geometry;this.material=material!==undefined?material:new THREE.LineBasicMaterial({color:Math.random()*16777215});this.type=type!==undefined?type:THREE.LineStrip;if(this.geometry){if(!this.geometry.boundingSphere){this.geometry.computeBoundingSphere()}}};THREE.LineStrip=0;THREE.LinePieces=1;THREE.Line.prototype=Object.create(THREE.Object3D.prototype);THREE.Line.prototype.clone=function(object){if(object===undefined)object=new THREE.Line(this.geometry,this.material,this.type);THREE.Object3D.prototype.clone.call(this,object);return object};THREE.Mesh=function(geometry,material){THREE.Object3D.call(this);this.geometry=null;this.material=null;this.setGeometry(geometry);this.setMaterial(material)};THREE.Mesh.prototype=Object.create(THREE.Object3D.prototype);THREE.Mesh.prototype.setGeometry=function(geometry){if(geometry!==undefined){this.geometry=geometry;if(this.geometry.boundingSphere===null){this.geometry.computeBoundingSphere()}this.updateMorphTargets()}};THREE.Mesh.prototype.setMaterial=function(material){if(material!==undefined){this.material=material}else{this.material=new THREE.MeshBasicMaterial({color:Math.random()*16777215,wireframe:true})}};THREE.Mesh.prototype.updateMorphTargets=function(){if(this.geometry.morphTargets.length>0){this.morphTargetBase=-1;this.morphTargetForcedOrder=[];this.morphTargetInfluences=[];this.morphTargetDictionary={};for(var m=0,ml=this.geometry.morphTargets.length;m<ml;m++){this.morphTargetInfluences.push(0);this.morphTargetDictionary[this.geometry.morphTargets[m].name]=m}}};THREE.Mesh.prototype.getMorphTargetIndexByName=function(name){if(this.morphTargetDictionary[name]!==undefined){return this.morphTargetDictionary[name]}console.log("THREE.Mesh.getMorphTargetIndexByName: morph target "+name+" does not exist. Returning 0.");return 0};THREE.Mesh.prototype.clone=function(object){if(object===undefined)object=new THREE.Mesh(this.geometry,this.material);THREE.Object3D.prototype.clone.call(this,object);return object};THREE.Bone=function(belongsToSkin){THREE.Object3D.call(this);this.skin=belongsToSkin;this.skinMatrix=new THREE.Matrix4};THREE.Bone.prototype=Object.create(THREE.Object3D.prototype);THREE.Bone.prototype.update=function(parentSkinMatrix,forceUpdate){if(this.matrixAutoUpdate){forceUpdate|=this.updateMatrix()}if(forceUpdate||this.matrixWorldNeedsUpdate){if(parentSkinMatrix){this.skinMatrix.multiplyMatrices(parentSkinMatrix,this.matrix)}else{this.skinMatrix.copy(this.matrix)}this.matrixWorldNeedsUpdate=false;forceUpdate=true}var child,i,l=this.children.length;for(i=0;i<l;i++){this.children[i].update(this.skinMatrix,forceUpdate)}};THREE.SkinnedMesh=function(geometry,material,useVertexTexture){THREE.Mesh.call(this,geometry,material);this.useVertexTexture=useVertexTexture!==undefined?useVertexTexture:true;this.identityMatrix=new THREE.Matrix4;this.bones=[];this.boneMatrices=[];var b,bone,gbone,p,q,s;if(this.geometry&&this.geometry.bones!==undefined){for(b=0;b<this.geometry.bones.length;b++){gbone=this.geometry.bones[b];p=gbone.pos;q=gbone.rotq;s=gbone.scl;bone=this.addBone();bone.name=gbone.name;bone.position.set(p[0],p[1],p[2]);bone.quaternion.set(q[0],q[1],q[2],q[3]);bone.useQuaternion=true;if(s!==undefined){bone.scale.set(s[0],s[1],s[2])}else{bone.scale.set(1,1,1)}}for(b=0;b<this.bones.length;b++){gbone=this.geometry.bones[b];bone=this.bones[b];if(gbone.parent===-1){this.add(bone)}else{this.bones[gbone.parent].add(bone)}}var nBones=this.bones.length;if(this.useVertexTexture){var size;if(nBones>256)size=64;else if(nBones>64)size=32;else if(nBones>16)size=16;else size=8;this.boneTextureWidth=size;this.boneTextureHeight=size;this.boneMatrices=new Float32Array(this.boneTextureWidth*this.boneTextureHeight*4);this.boneTexture=new THREE.DataTexture(this.boneMatrices,this.boneTextureWidth,this.boneTextureHeight,THREE.RGBAFormat,THREE.FloatType);this.boneTexture.minFilter=THREE.NearestFilter;this.boneTexture.magFilter=THREE.NearestFilter;this.boneTexture.generateMipmaps=false;this.boneTexture.flipY=false}else{this.boneMatrices=new Float32Array(16*nBones)}this.pose()}};THREE.SkinnedMesh.prototype=Object.create(THREE.Mesh.prototype);THREE.SkinnedMesh.prototype.addBone=function(bone){if(bone===undefined){bone=new THREE.Bone(this)}this.bones.push(bone);return bone};THREE.SkinnedMesh.prototype.updateMatrixWorld=function(force){this.matrixAutoUpdate&&this.updateMatrix();if(this.matrixWorldNeedsUpdate||force){if(this.parent){this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)}else{this.matrixWorld.copy(this.matrix)}this.matrixWorldNeedsUpdate=false;force=true}for(var i=0,l=this.children.length;i<l;i++){var child=this.children[i];if(child instanceof THREE.Bone){child.update(this.identityMatrix,false)}else{child.updateMatrixWorld(true)}}if(this.boneInverses==undefined){this.boneInverses=[];for(var b=0,bl=this.bones.length;b<bl;b++){var inverse=new THREE.Matrix4;inverse.getInverse(this.bones[b].skinMatrix);this.boneInverses.push(inverse)}}for(var b=0,bl=this.bones.length;b<bl;b++){THREE.SkinnedMesh.offsetMatrix.multiplyMatrices(this.bones[b].skinMatrix,this.boneInverses[b]);THREE.SkinnedMesh.offsetMatrix.flattenToArrayOffset(this.boneMatrices,b*16)}if(this.useVertexTexture){this.boneTexture.needsUpdate=true}};THREE.SkinnedMesh.prototype.pose=function(){this.updateMatrixWorld(true);for(var i=0;i<this.geometry.skinIndices.length;i++){var sw=this.geometry.skinWeights[i];var scale=1/sw.lengthManhattan();if(scale!==Infinity){sw.multiplyScalar(scale)}else{sw.set(1)}}};THREE.SkinnedMesh.prototype.clone=function(object){if(object===undefined)object=new THREE.SkinnedMesh(this.geometry,this.material,this.useVertexTexture);THREE.Mesh.prototype.clone.call(this,object);return object};THREE.SkinnedMesh.offsetMatrix=new THREE.Matrix4;THREE.MorphAnimMesh=function(geometry,material){THREE.Mesh.call(this,geometry,material);this.duration=1e3;this.mirroredLoop=false;this.time=0;this.lastKeyframe=0;this.currentKeyframe=0;this.direction=1;this.directionBackwards=false;this.setFrameRange(0,this.geometry.morphTargets.length-1)};THREE.MorphAnimMesh.prototype=Object.create(THREE.Mesh.prototype);THREE.MorphAnimMesh.prototype.setFrameRange=function(start,end){this.startKeyframe=start;this.endKeyframe=end;this.length=this.endKeyframe-this.startKeyframe+1};THREE.MorphAnimMesh.prototype.setDirectionForward=function(){this.direction=1;this.directionBackwards=false};THREE.MorphAnimMesh.prototype.setDirectionBackward=function(){this.direction=-1;this.directionBackwards=true};THREE.MorphAnimMesh.prototype.parseAnimations=function(){var geometry=this.geometry;if(!geometry.animations)geometry.animations={};var firstAnimation,animations=geometry.animations;var pattern=/([a-z]+)(\d+)/;for(var i=0,il=geometry.morphTargets.length;i<il;i++){var morph=geometry.morphTargets[i];var parts=morph.name.match(pattern);if(parts&&parts.length>1){var label=parts[1];var num=parts[2];if(!animations[label])animations[label]={start:Infinity,end:-Infinity};var animation=animations[label];if(i<animation.start)animation.start=i;if(i>animation.end)animation.end=i;if(!firstAnimation)firstAnimation=label}}geometry.firstAnimation=firstAnimation};THREE.MorphAnimMesh.prototype.setAnimationLabel=function(label,start,end){if(!this.geometry.animations)this.geometry.animations={};this.geometry.animations[label]={start:start,end:end}};THREE.MorphAnimMesh.prototype.playAnimation=function(label,fps){var animation=this.geometry.animations[label];if(animation){this.setFrameRange(animation.start,animation.end);this.duration=1e3*((animation.end-animation.start)/fps);this.time=0}else{console.warn("animation["+label+"] undefined")}};THREE.MorphAnimMesh.prototype.updateAnimation=function(delta){var frameTime=this.duration/this.length;this.time+=this.direction*delta;if(this.mirroredLoop){if(this.time>this.duration||this.time<0){this.direction*=-1;if(this.time>this.duration){this.time=this.duration;this.directionBackwards=true}if(this.time<0){this.time=0;this.directionBackwards=false}}}else{this.time=this.time%this.duration;if(this.time<0)this.time+=this.duration}var keyframe=this.startKeyframe+THREE.Math.clamp(Math.floor(this.time/frameTime),0,this.length-1);if(keyframe!==this.currentKeyframe){this.morphTargetInfluences[this.lastKeyframe]=0;this.morphTargetInfluences[this.currentKeyframe]=1;this.morphTargetInfluences[keyframe]=0;this.lastKeyframe=this.currentKeyframe;this.currentKeyframe=keyframe}var mix=this.time%frameTime/frameTime;if(this.directionBackwards){mix=1-mix}this.morphTargetInfluences[this.currentKeyframe]=mix;this.morphTargetInfluences[this.lastKeyframe]=1-mix};THREE.MorphAnimMesh.prototype.clone=function(object){if(object===undefined)object=new THREE.MorphAnimMesh(this.geometry,this.material);object.duration=this.duration;object.mirroredLoop=this.mirroredLoop;object.time=this.time;object.lastKeyframe=this.lastKeyframe;object.currentKeyframe=this.currentKeyframe;object.direction=this.direction;object.directionBackwards=this.directionBackwards;THREE.Mesh.prototype.clone.call(this,object);return object};THREE.Ribbon=function(geometry,material){THREE.Object3D.call(this);this.geometry=geometry;this.material=material};THREE.Ribbon.prototype=Object.create(THREE.Object3D.prototype);THREE.Ribbon.prototype.clone=function(object){if(object===undefined)object=new THREE.Ribbon(this.geometry,this.material);THREE.Object3D.prototype.clone.call(this,object);return object};THREE.LOD=function(){THREE.Object3D.call(this);this.objects=[]};THREE.LOD.prototype=Object.create(THREE.Object3D.prototype);THREE.LOD.prototype.addLevel=function(object,distance){if(distance===undefined)distance=0;distance=Math.abs(distance);for(var l=0;l<this.objects.length;l++){if(distance<this.objects[l].distance){break}}this.objects.splice(l,0,{distance:distance,object:object});this.add(object)};THREE.LOD.prototype.getObjectForDistance=function(distance){for(var i=1,l=this.objects.length;i<l;i++){if(distance<this.objects[i].distance){break}}return this.objects[i-1].object};THREE.LOD.prototype.update=function(){var v1=new THREE.Vector3;var v2=new THREE.Vector3;return function(camera){if(this.objects.length>1){v1.getPositionFromMatrix(camera.matrixWorld);v2.getPositionFromMatrix(this.matrixWorld);var distance=v1.distanceTo(v2);this.objects[0].object.visible=true;for(var i=1,l=this.objects.length;i<l;i++){if(distance>=this.objects[i].distance){this.objects[i-1].object.visible=false;this.objects[i].object.visible=true}else{break}}for(;i<l;i++){this.objects[i].object.visible=false}}}}();THREE.LOD.prototype.clone=function(){};THREE.Sprite=function(material){THREE.Object3D.call(this);this.material=material!==undefined?material:new THREE.SpriteMaterial;this.rotation3d=this.rotation;this.rotation=0};THREE.Sprite.prototype=Object.create(THREE.Object3D.prototype);THREE.Sprite.prototype.updateMatrix=function(){this.rotation3d.set(0,0,this.rotation);this.quaternion.setFromEuler(this.rotation3d,this.eulerOrder);this.matrix.makeFromPositionQuaternionScale(this.position,this.quaternion,this.scale);this.matrixWorldNeedsUpdate=true};THREE.Sprite.prototype.clone=function(object){if(object===undefined)object=new THREE.Sprite(this.material);THREE.Object3D.prototype.clone.call(this,object);return object};THREE.Scene=function(){THREE.Object3D.call(this);this.fog=null;this.overrideMaterial=null;this.autoUpdate=true;this.matrixAutoUpdate=false;this.__objects=[];this.__lights=[];this.__objectsAdded=[];this.__objectsRemoved=[]};THREE.Scene.prototype=Object.create(THREE.Object3D.prototype);THREE.Scene.prototype.__addObject=function(object){if(object instanceof THREE.Light){if(this.__lights.indexOf(object)===-1){this.__lights.push(object)}if(object.target&&object.target.parent===undefined){this.add(object.target)}}else if(!(object instanceof THREE.Camera||object instanceof THREE.Bone)){if(this.__objects.indexOf(object)===-1){this.__objects.push(object);this.__objectsAdded.push(object);var i=this.__objectsRemoved.indexOf(object);if(i!==-1){this.__objectsRemoved.splice(i,1)}}}for(var c=0;c<object.children.length;c++){this.__addObject(object.children[c])}};THREE.Scene.prototype.__removeObject=function(object){if(object instanceof THREE.Light){var i=this.__lights.indexOf(object);if(i!==-1){this.__lights.splice(i,1)}}else if(!(object instanceof THREE.Camera)){var i=this.__objects.indexOf(object);if(i!==-1){this.__objects.splice(i,1);this.__objectsRemoved.push(object);var ai=this.__objectsAdded.indexOf(object);if(ai!==-1){this.__objectsAdded.splice(ai,1)}}}for(var c=0;c<object.children.length;c++){this.__removeObject(object.children[c])}};THREE.Fog=function(hex,near,far){this.name="";this.color=new THREE.Color(hex);this.near=near!==undefined?near:1;this.far=far!==undefined?far:1e3};THREE.Fog.prototype.clone=function(){return new THREE.Fog(this.color.getHex(),this.near,this.far)};THREE.FogExp2=function(hex,density){this.name="";this.color=new THREE.Color(hex);this.density=density!==undefined?density:25e-5};THREE.FogExp2.prototype.clone=function(){return new THREE.FogExp2(this.color.getHex(),this.density)};THREE.CanvasRenderer=function(parameters){console.log("THREE.CanvasRenderer",THREE.REVISION);var smoothstep=THREE.Math.smoothstep;parameters=parameters||{};var _this=this,_renderData,_elements,_lights,_projector=new THREE.Projector,_canvas=parameters.canvas!==undefined?parameters.canvas:document.createElement("canvas"),_canvasWidth,_canvasHeight,_canvasWidthHalf,_canvasHeightHalf,_context=_canvas.getContext("2d"),_clearColor=new THREE.Color(0),_clearAlpha=0,_contextGlobalAlpha=1,_contextGlobalCompositeOperation=0,_contextStrokeStyle=null,_contextFillStyle=null,_contextLineWidth=null,_contextLineCap=null,_contextLineJoin=null,_contextDashSize=null,_contextGapSize=0,_camera,_v1,_v2,_v3,_v4,_v5=new THREE.RenderableVertex,_v6=new THREE.RenderableVertex,_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_v4x,_v4y,_v5x,_v5y,_v6x,_v6y,_color=new THREE.Color,_color1=new THREE.Color,_color2=new THREE.Color,_color3=new THREE.Color,_color4=new THREE.Color,_diffuseColor=new THREE.Color,_emissiveColor=new THREE.Color,_lightColor=new THREE.Color,_patterns={},_imagedatas={},_near,_far,_image,_uvs,_uv1x,_uv1y,_uv2x,_uv2y,_uv3x,_uv3y,_clipBox=new THREE.Box2,_clearBox=new THREE.Box2,_elemBox=new THREE.Box2,_ambientLight=new THREE.Color,_directionalLights=new THREE.Color,_pointLights=new THREE.Color,_vector3=new THREE.Vector3,_pixelMap,_pixelMapContext,_pixelMapImage,_pixelMapData,_gradientMap,_gradientMapContext,_gradientMapQuality=16;_pixelMap=document.createElement("canvas");_pixelMap.width=_pixelMap.height=2;_pixelMapContext=_pixelMap.getContext("2d");_pixelMapContext.fillStyle="rgba(0,0,0,1)";_pixelMapContext.fillRect(0,0,2,2);_pixelMapImage=_pixelMapContext.getImageData(0,0,2,2);_pixelMapData=_pixelMapImage.data;_gradientMap=document.createElement("canvas");_gradientMap.width=_gradientMap.height=_gradientMapQuality;_gradientMapContext=_gradientMap.getContext("2d");_gradientMapContext.translate(-_gradientMapQuality/2,-_gradientMapQuality/2);_gradientMapContext.scale(_gradientMapQuality,_gradientMapQuality);_gradientMapQuality--;if(_context.setLineDash===undefined){if(_context.mozDash!==undefined){_context.setLineDash=function(values){_context.mozDash=values[0]!==null?values:null}}else{_context.setLineDash=function(){}}}this.domElement=_canvas;this.devicePixelRatio=parameters.devicePixelRatio!==undefined?parameters.devicePixelRatio:window.devicePixelRatio!==undefined?window.devicePixelRatio:1;this.autoClear=true;this.sortObjects=true;this.sortElements=true;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.setSize=function(width,height,updateStyle){_canvasWidth=width*this.devicePixelRatio;_canvasHeight=height*this.devicePixelRatio;_canvasWidthHalf=Math.floor(_canvasWidth/2);_canvasHeightHalf=Math.floor(_canvasHeight/2);_canvas.width=_canvasWidth;_canvas.height=_canvasHeight;if(this.devicePixelRatio!==1&&updateStyle!==false){_canvas.style.width=width+"px";_canvas.style.height=height+"px"}_clipBox.set(new THREE.Vector2(-_canvasWidthHalf,-_canvasHeightHalf),new THREE.Vector2(_canvasWidthHalf,_canvasHeightHalf));_clearBox.set(new THREE.Vector2(-_canvasWidthHalf,-_canvasHeightHalf),new THREE.Vector2(_canvasWidthHalf,_canvasHeightHalf));_contextGlobalAlpha=1;_contextGlobalCompositeOperation=0;_contextStrokeStyle=null;_contextFillStyle=null;_contextLineWidth=null;_contextLineCap=null;_contextLineJoin=null};this.setClearColor=function(color,alpha){_clearColor.set(color);_clearAlpha=alpha!==undefined?alpha:1;_clearBox.set(new THREE.Vector2(-_canvasWidthHalf,-_canvasHeightHalf),new THREE.Vector2(_canvasWidthHalf,_canvasHeightHalf))};this.setClearColorHex=function(hex,alpha){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(hex,alpha)};this.getMaxAnisotropy=function(){return 0};this.clear=function(){_context.setTransform(1,0,0,-1,_canvasWidthHalf,_canvasHeightHalf);if(_clearBox.empty()===false){_clearBox.intersect(_clipBox);_clearBox.expandByScalar(2);if(_clearAlpha<1){_context.clearRect(_clearBox.min.x|0,_clearBox.min.y|0,_clearBox.max.x-_clearBox.min.x|0,_clearBox.max.y-_clearBox.min.y|0)}if(_clearAlpha>0){setBlending(THREE.NormalBlending);setOpacity(1);setFillStyle("rgba("+Math.floor(_clearColor.r*255)+","+Math.floor(_clearColor.g*255)+","+Math.floor(_clearColor.b*255)+","+_clearAlpha+")");_context.fillRect(_clearBox.min.x|0,_clearBox.min.y|0,_clearBox.max.x-_clearBox.min.x|0,_clearBox.max.y-_clearBox.min.y|0)}_clearBox.makeEmpty()}};this.render=function(scene,camera){if(camera instanceof THREE.Camera===false){console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");return}if(this.autoClear===true)this.clear();_context.setTransform(1,0,0,-1,_canvasWidthHalf,_canvasHeightHalf);_this.info.render.vertices=0;_this.info.render.faces=0;_renderData=_projector.projectScene(scene,camera,this.sortObjects,this.sortElements);_elements=_renderData.elements;_lights=_renderData.lights;_camera=camera;calculateLights();for(var e=0,el=_elements.length;e<el;e++){var element=_elements[e];var material=element.material;if(material===undefined||material.visible===false)continue;_elemBox.makeEmpty();if(element instanceof THREE.RenderableParticle){_v1=element;_v1.x*=_canvasWidthHalf;_v1.y*=_canvasHeightHalf;renderParticle(_v1,element,material)}else if(element instanceof THREE.RenderableLine){_v1=element.v1;_v2=element.v2;_v1.positionScreen.x*=_canvasWidthHalf;_v1.positionScreen.y*=_canvasHeightHalf;_v2.positionScreen.x*=_canvasWidthHalf;_v2.positionScreen.y*=_canvasHeightHalf;_elemBox.setFromPoints([_v1.positionScreen,_v2.positionScreen]);if(_clipBox.isIntersectionBox(_elemBox)===true){renderLine(_v1,_v2,element,material)}}else if(element instanceof THREE.RenderableFace3){_v1=element.v1;_v2=element.v2;_v3=element.v3;if(_v1.positionScreen.z<-1||_v1.positionScreen.z>1)continue;if(_v2.positionScreen.z<-1||_v2.positionScreen.z>1)continue;if(_v3.positionScreen.z<-1||_v3.positionScreen.z>1)continue;_v1.positionScreen.x*=_canvasWidthHalf;_v1.positionScreen.y*=_canvasHeightHalf;_v2.positionScreen.x*=_canvasWidthHalf;_v2.positionScreen.y*=_canvasHeightHalf;_v3.positionScreen.x*=_canvasWidthHalf;_v3.positionScreen.y*=_canvasHeightHalf;if(material.overdraw>0){expand(_v1.positionScreen,_v2.positionScreen,material.overdraw);expand(_v2.positionScreen,_v3.positionScreen,material.overdraw);expand(_v3.positionScreen,_v1.positionScreen,material.overdraw)}_elemBox.setFromPoints([_v1.positionScreen,_v2.positionScreen,_v3.positionScreen]);if(_clipBox.isIntersectionBox(_elemBox)===true){renderFace3(_v1,_v2,_v3,0,1,2,element,material)}}else if(element instanceof THREE.RenderableFace4){_v1=element.v1;_v2=element.v2;_v3=element.v3;_v4=element.v4;if(_v1.positionScreen.z<-1||_v1.positionScreen.z>1)continue;if(_v2.positionScreen.z<-1||_v2.positionScreen.z>1)continue;if(_v3.positionScreen.z<-1||_v3.positionScreen.z>1)continue;if(_v4.positionScreen.z<-1||_v4.positionScreen.z>1)continue;_v1.positionScreen.x*=_canvasWidthHalf;_v1.positionScreen.y*=_canvasHeightHalf;_v2.positionScreen.x*=_canvasWidthHalf;_v2.positionScreen.y*=_canvasHeightHalf;_v3.positionScreen.x*=_canvasWidthHalf;_v3.positionScreen.y*=_canvasHeightHalf;_v4.positionScreen.x*=_canvasWidthHalf;_v4.positionScreen.y*=_canvasHeightHalf;_v5.positionScreen.copy(_v2.positionScreen);_v6.positionScreen.copy(_v4.positionScreen);if(material.overdraw>0){expand(_v1.positionScreen,_v2.positionScreen,material.overdraw);expand(_v2.positionScreen,_v4.positionScreen,material.overdraw);expand(_v4.positionScreen,_v1.positionScreen,material.overdraw);expand(_v3.positionScreen,_v5.positionScreen,material.overdraw);expand(_v3.positionScreen,_v6.positionScreen,material.overdraw)}_elemBox.setFromPoints([_v1.positionScreen,_v2.positionScreen,_v3.positionScreen,_v4.positionScreen]);if(_clipBox.isIntersectionBox(_elemBox)===true){renderFace4(_v1,_v2,_v3,_v4,_v5,_v6,element,material)}}_clearBox.union(_elemBox)}_context.setTransform(1,0,0,1,0,0)};function calculateLights(){_ambientLight.setRGB(0,0,0);_directionalLights.setRGB(0,0,0);_pointLights.setRGB(0,0,0);for(var l=0,ll=_lights.length;l<ll;l++){var light=_lights[l];var lightColor=light.color;if(light instanceof THREE.AmbientLight){_ambientLight.add(lightColor)}else if(light instanceof THREE.DirectionalLight){_directionalLights.add(lightColor)}else if(light instanceof THREE.PointLight){_pointLights.add(lightColor)}}}function calculateLight(position,normal,color){for(var l=0,ll=_lights.length;l<ll;l++){var light=_lights[l];_lightColor.copy(light.color);if(light instanceof THREE.DirectionalLight){var lightPosition=_vector3.getPositionFromMatrix(light.matrixWorld).normalize();var amount=normal.dot(lightPosition);if(amount<=0)continue;amount*=light.intensity;color.add(_lightColor.multiplyScalar(amount))}else if(light instanceof THREE.PointLight){var lightPosition=_vector3.getPositionFromMatrix(light.matrixWorld);var amount=normal.dot(_vector3.subVectors(lightPosition,position).normalize());if(amount<=0)continue;amount*=light.distance==0?1:1-Math.min(position.distanceTo(lightPosition)/light.distance,1);if(amount==0)continue;amount*=light.intensity;color.add(_lightColor.multiplyScalar(amount))}}}function renderParticle(v1,element,material){setOpacity(material.opacity);setBlending(material.blending);var width,height,scaleX,scaleY,bitmap,bitmapWidth,bitmapHeight;if(material instanceof THREE.ParticleBasicMaterial){if(material.map===null){scaleX=element.object.scale.x;scaleY=element.object.scale.y;scaleX*=element.scale.x*_canvasWidthHalf;scaleY*=element.scale.y*_canvasHeightHalf;_elemBox.min.set(v1.x-scaleX,v1.y-scaleY);_elemBox.max.set(v1.x+scaleX,v1.y+scaleY);if(_clipBox.isIntersectionBox(_elemBox)===false){_elemBox.makeEmpty();return}setFillStyle(material.color.getStyle());_context.save();_context.translate(v1.x,v1.y);_context.rotate(-element.rotation);_context.scale(scaleX,scaleY);_context.fillRect(-1,-1,2,2);_context.restore()}else{bitmap=material.map.image;bitmapWidth=bitmap.width>>1;bitmapHeight=bitmap.height>>1;scaleX=element.scale.x*_canvasWidthHalf;scaleY=element.scale.y*_canvasHeightHalf;width=scaleX*bitmapWidth;height=scaleY*bitmapHeight;_elemBox.min.set(v1.x-width,v1.y-height);_elemBox.max.set(v1.x+width,v1.y+height);if(_clipBox.isIntersectionBox(_elemBox)===false){_elemBox.makeEmpty();return}_context.save();_context.translate(v1.x,v1.y);_context.rotate(-element.rotation);_context.scale(scaleX,-scaleY);_context.translate(-bitmapWidth,-bitmapHeight);_context.drawImage(bitmap,0,0);_context.restore()}}else if(material instanceof THREE.ParticleCanvasMaterial){width=element.scale.x*_canvasWidthHalf;height=element.scale.y*_canvasHeightHalf;_elemBox.min.set(v1.x-width,v1.y-height);_elemBox.max.set(v1.x+width,v1.y+height);if(_clipBox.isIntersectionBox(_elemBox)===false){_elemBox.makeEmpty();return}setStrokeStyle(material.color.getStyle());setFillStyle(material.color.getStyle());_context.save();_context.translate(v1.x,v1.y);_context.rotate(-element.rotation);_context.scale(width,height);material.program(_context);_context.restore()}}function renderLine(v1,v2,element,material){setOpacity(material.opacity);setBlending(material.blending);_context.beginPath();_context.moveTo(v1.positionScreen.x,v1.positionScreen.y);_context.lineTo(v2.positionScreen.x,v2.positionScreen.y);if(material instanceof THREE.LineBasicMaterial){setLineWidth(material.linewidth);setLineCap(material.linecap);setLineJoin(material.linejoin);if(material.vertexColors!==THREE.VertexColors){setStrokeStyle(material.color.getStyle())}else{var colorStyle1=element.vertexColors[0].getStyle();var colorStyle2=element.vertexColors[1].getStyle();if(colorStyle1===colorStyle2){setStrokeStyle(colorStyle1)}else{try{var grad=_context.createLinearGradient(v1.positionScreen.x,v1.positionScreen.y,v2.positionScreen.x,v2.positionScreen.y);grad.addColorStop(0,colorStyle1);grad.addColorStop(1,colorStyle2)}catch(exception){grad=colorStyle1}setStrokeStyle(grad)}}_context.stroke();_elemBox.expandByScalar(material.linewidth*2)}else if(material instanceof THREE.LineDashedMaterial){setLineWidth(material.linewidth);setLineCap(material.linecap);setLineJoin(material.linejoin);setStrokeStyle(material.color.getStyle());setDashAndGap(material.dashSize,material.gapSize);_context.stroke();_elemBox.expandByScalar(material.linewidth*2);setDashAndGap(null,null)}}function renderFace3(v1,v2,v3,uv1,uv2,uv3,element,material){_this.info.render.vertices+=3;_this.info.render.faces++;setOpacity(material.opacity);setBlending(material.blending);_v1x=v1.positionScreen.x;_v1y=v1.positionScreen.y;_v2x=v2.positionScreen.x;_v2y=v2.positionScreen.y;_v3x=v3.positionScreen.x;_v3y=v3.positionScreen.y;drawTriangle(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y);if((material instanceof THREE.MeshLambertMaterial||material instanceof THREE.MeshPhongMaterial)&&material.map===null){_diffuseColor.copy(material.color);_emissiveColor.copy(material.emissive);if(material.vertexColors===THREE.FaceColors){_diffuseColor.multiply(element.color)}if(material.wireframe===false&&material.shading==THREE.SmoothShading&&element.vertexNormalsLength==3){_color1.copy(_ambientLight);_color2.copy(_ambientLight);_color3.copy(_ambientLight);calculateLight(element.v1.positionWorld,element.vertexNormalsModel[0],_color1);calculateLight(element.v2.positionWorld,element.vertexNormalsModel[1],_color2);calculateLight(element.v3.positionWorld,element.vertexNormalsModel[2],_color3);_color1.multiply(_diffuseColor).add(_emissiveColor);_color2.multiply(_diffuseColor).add(_emissiveColor);_color3.multiply(_diffuseColor).add(_emissiveColor);_color4.addColors(_color2,_color3).multiplyScalar(.5);_image=getGradientTexture(_color1,_color2,_color3,_color4);clipImage(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,0,0,1,0,0,1,_image)}else{_color.copy(_ambientLight);calculateLight(element.centroidModel,element.normalModel,_color);_color.multiply(_diffuseColor).add(_emissiveColor);material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}}else if(material instanceof THREE.MeshBasicMaterial||material instanceof THREE.MeshLambertMaterial||material instanceof THREE.MeshPhongMaterial){if(material.map!==null){if(material.map.mapping instanceof THREE.UVMapping){_uvs=element.uvs[0];patternPath(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_uvs[uv1].x,_uvs[uv1].y,_uvs[uv2].x,_uvs[uv2].y,_uvs[uv3].x,_uvs[uv3].y,material.map)}}else if(material.envMap!==null){if(material.envMap.mapping instanceof THREE.SphericalReflectionMapping){_vector3.copy(element.vertexNormalsModelView[uv1]);_uv1x=.5*_vector3.x+.5;_uv1y=.5*_vector3.y+.5;_vector3.copy(element.vertexNormalsModelView[uv2]);_uv2x=.5*_vector3.x+.5;_uv2y=.5*_vector3.y+.5;_vector3.copy(element.vertexNormalsModelView[uv3]);_uv3x=.5*_vector3.x+.5;_uv3y=.5*_vector3.y+.5;patternPath(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_uv1x,_uv1y,_uv2x,_uv2y,_uv3x,_uv3y,material.envMap)}}else{_color.copy(material.color);if(material.vertexColors===THREE.FaceColors){_color.multiply(element.color)}material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}}else if(material instanceof THREE.MeshDepthMaterial){_near=_camera.near;_far=_camera.far;_color1.r=_color1.g=_color1.b=1-smoothstep(v1.positionScreen.z*v1.positionScreen.w,_near,_far);_color2.r=_color2.g=_color2.b=1-smoothstep(v2.positionScreen.z*v2.positionScreen.w,_near,_far);_color3.r=_color3.g=_color3.b=1-smoothstep(v3.positionScreen.z*v3.positionScreen.w,_near,_far);_color4.addColors(_color2,_color3).multiplyScalar(.5);_image=getGradientTexture(_color1,_color2,_color3,_color4);clipImage(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,0,0,1,0,0,1,_image)}else if(material instanceof THREE.MeshNormalMaterial){var normal;if(material.shading==THREE.FlatShading){normal=element.normalModelView;_color.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}else if(material.shading==THREE.SmoothShading){normal=element.vertexNormalsModelView[uv1];_color1.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);normal=element.vertexNormalsModelView[uv2];
_color2.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);normal=element.vertexNormalsModelView[uv3];_color3.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);_color4.addColors(_color2,_color3).multiplyScalar(.5);_image=getGradientTexture(_color1,_color2,_color3,_color4);clipImage(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,0,0,1,0,0,1,_image)}}}function renderFace4(v1,v2,v3,v4,v5,v6,element,material){_this.info.render.vertices+=4;_this.info.render.faces++;setOpacity(material.opacity);setBlending(material.blending);if(material.map!==undefined&&material.map!==null||material.envMap!==undefined&&material.envMap!==null){renderFace3(v1,v2,v4,0,1,3,element,material);renderFace3(v5,v3,v6,1,2,3,element,material);return}_v1x=v1.positionScreen.x;_v1y=v1.positionScreen.y;_v2x=v2.positionScreen.x;_v2y=v2.positionScreen.y;_v3x=v3.positionScreen.x;_v3y=v3.positionScreen.y;_v4x=v4.positionScreen.x;_v4y=v4.positionScreen.y;_v5x=v5.positionScreen.x;_v5y=v5.positionScreen.y;_v6x=v6.positionScreen.x;_v6y=v6.positionScreen.y;if(material instanceof THREE.MeshLambertMaterial||material instanceof THREE.MeshPhongMaterial){_diffuseColor.copy(material.color);_emissiveColor.copy(material.emissive);if(material.vertexColors===THREE.FaceColors){_diffuseColor.multiply(element.color)}if(material.wireframe===false&&material.shading==THREE.SmoothShading&&element.vertexNormalsLength==4){_color1.copy(_ambientLight);_color2.copy(_ambientLight);_color3.copy(_ambientLight);_color4.copy(_ambientLight);calculateLight(element.v1.positionWorld,element.vertexNormalsModel[0],_color1);calculateLight(element.v2.positionWorld,element.vertexNormalsModel[1],_color2);calculateLight(element.v4.positionWorld,element.vertexNormalsModel[3],_color3);calculateLight(element.v3.positionWorld,element.vertexNormalsModel[2],_color4);_color1.multiply(_diffuseColor).add(_emissiveColor);_color2.multiply(_diffuseColor).add(_emissiveColor);_color3.multiply(_diffuseColor).add(_emissiveColor);_color4.multiply(_diffuseColor).add(_emissiveColor);_image=getGradientTexture(_color1,_color2,_color3,_color4);drawTriangle(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y);clipImage(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y,0,0,1,0,0,1,_image);drawTriangle(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y);clipImage(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y,1,0,1,1,0,1,_image)}else{_color.copy(_ambientLight);calculateLight(element.centroidModel,element.normalModel,_color);_color.multiply(_diffuseColor).add(_emissiveColor);drawQuad(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_v4x,_v4y);material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}}else if(material instanceof THREE.MeshBasicMaterial){_color.copy(material.color);if(material.vertexColors===THREE.FaceColors){_color.multiply(element.color)}drawQuad(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_v4x,_v4y);material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}else if(material instanceof THREE.MeshNormalMaterial){var normal;if(material.shading==THREE.FlatShading){normal=element.normalModelView;_color.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);drawQuad(_v1x,_v1y,_v2x,_v2y,_v3x,_v3y,_v4x,_v4y);material.wireframe===true?strokePath(_color,material.wireframeLinewidth,material.wireframeLinecap,material.wireframeLinejoin):fillPath(_color)}else if(material.shading==THREE.SmoothShading){normal=element.vertexNormalsModelView[0];_color1.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);normal=element.vertexNormalsModelView[1];_color2.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);normal=element.vertexNormalsModelView[3];_color3.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);normal=element.vertexNormalsModelView[2];_color4.setRGB(normal.x,normal.y,normal.z).multiplyScalar(.5).addScalar(.5);_image=getGradientTexture(_color1,_color2,_color3,_color4);drawTriangle(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y);clipImage(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y,0,0,1,0,0,1,_image);drawTriangle(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y);clipImage(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y,1,0,1,1,0,1,_image)}}else if(material instanceof THREE.MeshDepthMaterial){_near=_camera.near;_far=_camera.far;_color1.r=_color1.g=_color1.b=1-smoothstep(v1.positionScreen.z*v1.positionScreen.w,_near,_far);_color2.r=_color2.g=_color2.b=1-smoothstep(v2.positionScreen.z*v2.positionScreen.w,_near,_far);_color3.r=_color3.g=_color3.b=1-smoothstep(v4.positionScreen.z*v4.positionScreen.w,_near,_far);_color4.r=_color4.g=_color4.b=1-smoothstep(v3.positionScreen.z*v3.positionScreen.w,_near,_far);_image=getGradientTexture(_color1,_color2,_color3,_color4);drawTriangle(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y);clipImage(_v1x,_v1y,_v2x,_v2y,_v4x,_v4y,0,0,1,0,0,1,_image);drawTriangle(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y);clipImage(_v5x,_v5y,_v3x,_v3y,_v6x,_v6y,1,0,1,1,0,1,_image)}}function drawTriangle(x0,y0,x1,y1,x2,y2){_context.beginPath();_context.moveTo(x0,y0);_context.lineTo(x1,y1);_context.lineTo(x2,y2);_context.closePath()}function drawQuad(x0,y0,x1,y1,x2,y2,x3,y3){_context.beginPath();_context.moveTo(x0,y0);_context.lineTo(x1,y1);_context.lineTo(x2,y2);_context.lineTo(x3,y3);_context.closePath()}function strokePath(color,linewidth,linecap,linejoin){setLineWidth(linewidth);setLineCap(linecap);setLineJoin(linejoin);setStrokeStyle(color.getStyle());_context.stroke();_elemBox.expandByScalar(linewidth*2)}function fillPath(color){setFillStyle(color.getStyle());_context.fill()}function patternPath(x0,y0,x1,y1,x2,y2,u0,v0,u1,v1,u2,v2,texture){if(texture instanceof THREE.DataTexture||texture.image===undefined||texture.image.width==0)return;if(texture.needsUpdate===true){var repeatX=texture.wrapS==THREE.RepeatWrapping;var repeatY=texture.wrapT==THREE.RepeatWrapping;_patterns[texture.id]=_context.createPattern(texture.image,repeatX===true&&repeatY===true?"repeat":repeatX===true&&repeatY===false?"repeat-x":repeatX===false&&repeatY===true?"repeat-y":"no-repeat");texture.needsUpdate=false}_patterns[texture.id]===undefined?setFillStyle("rgba(0,0,0,1)"):setFillStyle(_patterns[texture.id]);var a,b,c,d,e,f,det,idet,offsetX=texture.offset.x/texture.repeat.x,offsetY=texture.offset.y/texture.repeat.y,width=texture.image.width*texture.repeat.x,height=texture.image.height*texture.repeat.y;u0=(u0+offsetX)*width;v0=(1-v0+offsetY)*height;u1=(u1+offsetX)*width;v1=(1-v1+offsetY)*height;u2=(u2+offsetX)*width;v2=(1-v2+offsetY)*height;x1-=x0;y1-=y0;x2-=x0;y2-=y0;u1-=u0;v1-=v0;u2-=u0;v2-=v0;det=u1*v2-u2*v1;if(det===0){if(_imagedatas[texture.id]===undefined){var canvas=document.createElement("canvas");canvas.width=texture.image.width;canvas.height=texture.image.height;var context=canvas.getContext("2d");context.drawImage(texture.image,0,0);_imagedatas[texture.id]=context.getImageData(0,0,texture.image.width,texture.image.height).data}var data=_imagedatas[texture.id];var index=(Math.floor(u0)+Math.floor(v0)*texture.image.width)*4;_color.setRGB(data[index]/255,data[index+1]/255,data[index+2]/255);fillPath(_color);return}idet=1/det;a=(v2*x1-v1*x2)*idet;b=(v2*y1-v1*y2)*idet;c=(u1*x2-u2*x1)*idet;d=(u1*y2-u2*y1)*idet;e=x0-a*u0-c*v0;f=y0-b*u0-d*v0;_context.save();_context.transform(a,b,c,d,e,f);_context.fill();_context.restore()}function clipImage(x0,y0,x1,y1,x2,y2,u0,v0,u1,v1,u2,v2,image){var a,b,c,d,e,f,det,idet,width=image.width-1,height=image.height-1;u0*=width;v0*=height;u1*=width;v1*=height;u2*=width;v2*=height;x1-=x0;y1-=y0;x2-=x0;y2-=y0;u1-=u0;v1-=v0;u2-=u0;v2-=v0;det=u1*v2-u2*v1;idet=1/det;a=(v2*x1-v1*x2)*idet;b=(v2*y1-v1*y2)*idet;c=(u1*x2-u2*x1)*idet;d=(u1*y2-u2*y1)*idet;e=x0-a*u0-c*v0;f=y0-b*u0-d*v0;_context.save();_context.transform(a,b,c,d,e,f);_context.clip();_context.drawImage(image,0,0);_context.restore()}function getGradientTexture(color1,color2,color3,color4){_pixelMapData[0]=color1.r*255|0;_pixelMapData[1]=color1.g*255|0;_pixelMapData[2]=color1.b*255|0;_pixelMapData[4]=color2.r*255|0;_pixelMapData[5]=color2.g*255|0;_pixelMapData[6]=color2.b*255|0;_pixelMapData[8]=color3.r*255|0;_pixelMapData[9]=color3.g*255|0;_pixelMapData[10]=color3.b*255|0;_pixelMapData[12]=color4.r*255|0;_pixelMapData[13]=color4.g*255|0;_pixelMapData[14]=color4.b*255|0;_pixelMapContext.putImageData(_pixelMapImage,0,0);_gradientMapContext.drawImage(_pixelMap,0,0);return _gradientMap}function expand(v1,v2,pixels){var x=v2.x-v1.x,y=v2.y-v1.y,det=x*x+y*y,idet;if(det===0)return;idet=pixels/Math.sqrt(det);x*=idet;y*=idet;v2.x+=x;v2.y+=y;v1.x-=x;v1.y-=y}function setOpacity(value){if(_contextGlobalAlpha!==value){_context.globalAlpha=value;_contextGlobalAlpha=value}}function setBlending(value){if(_contextGlobalCompositeOperation!==value){if(value===THREE.NormalBlending){_context.globalCompositeOperation="source-over"}else if(value===THREE.AdditiveBlending){_context.globalCompositeOperation="lighter"}else if(value===THREE.SubtractiveBlending){_context.globalCompositeOperation="darker"}_contextGlobalCompositeOperation=value}}function setLineWidth(value){if(_contextLineWidth!==value){_context.lineWidth=value;_contextLineWidth=value}}function setLineCap(value){if(_contextLineCap!==value){_context.lineCap=value;_contextLineCap=value}}function setLineJoin(value){if(_contextLineJoin!==value){_context.lineJoin=value;_contextLineJoin=value}}function setStrokeStyle(value){if(_contextStrokeStyle!==value){_context.strokeStyle=value;_contextStrokeStyle=value}}function setFillStyle(value){if(_contextFillStyle!==value){_context.fillStyle=value;_contextFillStyle=value}}function setDashAndGap(dashSizeValue,gapSizeValue){if(_contextDashSize!==dashSizeValue||_contextGapSize!==gapSizeValue){_context.setLineDash([dashSizeValue,gapSizeValue]);_contextDashSize=dashSizeValue;_contextGapSize=gapSizeValue}}};THREE.ShaderChunk={fog_pars_fragment:["#ifdef USE_FOG","uniform vec3 fogColor;","#ifdef FOG_EXP2","uniform float fogDensity;","#else","uniform float fogNear;","uniform float fogFar;","#endif","#endif"].join("\n"),fog_fragment:["#ifdef USE_FOG","float depth = gl_FragCoord.z / gl_FragCoord.w;","#ifdef FOG_EXP2","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","#else","float fogFactor = smoothstep( fogNear, fogFar, depth );","#endif","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","#endif"].join("\n"),envmap_pars_fragment:["#ifdef USE_ENVMAP","uniform float reflectivity;","uniform samplerCube envMap;","uniform float flipEnvMap;","uniform int combine;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","uniform bool useRefract;","uniform float refractionRatio;","#else","varying vec3 vReflect;","#endif","#endif"].join("\n"),envmap_fragment:["#ifdef USE_ENVMAP","vec3 reflectVec;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","reflectVec = refract( cameraToVertex, normal, refractionRatio );","} else { ","reflectVec = reflect( cameraToVertex, normal );","}","#else","reflectVec = vReflect;","#endif","#ifdef DOUBLE_SIDED","float flipNormal = ( -1.0 + 2.0 * float( gl_FrontFacing ) );","vec4 cubeColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );","#else","vec4 cubeColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );","#endif","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n"),envmap_pars_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )","varying vec3 vReflect;","uniform float refractionRatio;","uniform bool useRefract;","#endif"].join("\n"),worldpos_vertex:["#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )","#ifdef USE_SKINNING","vec4 worldPosition = modelMatrix * skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","#endif","#endif"].join("\n"),envmap_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormal = normalize( worldNormal );","vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );","if ( useRefract ) {","vReflect = refract( cameraToVertex, worldNormal, refractionRatio );","} else {","vReflect = reflect( cameraToVertex, worldNormal );","}","#endif"].join("\n"),map_particle_pars_fragment:["#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_particle_fragment:["#ifdef USE_MAP","gl_FragColor = gl_FragColor * texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );","#endif"].join("\n"),map_pars_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )","varying vec2 vUv;","uniform vec4 offsetRepeat;","#endif"].join("\n"),map_pars_fragment:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )","varying vec2 vUv;","#endif","#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )","vUv = uv * offsetRepeat.zw + offsetRepeat.xy;","#endif"].join("\n"),map_fragment:["#ifdef USE_MAP","vec4 texelColor = texture2D( map, vUv );","#ifdef GAMMA_INPUT","texelColor.xyz *= texelColor.xyz;","#endif","gl_FragColor = gl_FragColor * texelColor;","#endif"].join("\n"),lightmap_pars_fragment:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","uniform sampler2D lightMap;","#endif"].join("\n"),lightmap_pars_vertex:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","#endif"].join("\n"),lightmap_fragment:["#ifdef USE_LIGHTMAP","gl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );","#endif"].join("\n"),lightmap_vertex:["#ifdef USE_LIGHTMAP","vUv2 = uv2;","#endif"].join("\n"),bumpmap_pars_fragment:["#ifdef USE_BUMPMAP","uniform sampler2D bumpMap;","uniform float bumpScale;","vec2 dHdxy_fwd() {","vec2 dSTdx = dFdx( vUv );","vec2 dSTdy = dFdy( vUv );","float Hll = bumpScale * texture2D( bumpMap, vUv ).x;","float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 R1 = cross( vSigmaY, vN );","vec3 R2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, R1 );","vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","return normalize( abs( fDet ) * surf_norm - vGrad );","}","#endif"].join("\n"),normalmap_pars_fragment:["#ifdef USE_NORMALMAP","uniform sampler2D normalMap;","uniform vec2 normalScale;","vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {","vec3 q0 = dFdx( eye_pos.xyz );","vec3 q1 = dFdy( eye_pos.xyz );","vec2 st0 = dFdx( vUv.st );","vec2 st1 = dFdy( vUv.st );","vec3 S = normalize(  q0 * st1.t - q1 * st0.t );","vec3 T = normalize( -q0 * st1.s + q1 * st0.s );","vec3 N = normalize( surf_norm );","vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;","mapN.xy = normalScale * mapN.xy;","mat3 tsn = mat3( S, T, N );","return normalize( tsn * mapN );","}","#endif"].join("\n"),specularmap_pars_fragment:["#ifdef USE_SPECULARMAP","uniform sampler2D specularMap;","#endif"].join("\n"),specularmap_fragment:["float specularStrength;","#ifdef USE_SPECULARMAP","vec4 texelSpecular = texture2D( specularMap, vUv );","specularStrength = texelSpecular.r;","#else","specularStrength = 1.0;","#endif"].join("\n"),lights_lambert_pars_vertex:["uniform vec3 ambient;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif"].join("\n"),lights_lambert_vertex:["vLightFront = vec3( 0.0 );","#ifdef DOUBLE_SIDED","vLightBack = vec3( 0.0 );","#endif","transformedNormal = normalize( transformedNormal );","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, dirVector );","vec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","directionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","directionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += directionalLightColor[ i ] * directionalLightWeighting;","#ifdef DOUBLE_SIDED","vLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;","#endif","}","#endif","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","pointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","pointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;","#ifdef DOUBLE_SIDED","vLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","spotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","spotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;","#ifdef DOUBLE_SIDED","vLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_HEMI_LIGHTS > 0","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","float hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;","vLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","#ifdef DOUBLE_SIDED","vLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );","#endif","}","#endif","vLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;","#ifdef DOUBLE_SIDED","vLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;","#endif"].join("\n"),lights_phong_pars_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","varying vec3 vWorldPosition;","#endif"].join("\n"),lights_phong_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","vWorldPosition = worldPosition.xyz;","#endif"].join("\n"),lights_phong_pars_fragment:["uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","varying vec3 vWorldPosition;","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),lights_phong_fragment:["vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );","#ifdef DOUBLE_SIDED","normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -vViewPosition, normal );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lDistance = vPointLight[ i ].w;","#endif","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dotProduct, 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dotProduct, 0.0 );","#endif","pointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization;","#else","pointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lDistance = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dotProduct, 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dotProduct, 0.0 );","#endif","spotDiffuse += diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;","vec3 spotHalfVector = normalize( lVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect;","#else","spotSpecular += specular * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += diffuse * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, shininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotProductGround = dot( normal, lVectorGround );","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlickSky = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );","vec3 schlickGround = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );","hemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );","#else","hemiSpecular += specular * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif"].join("\n"),color_pars_fragment:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_fragment:["#ifdef USE_COLOR","gl_FragColor = gl_FragColor * vec4( vColor, opacity );","#endif"].join("\n"),color_pars_vertex:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_vertex:["#ifdef USE_COLOR","#ifdef GAMMA_INPUT","vColor = color * color;","#else","vColor = color;","#endif","#endif"].join("\n"),skinning_pars_vertex:["#ifdef USE_SKINNING","#ifdef BONE_TEXTURE","uniform sampler2D boneTexture;","mat4 getBoneMatrix( const in float i ) {","float j = i * 4.0;","float x = mod( j, N_BONE_PIXEL_X );","float y = floor( j / N_BONE_PIXEL_X );","const float dx = 1.0 / N_BONE_PIXEL_X;","const float dy = 1.0 / N_BONE_PIXEL_Y;","y = dy * ( y + 0.5 );","vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );","vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );","vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );","vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );","mat4 bone = mat4( v1, v2, v3, v4 );","return bone;","}","#else","uniform mat4 boneGlobalMatrices[ MAX_BONES ];","mat4 getBoneMatrix( const in float i ) {","mat4 bone = boneGlobalMatrices[ int(i) ];","return bone;","}","#endif","#endif"].join("\n"),skinbase_vertex:["#ifdef USE_SKINNING","mat4 boneMatX = getBoneMatrix( skinIndex.x );","mat4 boneMatY = getBoneMatrix( skinIndex.y );","#endif"].join("\n"),skinning_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHTARGETS","vec4 skinVertex = vec4( morphed, 1.0 );","#else","vec4 skinVertex = vec4( position, 1.0 );","#endif","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","#endif"].join("\n"),morphtarget_pars_vertex:["#ifdef USE_MORPHTARGETS","#ifndef USE_MORPHNORMALS","uniform float morphTargetInfluences[ 8 ];","#else","uniform float morphTargetInfluences[ 4 ];","#endif","#endif"].join("\n"),morphtarget_vertex:["#ifdef USE_MORPHTARGETS","vec3 morphed = vec3( 0.0 );","morphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];","morphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];","morphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];","morphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];","#ifndef USE_MORPHNORMALS","morphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];","morphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];","morphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];","morphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];","#endif","morphed += position;","#endif"].join("\n"),default_vertex:["vec4 mvPosition;","#ifdef USE_SKINNING","mvPosition = modelViewMatrix * skinned;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( morphed, 1.0 );","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( position, 1.0 );","#endif","gl_Position = projectionMatrix * mvPosition;"].join("\n"),morphnormal_vertex:["#ifdef USE_MORPHNORMALS","vec3 morphedNormal = vec3( 0.0 );","morphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];","morphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];","morphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];","morphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];","morphedNormal += normal;","#endif"].join("\n"),skinnormal_vertex:["#ifdef USE_SKINNING","mat4 skinMatrix = skinWeight.x * boneMatX;","skinMatrix 	+= skinWeight.y * boneMatY;","#ifdef USE_MORPHNORMALS","vec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );","#else","vec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );","#endif","#endif"].join("\n"),defaultnormal_vertex:["vec3 objectNormal;","#ifdef USE_SKINNING","objectNormal = skinnedNormal.xyz;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS )","objectNormal = morphedNormal;","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS )","objectNormal = normal;","#endif","#ifdef FLIP_SIDED","objectNormal = -objectNormal;","#endif","vec3 transformedNormal = normalMatrix * objectNormal;"].join("\n"),shadowmap_pars_fragment:["#ifdef USE_SHADOWMAP","uniform sampler2D shadowMap[ MAX_SHADOWS ];","uniform vec2 shadowMapSize[ MAX_SHADOWS ];","uniform float shadowDarkness[ MAX_SHADOWS ];","uniform float shadowBias[ MAX_SHADOWS ];","varying vec4 vShadowCoord[ MAX_SHADOWS ];","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","#endif"].join("\n"),shadowmap_fragment:["#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","#ifdef SHADOWMAP_CASCADE","int inFrustumCount = 0;","#endif","float fDepth;","vec3 shadowColor = vec3( 1.0 );","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","#ifdef SHADOWMAP_CASCADE","inFrustumCount += int( inFrustum );","bvec3 frustumTestVec = bvec3( inFrustum, inFrustumCount == 1, shadowCoord.z <= 1.0 );","#else","bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","#endif","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","shadowCoord.z += shadowBias[ i ];","#if defined( SHADOWMAP_TYPE_PCF )","float shadow = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","mat3 depthKernel;","depthKernel[0][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","depthKernel[0][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","depthKernel[0][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","depthKernel[1][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","depthKernel[1][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","depthKernel[1][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","depthKernel[2][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","depthKernel[2][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","depthKernel[2][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","vec3 shadowZ = vec3( shadowCoord.z );","shadowKernel[0] = vec3(lessThan(depthKernel[0], shadowZ ));","shadowKernel[0] *= vec3(0.25);","shadowKernel[1] = vec3(lessThan(depthKernel[1], shadowZ ));","shadowKernel[1] *= vec3(0.25);","shadowKernel[2] = vec3(lessThan(depthKernel[2], shadowZ ));","shadowKernel[2] *= vec3(0.25);","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize[i].xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadow = dot( shadowValues, vec4( 1.0 ) );","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#else","vec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );","float fDepth = unpackDepth( rgbaDepth );","if ( fDepth < shadowCoord.z )","shadowColor = shadowColor * vec3( 1.0 - shadowDarkness[ i ] );","#endif","}","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( inFrustum && inFrustumCount == 1 ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","#ifdef GAMMA_OUTPUT","shadowColor *= shadowColor;","#endif","gl_FragColor.xyz = gl_FragColor.xyz * shadowColor;","#endif"].join("\n"),shadowmap_pars_vertex:["#ifdef USE_SHADOWMAP","varying vec4 vShadowCoord[ MAX_SHADOWS ];","uniform mat4 shadowMatrix[ MAX_SHADOWS ];","#endif"].join("\n"),shadowmap_vertex:["#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;","}","#endif"].join("\n"),alphatest_fragment:["#ifdef ALPHATEST","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif"].join("\n"),linear_to_gamma_fragment:["#ifdef GAMMA_OUTPUT","gl_FragColor.xyz = sqrt( gl_FragColor.xyz );","#endif"].join("\n")};
THREE.UniformsUtils={merge:function(uniforms){var u,p,tmp,merged={};for(u=0;u<uniforms.length;u++){tmp=this.clone(uniforms[u]);for(p in tmp){merged[p]=tmp[p]}}return merged},clone:function(uniforms_src){var u,p,parameter,parameter_src,uniforms_dst={};for(u in uniforms_src){uniforms_dst[u]={};for(p in uniforms_src[u]){parameter_src=uniforms_src[u][p];if(parameter_src instanceof THREE.Color||parameter_src instanceof THREE.Vector2||parameter_src instanceof THREE.Vector3||parameter_src instanceof THREE.Vector4||parameter_src instanceof THREE.Matrix4||parameter_src instanceof THREE.Texture){uniforms_dst[u][p]=parameter_src.clone()}else if(parameter_src instanceof Array){uniforms_dst[u][p]=parameter_src.slice()}else{uniforms_dst[u][p]=parameter_src}}}return uniforms_dst}};THREE.UniformsLib={common:{diffuse:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:null},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)},lightMap:{type:"t",value:null},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},flipEnvMap:{type:"f",value:-1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new THREE.Vector2(1,1)}},fog:{fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new THREE.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},hemisphereLightDirection:{type:"fv",value:[]},hemisphereLightSkyColor:{type:"fv",value:[]},hemisphereLightGroundColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngleCos:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]}},particle:{psColor:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new THREE.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]}}};THREE.ShaderLib={basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["common"],THREE.UniformsLib["fog"],THREE.UniformsLib["shadowmap"]]),vertexShader:[THREE.ShaderChunk["map_pars_vertex"],THREE.ShaderChunk["lightmap_pars_vertex"],THREE.ShaderChunk["envmap_pars_vertex"],THREE.ShaderChunk["color_pars_vertex"],THREE.ShaderChunk["morphtarget_pars_vertex"],THREE.ShaderChunk["skinning_pars_vertex"],THREE.ShaderChunk["shadowmap_pars_vertex"],"void main() {",THREE.ShaderChunk["map_vertex"],THREE.ShaderChunk["lightmap_vertex"],THREE.ShaderChunk["color_vertex"],THREE.ShaderChunk["skinbase_vertex"],"#ifdef USE_ENVMAP",THREE.ShaderChunk["morphnormal_vertex"],THREE.ShaderChunk["skinnormal_vertex"],THREE.ShaderChunk["defaultnormal_vertex"],"#endif",THREE.ShaderChunk["morphtarget_vertex"],THREE.ShaderChunk["skinning_vertex"],THREE.ShaderChunk["default_vertex"],THREE.ShaderChunk["worldpos_vertex"],THREE.ShaderChunk["envmap_vertex"],THREE.ShaderChunk["shadowmap_vertex"],"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;",THREE.ShaderChunk["color_pars_fragment"],THREE.ShaderChunk["map_pars_fragment"],THREE.ShaderChunk["lightmap_pars_fragment"],THREE.ShaderChunk["envmap_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],THREE.ShaderChunk["shadowmap_pars_fragment"],THREE.ShaderChunk["specularmap_pars_fragment"],"void main() {","gl_FragColor = vec4( diffuse, opacity );",THREE.ShaderChunk["map_fragment"],THREE.ShaderChunk["alphatest_fragment"],THREE.ShaderChunk["specularmap_fragment"],THREE.ShaderChunk["lightmap_fragment"],THREE.ShaderChunk["color_fragment"],THREE.ShaderChunk["envmap_fragment"],THREE.ShaderChunk["shadowmap_fragment"],THREE.ShaderChunk["linear_to_gamma_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n")},lambert:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["common"],THREE.UniformsLib["fog"],THREE.UniformsLib["lights"],THREE.UniformsLib["shadowmap"],{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk["map_pars_vertex"],THREE.ShaderChunk["lightmap_pars_vertex"],THREE.ShaderChunk["envmap_pars_vertex"],THREE.ShaderChunk["lights_lambert_pars_vertex"],THREE.ShaderChunk["color_pars_vertex"],THREE.ShaderChunk["morphtarget_pars_vertex"],THREE.ShaderChunk["skinning_pars_vertex"],THREE.ShaderChunk["shadowmap_pars_vertex"],"void main() {",THREE.ShaderChunk["map_vertex"],THREE.ShaderChunk["lightmap_vertex"],THREE.ShaderChunk["color_vertex"],THREE.ShaderChunk["morphnormal_vertex"],THREE.ShaderChunk["skinbase_vertex"],THREE.ShaderChunk["skinnormal_vertex"],THREE.ShaderChunk["defaultnormal_vertex"],THREE.ShaderChunk["morphtarget_vertex"],THREE.ShaderChunk["skinning_vertex"],THREE.ShaderChunk["default_vertex"],THREE.ShaderChunk["worldpos_vertex"],THREE.ShaderChunk["envmap_vertex"],THREE.ShaderChunk["lights_lambert_vertex"],THREE.ShaderChunk["shadowmap_vertex"],"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk["color_pars_fragment"],THREE.ShaderChunk["map_pars_fragment"],THREE.ShaderChunk["lightmap_pars_fragment"],THREE.ShaderChunk["envmap_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],THREE.ShaderChunk["shadowmap_pars_fragment"],THREE.ShaderChunk["specularmap_pars_fragment"],"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk["map_fragment"],THREE.ShaderChunk["alphatest_fragment"],THREE.ShaderChunk["specularmap_fragment"],"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",THREE.ShaderChunk["lightmap_fragment"],THREE.ShaderChunk["color_fragment"],THREE.ShaderChunk["envmap_fragment"],THREE.ShaderChunk["shadowmap_fragment"],THREE.ShaderChunk["linear_to_gamma_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n")},phong:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["common"],THREE.UniformsLib["bump"],THREE.UniformsLib["normalmap"],THREE.UniformsLib["fog"],THREE.UniformsLib["lights"],THREE.UniformsLib["shadowmap"],{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},specular:{type:"c",value:new THREE.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;",THREE.ShaderChunk["map_pars_vertex"],THREE.ShaderChunk["lightmap_pars_vertex"],THREE.ShaderChunk["envmap_pars_vertex"],THREE.ShaderChunk["lights_phong_pars_vertex"],THREE.ShaderChunk["color_pars_vertex"],THREE.ShaderChunk["morphtarget_pars_vertex"],THREE.ShaderChunk["skinning_pars_vertex"],THREE.ShaderChunk["shadowmap_pars_vertex"],"void main() {",THREE.ShaderChunk["map_vertex"],THREE.ShaderChunk["lightmap_vertex"],THREE.ShaderChunk["color_vertex"],THREE.ShaderChunk["morphnormal_vertex"],THREE.ShaderChunk["skinbase_vertex"],THREE.ShaderChunk["skinnormal_vertex"],THREE.ShaderChunk["defaultnormal_vertex"],"vNormal = normalize( transformedNormal );",THREE.ShaderChunk["morphtarget_vertex"],THREE.ShaderChunk["skinning_vertex"],THREE.ShaderChunk["default_vertex"],"vViewPosition = -mvPosition.xyz;",THREE.ShaderChunk["worldpos_vertex"],THREE.ShaderChunk["envmap_vertex"],THREE.ShaderChunk["lights_phong_vertex"],THREE.ShaderChunk["shadowmap_vertex"],"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;",THREE.ShaderChunk["color_pars_fragment"],THREE.ShaderChunk["map_pars_fragment"],THREE.ShaderChunk["lightmap_pars_fragment"],THREE.ShaderChunk["envmap_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],THREE.ShaderChunk["lights_phong_pars_fragment"],THREE.ShaderChunk["shadowmap_pars_fragment"],THREE.ShaderChunk["bumpmap_pars_fragment"],THREE.ShaderChunk["normalmap_pars_fragment"],THREE.ShaderChunk["specularmap_pars_fragment"],"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk["map_fragment"],THREE.ShaderChunk["alphatest_fragment"],THREE.ShaderChunk["specularmap_fragment"],THREE.ShaderChunk["lights_phong_fragment"],THREE.ShaderChunk["lightmap_fragment"],THREE.ShaderChunk["color_fragment"],THREE.ShaderChunk["envmap_fragment"],THREE.ShaderChunk["shadowmap_fragment"],THREE.ShaderChunk["linear_to_gamma_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n")},particle_basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["particle"],THREE.UniformsLib["shadowmap"]]),vertexShader:["uniform float size;","uniform float scale;",THREE.ShaderChunk["color_pars_vertex"],THREE.ShaderChunk["shadowmap_pars_vertex"],"void main() {",THREE.ShaderChunk["color_vertex"],"vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif","gl_Position = projectionMatrix * mvPosition;",THREE.ShaderChunk["worldpos_vertex"],THREE.ShaderChunk["shadowmap_vertex"],"}"].join("\n"),fragmentShader:["uniform vec3 psColor;","uniform float opacity;",THREE.ShaderChunk["color_pars_fragment"],THREE.ShaderChunk["map_particle_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],THREE.ShaderChunk["shadowmap_pars_fragment"],"void main() {","gl_FragColor = vec4( psColor, opacity );",THREE.ShaderChunk["map_particle_fragment"],THREE.ShaderChunk["alphatest_fragment"],THREE.ShaderChunk["color_fragment"],THREE.ShaderChunk["shadowmap_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n")},dashed:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["common"],THREE.UniformsLib["fog"],{scale:{type:"f",value:1},dashSize:{type:"f",value:1},totalSize:{type:"f",value:2}}]),vertexShader:["uniform float scale;","attribute float lineDistance;","varying float vLineDistance;",THREE.ShaderChunk["color_pars_vertex"],"void main() {",THREE.ShaderChunk["color_vertex"],"vLineDistance = scale * lineDistance;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform float dashSize;","uniform float totalSize;","varying float vLineDistance;",THREE.ShaderChunk["color_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],"void main() {","if ( mod( vLineDistance, totalSize ) > dashSize ) {","discard;","}","gl_FragColor = vec4( diffuse, opacity );",THREE.ShaderChunk["color_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n")},depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2e3},opacity:{type:"f",value:1}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float mNear;","uniform float mFar;","uniform float opacity;","void main() {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float color = 1.0 - smoothstep( mNear, mFar, depth );","gl_FragColor = vec4( vec3( color ), opacity );","}"].join("\n")},normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:["varying vec3 vNormal;",THREE.ShaderChunk["morphtarget_pars_vertex"],"void main() {","vNormal = normalize( normalMatrix * normal );",THREE.ShaderChunk["morphtarget_vertex"],THREE.ShaderChunk["default_vertex"],"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vNormal;","void main() {","gl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );","}"].join("\n")},normalmap:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["fog"],THREE.UniformsLib["lights"],THREE.UniformsLib["shadowmap"],{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},enableDisplacement:{type:"i",value:0},tDisplacement:{type:"t",value:null},tDiffuse:{type:"t",value:null},tCube:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tAO:{type:"t",value:null},uNormalScale:{type:"v2",value:new THREE.Vector2(1,1)},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new THREE.Color(16777215)},uSpecularColor:{type:"c",value:new THREE.Color(1118481)},uAmbientColor:{type:"c",value:new THREE.Color(16777215)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},useRefract:{type:"i",value:0},uRefractionRatio:{type:"f",value:.98},uReflectivity:{type:"f",value:.5},uOffset:{type:"v2",value:new THREE.Vector2(0,0)},uRepeat:{type:"v2",value:new THREE.Vector2(1,1)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),fragmentShader:["uniform vec3 uAmbientColor;","uniform vec3 uDiffuseColor;","uniform vec3 uSpecularColor;","uniform float uShininess;","uniform float uOpacity;","uniform bool enableDiffuse;","uniform bool enableSpecular;","uniform bool enableAO;","uniform bool enableReflection;","uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform sampler2D tSpecular;","uniform sampler2D tAO;","uniform samplerCube tCube;","uniform vec2 uNormalScale;","uniform bool useRefract;","uniform float uRefractionRatio;","uniform float uReflectivity;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",THREE.ShaderChunk["shadowmap_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],"void main() {","gl_FragColor = vec4( vec3( 1.0 ), uOpacity );","vec3 specularTex = vec3( 1.0 );","vec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","if( enableDiffuse ) {","#ifdef GAMMA_INPUT","vec4 texelColor = texture2D( tDiffuse, vUv );","texelColor.xyz *= texelColor.xyz;","gl_FragColor = gl_FragColor * texelColor;","#else","gl_FragColor = gl_FragColor * texture2D( tDiffuse, vUv );","#endif","}","if( enableAO ) {","#ifdef GAMMA_INPUT","vec4 aoColor = texture2D( tAO, vUv );","aoColor.xyz *= aoColor.xyz;","gl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;","#else","gl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, vUv ).xyz;","#endif","}","if( enableSpecular )","specularTex = texture2D( tSpecular, vUv ).xyz;","mat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );","vec3 finalNormal = tsb * normalTex;","#ifdef FLIP_SIDED","finalNormal = -finalNormal;","#endif","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 pointVector = lPosition.xyz + vViewPosition.xyz;","float pointDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","pointDistance = 1.0 - min( ( length( pointVector ) / pointLightDistance[ i ] ), 1.0 );","pointVector = normalize( pointVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );","#endif","pointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;","vec3 pointHalfVector = normalize( pointVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( pointVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * pointDistance * specularNormalization;","#else","pointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 spotVector = lPosition.xyz + vViewPosition.xyz;","float spotDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","spotDistance = 1.0 - min( ( length( spotVector ) / spotLightDistance[ i ] ), 1.0 );","spotVector = normalize( spotVector );","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dot( normal, spotVector ), 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dot( normal, spotVector ) + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dot( normal, spotVector ), 0.0 );","#endif","spotDiffuse += spotDistance * spotLightColor[ i ] * uDiffuseColor * spotDiffuseWeight * spotEffect;","vec3 spotHalfVector = normalize( spotVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularTex.r * max( pow( spotDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( spotVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * spotDistance * specularNormalization * spotEffect;","#else","spotSpecular += spotDistance * spotLightColor[ i ] * uSpecularColor * spotSpecularWeight * spotDiffuseWeight * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","#ifdef WRAP_AROUND","float directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );","float directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","#endif","dirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += uDiffuseColor * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularTex.r * max( pow( hemiDotNormalHalfSky, uShininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularTex.r * max( pow( hemiDotNormalHalfGround, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotProductGround = dot( normal, lVectorGround );","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlickSky = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );","vec3 schlickGround = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );","hemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );","#else","hemiSpecular += uSpecularColor * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor ) + totalSpecular;","#endif","if ( enableReflection ) {","vec3 vReflect;","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","vReflect = refract( cameraToVertex, normal, uRefractionRatio );","} else {","vReflect = reflect( cameraToVertex, normal );","}","vec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * uReflectivity );","}",THREE.ShaderChunk["shadowmap_fragment"],THREE.ShaderChunk["linear_to_gamma_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n"),vertexShader:["attribute vec4 tangent;","uniform vec2 uOffset;","uniform vec2 uRepeat;","uniform bool enableDisplacement;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",THREE.ShaderChunk["skinning_pars_vertex"],THREE.ShaderChunk["shadowmap_pars_vertex"],"void main() {",THREE.ShaderChunk["skinbase_vertex"],THREE.ShaderChunk["skinnormal_vertex"],"#ifdef USE_SKINNING","vNormal = normalize( normalMatrix * skinnedNormal.xyz );","vec4 skinnedTangent = skinMatrix * vec4( tangent.xyz, 0.0 );","vTangent = normalize( normalMatrix * skinnedTangent.xyz );","#else","vNormal = normalize( normalMatrix * normal );","vTangent = normalize( normalMatrix * tangent.xyz );","#endif","vBinormal = normalize( cross( vNormal, vTangent ) * tangent.w );","vUv = uv * uRepeat + uOffset;","vec3 displacedPosition;","#ifdef VERTEX_TEXTURES","if ( enableDisplacement ) {","vec3 dv = texture2D( tDisplacement, uv ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","displacedPosition = position + normalize( normal ) * df;","} else {","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","}","#else","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","#endif","vec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );","vec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );","gl_Position = projectionMatrix * mvPosition;","vWorldPosition = worldPosition.xyz;","vViewPosition = -mvPosition.xyz;","#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;","}","#endif","}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","uniform float tFlip;","varying vec3 vWorldPosition;","void main() {","gl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );","}"].join("\n")},depthRGBA:{uniforms:{},vertexShader:[THREE.ShaderChunk["morphtarget_pars_vertex"],THREE.ShaderChunk["skinning_pars_vertex"],"void main() {",THREE.ShaderChunk["skinbase_vertex"],THREE.ShaderChunk["morphtarget_vertex"],THREE.ShaderChunk["skinning_vertex"],THREE.ShaderChunk["default_vertex"],"}"].join("\n"),fragmentShader:["vec4 pack_depth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = fract( depth * bit_shift );","res -= res.xxyz * bit_mask;","return res;","}","void main() {","gl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );","}"].join("\n")}};THREE.WebGLRenderer=function(parameters){console.log("THREE.WebGLRenderer",THREE.REVISION);parameters=parameters||{};var _canvas=parameters.canvas!==undefined?parameters.canvas:document.createElement("canvas"),_precision=parameters.precision!==undefined?parameters.precision:"highp",_alpha=parameters.alpha!==undefined?parameters.alpha:true,_premultipliedAlpha=parameters.premultipliedAlpha!==undefined?parameters.premultipliedAlpha:true,_antialias=parameters.antialias!==undefined?parameters.antialias:false,_stencil=parameters.stencil!==undefined?parameters.stencil:true,_preserveDrawingBuffer=parameters.preserveDrawingBuffer!==undefined?parameters.preserveDrawingBuffer:false,_clearColor=new THREE.Color(0),_clearAlpha=0;if(parameters.clearColor!==undefined){console.warn("DEPRECATED: clearColor in WebGLRenderer constructor parameters is being removed. Use .setClearColor() instead.");_clearColor.setHex(parameters.clearColor)}if(parameters.clearAlpha!==undefined){console.warn("DEPRECATED: clearAlpha in WebGLRenderer constructor parameters is being removed. Use .setClearColor() instead.");_clearAlpha=parameters.clearAlpha}this.domElement=_canvas;this.context=null;this.devicePixelRatio=parameters.devicePixelRatio!==undefined?parameters.devicePixelRatio:window.devicePixelRatio!==undefined?window.devicePixelRatio:1;this.autoClear=true;this.autoClearColor=true;this.autoClearDepth=true;this.autoClearStencil=true;this.sortObjects=true;this.autoUpdateObjects=true;this.gammaInput=false;this.gammaOutput=false;this.physicallyBasedShading=false;this.shadowMapEnabled=false;this.shadowMapAutoUpdate=true;this.shadowMapType=THREE.PCFShadowMap;this.shadowMapCullFace=THREE.CullFaceFront;this.shadowMapDebug=false;this.shadowMapCascade=false;this.maxMorphTargets=8;this.maxMorphNormals=4;this.autoScaleCubemaps=true;this.renderPluginsPre=[];this.renderPluginsPost=[];this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}};var _this=this,_programs=[],_programs_counter=0,_currentProgram=null,_currentFramebuffer=null,_currentMaterialId=-1,_currentGeometryGroupHash=null,_currentCamera=null,_geometryGroupCounter=0,_usedTextureUnits=0,_oldDoubleSided=-1,_oldFlipSided=-1,_oldBlending=-1,_oldBlendEquation=-1,_oldBlendSrc=-1,_oldBlendDst=-1,_oldDepthTest=-1,_oldDepthWrite=-1,_oldPolygonOffset=null,_oldPolygonOffsetFactor=null,_oldPolygonOffsetUnits=null,_oldLineWidth=null,_viewportX=0,_viewportY=0,_viewportWidth=0,_viewportHeight=0,_currentWidth=0,_currentHeight=0,_enabledAttributes={},_frustum=new THREE.Frustum,_projScreenMatrix=new THREE.Matrix4,_projScreenMatrixPS=new THREE.Matrix4,_vector3=new THREE.Vector3,_direction=new THREE.Vector3,_lightsNeedUpdate=true,_lights={ambient:[0,0,0],directional:{length:0,colors:new Array,positions:new Array},point:{length:0,colors:new Array,positions:new Array,distances:new Array},spot:{length:0,colors:new Array,positions:new Array,distances:new Array,directions:new Array,anglesCos:new Array,exponents:new Array},hemi:{length:0,skyColors:new Array,groundColors:new Array,positions:new Array}};var _gl;var _glExtensionTextureFloat;var _glExtensionStandardDerivatives;var _glExtensionTextureFilterAnisotropic;var _glExtensionCompressedTextureS3TC;initGL();setDefaultGLState();this.context=_gl;var _maxTextures=_gl.getParameter(_gl.MAX_TEXTURE_IMAGE_UNITS);var _maxVertexTextures=_gl.getParameter(_gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS);var _maxTextureSize=_gl.getParameter(_gl.MAX_TEXTURE_SIZE);var _maxCubemapSize=_gl.getParameter(_gl.MAX_CUBE_MAP_TEXTURE_SIZE);var _maxAnisotropy=_glExtensionTextureFilterAnisotropic?_gl.getParameter(_glExtensionTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0;var _supportsVertexTextures=_maxVertexTextures>0;var _supportsBoneTextures=_supportsVertexTextures&&_glExtensionTextureFloat;var _compressedTextureFormats=_glExtensionCompressedTextureS3TC?_gl.getParameter(_gl.COMPRESSED_TEXTURE_FORMATS):[];var _vertexShaderPrecisionHighpFloat=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.HIGH_FLOAT);
var _vertexShaderPrecisionMediumpFloat=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.MEDIUM_FLOAT);var _vertexShaderPrecisionLowpFloat=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.LOW_FLOAT);var _fragmentShaderPrecisionHighpFloat=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.HIGH_FLOAT);var _fragmentShaderPrecisionMediumpFloat=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.MEDIUM_FLOAT);var _fragmentShaderPrecisionLowpFloat=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.LOW_FLOAT);var _vertexShaderPrecisionHighpInt=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.HIGH_INT);var _vertexShaderPrecisionMediumpInt=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.MEDIUM_INT);var _vertexShaderPrecisionLowpInt=_gl.getShaderPrecisionFormat(_gl.VERTEX_SHADER,_gl.LOW_INT);var _fragmentShaderPrecisionHighpInt=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.HIGH_INT);var _fragmentShaderPrecisionMediumpInt=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.MEDIUM_INT);var _fragmentShaderPrecisionLowpInt=_gl.getShaderPrecisionFormat(_gl.FRAGMENT_SHADER,_gl.LOW_INT);var highpAvailable=_vertexShaderPrecisionHighpFloat.precision>0&&_fragmentShaderPrecisionHighpFloat.precision>0;var mediumpAvailable=_vertexShaderPrecisionMediumpFloat.precision>0&&_fragmentShaderPrecisionMediumpFloat.precision>0;if(_precision==="highp"&&!highpAvailable){if(mediumpAvailable){_precision="mediump";console.warn("WebGLRenderer: highp not supported, using mediump")}else{_precision="lowp";console.warn("WebGLRenderer: highp and mediump not supported, using lowp")}}if(_precision==="mediump"&&!mediumpAvailable){_precision="lowp";console.warn("WebGLRenderer: mediump not supported, using lowp")}this.getContext=function(){return _gl};this.supportsVertexTextures=function(){return _supportsVertexTextures};this.supportsFloatTextures=function(){return _glExtensionTextureFloat};this.supportsStandardDerivatives=function(){return _glExtensionStandardDerivatives};this.supportsCompressedTextureS3TC=function(){return _glExtensionCompressedTextureS3TC};this.getMaxAnisotropy=function(){return _maxAnisotropy};this.getPrecision=function(){return _precision};this.setSize=function(width,height,updateStyle){_canvas.width=width*this.devicePixelRatio;_canvas.height=height*this.devicePixelRatio;if(this.devicePixelRatio!==1&&updateStyle!==false){_canvas.style.width=width+"px";_canvas.style.height=height+"px"}this.setViewport(0,0,_canvas.width,_canvas.height)};this.setViewport=function(x,y,width,height){_viewportX=x!==undefined?x:0;_viewportY=y!==undefined?y:0;_viewportWidth=width!==undefined?width:_canvas.width;_viewportHeight=height!==undefined?height:_canvas.height;_gl.viewport(_viewportX,_viewportY,_viewportWidth,_viewportHeight)};this.setScissor=function(x,y,width,height){_gl.scissor(x,y,width,height)};this.enableScissorTest=function(enable){enable?_gl.enable(_gl.SCISSOR_TEST):_gl.disable(_gl.SCISSOR_TEST)};this.setClearColor=function(color,alpha){_clearColor.set(color);_clearAlpha=alpha!==undefined?alpha:1;_gl.clearColor(_clearColor.r,_clearColor.g,_clearColor.b,_clearAlpha)};this.setClearColorHex=function(hex,alpha){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(hex,alpha)};this.getClearColor=function(){return _clearColor};this.getClearAlpha=function(){return _clearAlpha};this.clear=function(color,depth,stencil){var bits=0;if(color===undefined||color)bits|=_gl.COLOR_BUFFER_BIT;if(depth===undefined||depth)bits|=_gl.DEPTH_BUFFER_BIT;if(stencil===undefined||stencil)bits|=_gl.STENCIL_BUFFER_BIT;_gl.clear(bits)};this.clearTarget=function(renderTarget,color,depth,stencil){this.setRenderTarget(renderTarget);this.clear(color,depth,stencil)};this.addPostPlugin=function(plugin){plugin.init(this);this.renderPluginsPost.push(plugin)};this.addPrePlugin=function(plugin){plugin.init(this);this.renderPluginsPre.push(plugin)};this.updateShadowMap=function(scene,camera){_currentProgram=null;_oldBlending=-1;_oldDepthTest=-1;_oldDepthWrite=-1;_currentGeometryGroupHash=-1;_currentMaterialId=-1;_lightsNeedUpdate=true;_oldDoubleSided=-1;_oldFlipSided=-1;this.shadowMapPlugin.update(scene,camera)};function createParticleBuffers(geometry){geometry.__webglVertexBuffer=_gl.createBuffer();geometry.__webglColorBuffer=_gl.createBuffer();_this.info.memory.geometries++}function createLineBuffers(geometry){geometry.__webglVertexBuffer=_gl.createBuffer();geometry.__webglColorBuffer=_gl.createBuffer();geometry.__webglLineDistanceBuffer=_gl.createBuffer();_this.info.memory.geometries++}function createRibbonBuffers(geometry){geometry.__webglVertexBuffer=_gl.createBuffer();geometry.__webglColorBuffer=_gl.createBuffer();geometry.__webglNormalBuffer=_gl.createBuffer();_this.info.memory.geometries++}function createMeshBuffers(geometryGroup){geometryGroup.__webglVertexBuffer=_gl.createBuffer();geometryGroup.__webglNormalBuffer=_gl.createBuffer();geometryGroup.__webglTangentBuffer=_gl.createBuffer();geometryGroup.__webglColorBuffer=_gl.createBuffer();geometryGroup.__webglUVBuffer=_gl.createBuffer();geometryGroup.__webglUV2Buffer=_gl.createBuffer();geometryGroup.__webglSkinIndicesBuffer=_gl.createBuffer();geometryGroup.__webglSkinWeightsBuffer=_gl.createBuffer();geometryGroup.__webglFaceBuffer=_gl.createBuffer();geometryGroup.__webglLineBuffer=_gl.createBuffer();var m,ml;if(geometryGroup.numMorphTargets){geometryGroup.__webglMorphTargetsBuffers=[];for(m=0,ml=geometryGroup.numMorphTargets;m<ml;m++){geometryGroup.__webglMorphTargetsBuffers.push(_gl.createBuffer())}}if(geometryGroup.numMorphNormals){geometryGroup.__webglMorphNormalsBuffers=[];for(m=0,ml=geometryGroup.numMorphNormals;m<ml;m++){geometryGroup.__webglMorphNormalsBuffers.push(_gl.createBuffer())}}_this.info.memory.geometries++}var onGeometryDispose=function(event){var geometry=event.target;geometry.removeEventListener("dispose",onGeometryDispose);deallocateGeometry(geometry);_this.info.memory.geometries--};var onTextureDispose=function(event){var texture=event.target;texture.removeEventListener("dispose",onTextureDispose);deallocateTexture(texture);_this.info.memory.textures--};var onRenderTargetDispose=function(event){var renderTarget=event.target;renderTarget.removeEventListener("dispose",onRenderTargetDispose);deallocateRenderTarget(renderTarget);_this.info.memory.textures--};var onMaterialDispose=function(event){var material=event.target;material.removeEventListener("dispose",onMaterialDispose);deallocateMaterial(material)};var deallocateGeometry=function(geometry){geometry.__webglInit=undefined;if(geometry.__webglVertexBuffer!==undefined)_gl.deleteBuffer(geometry.__webglVertexBuffer);if(geometry.__webglNormalBuffer!==undefined)_gl.deleteBuffer(geometry.__webglNormalBuffer);if(geometry.__webglTangentBuffer!==undefined)_gl.deleteBuffer(geometry.__webglTangentBuffer);if(geometry.__webglColorBuffer!==undefined)_gl.deleteBuffer(geometry.__webglColorBuffer);if(geometry.__webglUVBuffer!==undefined)_gl.deleteBuffer(geometry.__webglUVBuffer);if(geometry.__webglUV2Buffer!==undefined)_gl.deleteBuffer(geometry.__webglUV2Buffer);if(geometry.__webglSkinIndicesBuffer!==undefined)_gl.deleteBuffer(geometry.__webglSkinIndicesBuffer);if(geometry.__webglSkinWeightsBuffer!==undefined)_gl.deleteBuffer(geometry.__webglSkinWeightsBuffer);if(geometry.__webglFaceBuffer!==undefined)_gl.deleteBuffer(geometry.__webglFaceBuffer);if(geometry.__webglLineBuffer!==undefined)_gl.deleteBuffer(geometry.__webglLineBuffer);if(geometry.__webglLineDistanceBuffer!==undefined)_gl.deleteBuffer(geometry.__webglLineDistanceBuffer);if(geometry.geometryGroups!==undefined){for(var g in geometry.geometryGroups){var geometryGroup=geometry.geometryGroups[g];if(geometryGroup.numMorphTargets!==undefined){for(var m=0,ml=geometryGroup.numMorphTargets;m<ml;m++){_gl.deleteBuffer(geometryGroup.__webglMorphTargetsBuffers[m])}}if(geometryGroup.numMorphNormals!==undefined){for(var m=0,ml=geometryGroup.numMorphNormals;m<ml;m++){_gl.deleteBuffer(geometryGroup.__webglMorphNormalsBuffers[m])}}deleteCustomAttributesBuffers(geometryGroup)}}deleteCustomAttributesBuffers(geometry)};var deallocateTexture=function(texture){if(texture.image&&texture.image.__webglTextureCube){_gl.deleteTexture(texture.image.__webglTextureCube)}else{if(!texture.__webglInit)return;texture.__webglInit=false;_gl.deleteTexture(texture.__webglTexture)}};var deallocateRenderTarget=function(renderTarget){if(!renderTarget||!renderTarget.__webglTexture)return;_gl.deleteTexture(renderTarget.__webglTexture);if(renderTarget instanceof THREE.WebGLRenderTargetCube){for(var i=0;i<6;i++){_gl.deleteFramebuffer(renderTarget.__webglFramebuffer[i]);_gl.deleteRenderbuffer(renderTarget.__webglRenderbuffer[i])}}else{_gl.deleteFramebuffer(renderTarget.__webglFramebuffer);_gl.deleteRenderbuffer(renderTarget.__webglRenderbuffer)}};var deallocateMaterial=function(material){var program=material.program;if(program===undefined)return;material.program=undefined;var i,il,programInfo;var deleteProgram=false;for(i=0,il=_programs.length;i<il;i++){programInfo=_programs[i];if(programInfo.program===program){programInfo.usedTimes--;if(programInfo.usedTimes===0){deleteProgram=true}break}}if(deleteProgram===true){var newPrograms=[];for(i=0,il=_programs.length;i<il;i++){programInfo=_programs[i];if(programInfo.program!==program){newPrograms.push(programInfo)}}_programs=newPrograms;_gl.deleteProgram(program);_this.info.memory.programs--}};function deleteCustomAttributesBuffers(geometry){if(geometry.__webglCustomAttributesList){for(var id in geometry.__webglCustomAttributesList){_gl.deleteBuffer(geometry.__webglCustomAttributesList[id].buffer)}}}function initCustomAttributes(geometry,object){var nvertices=geometry.vertices.length;var material=object.material;if(material.attributes){if(geometry.__webglCustomAttributesList===undefined){geometry.__webglCustomAttributesList=[]}for(var a in material.attributes){var attribute=material.attributes[a];if(!attribute.__webglInitialized||attribute.createUniqueBuffers){attribute.__webglInitialized=true;var size=1;if(attribute.type==="v2")size=2;else if(attribute.type==="v3")size=3;else if(attribute.type==="v4")size=4;else if(attribute.type==="c")size=3;attribute.size=size;attribute.array=new Float32Array(nvertices*size);attribute.buffer=_gl.createBuffer();attribute.buffer.belongsToAttribute=a;attribute.needsUpdate=true}geometry.__webglCustomAttributesList.push(attribute)}}}function initParticleBuffers(geometry,object){var nvertices=geometry.vertices.length;geometry.__vertexArray=new Float32Array(nvertices*3);geometry.__colorArray=new Float32Array(nvertices*3);geometry.__sortArray=[];geometry.__webglParticleCount=nvertices;initCustomAttributes(geometry,object)}function initLineBuffers(geometry,object){var nvertices=geometry.vertices.length;geometry.__vertexArray=new Float32Array(nvertices*3);geometry.__colorArray=new Float32Array(nvertices*3);geometry.__lineDistanceArray=new Float32Array(nvertices*1);geometry.__webglLineCount=nvertices;initCustomAttributes(geometry,object)}function initRibbonBuffers(geometry,object){var nvertices=geometry.vertices.length;geometry.__vertexArray=new Float32Array(nvertices*3);geometry.__colorArray=new Float32Array(nvertices*3);geometry.__normalArray=new Float32Array(nvertices*3);geometry.__webglVertexCount=nvertices;initCustomAttributes(geometry,object)}function initMeshBuffers(geometryGroup,object){var geometry=object.geometry,faces3=geometryGroup.faces3,faces4=geometryGroup.faces4,nvertices=faces3.length*3+faces4.length*4,ntris=faces3.length*1+faces4.length*2,nlines=faces3.length*3+faces4.length*4,material=getBufferMaterial(object,geometryGroup),uvType=bufferGuessUVType(material),normalType=bufferGuessNormalType(material),vertexColorType=bufferGuessVertexColorType(material);geometryGroup.__vertexArray=new Float32Array(nvertices*3);if(normalType){geometryGroup.__normalArray=new Float32Array(nvertices*3)}if(geometry.hasTangents){geometryGroup.__tangentArray=new Float32Array(nvertices*4)}if(vertexColorType){geometryGroup.__colorArray=new Float32Array(nvertices*3)}if(uvType){if(geometry.faceUvs.length>0||geometry.faceVertexUvs.length>0){geometryGroup.__uvArray=new Float32Array(nvertices*2)}if(geometry.faceUvs.length>1||geometry.faceVertexUvs.length>1){geometryGroup.__uv2Array=new Float32Array(nvertices*2)}}if(object.geometry.skinWeights.length&&object.geometry.skinIndices.length){geometryGroup.__skinIndexArray=new Float32Array(nvertices*4);geometryGroup.__skinWeightArray=new Float32Array(nvertices*4)}geometryGroup.__faceArray=new Uint16Array(ntris*3);geometryGroup.__lineArray=new Uint16Array(nlines*2);var m,ml;if(geometryGroup.numMorphTargets){geometryGroup.__morphTargetsArrays=[];for(m=0,ml=geometryGroup.numMorphTargets;m<ml;m++){geometryGroup.__morphTargetsArrays.push(new Float32Array(nvertices*3))}}if(geometryGroup.numMorphNormals){geometryGroup.__morphNormalsArrays=[];for(m=0,ml=geometryGroup.numMorphNormals;m<ml;m++){geometryGroup.__morphNormalsArrays.push(new Float32Array(nvertices*3))}}geometryGroup.__webglFaceCount=ntris*3;geometryGroup.__webglLineCount=nlines*2;if(material.attributes){if(geometryGroup.__webglCustomAttributesList===undefined){geometryGroup.__webglCustomAttributesList=[]}for(var a in material.attributes){var originalAttribute=material.attributes[a];var attribute={};for(var property in originalAttribute){attribute[property]=originalAttribute[property]}if(!attribute.__webglInitialized||attribute.createUniqueBuffers){attribute.__webglInitialized=true;var size=1;if(attribute.type==="v2")size=2;else if(attribute.type==="v3")size=3;else if(attribute.type==="v4")size=4;else if(attribute.type==="c")size=3;attribute.size=size;attribute.array=new Float32Array(nvertices*size);attribute.buffer=_gl.createBuffer();attribute.buffer.belongsToAttribute=a;originalAttribute.needsUpdate=true;attribute.__original=originalAttribute}geometryGroup.__webglCustomAttributesList.push(attribute)}}geometryGroup.__inittedArrays=true}function getBufferMaterial(object,geometryGroup){return object.material instanceof THREE.MeshFaceMaterial?object.material.materials[geometryGroup.materialIndex]:object.material}function materialNeedsSmoothNormals(material){return material&&material.shading!==undefined&&material.shading===THREE.SmoothShading}function bufferGuessNormalType(material){if(material instanceof THREE.MeshBasicMaterial&&!material.envMap||material instanceof THREE.MeshDepthMaterial){return false}if(materialNeedsSmoothNormals(material)){return THREE.SmoothShading}else{return THREE.FlatShading}}function bufferGuessVertexColorType(material){if(material.vertexColors){return material.vertexColors}return false}function bufferGuessUVType(material){if(material.map||material.lightMap||material.bumpMap||material.normalMap||material.specularMap||material instanceof THREE.ShaderMaterial){return true}return false}function initDirectBuffers(geometry){var a,attribute,type;for(a in geometry.attributes){if(a==="index"){type=_gl.ELEMENT_ARRAY_BUFFER}else{type=_gl.ARRAY_BUFFER}attribute=geometry.attributes[a];attribute.buffer=_gl.createBuffer();_gl.bindBuffer(type,attribute.buffer);_gl.bufferData(type,attribute.array,_gl.STATIC_DRAW)}}function setParticleBuffers(geometry,hint,object){var v,c,vertex,offset,index,color,vertices=geometry.vertices,vl=vertices.length,colors=geometry.colors,cl=colors.length,vertexArray=geometry.__vertexArray,colorArray=geometry.__colorArray,sortArray=geometry.__sortArray,dirtyVertices=geometry.verticesNeedUpdate,dirtyElements=geometry.elementsNeedUpdate,dirtyColors=geometry.colorsNeedUpdate,customAttributes=geometry.__webglCustomAttributesList,i,il,a,ca,cal,value,customAttribute;if(object.sortParticles){_projScreenMatrixPS.copy(_projScreenMatrix);_projScreenMatrixPS.multiply(object.matrixWorld);for(v=0;v<vl;v++){vertex=vertices[v];_vector3.copy(vertex);_vector3.applyProjection(_projScreenMatrixPS);sortArray[v]=[_vector3.z,v]}sortArray.sort(numericalSort);for(v=0;v<vl;v++){vertex=vertices[sortArray[v][1]];offset=v*3;vertexArray[offset]=vertex.x;vertexArray[offset+1]=vertex.y;vertexArray[offset+2]=vertex.z}for(c=0;c<cl;c++){offset=c*3;color=colors[sortArray[c][1]];colorArray[offset]=color.r;colorArray[offset+1]=color.g;colorArray[offset+2]=color.b}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(!(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices"))continue;offset=0;cal=customAttribute.value.length;if(customAttribute.size===1){for(ca=0;ca<cal;ca++){index=sortArray[ca][1];customAttribute.array[ca]=customAttribute.value[index]}}else if(customAttribute.size===2){for(ca=0;ca<cal;ca++){index=sortArray[ca][1];value=customAttribute.value[index];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;offset+=2}}else if(customAttribute.size===3){if(customAttribute.type==="c"){for(ca=0;ca<cal;ca++){index=sortArray[ca][1];value=customAttribute.value[index];customAttribute.array[offset]=value.r;customAttribute.array[offset+1]=value.g;customAttribute.array[offset+2]=value.b;offset+=3}}else{for(ca=0;ca<cal;ca++){index=sortArray[ca][1];value=customAttribute.value[index];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;offset+=3}}}else if(customAttribute.size===4){for(ca=0;ca<cal;ca++){index=sortArray[ca][1];value=customAttribute.value[index];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;customAttribute.array[offset+3]=value.w;offset+=4}}}}}else{if(dirtyVertices){for(v=0;v<vl;v++){vertex=vertices[v];offset=v*3;vertexArray[offset]=vertex.x;vertexArray[offset+1]=vertex.y;vertexArray[offset+2]=vertex.z}}if(dirtyColors){for(c=0;c<cl;c++){color=colors[c];offset=c*3;colorArray[offset]=color.r;colorArray[offset+1]=color.g;colorArray[offset+2]=color.b}}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(customAttribute.needsUpdate&&(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices")){cal=customAttribute.value.length;offset=0;if(customAttribute.size===1){for(ca=0;ca<cal;ca++){customAttribute.array[ca]=customAttribute.value[ca]}}else if(customAttribute.size===2){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;offset+=2}}else if(customAttribute.size===3){if(customAttribute.type==="c"){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.r;customAttribute.array[offset+1]=value.g;customAttribute.array[offset+2]=value.b;offset+=3}}else{for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;offset+=3}}}else if(customAttribute.size===4){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;customAttribute.array[offset+3]=value.w;offset+=4}}}}}}if(dirtyVertices||object.sortParticles){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglVertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,vertexArray,hint)}if(dirtyColors||object.sortParticles){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglColorBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,colorArray,hint)}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(customAttribute.needsUpdate||object.sortParticles){_gl.bindBuffer(_gl.ARRAY_BUFFER,customAttribute.buffer);_gl.bufferData(_gl.ARRAY_BUFFER,customAttribute.array,hint)}}}}function setLineBuffers(geometry,hint){var v,c,d,vertex,offset,color,vertices=geometry.vertices,colors=geometry.colors,lineDistances=geometry.lineDistances,vl=vertices.length,cl=colors.length,dl=lineDistances.length,vertexArray=geometry.__vertexArray,colorArray=geometry.__colorArray,lineDistanceArray=geometry.__lineDistanceArray,dirtyVertices=geometry.verticesNeedUpdate,dirtyColors=geometry.colorsNeedUpdate,dirtyLineDistances=geometry.lineDistancesNeedUpdate,customAttributes=geometry.__webglCustomAttributesList,i,il,a,ca,cal,value,customAttribute;if(dirtyVertices){for(v=0;v<vl;v++){vertex=vertices[v];offset=v*3;vertexArray[offset]=vertex.x;vertexArray[offset+1]=vertex.y;vertexArray[offset+2]=vertex.z}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglVertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,vertexArray,hint)}if(dirtyColors){for(c=0;c<cl;c++){color=colors[c];offset=c*3;colorArray[offset]=color.r;colorArray[offset+1]=color.g;colorArray[offset+2]=color.b}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglColorBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,colorArray,hint)}if(dirtyLineDistances){for(d=0;d<dl;d++){lineDistanceArray[d]=lineDistances[d]}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglLineDistanceBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,lineDistanceArray,hint)}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(customAttribute.needsUpdate&&(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices")){offset=0;cal=customAttribute.value.length;if(customAttribute.size===1){for(ca=0;ca<cal;ca++){customAttribute.array[ca]=customAttribute.value[ca]}}else if(customAttribute.size===2){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;offset+=2}}else if(customAttribute.size===3){if(customAttribute.type==="c"){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.r;customAttribute.array[offset+1]=value.g;customAttribute.array[offset+2]=value.b;offset+=3}}else{for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;offset+=3}}}else if(customAttribute.size===4){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;customAttribute.array[offset+3]=value.w;offset+=4}}_gl.bindBuffer(_gl.ARRAY_BUFFER,customAttribute.buffer);_gl.bufferData(_gl.ARRAY_BUFFER,customAttribute.array,hint)}}}}function setRibbonBuffers(geometry,hint){var v,c,n,vertex,offset,color,normal,i,il,ca,cal,customAttribute,value,vertices=geometry.vertices,colors=geometry.colors,normals=geometry.normals,vl=vertices.length,cl=colors.length,nl=normals.length,vertexArray=geometry.__vertexArray,colorArray=geometry.__colorArray,normalArray=geometry.__normalArray,dirtyVertices=geometry.verticesNeedUpdate,dirtyColors=geometry.colorsNeedUpdate,dirtyNormals=geometry.normalsNeedUpdate,customAttributes=geometry.__webglCustomAttributesList;if(dirtyVertices){for(v=0;v<vl;v++){vertex=vertices[v];offset=v*3;vertexArray[offset]=vertex.x;vertexArray[offset+1]=vertex.y;vertexArray[offset+2]=vertex.z}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglVertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,vertexArray,hint)}if(dirtyColors){for(c=0;c<cl;c++){color=colors[c];offset=c*3;colorArray[offset]=color.r;colorArray[offset+1]=color.g;colorArray[offset+2]=color.b}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglColorBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,colorArray,hint)}if(dirtyNormals){for(n=0;n<nl;n++){normal=normals[n];offset=n*3;normalArray[offset]=normal.x;normalArray[offset+1]=normal.y;normalArray[offset+2]=normal.z}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometry.__webglNormalBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,normalArray,hint)}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(customAttribute.needsUpdate&&(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices")){offset=0;cal=customAttribute.value.length;if(customAttribute.size===1){for(ca=0;ca<cal;ca++){customAttribute.array[ca]=customAttribute.value[ca]}}else if(customAttribute.size===2){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;offset+=2}}else if(customAttribute.size===3){if(customAttribute.type==="c"){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.r;customAttribute.array[offset+1]=value.g;customAttribute.array[offset+2]=value.b;offset+=3}}else{for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;offset+=3}}}else if(customAttribute.size===4){for(ca=0;ca<cal;ca++){value=customAttribute.value[ca];customAttribute.array[offset]=value.x;customAttribute.array[offset+1]=value.y;customAttribute.array[offset+2]=value.z;customAttribute.array[offset+3]=value.w;offset+=4}}_gl.bindBuffer(_gl.ARRAY_BUFFER,customAttribute.buffer);_gl.bufferData(_gl.ARRAY_BUFFER,customAttribute.array,hint)}}}}function setMeshBuffers(geometryGroup,object,hint,dispose,material){if(!geometryGroup.__inittedArrays){return}var normalType=bufferGuessNormalType(material),vertexColorType=bufferGuessVertexColorType(material),uvType=bufferGuessUVType(material),needsSmoothNormals=normalType===THREE.SmoothShading;var f,fl,fi,face,vertexNormals,faceNormal,normal,vertexColors,faceColor,vertexTangents,uv,uv2,v1,v2,v3,v4,t1,t2,t3,t4,n1,n2,n3,n4,c1,c2,c3,c4,sw1,sw2,sw3,sw4,si1,si2,si3,si4,sa1,sa2,sa3,sa4,sb1,sb2,sb3,sb4,m,ml,i,il,vn,uvi,uv2i,vk,vkl,vka,nka,chf,faceVertexNormals,a,vertexIndex=0,offset=0,offset_uv=0,offset_uv2=0,offset_face=0,offset_normal=0,offset_tangent=0,offset_line=0,offset_color=0,offset_skin=0,offset_morphTarget=0,offset_custom=0,offset_customSrc=0,value,vertexArray=geometryGroup.__vertexArray,uvArray=geometryGroup.__uvArray,uv2Array=geometryGroup.__uv2Array,normalArray=geometryGroup.__normalArray,tangentArray=geometryGroup.__tangentArray,colorArray=geometryGroup.__colorArray,skinIndexArray=geometryGroup.__skinIndexArray,skinWeightArray=geometryGroup.__skinWeightArray,morphTargetsArrays=geometryGroup.__morphTargetsArrays,morphNormalsArrays=geometryGroup.__morphNormalsArrays,customAttributes=geometryGroup.__webglCustomAttributesList,customAttribute,faceArray=geometryGroup.__faceArray,lineArray=geometryGroup.__lineArray,geometry=object.geometry,dirtyVertices=geometry.verticesNeedUpdate,dirtyElements=geometry.elementsNeedUpdate,dirtyUvs=geometry.uvsNeedUpdate,dirtyNormals=geometry.normalsNeedUpdate,dirtyTangents=geometry.tangentsNeedUpdate,dirtyColors=geometry.colorsNeedUpdate,dirtyMorphTargets=geometry.morphTargetsNeedUpdate,vertices=geometry.vertices,chunk_faces3=geometryGroup.faces3,chunk_faces4=geometryGroup.faces4,obj_faces=geometry.faces,obj_uvs=geometry.faceVertexUvs[0],obj_uvs2=geometry.faceVertexUvs[1],obj_colors=geometry.colors,obj_skinIndices=geometry.skinIndices,obj_skinWeights=geometry.skinWeights,morphTargets=geometry.morphTargets,morphNormals=geometry.morphNormals;if(dirtyVertices){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];v1=vertices[face.a];v2=vertices[face.b];v3=vertices[face.c];vertexArray[offset]=v1.x;vertexArray[offset+1]=v1.y;vertexArray[offset+2]=v1.z;vertexArray[offset+3]=v2.x;vertexArray[offset+4]=v2.y;vertexArray[offset+5]=v2.z;vertexArray[offset+6]=v3.x;vertexArray[offset+7]=v3.y;vertexArray[offset+8]=v3.z;offset+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];v1=vertices[face.a];v2=vertices[face.b];v3=vertices[face.c];v4=vertices[face.d];vertexArray[offset]=v1.x;vertexArray[offset+1]=v1.y;vertexArray[offset+2]=v1.z;vertexArray[offset+3]=v2.x;vertexArray[offset+4]=v2.y;vertexArray[offset+5]=v2.z;vertexArray[offset+6]=v3.x;vertexArray[offset+7]=v3.y;vertexArray[offset+8]=v3.z;vertexArray[offset+9]=v4.x;vertexArray[offset+10]=v4.y;vertexArray[offset+11]=v4.z;offset+=12}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglVertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,vertexArray,hint)}if(dirtyMorphTargets){for(vk=0,vkl=morphTargets.length;vk<vkl;vk++){offset_morphTarget=0;for(f=0,fl=chunk_faces3.length;f<fl;f++){chf=chunk_faces3[f];face=obj_faces[chf];v1=morphTargets[vk].vertices[face.a];v2=morphTargets[vk].vertices[face.b];v3=morphTargets[vk].vertices[face.c];vka=morphTargetsArrays[vk];vka[offset_morphTarget]=v1.x;vka[offset_morphTarget+1]=v1.y;vka[offset_morphTarget+2]=v1.z;vka[offset_morphTarget+3]=v2.x;vka[offset_morphTarget+4]=v2.y;vka[offset_morphTarget+5]=v2.z;vka[offset_morphTarget+6]=v3.x;vka[offset_morphTarget+7]=v3.y;vka[offset_morphTarget+8]=v3.z;if(material.morphNormals){if(needsSmoothNormals){faceVertexNormals=morphNormals[vk].vertexNormals[chf];n1=faceVertexNormals.a;n2=faceVertexNormals.b;n3=faceVertexNormals.c}else{n1=morphNormals[vk].faceNormals[chf];n2=n1;n3=n1}nka=morphNormalsArrays[vk];nka[offset_morphTarget]=n1.x;nka[offset_morphTarget+1]=n1.y;nka[offset_morphTarget+2]=n1.z;nka[offset_morphTarget+3]=n2.x;nka[offset_morphTarget+4]=n2.y;nka[offset_morphTarget+5]=n2.z;nka[offset_morphTarget+6]=n3.x;nka[offset_morphTarget+7]=n3.y;nka[offset_morphTarget+8]=n3.z}offset_morphTarget+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){chf=chunk_faces4[f];face=obj_faces[chf];v1=morphTargets[vk].vertices[face.a];v2=morphTargets[vk].vertices[face.b];v3=morphTargets[vk].vertices[face.c];v4=morphTargets[vk].vertices[face.d];vka=morphTargetsArrays[vk];vka[offset_morphTarget]=v1.x;vka[offset_morphTarget+1]=v1.y;vka[offset_morphTarget+2]=v1.z;vka[offset_morphTarget+3]=v2.x;vka[offset_morphTarget+4]=v2.y;vka[offset_morphTarget+5]=v2.z;vka[offset_morphTarget+6]=v3.x;vka[offset_morphTarget+7]=v3.y;vka[offset_morphTarget+8]=v3.z;vka[offset_morphTarget+9]=v4.x;vka[offset_morphTarget+10]=v4.y;vka[offset_morphTarget+11]=v4.z;if(material.morphNormals){if(needsSmoothNormals){faceVertexNormals=morphNormals[vk].vertexNormals[chf];n1=faceVertexNormals.a;n2=faceVertexNormals.b;n3=faceVertexNormals.c;n4=faceVertexNormals.d}else{n1=morphNormals[vk].faceNormals[chf];n2=n1;n3=n1;n4=n1}nka=morphNormalsArrays[vk];nka[offset_morphTarget]=n1.x;nka[offset_morphTarget+1]=n1.y;nka[offset_morphTarget+2]=n1.z;nka[offset_morphTarget+3]=n2.x;nka[offset_morphTarget+4]=n2.y;nka[offset_morphTarget+5]=n2.z;nka[offset_morphTarget+6]=n3.x;nka[offset_morphTarget+7]=n3.y;nka[offset_morphTarget+8]=n3.z;nka[offset_morphTarget+9]=n4.x;nka[offset_morphTarget+10]=n4.y;nka[offset_morphTarget+11]=n4.z}offset_morphTarget+=12}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphTargetsBuffers[vk]);_gl.bufferData(_gl.ARRAY_BUFFER,morphTargetsArrays[vk],hint);if(material.morphNormals){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphNormalsBuffers[vk]);_gl.bufferData(_gl.ARRAY_BUFFER,morphNormalsArrays[vk],hint)}}}if(obj_skinWeights.length){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];sw1=obj_skinWeights[face.a];sw2=obj_skinWeights[face.b];sw3=obj_skinWeights[face.c];skinWeightArray[offset_skin]=sw1.x;skinWeightArray[offset_skin+1]=sw1.y;skinWeightArray[offset_skin+2]=sw1.z;skinWeightArray[offset_skin+3]=sw1.w;skinWeightArray[offset_skin+4]=sw2.x;skinWeightArray[offset_skin+5]=sw2.y;skinWeightArray[offset_skin+6]=sw2.z;skinWeightArray[offset_skin+7]=sw2.w;skinWeightArray[offset_skin+8]=sw3.x;skinWeightArray[offset_skin+9]=sw3.y;skinWeightArray[offset_skin+10]=sw3.z;skinWeightArray[offset_skin+11]=sw3.w;si1=obj_skinIndices[face.a];si2=obj_skinIndices[face.b];si3=obj_skinIndices[face.c];skinIndexArray[offset_skin]=si1.x;skinIndexArray[offset_skin+1]=si1.y;skinIndexArray[offset_skin+2]=si1.z;skinIndexArray[offset_skin+3]=si1.w;skinIndexArray[offset_skin+4]=si2.x;skinIndexArray[offset_skin+5]=si2.y;skinIndexArray[offset_skin+6]=si2.z;skinIndexArray[offset_skin+7]=si2.w;skinIndexArray[offset_skin+8]=si3.x;skinIndexArray[offset_skin+9]=si3.y;skinIndexArray[offset_skin+10]=si3.z;skinIndexArray[offset_skin+11]=si3.w;offset_skin+=12}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];sw1=obj_skinWeights[face.a];
sw2=obj_skinWeights[face.b];sw3=obj_skinWeights[face.c];sw4=obj_skinWeights[face.d];skinWeightArray[offset_skin]=sw1.x;skinWeightArray[offset_skin+1]=sw1.y;skinWeightArray[offset_skin+2]=sw1.z;skinWeightArray[offset_skin+3]=sw1.w;skinWeightArray[offset_skin+4]=sw2.x;skinWeightArray[offset_skin+5]=sw2.y;skinWeightArray[offset_skin+6]=sw2.z;skinWeightArray[offset_skin+7]=sw2.w;skinWeightArray[offset_skin+8]=sw3.x;skinWeightArray[offset_skin+9]=sw3.y;skinWeightArray[offset_skin+10]=sw3.z;skinWeightArray[offset_skin+11]=sw3.w;skinWeightArray[offset_skin+12]=sw4.x;skinWeightArray[offset_skin+13]=sw4.y;skinWeightArray[offset_skin+14]=sw4.z;skinWeightArray[offset_skin+15]=sw4.w;si1=obj_skinIndices[face.a];si2=obj_skinIndices[face.b];si3=obj_skinIndices[face.c];si4=obj_skinIndices[face.d];skinIndexArray[offset_skin]=si1.x;skinIndexArray[offset_skin+1]=si1.y;skinIndexArray[offset_skin+2]=si1.z;skinIndexArray[offset_skin+3]=si1.w;skinIndexArray[offset_skin+4]=si2.x;skinIndexArray[offset_skin+5]=si2.y;skinIndexArray[offset_skin+6]=si2.z;skinIndexArray[offset_skin+7]=si2.w;skinIndexArray[offset_skin+8]=si3.x;skinIndexArray[offset_skin+9]=si3.y;skinIndexArray[offset_skin+10]=si3.z;skinIndexArray[offset_skin+11]=si3.w;skinIndexArray[offset_skin+12]=si4.x;skinIndexArray[offset_skin+13]=si4.y;skinIndexArray[offset_skin+14]=si4.z;skinIndexArray[offset_skin+15]=si4.w;offset_skin+=16}if(offset_skin>0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglSkinIndicesBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,skinIndexArray,hint);_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglSkinWeightsBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,skinWeightArray,hint)}}if(dirtyColors&&vertexColorType){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];vertexColors=face.vertexColors;faceColor=face.color;if(vertexColors.length===3&&vertexColorType===THREE.VertexColors){c1=vertexColors[0];c2=vertexColors[1];c3=vertexColors[2]}else{c1=faceColor;c2=faceColor;c3=faceColor}colorArray[offset_color]=c1.r;colorArray[offset_color+1]=c1.g;colorArray[offset_color+2]=c1.b;colorArray[offset_color+3]=c2.r;colorArray[offset_color+4]=c2.g;colorArray[offset_color+5]=c2.b;colorArray[offset_color+6]=c3.r;colorArray[offset_color+7]=c3.g;colorArray[offset_color+8]=c3.b;offset_color+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];vertexColors=face.vertexColors;faceColor=face.color;if(vertexColors.length===4&&vertexColorType===THREE.VertexColors){c1=vertexColors[0];c2=vertexColors[1];c3=vertexColors[2];c4=vertexColors[3]}else{c1=faceColor;c2=faceColor;c3=faceColor;c4=faceColor}colorArray[offset_color]=c1.r;colorArray[offset_color+1]=c1.g;colorArray[offset_color+2]=c1.b;colorArray[offset_color+3]=c2.r;colorArray[offset_color+4]=c2.g;colorArray[offset_color+5]=c2.b;colorArray[offset_color+6]=c3.r;colorArray[offset_color+7]=c3.g;colorArray[offset_color+8]=c3.b;colorArray[offset_color+9]=c4.r;colorArray[offset_color+10]=c4.g;colorArray[offset_color+11]=c4.b;offset_color+=12}if(offset_color>0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglColorBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,colorArray,hint)}}if(dirtyTangents&&geometry.hasTangents){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];vertexTangents=face.vertexTangents;t1=vertexTangents[0];t2=vertexTangents[1];t3=vertexTangents[2];tangentArray[offset_tangent]=t1.x;tangentArray[offset_tangent+1]=t1.y;tangentArray[offset_tangent+2]=t1.z;tangentArray[offset_tangent+3]=t1.w;tangentArray[offset_tangent+4]=t2.x;tangentArray[offset_tangent+5]=t2.y;tangentArray[offset_tangent+6]=t2.z;tangentArray[offset_tangent+7]=t2.w;tangentArray[offset_tangent+8]=t3.x;tangentArray[offset_tangent+9]=t3.y;tangentArray[offset_tangent+10]=t3.z;tangentArray[offset_tangent+11]=t3.w;offset_tangent+=12}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];vertexTangents=face.vertexTangents;t1=vertexTangents[0];t2=vertexTangents[1];t3=vertexTangents[2];t4=vertexTangents[3];tangentArray[offset_tangent]=t1.x;tangentArray[offset_tangent+1]=t1.y;tangentArray[offset_tangent+2]=t1.z;tangentArray[offset_tangent+3]=t1.w;tangentArray[offset_tangent+4]=t2.x;tangentArray[offset_tangent+5]=t2.y;tangentArray[offset_tangent+6]=t2.z;tangentArray[offset_tangent+7]=t2.w;tangentArray[offset_tangent+8]=t3.x;tangentArray[offset_tangent+9]=t3.y;tangentArray[offset_tangent+10]=t3.z;tangentArray[offset_tangent+11]=t3.w;tangentArray[offset_tangent+12]=t4.x;tangentArray[offset_tangent+13]=t4.y;tangentArray[offset_tangent+14]=t4.z;tangentArray[offset_tangent+15]=t4.w;offset_tangent+=16}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglTangentBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,tangentArray,hint)}if(dirtyNormals&&normalType){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];vertexNormals=face.vertexNormals;faceNormal=face.normal;if(vertexNormals.length===3&&needsSmoothNormals){for(i=0;i<3;i++){vn=vertexNormals[i];normalArray[offset_normal]=vn.x;normalArray[offset_normal+1]=vn.y;normalArray[offset_normal+2]=vn.z;offset_normal+=3}}else{for(i=0;i<3;i++){normalArray[offset_normal]=faceNormal.x;normalArray[offset_normal+1]=faceNormal.y;normalArray[offset_normal+2]=faceNormal.z;offset_normal+=3}}}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];vertexNormals=face.vertexNormals;faceNormal=face.normal;if(vertexNormals.length===4&&needsSmoothNormals){for(i=0;i<4;i++){vn=vertexNormals[i];normalArray[offset_normal]=vn.x;normalArray[offset_normal+1]=vn.y;normalArray[offset_normal+2]=vn.z;offset_normal+=3}}else{for(i=0;i<4;i++){normalArray[offset_normal]=faceNormal.x;normalArray[offset_normal+1]=faceNormal.y;normalArray[offset_normal+2]=faceNormal.z;offset_normal+=3}}}_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglNormalBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,normalArray,hint)}if(dirtyUvs&&obj_uvs&&uvType){for(f=0,fl=chunk_faces3.length;f<fl;f++){fi=chunk_faces3[f];uv=obj_uvs[fi];if(uv===undefined)continue;for(i=0;i<3;i++){uvi=uv[i];uvArray[offset_uv]=uvi.x;uvArray[offset_uv+1]=uvi.y;offset_uv+=2}}for(f=0,fl=chunk_faces4.length;f<fl;f++){fi=chunk_faces4[f];uv=obj_uvs[fi];if(uv===undefined)continue;for(i=0;i<4;i++){uvi=uv[i];uvArray[offset_uv]=uvi.x;uvArray[offset_uv+1]=uvi.y;offset_uv+=2}}if(offset_uv>0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglUVBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,uvArray,hint)}}if(dirtyUvs&&obj_uvs2&&uvType){for(f=0,fl=chunk_faces3.length;f<fl;f++){fi=chunk_faces3[f];uv2=obj_uvs2[fi];if(uv2===undefined)continue;for(i=0;i<3;i++){uv2i=uv2[i];uv2Array[offset_uv2]=uv2i.x;uv2Array[offset_uv2+1]=uv2i.y;offset_uv2+=2}}for(f=0,fl=chunk_faces4.length;f<fl;f++){fi=chunk_faces4[f];uv2=obj_uvs2[fi];if(uv2===undefined)continue;for(i=0;i<4;i++){uv2i=uv2[i];uv2Array[offset_uv2]=uv2i.x;uv2Array[offset_uv2+1]=uv2i.y;offset_uv2+=2}}if(offset_uv2>0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglUV2Buffer);_gl.bufferData(_gl.ARRAY_BUFFER,uv2Array,hint)}}if(dirtyElements){for(f=0,fl=chunk_faces3.length;f<fl;f++){faceArray[offset_face]=vertexIndex;faceArray[offset_face+1]=vertexIndex+1;faceArray[offset_face+2]=vertexIndex+2;offset_face+=3;lineArray[offset_line]=vertexIndex;lineArray[offset_line+1]=vertexIndex+1;lineArray[offset_line+2]=vertexIndex;lineArray[offset_line+3]=vertexIndex+2;lineArray[offset_line+4]=vertexIndex+1;lineArray[offset_line+5]=vertexIndex+2;offset_line+=6;vertexIndex+=3}for(f=0,fl=chunk_faces4.length;f<fl;f++){faceArray[offset_face]=vertexIndex;faceArray[offset_face+1]=vertexIndex+1;faceArray[offset_face+2]=vertexIndex+3;faceArray[offset_face+3]=vertexIndex+1;faceArray[offset_face+4]=vertexIndex+2;faceArray[offset_face+5]=vertexIndex+3;offset_face+=6;lineArray[offset_line]=vertexIndex;lineArray[offset_line+1]=vertexIndex+1;lineArray[offset_line+2]=vertexIndex;lineArray[offset_line+3]=vertexIndex+3;lineArray[offset_line+4]=vertexIndex+1;lineArray[offset_line+5]=vertexIndex+2;lineArray[offset_line+6]=vertexIndex+2;lineArray[offset_line+7]=vertexIndex+3;offset_line+=8;vertexIndex+=4}_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglFaceBuffer);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,faceArray,hint);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglLineBuffer);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,lineArray,hint)}if(customAttributes){for(i=0,il=customAttributes.length;i<il;i++){customAttribute=customAttributes[i];if(!customAttribute.__original.needsUpdate)continue;offset_custom=0;offset_customSrc=0;if(customAttribute.size===1){if(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];customAttribute.array[offset_custom]=customAttribute.value[face.a];customAttribute.array[offset_custom+1]=customAttribute.value[face.b];customAttribute.array[offset_custom+2]=customAttribute.value[face.c];offset_custom+=3}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];customAttribute.array[offset_custom]=customAttribute.value[face.a];customAttribute.array[offset_custom+1]=customAttribute.value[face.b];customAttribute.array[offset_custom+2]=customAttribute.value[face.c];customAttribute.array[offset_custom+3]=customAttribute.value[face.d];offset_custom+=4}}else if(customAttribute.boundTo==="faces"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];customAttribute.array[offset_custom]=value;customAttribute.array[offset_custom+1]=value;customAttribute.array[offset_custom+2]=value;offset_custom+=3}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];customAttribute.array[offset_custom]=value;customAttribute.array[offset_custom+1]=value;customAttribute.array[offset_custom+2]=value;customAttribute.array[offset_custom+3]=value;offset_custom+=4}}}else if(customAttribute.size===2){if(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v2.x;customAttribute.array[offset_custom+3]=v2.y;customAttribute.array[offset_custom+4]=v3.x;customAttribute.array[offset_custom+5]=v3.y;offset_custom+=6}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];v4=customAttribute.value[face.d];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v2.x;customAttribute.array[offset_custom+3]=v2.y;customAttribute.array[offset_custom+4]=v3.x;customAttribute.array[offset_custom+5]=v3.y;customAttribute.array[offset_custom+6]=v4.x;customAttribute.array[offset_custom+7]=v4.y;offset_custom+=8}}else if(customAttribute.boundTo==="faces"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];v1=value;v2=value;v3=value;customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v2.x;customAttribute.array[offset_custom+3]=v2.y;customAttribute.array[offset_custom+4]=v3.x;customAttribute.array[offset_custom+5]=v3.y;offset_custom+=6}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];v1=value;v2=value;v3=value;v4=value;customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v2.x;customAttribute.array[offset_custom+3]=v2.y;customAttribute.array[offset_custom+4]=v3.x;customAttribute.array[offset_custom+5]=v3.y;customAttribute.array[offset_custom+6]=v4.x;customAttribute.array[offset_custom+7]=v4.y;offset_custom+=8}}}else if(customAttribute.size===3){var pp;if(customAttribute.type==="c"){pp=["r","g","b"]}else{pp=["x","y","z"]}if(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];offset_custom+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];v4=customAttribute.value[face.d];customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];customAttribute.array[offset_custom+9]=v4[pp[0]];customAttribute.array[offset_custom+10]=v4[pp[1]];customAttribute.array[offset_custom+11]=v4[pp[2]];offset_custom+=12}}else if(customAttribute.boundTo==="faces"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];v1=value;v2=value;v3=value;customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];offset_custom+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];v1=value;v2=value;v3=value;v4=value;customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];customAttribute.array[offset_custom+9]=v4[pp[0]];customAttribute.array[offset_custom+10]=v4[pp[1]];customAttribute.array[offset_custom+11]=v4[pp[2]];offset_custom+=12}}else if(customAttribute.boundTo==="faceVertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];v1=value[0];v2=value[1];v3=value[2];customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];offset_custom+=9}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];v1=value[0];v2=value[1];v3=value[2];v4=value[3];customAttribute.array[offset_custom]=v1[pp[0]];customAttribute.array[offset_custom+1]=v1[pp[1]];customAttribute.array[offset_custom+2]=v1[pp[2]];customAttribute.array[offset_custom+3]=v2[pp[0]];customAttribute.array[offset_custom+4]=v2[pp[1]];customAttribute.array[offset_custom+5]=v2[pp[2]];customAttribute.array[offset_custom+6]=v3[pp[0]];customAttribute.array[offset_custom+7]=v3[pp[1]];customAttribute.array[offset_custom+8]=v3[pp[2]];customAttribute.array[offset_custom+9]=v4[pp[0]];customAttribute.array[offset_custom+10]=v4[pp[1]];customAttribute.array[offset_custom+11]=v4[pp[2]];offset_custom+=12}}}else if(customAttribute.size===4){if(customAttribute.boundTo===undefined||customAttribute.boundTo==="vertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){face=obj_faces[chunk_faces3[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;offset_custom+=12}for(f=0,fl=chunk_faces4.length;f<fl;f++){face=obj_faces[chunk_faces4[f]];v1=customAttribute.value[face.a];v2=customAttribute.value[face.b];v3=customAttribute.value[face.c];v4=customAttribute.value[face.d];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;customAttribute.array[offset_custom+12]=v4.x;customAttribute.array[offset_custom+13]=v4.y;customAttribute.array[offset_custom+14]=v4.z;customAttribute.array[offset_custom+15]=v4.w;offset_custom+=16}}else if(customAttribute.boundTo==="faces"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];v1=value;v2=value;v3=value;customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;offset_custom+=12}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];v1=value;v2=value;v3=value;v4=value;customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;customAttribute.array[offset_custom+12]=v4.x;customAttribute.array[offset_custom+13]=v4.y;customAttribute.array[offset_custom+14]=v4.z;customAttribute.array[offset_custom+15]=v4.w;offset_custom+=16}}else if(customAttribute.boundTo==="faceVertices"){for(f=0,fl=chunk_faces3.length;f<fl;f++){value=customAttribute.value[chunk_faces3[f]];v1=value[0];v2=value[1];v3=value[2];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;offset_custom+=12}for(f=0,fl=chunk_faces4.length;f<fl;f++){value=customAttribute.value[chunk_faces4[f]];v1=value[0];v2=value[1];v3=value[2];v4=value[3];customAttribute.array[offset_custom]=v1.x;customAttribute.array[offset_custom+1]=v1.y;customAttribute.array[offset_custom+2]=v1.z;customAttribute.array[offset_custom+3]=v1.w;customAttribute.array[offset_custom+4]=v2.x;customAttribute.array[offset_custom+5]=v2.y;customAttribute.array[offset_custom+6]=v2.z;customAttribute.array[offset_custom+7]=v2.w;customAttribute.array[offset_custom+8]=v3.x;customAttribute.array[offset_custom+9]=v3.y;customAttribute.array[offset_custom+10]=v3.z;customAttribute.array[offset_custom+11]=v3.w;customAttribute.array[offset_custom+12]=v4.x;customAttribute.array[offset_custom+13]=v4.y;customAttribute.array[offset_custom+14]=v4.z;customAttribute.array[offset_custom+15]=v4.w;offset_custom+=16}}}_gl.bindBuffer(_gl.ARRAY_BUFFER,customAttribute.buffer);_gl.bufferData(_gl.ARRAY_BUFFER,customAttribute.array,hint)}}if(dispose){delete geometryGroup.__inittedArrays;delete geometryGroup.__colorArray;delete geometryGroup.__normalArray;delete geometryGroup.__tangentArray;delete geometryGroup.__uvArray;delete geometryGroup.__uv2Array;delete geometryGroup.__faceArray;delete geometryGroup.__vertexArray;delete geometryGroup.__lineArray;delete geometryGroup.__skinIndexArray;delete geometryGroup.__skinWeightArray}}function setDirectBuffers(geometry,hint,dispose){var attributes=geometry.attributes;var attributeName,attributeItem;for(attributeName in attributes){attributeItem=attributes[attributeName];if(attributeItem.needsUpdate){if(attributeName==="index"){_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,attributeItem.buffer);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,attributeItem.array,hint)}else{_gl.bindBuffer(_gl.ARRAY_BUFFER,attributeItem.buffer);_gl.bufferData(_gl.ARRAY_BUFFER,attributeItem.array,hint)}attributeItem.needsUpdate=false}if(dispose&&!attributeItem.dynamic){delete attributeItem.array}}}this.renderBufferImmediate=function(object,program,material){if(object.hasPositions&&!object.__webglVertexBuffer)object.__webglVertexBuffer=_gl.createBuffer();if(object.hasNormals&&!object.__webglNormalBuffer)object.__webglNormalBuffer=_gl.createBuffer();if(object.hasUvs&&!object.__webglUvBuffer)object.__webglUvBuffer=_gl.createBuffer();if(object.hasColors&&!object.__webglColorBuffer)object.__webglColorBuffer=_gl.createBuffer();if(object.hasPositions){_gl.bindBuffer(_gl.ARRAY_BUFFER,object.__webglVertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,object.positionArray,_gl.DYNAMIC_DRAW);_gl.enableVertexAttribArray(program.attributes.position);_gl.vertexAttribPointer(program.attributes.position,3,_gl.FLOAT,false,0,0)}if(object.hasNormals){_gl.bindBuffer(_gl.ARRAY_BUFFER,object.__webglNormalBuffer);if(material.shading===THREE.FlatShading){var nx,ny,nz,nax,nbx,ncx,nay,nby,ncy,naz,nbz,ncz,normalArray,i,il=object.count*3;for(i=0;i<il;i+=9){normalArray=object.normalArray;nax=normalArray[i];nay=normalArray[i+1];naz=normalArray[i+2];nbx=normalArray[i+3];nby=normalArray[i+4];nbz=normalArray[i+5];ncx=normalArray[i+6];ncy=normalArray[i+7];ncz=normalArray[i+8];nx=(nax+nbx+ncx)/3;ny=(nay+nby+ncy)/3;nz=(naz+nbz+ncz)/3;normalArray[i]=nx;normalArray[i+1]=ny;normalArray[i+2]=nz;normalArray[i+3]=nx;normalArray[i+4]=ny;normalArray[i+5]=nz;normalArray[i+6]=nx;normalArray[i+7]=ny;normalArray[i+8]=nz}}_gl.bufferData(_gl.ARRAY_BUFFER,object.normalArray,_gl.DYNAMIC_DRAW);_gl.enableVertexAttribArray(program.attributes.normal);_gl.vertexAttribPointer(program.attributes.normal,3,_gl.FLOAT,false,0,0)}if(object.hasUvs&&material.map){_gl.bindBuffer(_gl.ARRAY_BUFFER,object.__webglUvBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,object.uvArray,_gl.DYNAMIC_DRAW);_gl.enableVertexAttribArray(program.attributes.uv);_gl.vertexAttribPointer(program.attributes.uv,2,_gl.FLOAT,false,0,0)}if(object.hasColors&&material.vertexColors!==THREE.NoColors){_gl.bindBuffer(_gl.ARRAY_BUFFER,object.__webglColorBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,object.colorArray,_gl.DYNAMIC_DRAW);_gl.enableVertexAttribArray(program.attributes.color);_gl.vertexAttribPointer(program.attributes.color,3,_gl.FLOAT,false,0,0)}_gl.drawArrays(_gl.TRIANGLES,0,object.count);object.count=0};this.renderBufferDirect=function(camera,lights,fog,material,geometry,object){if(material.visible===false)return;var program,programAttributes,linewidth,primitives,a,attribute,geometryAttributes;var attributeItem,attributeName,attributePointer,attributeSize;program=setProgram(camera,lights,fog,material,object);programAttributes=program.attributes;geometryAttributes=geometry.attributes;var updateBuffers=false,wireframeBit=material.wireframe?1:0,geometryHash=geometry.id*16777215+program.id*2+wireframeBit;if(geometryHash!==_currentGeometryGroupHash){_currentGeometryGroupHash=geometryHash;updateBuffers=true}if(updateBuffers){disableAttributes()}if(object instanceof THREE.Mesh){var index=geometryAttributes["index"];if(index){var offsets=geometry.offsets;if(offsets.length>1)updateBuffers=true;for(var i=0,il=offsets.length;i<il;i++){var startIndex=offsets[i].index;if(updateBuffers){for(attributeName in geometryAttributes){if(attributeName==="index")continue;attributePointer=programAttributes[attributeName];attributeItem=geometryAttributes[attributeName];attributeSize=attributeItem.itemSize;if(attributePointer>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,attributeItem.buffer);enableAttribute(attributePointer);_gl.vertexAttribPointer(attributePointer,attributeSize,_gl.FLOAT,false,0,startIndex*attributeSize*4)}}_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,index.buffer)}_gl.drawElements(_gl.TRIANGLES,offsets[i].count,_gl.UNSIGNED_SHORT,offsets[i].start*2);_this.info.render.calls++;_this.info.render.vertices+=offsets[i].count;_this.info.render.faces+=offsets[i].count/3}}else{if(updateBuffers){for(attributeName in geometryAttributes){if(attributeName==="index")continue;attributePointer=programAttributes[attributeName];attributeItem=geometryAttributes[attributeName];attributeSize=attributeItem.itemSize;if(attributePointer>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,attributeItem.buffer);enableAttribute(attributePointer);_gl.vertexAttribPointer(attributePointer,attributeSize,_gl.FLOAT,false,0,0)}}}var position=geometry.attributes["position"];_gl.drawArrays(_gl.TRIANGLES,0,position.numItems/3);_this.info.render.calls++;_this.info.render.vertices+=position.numItems/3;_this.info.render.faces+=position.numItems/3/3}}else if(object instanceof THREE.ParticleSystem){if(updateBuffers){for(attributeName in geometryAttributes){attributePointer=programAttributes[attributeName];attributeItem=geometryAttributes[attributeName];attributeSize=attributeItem.itemSize;if(attributePointer>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,attributeItem.buffer);enableAttribute(attributePointer);_gl.vertexAttribPointer(attributePointer,attributeSize,_gl.FLOAT,false,0,0)}}var position=geometryAttributes["position"];_gl.drawArrays(_gl.POINTS,0,position.numItems/3);_this.info.render.calls++;_this.info.render.points+=position.numItems/3}}else if(object instanceof THREE.Line){if(updateBuffers){for(attributeName in geometryAttributes){attributePointer=programAttributes[attributeName];attributeItem=geometryAttributes[attributeName];attributeSize=attributeItem.itemSize;if(attributePointer>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,attributeItem.buffer);enableAttribute(attributePointer);_gl.vertexAttribPointer(attributePointer,attributeSize,_gl.FLOAT,false,0,0)}}setLineWidth(material.linewidth);var position=geometryAttributes["position"];_gl.drawArrays(_gl.LINE_STRIP,0,position.numItems/3);_this.info.render.calls++;_this.info.render.points+=position.numItems}}};this.renderBuffer=function(camera,lights,fog,material,geometryGroup,object){if(material.visible===false)return;var program,attributes,linewidth,primitives,a,attribute,i,il;program=setProgram(camera,lights,fog,material,object);attributes=program.attributes;var updateBuffers=false,wireframeBit=material.wireframe?1:0,geometryGroupHash=geometryGroup.id*16777215+program.id*2+wireframeBit;if(geometryGroupHash!==_currentGeometryGroupHash){_currentGeometryGroupHash=geometryGroupHash;updateBuffers=true}if(updateBuffers){disableAttributes()}if(!material.morphTargets&&attributes.position>=0){if(updateBuffers){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglVertexBuffer);enableAttribute(attributes.position);_gl.vertexAttribPointer(attributes.position,3,_gl.FLOAT,false,0,0)}}else{if(object.morphTargetBase){setupMorphTargets(material,geometryGroup,object)}}if(updateBuffers){if(geometryGroup.__webglCustomAttributesList){for(i=0,il=geometryGroup.__webglCustomAttributesList.length;i<il;i++){attribute=geometryGroup.__webglCustomAttributesList[i];if(attributes[attribute.buffer.belongsToAttribute]>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,attribute.buffer);enableAttribute(attributes[attribute.buffer.belongsToAttribute]);_gl.vertexAttribPointer(attributes[attribute.buffer.belongsToAttribute],attribute.size,_gl.FLOAT,false,0,0)}}}if(attributes.color>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglColorBuffer);enableAttribute(attributes.color);_gl.vertexAttribPointer(attributes.color,3,_gl.FLOAT,false,0,0)}if(attributes.normal>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglNormalBuffer);enableAttribute(attributes.normal);_gl.vertexAttribPointer(attributes.normal,3,_gl.FLOAT,false,0,0)}if(attributes.tangent>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglTangentBuffer);enableAttribute(attributes.tangent);_gl.vertexAttribPointer(attributes.tangent,4,_gl.FLOAT,false,0,0)}if(attributes.uv>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglUVBuffer);enableAttribute(attributes.uv);_gl.vertexAttribPointer(attributes.uv,2,_gl.FLOAT,false,0,0)}if(attributes.uv2>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglUV2Buffer);enableAttribute(attributes.uv2);_gl.vertexAttribPointer(attributes.uv2,2,_gl.FLOAT,false,0,0)}if(material.skinning&&attributes.skinIndex>=0&&attributes.skinWeight>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglSkinIndicesBuffer);enableAttribute(attributes.skinIndex);_gl.vertexAttribPointer(attributes.skinIndex,4,_gl.FLOAT,false,0,0);_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglSkinWeightsBuffer);enableAttribute(attributes.skinWeight);_gl.vertexAttribPointer(attributes.skinWeight,4,_gl.FLOAT,false,0,0)}if(attributes.lineDistance>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglLineDistanceBuffer);enableAttribute(attributes.lineDistance);_gl.vertexAttribPointer(attributes.lineDistance,1,_gl.FLOAT,false,0,0)}}if(object instanceof THREE.Mesh){if(material.wireframe){setLineWidth(material.wireframeLinewidth);if(updateBuffers)_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglLineBuffer);_gl.drawElements(_gl.LINES,geometryGroup.__webglLineCount,_gl.UNSIGNED_SHORT,0)}else{if(updateBuffers)_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglFaceBuffer);_gl.drawElements(_gl.TRIANGLES,geometryGroup.__webglFaceCount,_gl.UNSIGNED_SHORT,0)}_this.info.render.calls++;_this.info.render.vertices+=geometryGroup.__webglFaceCount;_this.info.render.faces+=geometryGroup.__webglFaceCount/3}else if(object instanceof THREE.Line){primitives=object.type===THREE.LineStrip?_gl.LINE_STRIP:_gl.LINES;setLineWidth(material.linewidth);_gl.drawArrays(primitives,0,geometryGroup.__webglLineCount);_this.info.render.calls++}else if(object instanceof THREE.ParticleSystem){_gl.drawArrays(_gl.POINTS,0,geometryGroup.__webglParticleCount);_this.info.render.calls++;_this.info.render.points+=geometryGroup.__webglParticleCount}else if(object instanceof THREE.Ribbon){_gl.drawArrays(_gl.TRIANGLE_STRIP,0,geometryGroup.__webglVertexCount);_this.info.render.calls++}};function enableAttribute(attribute){if(!_enabledAttributes[attribute]){_gl.enableVertexAttribArray(attribute);
_enabledAttributes[attribute]=true}}function disableAttributes(){for(var attribute in _enabledAttributes){if(_enabledAttributes[attribute]){_gl.disableVertexAttribArray(attribute);_enabledAttributes[attribute]=false}}}function setupMorphTargets(material,geometryGroup,object){var attributes=material.program.attributes;if(object.morphTargetBase!==-1&&attributes.position>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphTargetsBuffers[object.morphTargetBase]);enableAttribute(attributes.position);_gl.vertexAttribPointer(attributes.position,3,_gl.FLOAT,false,0,0)}else if(attributes.position>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglVertexBuffer);enableAttribute(attributes.position);_gl.vertexAttribPointer(attributes.position,3,_gl.FLOAT,false,0,0)}if(object.morphTargetForcedOrder.length){var m=0;var order=object.morphTargetForcedOrder;var influences=object.morphTargetInfluences;while(m<material.numSupportedMorphTargets&&m<order.length){if(attributes["morphTarget"+m]>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphTargetsBuffers[order[m]]);enableAttribute(attributes["morphTarget"+m]);_gl.vertexAttribPointer(attributes["morphTarget"+m],3,_gl.FLOAT,false,0,0)}if(attributes["morphNormal"+m]>=0&&material.morphNormals){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphNormalsBuffers[order[m]]);enableAttribute(attributes["morphNormal"+m]);_gl.vertexAttribPointer(attributes["morphNormal"+m],3,_gl.FLOAT,false,0,0)}object.__webglMorphTargetInfluences[m]=influences[order[m]];m++}}else{var influence,activeInfluenceIndices=[];var influences=object.morphTargetInfluences;var i,il=influences.length;for(i=0;i<il;i++){influence=influences[i];if(influence>0){activeInfluenceIndices.push([influence,i])}}if(activeInfluenceIndices.length>material.numSupportedMorphTargets){activeInfluenceIndices.sort(numericalSort);activeInfluenceIndices.length=material.numSupportedMorphTargets}else if(activeInfluenceIndices.length>material.numSupportedMorphNormals){activeInfluenceIndices.sort(numericalSort)}else if(activeInfluenceIndices.length===0){activeInfluenceIndices.push([0,0])}var influenceIndex,m=0;while(m<material.numSupportedMorphTargets){if(activeInfluenceIndices[m]){influenceIndex=activeInfluenceIndices[m][1];if(attributes["morphTarget"+m]>=0){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphTargetsBuffers[influenceIndex]);enableAttribute(attributes["morphTarget"+m]);_gl.vertexAttribPointer(attributes["morphTarget"+m],3,_gl.FLOAT,false,0,0)}if(attributes["morphNormal"+m]>=0&&material.morphNormals){_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglMorphNormalsBuffers[influenceIndex]);enableAttribute(attributes["morphNormal"+m]);_gl.vertexAttribPointer(attributes["morphNormal"+m],3,_gl.FLOAT,false,0,0)}object.__webglMorphTargetInfluences[m]=influences[influenceIndex]}else{object.__webglMorphTargetInfluences[m]=0}m++}}if(material.program.uniforms.morphTargetInfluences!==null){_gl.uniform1fv(material.program.uniforms.morphTargetInfluences,object.__webglMorphTargetInfluences)}}function painterSortStable(a,b){if(a.z!==b.z){return b.z-a.z}else{return a.id-b.id}}function numericalSort(a,b){return b[0]-a[0]}this.render=function(scene,camera,renderTarget,forceClear){if(camera instanceof THREE.Camera===false){console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");return}var i,il,webglObject,object,renderList,lights=scene.__lights,fog=scene.fog;_currentMaterialId=-1;_lightsNeedUpdate=true;if(scene.autoUpdate===true)scene.updateMatrixWorld();if(camera.parent===undefined)camera.updateMatrixWorld();camera.matrixWorldInverse.getInverse(camera.matrixWorld);_projScreenMatrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse);_frustum.setFromMatrix(_projScreenMatrix);if(this.autoUpdateObjects)this.initWebGLObjects(scene);renderPlugins(this.renderPluginsPre,scene,camera);_this.info.render.calls=0;_this.info.render.vertices=0;_this.info.render.faces=0;_this.info.render.points=0;this.setRenderTarget(renderTarget);if(this.autoClear||forceClear){this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil)}renderList=scene.__webglObjects;for(i=0,il=renderList.length;i<il;i++){webglObject=renderList[i];object=webglObject.object;webglObject.id=i;webglObject.render=false;if(object.visible){if(!(object instanceof THREE.Mesh||object instanceof THREE.ParticleSystem)||!object.frustumCulled||_frustum.intersectsObject(object)){setupMatrices(object,camera);unrollBufferMaterial(webglObject);webglObject.render=true;if(this.sortObjects===true){if(object.renderDepth!==null){webglObject.z=object.renderDepth}else{_vector3.getPositionFromMatrix(object.matrixWorld);_vector3.applyProjection(_projScreenMatrix);webglObject.z=_vector3.z}}}}}if(this.sortObjects){renderList.sort(painterSortStable)}renderList=scene.__webglObjectsImmediate;for(i=0,il=renderList.length;i<il;i++){webglObject=renderList[i];object=webglObject.object;if(object.visible){setupMatrices(object,camera);unrollImmediateBufferMaterial(webglObject)}}if(scene.overrideMaterial){var material=scene.overrideMaterial;this.setBlending(material.blending,material.blendEquation,material.blendSrc,material.blendDst);this.setDepthTest(material.depthTest);this.setDepthWrite(material.depthWrite);setPolygonOffset(material.polygonOffset,material.polygonOffsetFactor,material.polygonOffsetUnits);renderObjects(scene.__webglObjects,false,"",camera,lights,fog,true,material);renderObjectsImmediate(scene.__webglObjectsImmediate,"",camera,lights,fog,false,material)}else{var material=null;this.setBlending(THREE.NoBlending);renderObjects(scene.__webglObjects,true,"opaque",camera,lights,fog,false,material);renderObjectsImmediate(scene.__webglObjectsImmediate,"opaque",camera,lights,fog,false,material);renderObjects(scene.__webglObjects,false,"transparent",camera,lights,fog,true,material);renderObjectsImmediate(scene.__webglObjectsImmediate,"transparent",camera,lights,fog,true,material)}renderPlugins(this.renderPluginsPost,scene,camera);if(renderTarget&&renderTarget.generateMipmaps&&renderTarget.minFilter!==THREE.NearestFilter&&renderTarget.minFilter!==THREE.LinearFilter){updateRenderTargetMipmap(renderTarget)}this.setDepthTest(true);this.setDepthWrite(true)};function renderPlugins(plugins,scene,camera){if(!plugins.length)return;for(var i=0,il=plugins.length;i<il;i++){_currentProgram=null;_currentCamera=null;_oldBlending=-1;_oldDepthTest=-1;_oldDepthWrite=-1;_oldDoubleSided=-1;_oldFlipSided=-1;_currentGeometryGroupHash=-1;_currentMaterialId=-1;_lightsNeedUpdate=true;plugins[i].render(scene,camera,_currentWidth,_currentHeight);_currentProgram=null;_currentCamera=null;_oldBlending=-1;_oldDepthTest=-1;_oldDepthWrite=-1;_oldDoubleSided=-1;_oldFlipSided=-1;_currentGeometryGroupHash=-1;_currentMaterialId=-1;_lightsNeedUpdate=true}}function renderObjects(renderList,reverse,materialType,camera,lights,fog,useBlending,overrideMaterial){var webglObject,object,buffer,material,start,end,delta;if(reverse){start=renderList.length-1;end=-1;delta=-1}else{start=0;end=renderList.length;delta=1}for(var i=start;i!==end;i+=delta){webglObject=renderList[i];if(webglObject.render){object=webglObject.object;buffer=webglObject.buffer;if(overrideMaterial){material=overrideMaterial}else{material=webglObject[materialType];if(!material)continue;if(useBlending)_this.setBlending(material.blending,material.blendEquation,material.blendSrc,material.blendDst);_this.setDepthTest(material.depthTest);_this.setDepthWrite(material.depthWrite);setPolygonOffset(material.polygonOffset,material.polygonOffsetFactor,material.polygonOffsetUnits)}_this.setMaterialFaces(material);if(buffer instanceof THREE.BufferGeometry){_this.renderBufferDirect(camera,lights,fog,material,buffer,object)}else{_this.renderBuffer(camera,lights,fog,material,buffer,object)}}}}function renderObjectsImmediate(renderList,materialType,camera,lights,fog,useBlending,overrideMaterial){var webglObject,object,material,program;for(var i=0,il=renderList.length;i<il;i++){webglObject=renderList[i];object=webglObject.object;if(object.visible){if(overrideMaterial){material=overrideMaterial}else{material=webglObject[materialType];if(!material)continue;if(useBlending)_this.setBlending(material.blending,material.blendEquation,material.blendSrc,material.blendDst);_this.setDepthTest(material.depthTest);_this.setDepthWrite(material.depthWrite);setPolygonOffset(material.polygonOffset,material.polygonOffsetFactor,material.polygonOffsetUnits)}_this.renderImmediateObject(camera,lights,fog,material,object)}}}this.renderImmediateObject=function(camera,lights,fog,material,object){var program=setProgram(camera,lights,fog,material,object);_currentGeometryGroupHash=-1;_this.setMaterialFaces(material);if(object.immediateRenderCallback){object.immediateRenderCallback(program,_gl,_frustum)}else{object.render(function(object){_this.renderBufferImmediate(object,program,material)})}};function unrollImmediateBufferMaterial(globject){var object=globject.object,material=object.material;if(material.transparent){globject.transparent=material;globject.opaque=null}else{globject.opaque=material;globject.transparent=null}}function unrollBufferMaterial(globject){var object=globject.object,buffer=globject.buffer,material,materialIndex,meshMaterial;meshMaterial=object.material;if(meshMaterial instanceof THREE.MeshFaceMaterial){materialIndex=buffer.materialIndex;material=meshMaterial.materials[materialIndex];if(material.transparent){globject.transparent=material;globject.opaque=null}else{globject.opaque=material;globject.transparent=null}}else{material=meshMaterial;if(material){if(material.transparent){globject.transparent=material;globject.opaque=null}else{globject.opaque=material;globject.transparent=null}}}}function sortFacesByMaterial(geometry,material){var f,fl,face,materialIndex,vertices,groupHash,hash_map={};var numMorphTargets=geometry.morphTargets.length;var numMorphNormals=geometry.morphNormals.length;var usesFaceMaterial=material instanceof THREE.MeshFaceMaterial;geometry.geometryGroups={};for(f=0,fl=geometry.faces.length;f<fl;f++){face=geometry.faces[f];materialIndex=usesFaceMaterial?face.materialIndex:0;if(hash_map[materialIndex]===undefined){hash_map[materialIndex]={hash:materialIndex,counter:0}}groupHash=hash_map[materialIndex].hash+"_"+hash_map[materialIndex].counter;if(geometry.geometryGroups[groupHash]===undefined){geometry.geometryGroups[groupHash]={faces3:[],faces4:[],materialIndex:materialIndex,vertices:0,numMorphTargets:numMorphTargets,numMorphNormals:numMorphNormals}}vertices=face instanceof THREE.Face3?3:4;if(geometry.geometryGroups[groupHash].vertices+vertices>65535){hash_map[materialIndex].counter+=1;groupHash=hash_map[materialIndex].hash+"_"+hash_map[materialIndex].counter;if(geometry.geometryGroups[groupHash]===undefined){geometry.geometryGroups[groupHash]={faces3:[],faces4:[],materialIndex:materialIndex,vertices:0,numMorphTargets:numMorphTargets,numMorphNormals:numMorphNormals}}}if(face instanceof THREE.Face3){geometry.geometryGroups[groupHash].faces3.push(f)}else{geometry.geometryGroups[groupHash].faces4.push(f)}geometry.geometryGroups[groupHash].vertices+=vertices}geometry.geometryGroupsList=[];for(var g in geometry.geometryGroups){geometry.geometryGroups[g].id=_geometryGroupCounter++;geometry.geometryGroupsList.push(geometry.geometryGroups[g])}}this.initWebGLObjects=function(scene){if(!scene.__webglObjects){scene.__webglObjects=[];scene.__webglObjectsImmediate=[];scene.__webglSprites=[];scene.__webglFlares=[]}while(scene.__objectsAdded.length){addObject(scene.__objectsAdded[0],scene);scene.__objectsAdded.splice(0,1)}while(scene.__objectsRemoved.length){removeObject(scene.__objectsRemoved[0],scene);scene.__objectsRemoved.splice(0,1)}for(var o=0,ol=scene.__webglObjects.length;o<ol;o++){var object=scene.__webglObjects[o].object;if(object.__webglInit===undefined){if(object.__webglActive!==undefined){removeObject(object,scene)}addObject(object,scene)}updateObject(object)}};function addObject(object,scene){var g,geometry,material,geometryGroup;if(object.__webglInit===undefined){object.__webglInit=true;object._modelViewMatrix=new THREE.Matrix4;object._normalMatrix=new THREE.Matrix3;if(object.geometry!==undefined&&object.geometry.__webglInit===undefined){object.geometry.__webglInit=true;object.geometry.addEventListener("dispose",onGeometryDispose)}geometry=object.geometry;if(geometry===undefined){}else if(geometry instanceof THREE.BufferGeometry){initDirectBuffers(geometry)}else if(object instanceof THREE.Mesh){material=object.material;if(geometry.geometryGroups===undefined){sortFacesByMaterial(geometry,material)}for(g in geometry.geometryGroups){geometryGroup=geometry.geometryGroups[g];if(!geometryGroup.__webglVertexBuffer){createMeshBuffers(geometryGroup);initMeshBuffers(geometryGroup,object);geometry.verticesNeedUpdate=true;geometry.morphTargetsNeedUpdate=true;geometry.elementsNeedUpdate=true;geometry.uvsNeedUpdate=true;geometry.normalsNeedUpdate=true;geometry.tangentsNeedUpdate=true;geometry.colorsNeedUpdate=true}}}else if(object instanceof THREE.Ribbon){if(!geometry.__webglVertexBuffer){createRibbonBuffers(geometry);initRibbonBuffers(geometry,object);geometry.verticesNeedUpdate=true;geometry.colorsNeedUpdate=true;geometry.normalsNeedUpdate=true}}else if(object instanceof THREE.Line){if(!geometry.__webglVertexBuffer){createLineBuffers(geometry);initLineBuffers(geometry,object);geometry.verticesNeedUpdate=true;geometry.colorsNeedUpdate=true;geometry.lineDistancesNeedUpdate=true}}else if(object instanceof THREE.ParticleSystem){if(!geometry.__webglVertexBuffer){createParticleBuffers(geometry);initParticleBuffers(geometry,object);geometry.verticesNeedUpdate=true;geometry.colorsNeedUpdate=true}}}if(object.__webglActive===undefined){if(object instanceof THREE.Mesh){geometry=object.geometry;if(geometry instanceof THREE.BufferGeometry){addBuffer(scene.__webglObjects,geometry,object)}else if(geometry instanceof THREE.Geometry){for(g in geometry.geometryGroups){geometryGroup=geometry.geometryGroups[g];addBuffer(scene.__webglObjects,geometryGroup,object)}}}else if(object instanceof THREE.Ribbon||object instanceof THREE.Line||object instanceof THREE.ParticleSystem){geometry=object.geometry;addBuffer(scene.__webglObjects,geometry,object)}else if(object instanceof THREE.ImmediateRenderObject||object.immediateRenderCallback){addBufferImmediate(scene.__webglObjectsImmediate,object)}else if(object instanceof THREE.Sprite){scene.__webglSprites.push(object)}else if(object instanceof THREE.LensFlare){scene.__webglFlares.push(object)}object.__webglActive=true}}function addBuffer(objlist,buffer,object){objlist.push({id:null,buffer:buffer,object:object,opaque:null,transparent:null,z:0})}function addBufferImmediate(objlist,object){objlist.push({id:null,object:object,opaque:null,transparent:null,z:0})}function updateObject(object){var geometry=object.geometry,geometryGroup,customAttributesDirty,material;if(geometry instanceof THREE.BufferGeometry){setDirectBuffers(geometry,_gl.DYNAMIC_DRAW,!geometry.dynamic)}else if(object instanceof THREE.Mesh){for(var i=0,il=geometry.geometryGroupsList.length;i<il;i++){geometryGroup=geometry.geometryGroupsList[i];material=getBufferMaterial(object,geometryGroup);if(geometry.buffersNeedUpdate){initMeshBuffers(geometryGroup,object)}customAttributesDirty=material.attributes&&areCustomAttributesDirty(material);if(geometry.verticesNeedUpdate||geometry.morphTargetsNeedUpdate||geometry.elementsNeedUpdate||geometry.uvsNeedUpdate||geometry.normalsNeedUpdate||geometry.colorsNeedUpdate||geometry.tangentsNeedUpdate||customAttributesDirty){setMeshBuffers(geometryGroup,object,_gl.DYNAMIC_DRAW,!geometry.dynamic,material)}}geometry.verticesNeedUpdate=false;geometry.morphTargetsNeedUpdate=false;geometry.elementsNeedUpdate=false;geometry.uvsNeedUpdate=false;geometry.normalsNeedUpdate=false;geometry.colorsNeedUpdate=false;geometry.tangentsNeedUpdate=false;geometry.buffersNeedUpdate=false;material.attributes&&clearCustomAttributes(material)}else if(object instanceof THREE.Ribbon){material=getBufferMaterial(object,geometry);customAttributesDirty=material.attributes&&areCustomAttributesDirty(material);if(geometry.verticesNeedUpdate||geometry.colorsNeedUpdate||geometry.normalsNeedUpdate||customAttributesDirty){setRibbonBuffers(geometry,_gl.DYNAMIC_DRAW)}geometry.verticesNeedUpdate=false;geometry.colorsNeedUpdate=false;geometry.normalsNeedUpdate=false;material.attributes&&clearCustomAttributes(material)}else if(object instanceof THREE.Line){material=getBufferMaterial(object,geometry);customAttributesDirty=material.attributes&&areCustomAttributesDirty(material);if(geometry.verticesNeedUpdate||geometry.colorsNeedUpdate||geometry.lineDistancesNeedUpdate||customAttributesDirty){setLineBuffers(geometry,_gl.DYNAMIC_DRAW)}geometry.verticesNeedUpdate=false;geometry.colorsNeedUpdate=false;geometry.lineDistancesNeedUpdate=false;material.attributes&&clearCustomAttributes(material)}else if(object instanceof THREE.ParticleSystem){material=getBufferMaterial(object,geometry);customAttributesDirty=material.attributes&&areCustomAttributesDirty(material);if(geometry.verticesNeedUpdate||geometry.colorsNeedUpdate||object.sortParticles||customAttributesDirty){setParticleBuffers(geometry,_gl.DYNAMIC_DRAW,object)}geometry.verticesNeedUpdate=false;geometry.colorsNeedUpdate=false;material.attributes&&clearCustomAttributes(material)}}function areCustomAttributesDirty(material){for(var a in material.attributes){if(material.attributes[a].needsUpdate)return true}return false}function clearCustomAttributes(material){for(var a in material.attributes){material.attributes[a].needsUpdate=false}}function removeObject(object,scene){if(object instanceof THREE.Mesh||object instanceof THREE.ParticleSystem||object instanceof THREE.Ribbon||object instanceof THREE.Line){removeInstances(scene.__webglObjects,object)}else if(object instanceof THREE.Sprite){removeInstancesDirect(scene.__webglSprites,object)}else if(object instanceof THREE.LensFlare){removeInstancesDirect(scene.__webglFlares,object)}else if(object instanceof THREE.ImmediateRenderObject||object.immediateRenderCallback){removeInstances(scene.__webglObjectsImmediate,object)}delete object.__webglActive}function removeInstances(objlist,object){for(var o=objlist.length-1;o>=0;o--){if(objlist[o].object===object){objlist.splice(o,1)}}}function removeInstancesDirect(objlist,object){for(var o=objlist.length-1;o>=0;o--){if(objlist[o]===object){objlist.splice(o,1)}}}this.initMaterial=function(material,lights,fog,object){material.addEventListener("dispose",onMaterialDispose);var u,a,identifiers,i,parameters,maxLightCount,maxBones,maxShadows,shaderID;if(material instanceof THREE.MeshDepthMaterial){shaderID="depth"}else if(material instanceof THREE.MeshNormalMaterial){shaderID="normal"}else if(material instanceof THREE.MeshBasicMaterial){shaderID="basic"}else if(material instanceof THREE.MeshLambertMaterial){shaderID="lambert"}else if(material instanceof THREE.MeshPhongMaterial){shaderID="phong"}else if(material instanceof THREE.LineBasicMaterial){shaderID="basic"}else if(material instanceof THREE.LineDashedMaterial){shaderID="dashed"}else if(material instanceof THREE.ParticleBasicMaterial){shaderID="particle_basic"}if(shaderID){setMaterialShaders(material,THREE.ShaderLib[shaderID])}maxLightCount=allocateLights(lights);maxShadows=allocateShadows(lights);maxBones=allocateBones(object);parameters={map:!!material.map,envMap:!!material.envMap,lightMap:!!material.lightMap,bumpMap:!!material.bumpMap,normalMap:!!material.normalMap,specularMap:!!material.specularMap,vertexColors:material.vertexColors,fog:fog,useFog:material.fog,fogExp:fog instanceof THREE.FogExp2,sizeAttenuation:material.sizeAttenuation,skinning:material.skinning,maxBones:maxBones,useVertexTexture:_supportsBoneTextures&&object&&object.useVertexTexture,boneTextureWidth:object&&object.boneTextureWidth,boneTextureHeight:object&&object.boneTextureHeight,morphTargets:material.morphTargets,morphNormals:material.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,maxDirLights:maxLightCount.directional,maxPointLights:maxLightCount.point,maxSpotLights:maxLightCount.spot,maxHemiLights:maxLightCount.hemi,maxShadows:maxShadows,shadowMapEnabled:this.shadowMapEnabled&&object.receiveShadow,shadowMapType:this.shadowMapType,shadowMapDebug:this.shadowMapDebug,shadowMapCascade:this.shadowMapCascade,alphaTest:material.alphaTest,metal:material.metal,perPixel:material.perPixel,wrapAround:material.wrapAround,doubleSided:material.side===THREE.DoubleSide,flipSided:material.side===THREE.BackSide};material.program=buildProgram(shaderID,material.fragmentShader,material.vertexShader,material.uniforms,material.attributes,material.defines,parameters);var attributes=material.program.attributes;if(material.morphTargets){material.numSupportedMorphTargets=0;var id,base="morphTarget";for(i=0;i<this.maxMorphTargets;i++){id=base+i;if(attributes[id]>=0){material.numSupportedMorphTargets++}}}if(material.morphNormals){material.numSupportedMorphNormals=0;var id,base="morphNormal";for(i=0;i<this.maxMorphNormals;i++){id=base+i;if(attributes[id]>=0){material.numSupportedMorphNormals++}}}material.uniformsList=[];for(u in material.uniforms){material.uniformsList.push([material.uniforms[u],u])}};function setMaterialShaders(material,shaders){material.uniforms=THREE.UniformsUtils.clone(shaders.uniforms);material.vertexShader=shaders.vertexShader;material.fragmentShader=shaders.fragmentShader}function setProgram(camera,lights,fog,material,object){_usedTextureUnits=0;if(material.needsUpdate){if(material.program)deallocateMaterial(material);_this.initMaterial(material,lights,fog,object);material.needsUpdate=false}if(material.morphTargets){if(!object.__webglMorphTargetInfluences){object.__webglMorphTargetInfluences=new Float32Array(_this.maxMorphTargets)}}var refreshMaterial=false;var program=material.program,p_uniforms=program.uniforms,m_uniforms=material.uniforms;if(program!==_currentProgram){_gl.useProgram(program);_currentProgram=program;refreshMaterial=true}if(material.id!==_currentMaterialId){_currentMaterialId=material.id;refreshMaterial=true}if(refreshMaterial||camera!==_currentCamera){_gl.uniformMatrix4fv(p_uniforms.projectionMatrix,false,camera.projectionMatrix.elements);if(camera!==_currentCamera)_currentCamera=camera}if(material.skinning){if(_supportsBoneTextures&&object.useVertexTexture){if(p_uniforms.boneTexture!==null){var textureUnit=getTextureUnit();_gl.uniform1i(p_uniforms.boneTexture,textureUnit);_this.setTexture(object.boneTexture,textureUnit)}}else{if(p_uniforms.boneGlobalMatrices!==null){_gl.uniformMatrix4fv(p_uniforms.boneGlobalMatrices,false,object.boneMatrices)}}}if(refreshMaterial){if(fog&&material.fog){refreshUniformsFog(m_uniforms,fog)}if(material instanceof THREE.MeshPhongMaterial||material instanceof THREE.MeshLambertMaterial||material.lights){if(_lightsNeedUpdate){setupLights(program,lights);_lightsNeedUpdate=false}refreshUniformsLights(m_uniforms,_lights)}if(material instanceof THREE.MeshBasicMaterial||material instanceof THREE.MeshLambertMaterial||material instanceof THREE.MeshPhongMaterial){refreshUniformsCommon(m_uniforms,material)}if(material instanceof THREE.LineBasicMaterial){refreshUniformsLine(m_uniforms,material)}else if(material instanceof THREE.LineDashedMaterial){refreshUniformsLine(m_uniforms,material);refreshUniformsDash(m_uniforms,material)}else if(material instanceof THREE.ParticleBasicMaterial){refreshUniformsParticle(m_uniforms,material)}else if(material instanceof THREE.MeshPhongMaterial){refreshUniformsPhong(m_uniforms,material)}else if(material instanceof THREE.MeshLambertMaterial){refreshUniformsLambert(m_uniforms,material)}else if(material instanceof THREE.MeshDepthMaterial){m_uniforms.mNear.value=camera.near;m_uniforms.mFar.value=camera.far;m_uniforms.opacity.value=material.opacity}else if(material instanceof THREE.MeshNormalMaterial){m_uniforms.opacity.value=material.opacity}if(object.receiveShadow&&!material._shadowPass){refreshUniformsShadow(m_uniforms,lights)}loadUniformsGeneric(program,material.uniformsList);if(material instanceof THREE.ShaderMaterial||material instanceof THREE.MeshPhongMaterial||material.envMap){if(p_uniforms.cameraPosition!==null){_vector3.getPositionFromMatrix(camera.matrixWorld);_gl.uniform3f(p_uniforms.cameraPosition,_vector3.x,_vector3.y,_vector3.z)}}if(material instanceof THREE.MeshPhongMaterial||material instanceof THREE.MeshLambertMaterial||material instanceof THREE.ShaderMaterial||material.skinning){if(p_uniforms.viewMatrix!==null){_gl.uniformMatrix4fv(p_uniforms.viewMatrix,false,camera.matrixWorldInverse.elements)}}}loadUniformsMatrices(p_uniforms,object);if(p_uniforms.modelMatrix!==null){_gl.uniformMatrix4fv(p_uniforms.modelMatrix,false,object.matrixWorld.elements)}return program}function refreshUniformsCommon(uniforms,material){uniforms.opacity.value=material.opacity;if(_this.gammaInput){uniforms.diffuse.value.copyGammaToLinear(material.color)}else{uniforms.diffuse.value=material.color}uniforms.map.value=material.map;uniforms.lightMap.value=material.lightMap;uniforms.specularMap.value=material.specularMap;if(material.bumpMap){uniforms.bumpMap.value=material.bumpMap;uniforms.bumpScale.value=material.bumpScale}if(material.normalMap){uniforms.normalMap.value=material.normalMap;uniforms.normalScale.value.copy(material.normalScale)}var uvScaleMap;if(material.map){uvScaleMap=material.map}else if(material.specularMap){uvScaleMap=material.specularMap}else if(material.normalMap){uvScaleMap=material.normalMap}else if(material.bumpMap){uvScaleMap=material.bumpMap}if(uvScaleMap!==undefined){var offset=uvScaleMap.offset;var repeat=uvScaleMap.repeat;uniforms.offsetRepeat.value.set(offset.x,offset.y,repeat.x,repeat.y)}uniforms.envMap.value=material.envMap;uniforms.flipEnvMap.value=material.envMap instanceof THREE.WebGLRenderTargetCube?1:-1;if(_this.gammaInput){uniforms.reflectivity.value=material.reflectivity}else{uniforms.reflectivity.value=material.reflectivity}uniforms.refractionRatio.value=material.refractionRatio;uniforms.combine.value=material.combine;uniforms.useRefract.value=material.envMap&&material.envMap.mapping instanceof THREE.CubeRefractionMapping}function refreshUniformsLine(uniforms,material){uniforms.diffuse.value=material.color;uniforms.opacity.value=material.opacity}function refreshUniformsDash(uniforms,material){uniforms.dashSize.value=material.dashSize;uniforms.totalSize.value=material.dashSize+material.gapSize;uniforms.scale.value=material.scale}function refreshUniformsParticle(uniforms,material){uniforms.psColor.value=material.color;uniforms.opacity.value=material.opacity;uniforms.size.value=material.size;uniforms.scale.value=_canvas.height/2;uniforms.map.value=material.map}function refreshUniformsFog(uniforms,fog){uniforms.fogColor.value=fog.color;if(fog instanceof THREE.Fog){uniforms.fogNear.value=fog.near;uniforms.fogFar.value=fog.far}else if(fog instanceof THREE.FogExp2){uniforms.fogDensity.value=fog.density}}function refreshUniformsPhong(uniforms,material){uniforms.shininess.value=material.shininess;if(_this.gammaInput){uniforms.ambient.value.copyGammaToLinear(material.ambient);uniforms.emissive.value.copyGammaToLinear(material.emissive);uniforms.specular.value.copyGammaToLinear(material.specular)}else{uniforms.ambient.value=material.ambient;uniforms.emissive.value=material.emissive;uniforms.specular.value=material.specular}if(material.wrapAround){uniforms.wrapRGB.value.copy(material.wrapRGB)}}function refreshUniformsLambert(uniforms,material){if(_this.gammaInput){uniforms.ambient.value.copyGammaToLinear(material.ambient);uniforms.emissive.value.copyGammaToLinear(material.emissive)}else{uniforms.ambient.value=material.ambient;uniforms.emissive.value=material.emissive}if(material.wrapAround){uniforms.wrapRGB.value.copy(material.wrapRGB)}}function refreshUniformsLights(uniforms,lights){uniforms.ambientLightColor.value=lights.ambient;uniforms.directionalLightColor.value=lights.directional.colors;uniforms.directionalLightDirection.value=lights.directional.positions;uniforms.pointLightColor.value=lights.point.colors;uniforms.pointLightPosition.value=lights.point.positions;uniforms.pointLightDistance.value=lights.point.distances;uniforms.spotLightColor.value=lights.spot.colors;uniforms.spotLightPosition.value=lights.spot.positions;uniforms.spotLightDistance.value=lights.spot.distances;uniforms.spotLightDirection.value=lights.spot.directions;uniforms.spotLightAngleCos.value=lights.spot.anglesCos;uniforms.spotLightExponent.value=lights.spot.exponents;uniforms.hemisphereLightSkyColor.value=lights.hemi.skyColors;uniforms.hemisphereLightGroundColor.value=lights.hemi.groundColors;uniforms.hemisphereLightDirection.value=lights.hemi.positions}function refreshUniformsShadow(uniforms,lights){if(uniforms.shadowMatrix){var j=0;for(var i=0,il=lights.length;i<il;i++){var light=lights[i];if(!light.castShadow)continue;if(light instanceof THREE.SpotLight||light instanceof THREE.DirectionalLight&&!light.shadowCascade){uniforms.shadowMap.value[j]=light.shadowMap;uniforms.shadowMapSize.value[j]=light.shadowMapSize;uniforms.shadowMatrix.value[j]=light.shadowMatrix;uniforms.shadowDarkness.value[j]=light.shadowDarkness;uniforms.shadowBias.value[j]=light.shadowBias;j++}}}}function loadUniformsMatrices(uniforms,object){_gl.uniformMatrix4fv(uniforms.modelViewMatrix,false,object._modelViewMatrix.elements);if(uniforms.normalMatrix){_gl.uniformMatrix3fv(uniforms.normalMatrix,false,object._normalMatrix.elements)}}function getTextureUnit(){var textureUnit=_usedTextureUnits;if(textureUnit>=_maxTextures){console.warn("WebGLRenderer: trying to use "+textureUnit+" texture units while this GPU supports only "+_maxTextures)}_usedTextureUnits+=1;return textureUnit}function loadUniformsGeneric(program,uniforms){var uniform,value,type,location,texture,textureUnit,i,il,j,jl,offset;for(j=0,jl=uniforms.length;j<jl;j++){location=program.uniforms[uniforms[j][1]];if(!location)continue;uniform=uniforms[j][0];type=uniform.type;value=uniform.value;if(type==="i"){_gl.uniform1i(location,value)}else if(type==="f"){_gl.uniform1f(location,value)}else if(type==="v2"){_gl.uniform2f(location,value.x,value.y)}else if(type==="v3"){_gl.uniform3f(location,value.x,value.y,value.z)}else if(type==="v4"){_gl.uniform4f(location,value.x,value.y,value.z,value.w)}else if(type==="c"){_gl.uniform3f(location,value.r,value.g,value.b)}else if(type==="iv1"){_gl.uniform1iv(location,value)}else if(type==="iv"){_gl.uniform3iv(location,value)}else if(type==="fv1"){_gl.uniform1fv(location,value)}else if(type==="fv"){_gl.uniform3fv(location,value)}else if(type==="v2v"){if(uniform._array===undefined){uniform._array=new Float32Array(2*value.length)}for(i=0,il=value.length;i<il;i++){offset=i*2;uniform._array[offset]=value[i].x;uniform._array[offset+1]=value[i].y}_gl.uniform2fv(location,uniform._array)}else if(type==="v3v"){if(uniform._array===undefined){uniform._array=new Float32Array(3*value.length)}for(i=0,il=value.length;i<il;i++){offset=i*3;uniform._array[offset]=value[i].x;uniform._array[offset+1]=value[i].y;uniform._array[offset+2]=value[i].z}_gl.uniform3fv(location,uniform._array)}else if(type==="v4v"){if(uniform._array===undefined){uniform._array=new Float32Array(4*value.length)}for(i=0,il=value.length;i<il;i++){offset=i*4;uniform._array[offset]=value[i].x;uniform._array[offset+1]=value[i].y;uniform._array[offset+2]=value[i].z;uniform._array[offset+3]=value[i].w}_gl.uniform4fv(location,uniform._array)}else if(type==="m4"){if(uniform._array===undefined){uniform._array=new Float32Array(16)}value.flattenToArray(uniform._array);_gl.uniformMatrix4fv(location,false,uniform._array)}else if(type==="m4v"){if(uniform._array===undefined){uniform._array=new Float32Array(16*value.length)}for(i=0,il=value.length;i<il;i++){value[i].flattenToArrayOffset(uniform._array,i*16)}_gl.uniformMatrix4fv(location,false,uniform._array)}else if(type==="t"){texture=value;
textureUnit=getTextureUnit();_gl.uniform1i(location,textureUnit);if(!texture)continue;if(texture.image instanceof Array&&texture.image.length===6){setCubeTexture(texture,textureUnit)}else if(texture instanceof THREE.WebGLRenderTargetCube){setCubeTextureDynamic(texture,textureUnit)}else{_this.setTexture(texture,textureUnit)}}else if(type==="tv"){if(uniform._array===undefined){uniform._array=[]}for(i=0,il=uniform.value.length;i<il;i++){uniform._array[i]=getTextureUnit()}_gl.uniform1iv(location,uniform._array);for(i=0,il=uniform.value.length;i<il;i++){texture=uniform.value[i];textureUnit=uniform._array[i];if(!texture)continue;_this.setTexture(texture,textureUnit)}}}}function setupMatrices(object,camera){object._modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld);object._normalMatrix.getNormalMatrix(object._modelViewMatrix)}function setColorGamma(array,offset,color,intensitySq){array[offset]=color.r*color.r*intensitySq;array[offset+1]=color.g*color.g*intensitySq;array[offset+2]=color.b*color.b*intensitySq}function setColorLinear(array,offset,color,intensity){array[offset]=color.r*intensity;array[offset+1]=color.g*intensity;array[offset+2]=color.b*intensity}function setupLights(program,lights){var l,ll,light,n,r=0,g=0,b=0,color,skyColor,groundColor,intensity,intensitySq,position,distance,zlights=_lights,dirColors=zlights.directional.colors,dirPositions=zlights.directional.positions,pointColors=zlights.point.colors,pointPositions=zlights.point.positions,pointDistances=zlights.point.distances,spotColors=zlights.spot.colors,spotPositions=zlights.spot.positions,spotDistances=zlights.spot.distances,spotDirections=zlights.spot.directions,spotAnglesCos=zlights.spot.anglesCos,spotExponents=zlights.spot.exponents,hemiSkyColors=zlights.hemi.skyColors,hemiGroundColors=zlights.hemi.groundColors,hemiPositions=zlights.hemi.positions,dirLength=0,pointLength=0,spotLength=0,hemiLength=0,dirCount=0,pointCount=0,spotCount=0,hemiCount=0,dirOffset=0,pointOffset=0,spotOffset=0,hemiOffset=0;for(l=0,ll=lights.length;l<ll;l++){light=lights[l];if(light.onlyShadow)continue;color=light.color;intensity=light.intensity;distance=light.distance;if(light instanceof THREE.AmbientLight){if(!light.visible)continue;if(_this.gammaInput){r+=color.r*color.r;g+=color.g*color.g;b+=color.b*color.b}else{r+=color.r;g+=color.g;b+=color.b}}else if(light instanceof THREE.DirectionalLight){dirCount+=1;if(!light.visible)continue;_direction.getPositionFromMatrix(light.matrixWorld);_vector3.getPositionFromMatrix(light.target.matrixWorld);_direction.sub(_vector3);_direction.normalize();if(_direction.x===0&&_direction.y===0&&_direction.z===0)continue;dirOffset=dirLength*3;dirPositions[dirOffset]=_direction.x;dirPositions[dirOffset+1]=_direction.y;dirPositions[dirOffset+2]=_direction.z;if(_this.gammaInput){setColorGamma(dirColors,dirOffset,color,intensity*intensity)}else{setColorLinear(dirColors,dirOffset,color,intensity)}dirLength+=1}else if(light instanceof THREE.PointLight){pointCount+=1;if(!light.visible)continue;pointOffset=pointLength*3;if(_this.gammaInput){setColorGamma(pointColors,pointOffset,color,intensity*intensity)}else{setColorLinear(pointColors,pointOffset,color,intensity)}_vector3.getPositionFromMatrix(light.matrixWorld);pointPositions[pointOffset]=_vector3.x;pointPositions[pointOffset+1]=_vector3.y;pointPositions[pointOffset+2]=_vector3.z;pointDistances[pointLength]=distance;pointLength+=1}else if(light instanceof THREE.SpotLight){spotCount+=1;if(!light.visible)continue;spotOffset=spotLength*3;if(_this.gammaInput){setColorGamma(spotColors,spotOffset,color,intensity*intensity)}else{setColorLinear(spotColors,spotOffset,color,intensity)}_vector3.getPositionFromMatrix(light.matrixWorld);spotPositions[spotOffset]=_vector3.x;spotPositions[spotOffset+1]=_vector3.y;spotPositions[spotOffset+2]=_vector3.z;spotDistances[spotLength]=distance;_direction.copy(_vector3);_vector3.getPositionFromMatrix(light.target.matrixWorld);_direction.sub(_vector3);_direction.normalize();spotDirections[spotOffset]=_direction.x;spotDirections[spotOffset+1]=_direction.y;spotDirections[spotOffset+2]=_direction.z;spotAnglesCos[spotLength]=Math.cos(light.angle);spotExponents[spotLength]=light.exponent;spotLength+=1}else if(light instanceof THREE.HemisphereLight){hemiCount+=1;if(!light.visible)continue;_direction.getPositionFromMatrix(light.matrixWorld);_direction.normalize();if(_direction.x===0&&_direction.y===0&&_direction.z===0)continue;hemiOffset=hemiLength*3;hemiPositions[hemiOffset]=_direction.x;hemiPositions[hemiOffset+1]=_direction.y;hemiPositions[hemiOffset+2]=_direction.z;skyColor=light.color;groundColor=light.groundColor;if(_this.gammaInput){intensitySq=intensity*intensity;setColorGamma(hemiSkyColors,hemiOffset,skyColor,intensitySq);setColorGamma(hemiGroundColors,hemiOffset,groundColor,intensitySq)}else{setColorLinear(hemiSkyColors,hemiOffset,skyColor,intensity);setColorLinear(hemiGroundColors,hemiOffset,groundColor,intensity)}hemiLength+=1}}for(l=dirLength*3,ll=Math.max(dirColors.length,dirCount*3);l<ll;l++)dirColors[l]=0;for(l=pointLength*3,ll=Math.max(pointColors.length,pointCount*3);l<ll;l++)pointColors[l]=0;for(l=spotLength*3,ll=Math.max(spotColors.length,spotCount*3);l<ll;l++)spotColors[l]=0;for(l=hemiLength*3,ll=Math.max(hemiSkyColors.length,hemiCount*3);l<ll;l++)hemiSkyColors[l]=0;for(l=hemiLength*3,ll=Math.max(hemiGroundColors.length,hemiCount*3);l<ll;l++)hemiGroundColors[l]=0;zlights.directional.length=dirLength;zlights.point.length=pointLength;zlights.spot.length=spotLength;zlights.hemi.length=hemiLength;zlights.ambient[0]=r;zlights.ambient[1]=g;zlights.ambient[2]=b}this.setFaceCulling=function(cullFace,frontFaceDirection){if(cullFace===THREE.CullFaceNone){_gl.disable(_gl.CULL_FACE)}else{if(frontFaceDirection===THREE.FrontFaceDirectionCW){_gl.frontFace(_gl.CW)}else{_gl.frontFace(_gl.CCW)}if(cullFace===THREE.CullFaceBack){_gl.cullFace(_gl.BACK)}else if(cullFace===THREE.CullFaceFront){_gl.cullFace(_gl.FRONT)}else{_gl.cullFace(_gl.FRONT_AND_BACK)}_gl.enable(_gl.CULL_FACE)}};this.setMaterialFaces=function(material){var doubleSided=material.side===THREE.DoubleSide;var flipSided=material.side===THREE.BackSide;if(_oldDoubleSided!==doubleSided){if(doubleSided){_gl.disable(_gl.CULL_FACE)}else{_gl.enable(_gl.CULL_FACE)}_oldDoubleSided=doubleSided}if(_oldFlipSided!==flipSided){if(flipSided){_gl.frontFace(_gl.CW)}else{_gl.frontFace(_gl.CCW)}_oldFlipSided=flipSided}};this.setDepthTest=function(depthTest){if(_oldDepthTest!==depthTest){if(depthTest){_gl.enable(_gl.DEPTH_TEST)}else{_gl.disable(_gl.DEPTH_TEST)}_oldDepthTest=depthTest}};this.setDepthWrite=function(depthWrite){if(_oldDepthWrite!==depthWrite){_gl.depthMask(depthWrite);_oldDepthWrite=depthWrite}};function setLineWidth(width){if(width!==_oldLineWidth){_gl.lineWidth(width);_oldLineWidth=width}}function setPolygonOffset(polygonoffset,factor,units){if(_oldPolygonOffset!==polygonoffset){if(polygonoffset){_gl.enable(_gl.POLYGON_OFFSET_FILL)}else{_gl.disable(_gl.POLYGON_OFFSET_FILL)}_oldPolygonOffset=polygonoffset}if(polygonoffset&&(_oldPolygonOffsetFactor!==factor||_oldPolygonOffsetUnits!==units)){_gl.polygonOffset(factor,units);_oldPolygonOffsetFactor=factor;_oldPolygonOffsetUnits=units}}this.setBlending=function(blending,blendEquation,blendSrc,blendDst){if(blending!==_oldBlending){if(blending===THREE.NoBlending){_gl.disable(_gl.BLEND)}else if(blending===THREE.AdditiveBlending){_gl.enable(_gl.BLEND);_gl.blendEquation(_gl.FUNC_ADD);_gl.blendFunc(_gl.SRC_ALPHA,_gl.ONE)}else if(blending===THREE.SubtractiveBlending){_gl.enable(_gl.BLEND);_gl.blendEquation(_gl.FUNC_ADD);_gl.blendFunc(_gl.ZERO,_gl.ONE_MINUS_SRC_COLOR)}else if(blending===THREE.MultiplyBlending){_gl.enable(_gl.BLEND);_gl.blendEquation(_gl.FUNC_ADD);_gl.blendFunc(_gl.ZERO,_gl.SRC_COLOR)}else if(blending===THREE.CustomBlending){_gl.enable(_gl.BLEND)}else{_gl.enable(_gl.BLEND);_gl.blendEquationSeparate(_gl.FUNC_ADD,_gl.FUNC_ADD);_gl.blendFuncSeparate(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA,_gl.ONE,_gl.ONE_MINUS_SRC_ALPHA)}_oldBlending=blending}if(blending===THREE.CustomBlending){if(blendEquation!==_oldBlendEquation){_gl.blendEquation(paramThreeToGL(blendEquation));_oldBlendEquation=blendEquation}if(blendSrc!==_oldBlendSrc||blendDst!==_oldBlendDst){_gl.blendFunc(paramThreeToGL(blendSrc),paramThreeToGL(blendDst));_oldBlendSrc=blendSrc;_oldBlendDst=blendDst}}else{_oldBlendEquation=null;_oldBlendSrc=null;_oldBlendDst=null}};function generateDefines(defines){var value,chunk,chunks=[];for(var d in defines){value=defines[d];if(value===false)continue;chunk="#define "+d+" "+value;chunks.push(chunk)}return chunks.join("\n")}function buildProgram(shaderID,fragmentShader,vertexShader,uniforms,attributes,defines,parameters){var p,pl,d,program,code;var chunks=[];if(shaderID){chunks.push(shaderID)}else{chunks.push(fragmentShader);chunks.push(vertexShader)}for(d in defines){chunks.push(d);chunks.push(defines[d])}for(p in parameters){chunks.push(p);chunks.push(parameters[p])}code=chunks.join();for(p=0,pl=_programs.length;p<pl;p++){var programInfo=_programs[p];if(programInfo.code===code){programInfo.usedTimes++;return programInfo.program}}var shadowMapTypeDefine="SHADOWMAP_TYPE_BASIC";if(parameters.shadowMapType===THREE.PCFShadowMap){shadowMapTypeDefine="SHADOWMAP_TYPE_PCF"}else if(parameters.shadowMapType===THREE.PCFSoftShadowMap){shadowMapTypeDefine="SHADOWMAP_TYPE_PCF_SOFT"}var customDefines=generateDefines(defines);program=_gl.createProgram();var prefix_vertex=["precision "+_precision+" float;",customDefines,_supportsVertexTextures?"#define VERTEX_TEXTURES":"",_this.gammaInput?"#define GAMMA_INPUT":"",_this.gammaOutput?"#define GAMMA_OUTPUT":"",_this.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"","#define MAX_DIR_LIGHTS "+parameters.maxDirLights,"#define MAX_POINT_LIGHTS "+parameters.maxPointLights,"#define MAX_SPOT_LIGHTS "+parameters.maxSpotLights,"#define MAX_HEMI_LIGHTS "+parameters.maxHemiLights,"#define MAX_SHADOWS "+parameters.maxShadows,"#define MAX_BONES "+parameters.maxBones,parameters.map?"#define USE_MAP":"",parameters.envMap?"#define USE_ENVMAP":"",parameters.lightMap?"#define USE_LIGHTMAP":"",parameters.bumpMap?"#define USE_BUMPMAP":"",parameters.normalMap?"#define USE_NORMALMAP":"",parameters.specularMap?"#define USE_SPECULARMAP":"",parameters.vertexColors?"#define USE_COLOR":"",parameters.skinning?"#define USE_SKINNING":"",parameters.useVertexTexture?"#define BONE_TEXTURE":"",parameters.boneTextureWidth?"#define N_BONE_PIXEL_X "+parameters.boneTextureWidth.toFixed(1):"",parameters.boneTextureHeight?"#define N_BONE_PIXEL_Y "+parameters.boneTextureHeight.toFixed(1):"",parameters.morphTargets?"#define USE_MORPHTARGETS":"",parameters.morphNormals?"#define USE_MORPHNORMALS":"",parameters.perPixel?"#define PHONG_PER_PIXEL":"",parameters.wrapAround?"#define WRAP_AROUND":"",parameters.doubleSided?"#define DOUBLE_SIDED":"",parameters.flipSided?"#define FLIP_SIDED":"",parameters.shadowMapEnabled?"#define USE_SHADOWMAP":"",parameters.shadowMapEnabled?"#define "+shadowMapTypeDefine:"",parameters.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",parameters.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",parameters.sizeAttenuation?"#define USE_SIZEATTENUATION":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","attribute vec2 uv2;","#ifdef USE_COLOR","attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#else","attribute vec3 morphTarget4;","attribute vec3 morphTarget5;","attribute vec3 morphTarget6;","attribute vec3 morphTarget7;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif",""].join("\n");var prefix_fragment=["precision "+_precision+" float;",parameters.bumpMap||parameters.normalMap?"#extension GL_OES_standard_derivatives : enable":"",customDefines,"#define MAX_DIR_LIGHTS "+parameters.maxDirLights,"#define MAX_POINT_LIGHTS "+parameters.maxPointLights,"#define MAX_SPOT_LIGHTS "+parameters.maxSpotLights,"#define MAX_HEMI_LIGHTS "+parameters.maxHemiLights,"#define MAX_SHADOWS "+parameters.maxShadows,parameters.alphaTest?"#define ALPHATEST "+parameters.alphaTest:"",_this.gammaInput?"#define GAMMA_INPUT":"",_this.gammaOutput?"#define GAMMA_OUTPUT":"",_this.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"",parameters.useFog&&parameters.fog?"#define USE_FOG":"",parameters.useFog&&parameters.fogExp?"#define FOG_EXP2":"",parameters.map?"#define USE_MAP":"",parameters.envMap?"#define USE_ENVMAP":"",parameters.lightMap?"#define USE_LIGHTMAP":"",parameters.bumpMap?"#define USE_BUMPMAP":"",parameters.normalMap?"#define USE_NORMALMAP":"",parameters.specularMap?"#define USE_SPECULARMAP":"",parameters.vertexColors?"#define USE_COLOR":"",parameters.metal?"#define METAL":"",parameters.perPixel?"#define PHONG_PER_PIXEL":"",parameters.wrapAround?"#define WRAP_AROUND":"",parameters.doubleSided?"#define DOUBLE_SIDED":"",parameters.flipSided?"#define FLIP_SIDED":"",parameters.shadowMapEnabled?"#define USE_SHADOWMAP":"",parameters.shadowMapEnabled?"#define "+shadowMapTypeDefine:"",parameters.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",parameters.shadowMapCascade?"#define SHADOWMAP_CASCADE":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",""].join("\n");var glVertexShader=getShader("vertex",prefix_vertex+vertexShader);var glFragmentShader=getShader("fragment",prefix_fragment+fragmentShader);_gl.attachShader(program,glVertexShader);_gl.attachShader(program,glFragmentShader);_gl.linkProgram(program);if(!_gl.getProgramParameter(program,_gl.LINK_STATUS)){console.error("Could not initialise shader\n"+"VALIDATE_STATUS: "+_gl.getProgramParameter(program,_gl.VALIDATE_STATUS)+", gl error ["+_gl.getError()+"]")}_gl.deleteShader(glFragmentShader);_gl.deleteShader(glVertexShader);program.uniforms={};program.attributes={};var identifiers,u,a,i;identifiers=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","cameraPosition","morphTargetInfluences"];if(parameters.useVertexTexture){identifiers.push("boneTexture")}else{identifiers.push("boneGlobalMatrices")}for(u in uniforms){identifiers.push(u)}cacheUniformLocations(program,identifiers);identifiers=["position","normal","uv","uv2","tangent","color","skinIndex","skinWeight","lineDistance"];for(i=0;i<parameters.maxMorphTargets;i++){identifiers.push("morphTarget"+i)}for(i=0;i<parameters.maxMorphNormals;i++){identifiers.push("morphNormal"+i)}for(a in attributes){identifiers.push(a)}cacheAttributeLocations(program,identifiers);program.id=_programs_counter++;_programs.push({program:program,code:code,usedTimes:1});_this.info.memory.programs=_programs.length;return program}function cacheUniformLocations(program,identifiers){var i,l,id;for(i=0,l=identifiers.length;i<l;i++){id=identifiers[i];program.uniforms[id]=_gl.getUniformLocation(program,id)}}function cacheAttributeLocations(program,identifiers){var i,l,id;for(i=0,l=identifiers.length;i<l;i++){id=identifiers[i];program.attributes[id]=_gl.getAttribLocation(program,id)}}function addLineNumbers(string){var chunks=string.split("\n");for(var i=0,il=chunks.length;i<il;i++){chunks[i]=i+1+": "+chunks[i]}return chunks.join("\n")}function getShader(type,string){var shader;if(type==="fragment"){shader=_gl.createShader(_gl.FRAGMENT_SHADER)}else if(type==="vertex"){shader=_gl.createShader(_gl.VERTEX_SHADER)}_gl.shaderSource(shader,string);_gl.compileShader(shader);if(!_gl.getShaderParameter(shader,_gl.COMPILE_STATUS)){console.error(_gl.getShaderInfoLog(shader));console.error(addLineNumbers(string));return null}return shader}function isPowerOfTwo(value){return(value&value-1)===0}function setTextureParameters(textureType,texture,isImagePowerOfTwo){if(isImagePowerOfTwo){_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_S,paramThreeToGL(texture.wrapS));_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_T,paramThreeToGL(texture.wrapT));_gl.texParameteri(textureType,_gl.TEXTURE_MAG_FILTER,paramThreeToGL(texture.magFilter));_gl.texParameteri(textureType,_gl.TEXTURE_MIN_FILTER,paramThreeToGL(texture.minFilter))}else{_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.texParameteri(textureType,_gl.TEXTURE_MAG_FILTER,filterFallback(texture.magFilter));_gl.texParameteri(textureType,_gl.TEXTURE_MIN_FILTER,filterFallback(texture.minFilter))}if(_glExtensionTextureFilterAnisotropic&&texture.type!==THREE.FloatType){if(texture.anisotropy>1||texture.__oldAnisotropy){_gl.texParameterf(textureType,_glExtensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(texture.anisotropy,_maxAnisotropy));texture.__oldAnisotropy=texture.anisotropy}}}this.setTexture=function(texture,slot){if(texture.needsUpdate){if(!texture.__webglInit){texture.__webglInit=true;texture.addEventListener("dispose",onTextureDispose);texture.__webglTexture=_gl.createTexture();_this.info.memory.textures++}_gl.activeTexture(_gl.TEXTURE0+slot);_gl.bindTexture(_gl.TEXTURE_2D,texture.__webglTexture);_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,texture.flipY);_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,texture.premultiplyAlpha);_gl.pixelStorei(_gl.UNPACK_ALIGNMENT,texture.unpackAlignment);var image=texture.image,isImagePowerOfTwo=isPowerOfTwo(image.width)&&isPowerOfTwo(image.height),glFormat=paramThreeToGL(texture.format),glType=paramThreeToGL(texture.type);setTextureParameters(_gl.TEXTURE_2D,texture,isImagePowerOfTwo);var mipmap,mipmaps=texture.mipmaps;if(texture instanceof THREE.DataTexture){if(mipmaps.length>0&&isImagePowerOfTwo){for(var i=0,il=mipmaps.length;i<il;i++){mipmap=mipmaps[i];_gl.texImage2D(_gl.TEXTURE_2D,i,glFormat,mipmap.width,mipmap.height,0,glFormat,glType,mipmap.data)}texture.generateMipmaps=false}else{_gl.texImage2D(_gl.TEXTURE_2D,0,glFormat,image.width,image.height,0,glFormat,glType,image.data)}}else if(texture instanceof THREE.CompressedTexture){for(var i=0,il=mipmaps.length;i<il;i++){mipmap=mipmaps[i];_gl.compressedTexImage2D(_gl.TEXTURE_2D,i,glFormat,mipmap.width,mipmap.height,0,mipmap.data)}}else{if(mipmaps.length>0&&isImagePowerOfTwo){for(var i=0,il=mipmaps.length;i<il;i++){mipmap=mipmaps[i];_gl.texImage2D(_gl.TEXTURE_2D,i,glFormat,glFormat,glType,mipmap)}texture.generateMipmaps=false}else{_gl.texImage2D(_gl.TEXTURE_2D,0,glFormat,glFormat,glType,texture.image)}}if(texture.generateMipmaps&&isImagePowerOfTwo)_gl.generateMipmap(_gl.TEXTURE_2D);texture.needsUpdate=false;if(texture.onUpdate)texture.onUpdate()}else{_gl.activeTexture(_gl.TEXTURE0+slot);_gl.bindTexture(_gl.TEXTURE_2D,texture.__webglTexture)}};function clampToMaxSize(image,maxSize){if(image.width<=maxSize&&image.height<=maxSize){return image}var maxDimension=Math.max(image.width,image.height);var newWidth=Math.floor(image.width*maxSize/maxDimension);var newHeight=Math.floor(image.height*maxSize/maxDimension);var canvas=document.createElement("canvas");canvas.width=newWidth;canvas.height=newHeight;var ctx=canvas.getContext("2d");ctx.drawImage(image,0,0,image.width,image.height,0,0,newWidth,newHeight);return canvas}function setCubeTexture(texture,slot){if(texture.image.length===6){if(texture.needsUpdate){if(!texture.image.__webglTextureCube){texture.image.__webglTextureCube=_gl.createTexture();_this.info.memory.textures++}_gl.activeTexture(_gl.TEXTURE0+slot);_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture.image.__webglTextureCube);_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,texture.flipY);var isCompressed=texture instanceof THREE.CompressedTexture;var cubeImage=[];for(var i=0;i<6;i++){if(_this.autoScaleCubemaps&&!isCompressed){cubeImage[i]=clampToMaxSize(texture.image[i],_maxCubemapSize)}else{cubeImage[i]=texture.image[i]}}var image=cubeImage[0],isImagePowerOfTwo=isPowerOfTwo(image.width)&&isPowerOfTwo(image.height),glFormat=paramThreeToGL(texture.format),glType=paramThreeToGL(texture.type);setTextureParameters(_gl.TEXTURE_CUBE_MAP,texture,isImagePowerOfTwo);for(var i=0;i<6;i++){if(isCompressed){var mipmap,mipmaps=cubeImage[i].mipmaps;for(var j=0,jl=mipmaps.length;j<jl;j++){mipmap=mipmaps[j];_gl.compressedTexImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,j,glFormat,mipmap.width,mipmap.height,0,mipmap.data)}}else{_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,glFormat,glFormat,glType,cubeImage[i])}}if(texture.generateMipmaps&&isImagePowerOfTwo){_gl.generateMipmap(_gl.TEXTURE_CUBE_MAP)}texture.needsUpdate=false;if(texture.onUpdate)texture.onUpdate()}else{_gl.activeTexture(_gl.TEXTURE0+slot);_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture.image.__webglTextureCube)}}}function setCubeTextureDynamic(texture,slot){_gl.activeTexture(_gl.TEXTURE0+slot);_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture.__webglTexture)}function setupFrameBuffer(framebuffer,renderTarget,textureTarget){_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,textureTarget,renderTarget.__webglTexture,0)}function setupRenderBuffer(renderbuffer,renderTarget){_gl.bindRenderbuffer(_gl.RENDERBUFFER,renderbuffer);if(renderTarget.depthBuffer&&!renderTarget.stencilBuffer){_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_COMPONENT16,renderTarget.width,renderTarget.height);_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,renderbuffer)}else if(renderTarget.depthBuffer&&renderTarget.stencilBuffer){_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_STENCIL,renderTarget.width,renderTarget.height);_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_STENCIL_ATTACHMENT,_gl.RENDERBUFFER,renderbuffer)}else{_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.RGBA4,renderTarget.width,renderTarget.height)}}this.setRenderTarget=function(renderTarget){var isCube=renderTarget instanceof THREE.WebGLRenderTargetCube;if(renderTarget&&!renderTarget.__webglFramebuffer){if(renderTarget.depthBuffer===undefined)renderTarget.depthBuffer=true;if(renderTarget.stencilBuffer===undefined)renderTarget.stencilBuffer=true;renderTarget.addEventListener("dispose",onRenderTargetDispose);renderTarget.__webglTexture=_gl.createTexture();_this.info.memory.textures++;var isTargetPowerOfTwo=isPowerOfTwo(renderTarget.width)&&isPowerOfTwo(renderTarget.height),glFormat=paramThreeToGL(renderTarget.format),glType=paramThreeToGL(renderTarget.type);if(isCube){renderTarget.__webglFramebuffer=[];renderTarget.__webglRenderbuffer=[];_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,renderTarget.__webglTexture);setTextureParameters(_gl.TEXTURE_CUBE_MAP,renderTarget,isTargetPowerOfTwo);for(var i=0;i<6;i++){renderTarget.__webglFramebuffer[i]=_gl.createFramebuffer();renderTarget.__webglRenderbuffer[i]=_gl.createRenderbuffer();_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,glFormat,renderTarget.width,renderTarget.height,0,glFormat,glType,null);setupFrameBuffer(renderTarget.__webglFramebuffer[i],renderTarget,_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i);setupRenderBuffer(renderTarget.__webglRenderbuffer[i],renderTarget)}if(isTargetPowerOfTwo)_gl.generateMipmap(_gl.TEXTURE_CUBE_MAP)}else{renderTarget.__webglFramebuffer=_gl.createFramebuffer();if(renderTarget.shareDepthFrom){renderTarget.__webglRenderbuffer=renderTarget.shareDepthFrom.__webglRenderbuffer}else{renderTarget.__webglRenderbuffer=_gl.createRenderbuffer()}_gl.bindTexture(_gl.TEXTURE_2D,renderTarget.__webglTexture);setTextureParameters(_gl.TEXTURE_2D,renderTarget,isTargetPowerOfTwo);_gl.texImage2D(_gl.TEXTURE_2D,0,glFormat,renderTarget.width,renderTarget.height,0,glFormat,glType,null);setupFrameBuffer(renderTarget.__webglFramebuffer,renderTarget,_gl.TEXTURE_2D);if(renderTarget.shareDepthFrom){if(renderTarget.depthBuffer&&!renderTarget.stencilBuffer){_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,renderTarget.__webglRenderbuffer)}else if(renderTarget.depthBuffer&&renderTarget.stencilBuffer){_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_STENCIL_ATTACHMENT,_gl.RENDERBUFFER,renderTarget.__webglRenderbuffer)}}else{setupRenderBuffer(renderTarget.__webglRenderbuffer,renderTarget)}if(isTargetPowerOfTwo)_gl.generateMipmap(_gl.TEXTURE_2D)}if(isCube){_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,null)}else{_gl.bindTexture(_gl.TEXTURE_2D,null)}_gl.bindRenderbuffer(_gl.RENDERBUFFER,null);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)}var framebuffer,width,height,vx,vy;if(renderTarget){if(isCube){framebuffer=renderTarget.__webglFramebuffer[renderTarget.activeCubeFace]}else{framebuffer=renderTarget.__webglFramebuffer}width=renderTarget.width;height=renderTarget.height;vx=0;vy=0}else{framebuffer=null;width=_viewportWidth;height=_viewportHeight;vx=_viewportX;vy=_viewportY}if(framebuffer!==_currentFramebuffer){_gl.bindFramebuffer(_gl.FRAMEBUFFER,framebuffer);_gl.viewport(vx,vy,width,height);_currentFramebuffer=framebuffer}_currentWidth=width;_currentHeight=height};function updateRenderTargetMipmap(renderTarget){if(renderTarget instanceof THREE.WebGLRenderTargetCube){_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,renderTarget.__webglTexture);_gl.generateMipmap(_gl.TEXTURE_CUBE_MAP);_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,null)}else{_gl.bindTexture(_gl.TEXTURE_2D,renderTarget.__webglTexture);_gl.generateMipmap(_gl.TEXTURE_2D);_gl.bindTexture(_gl.TEXTURE_2D,null)}}function filterFallback(f){if(f===THREE.NearestFilter||f===THREE.NearestMipMapNearestFilter||f===THREE.NearestMipMapLinearFilter){return _gl.NEAREST}return _gl.LINEAR}function paramThreeToGL(p){if(p===THREE.RepeatWrapping)return _gl.REPEAT;if(p===THREE.ClampToEdgeWrapping)return _gl.CLAMP_TO_EDGE;if(p===THREE.MirroredRepeatWrapping)return _gl.MIRRORED_REPEAT;if(p===THREE.NearestFilter)return _gl.NEAREST;if(p===THREE.NearestMipMapNearestFilter)return _gl.NEAREST_MIPMAP_NEAREST;if(p===THREE.NearestMipMapLinearFilter)return _gl.NEAREST_MIPMAP_LINEAR;if(p===THREE.LinearFilter)return _gl.LINEAR;if(p===THREE.LinearMipMapNearestFilter)return _gl.LINEAR_MIPMAP_NEAREST;if(p===THREE.LinearMipMapLinearFilter)return _gl.LINEAR_MIPMAP_LINEAR;if(p===THREE.UnsignedByteType)return _gl.UNSIGNED_BYTE;if(p===THREE.UnsignedShort4444Type)return _gl.UNSIGNED_SHORT_4_4_4_4;if(p===THREE.UnsignedShort5551Type)return _gl.UNSIGNED_SHORT_5_5_5_1;if(p===THREE.UnsignedShort565Type)return _gl.UNSIGNED_SHORT_5_6_5;if(p===THREE.ByteType)return _gl.BYTE;if(p===THREE.ShortType)return _gl.SHORT;if(p===THREE.UnsignedShortType)return _gl.UNSIGNED_SHORT;if(p===THREE.IntType)return _gl.INT;if(p===THREE.UnsignedIntType)return _gl.UNSIGNED_INT;if(p===THREE.FloatType)return _gl.FLOAT;if(p===THREE.AlphaFormat)return _gl.ALPHA;if(p===THREE.RGBFormat)return _gl.RGB;if(p===THREE.RGBAFormat)return _gl.RGBA;if(p===THREE.LuminanceFormat)return _gl.LUMINANCE;if(p===THREE.LuminanceAlphaFormat)return _gl.LUMINANCE_ALPHA;if(p===THREE.AddEquation)return _gl.FUNC_ADD;if(p===THREE.SubtractEquation)return _gl.FUNC_SUBTRACT;if(p===THREE.ReverseSubtractEquation)return _gl.FUNC_REVERSE_SUBTRACT;if(p===THREE.ZeroFactor)return _gl.ZERO;if(p===THREE.OneFactor)return _gl.ONE;if(p===THREE.SrcColorFactor)return _gl.SRC_COLOR;if(p===THREE.OneMinusSrcColorFactor)return _gl.ONE_MINUS_SRC_COLOR;if(p===THREE.SrcAlphaFactor)return _gl.SRC_ALPHA;if(p===THREE.OneMinusSrcAlphaFactor)return _gl.ONE_MINUS_SRC_ALPHA;if(p===THREE.DstAlphaFactor)return _gl.DST_ALPHA;if(p===THREE.OneMinusDstAlphaFactor)return _gl.ONE_MINUS_DST_ALPHA;if(p===THREE.DstColorFactor)return _gl.DST_COLOR;if(p===THREE.OneMinusDstColorFactor)return _gl.ONE_MINUS_DST_COLOR;if(p===THREE.SrcAlphaSaturateFactor)return _gl.SRC_ALPHA_SATURATE;if(_glExtensionCompressedTextureS3TC!==undefined){if(p===THREE.RGB_S3TC_DXT1_Format)return _glExtensionCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;if(p===THREE.RGBA_S3TC_DXT1_Format)return _glExtensionCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(p===THREE.RGBA_S3TC_DXT3_Format)return _glExtensionCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(p===THREE.RGBA_S3TC_DXT5_Format)return _glExtensionCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT}return 0}function allocateBones(object){if(_supportsBoneTextures&&object&&object.useVertexTexture){return 1024}else{var nVertexUniforms=_gl.getParameter(_gl.MAX_VERTEX_UNIFORM_VECTORS);var nVertexMatrices=Math.floor((nVertexUniforms-20)/4);var maxBones=nVertexMatrices;if(object!==undefined&&object instanceof THREE.SkinnedMesh){maxBones=Math.min(object.bones.length,maxBones);if(maxBones<object.bones.length){console.warn("WebGLRenderer: too many bones - "+object.bones.length+", this GPU supports just "+maxBones+" (try OpenGL instead of ANGLE)")}}return maxBones}}function allocateLights(lights){var l,ll,light,dirLights,pointLights,spotLights,hemiLights;dirLights=pointLights=spotLights=hemiLights=0;for(l=0,ll=lights.length;l<ll;l++){light=lights[l];if(light.onlyShadow)continue;if(light instanceof THREE.DirectionalLight)dirLights++;if(light instanceof THREE.PointLight)pointLights++;if(light instanceof THREE.SpotLight)spotLights++;if(light instanceof THREE.HemisphereLight)hemiLights++}return{directional:dirLights,point:pointLights,spot:spotLights,hemi:hemiLights}}function allocateShadows(lights){var l,ll,light,maxShadows=0;for(l=0,ll=lights.length;l<ll;l++){light=lights[l];if(!light.castShadow)continue;if(light instanceof THREE.SpotLight)maxShadows++;if(light instanceof THREE.DirectionalLight&&!light.shadowCascade)maxShadows++}return maxShadows}function initGL(){try{var attributes={alpha:_alpha,premultipliedAlpha:_premultipliedAlpha,antialias:_antialias,stencil:_stencil,preserveDrawingBuffer:_preserveDrawingBuffer};_gl=_canvas.getContext("webgl",attributes)||_canvas.getContext("experimental-webgl",attributes);if(_gl===null){throw"Error creating WebGL context."}}catch(error){console.error(error)}_glExtensionTextureFloat=_gl.getExtension("OES_texture_float");_glExtensionStandardDerivatives=_gl.getExtension("OES_standard_derivatives");_glExtensionTextureFilterAnisotropic=_gl.getExtension("EXT_texture_filter_anisotropic")||_gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||_gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");_glExtensionCompressedTextureS3TC=_gl.getExtension("WEBGL_compressed_texture_s3tc")||_gl.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||_gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");if(!_glExtensionTextureFloat){console.log("THREE.WebGLRenderer: Float textures not supported.")}if(!_glExtensionStandardDerivatives){console.log("THREE.WebGLRenderer: Standard derivatives not supported.")}if(!_glExtensionTextureFilterAnisotropic){console.log("THREE.WebGLRenderer: Anisotropic texture filtering not supported.")}if(!_glExtensionCompressedTextureS3TC){console.log("THREE.WebGLRenderer: S3TC compressed textures not supported.")}if(_gl.getShaderPrecisionFormat===undefined){_gl.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}}}function setDefaultGLState(){_gl.clearColor(0,0,0,1);_gl.clearDepth(1);_gl.clearStencil(0);_gl.enable(_gl.DEPTH_TEST);_gl.depthFunc(_gl.LEQUAL);_gl.frontFace(_gl.CCW);_gl.cullFace(_gl.BACK);_gl.enable(_gl.CULL_FACE);_gl.enable(_gl.BLEND);_gl.blendEquation(_gl.FUNC_ADD);_gl.blendFunc(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA);_gl.clearColor(_clearColor.r,_clearColor.g,_clearColor.b,_clearAlpha)}this.shadowMapPlugin=new THREE.ShadowMapPlugin;this.addPrePlugin(this.shadowMapPlugin);this.addPostPlugin(new THREE.SpritePlugin);this.addPostPlugin(new THREE.LensFlarePlugin)};THREE.WebGLRenderTarget=function(width,height,options){this.width=width;this.height=height;options=options||{};this.wrapS=options.wrapS!==undefined?options.wrapS:THREE.ClampToEdgeWrapping;this.wrapT=options.wrapT!==undefined?options.wrapT:THREE.ClampToEdgeWrapping;this.magFilter=options.magFilter!==undefined?options.magFilter:THREE.LinearFilter;
this.minFilter=options.minFilter!==undefined?options.minFilter:THREE.LinearMipMapLinearFilter;this.anisotropy=options.anisotropy!==undefined?options.anisotropy:1;this.offset=new THREE.Vector2(0,0);this.repeat=new THREE.Vector2(1,1);this.format=options.format!==undefined?options.format:THREE.RGBAFormat;this.type=options.type!==undefined?options.type:THREE.UnsignedByteType;this.depthBuffer=options.depthBuffer!==undefined?options.depthBuffer:true;this.stencilBuffer=options.stencilBuffer!==undefined?options.stencilBuffer:true;this.generateMipmaps=true;this.shareDepthFrom=null};THREE.WebGLRenderTarget.prototype={constructor:THREE.WebGLRenderTarget,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent,clone:function(){var tmp=new THREE.WebGLRenderTarget(this.width,this.height);tmp.wrapS=this.wrapS;tmp.wrapT=this.wrapT;tmp.magFilter=this.magFilter;tmp.minFilter=this.minFilter;tmp.anisotropy=this.anisotropy;tmp.offset.copy(this.offset);tmp.repeat.copy(this.repeat);tmp.format=this.format;tmp.type=this.type;tmp.depthBuffer=this.depthBuffer;tmp.stencilBuffer=this.stencilBuffer;tmp.generateMipmaps=this.generateMipmaps;tmp.shareDepthFrom=this.shareDepthFrom;return tmp},dispose:function(){this.dispatchEvent({type:"dispose"})}};THREE.WebGLRenderTargetCube=function(width,height,options){THREE.WebGLRenderTarget.call(this,width,height,options);this.activeCubeFace=0};THREE.WebGLRenderTargetCube.prototype=Object.create(THREE.WebGLRenderTarget.prototype);THREE.RenderableVertex=function(){this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=true};THREE.RenderableVertex.prototype.copy=function(vertex){this.positionWorld.copy(vertex.positionWorld);this.positionScreen.copy(vertex.positionScreen)};THREE.RenderableFace3=function(){this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.centroidModel=new THREE.Vector3;this.normalModel=new THREE.Vector3;this.normalModelView=new THREE.Vector3;this.vertexNormalsLength=0;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsModelView=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.color=null;this.material=null;this.uvs=[[]];this.z=null};THREE.RenderableFace4=function(){this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.v4=new THREE.RenderableVertex;this.centroidModel=new THREE.Vector3;this.normalModel=new THREE.Vector3;this.normalModelView=new THREE.Vector3;this.vertexNormalsLength=0;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsModelView=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.color=null;this.material=null;this.uvs=[[]];this.z=null};THREE.RenderableObject=function(){this.object=null;this.z=null};THREE.RenderableParticle=function(){this.object=null;this.x=null;this.y=null;this.z=null;this.rotation=null;this.scale=new THREE.Vector2;this.material=null};THREE.RenderableLine=function(){this.z=null;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null};THREE.GeometryUtils={merge:function(geometry1,object2,materialIndexOffset){var matrix,normalMatrix,vertexOffset=geometry1.vertices.length,uvPosition=geometry1.faceVertexUvs[0].length,geometry2=object2 instanceof THREE.Mesh?object2.geometry:object2,vertices1=geometry1.vertices,vertices2=geometry2.vertices,faces1=geometry1.faces,faces2=geometry2.faces,uvs1=geometry1.faceVertexUvs[0],uvs2=geometry2.faceVertexUvs[0];if(materialIndexOffset===undefined)materialIndexOffset=0;if(object2 instanceof THREE.Mesh){object2.matrixAutoUpdate&&object2.updateMatrix();matrix=object2.matrix;normalMatrix=(new THREE.Matrix3).getNormalMatrix(matrix)}for(var i=0,il=vertices2.length;i<il;i++){var vertex=vertices2[i];var vertexCopy=vertex.clone();if(matrix)vertexCopy.applyMatrix4(matrix);vertices1.push(vertexCopy)}for(i=0,il=faces2.length;i<il;i++){var face=faces2[i],faceCopy,normal,color,faceVertexNormals=face.vertexNormals,faceVertexColors=face.vertexColors;if(face instanceof THREE.Face3){faceCopy=new THREE.Face3(face.a+vertexOffset,face.b+vertexOffset,face.c+vertexOffset)}else if(face instanceof THREE.Face4){faceCopy=new THREE.Face4(face.a+vertexOffset,face.b+vertexOffset,face.c+vertexOffset,face.d+vertexOffset)}faceCopy.normal.copy(face.normal);if(normalMatrix){faceCopy.normal.applyMatrix3(normalMatrix).normalize()}for(var j=0,jl=faceVertexNormals.length;j<jl;j++){normal=faceVertexNormals[j].clone();if(normalMatrix){normal.applyMatrix3(normalMatrix).normalize()}faceCopy.vertexNormals.push(normal)}faceCopy.color.copy(face.color);for(var j=0,jl=faceVertexColors.length;j<jl;j++){color=faceVertexColors[j];faceCopy.vertexColors.push(color.clone())}faceCopy.materialIndex=face.materialIndex+materialIndexOffset;faceCopy.centroid.copy(face.centroid);if(matrix){faceCopy.centroid.applyMatrix4(matrix)}faces1.push(faceCopy)}for(i=0,il=uvs2.length;i<il;i++){var uv=uvs2[i],uvCopy=[];for(var j=0,jl=uv.length;j<jl;j++){uvCopy.push(new THREE.Vector2(uv[j].x,uv[j].y))}uvs1.push(uvCopy)}},removeMaterials:function(geometry,materialIndexArray){var materialIndexMap={};for(var i=0,il=materialIndexArray.length;i<il;i++){materialIndexMap[materialIndexArray[i]]=true}var face,newFaces=[];for(var i=0,il=geometry.faces.length;i<il;i++){face=geometry.faces[i];if(!(face.materialIndex in materialIndexMap))newFaces.push(face)}geometry.faces=newFaces},randomPointInTriangle:function(vectorA,vectorB,vectorC){var a,b,c,point=new THREE.Vector3,tmp=THREE.GeometryUtils.__v1;a=THREE.GeometryUtils.random();b=THREE.GeometryUtils.random();if(a+b>1){a=1-a;b=1-b}c=1-a-b;point.copy(vectorA);point.multiplyScalar(a);tmp.copy(vectorB);tmp.multiplyScalar(b);point.add(tmp);tmp.copy(vectorC);tmp.multiplyScalar(c);point.add(tmp);return point},randomPointInFace:function(face,geometry,useCachedAreas){var vA,vB,vC,vD;if(face instanceof THREE.Face3){vA=geometry.vertices[face.a];vB=geometry.vertices[face.b];vC=geometry.vertices[face.c];return THREE.GeometryUtils.randomPointInTriangle(vA,vB,vC)}else if(face instanceof THREE.Face4){vA=geometry.vertices[face.a];vB=geometry.vertices[face.b];vC=geometry.vertices[face.c];vD=geometry.vertices[face.d];var area1,area2;if(useCachedAreas){if(face._area1&&face._area2){area1=face._area1;area2=face._area2}else{area1=THREE.GeometryUtils.triangleArea(vA,vB,vD);area2=THREE.GeometryUtils.triangleArea(vB,vC,vD);face._area1=area1;face._area2=area2}}else{area1=THREE.GeometryUtils.triangleArea(vA,vB,vD),area2=THREE.GeometryUtils.triangleArea(vB,vC,vD)}var r=THREE.GeometryUtils.random()*(area1+area2);if(r<area1){return THREE.GeometryUtils.randomPointInTriangle(vA,vB,vD)}else{return THREE.GeometryUtils.randomPointInTriangle(vB,vC,vD)}}},randomPointsInGeometry:function(geometry,n){var face,i,faces=geometry.faces,vertices=geometry.vertices,il=faces.length,totalArea=0,cumulativeAreas=[],vA,vB,vC,vD;for(i=0;i<il;i++){face=faces[i];if(face instanceof THREE.Face3){vA=vertices[face.a];vB=vertices[face.b];vC=vertices[face.c];face._area=THREE.GeometryUtils.triangleArea(vA,vB,vC)}else if(face instanceof THREE.Face4){vA=vertices[face.a];vB=vertices[face.b];vC=vertices[face.c];vD=vertices[face.d];face._area1=THREE.GeometryUtils.triangleArea(vA,vB,vD);face._area2=THREE.GeometryUtils.triangleArea(vB,vC,vD);face._area=face._area1+face._area2}totalArea+=face._area;cumulativeAreas[i]=totalArea}function binarySearchIndices(value){function binarySearch(start,end){if(end<start)return start;var mid=start+Math.floor((end-start)/2);if(cumulativeAreas[mid]>value){return binarySearch(start,mid-1)}else if(cumulativeAreas[mid]<value){return binarySearch(mid+1,end)}else{return mid}}var result=binarySearch(0,cumulativeAreas.length-1);return result}var r,index,result=[];var stats={};for(i=0;i<n;i++){r=THREE.GeometryUtils.random()*totalArea;index=binarySearchIndices(r);result[i]=THREE.GeometryUtils.randomPointInFace(faces[index],geometry,true);if(!stats[index]){stats[index]=1}else{stats[index]+=1}}return result},triangleArea:function(vectorA,vectorB,vectorC){var tmp1=THREE.GeometryUtils.__v1,tmp2=THREE.GeometryUtils.__v2;tmp1.subVectors(vectorB,vectorA);tmp2.subVectors(vectorC,vectorA);tmp1.cross(tmp2);return.5*tmp1.length()},center:function(geometry){geometry.computeBoundingBox();var bb=geometry.boundingBox;var offset=new THREE.Vector3;offset.addVectors(bb.min,bb.max);offset.multiplyScalar(-.5);geometry.applyMatrix((new THREE.Matrix4).makeTranslation(offset.x,offset.y,offset.z));geometry.computeBoundingBox();return offset},normalizeUVs:function(geometry){var uvSet=geometry.faceVertexUvs[0];for(var i=0,il=uvSet.length;i<il;i++){var uvs=uvSet[i];for(var j=0,jl=uvs.length;j<jl;j++){if(uvs[j].x!==1)uvs[j].x=uvs[j].x-Math.floor(uvs[j].x);if(uvs[j].y!==1)uvs[j].y=uvs[j].y-Math.floor(uvs[j].y)}}},triangulateQuads:function(geometry){var i,il,j,jl;var faces=[];var faceUvs=[];var faceVertexUvs=[];for(i=0,il=geometry.faceUvs.length;i<il;i++){faceUvs[i]=[]}for(i=0,il=geometry.faceVertexUvs.length;i<il;i++){faceVertexUvs[i]=[]}for(i=0,il=geometry.faces.length;i<il;i++){var face=geometry.faces[i];if(face instanceof THREE.Face4){var a=face.a;var b=face.b;var c=face.c;var d=face.d;var triA=new THREE.Face3;var triB=new THREE.Face3;triA.color.copy(face.color);triB.color.copy(face.color);triA.materialIndex=face.materialIndex;triB.materialIndex=face.materialIndex;triA.a=a;triA.b=b;triA.c=d;triB.a=b;triB.b=c;triB.c=d;if(face.vertexColors.length===4){triA.vertexColors[0]=face.vertexColors[0].clone();triA.vertexColors[1]=face.vertexColors[1].clone();triA.vertexColors[2]=face.vertexColors[3].clone();triB.vertexColors[0]=face.vertexColors[1].clone();triB.vertexColors[1]=face.vertexColors[2].clone();triB.vertexColors[2]=face.vertexColors[3].clone()}faces.push(triA,triB);for(j=0,jl=geometry.faceVertexUvs.length;j<jl;j++){if(geometry.faceVertexUvs[j].length){var uvs=geometry.faceVertexUvs[j][i];var uvA=uvs[0];var uvB=uvs[1];var uvC=uvs[2];var uvD=uvs[3];var uvsTriA=[uvA.clone(),uvB.clone(),uvD.clone()];var uvsTriB=[uvB.clone(),uvC.clone(),uvD.clone()];faceVertexUvs[j].push(uvsTriA,uvsTriB)}}for(j=0,jl=geometry.faceUvs.length;j<jl;j++){if(geometry.faceUvs[j].length){var faceUv=geometry.faceUvs[j][i];faceUvs[j].push(faceUv,faceUv)}}}else{faces.push(face);for(j=0,jl=geometry.faceUvs.length;j<jl;j++){faceUvs[j].push(geometry.faceUvs[j][i])}for(j=0,jl=geometry.faceVertexUvs.length;j<jl;j++){faceVertexUvs[j].push(geometry.faceVertexUvs[j][i])}}}geometry.faces=faces;geometry.faceUvs=faceUvs;geometry.faceVertexUvs=faceVertexUvs;geometry.computeCentroids();geometry.computeFaceNormals();geometry.computeVertexNormals();if(geometry.hasTangents)geometry.computeTangents()},setMaterialIndex:function(geometry,index,startFace,endFace){var faces=geometry.faces;var start=startFace||0;var end=endFace||faces.length-1;for(var i=start;i<=end;i++){faces[i].materialIndex=index}}};THREE.GeometryUtils.random=THREE.Math.random16;THREE.GeometryUtils.__v1=new THREE.Vector3;THREE.GeometryUtils.__v2=new THREE.Vector3;THREE.ImageUtils={crossOrigin:"anonymous",loadTexture:function(url,mapping,onLoad,onError){var image=new Image;var texture=new THREE.Texture(image,mapping);var loader=new THREE.ImageLoader;loader.addEventListener("load",function(event){texture.image=event.content;texture.needsUpdate=true;if(onLoad)onLoad(texture)});loader.addEventListener("error",function(event){if(onError)onError(event.message)});loader.crossOrigin=this.crossOrigin;loader.load(url,image);texture.sourceFile=url;return texture},loadCompressedTexture:function(url,mapping,onLoad,onError){var texture=new THREE.CompressedTexture;texture.mapping=mapping;var request=new XMLHttpRequest;request.onload=function(){var buffer=request.response;var dds=THREE.ImageUtils.parseDDS(buffer,true);texture.format=dds.format;texture.mipmaps=dds.mipmaps;texture.image.width=dds.width;texture.image.height=dds.height;texture.generateMipmaps=false;texture.needsUpdate=true;if(onLoad)onLoad(texture)};request.onerror=onError;request.open("GET",url,true);request.responseType="arraybuffer";request.send(null);return texture},loadTextureCube:function(array,mapping,onLoad,onError){var images=[];images.loadCount=0;var texture=new THREE.Texture;texture.image=images;if(mapping!==undefined)texture.mapping=mapping;texture.flipY=false;for(var i=0,il=array.length;i<il;++i){var cubeImage=new Image;images[i]=cubeImage;cubeImage.onload=function(){images.loadCount+=1;if(images.loadCount===6){texture.needsUpdate=true;if(onLoad)onLoad(texture)}};cubeImage.onerror=onError;cubeImage.crossOrigin=this.crossOrigin;cubeImage.src=array[i]}return texture},loadCompressedTextureCube:function(array,mapping,onLoad,onError){var images=[];images.loadCount=0;var texture=new THREE.CompressedTexture;texture.image=images;if(mapping!==undefined)texture.mapping=mapping;texture.flipY=false;texture.generateMipmaps=false;var generateCubeFaceCallback=function(rq,img){return function(){var buffer=rq.response;var dds=THREE.ImageUtils.parseDDS(buffer,true);img.format=dds.format;img.mipmaps=dds.mipmaps;img.width=dds.width;img.height=dds.height;images.loadCount+=1;if(images.loadCount===6){texture.format=dds.format;texture.needsUpdate=true;if(onLoad)onLoad(texture)}}};if(array instanceof Array){for(var i=0,il=array.length;i<il;++i){var cubeImage={};images[i]=cubeImage;var request=new XMLHttpRequest;request.onload=generateCubeFaceCallback(request,cubeImage);request.onerror=onError;var url=array[i];request.open("GET",url,true);request.responseType="arraybuffer";request.send(null)}}else{var url=array;var request=new XMLHttpRequest;request.onload=function(){var buffer=request.response;var dds=THREE.ImageUtils.parseDDS(buffer,true);if(dds.isCubemap){var faces=dds.mipmaps.length/dds.mipmapCount;for(var f=0;f<faces;f++){images[f]={mipmaps:[]};for(var i=0;i<dds.mipmapCount;i++){images[f].mipmaps.push(dds.mipmaps[f*dds.mipmapCount+i]);images[f].format=dds.format;images[f].width=dds.width;images[f].height=dds.height}}texture.format=dds.format;texture.needsUpdate=true;if(onLoad)onLoad(texture)}};request.onerror=onError;request.open("GET",url,true);request.responseType="arraybuffer";request.send(null)}return texture},parseDDS:function(buffer,loadMipmaps){var dds={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};var DDS_MAGIC=542327876;var DDSD_CAPS=1,DDSD_HEIGHT=2,DDSD_WIDTH=4,DDSD_PITCH=8,DDSD_PIXELFORMAT=4096,DDSD_MIPMAPCOUNT=131072,DDSD_LINEARSIZE=524288,DDSD_DEPTH=8388608;var DDSCAPS_COMPLEX=8,DDSCAPS_MIPMAP=4194304,DDSCAPS_TEXTURE=4096;var DDSCAPS2_CUBEMAP=512,DDSCAPS2_CUBEMAP_POSITIVEX=1024,DDSCAPS2_CUBEMAP_NEGATIVEX=2048,DDSCAPS2_CUBEMAP_POSITIVEY=4096,DDSCAPS2_CUBEMAP_NEGATIVEY=8192,DDSCAPS2_CUBEMAP_POSITIVEZ=16384,DDSCAPS2_CUBEMAP_NEGATIVEZ=32768,DDSCAPS2_VOLUME=2097152;var DDPF_ALPHAPIXELS=1,DDPF_ALPHA=2,DDPF_FOURCC=4,DDPF_RGB=64,DDPF_YUV=512,DDPF_LUMINANCE=131072;function fourCCToInt32(value){return value.charCodeAt(0)+(value.charCodeAt(1)<<8)+(value.charCodeAt(2)<<16)+(value.charCodeAt(3)<<24)}function int32ToFourCC(value){return String.fromCharCode(value&255,value>>8&255,value>>16&255,value>>24&255)}var FOURCC_DXT1=fourCCToInt32("DXT1");var FOURCC_DXT3=fourCCToInt32("DXT3");var FOURCC_DXT5=fourCCToInt32("DXT5");var headerLengthInt=31;var off_magic=0;var off_size=1;var off_flags=2;var off_height=3;var off_width=4;var off_mipmapCount=7;var off_pfFlags=20;var off_pfFourCC=21;var off_caps=27;var off_caps2=28;var off_caps3=29;var off_caps4=30;var header=new Int32Array(buffer,0,headerLengthInt);if(header[off_magic]!==DDS_MAGIC){console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header");return dds}if(!header[off_pfFlags]&DDPF_FOURCC){console.error("ImageUtils.parseDDS(): Unsupported format, must contain a FourCC code");return dds}var blockBytes;var fourCC=header[off_pfFourCC];switch(fourCC){case FOURCC_DXT1:blockBytes=8;dds.format=THREE.RGB_S3TC_DXT1_Format;break;case FOURCC_DXT3:blockBytes=16;dds.format=THREE.RGBA_S3TC_DXT3_Format;break;case FOURCC_DXT5:blockBytes=16;dds.format=THREE.RGBA_S3TC_DXT5_Format;break;default:console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",int32ToFourCC(fourCC));return dds}dds.mipmapCount=1;if(header[off_flags]&DDSD_MIPMAPCOUNT&&loadMipmaps!==false){dds.mipmapCount=Math.max(1,header[off_mipmapCount])}dds.isCubemap=header[off_caps2]&DDSCAPS2_CUBEMAP?true:false;dds.width=header[off_width];dds.height=header[off_height];var dataOffset=header[off_size]+4;var width=dds.width;var height=dds.height;var faces=dds.isCubemap?6:1;for(var face=0;face<faces;face++){for(var i=0;i<dds.mipmapCount;i++){var dataLength=Math.max(4,width)/4*Math.max(4,height)/4*blockBytes;var byteArray=new Uint8Array(buffer,dataOffset,dataLength);var mipmap={data:byteArray,width:width,height:height};dds.mipmaps.push(mipmap);dataOffset+=dataLength;width=Math.max(width*.5,1);height=Math.max(height*.5,1)}width=dds.width;height=dds.height}return dds},getNormalMap:function(image,depth){var cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};var subtract=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]};var normalize=function(a){var l=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return[a[0]/l,a[1]/l,a[2]/l]};depth=depth|1;var width=image.width;var height=image.height;var canvas=document.createElement("canvas");canvas.width=width;canvas.height=height;var context=canvas.getContext("2d");context.drawImage(image,0,0);var data=context.getImageData(0,0,width,height).data;var imageData=context.createImageData(width,height);var output=imageData.data;for(var x=0;x<width;x++){for(var y=0;y<height;y++){var ly=y-1<0?0:y-1;var uy=y+1>height-1?height-1:y+1;var lx=x-1<0?0:x-1;var ux=x+1>width-1?width-1:x+1;var points=[];var origin=[0,0,data[(y*width+x)*4]/255*depth];points.push([-1,0,data[(y*width+lx)*4]/255*depth]);points.push([-1,-1,data[(ly*width+lx)*4]/255*depth]);points.push([0,-1,data[(ly*width+x)*4]/255*depth]);points.push([1,-1,data[(ly*width+ux)*4]/255*depth]);points.push([1,0,data[(y*width+ux)*4]/255*depth]);points.push([1,1,data[(uy*width+ux)*4]/255*depth]);points.push([0,1,data[(uy*width+x)*4]/255*depth]);points.push([-1,1,data[(uy*width+lx)*4]/255*depth]);var normals=[];var num_points=points.length;for(var i=0;i<num_points;i++){var v1=points[i];var v2=points[(i+1)%num_points];v1=subtract(v1,origin);v2=subtract(v2,origin);normals.push(normalize(cross(v1,v2)))}var normal=[0,0,0];for(var i=0;i<normals.length;i++){normal[0]+=normals[i][0];normal[1]+=normals[i][1];normal[2]+=normals[i][2]}normal[0]/=normals.length;normal[1]/=normals.length;normal[2]/=normals.length;var idx=(y*width+x)*4;output[idx]=(normal[0]+1)/2*255|0;output[idx+1]=(normal[1]+1)/2*255|0;output[idx+2]=normal[2]*255|0;output[idx+3]=255}}context.putImageData(imageData,0,0);return canvas},generateDataTexture:function(width,height,color){var size=width*height;var data=new Uint8Array(3*size);var r=Math.floor(color.r*255);var g=Math.floor(color.g*255);var b=Math.floor(color.b*255);for(var i=0;i<size;i++){data[i*3]=r;data[i*3+1]=g;data[i*3+2]=b}var texture=new THREE.DataTexture(data,width,height,THREE.RGBFormat);texture.needsUpdate=true;return texture}};THREE.SceneUtils={createMultiMaterialObject:function(geometry,materials){var group=new THREE.Object3D;for(var i=0,l=materials.length;i<l;i++){group.add(new THREE.Mesh(geometry,materials[i]))}return group},detach:function(child,parent,scene){child.applyMatrix(parent.matrixWorld);parent.remove(child);scene.add(child)},attach:function(child,scene,parent){var matrixWorldInverse=new THREE.Matrix4;matrixWorldInverse.getInverse(parent.matrixWorld);child.applyMatrix(matrixWorldInverse);scene.remove(child);parent.add(child)}};THREE.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(data){var family=data.familyName.toLowerCase();var ThreeFont=this;ThreeFont.faces[family]=ThreeFont.faces[family]||{};ThreeFont.faces[family][data.cssFontWeight]=ThreeFont.faces[family][data.cssFontWeight]||{};ThreeFont.faces[family][data.cssFontWeight][data.cssFontStyle]=data;var face=ThreeFont.faces[family][data.cssFontWeight][data.cssFontStyle]=data;return data},drawText:function(text){var characterPts=[],allPts=[];var i,p,face=this.getFace(),scale=this.size/face.resolution,offset=0,chars=String(text).split(""),length=chars.length;var fontPaths=[];for(i=0;i<length;i++){var path=new THREE.Path;var ret=this.extractGlyphPoints(chars[i],face,scale,offset,path);offset+=ret.offset;fontPaths.push(ret.path)}var width=offset/2;return{paths:fontPaths,offset:width}},extractGlyphPoints:function(c,face,scale,offset,path){var pts=[];var i,i2,divisions,outline,action,length,scaleX,scaleY,x,y,cpx,cpy,cpx0,cpy0,cpx1,cpy1,cpx2,cpy2,laste,glyph=face.glyphs[c]||face.glyphs["?"];if(!glyph)return;if(glyph.o){outline=glyph._cachedOutline||(glyph._cachedOutline=glyph.o.split(" "));length=outline.length;scaleX=scale;scaleY=scale;for(i=0;i<length;){action=outline[i++];switch(action){case"m":x=outline[i++]*scaleX+offset;y=outline[i++]*scaleY;path.moveTo(x,y);break;case"l":x=outline[i++]*scaleX+offset;y=outline[i++]*scaleY;path.lineTo(x,y);break;case"q":cpx=outline[i++]*scaleX+offset;cpy=outline[i++]*scaleY;cpx1=outline[i++]*scaleX+offset;cpy1=outline[i++]*scaleY;path.quadraticCurveTo(cpx1,cpy1,cpx,cpy);laste=pts[pts.length-1];if(laste){cpx0=laste.x;cpy0=laste.y;for(i2=1,divisions=this.divisions;i2<=divisions;i2++){var t=i2/divisions;var tx=THREE.Shape.Utils.b2(t,cpx0,cpx1,cpx);var ty=THREE.Shape.Utils.b2(t,cpy0,cpy1,cpy)}}break;case"b":cpx=outline[i++]*scaleX+offset;cpy=outline[i++]*scaleY;cpx1=outline[i++]*scaleX+offset;cpy1=outline[i++]*-scaleY;cpx2=outline[i++]*scaleX+offset;cpy2=outline[i++]*-scaleY;path.bezierCurveTo(cpx,cpy,cpx1,cpy1,cpx2,cpy2);laste=pts[pts.length-1];if(laste){cpx0=laste.x;cpy0=laste.y;for(i2=1,divisions=this.divisions;i2<=divisions;i2++){var t=i2/divisions;var tx=THREE.Shape.Utils.b3(t,cpx0,cpx1,cpx2,cpx);var ty=THREE.Shape.Utils.b3(t,cpy0,cpy1,cpy2,cpy)}}break}}}return{offset:glyph.ha*scale,path:path}}};THREE.FontUtils.generateShapes=function(text,parameters){parameters=parameters||{};var size=parameters.size!==undefined?parameters.size:100;var curveSegments=parameters.curveSegments!==undefined?parameters.curveSegments:4;var font=parameters.font!==undefined?parameters.font:"helvetiker";var weight=parameters.weight!==undefined?parameters.weight:"normal";var style=parameters.style!==undefined?parameters.style:"normal";THREE.FontUtils.size=size;THREE.FontUtils.divisions=curveSegments;THREE.FontUtils.face=font;THREE.FontUtils.weight=weight;THREE.FontUtils.style=style;var data=THREE.FontUtils.drawText(text);var paths=data.paths;var shapes=[];for(var p=0,pl=paths.length;p<pl;p++){Array.prototype.push.apply(shapes,paths[p].toShapes())}return shapes};(function(namespace){var EPSILON=1e-10;var process=function(contour,indices){var n=contour.length;if(n<3)return null;var result=[],verts=[],vertIndices=[];var u,v,w;if(area(contour)>0){for(v=0;v<n;v++)verts[v]=v}else{for(v=0;v<n;v++)verts[v]=n-1-v}var nv=n;var count=2*nv;for(v=nv-1;nv>2;){if(count--<=0){console.log("Warning, unable to triangulate polygon!");if(indices)return vertIndices;return result}u=v;if(nv<=u)u=0;v=u+1;if(nv<=v)v=0;w=v+1;if(nv<=w)w=0;if(snip(contour,u,v,w,nv,verts)){var a,b,c,s,t;a=verts[u];b=verts[v];c=verts[w];result.push([contour[a],contour[b],contour[c]]);vertIndices.push([verts[u],verts[v],verts[w]]);for(s=v,t=v+1;t<nv;s++,t++){verts[s]=verts[t]}nv--;count=2*nv}}if(indices)return vertIndices;return result};var area=function(contour){var n=contour.length;var a=0;for(var p=n-1,q=0;q<n;p=q++){a+=contour[p].x*contour[q].y-contour[q].x*contour[p].y}return a*.5};var snip=function(contour,u,v,w,n,verts){var p;var ax,ay,bx,by;var cx,cy,px,py;ax=contour[verts[u]].x;ay=contour[verts[u]].y;bx=contour[verts[v]].x;by=contour[verts[v]].y;cx=contour[verts[w]].x;cy=contour[verts[w]].y;if(EPSILON>(bx-ax)*(cy-ay)-(by-ay)*(cx-ax))return false;var aX,aY,bX,bY,cX,cY;var apx,apy,bpx,bpy,cpx,cpy;var cCROSSap,bCROSScp,aCROSSbp;aX=cx-bx;aY=cy-by;bX=ax-cx;bY=ay-cy;cX=bx-ax;cY=by-ay;for(p=0;p<n;p++){if(p===u||p===v||p===w)continue;px=contour[verts[p]].x;py=contour[verts[p]].y;apx=px-ax;apy=py-ay;bpx=px-bx;bpy=py-by;cpx=px-cx;cpy=py-cy;aCROSSbp=aX*bpy-aY*bpx;cCROSSap=cX*apy-cY*apx;bCROSScp=bX*cpy-bY*cpx;if(aCROSSbp>=0&&bCROSScp>=0&&cCROSSap>=0)return false}return true};namespace.Triangulate=process;namespace.Triangulate.area=area;return namespace})(THREE.FontUtils);self._typeface_js={faces:THREE.FontUtils.faces,loadFace:THREE.FontUtils.loadFace};THREE.typeface_js=self._typeface_js;THREE.Curve=function(){};THREE.Curve.prototype.getPoint=function(t){console.log("Warning, getPoint() not implemented!");return null};THREE.Curve.prototype.getPointAt=function(u){var t=this.getUtoTmapping(u);return this.getPoint(t)};THREE.Curve.prototype.getPoints=function(divisions){if(!divisions)divisions=5;var d,pts=[];for(d=0;d<=divisions;d++){pts.push(this.getPoint(d/divisions))}return pts};THREE.Curve.prototype.getSpacedPoints=function(divisions){if(!divisions)divisions=5;var d,pts=[];for(d=0;d<=divisions;d++){pts.push(this.getPointAt(d/divisions))}return pts};THREE.Curve.prototype.getLength=function(){var lengths=this.getLengths();return lengths[lengths.length-1]};THREE.Curve.prototype.getLengths=function(divisions){if(!divisions)divisions=this.__arcLengthDivisions?this.__arcLengthDivisions:200;if(this.cacheArcLengths&&this.cacheArcLengths.length==divisions+1&&!this.needsUpdate){return this.cacheArcLengths}this.needsUpdate=false;var cache=[];var current,last=this.getPoint(0);var p,sum=0;cache.push(0);for(p=1;p<=divisions;p++){current=this.getPoint(p/divisions);sum+=current.distanceTo(last);cache.push(sum);last=current}this.cacheArcLengths=cache;return cache};THREE.Curve.prototype.updateArcLengths=function(){this.needsUpdate=true;this.getLengths()};THREE.Curve.prototype.getUtoTmapping=function(u,distance){var arcLengths=this.getLengths();var i=0,il=arcLengths.length;var targetArcLength;if(distance){targetArcLength=distance}else{targetArcLength=u*arcLengths[il-1]}var low=0,high=il-1,comparison;while(low<=high){i=Math.floor(low+(high-low)/2);comparison=arcLengths[i]-targetArcLength;if(comparison<0){low=i+1;continue}else if(comparison>0){high=i-1;continue}else{high=i;break}}i=high;if(arcLengths[i]==targetArcLength){var t=i/(il-1);return t}var lengthBefore=arcLengths[i];var lengthAfter=arcLengths[i+1];var segmentLength=lengthAfter-lengthBefore;var segmentFraction=(targetArcLength-lengthBefore)/segmentLength;var t=(i+segmentFraction)/(il-1);return t};THREE.Curve.prototype.getTangent=function(t){var delta=1e-4;var t1=t-delta;var t2=t+delta;if(t1<0)t1=0;if(t2>1)t2=1;var pt1=this.getPoint(t1);var pt2=this.getPoint(t2);var vec=pt2.clone().sub(pt1);return vec.normalize()};THREE.Curve.prototype.getTangentAt=function(u){var t=this.getUtoTmapping(u);return this.getTangent(t)};THREE.Curve.Utils={tangentQuadraticBezier:function(t,p0,p1,p2){return 2*(1-t)*(p1-p0)+2*t*(p2-p1)},tangentCubicBezier:function(t,p0,p1,p2,p3){return-3*p0*(1-t)*(1-t)+3*p1*(1-t)*(1-t)-6*t*p1*(1-t)+6*t*p2*(1-t)-3*t*t*p2+3*t*t*p3},tangentSpline:function(t,p0,p1,p2,p3){var h00=6*t*t-6*t;var h10=3*t*t-4*t+1;var h01=-6*t*t+6*t;var h11=3*t*t-2*t;return h00+h10+h01+h11},interpolate:function(p0,p1,p2,p3,t){var v0=(p2-p0)*.5;var v1=(p3-p1)*.5;var t2=t*t;var t3=t*t2;return(2*p1-2*p2+v0+v1)*t3+(-3*p1+3*p2-2*v0-v1)*t2+v0*t+p1}};THREE.Curve.create=function(constructor,getPointFunc){constructor.prototype=Object.create(THREE.Curve.prototype);constructor.prototype.getPoint=getPointFunc;return constructor};THREE.CurvePath=function(){this.curves=[];this.bends=[];this.autoClose=false};THREE.CurvePath.prototype=Object.create(THREE.Curve.prototype);THREE.CurvePath.prototype.add=function(curve){this.curves.push(curve)};THREE.CurvePath.prototype.checkConnection=function(){};THREE.CurvePath.prototype.closePath=function(){var startPoint=this.curves[0].getPoint(0);var endPoint=this.curves[this.curves.length-1].getPoint(1);if(!startPoint.equals(endPoint)){this.curves.push(new THREE.LineCurve(endPoint,startPoint))}};THREE.CurvePath.prototype.getPoint=function(t){var d=t*this.getLength();var curveLengths=this.getCurveLengths();var i=0,diff,curve;while(i<curveLengths.length){if(curveLengths[i]>=d){diff=curveLengths[i]-d;curve=this.curves[i];var u=1-diff/curve.getLength();return curve.getPointAt(u);break}i++}return null};THREE.CurvePath.prototype.getLength=function(){var lens=this.getCurveLengths();return lens[lens.length-1]};THREE.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length){return this.cacheLengths}var lengths=[],sums=0;var i,il=this.curves.length;for(i=0;i<il;i++){sums+=this.curves[i].getLength();lengths.push(sums)}this.cacheLengths=lengths;return lengths};THREE.CurvePath.prototype.getBoundingBox=function(){var points=this.getPoints();var maxX,maxY,maxZ;var minX,minY,minZ;maxX=maxY=Number.NEGATIVE_INFINITY;minX=minY=Number.POSITIVE_INFINITY;var p,i,il,sum;var v3=points[0]instanceof THREE.Vector3;sum=v3?new THREE.Vector3:new THREE.Vector2;for(i=0,il=points.length;i<il;i++){p=points[i];if(p.x>maxX)maxX=p.x;else if(p.x<minX)minX=p.x;if(p.y>maxY)maxY=p.y;else if(p.y<minY)minY=p.y;if(v3){if(p.z>maxZ)maxZ=p.z;else if(p.z<minZ)minZ=p.z}sum.add(p)}var ret={minX:minX,minY:minY,maxX:maxX,maxY:maxY,centroid:sum.divideScalar(il)};if(v3){ret.maxZ=maxZ;ret.minZ=minZ}return ret};THREE.CurvePath.prototype.createPointsGeometry=function(divisions){var pts=this.getPoints(divisions,true);return this.createGeometry(pts)};THREE.CurvePath.prototype.createSpacedPointsGeometry=function(divisions){var pts=this.getSpacedPoints(divisions,true);return this.createGeometry(pts)};THREE.CurvePath.prototype.createGeometry=function(points){var geometry=new THREE.Geometry;for(var i=0;i<points.length;i++){geometry.vertices.push(new THREE.Vector3(points[i].x,points[i].y,points[i].z||0))}return geometry};THREE.CurvePath.prototype.addWrapPath=function(bendpath){this.bends.push(bendpath)};THREE.CurvePath.prototype.getTransformedPoints=function(segments,bends){var oldPts=this.getPoints(segments);var i,il;if(!bends){bends=this.bends}for(i=0,il=bends.length;i<il;i++){oldPts=this.getWrapPoints(oldPts,bends[i])}return oldPts};THREE.CurvePath.prototype.getTransformedSpacedPoints=function(segments,bends){var oldPts=this.getSpacedPoints(segments);var i,il;if(!bends){bends=this.bends}for(i=0,il=bends.length;i<il;i++){oldPts=this.getWrapPoints(oldPts,bends[i])}return oldPts};THREE.CurvePath.prototype.getWrapPoints=function(oldPts,path){var bounds=this.getBoundingBox();var i,il,p,oldX,oldY,xNorm;for(i=0,il=oldPts.length;i<il;i++){p=oldPts[i];oldX=p.x;oldY=p.y;xNorm=oldX/bounds.maxX;xNorm=path.getUtoTmapping(xNorm,oldX);var pathPt=path.getPoint(xNorm);var normal=path.getNormalVector(xNorm).multiplyScalar(oldY);p.x=pathPt.x+normal.x;p.y=pathPt.y+normal.y}return oldPts};THREE.Gyroscope=function(){THREE.Object3D.call(this)};THREE.Gyroscope.prototype=Object.create(THREE.Object3D.prototype);THREE.Gyroscope.prototype.updateMatrixWorld=function(force){this.matrixAutoUpdate&&this.updateMatrix();if(this.matrixWorldNeedsUpdate||force){if(this.parent){this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix);this.matrixWorld.decompose(this.translationWorld,this.rotationWorld,this.scaleWorld);this.matrix.decompose(this.translationObject,this.rotationObject,this.scaleObject);this.matrixWorld.makeFromPositionQuaternionScale(this.translationWorld,this.rotationObject,this.scaleWorld)}else{this.matrixWorld.copy(this.matrix)}this.matrixWorldNeedsUpdate=false;
force=true}for(var i=0,l=this.children.length;i<l;i++){this.children[i].updateMatrixWorld(force)}};THREE.Gyroscope.prototype.translationWorld=new THREE.Vector3;THREE.Gyroscope.prototype.translationObject=new THREE.Vector3;THREE.Gyroscope.prototype.rotationWorld=new THREE.Quaternion;THREE.Gyroscope.prototype.rotationObject=new THREE.Quaternion;THREE.Gyroscope.prototype.scaleWorld=new THREE.Vector3;THREE.Gyroscope.prototype.scaleObject=new THREE.Vector3;THREE.Path=function(points){THREE.CurvePath.call(this);this.actions=[];if(points){this.fromPoints(points)}};THREE.Path.prototype=Object.create(THREE.CurvePath.prototype);THREE.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"};THREE.Path.prototype.fromPoints=function(vectors){this.moveTo(vectors[0].x,vectors[0].y);for(var v=1,vlen=vectors.length;v<vlen;v++){this.lineTo(vectors[v].x,vectors[v].y)}};THREE.Path.prototype.moveTo=function(x,y){var args=Array.prototype.slice.call(arguments);this.actions.push({action:THREE.PathActions.MOVE_TO,args:args})};THREE.Path.prototype.lineTo=function(x,y){var args=Array.prototype.slice.call(arguments);var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];var curve=new THREE.LineCurve(new THREE.Vector2(x0,y0),new THREE.Vector2(x,y));this.curves.push(curve);this.actions.push({action:THREE.PathActions.LINE_TO,args:args})};THREE.Path.prototype.quadraticCurveTo=function(aCPx,aCPy,aX,aY){var args=Array.prototype.slice.call(arguments);var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];var curve=new THREE.QuadraticBezierCurve(new THREE.Vector2(x0,y0),new THREE.Vector2(aCPx,aCPy),new THREE.Vector2(aX,aY));this.curves.push(curve);this.actions.push({action:THREE.PathActions.QUADRATIC_CURVE_TO,args:args})};THREE.Path.prototype.bezierCurveTo=function(aCP1x,aCP1y,aCP2x,aCP2y,aX,aY){var args=Array.prototype.slice.call(arguments);var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];var curve=new THREE.CubicBezierCurve(new THREE.Vector2(x0,y0),new THREE.Vector2(aCP1x,aCP1y),new THREE.Vector2(aCP2x,aCP2y),new THREE.Vector2(aX,aY));this.curves.push(curve);this.actions.push({action:THREE.PathActions.BEZIER_CURVE_TO,args:args})};THREE.Path.prototype.splineThru=function(pts){var args=Array.prototype.slice.call(arguments);var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];var npts=[new THREE.Vector2(x0,y0)];Array.prototype.push.apply(npts,pts);var curve=new THREE.SplineCurve(npts);this.curves.push(curve);this.actions.push({action:THREE.PathActions.CSPLINE_THRU,args:args})};THREE.Path.prototype.arc=function(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];this.absarc(aX+x0,aY+y0,aRadius,aStartAngle,aEndAngle,aClockwise)};THREE.Path.prototype.absarc=function(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){this.absellipse(aX,aY,aRadius,aRadius,aStartAngle,aEndAngle,aClockwise)};THREE.Path.prototype.ellipse=function(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise){var lastargs=this.actions[this.actions.length-1].args;var x0=lastargs[lastargs.length-2];var y0=lastargs[lastargs.length-1];this.absellipse(aX+x0,aY+y0,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise)};THREE.Path.prototype.absellipse=function(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise){var args=Array.prototype.slice.call(arguments);var curve=new THREE.EllipseCurve(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise);this.curves.push(curve);var lastPoint=curve.getPoint(aClockwise?1:0);args.push(lastPoint.x);args.push(lastPoint.y);this.actions.push({action:THREE.PathActions.ELLIPSE,args:args})};THREE.Path.prototype.getSpacedPoints=function(divisions,closedPath){if(!divisions)divisions=40;var points=[];for(var i=0;i<divisions;i++){points.push(this.getPoint(i/divisions))}return points};THREE.Path.prototype.getPoints=function(divisions,closedPath){if(this.useSpacedPoints){console.log("tata");return this.getSpacedPoints(divisions,closedPath)}divisions=divisions||12;var points=[];var i,il,item,action,args;var cpx,cpy,cpx2,cpy2,cpx1,cpy1,cpx0,cpy0,laste,j,t,tx,ty;for(i=0,il=this.actions.length;i<il;i++){item=this.actions[i];action=item.action;args=item.args;switch(action){case THREE.PathActions.MOVE_TO:points.push(new THREE.Vector2(args[0],args[1]));break;case THREE.PathActions.LINE_TO:points.push(new THREE.Vector2(args[0],args[1]));break;case THREE.PathActions.QUADRATIC_CURVE_TO:cpx=args[2];cpy=args[3];cpx1=args[0];cpy1=args[1];if(points.length>0){laste=points[points.length-1];cpx0=laste.x;cpy0=laste.y}else{laste=this.actions[i-1].args;cpx0=laste[laste.length-2];cpy0=laste[laste.length-1]}for(j=1;j<=divisions;j++){t=j/divisions;tx=THREE.Shape.Utils.b2(t,cpx0,cpx1,cpx);ty=THREE.Shape.Utils.b2(t,cpy0,cpy1,cpy);points.push(new THREE.Vector2(tx,ty))}break;case THREE.PathActions.BEZIER_CURVE_TO:cpx=args[4];cpy=args[5];cpx1=args[0];cpy1=args[1];cpx2=args[2];cpy2=args[3];if(points.length>0){laste=points[points.length-1];cpx0=laste.x;cpy0=laste.y}else{laste=this.actions[i-1].args;cpx0=laste[laste.length-2];cpy0=laste[laste.length-1]}for(j=1;j<=divisions;j++){t=j/divisions;tx=THREE.Shape.Utils.b3(t,cpx0,cpx1,cpx2,cpx);ty=THREE.Shape.Utils.b3(t,cpy0,cpy1,cpy2,cpy);points.push(new THREE.Vector2(tx,ty))}break;case THREE.PathActions.CSPLINE_THRU:laste=this.actions[i-1].args;var last=new THREE.Vector2(laste[laste.length-2],laste[laste.length-1]);var spts=[last];var n=divisions*args[0].length;spts=spts.concat(args[0]);var spline=new THREE.SplineCurve(spts);for(j=1;j<=n;j++){points.push(spline.getPointAt(j/n))}break;case THREE.PathActions.ARC:var aX=args[0],aY=args[1],aRadius=args[2],aStartAngle=args[3],aEndAngle=args[4],aClockwise=!!args[5];var deltaAngle=aEndAngle-aStartAngle;var angle;var tdivisions=divisions*2;for(j=1;j<=tdivisions;j++){t=j/tdivisions;if(!aClockwise){t=1-t}angle=aStartAngle+t*deltaAngle;tx=aX+aRadius*Math.cos(angle);ty=aY+aRadius*Math.sin(angle);points.push(new THREE.Vector2(tx,ty))}break;case THREE.PathActions.ELLIPSE:var aX=args[0],aY=args[1],xRadius=args[2],yRadius=args[3],aStartAngle=args[4],aEndAngle=args[5],aClockwise=!!args[6];var deltaAngle=aEndAngle-aStartAngle;var angle;var tdivisions=divisions*2;for(j=1;j<=tdivisions;j++){t=j/tdivisions;if(!aClockwise){t=1-t}angle=aStartAngle+t*deltaAngle;tx=aX+xRadius*Math.cos(angle);ty=aY+yRadius*Math.sin(angle);points.push(new THREE.Vector2(tx,ty))}break}}var lastPoint=points[points.length-1];var EPSILON=1e-10;if(Math.abs(lastPoint.x-points[0].x)<EPSILON&&Math.abs(lastPoint.y-points[0].y)<EPSILON)points.splice(points.length-1,1);if(closedPath){points.push(points[0])}return points};THREE.Path.prototype.toShapes=function(){var i,il,item,action,args;var subPaths=[],lastPath=new THREE.Path;for(i=0,il=this.actions.length;i<il;i++){item=this.actions[i];args=item.args;action=item.action;if(action==THREE.PathActions.MOVE_TO){if(lastPath.actions.length!=0){subPaths.push(lastPath);lastPath=new THREE.Path}}lastPath[action].apply(lastPath,args)}if(lastPath.actions.length!=0){subPaths.push(lastPath)}if(subPaths.length==0)return[];var tmpPath,tmpShape,shapes=[];var holesFirst=!THREE.Shape.Utils.isClockWise(subPaths[0].getPoints());if(subPaths.length==1){tmpPath=subPaths[0];tmpShape=new THREE.Shape;tmpShape.actions=tmpPath.actions;tmpShape.curves=tmpPath.curves;shapes.push(tmpShape);return shapes}if(holesFirst){tmpShape=new THREE.Shape;for(i=0,il=subPaths.length;i<il;i++){tmpPath=subPaths[i];if(THREE.Shape.Utils.isClockWise(tmpPath.getPoints())){tmpShape.actions=tmpPath.actions;tmpShape.curves=tmpPath.curves;shapes.push(tmpShape);tmpShape=new THREE.Shape}else{tmpShape.holes.push(tmpPath)}}}else{for(i=0,il=subPaths.length;i<il;i++){tmpPath=subPaths[i];if(THREE.Shape.Utils.isClockWise(tmpPath.getPoints())){if(tmpShape)shapes.push(tmpShape);tmpShape=new THREE.Shape;tmpShape.actions=tmpPath.actions;tmpShape.curves=tmpPath.curves}else{tmpShape.holes.push(tmpPath)}}shapes.push(tmpShape)}return shapes};THREE.Shape=function(){THREE.Path.apply(this,arguments);this.holes=[]};THREE.Shape.prototype=Object.create(THREE.Path.prototype);THREE.Shape.prototype.extrude=function(options){var extruded=new THREE.ExtrudeGeometry(this,options);return extruded};THREE.Shape.prototype.makeGeometry=function(options){var geometry=new THREE.ShapeGeometry(this,options);return geometry};THREE.Shape.prototype.getPointsHoles=function(divisions){var i,il=this.holes.length,holesPts=[];for(i=0;i<il;i++){holesPts[i]=this.holes[i].getTransformedPoints(divisions,this.bends)}return holesPts};THREE.Shape.prototype.getSpacedPointsHoles=function(divisions){var i,il=this.holes.length,holesPts=[];for(i=0;i<il;i++){holesPts[i]=this.holes[i].getTransformedSpacedPoints(divisions,this.bends)}return holesPts};THREE.Shape.prototype.extractAllPoints=function(divisions){return{shape:this.getTransformedPoints(divisions),holes:this.getPointsHoles(divisions)}};THREE.Shape.prototype.extractPoints=function(divisions){if(this.useSpacedPoints){return this.extractAllSpacedPoints(divisions)}return this.extractAllPoints(divisions)};THREE.Shape.prototype.extractAllSpacedPoints=function(divisions){return{shape:this.getTransformedSpacedPoints(divisions),holes:this.getSpacedPointsHoles(divisions)}};THREE.Shape.Utils={removeHoles:function(contour,holes){var shape=contour.concat();var allpoints=shape.concat();var prevShapeVert,nextShapeVert,prevHoleVert,nextHoleVert,holeIndex,shapeIndex,shapeId,shapeGroup,h,h2,hole,shortest,d,p,pts1,pts2,tmpShape1,tmpShape2,tmpHole1,tmpHole2,verts=[];for(h=0;h<holes.length;h++){hole=holes[h];Array.prototype.push.apply(allpoints,hole);shortest=Number.POSITIVE_INFINITY;for(h2=0;h2<hole.length;h2++){pts1=hole[h2];var dist=[];for(p=0;p<shape.length;p++){pts2=shape[p];d=pts1.distanceToSquared(pts2);dist.push(d);if(d<shortest){shortest=d;holeIndex=h2;shapeIndex=p}}}prevShapeVert=shapeIndex-1>=0?shapeIndex-1:shape.length-1;prevHoleVert=holeIndex-1>=0?holeIndex-1:hole.length-1;var areaapts=[hole[holeIndex],shape[shapeIndex],shape[prevShapeVert]];var areaa=THREE.FontUtils.Triangulate.area(areaapts);var areabpts=[hole[holeIndex],hole[prevHoleVert],shape[shapeIndex]];var areab=THREE.FontUtils.Triangulate.area(areabpts);var shapeOffset=1;var holeOffset=-1;var oldShapeIndex=shapeIndex,oldHoleIndex=holeIndex;shapeIndex+=shapeOffset;holeIndex+=holeOffset;if(shapeIndex<0){shapeIndex+=shape.length}shapeIndex%=shape.length;if(holeIndex<0){holeIndex+=hole.length}holeIndex%=hole.length;prevShapeVert=shapeIndex-1>=0?shapeIndex-1:shape.length-1;prevHoleVert=holeIndex-1>=0?holeIndex-1:hole.length-1;areaapts=[hole[holeIndex],shape[shapeIndex],shape[prevShapeVert]];var areaa2=THREE.FontUtils.Triangulate.area(areaapts);areabpts=[hole[holeIndex],hole[prevHoleVert],shape[shapeIndex]];var areab2=THREE.FontUtils.Triangulate.area(areabpts);if(areaa+areab>areaa2+areab2){shapeIndex=oldShapeIndex;holeIndex=oldHoleIndex;if(shapeIndex<0){shapeIndex+=shape.length}shapeIndex%=shape.length;if(holeIndex<0){holeIndex+=hole.length}holeIndex%=hole.length;prevShapeVert=shapeIndex-1>=0?shapeIndex-1:shape.length-1;prevHoleVert=holeIndex-1>=0?holeIndex-1:hole.length-1}else{}tmpShape1=shape.slice(0,shapeIndex);tmpShape2=shape.slice(shapeIndex);tmpHole1=hole.slice(holeIndex);tmpHole2=hole.slice(0,holeIndex);var trianglea=[hole[holeIndex],shape[shapeIndex],shape[prevShapeVert]];var triangleb=[hole[holeIndex],hole[prevHoleVert],shape[shapeIndex]];verts.push(trianglea);verts.push(triangleb);shape=tmpShape1.concat(tmpHole1).concat(tmpHole2).concat(tmpShape2)}return{shape:shape,isolatedPts:verts,allpoints:allpoints}},triangulateShape:function(contour,holes){var shapeWithoutHoles=THREE.Shape.Utils.removeHoles(contour,holes);var shape=shapeWithoutHoles.shape,allpoints=shapeWithoutHoles.allpoints,isolatedPts=shapeWithoutHoles.isolatedPts;var triangles=THREE.FontUtils.Triangulate(shape,false);var i,il,f,face,key,index,allPointsMap={},isolatedPointsMap={};for(i=0,il=allpoints.length;i<il;i++){key=allpoints[i].x+":"+allpoints[i].y;if(allPointsMap[key]!==undefined){console.log("Duplicate point",key)}allPointsMap[key]=i}for(i=0,il=triangles.length;i<il;i++){face=triangles[i];for(f=0;f<3;f++){key=face[f].x+":"+face[f].y;index=allPointsMap[key];if(index!==undefined){face[f]=index}}}for(i=0,il=isolatedPts.length;i<il;i++){face=isolatedPts[i];for(f=0;f<3;f++){key=face[f].x+":"+face[f].y;index=allPointsMap[key];if(index!==undefined){face[f]=index}}}return triangles.concat(isolatedPts)},isClockWise:function(pts){return THREE.FontUtils.Triangulate.area(pts)<0},b2p0:function(t,p){var k=1-t;return k*k*p},b2p1:function(t,p){return 2*(1-t)*t*p},b2p2:function(t,p){return t*t*p},b2:function(t,p0,p1,p2){return this.b2p0(t,p0)+this.b2p1(t,p1)+this.b2p2(t,p2)},b3p0:function(t,p){var k=1-t;return k*k*k*p},b3p1:function(t,p){var k=1-t;return 3*k*k*t*p},b3p2:function(t,p){var k=1-t;return 3*k*t*t*p},b3p3:function(t,p){return t*t*t*p},b3:function(t,p0,p1,p2,p3){return this.b3p0(t,p0)+this.b3p1(t,p1)+this.b3p2(t,p2)+this.b3p3(t,p3)}};THREE.LineCurve=function(v1,v2){this.v1=v1;this.v2=v2};THREE.LineCurve.prototype=Object.create(THREE.Curve.prototype);THREE.LineCurve.prototype.getPoint=function(t){var point=this.v2.clone().sub(this.v1);point.multiplyScalar(t).add(this.v1);return point};THREE.LineCurve.prototype.getPointAt=function(u){return this.getPoint(u)};THREE.LineCurve.prototype.getTangent=function(t){var tangent=this.v2.clone().sub(this.v1);return tangent.normalize()};THREE.QuadraticBezierCurve=function(v0,v1,v2){this.v0=v0;this.v1=v1;this.v2=v2};THREE.QuadraticBezierCurve.prototype=Object.create(THREE.Curve.prototype);THREE.QuadraticBezierCurve.prototype.getPoint=function(t){var tx,ty;tx=THREE.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x);ty=THREE.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y);return new THREE.Vector2(tx,ty)};THREE.QuadraticBezierCurve.prototype.getTangent=function(t){var tx,ty;tx=THREE.Curve.Utils.tangentQuadraticBezier(t,this.v0.x,this.v1.x,this.v2.x);ty=THREE.Curve.Utils.tangentQuadraticBezier(t,this.v0.y,this.v1.y,this.v2.y);var tangent=new THREE.Vector2(tx,ty);tangent.normalize();return tangent};THREE.CubicBezierCurve=function(v0,v1,v2,v3){this.v0=v0;this.v1=v1;this.v2=v2;this.v3=v3};THREE.CubicBezierCurve.prototype=Object.create(THREE.Curve.prototype);THREE.CubicBezierCurve.prototype.getPoint=function(t){var tx,ty;tx=THREE.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x);ty=THREE.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y);return new THREE.Vector2(tx,ty)};THREE.CubicBezierCurve.prototype.getTangent=function(t){var tx,ty;tx=THREE.Curve.Utils.tangentCubicBezier(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x);ty=THREE.Curve.Utils.tangentCubicBezier(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y);var tangent=new THREE.Vector2(tx,ty);tangent.normalize();return tangent};THREE.SplineCurve=function(points){this.points=points==undefined?[]:points};THREE.SplineCurve.prototype=Object.create(THREE.Curve.prototype);THREE.SplineCurve.prototype.getPoint=function(t){var v=new THREE.Vector2;var c=[];var points=this.points,point,intPoint,weight;point=(points.length-1)*t;intPoint=Math.floor(point);weight=point-intPoint;c[0]=intPoint==0?intPoint:intPoint-1;c[1]=intPoint;c[2]=intPoint>points.length-2?points.length-1:intPoint+1;c[3]=intPoint>points.length-3?points.length-1:intPoint+2;v.x=THREE.Curve.Utils.interpolate(points[c[0]].x,points[c[1]].x,points[c[2]].x,points[c[3]].x,weight);v.y=THREE.Curve.Utils.interpolate(points[c[0]].y,points[c[1]].y,points[c[2]].y,points[c[3]].y,weight);return v};THREE.EllipseCurve=function(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise){this.aX=aX;this.aY=aY;this.xRadius=xRadius;this.yRadius=yRadius;this.aStartAngle=aStartAngle;this.aEndAngle=aEndAngle;this.aClockwise=aClockwise};THREE.EllipseCurve.prototype=Object.create(THREE.Curve.prototype);THREE.EllipseCurve.prototype.getPoint=function(t){var deltaAngle=this.aEndAngle-this.aStartAngle;if(!this.aClockwise){t=1-t}var angle=this.aStartAngle+t*deltaAngle;var tx=this.aX+this.xRadius*Math.cos(angle);var ty=this.aY+this.yRadius*Math.sin(angle);return new THREE.Vector2(tx,ty)};THREE.ArcCurve=function(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){THREE.EllipseCurve.call(this,aX,aY,aRadius,aRadius,aStartAngle,aEndAngle,aClockwise)};THREE.ArcCurve.prototype=Object.create(THREE.EllipseCurve.prototype);THREE.LineCurve3=THREE.Curve.create(function(v1,v2){this.v1=v1;this.v2=v2},function(t){var r=new THREE.Vector3;r.subVectors(this.v2,this.v1);r.multiplyScalar(t);r.add(this.v1);return r});THREE.QuadraticBezierCurve3=THREE.Curve.create(function(v0,v1,v2){this.v0=v0;this.v1=v1;this.v2=v2},function(t){var tx,ty,tz;tx=THREE.Shape.Utils.b2(t,this.v0.x,this.v1.x,this.v2.x);ty=THREE.Shape.Utils.b2(t,this.v0.y,this.v1.y,this.v2.y);tz=THREE.Shape.Utils.b2(t,this.v0.z,this.v1.z,this.v2.z);return new THREE.Vector3(tx,ty,tz)});THREE.CubicBezierCurve3=THREE.Curve.create(function(v0,v1,v2,v3){this.v0=v0;this.v1=v1;this.v2=v2;this.v3=v3},function(t){var tx,ty,tz;tx=THREE.Shape.Utils.b3(t,this.v0.x,this.v1.x,this.v2.x,this.v3.x);ty=THREE.Shape.Utils.b3(t,this.v0.y,this.v1.y,this.v2.y,this.v3.y);tz=THREE.Shape.Utils.b3(t,this.v0.z,this.v1.z,this.v2.z,this.v3.z);return new THREE.Vector3(tx,ty,tz)});THREE.SplineCurve3=THREE.Curve.create(function(points){this.points=points==undefined?[]:points},function(t){var v=new THREE.Vector3;var c=[];var points=this.points,point,intPoint,weight;point=(points.length-1)*t;intPoint=Math.floor(point);weight=point-intPoint;c[0]=intPoint==0?intPoint:intPoint-1;c[1]=intPoint;c[2]=intPoint>points.length-2?points.length-1:intPoint+1;c[3]=intPoint>points.length-3?points.length-1:intPoint+2;var pt0=points[c[0]],pt1=points[c[1]],pt2=points[c[2]],pt3=points[c[3]];v.x=THREE.Curve.Utils.interpolate(pt0.x,pt1.x,pt2.x,pt3.x,weight);v.y=THREE.Curve.Utils.interpolate(pt0.y,pt1.y,pt2.y,pt3.y,weight);v.z=THREE.Curve.Utils.interpolate(pt0.z,pt1.z,pt2.z,pt3.z,weight);return v});THREE.ClosedSplineCurve3=THREE.Curve.create(function(points){this.points=points==undefined?[]:points},function(t){var v=new THREE.Vector3;var c=[];var points=this.points,point,intPoint,weight;point=(points.length-0)*t;intPoint=Math.floor(point);weight=point-intPoint;intPoint+=intPoint>0?0:(Math.floor(Math.abs(intPoint)/points.length)+1)*points.length;c[0]=(intPoint-1)%points.length;c[1]=intPoint%points.length;c[2]=(intPoint+1)%points.length;c[3]=(intPoint+2)%points.length;v.x=THREE.Curve.Utils.interpolate(points[c[0]].x,points[c[1]].x,points[c[2]].x,points[c[3]].x,weight);v.y=THREE.Curve.Utils.interpolate(points[c[0]].y,points[c[1]].y,points[c[2]].y,points[c[3]].y,weight);v.z=THREE.Curve.Utils.interpolate(points[c[0]].z,points[c[1]].z,points[c[2]].z,points[c[3]].z,weight);return v});THREE.AnimationHandler=function(){var playing=[];var library={};var that={};that.update=function(deltaTimeMS){for(var i=0;i<playing.length;i++)playing[i].update(deltaTimeMS)};that.addToUpdate=function(animation){if(playing.indexOf(animation)===-1)playing.push(animation)};that.removeFromUpdate=function(animation){var index=playing.indexOf(animation);if(index!==-1)playing.splice(index,1)};that.add=function(data){if(library[data.name]!==undefined)console.log("THREE.AnimationHandler.add: Warning! "+data.name+" already exists in library. Overwriting.");library[data.name]=data;initData(data)};that.get=function(name){if(typeof name==="string"){if(library[name]){return library[name]}else{console.log("THREE.AnimationHandler.get: Couldn't find animation "+name);return null}}else{}};that.parse=function(root){var hierarchy=[];if(root instanceof THREE.SkinnedMesh){for(var b=0;b<root.bones.length;b++){hierarchy.push(root.bones[b])}}else{parseRecurseHierarchy(root,hierarchy)}return hierarchy};var parseRecurseHierarchy=function(root,hierarchy){hierarchy.push(root);for(var c=0;c<root.children.length;c++)parseRecurseHierarchy(root.children[c],hierarchy)};var initData=function(data){if(data.initialized===true)return;for(var h=0;h<data.hierarchy.length;h++){for(var k=0;k<data.hierarchy[h].keys.length;k++){if(data.hierarchy[h].keys[k].time<0)data.hierarchy[h].keys[k].time=0;if(data.hierarchy[h].keys[k].rot!==undefined&&!(data.hierarchy[h].keys[k].rot instanceof THREE.Quaternion)){var quat=data.hierarchy[h].keys[k].rot;data.hierarchy[h].keys[k].rot=new THREE.Quaternion(quat[0],quat[1],quat[2],quat[3])}}if(data.hierarchy[h].keys.length&&data.hierarchy[h].keys[0].morphTargets!==undefined){var usedMorphTargets={};for(var k=0;k<data.hierarchy[h].keys.length;k++){for(var m=0;m<data.hierarchy[h].keys[k].morphTargets.length;m++){var morphTargetName=data.hierarchy[h].keys[k].morphTargets[m];usedMorphTargets[morphTargetName]=-1}}data.hierarchy[h].usedMorphTargets=usedMorphTargets;for(var k=0;k<data.hierarchy[h].keys.length;k++){var influences={};for(var morphTargetName in usedMorphTargets){for(var m=0;m<data.hierarchy[h].keys[k].morphTargets.length;m++){if(data.hierarchy[h].keys[k].morphTargets[m]===morphTargetName){influences[morphTargetName]=data.hierarchy[h].keys[k].morphTargetsInfluences[m];break}}if(m===data.hierarchy[h].keys[k].morphTargets.length){influences[morphTargetName]=0}}data.hierarchy[h].keys[k].morphTargetsInfluences=influences}}for(var k=1;k<data.hierarchy[h].keys.length;k++){if(data.hierarchy[h].keys[k].time===data.hierarchy[h].keys[k-1].time){data.hierarchy[h].keys.splice(k,1);k--}}for(var k=0;k<data.hierarchy[h].keys.length;k++){data.hierarchy[h].keys[k].index=k}}var lengthInFrames=parseInt(data.length*data.fps,10);data.JIT={};data.JIT.hierarchy=[];for(var h=0;h<data.hierarchy.length;h++)data.JIT.hierarchy.push(new Array(lengthInFrames));data.initialized=true};that.LINEAR=0;that.CATMULLROM=1;that.CATMULLROM_FORWARD=2;return that}();THREE.Animation=function(root,name,interpolationType){this.root=root;this.data=THREE.AnimationHandler.get(name);this.hierarchy=THREE.AnimationHandler.parse(root);this.currentTime=0;this.timeScale=1;this.isPlaying=false;this.isPaused=true;this.loop=true;this.interpolationType=interpolationType!==undefined?interpolationType:THREE.AnimationHandler.LINEAR;this.points=[];this.target=new THREE.Vector3};THREE.Animation.prototype.play=function(loop,startTimeMS){if(this.isPlaying===false){this.isPlaying=true;this.loop=loop!==undefined?loop:true;this.currentTime=startTimeMS!==undefined?startTimeMS:0;var h,hl=this.hierarchy.length,object;for(h=0;h<hl;h++){object=this.hierarchy[h];if(this.interpolationType!==THREE.AnimationHandler.CATMULLROM_FORWARD){object.useQuaternion=true}object.matrixAutoUpdate=true;if(object.animationCache===undefined){object.animationCache={};object.animationCache.prevKey={pos:0,rot:0,scl:0};object.animationCache.nextKey={pos:0,rot:0,scl:0};object.animationCache.originalMatrix=object instanceof THREE.Bone?object.skinMatrix:object.matrix}var prevKey=object.animationCache.prevKey;var nextKey=object.animationCache.nextKey;prevKey.pos=this.data.hierarchy[h].keys[0];prevKey.rot=this.data.hierarchy[h].keys[0];prevKey.scl=this.data.hierarchy[h].keys[0];nextKey.pos=this.getNextKeyWith("pos",h,1);nextKey.rot=this.getNextKeyWith("rot",h,1);nextKey.scl=this.getNextKeyWith("scl",h,1)}this.update(0)}this.isPaused=false;THREE.AnimationHandler.addToUpdate(this)};THREE.Animation.prototype.pause=function(){if(this.isPaused===true){THREE.AnimationHandler.addToUpdate(this)}else{THREE.AnimationHandler.removeFromUpdate(this)}this.isPaused=!this.isPaused};THREE.Animation.prototype.stop=function(){this.isPlaying=false;this.isPaused=false;THREE.AnimationHandler.removeFromUpdate(this)};THREE.Animation.prototype.update=function(deltaTimeMS){if(this.isPlaying===false)return;var types=["pos","rot","scl"];var type;var scale;var vector;var prevXYZ,nextXYZ;var prevKey,nextKey;var object;var animationCache;var frame;var JIThierarchy=this.data.JIT.hierarchy;var currentTime,unloopedCurrentTime;var currentPoint,forwardPoint,angle;this.currentTime+=deltaTimeMS*this.timeScale;unloopedCurrentTime=this.currentTime;currentTime=this.currentTime=this.currentTime%this.data.length;frame=parseInt(Math.min(currentTime*this.data.fps,this.data.length*this.data.fps),10);for(var h=0,hl=this.hierarchy.length;h<hl;h++){object=this.hierarchy[h];animationCache=object.animationCache;for(var t=0;t<3;t++){type=types[t];prevKey=animationCache.prevKey[type];nextKey=animationCache.nextKey[type];if(nextKey.time<=unloopedCurrentTime){if(currentTime<unloopedCurrentTime){if(this.loop){prevKey=this.data.hierarchy[h].keys[0];nextKey=this.getNextKeyWith(type,h,1);while(nextKey.time<currentTime){prevKey=nextKey;nextKey=this.getNextKeyWith(type,h,nextKey.index+1)}}else{this.stop();return}}else{do{prevKey=nextKey;nextKey=this.getNextKeyWith(type,h,nextKey.index+1)}while(nextKey.time<currentTime)}animationCache.prevKey[type]=prevKey;animationCache.nextKey[type]=nextKey}object.matrixAutoUpdate=true;object.matrixWorldNeedsUpdate=true;scale=(currentTime-prevKey.time)/(nextKey.time-prevKey.time);prevXYZ=prevKey[type];nextXYZ=nextKey[type];if(scale<0||scale>1){console.log("THREE.Animation.update: Warning! Scale out of bounds:"+scale+" on bone "+h);scale=scale<0?0:1}if(type==="pos"){vector=object.position;if(this.interpolationType===THREE.AnimationHandler.LINEAR){vector.x=prevXYZ[0]+(nextXYZ[0]-prevXYZ[0])*scale;vector.y=prevXYZ[1]+(nextXYZ[1]-prevXYZ[1])*scale;vector.z=prevXYZ[2]+(nextXYZ[2]-prevXYZ[2])*scale}else if(this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD){this.points[0]=this.getPrevKeyWith("pos",h,prevKey.index-1)["pos"];this.points[1]=prevXYZ;this.points[2]=nextXYZ;this.points[3]=this.getNextKeyWith("pos",h,nextKey.index+1)["pos"];scale=scale*.33+.33;currentPoint=this.interpolateCatmullRom(this.points,scale);vector.x=currentPoint[0];vector.y=currentPoint[1];vector.z=currentPoint[2];if(this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD){forwardPoint=this.interpolateCatmullRom(this.points,scale*1.01);this.target.set(forwardPoint[0],forwardPoint[1],forwardPoint[2]);this.target.sub(vector);this.target.y=0;this.target.normalize();angle=Math.atan2(this.target.x,this.target.z);object.rotation.set(0,angle,0)}}}else if(type==="rot"){THREE.Quaternion.slerp(prevXYZ,nextXYZ,object.quaternion,scale)}else if(type==="scl"){vector=object.scale;vector.x=prevXYZ[0]+(nextXYZ[0]-prevXYZ[0])*scale;vector.y=prevXYZ[1]+(nextXYZ[1]-prevXYZ[1])*scale;vector.z=prevXYZ[2]+(nextXYZ[2]-prevXYZ[2])*scale}}}};THREE.Animation.prototype.interpolateCatmullRom=function(points,scale){var c=[],v3=[],point,intPoint,weight,w2,w3,pa,pb,pc,pd;point=(points.length-1)*scale;intPoint=Math.floor(point);weight=point-intPoint;c[0]=intPoint===0?intPoint:intPoint-1;c[1]=intPoint;c[2]=intPoint>points.length-2?intPoint:intPoint+1;c[3]=intPoint>points.length-3?intPoint:intPoint+2;pa=points[c[0]];pb=points[c[1]];pc=points[c[2]];pd=points[c[3]];w2=weight*weight;w3=weight*w2;v3[0]=this.interpolate(pa[0],pb[0],pc[0],pd[0],weight,w2,w3);v3[1]=this.interpolate(pa[1],pb[1],pc[1],pd[1],weight,w2,w3);v3[2]=this.interpolate(pa[2],pb[2],pc[2],pd[2],weight,w2,w3);return v3};THREE.Animation.prototype.interpolate=function(p0,p1,p2,p3,t,t2,t3){var v0=(p2-p0)*.5,v1=(p3-p1)*.5;return(2*(p1-p2)+v0+v1)*t3+(-3*(p1-p2)-2*v0-v1)*t2+v0*t+p1};THREE.Animation.prototype.getNextKeyWith=function(type,h,key){var keys=this.data.hierarchy[h].keys;if(this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD){key=key<keys.length-1?key:keys.length-1}else{key=key%keys.length}for(;key<keys.length;key++){if(keys[key][type]!==undefined){return keys[key]}}return this.data.hierarchy[h].keys[0]};THREE.Animation.prototype.getPrevKeyWith=function(type,h,key){var keys=this.data.hierarchy[h].keys;if(this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD){key=key>0?key:0}else{key=key>=0?key:key+keys.length}for(;key>=0;key--){if(keys[key][type]!==undefined){return keys[key]}}return this.data.hierarchy[h].keys[keys.length-1]};THREE.KeyFrameAnimation=function(root,data,JITCompile){this.root=root;this.data=THREE.AnimationHandler.get(data);this.hierarchy=THREE.AnimationHandler.parse(root);this.currentTime=0;this.timeScale=.001;this.isPlaying=false;this.isPaused=true;this.loop=true;this.JITCompile=JITCompile!==undefined?JITCompile:true;for(var h=0,hl=this.hierarchy.length;h<hl;h++){var keys=this.data.hierarchy[h].keys,sids=this.data.hierarchy[h].sids,obj=this.hierarchy[h];if(keys.length&&sids){for(var s=0;s<sids.length;s++){var sid=sids[s],next=this.getNextKeyWith(sid,h,0);if(next){next.apply(sid)}}obj.matrixAutoUpdate=false;this.data.hierarchy[h].node.updateMatrix();obj.matrixWorldNeedsUpdate=true}}};THREE.KeyFrameAnimation.prototype.play=function(loop,startTimeMS){if(!this.isPlaying){this.isPlaying=true;this.loop=loop!==undefined?loop:true;this.currentTime=startTimeMS!==undefined?startTimeMS:0;this.startTimeMs=startTimeMS;this.startTime=1e7;this.endTime=-this.startTime;var h,hl=this.hierarchy.length,object,node;for(h=0;h<hl;h++){object=this.hierarchy[h];node=this.data.hierarchy[h];object.useQuaternion=true;if(node.animationCache===undefined){node.animationCache={};node.animationCache.prevKey=null;node.animationCache.nextKey=null;node.animationCache.originalMatrix=object instanceof THREE.Bone?object.skinMatrix:object.matrix}var keys=this.data.hierarchy[h].keys;if(keys.length){node.animationCache.prevKey=keys[0];node.animationCache.nextKey=keys[1];this.startTime=Math.min(keys[0].time,this.startTime);this.endTime=Math.max(keys[keys.length-1].time,this.endTime)}}this.update(0)}this.isPaused=false;THREE.AnimationHandler.addToUpdate(this)};THREE.KeyFrameAnimation.prototype.pause=function(){if(this.isPaused){THREE.AnimationHandler.addToUpdate(this)}else{THREE.AnimationHandler.removeFromUpdate(this)}this.isPaused=!this.isPaused};THREE.KeyFrameAnimation.prototype.stop=function(){this.isPlaying=false;this.isPaused=false;THREE.AnimationHandler.removeFromUpdate(this);for(var h=0;h<this.data.hierarchy.length;h++){var obj=this.hierarchy[h];var node=this.data.hierarchy[h];if(node.animationCache!==undefined){var original=node.animationCache.originalMatrix;if(obj instanceof THREE.Bone){original.copy(obj.skinMatrix);obj.skinMatrix=original}else{original.copy(obj.matrix);obj.matrix=original}delete node.animationCache}}};THREE.KeyFrameAnimation.prototype.update=function(deltaTimeMS){if(!this.isPlaying)return;var prevKey,nextKey;var object;var node;var frame;var JIThierarchy=this.data.JIT.hierarchy;var currentTime,unloopedCurrentTime;var looped;this.currentTime+=deltaTimeMS*this.timeScale;unloopedCurrentTime=this.currentTime;currentTime=this.currentTime=this.currentTime%this.data.length;if(currentTime<this.startTimeMs){currentTime=this.currentTime=this.startTimeMs+currentTime}frame=parseInt(Math.min(currentTime*this.data.fps,this.data.length*this.data.fps),10);looped=currentTime<unloopedCurrentTime;if(looped&&!this.loop){for(var h=0,hl=this.hierarchy.length;h<hl;h++){var keys=this.data.hierarchy[h].keys,sids=this.data.hierarchy[h].sids,end=keys.length-1,obj=this.hierarchy[h];if(keys.length){for(var s=0;s<sids.length;s++){var sid=sids[s],prev=this.getPrevKeyWith(sid,h,end);if(prev){prev.apply(sid)}}this.data.hierarchy[h].node.updateMatrix();obj.matrixWorldNeedsUpdate=true}}this.stop();return}if(currentTime<this.startTime){return}for(var h=0,hl=this.hierarchy.length;h<hl;h++){object=this.hierarchy[h];node=this.data.hierarchy[h];var keys=node.keys,animationCache=node.animationCache;if(this.JITCompile&&JIThierarchy[h][frame]!==undefined){if(object instanceof THREE.Bone){object.skinMatrix=JIThierarchy[h][frame];
object.matrixWorldNeedsUpdate=false}else{object.matrix=JIThierarchy[h][frame];object.matrixWorldNeedsUpdate=true}}else if(keys.length){if(this.JITCompile&&animationCache){if(object instanceof THREE.Bone){object.skinMatrix=animationCache.originalMatrix}else{object.matrix=animationCache.originalMatrix}}prevKey=animationCache.prevKey;nextKey=animationCache.nextKey;if(prevKey&&nextKey){if(nextKey.time<=unloopedCurrentTime){if(looped&&this.loop){prevKey=keys[0];nextKey=keys[1];while(nextKey.time<currentTime){prevKey=nextKey;nextKey=keys[prevKey.index+1]}}else if(!looped){var lastIndex=keys.length-1;while(nextKey.time<currentTime&&nextKey.index!==lastIndex){prevKey=nextKey;nextKey=keys[prevKey.index+1]}}animationCache.prevKey=prevKey;animationCache.nextKey=nextKey}if(nextKey.time>=currentTime)prevKey.interpolate(nextKey,currentTime);else prevKey.interpolate(nextKey,nextKey.time)}this.data.hierarchy[h].node.updateMatrix();object.matrixWorldNeedsUpdate=true}}if(this.JITCompile){if(JIThierarchy[0][frame]===undefined){this.hierarchy[0].updateMatrixWorld(true);for(var h=0;h<this.hierarchy.length;h++){if(this.hierarchy[h]instanceof THREE.Bone){JIThierarchy[h][frame]=this.hierarchy[h].skinMatrix.clone()}else{JIThierarchy[h][frame]=this.hierarchy[h].matrix.clone()}}}}};THREE.KeyFrameAnimation.prototype.getNextKeyWith=function(sid,h,key){var keys=this.data.hierarchy[h].keys;key=key%keys.length;for(;key<keys.length;key++){if(keys[key].hasTarget(sid)){return keys[key]}}return keys[0]};THREE.KeyFrameAnimation.prototype.getPrevKeyWith=function(sid,h,key){var keys=this.data.hierarchy[h].keys;key=key>=0?key:key+keys.length;for(;key>=0;key--){if(keys[key].hasTarget(sid)){return keys[key]}}return keys[keys.length-1]};THREE.CubeCamera=function(near,far,cubeResolution){THREE.Object3D.call(this);var fov=90,aspect=1;var cameraPX=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraPX.up.set(0,-1,0);cameraPX.lookAt(new THREE.Vector3(1,0,0));this.add(cameraPX);var cameraNX=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraNX.up.set(0,-1,0);cameraNX.lookAt(new THREE.Vector3(-1,0,0));this.add(cameraNX);var cameraPY=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraPY.up.set(0,0,1);cameraPY.lookAt(new THREE.Vector3(0,1,0));this.add(cameraPY);var cameraNY=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraNY.up.set(0,0,-1);cameraNY.lookAt(new THREE.Vector3(0,-1,0));this.add(cameraNY);var cameraPZ=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraPZ.up.set(0,-1,0);cameraPZ.lookAt(new THREE.Vector3(0,0,1));this.add(cameraPZ);var cameraNZ=new THREE.PerspectiveCamera(fov,aspect,near,far);cameraNZ.up.set(0,-1,0);cameraNZ.lookAt(new THREE.Vector3(0,0,-1));this.add(cameraNZ);this.renderTarget=new THREE.WebGLRenderTargetCube(cubeResolution,cubeResolution,{format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter});this.updateCubeMap=function(renderer,scene){var renderTarget=this.renderTarget;var generateMipmaps=renderTarget.generateMipmaps;renderTarget.generateMipmaps=false;renderTarget.activeCubeFace=0;renderer.render(scene,cameraPX,renderTarget);renderTarget.activeCubeFace=1;renderer.render(scene,cameraNX,renderTarget);renderTarget.activeCubeFace=2;renderer.render(scene,cameraPY,renderTarget);renderTarget.activeCubeFace=3;renderer.render(scene,cameraNY,renderTarget);renderTarget.activeCubeFace=4;renderer.render(scene,cameraPZ,renderTarget);renderTarget.generateMipmaps=generateMipmaps;renderTarget.activeCubeFace=5;renderer.render(scene,cameraNZ,renderTarget)}};THREE.CubeCamera.prototype=Object.create(THREE.Object3D.prototype);THREE.CombinedCamera=function(width,height,fov,near,far,orthoNear,orthoFar){THREE.Camera.call(this);this.fov=fov;this.left=-width/2;this.right=width/2;this.top=height/2;this.bottom=-height/2;this.cameraO=new THREE.OrthographicCamera(width/-2,width/2,height/2,height/-2,orthoNear,orthoFar);this.cameraP=new THREE.PerspectiveCamera(fov,width/height,near,far);this.zoom=1;this.toPerspective();var aspect=width/height};THREE.CombinedCamera.prototype=Object.create(THREE.Camera.prototype);THREE.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraP.near;this.far=this.cameraP.far;this.cameraP.fov=this.fov/this.zoom;this.cameraP.updateProjectionMatrix();this.projectionMatrix=this.cameraP.projectionMatrix;this.inPerspectiveMode=true;this.inOrthographicMode=false};THREE.CombinedCamera.prototype.toOrthographic=function(){var fov=this.fov;var aspect=this.cameraP.aspect;var near=this.cameraP.near;var far=this.cameraP.far;var hyperfocus=(near+far)/2;var halfHeight=Math.tan(fov/2)*hyperfocus;var planeHeight=2*halfHeight;var planeWidth=planeHeight*aspect;var halfWidth=planeWidth/2;halfHeight/=this.zoom;halfWidth/=this.zoom;this.cameraO.left=-halfWidth;this.cameraO.right=halfWidth;this.cameraO.top=halfHeight;this.cameraO.bottom=-halfHeight;this.cameraO.updateProjectionMatrix();this.near=this.cameraO.near;this.far=this.cameraO.far;this.projectionMatrix=this.cameraO.projectionMatrix;this.inPerspectiveMode=false;this.inOrthographicMode=true};THREE.CombinedCamera.prototype.setSize=function(width,height){this.cameraP.aspect=width/height;this.left=-width/2;this.right=width/2;this.top=height/2;this.bottom=-height/2};THREE.CombinedCamera.prototype.setFov=function(fov){this.fov=fov;if(this.inPerspectiveMode){this.toPerspective()}else{this.toOrthographic()}};THREE.CombinedCamera.prototype.updateProjectionMatrix=function(){if(this.inPerspectiveMode){this.toPerspective()}else{this.toPerspective();this.toOrthographic()}};THREE.CombinedCamera.prototype.setLens=function(focalLength,frameHeight){if(frameHeight===undefined)frameHeight=24;var fov=2*THREE.Math.radToDeg(Math.atan(frameHeight/(focalLength*2)));this.setFov(fov);return fov};THREE.CombinedCamera.prototype.setZoom=function(zoom){this.zoom=zoom;if(this.inPerspectiveMode){this.toPerspective()}else{this.toOrthographic()}};THREE.CombinedCamera.prototype.toFrontView=function(){this.rotation.x=0;this.rotation.y=0;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CombinedCamera.prototype.toBackView=function(){this.rotation.x=0;this.rotation.y=Math.PI;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CombinedCamera.prototype.toLeftView=function(){this.rotation.x=0;this.rotation.y=-Math.PI/2;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CombinedCamera.prototype.toRightView=function(){this.rotation.x=0;this.rotation.y=Math.PI/2;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CombinedCamera.prototype.toTopView=function(){this.rotation.x=-Math.PI/2;this.rotation.y=0;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CombinedCamera.prototype.toBottomView=function(){this.rotation.x=Math.PI/2;this.rotation.y=0;this.rotation.z=0;this.rotationAutoUpdate=false};THREE.CircleGeometry=function(radius,segments,thetaStart,thetaLength){THREE.Geometry.call(this);radius=radius||50;thetaStart=thetaStart!==undefined?thetaStart:0;thetaLength=thetaLength!==undefined?thetaLength:Math.PI*2;segments=segments!==undefined?Math.max(3,segments):8;var i,uvs=[],center=new THREE.Vector3,centerUV=new THREE.Vector2(.5,.5);this.vertices.push(center);uvs.push(centerUV);for(i=0;i<=segments;i++){var vertex=new THREE.Vector3;var segment=thetaStart+i/segments*thetaLength;vertex.x=radius*Math.cos(segment);vertex.y=radius*Math.sin(segment);this.vertices.push(vertex);uvs.push(new THREE.Vector2((vertex.x/radius+1)/2,(vertex.y/radius+1)/2))}var n=new THREE.Vector3(0,0,1);for(i=1;i<=segments;i++){var v1=i;var v2=i+1;var v3=0;this.faces.push(new THREE.Face3(v1,v2,v3,[n,n,n]));this.faceVertexUvs[0].push([uvs[i],uvs[i+1],centerUV])}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,radius)};THREE.CircleGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.CubeGeometry=function(width,height,depth,widthSegments,heightSegments,depthSegments){THREE.Geometry.call(this);var scope=this;this.width=width;this.height=height;this.depth=depth;this.widthSegments=widthSegments||1;this.heightSegments=heightSegments||1;this.depthSegments=depthSegments||1;var width_half=this.width/2;var height_half=this.height/2;var depth_half=this.depth/2;buildPlane("z","y",-1,-1,this.depth,this.height,width_half,0);buildPlane("z","y",1,-1,this.depth,this.height,-width_half,1);buildPlane("x","z",1,1,this.width,this.depth,height_half,2);buildPlane("x","z",1,-1,this.width,this.depth,-height_half,3);buildPlane("x","y",1,-1,this.width,this.height,depth_half,4);buildPlane("x","y",-1,-1,this.width,this.height,-depth_half,5);function buildPlane(u,v,udir,vdir,width,height,depth,materialIndex){var w,ix,iy,gridX=scope.widthSegments,gridY=scope.heightSegments,width_half=width/2,height_half=height/2,offset=scope.vertices.length;if(u==="x"&&v==="y"||u==="y"&&v==="x"){w="z"}else if(u==="x"&&v==="z"||u==="z"&&v==="x"){w="y";gridY=scope.depthSegments}else if(u==="z"&&v==="y"||u==="y"&&v==="z"){w="x";gridX=scope.depthSegments}var gridX1=gridX+1,gridY1=gridY+1,segment_width=width/gridX,segment_height=height/gridY,normal=new THREE.Vector3;normal[w]=depth>0?1:-1;for(iy=0;iy<gridY1;iy++){for(ix=0;ix<gridX1;ix++){var vector=new THREE.Vector3;vector[u]=(ix*segment_width-width_half)*udir;vector[v]=(iy*segment_height-height_half)*vdir;vector[w]=depth;scope.vertices.push(vector)}}for(iy=0;iy<gridY;iy++){for(ix=0;ix<gridX;ix++){var a=ix+gridX1*iy;var b=ix+gridX1*(iy+1);var c=ix+1+gridX1*(iy+1);var d=ix+1+gridX1*iy;var face=new THREE.Face4(a+offset,b+offset,c+offset,d+offset);face.normal.copy(normal);face.vertexNormals.push(normal.clone(),normal.clone(),normal.clone(),normal.clone());face.materialIndex=materialIndex;scope.faces.push(face);scope.faceVertexUvs[0].push([new THREE.Vector2(ix/gridX,1-iy/gridY),new THREE.Vector2(ix/gridX,1-(iy+1)/gridY),new THREE.Vector2((ix+1)/gridX,1-(iy+1)/gridY),new THREE.Vector2((ix+1)/gridX,1-iy/gridY)])}}}this.computeCentroids();this.mergeVertices()};THREE.CubeGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.CylinderGeometry=function(radiusTop,radiusBottom,height,radiusSegments,heightSegments,openEnded){THREE.Geometry.call(this);this.radiusTop=radiusTop=radiusTop!==undefined?radiusTop:20;this.radiusBottom=radiusBottom=radiusBottom!==undefined?radiusBottom:20;this.height=height=height!==undefined?height:100;this.radiusSegments=radiusSegments=radiusSegments||8;this.heightSegments=heightSegments=heightSegments||1;this.openEnded=openEnded=openEnded!==undefined?openEnded:false;var heightHalf=height/2;var x,y,vertices=[],uvs=[];for(y=0;y<=heightSegments;y++){var verticesRow=[];var uvsRow=[];var v=y/heightSegments;var radius=v*(radiusBottom-radiusTop)+radiusTop;for(x=0;x<=radiusSegments;x++){var u=x/radiusSegments;var vertex=new THREE.Vector3;vertex.x=radius*Math.sin(u*Math.PI*2);vertex.y=-v*height+heightHalf;vertex.z=radius*Math.cos(u*Math.PI*2);this.vertices.push(vertex);verticesRow.push(this.vertices.length-1);uvsRow.push(new THREE.Vector2(u,1-v))}vertices.push(verticesRow);uvs.push(uvsRow)}var tanTheta=(radiusBottom-radiusTop)/height;var na,nb;for(x=0;x<radiusSegments;x++){if(radiusTop!==0){na=this.vertices[vertices[0][x]].clone();nb=this.vertices[vertices[0][x+1]].clone()}else{na=this.vertices[vertices[1][x]].clone();nb=this.vertices[vertices[1][x+1]].clone()}na.setY(Math.sqrt(na.x*na.x+na.z*na.z)*tanTheta).normalize();nb.setY(Math.sqrt(nb.x*nb.x+nb.z*nb.z)*tanTheta).normalize();for(y=0;y<heightSegments;y++){var v1=vertices[y][x];var v2=vertices[y+1][x];var v3=vertices[y+1][x+1];var v4=vertices[y][x+1];var n1=na.clone();var n2=na.clone();var n3=nb.clone();var n4=nb.clone();var uv1=uvs[y][x].clone();var uv2=uvs[y+1][x].clone();var uv3=uvs[y+1][x+1].clone();var uv4=uvs[y][x+1].clone();this.faces.push(new THREE.Face4(v1,v2,v3,v4,[n1,n2,n3,n4]));this.faceVertexUvs[0].push([uv1,uv2,uv3,uv4])}}if(openEnded===false&&radiusTop>0){this.vertices.push(new THREE.Vector3(0,heightHalf,0));for(x=0;x<radiusSegments;x++){var v1=vertices[0][x];var v2=vertices[0][x+1];var v3=this.vertices.length-1;var n1=new THREE.Vector3(0,1,0);var n2=new THREE.Vector3(0,1,0);var n3=new THREE.Vector3(0,1,0);var uv1=uvs[0][x].clone();var uv2=uvs[0][x+1].clone();var uv3=new THREE.Vector2(uv2.u,0);this.faces.push(new THREE.Face3(v1,v2,v3,[n1,n2,n3]));this.faceVertexUvs[0].push([uv1,uv2,uv3])}}if(openEnded===false&&radiusBottom>0){this.vertices.push(new THREE.Vector3(0,-heightHalf,0));for(x=0;x<radiusSegments;x++){var v1=vertices[y][x+1];var v2=vertices[y][x];var v3=this.vertices.length-1;var n1=new THREE.Vector3(0,-1,0);var n2=new THREE.Vector3(0,-1,0);var n3=new THREE.Vector3(0,-1,0);var uv1=uvs[y][x+1].clone();var uv2=uvs[y][x].clone();var uv3=new THREE.Vector2(uv2.u,1);this.faces.push(new THREE.Face3(v1,v2,v3,[n1,n2,n3]));this.faceVertexUvs[0].push([uv1,uv2,uv3])}}this.computeCentroids();this.computeFaceNormals()};THREE.CylinderGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ExtrudeGeometry=function(shapes,options){if(typeof shapes==="undefined"){shapes=[];return}THREE.Geometry.call(this);shapes=shapes instanceof Array?shapes:[shapes];this.shapebb=shapes[shapes.length-1].getBoundingBox();this.addShapeList(shapes,options);this.computeCentroids();this.computeFaceNormals()};THREE.ExtrudeGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ExtrudeGeometry.prototype.addShapeList=function(shapes,options){var sl=shapes.length;for(var s=0;s<sl;s++){var shape=shapes[s];this.addShape(shape,options)}};THREE.ExtrudeGeometry.prototype.addShape=function(shape,options){var amount=options.amount!==undefined?options.amount:100;var bevelThickness=options.bevelThickness!==undefined?options.bevelThickness:6;var bevelSize=options.bevelSize!==undefined?options.bevelSize:bevelThickness-2;var bevelSegments=options.bevelSegments!==undefined?options.bevelSegments:3;var bevelEnabled=options.bevelEnabled!==undefined?options.bevelEnabled:true;var curveSegments=options.curveSegments!==undefined?options.curveSegments:12;var steps=options.steps!==undefined?options.steps:1;var extrudePath=options.extrudePath;var extrudePts,extrudeByPath=false;var material=options.material;var extrudeMaterial=options.extrudeMaterial;var uvgen=options.UVGenerator!==undefined?options.UVGenerator:THREE.ExtrudeGeometry.WorldUVGenerator;var shapebb=this.shapebb;var splineTube,binormal,normal,position2;if(extrudePath){extrudePts=extrudePath.getSpacedPoints(steps);extrudeByPath=true;bevelEnabled=false;splineTube=options.frames!==undefined?options.frames:new THREE.TubeGeometry.FrenetFrames(extrudePath,steps,false);binormal=new THREE.Vector3;normal=new THREE.Vector3;position2=new THREE.Vector3}if(!bevelEnabled){bevelSegments=0;bevelThickness=0;bevelSize=0}var ahole,h,hl;var scope=this;var bevelPoints=[];var shapesOffset=this.vertices.length;var shapePoints=shape.extractPoints(curveSegments);var vertices=shapePoints.shape;var holes=shapePoints.holes;var reverse=!THREE.Shape.Utils.isClockWise(vertices);if(reverse){vertices=vertices.reverse();for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];if(THREE.Shape.Utils.isClockWise(ahole)){holes[h]=ahole.reverse()}}reverse=false}var faces=THREE.Shape.Utils.triangulateShape(vertices,holes);var contour=vertices;for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];vertices=vertices.concat(ahole)}function scalePt2(pt,vec,size){if(!vec)console.log("die");return vec.clone().multiplyScalar(size).add(pt)}var b,bs,t,z,vert,vlen=vertices.length,face,flen=faces.length,cont,clen=contour.length;var RAD_TO_DEGREES=180/Math.PI;function getBevelVec(pt_i,pt_j,pt_k){return getBevelVec2(pt_i,pt_j,pt_k)}function getBevelVec1(pt_i,pt_j,pt_k){var anglea=Math.atan2(pt_j.y-pt_i.y,pt_j.x-pt_i.x);var angleb=Math.atan2(pt_k.y-pt_i.y,pt_k.x-pt_i.x);if(anglea>angleb){angleb+=Math.PI*2}var anglec=(anglea+angleb)/2;var x=-Math.cos(anglec);var y=-Math.sin(anglec);var vec=new THREE.Vector2(x,y);return vec}function getBevelVec2(pt_i,pt_j,pt_k){var a=THREE.ExtrudeGeometry.__v1,b=THREE.ExtrudeGeometry.__v2,v_hat=THREE.ExtrudeGeometry.__v3,w_hat=THREE.ExtrudeGeometry.__v4,p=THREE.ExtrudeGeometry.__v5,q=THREE.ExtrudeGeometry.__v6,v,w,v_dot_w_hat,q_sub_p_dot_w_hat,s,intersection;a.set(pt_i.x-pt_j.x,pt_i.y-pt_j.y);b.set(pt_i.x-pt_k.x,pt_i.y-pt_k.y);v=a.normalize();w=b.normalize();v_hat.set(-v.y,v.x);w_hat.set(w.y,-w.x);p.copy(pt_i).add(v_hat);q.copy(pt_i).add(w_hat);if(p.equals(q)){return w_hat.clone()}p.copy(pt_j).add(v_hat);q.copy(pt_k).add(w_hat);v_dot_w_hat=v.dot(w_hat);q_sub_p_dot_w_hat=q.sub(p).dot(w_hat);if(v_dot_w_hat===0){console.log("Either infinite or no solutions!");if(q_sub_p_dot_w_hat===0){console.log("Its finite solutions.")}else{console.log("Too bad, no solutions.")}}s=q_sub_p_dot_w_hat/v_dot_w_hat;if(s<0){return getBevelVec1(pt_i,pt_j,pt_k)}intersection=v.multiplyScalar(s).add(p);return intersection.sub(pt_i).clone()}var contourMovements=[];for(var i=0,il=contour.length,j=il-1,k=i+1;i<il;i++,j++,k++){if(j===il)j=0;if(k===il)k=0;var pt_i=contour[i];var pt_j=contour[j];var pt_k=contour[k];contourMovements[i]=getBevelVec(contour[i],contour[j],contour[k])}var holesMovements=[],oneHoleMovements,verticesMovements=contourMovements.concat();for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];oneHoleMovements=[];for(i=0,il=ahole.length,j=il-1,k=i+1;i<il;i++,j++,k++){if(j===il)j=0;if(k===il)k=0;oneHoleMovements[i]=getBevelVec(ahole[i],ahole[j],ahole[k])}holesMovements.push(oneHoleMovements);verticesMovements=verticesMovements.concat(oneHoleMovements)}for(b=0;b<bevelSegments;b++){t=b/bevelSegments;z=bevelThickness*(1-t);bs=bevelSize*Math.sin(t*Math.PI/2);for(i=0,il=contour.length;i<il;i++){vert=scalePt2(contour[i],contourMovements[i],bs);v(vert.x,vert.y,-z)}for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];oneHoleMovements=holesMovements[h];for(i=0,il=ahole.length;i<il;i++){vert=scalePt2(ahole[i],oneHoleMovements[i],bs);v(vert.x,vert.y,-z)}}}bs=bevelSize;for(i=0;i<vlen;i++){vert=bevelEnabled?scalePt2(vertices[i],verticesMovements[i],bs):vertices[i];if(!extrudeByPath){v(vert.x,vert.y,0)}else{normal.copy(splineTube.normals[0]).multiplyScalar(vert.x);binormal.copy(splineTube.binormals[0]).multiplyScalar(vert.y);position2.copy(extrudePts[0]).add(normal).add(binormal);v(position2.x,position2.y,position2.z)}}var s;for(s=1;s<=steps;s++){for(i=0;i<vlen;i++){vert=bevelEnabled?scalePt2(vertices[i],verticesMovements[i],bs):vertices[i];if(!extrudeByPath){v(vert.x,vert.y,amount/steps*s)}else{normal.copy(splineTube.normals[s]).multiplyScalar(vert.x);binormal.copy(splineTube.binormals[s]).multiplyScalar(vert.y);position2.copy(extrudePts[s]).add(normal).add(binormal);v(position2.x,position2.y,position2.z)}}}for(b=bevelSegments-1;b>=0;b--){t=b/bevelSegments;z=bevelThickness*(1-t);bs=bevelSize*Math.sin(t*Math.PI/2);for(i=0,il=contour.length;i<il;i++){vert=scalePt2(contour[i],contourMovements[i],bs);v(vert.x,vert.y,amount+z)}for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];oneHoleMovements=holesMovements[h];for(i=0,il=ahole.length;i<il;i++){vert=scalePt2(ahole[i],oneHoleMovements[i],bs);if(!extrudeByPath){v(vert.x,vert.y,amount+z)}else{v(vert.x,vert.y+extrudePts[steps-1].y,extrudePts[steps-1].x+z)}}}}buildLidFaces();buildSideFaces();function buildLidFaces(){if(bevelEnabled){var layer=0;var offset=vlen*layer;for(i=0;i<flen;i++){face=faces[i];f3(face[2]+offset,face[1]+offset,face[0]+offset,true)}layer=steps+bevelSegments*2;offset=vlen*layer;for(i=0;i<flen;i++){face=faces[i];f3(face[0]+offset,face[1]+offset,face[2]+offset,false)}}else{for(i=0;i<flen;i++){face=faces[i];f3(face[2],face[1],face[0],true)}for(i=0;i<flen;i++){face=faces[i];f3(face[0]+vlen*steps,face[1]+vlen*steps,face[2]+vlen*steps,false)}}}function buildSideFaces(){var layeroffset=0;sidewalls(contour,layeroffset);layeroffset+=contour.length;for(h=0,hl=holes.length;h<hl;h++){ahole=holes[h];sidewalls(ahole,layeroffset);layeroffset+=ahole.length}}function sidewalls(contour,layeroffset){var j,k;i=contour.length;while(--i>=0){j=i;k=i-1;if(k<0)k=contour.length-1;var s=0,sl=steps+bevelSegments*2;for(s=0;s<sl;s++){var slen1=vlen*s;var slen2=vlen*(s+1);var a=layeroffset+j+slen1,b=layeroffset+k+slen1,c=layeroffset+k+slen2,d=layeroffset+j+slen2;f4(a,b,c,d,contour,s,sl,j,k)}}}function v(x,y,z){scope.vertices.push(new THREE.Vector3(x,y,z))}function f3(a,b,c,isBottom){a+=shapesOffset;b+=shapesOffset;c+=shapesOffset;scope.faces.push(new THREE.Face3(a,b,c,null,null,material));var uvs=isBottom?uvgen.generateBottomUV(scope,shape,options,a,b,c):uvgen.generateTopUV(scope,shape,options,a,b,c);scope.faceVertexUvs[0].push(uvs)}function f4(a,b,c,d,wallContour,stepIndex,stepsLength,contourIndex1,contourIndex2){a+=shapesOffset;b+=shapesOffset;c+=shapesOffset;d+=shapesOffset;scope.faces.push(new THREE.Face4(a,b,c,d,null,null,extrudeMaterial));var uvs=uvgen.generateSideWallUV(scope,shape,wallContour,options,a,b,c,d,stepIndex,stepsLength,contourIndex1,contourIndex2);scope.faceVertexUvs[0].push(uvs)}};THREE.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(geometry,extrudedShape,extrudeOptions,indexA,indexB,indexC){var ax=geometry.vertices[indexA].x,ay=geometry.vertices[indexA].y,bx=geometry.vertices[indexB].x,by=geometry.vertices[indexB].y,cx=geometry.vertices[indexC].x,cy=geometry.vertices[indexC].y;return[new THREE.Vector2(ax,ay),new THREE.Vector2(bx,by),new THREE.Vector2(cx,cy)]},generateBottomUV:function(geometry,extrudedShape,extrudeOptions,indexA,indexB,indexC){return this.generateTopUV(geometry,extrudedShape,extrudeOptions,indexA,indexB,indexC)},generateSideWallUV:function(geometry,extrudedShape,wallContour,extrudeOptions,indexA,indexB,indexC,indexD,stepIndex,stepsLength,contourIndex1,contourIndex2){var ax=geometry.vertices[indexA].x,ay=geometry.vertices[indexA].y,az=geometry.vertices[indexA].z,bx=geometry.vertices[indexB].x,by=geometry.vertices[indexB].y,bz=geometry.vertices[indexB].z,cx=geometry.vertices[indexC].x,cy=geometry.vertices[indexC].y,cz=geometry.vertices[indexC].z,dx=geometry.vertices[indexD].x,dy=geometry.vertices[indexD].y,dz=geometry.vertices[indexD].z;if(Math.abs(ay-by)<.01){return[new THREE.Vector2(ax,1-az),new THREE.Vector2(bx,1-bz),new THREE.Vector2(cx,1-cz),new THREE.Vector2(dx,1-dz)]}else{return[new THREE.Vector2(ay,1-az),new THREE.Vector2(by,1-bz),new THREE.Vector2(cy,1-cz),new THREE.Vector2(dy,1-dz)]}}};THREE.ExtrudeGeometry.__v1=new THREE.Vector2;THREE.ExtrudeGeometry.__v2=new THREE.Vector2;THREE.ExtrudeGeometry.__v3=new THREE.Vector2;THREE.ExtrudeGeometry.__v4=new THREE.Vector2;THREE.ExtrudeGeometry.__v5=new THREE.Vector2;THREE.ExtrudeGeometry.__v6=new THREE.Vector2;THREE.ShapeGeometry=function(shapes,options){THREE.Geometry.call(this);if(shapes instanceof Array===false)shapes=[shapes];this.shapebb=shapes[shapes.length-1].getBoundingBox();this.addShapeList(shapes,options);this.computeCentroids();this.computeFaceNormals()};THREE.ShapeGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ShapeGeometry.prototype.addShapeList=function(shapes,options){for(var i=0,l=shapes.length;i<l;i++){this.addShape(shapes[i],options)}return this};THREE.ShapeGeometry.prototype.addShape=function(shape,options){if(options===undefined)options={};var curveSegments=options.curveSegments!==undefined?options.curveSegments:12;var material=options.material;var uvgen=options.UVGenerator===undefined?THREE.ExtrudeGeometry.WorldUVGenerator:options.UVGenerator;var shapebb=this.shapebb;var i,l,hole,s;var shapesOffset=this.vertices.length;var shapePoints=shape.extractPoints(curveSegments);var vertices=shapePoints.shape;var holes=shapePoints.holes;var reverse=!THREE.Shape.Utils.isClockWise(vertices);if(reverse){vertices=vertices.reverse();for(i=0,l=holes.length;i<l;i++){hole=holes[i];if(THREE.Shape.Utils.isClockWise(hole)){holes[i]=hole.reverse()}}reverse=false}var faces=THREE.Shape.Utils.triangulateShape(vertices,holes);var contour=vertices;for(i=0,l=holes.length;i<l;i++){hole=holes[i];vertices=vertices.concat(hole)}var vert,vlen=vertices.length;var face,flen=faces.length;var cont,clen=contour.length;for(i=0;i<vlen;i++){vert=vertices[i];this.vertices.push(new THREE.Vector3(vert.x,vert.y,0))}for(i=0;i<flen;i++){face=faces[i];var a=face[0]+shapesOffset;var b=face[1]+shapesOffset;var c=face[2]+shapesOffset;this.faces.push(new THREE.Face3(a,b,c,null,null,material));this.faceVertexUvs[0].push(uvgen.generateBottomUV(this,shape,options,a,b,c))}};THREE.LatheGeometry=function(points,segments,phiStart,phiLength){THREE.Geometry.call(this);segments=segments||12;phiStart=phiStart||0;phiLength=phiLength||2*Math.PI;var inversePointLength=1/(points.length-1);var inverseSegments=1/segments;for(var i=0,il=segments;i<=il;i++){var phi=phiStart+i*inverseSegments*phiLength;var c=Math.cos(phi),s=Math.sin(phi);for(var j=0,jl=points.length;j<jl;j++){var pt=points[j];var vertex=new THREE.Vector3;vertex.x=c*pt.x-s*pt.y;vertex.y=s*pt.x+c*pt.y;vertex.z=pt.z;this.vertices.push(vertex)}}var np=points.length;for(var i=0,il=segments;i<il;i++){for(var j=0,jl=points.length-1;j<jl;j++){var base=j+np*i;var a=base;var b=base+np;var c=base+1+np;var d=base+1;this.faces.push(new THREE.Face4(a,b,c,d));var u0=i*inverseSegments;var v0=j*inversePointLength;var u1=u0+inverseSegments;var v1=v0+inversePointLength;this.faceVertexUvs[0].push([new THREE.Vector2(u0,v0),new THREE.Vector2(u1,v0),new THREE.Vector2(u1,v1),new THREE.Vector2(u0,v1)])}}this.mergeVertices();this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.LatheGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.PlaneGeometry=function(width,height,widthSegments,heightSegments){THREE.Geometry.call(this);this.width=width;this.height=height;this.widthSegments=widthSegments||1;this.heightSegments=heightSegments||1;var ix,iz;var width_half=width/2;var height_half=height/2;var gridX=this.widthSegments;var gridZ=this.heightSegments;var gridX1=gridX+1;var gridZ1=gridZ+1;var segment_width=this.width/gridX;var segment_height=this.height/gridZ;var normal=new THREE.Vector3(0,0,1);for(iz=0;iz<gridZ1;iz++){for(ix=0;ix<gridX1;ix++){var x=ix*segment_width-width_half;var y=iz*segment_height-height_half;this.vertices.push(new THREE.Vector3(x,-y,0))}}for(iz=0;iz<gridZ;iz++){for(ix=0;ix<gridX;ix++){var a=ix+gridX1*iz;var b=ix+gridX1*(iz+1);var c=ix+1+gridX1*(iz+1);var d=ix+1+gridX1*iz;var face=new THREE.Face4(a,b,c,d);face.normal.copy(normal);face.vertexNormals.push(normal.clone(),normal.clone(),normal.clone(),normal.clone());this.faces.push(face);this.faceVertexUvs[0].push([new THREE.Vector2(ix/gridX,1-iz/gridZ),new THREE.Vector2(ix/gridX,1-(iz+1)/gridZ),new THREE.Vector2((ix+1)/gridX,1-(iz+1)/gridZ),new THREE.Vector2((ix+1)/gridX,1-iz/gridZ)])}}this.computeCentroids()};THREE.PlaneGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.RingGeometry=function(innerRadius,outerRadius,thetaSegments,phiSegments,thetaStart,thetaLength){THREE.Geometry.call(this);innerRadius=innerRadius||0;outerRadius=outerRadius||50;thetaStart=thetaStart!==undefined?thetaStart:0;thetaLength=thetaLength!==undefined?thetaLength:Math.PI*2;thetaSegments=thetaSegments!==undefined?Math.max(3,thetaSegments):8;phiSegments=phiSegments!==undefined?Math.max(3,phiSegments):8;var i,o,uvs=[],radius=innerRadius,radiusStep=(outerRadius-innerRadius)/phiSegments;for(i=0;i<=phiSegments;i++){for(o=0;o<=thetaSegments;o++){var vertex=new THREE.Vector3;var segment=thetaStart+o/thetaSegments*thetaLength;vertex.x=radius*Math.cos(segment);vertex.y=radius*Math.sin(segment);this.vertices.push(vertex);uvs.push(new THREE.Vector2((vertex.x/radius+1)/2,-(vertex.y/radius+1)/2+1))}radius+=radiusStep}var n=new THREE.Vector3(0,0,1);for(i=0;i<phiSegments;i++){var thetaSegment=i*thetaSegments;for(o=0;o<=thetaSegments;o++){var segment=o+thetaSegment;var v1=segment+i;var v2=segment+thetaSegments+i;var v3=segment+thetaSegments+1+i;this.faces.push(new THREE.Face3(v1,v2,v3,[n,n,n]));this.faceVertexUvs[0].push([uvs[v1],uvs[v2],uvs[v3]]);v1=segment+i;v2=segment+thetaSegments+1+i;v3=segment+1+i;this.faces.push(new THREE.Face3(v1,v2,v3,[n,n,n]));this.faceVertexUvs[0].push([uvs[v1],uvs[v2],uvs[v3]])}}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,radius)};THREE.RingGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.SphereGeometry=function(radius,widthSegments,heightSegments,phiStart,phiLength,thetaStart,thetaLength){THREE.Geometry.call(this);this.radius=radius=radius||50;this.widthSegments=widthSegments=Math.max(3,Math.floor(widthSegments)||8);this.heightSegments=heightSegments=Math.max(2,Math.floor(heightSegments)||6);this.phiStart=phiStart=phiStart!==undefined?phiStart:0;this.phiLength=phiLength=phiLength!==undefined?phiLength:Math.PI*2;this.thetaStart=thetaStart=thetaStart!==undefined?thetaStart:0;this.thetaLength=thetaLength=thetaLength!==undefined?thetaLength:Math.PI;var x,y,vertices=[],uvs=[];for(y=0;y<=heightSegments;y++){var verticesRow=[];var uvsRow=[];for(x=0;x<=widthSegments;x++){var u=x/widthSegments;var v=y/heightSegments;var vertex=new THREE.Vector3;vertex.x=-radius*Math.cos(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength);vertex.y=radius*Math.cos(thetaStart+v*thetaLength);vertex.z=radius*Math.sin(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength);this.vertices.push(vertex);verticesRow.push(this.vertices.length-1);uvsRow.push(new THREE.Vector2(u,1-v))}vertices.push(verticesRow);uvs.push(uvsRow)}for(y=0;y<this.heightSegments;y++){for(x=0;x<this.widthSegments;x++){var v1=vertices[y][x+1];var v2=vertices[y][x];var v3=vertices[y+1][x];var v4=vertices[y+1][x+1];var n1=this.vertices[v1].clone().normalize();var n2=this.vertices[v2].clone().normalize();var n3=this.vertices[v3].clone().normalize();var n4=this.vertices[v4].clone().normalize();var uv1=uvs[y][x+1].clone();var uv2=uvs[y][x].clone();var uv3=uvs[y+1][x].clone();var uv4=uvs[y+1][x+1].clone();if(Math.abs(this.vertices[v1].y)===this.radius){this.faces.push(new THREE.Face3(v1,v3,v4,[n1,n3,n4]));this.faceVertexUvs[0].push([uv1,uv3,uv4])}else if(Math.abs(this.vertices[v3].y)===this.radius){this.faces.push(new THREE.Face3(v1,v2,v3,[n1,n2,n3]));this.faceVertexUvs[0].push([uv1,uv2,uv3])}else{this.faces.push(new THREE.Face4(v1,v2,v3,v4,[n1,n2,n3,n4]));this.faceVertexUvs[0].push([uv1,uv2,uv3,uv4])}}}this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,radius)};THREE.SphereGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TextGeometry=function(text,parameters){parameters=parameters||{};var textShapes=THREE.FontUtils.generateShapes(text,parameters);parameters.amount=parameters.height!==undefined?parameters.height:50;if(parameters.bevelThickness===undefined)parameters.bevelThickness=10;if(parameters.bevelSize===undefined)parameters.bevelSize=8;if(parameters.bevelEnabled===undefined)parameters.bevelEnabled=false;THREE.ExtrudeGeometry.call(this,textShapes,parameters)};THREE.TextGeometry.prototype=Object.create(THREE.ExtrudeGeometry.prototype);THREE.TorusGeometry=function(radius,tube,radialSegments,tubularSegments,arc){THREE.Geometry.call(this);var scope=this;this.radius=radius||100;this.tube=tube||40;this.radialSegments=radialSegments||8;this.tubularSegments=tubularSegments||6;this.arc=arc||Math.PI*2;var center=new THREE.Vector3,uvs=[],normals=[];for(var j=0;j<=this.radialSegments;j++){for(var i=0;i<=this.tubularSegments;i++){var u=i/this.tubularSegments*this.arc;var v=j/this.radialSegments*Math.PI*2;center.x=this.radius*Math.cos(u);center.y=this.radius*Math.sin(u);var vertex=new THREE.Vector3;vertex.x=(this.radius+this.tube*Math.cos(v))*Math.cos(u);vertex.y=(this.radius+this.tube*Math.cos(v))*Math.sin(u);vertex.z=this.tube*Math.sin(v);this.vertices.push(vertex);uvs.push(new THREE.Vector2(i/this.tubularSegments,j/this.radialSegments));normals.push(vertex.clone().sub(center).normalize())}}for(var j=1;j<=this.radialSegments;j++){for(var i=1;i<=this.tubularSegments;i++){var a=(this.tubularSegments+1)*j+i-1;var b=(this.tubularSegments+1)*(j-1)+i-1;var c=(this.tubularSegments+1)*(j-1)+i;var d=(this.tubularSegments+1)*j+i;var face=new THREE.Face4(a,b,c,d,[normals[a],normals[b],normals[c],normals[d]]);
face.normal.add(normals[a]);face.normal.add(normals[b]);face.normal.add(normals[c]);face.normal.add(normals[d]);face.normal.normalize();this.faces.push(face);this.faceVertexUvs[0].push([uvs[a].clone(),uvs[b].clone(),uvs[c].clone(),uvs[d].clone()])}}this.computeCentroids()};THREE.TorusGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TorusKnotGeometry=function(radius,tube,radialSegments,tubularSegments,p,q,heightScale){THREE.Geometry.call(this);var scope=this;this.radius=radius||100;this.tube=tube||40;this.radialSegments=radialSegments||64;this.tubularSegments=tubularSegments||8;this.p=p||2;this.q=q||3;this.heightScale=heightScale||1;this.grid=new Array(this.radialSegments);var tang=new THREE.Vector3;var n=new THREE.Vector3;var bitan=new THREE.Vector3;for(var i=0;i<this.radialSegments;++i){this.grid[i]=new Array(this.tubularSegments);for(var j=0;j<this.tubularSegments;++j){var u=i/this.radialSegments*2*this.p*Math.PI;var v=j/this.tubularSegments*2*Math.PI;var p1=getPos(u,v,this.q,this.p,this.radius,this.heightScale);var p2=getPos(u+.01,v,this.q,this.p,this.radius,this.heightScale);var cx,cy;tang.subVectors(p2,p1);n.addVectors(p2,p1);bitan.crossVectors(tang,n);n.crossVectors(bitan,tang);bitan.normalize();n.normalize();cx=-this.tube*Math.cos(v);cy=this.tube*Math.sin(v);p1.x+=cx*n.x+cy*bitan.x;p1.y+=cx*n.y+cy*bitan.y;p1.z+=cx*n.z+cy*bitan.z;this.grid[i][j]=vert(p1.x,p1.y,p1.z)}}for(var i=0;i<this.radialSegments;++i){for(var j=0;j<this.tubularSegments;++j){var ip=(i+1)%this.radialSegments;var jp=(j+1)%this.tubularSegments;var a=this.grid[i][j];var b=this.grid[ip][j];var c=this.grid[ip][jp];var d=this.grid[i][jp];var uva=new THREE.Vector2(i/this.radialSegments,j/this.tubularSegments);var uvb=new THREE.Vector2((i+1)/this.radialSegments,j/this.tubularSegments);var uvc=new THREE.Vector2((i+1)/this.radialSegments,(j+1)/this.tubularSegments);var uvd=new THREE.Vector2(i/this.radialSegments,(j+1)/this.tubularSegments);this.faces.push(new THREE.Face4(a,b,c,d));this.faceVertexUvs[0].push([uva,uvb,uvc,uvd])}}this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals();function vert(x,y,z){return scope.vertices.push(new THREE.Vector3(x,y,z))-1}function getPos(u,v,in_q,in_p,radius,heightScale){var cu=Math.cos(u);var cv=Math.cos(v);var su=Math.sin(u);var quOverP=in_q/in_p*u;var cs=Math.cos(quOverP);var tx=radius*(2+cs)*.5*cu;var ty=radius*(2+cs)*su*.5;var tz=heightScale*radius*Math.sin(quOverP)*.5;return new THREE.Vector3(tx,ty,tz)}};THREE.TorusKnotGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TubeGeometry=function(path,segments,radius,radiusSegments,closed,debug){THREE.Geometry.call(this);this.path=path;this.segments=segments||64;this.radius=radius||1;this.radiusSegments=radiusSegments||8;this.closed=closed||false;if(debug)this.debug=new THREE.Object3D;this.grid=[];var scope=this,tangent,normal,binormal,numpoints=this.segments+1,x,y,z,tx,ty,tz,u,v,cx,cy,pos,pos2=new THREE.Vector3,i,j,ip,jp,a,b,c,d,uva,uvb,uvc,uvd;var frames=new THREE.TubeGeometry.FrenetFrames(this.path,this.segments,this.closed),tangents=frames.tangents,normals=frames.normals,binormals=frames.binormals;this.tangents=tangents;this.normals=normals;this.binormals=binormals;function vert(x,y,z){return scope.vertices.push(new THREE.Vector3(x,y,z))-1}for(i=0;i<numpoints;i++){this.grid[i]=[];u=i/(numpoints-1);pos=path.getPointAt(u);tangent=tangents[i];normal=normals[i];binormal=binormals[i];if(this.debug){this.debug.add(new THREE.ArrowHelper(tangent,pos,radius,255));this.debug.add(new THREE.ArrowHelper(normal,pos,radius,16711680));this.debug.add(new THREE.ArrowHelper(binormal,pos,radius,65280))}for(j=0;j<this.radiusSegments;j++){v=j/this.radiusSegments*2*Math.PI;cx=-this.radius*Math.cos(v);cy=this.radius*Math.sin(v);pos2.copy(pos);pos2.x+=cx*normal.x+cy*binormal.x;pos2.y+=cx*normal.y+cy*binormal.y;pos2.z+=cx*normal.z+cy*binormal.z;this.grid[i][j]=vert(pos2.x,pos2.y,pos2.z)}}for(i=0;i<this.segments;i++){for(j=0;j<this.radiusSegments;j++){ip=this.closed?(i+1)%this.segments:i+1;jp=(j+1)%this.radiusSegments;a=this.grid[i][j];b=this.grid[ip][j];c=this.grid[ip][jp];d=this.grid[i][jp];uva=new THREE.Vector2(i/this.segments,j/this.radiusSegments);uvb=new THREE.Vector2((i+1)/this.segments,j/this.radiusSegments);uvc=new THREE.Vector2((i+1)/this.segments,(j+1)/this.radiusSegments);uvd=new THREE.Vector2(i/this.segments,(j+1)/this.radiusSegments);this.faces.push(new THREE.Face4(a,b,c,d));this.faceVertexUvs[0].push([uva,uvb,uvc,uvd])}}this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.TubeGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TubeGeometry.FrenetFrames=function(path,segments,closed){var tangent=new THREE.Vector3,normal=new THREE.Vector3,binormal=new THREE.Vector3,tangents=[],normals=[],binormals=[],vec=new THREE.Vector3,mat=new THREE.Matrix4,numpoints=segments+1,theta,epsilon=1e-4,smallest,tx,ty,tz,i,u,v;this.tangents=tangents;this.normals=normals;this.binormals=binormals;for(i=0;i<numpoints;i++){u=i/(numpoints-1);tangents[i]=path.getTangentAt(u);tangents[i].normalize()}initialNormal3();function initialNormal1(lastBinormal){normals[0]=new THREE.Vector3;binormals[0]=new THREE.Vector3;if(lastBinormal===undefined)lastBinormal=new THREE.Vector3(0,0,1);normals[0].crossVectors(lastBinormal,tangents[0]).normalize();binormals[0].crossVectors(tangents[0],normals[0]).normalize()}function initialNormal2(){var t2=path.getTangentAt(epsilon);normals[0]=(new THREE.Vector3).subVectors(t2,tangents[0]).normalize();binormals[0]=(new THREE.Vector3).crossVectors(tangents[0],normals[0]);normals[0].crossVectors(binormals[0],tangents[0]).normalize();binormals[0].crossVectors(tangents[0],normals[0]).normalize()}function initialNormal3(){normals[0]=new THREE.Vector3;binormals[0]=new THREE.Vector3;smallest=Number.MAX_VALUE;tx=Math.abs(tangents[0].x);ty=Math.abs(tangents[0].y);tz=Math.abs(tangents[0].z);if(tx<=smallest){smallest=tx;normal.set(1,0,0)}if(ty<=smallest){smallest=ty;normal.set(0,1,0)}if(tz<=smallest){normal.set(0,0,1)}vec.crossVectors(tangents[0],normal).normalize();normals[0].crossVectors(tangents[0],vec);binormals[0].crossVectors(tangents[0],normals[0])}for(i=1;i<numpoints;i++){normals[i]=normals[i-1].clone();binormals[i]=binormals[i-1].clone();vec.crossVectors(tangents[i-1],tangents[i]);if(vec.length()>epsilon){vec.normalize();theta=Math.acos(tangents[i-1].dot(tangents[i]));normals[i].applyMatrix4(mat.makeRotationAxis(vec,theta))}binormals[i].crossVectors(tangents[i],normals[i])}if(closed){theta=Math.acos(normals[0].dot(normals[numpoints-1]));theta/=numpoints-1;if(tangents[0].dot(vec.crossVectors(normals[0],normals[numpoints-1]))>0){theta=-theta}for(i=1;i<numpoints;i++){normals[i].applyMatrix4(mat.makeRotationAxis(tangents[i],theta*i));binormals[i].crossVectors(tangents[i],normals[i])}}};THREE.PolyhedronGeometry=function(vertices,faces,radius,detail){THREE.Geometry.call(this);radius=radius||1;detail=detail||0;var that=this;for(var i=0,l=vertices.length;i<l;i++){prepare(new THREE.Vector3(vertices[i][0],vertices[i][1],vertices[i][2]))}var midpoints=[],p=this.vertices;var f=[];for(var i=0,l=faces.length;i<l;i++){var v1=p[faces[i][0]];var v2=p[faces[i][1]];var v3=p[faces[i][2]];f[i]=new THREE.Face3(v1.index,v2.index,v3.index,[v1.clone(),v2.clone(),v3.clone()])}for(var i=0,l=f.length;i<l;i++){subdivide(f[i],detail)}for(var i=0,l=this.faceVertexUvs[0].length;i<l;i++){var uvs=this.faceVertexUvs[0][i];var x0=uvs[0].x;var x1=uvs[1].x;var x2=uvs[2].x;var max=Math.max(x0,Math.max(x1,x2));var min=Math.min(x0,Math.min(x1,x2));if(max>.9&&min<.1){if(x0<.2)uvs[0].x+=1;if(x1<.2)uvs[1].x+=1;if(x2<.2)uvs[2].x+=1}}for(var i=0,l=this.vertices.length;i<l;i++){this.vertices[i].multiplyScalar(radius)}this.mergeVertices();this.computeCentroids();this.computeFaceNormals();this.boundingSphere=new THREE.Sphere(new THREE.Vector3,radius);function prepare(vector){var vertex=vector.normalize().clone();vertex.index=that.vertices.push(vertex)-1;var u=azimuth(vector)/2/Math.PI+.5;var v=inclination(vector)/Math.PI+.5;vertex.uv=new THREE.Vector2(u,1-v);return vertex}function make(v1,v2,v3){var face=new THREE.Face3(v1.index,v2.index,v3.index,[v1.clone(),v2.clone(),v3.clone()]);face.centroid.add(v1).add(v2).add(v3).divideScalar(3);that.faces.push(face);var azi=azimuth(face.centroid);that.faceVertexUvs[0].push([correctUV(v1.uv,v1,azi),correctUV(v2.uv,v2,azi),correctUV(v3.uv,v3,azi)])}function subdivide(face,detail){var cols=Math.pow(2,detail);var cells=Math.pow(4,detail);var a=prepare(that.vertices[face.a]);var b=prepare(that.vertices[face.b]);var c=prepare(that.vertices[face.c]);var v=[];for(var i=0;i<=cols;i++){v[i]=[];var aj=prepare(a.clone().lerp(c,i/cols));var bj=prepare(b.clone().lerp(c,i/cols));var rows=cols-i;for(var j=0;j<=rows;j++){if(j==0&&i==cols){v[i][j]=aj}else{v[i][j]=prepare(aj.clone().lerp(bj,j/rows))}}}for(var i=0;i<cols;i++){for(var j=0;j<2*(cols-i)-1;j++){var k=Math.floor(j/2);if(j%2==0){make(v[i][k+1],v[i+1][k],v[i][k])}else{make(v[i][k+1],v[i+1][k+1],v[i+1][k])}}}}function azimuth(vector){return Math.atan2(vector.z,-vector.x)}function inclination(vector){return Math.atan2(-vector.y,Math.sqrt(vector.x*vector.x+vector.z*vector.z))}function correctUV(uv,vector,azimuth){if(azimuth<0&&uv.x===1)uv=new THREE.Vector2(uv.x-1,uv.y);if(vector.x===0&&vector.z===0)uv=new THREE.Vector2(azimuth/2/Math.PI+.5,uv.y);return uv.clone()}};THREE.PolyhedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.IcosahedronGeometry=function(radius,detail){this.radius=radius;this.detail=detail;var t=(1+Math.sqrt(5))/2;var vertices=[[-1,t,0],[1,t,0],[-1,-t,0],[1,-t,0],[0,-1,t],[0,1,t],[0,-1,-t],[0,1,-t],[t,0,-1],[t,0,1],[-t,0,-1],[-t,0,1]];var faces=[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]];THREE.PolyhedronGeometry.call(this,vertices,faces,radius,detail)};THREE.IcosahedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.OctahedronGeometry=function(radius,detail){var vertices=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]];var faces=[[0,2,4],[0,4,3],[0,3,5],[0,5,2],[1,2,5],[1,5,3],[1,3,4],[1,4,2]];THREE.PolyhedronGeometry.call(this,vertices,faces,radius,detail)};THREE.OctahedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.TetrahedronGeometry=function(radius,detail){var vertices=[[1,1,1],[-1,-1,1],[-1,1,-1],[1,-1,-1]];var faces=[[2,1,0],[0,3,2],[1,3,0],[2,3,1]];THREE.PolyhedronGeometry.call(this,vertices,faces,radius,detail)};THREE.TetrahedronGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ParametricGeometry=function(func,slices,stacks,useTris){THREE.Geometry.call(this);var verts=this.vertices;var faces=this.faces;var uvs=this.faceVertexUvs[0];useTris=useTris===undefined?false:useTris;var i,il,j,p;var u,v;var stackCount=stacks+1;var sliceCount=slices+1;for(i=0;i<=stacks;i++){v=i/stacks;for(j=0;j<=slices;j++){u=j/slices;p=func(u,v);verts.push(p)}}var a,b,c,d;var uva,uvb,uvc,uvd;for(i=0;i<stacks;i++){for(j=0;j<slices;j++){a=i*sliceCount+j;b=i*sliceCount+j+1;c=(i+1)*sliceCount+j;d=(i+1)*sliceCount+j+1;uva=new THREE.Vector2(j/slices,i/stacks);uvb=new THREE.Vector2((j+1)/slices,i/stacks);uvc=new THREE.Vector2(j/slices,(i+1)/stacks);uvd=new THREE.Vector2((j+1)/slices,(i+1)/stacks);if(useTris){faces.push(new THREE.Face3(a,b,c));faces.push(new THREE.Face3(b,d,c));uvs.push([uva,uvb,uvc]);uvs.push([uvb,uvd,uvc])}else{faces.push(new THREE.Face4(a,b,d,c));uvs.push([uva,uvb,uvd,uvc])}}}this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.ParametricGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.ConvexGeometry=function(vertices){THREE.Geometry.call(this);var faces=[[0,1,2],[0,2,1]];for(var i=3;i<vertices.length;i++){addPoint(i)}function addPoint(vertexId){var vertex=vertices[vertexId].clone();var mag=vertex.length();vertex.x+=mag*randomOffset();vertex.y+=mag*randomOffset();vertex.z+=mag*randomOffset();var hole=[];for(var f=0;f<faces.length;){var face=faces[f];if(visible(face,vertex)){for(var e=0;e<3;e++){var edge=[face[e],face[(e+1)%3]];var boundary=true;for(var h=0;h<hole.length;h++){if(equalEdge(hole[h],edge)){hole[h]=hole[hole.length-1];hole.pop();boundary=false;break}}if(boundary){hole.push(edge)}}faces[f]=faces[faces.length-1];faces.pop()}else{f++}}for(var h=0;h<hole.length;h++){faces.push([hole[h][0],hole[h][1],vertexId])}}function visible(face,vertex){var va=vertices[face[0]];var vb=vertices[face[1]];var vc=vertices[face[2]];var n=normal(va,vb,vc);var dist=n.dot(va);return n.dot(vertex)>=dist}function normal(va,vb,vc){var cb=new THREE.Vector3;var ab=new THREE.Vector3;cb.subVectors(vc,vb);ab.subVectors(va,vb);cb.cross(ab);cb.normalize();return cb}function equalEdge(ea,eb){return ea[0]===eb[1]&&ea[1]===eb[0]}function randomOffset(){return(Math.random()-.5)*2*1e-6}function vertexUv(vertex){var mag=vertex.length();return new THREE.Vector2(vertex.x/mag,vertex.y/mag)}var id=0;var newId=new Array(vertices.length);for(var i=0;i<faces.length;i++){var face=faces[i];for(var j=0;j<3;j++){if(newId[face[j]]===undefined){newId[face[j]]=id++;this.vertices.push(vertices[face[j]])}face[j]=newId[face[j]]}}for(var i=0;i<faces.length;i++){this.faces.push(new THREE.Face3(faces[i][0],faces[i][1],faces[i][2]))}for(var i=0;i<this.faces.length;i++){var face=this.faces[i];this.faceVertexUvs[0].push([vertexUv(this.vertices[face.a]),vertexUv(this.vertices[face.b]),vertexUv(this.vertices[face.c])])}this.computeCentroids();this.computeFaceNormals();this.computeVertexNormals()};THREE.ConvexGeometry.prototype=Object.create(THREE.Geometry.prototype);THREE.AxisHelper=function(size){size=size||1;var geometry=new THREE.Geometry;geometry.vertices.push(new THREE.Vector3,new THREE.Vector3(size,0,0),new THREE.Vector3,new THREE.Vector3(0,size,0),new THREE.Vector3,new THREE.Vector3(0,0,size));geometry.colors.push(new THREE.Color(16711680),new THREE.Color(16755200),new THREE.Color(65280),new THREE.Color(11206400),new THREE.Color(255),new THREE.Color(43775));var material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});THREE.Line.call(this,geometry,material,THREE.LinePieces)};THREE.AxisHelper.prototype=Object.create(THREE.Line.prototype);THREE.ArrowHelper=function(dir,origin,length,hex){THREE.Object3D.call(this);if(hex===undefined)hex=16776960;if(length===undefined)length=1;this.position=origin;this.useQuaternion=true;var lineGeometry=new THREE.Geometry;lineGeometry.vertices.push(new THREE.Vector3(0,0,0));lineGeometry.vertices.push(new THREE.Vector3(0,1,0));this.line=new THREE.Line(lineGeometry,new THREE.LineBasicMaterial({color:hex}));this.line.matrixAutoUpdate=false;this.add(this.line);var coneGeometry=new THREE.CylinderGeometry(0,.05,.25,5,1);coneGeometry.applyMatrix((new THREE.Matrix4).makeTranslation(0,.875,0));this.cone=new THREE.Mesh(coneGeometry,new THREE.MeshBasicMaterial({color:hex}));this.cone.matrixAutoUpdate=false;this.add(this.cone);this.setDirection(dir);this.setLength(length)};THREE.ArrowHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.ArrowHelper.prototype.setDirection=function(){var axis=new THREE.Vector3;var radians;return function(dir){if(dir.y>.999){this.quaternion.set(0,0,0,1)}else if(dir.y<-.999){this.quaternion.set(1,0,0,0)}else{axis.set(dir.z,0,-dir.x).normalize();radians=Math.acos(dir.y);this.quaternion.setFromAxisAngle(axis,radians)}}}();THREE.ArrowHelper.prototype.setLength=function(length){this.scale.set(length,length,length)};THREE.ArrowHelper.prototype.setColor=function(hex){this.line.material.color.setHex(hex);this.cone.material.color.setHex(hex)};THREE.BoxHelper=function(object){var vertices=[new THREE.Vector3(1,1,1),new THREE.Vector3(-1,1,1),new THREE.Vector3(-1,-1,1),new THREE.Vector3(1,-1,1),new THREE.Vector3(1,1,-1),new THREE.Vector3(-1,1,-1),new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,-1,-1)];this.vertices=vertices;var geometry=new THREE.Geometry;geometry.vertices.push(vertices[0],vertices[1],vertices[1],vertices[2],vertices[2],vertices[3],vertices[3],vertices[0],vertices[4],vertices[5],vertices[5],vertices[6],vertices[6],vertices[7],vertices[7],vertices[4],vertices[0],vertices[4],vertices[1],vertices[5],vertices[2],vertices[6],vertices[3],vertices[7]);THREE.Line.call(this,geometry,new THREE.LineBasicMaterial({color:16776960}),THREE.LinePieces);if(object!==undefined){this.update(object)}};THREE.BoxHelper.prototype=Object.create(THREE.Line.prototype);THREE.BoxHelper.prototype.update=function(object){var geometry=object.geometry;if(geometry.boundingBox===null){geometry.computeBoundingBox()}var min=geometry.boundingBox.min;var max=geometry.boundingBox.max;var vertices=this.vertices;vertices[0].set(max.x,max.y,max.z);vertices[1].set(min.x,max.y,max.z);vertices[2].set(min.x,min.y,max.z);vertices[3].set(max.x,min.y,max.z);vertices[4].set(max.x,max.y,min.z);vertices[5].set(min.x,max.y,min.z);vertices[6].set(min.x,min.y,min.z);vertices[7].set(max.x,min.y,min.z);this.geometry.computeBoundingSphere();this.geometry.verticesNeedUpdate=true;this.matrixAutoUpdate=false;this.matrixWorld=object.matrixWorld};THREE.CameraHelper=function(camera){THREE.Line.call(this);var geometry=new THREE.Geometry;var material=new THREE.LineBasicMaterial({color:16777215,vertexColors:THREE.FaceColors});var pointMap={};var hexFrustum=16755200;var hexCone=16711680;var hexUp=43775;var hexTarget=16777215;var hexCross=3355443;addLine("n1","n2",hexFrustum);addLine("n2","n4",hexFrustum);addLine("n4","n3",hexFrustum);addLine("n3","n1",hexFrustum);addLine("f1","f2",hexFrustum);addLine("f2","f4",hexFrustum);addLine("f4","f3",hexFrustum);addLine("f3","f1",hexFrustum);addLine("n1","f1",hexFrustum);addLine("n2","f2",hexFrustum);addLine("n3","f3",hexFrustum);addLine("n4","f4",hexFrustum);addLine("p","n1",hexCone);addLine("p","n2",hexCone);addLine("p","n3",hexCone);addLine("p","n4",hexCone);addLine("u1","u2",hexUp);addLine("u2","u3",hexUp);addLine("u3","u1",hexUp);addLine("c","t",hexTarget);addLine("p","c",hexCross);addLine("cn1","cn2",hexCross);addLine("cn3","cn4",hexCross);addLine("cf1","cf2",hexCross);addLine("cf3","cf4",hexCross);function addLine(a,b,hex){addPoint(a,hex);addPoint(b,hex)}function addPoint(id,hex){geometry.vertices.push(new THREE.Vector3);geometry.colors.push(new THREE.Color(hex));if(pointMap[id]===undefined){pointMap[id]=[]}pointMap[id].push(geometry.vertices.length-1)}THREE.Line.call(this,geometry,material,THREE.LinePieces);this.camera=camera;this.matrixWorld=camera.matrixWorld;this.matrixAutoUpdate=false;this.pointMap=pointMap;this.update()};THREE.CameraHelper.prototype=Object.create(THREE.Line.prototype);THREE.CameraHelper.prototype.update=function(){var vector=new THREE.Vector3;var camera=new THREE.Camera;var projector=new THREE.Projector;return function(){var scope=this;var w=1,h=1;camera.projectionMatrix.copy(this.camera.projectionMatrix);setPoint("c",0,0,-1);setPoint("t",0,0,1);setPoint("n1",-w,-h,-1);setPoint("n2",w,-h,-1);setPoint("n3",-w,h,-1);setPoint("n4",w,h,-1);setPoint("f1",-w,-h,1);setPoint("f2",w,-h,1);setPoint("f3",-w,h,1);setPoint("f4",w,h,1);setPoint("u1",w*.7,h*1.1,-1);setPoint("u2",-w*.7,h*1.1,-1);setPoint("u3",0,h*2,-1);setPoint("cf1",-w,0,1);setPoint("cf2",w,0,1);setPoint("cf3",0,-h,1);setPoint("cf4",0,h,1);setPoint("cn1",-w,0,-1);setPoint("cn2",w,0,-1);setPoint("cn3",0,-h,-1);setPoint("cn4",0,h,-1);function setPoint(point,x,y,z){vector.set(x,y,z);projector.unprojectVector(vector,camera);var points=scope.pointMap[point];if(points!==undefined){for(var i=0,il=points.length;i<il;i++){scope.geometry.vertices[points[i]].copy(vector)}}}this.geometry.verticesNeedUpdate=true}}();THREE.DirectionalLightHelper=function(light,sphereSize){THREE.Object3D.call(this);this.matrixAutoUpdate=false;this.light=light;var geometry=new THREE.SphereGeometry(sphereSize,4,2);var material=new THREE.MeshBasicMaterial({fog:false,wireframe:true});material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightSphere=new THREE.Mesh(geometry,material);this.lightSphere.matrixWorld=this.light.matrixWorld;this.lightSphere.matrixAutoUpdate=false;this.add(this.lightSphere);geometry=new THREE.Geometry;geometry.vertices.push(this.light.position);geometry.vertices.push(this.light.target.position);geometry.computeLineDistances();material=new THREE.LineDashedMaterial({dashSize:4,gapSize:4,opacity:.75,transparent:true,fog:false});material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.targetLine=new THREE.Line(geometry,material);this.add(this.targetLine)};THREE.DirectionalLightHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.DirectionalLightHelper.prototype.update=function(){this.lightSphere.material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.targetLine.geometry.computeLineDistances();this.targetLine.geometry.verticesNeedUpdate=true;this.targetLine.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)};THREE.FaceNormalsHelper=function(object,size,hex){this.object=object;this.size=size||1;var color=hex||255;var geometry=new THREE.Geometry;var faces=this.object.geometry.faces;for(var i=0,l=faces.length;i<l;i++){geometry.vertices.push(new THREE.Vector3);geometry.vertices.push(new THREE.Vector3)}THREE.Line.call(this,geometry,new THREE.LineBasicMaterial({color:color}),THREE.LinePieces);this.matrixAutoUpdate=false;this.normalMatrix=new THREE.Matrix3;this.update()};THREE.FaceNormalsHelper.prototype=Object.create(THREE.Line.prototype);THREE.FaceNormalsHelper.prototype.update=function(object){var v1=new THREE.Vector3;return function(object){this.object.updateMatrixWorld(true);this.normalMatrix.getNormalMatrix(this.object.matrixWorld);var vertices=this.geometry.vertices;var faces=this.object.geometry.faces;for(var i=0,l=faces.length;i<l;i++){var face=faces[i];v1.copy(face.normal).applyMatrix3(this.normalMatrix).normalize().multiplyScalar(this.size);var idx=2*i;vertices[idx].copy(face.centroid).applyMatrix4(this.object.matrixWorld);vertices[idx+1].addVectors(vertices[idx],v1)}this.geometry.verticesNeedUpdate=true;return this}}();THREE.GridHelper=function(size,step){var geometry=new THREE.Geometry;var material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});var color1=new THREE.Color(4473924),color2=new THREE.Color(8947848);for(var i=-size;i<=size;i+=step){geometry.vertices.push(new THREE.Vector3(-size,0,i),new THREE.Vector3(size,0,i),new THREE.Vector3(i,0,-size),new THREE.Vector3(i,0,size));var color=i===0?color1:color2;geometry.colors.push(color,color,color,color)}THREE.Line.call(this,geometry,material,THREE.LinePieces)};THREE.GridHelper.prototype=Object.create(THREE.Line.prototype);THREE.HemisphereLightHelper=function(light,sphereSize,arrowLength,domeSize){THREE.Object3D.call(this);this.light=light;var geometry=new THREE.SphereGeometry(sphereSize,4,2);geometry.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));for(var i=0,il=8;i<il;i++){geometry.faces[i].materialIndex=i<4?0:1}var materialSky=new THREE.MeshBasicMaterial({fog:false,wireframe:true});materialSky.color.copy(light.color).multiplyScalar(light.intensity);var materialGround=new THREE.MeshBasicMaterial({fog:false,wireframe:true});materialGround.color.copy(light.groundColor).multiplyScalar(light.intensity);this.lightSphere=new THREE.Mesh(geometry,new THREE.MeshFaceMaterial([materialSky,materialGround]));this.lightSphere.position=light.position;this.lightSphere.lookAt(new THREE.Vector3);this.add(this.lightSphere)};THREE.HemisphereLightHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.HemisphereLightHelper.prototype.update=function(){this.lightSphere.lookAt(new THREE.Vector3);this.lightSphere.material.materials[0].color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightSphere.material.materials[1].color.copy(this.light.groundColor).multiplyScalar(this.light.intensity)};THREE.PointLightHelper=function(light,sphereSize){THREE.Object3D.call(this);this.matrixAutoUpdate=false;this.light=light;var geometry=new THREE.SphereGeometry(sphereSize,4,2);var material=new THREE.MeshBasicMaterial({fog:false,wireframe:true});material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightSphere=new THREE.Mesh(geometry,material);this.lightSphere.matrixWorld=this.light.matrixWorld;this.lightSphere.matrixAutoUpdate=false;this.add(this.lightSphere)};THREE.PointLightHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.PointLightHelper.prototype.update=function(){this.lightSphere.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)};THREE.SpotLightHelper=function(light,sphereSize){THREE.Object3D.call(this);this.matrixAutoUpdate=false;this.light=light;var geometry=new THREE.SphereGeometry(sphereSize,4,2);var material=new THREE.MeshBasicMaterial({fog:false,wireframe:true});material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightSphere=new THREE.Mesh(geometry,material);this.lightSphere.matrixWorld=this.light.matrixWorld;this.lightSphere.matrixAutoUpdate=false;this.add(this.lightSphere);geometry=new THREE.CylinderGeometry(1e-4,1,1,8,1,true);geometry.applyMatrix((new THREE.Matrix4).makeTranslation(0,-.5,0));geometry.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));material=new THREE.MeshBasicMaterial({fog:false,wireframe:true,opacity:.3,transparent:true});material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightCone=new THREE.Mesh(geometry,material);this.lightCone.position=this.light.position;var coneLength=light.distance?light.distance:1e4;var coneWidth=coneLength*Math.tan(light.angle);this.lightCone.scale.set(coneWidth,coneWidth,coneLength);this.lightCone.lookAt(this.light.target.position);this.add(this.lightCone)};THREE.SpotLightHelper.prototype=Object.create(THREE.Object3D.prototype);THREE.SpotLightHelper.prototype.update=function(){var coneLength=this.light.distance?this.light.distance:1e4;var coneWidth=coneLength*Math.tan(this.light.angle);this.lightCone.scale.set(coneWidth,coneWidth,coneLength);this.lightCone.lookAt(this.light.target.position);this.lightSphere.material.color.copy(this.light.color).multiplyScalar(this.light.intensity);this.lightCone.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)};THREE.VertexNormalsHelper=function(object,size,hex){this.object=object;this.size=size||1;var color=hex||16711680;var geometry=new THREE.Geometry;var vertices=object.geometry.vertices;var faces=object.geometry.faces;for(var i=0,l=faces.length;i<l;i++){var face=faces[i];for(var j=0,jl=face.vertexNormals.length;j<jl;j++){geometry.vertices.push(new THREE.Vector3);geometry.vertices.push(new THREE.Vector3)}}THREE.Line.call(this,geometry,new THREE.LineBasicMaterial({color:color}),THREE.LinePieces);this.matrixAutoUpdate=false;this.normalMatrix=new THREE.Matrix3;this.update()};THREE.VertexNormalsHelper.prototype=Object.create(THREE.Line.prototype);THREE.VertexNormalsHelper.prototype.update=function(object){var v1=new THREE.Vector3;return function(object){var keys=["a","b","c","d"];this.object.updateMatrixWorld(true);this.normalMatrix.getNormalMatrix(this.object.matrixWorld);var vertices=this.geometry.vertices;var verts=this.object.geometry.vertices;var faces=this.object.geometry.faces;var idx=0;for(var i=0,l=faces.length;i<l;i++){var face=faces[i];for(var j=0,jl=face.vertexNormals.length;j<jl;j++){var vertexId=face[keys[j]];var vertex=verts[vertexId];var normal=face.vertexNormals[j];vertices[idx].copy(vertex).applyMatrix4(this.object.matrixWorld);v1.copy(normal).applyMatrix3(this.normalMatrix).normalize().multiplyScalar(this.size);v1.add(vertices[idx]);idx=idx+1;vertices[idx].copy(v1);idx=idx+1}}this.geometry.verticesNeedUpdate=true;return this}}();THREE.WireframeHelper=function(object){var edge=[0,0],hash={};var sortFunction=function(a,b){return a-b};var keys=["a","b","c","d"];var geometry=new THREE.Geometry;var vertices=object.geometry.vertices;var faces=object.geometry.faces;for(var i=0,l=faces.length;i<l;i++){var face=faces[i];var length=face instanceof THREE.Face4?4:3;for(var j=0;j<length;j++){edge[0]=face[keys[j]];edge[1]=face[keys[(j+1)%length]];edge.sort(sortFunction);var key=edge.toString();if(hash[key]===undefined){geometry.vertices.push(vertices[edge[0]]);geometry.vertices.push(vertices[edge[1]]);hash[key]=true}}}THREE.Line.call(this,geometry,new THREE.LineBasicMaterial({color:16777215}),THREE.LinePieces);this.matrixAutoUpdate=false;this.matrixWorld=object.matrixWorld};THREE.WireframeHelper.prototype=Object.create(THREE.Line.prototype);THREE.ImmediateRenderObject=function(){THREE.Object3D.call(this);this.render=function(renderCallback){}};THREE.ImmediateRenderObject.prototype=Object.create(THREE.Object3D.prototype);THREE.LensFlare=function(texture,size,distance,blending,color){THREE.Object3D.call(this);this.lensFlares=[];this.positionScreen=new THREE.Vector3;this.customUpdateCallback=undefined;if(texture!==undefined){this.add(texture,size,distance,blending,color)}};THREE.LensFlare.prototype=Object.create(THREE.Object3D.prototype);THREE.LensFlare.prototype.add=function(texture,size,distance,blending,color,opacity){if(size===undefined)size=-1;if(distance===undefined)distance=0;if(opacity===undefined)opacity=1;if(color===undefined)color=new THREE.Color(16777215);if(blending===undefined)blending=THREE.NormalBlending;distance=Math.min(distance,Math.max(0,distance));this.lensFlares.push({texture:texture,size:size,distance:distance,x:0,y:0,z:0,scale:1,rotation:1,opacity:opacity,color:color,blending:blending})};THREE.LensFlare.prototype.updateLensFlares=function(){var f,fl=this.lensFlares.length;var flare;var vecX=-this.positionScreen.x*2;var vecY=-this.positionScreen.y*2;for(f=0;f<fl;f++){flare=this.lensFlares[f];flare.x=this.positionScreen.x+vecX*flare.distance;flare.y=this.positionScreen.y+vecY*flare.distance;flare.wantedRotation=flare.x*Math.PI*.25;flare.rotation+=(flare.wantedRotation-flare.rotation)*.25}};THREE.MorphBlendMesh=function(geometry,material){THREE.Mesh.call(this,geometry,material);this.animationsMap={};this.animationsList=[];var numFrames=this.geometry.morphTargets.length;var name="__default";var startFrame=0;var endFrame=numFrames-1;var fps=numFrames/1;this.createAnimation(name,startFrame,endFrame,fps);this.setAnimationWeight(name,1)};THREE.MorphBlendMesh.prototype=Object.create(THREE.Mesh.prototype);THREE.MorphBlendMesh.prototype.createAnimation=function(name,start,end,fps){var animation={startFrame:start,endFrame:end,length:end-start+1,fps:fps,duration:(end-start)/fps,lastFrame:0,currentFrame:0,active:false,time:0,direction:1,weight:1,directionBackwards:false,mirroredLoop:false};this.animationsMap[name]=animation;this.animationsList.push(animation)};THREE.MorphBlendMesh.prototype.autoCreateAnimations=function(fps){var pattern=/([a-z]+)(\d+)/;var firstAnimation,frameRanges={};var geometry=this.geometry;for(var i=0,il=geometry.morphTargets.length;i<il;i++){var morph=geometry.morphTargets[i];var chunks=morph.name.match(pattern);if(chunks&&chunks.length>1){var name=chunks[1];var num=chunks[2];if(!frameRanges[name])frameRanges[name]={start:Infinity,end:-Infinity};var range=frameRanges[name];if(i<range.start)range.start=i;if(i>range.end)range.end=i;if(!firstAnimation)firstAnimation=name}}for(var name in frameRanges){var range=frameRanges[name];this.createAnimation(name,range.start,range.end,fps)}this.firstAnimation=firstAnimation};THREE.MorphBlendMesh.prototype.setAnimationDirectionForward=function(name){var animation=this.animationsMap[name];if(animation){animation.direction=1;animation.directionBackwards=false}};THREE.MorphBlendMesh.prototype.setAnimationDirectionBackward=function(name){var animation=this.animationsMap[name];if(animation){animation.direction=-1;animation.directionBackwards=true}};THREE.MorphBlendMesh.prototype.setAnimationFPS=function(name,fps){var animation=this.animationsMap[name];if(animation){animation.fps=fps;animation.duration=(animation.end-animation.start)/animation.fps
}};THREE.MorphBlendMesh.prototype.setAnimationDuration=function(name,duration){var animation=this.animationsMap[name];if(animation){animation.duration=duration;animation.fps=(animation.end-animation.start)/animation.duration}};THREE.MorphBlendMesh.prototype.setAnimationWeight=function(name,weight){var animation=this.animationsMap[name];if(animation){animation.weight=weight}};THREE.MorphBlendMesh.prototype.setAnimationTime=function(name,time){var animation=this.animationsMap[name];if(animation){animation.time=time}};THREE.MorphBlendMesh.prototype.getAnimationTime=function(name){var time=0;var animation=this.animationsMap[name];if(animation){time=animation.time}return time};THREE.MorphBlendMesh.prototype.getAnimationDuration=function(name){var duration=-1;var animation=this.animationsMap[name];if(animation){duration=animation.duration}return duration};THREE.MorphBlendMesh.prototype.playAnimation=function(name){var animation=this.animationsMap[name];if(animation){animation.time=0;animation.active=true}else{console.warn("animation["+name+"] undefined")}};THREE.MorphBlendMesh.prototype.stopAnimation=function(name){var animation=this.animationsMap[name];if(animation){animation.active=false}};THREE.MorphBlendMesh.prototype.update=function(delta){for(var i=0,il=this.animationsList.length;i<il;i++){var animation=this.animationsList[i];if(!animation.active)continue;var frameTime=animation.duration/animation.length;animation.time+=animation.direction*delta;if(animation.mirroredLoop){if(animation.time>animation.duration||animation.time<0){animation.direction*=-1;if(animation.time>animation.duration){animation.time=animation.duration;animation.directionBackwards=true}if(animation.time<0){animation.time=0;animation.directionBackwards=false}}}else{animation.time=animation.time%animation.duration;if(animation.time<0)animation.time+=animation.duration}var keyframe=animation.startFrame+THREE.Math.clamp(Math.floor(animation.time/frameTime),0,animation.length-1);var weight=animation.weight;if(keyframe!==animation.currentFrame){this.morphTargetInfluences[animation.lastFrame]=0;this.morphTargetInfluences[animation.currentFrame]=1*weight;this.morphTargetInfluences[keyframe]=0;animation.lastFrame=animation.currentFrame;animation.currentFrame=keyframe}var mix=animation.time%frameTime/frameTime;if(animation.directionBackwards)mix=1-mix;this.morphTargetInfluences[animation.currentFrame]=mix*weight;this.morphTargetInfluences[animation.lastFrame]=(1-mix)*weight}};THREE.LensFlarePlugin=function(){var _gl,_renderer,_precision,_lensFlare={};this.init=function(renderer){_gl=renderer.context;_renderer=renderer;_precision=renderer.getPrecision();_lensFlare.vertices=new Float32Array(8+8);_lensFlare.faces=new Uint16Array(6);var i=0;_lensFlare.vertices[i++]=-1;_lensFlare.vertices[i++]=-1;_lensFlare.vertices[i++]=0;_lensFlare.vertices[i++]=0;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=-1;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=0;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=-1;_lensFlare.vertices[i++]=1;_lensFlare.vertices[i++]=0;_lensFlare.vertices[i++]=1;i=0;_lensFlare.faces[i++]=0;_lensFlare.faces[i++]=1;_lensFlare.faces[i++]=2;_lensFlare.faces[i++]=0;_lensFlare.faces[i++]=2;_lensFlare.faces[i++]=3;_lensFlare.vertexBuffer=_gl.createBuffer();_lensFlare.elementBuffer=_gl.createBuffer();_gl.bindBuffer(_gl.ARRAY_BUFFER,_lensFlare.vertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,_lensFlare.vertices,_gl.STATIC_DRAW);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,_lensFlare.elementBuffer);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,_lensFlare.faces,_gl.STATIC_DRAW);_lensFlare.tempTexture=_gl.createTexture();_lensFlare.occlusionTexture=_gl.createTexture();_gl.bindTexture(_gl.TEXTURE_2D,_lensFlare.tempTexture);_gl.texImage2D(_gl.TEXTURE_2D,0,_gl.RGB,16,16,0,_gl.RGB,_gl.UNSIGNED_BYTE,null);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MAG_FILTER,_gl.NEAREST);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,_gl.NEAREST);_gl.bindTexture(_gl.TEXTURE_2D,_lensFlare.occlusionTexture);_gl.texImage2D(_gl.TEXTURE_2D,0,_gl.RGBA,16,16,0,_gl.RGBA,_gl.UNSIGNED_BYTE,null);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MAG_FILTER,_gl.NEAREST);_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,_gl.NEAREST);if(_gl.getParameter(_gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)<=0){_lensFlare.hasVertexTexture=false;_lensFlare.program=createProgram(THREE.ShaderFlares["lensFlare"],_precision)}else{_lensFlare.hasVertexTexture=true;_lensFlare.program=createProgram(THREE.ShaderFlares["lensFlareVertexTexture"],_precision)}_lensFlare.attributes={};_lensFlare.uniforms={};_lensFlare.attributes.vertex=_gl.getAttribLocation(_lensFlare.program,"position");_lensFlare.attributes.uv=_gl.getAttribLocation(_lensFlare.program,"uv");_lensFlare.uniforms.renderType=_gl.getUniformLocation(_lensFlare.program,"renderType");_lensFlare.uniforms.map=_gl.getUniformLocation(_lensFlare.program,"map");_lensFlare.uniforms.occlusionMap=_gl.getUniformLocation(_lensFlare.program,"occlusionMap");_lensFlare.uniforms.opacity=_gl.getUniformLocation(_lensFlare.program,"opacity");_lensFlare.uniforms.color=_gl.getUniformLocation(_lensFlare.program,"color");_lensFlare.uniforms.scale=_gl.getUniformLocation(_lensFlare.program,"scale");_lensFlare.uniforms.rotation=_gl.getUniformLocation(_lensFlare.program,"rotation");_lensFlare.uniforms.screenPosition=_gl.getUniformLocation(_lensFlare.program,"screenPosition")};this.render=function(scene,camera,viewportWidth,viewportHeight){var flares=scene.__webglFlares,nFlares=flares.length;if(!nFlares)return;var tempPosition=new THREE.Vector3;var invAspect=viewportHeight/viewportWidth,halfViewportWidth=viewportWidth*.5,halfViewportHeight=viewportHeight*.5;var size=16/viewportHeight,scale=new THREE.Vector2(size*invAspect,size);var screenPosition=new THREE.Vector3(1,1,0),screenPositionPixels=new THREE.Vector2(1,1);var uniforms=_lensFlare.uniforms,attributes=_lensFlare.attributes;_gl.useProgram(_lensFlare.program);_gl.enableVertexAttribArray(_lensFlare.attributes.vertex);_gl.enableVertexAttribArray(_lensFlare.attributes.uv);_gl.uniform1i(uniforms.occlusionMap,0);_gl.uniform1i(uniforms.map,1);_gl.bindBuffer(_gl.ARRAY_BUFFER,_lensFlare.vertexBuffer);_gl.vertexAttribPointer(attributes.vertex,2,_gl.FLOAT,false,2*8,0);_gl.vertexAttribPointer(attributes.uv,2,_gl.FLOAT,false,2*8,8);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,_lensFlare.elementBuffer);_gl.disable(_gl.CULL_FACE);_gl.depthMask(false);var i,j,jl,flare,sprite;for(i=0;i<nFlares;i++){size=16/viewportHeight;scale.set(size*invAspect,size);flare=flares[i];tempPosition.set(flare.matrixWorld.elements[12],flare.matrixWorld.elements[13],flare.matrixWorld.elements[14]);tempPosition.applyMatrix4(camera.matrixWorldInverse);tempPosition.applyProjection(camera.projectionMatrix);screenPosition.copy(tempPosition);screenPositionPixels.x=screenPosition.x*halfViewportWidth+halfViewportWidth;screenPositionPixels.y=screenPosition.y*halfViewportHeight+halfViewportHeight;if(_lensFlare.hasVertexTexture||screenPositionPixels.x>0&&screenPositionPixels.x<viewportWidth&&screenPositionPixels.y>0&&screenPositionPixels.y<viewportHeight){_gl.activeTexture(_gl.TEXTURE1);_gl.bindTexture(_gl.TEXTURE_2D,_lensFlare.tempTexture);_gl.copyTexImage2D(_gl.TEXTURE_2D,0,_gl.RGB,screenPositionPixels.x-8,screenPositionPixels.y-8,16,16,0);_gl.uniform1i(uniforms.renderType,0);_gl.uniform2f(uniforms.scale,scale.x,scale.y);_gl.uniform3f(uniforms.screenPosition,screenPosition.x,screenPosition.y,screenPosition.z);_gl.disable(_gl.BLEND);_gl.enable(_gl.DEPTH_TEST);_gl.drawElements(_gl.TRIANGLES,6,_gl.UNSIGNED_SHORT,0);_gl.activeTexture(_gl.TEXTURE0);_gl.bindTexture(_gl.TEXTURE_2D,_lensFlare.occlusionTexture);_gl.copyTexImage2D(_gl.TEXTURE_2D,0,_gl.RGBA,screenPositionPixels.x-8,screenPositionPixels.y-8,16,16,0);_gl.uniform1i(uniforms.renderType,1);_gl.disable(_gl.DEPTH_TEST);_gl.activeTexture(_gl.TEXTURE1);_gl.bindTexture(_gl.TEXTURE_2D,_lensFlare.tempTexture);_gl.drawElements(_gl.TRIANGLES,6,_gl.UNSIGNED_SHORT,0);flare.positionScreen.copy(screenPosition);if(flare.customUpdateCallback){flare.customUpdateCallback(flare)}else{flare.updateLensFlares()}_gl.uniform1i(uniforms.renderType,2);_gl.enable(_gl.BLEND);for(j=0,jl=flare.lensFlares.length;j<jl;j++){sprite=flare.lensFlares[j];if(sprite.opacity>.001&&sprite.scale>.001){screenPosition.x=sprite.x;screenPosition.y=sprite.y;screenPosition.z=sprite.z;size=sprite.size*sprite.scale/viewportHeight;scale.x=size*invAspect;scale.y=size;_gl.uniform3f(uniforms.screenPosition,screenPosition.x,screenPosition.y,screenPosition.z);_gl.uniform2f(uniforms.scale,scale.x,scale.y);_gl.uniform1f(uniforms.rotation,sprite.rotation);_gl.uniform1f(uniforms.opacity,sprite.opacity);_gl.uniform3f(uniforms.color,sprite.color.r,sprite.color.g,sprite.color.b);_renderer.setBlending(sprite.blending,sprite.blendEquation,sprite.blendSrc,sprite.blendDst);_renderer.setTexture(sprite.texture,1);_gl.drawElements(_gl.TRIANGLES,6,_gl.UNSIGNED_SHORT,0)}}}}_gl.enable(_gl.CULL_FACE);_gl.enable(_gl.DEPTH_TEST);_gl.depthMask(true)};function createProgram(shader,precision){var program=_gl.createProgram();var fragmentShader=_gl.createShader(_gl.FRAGMENT_SHADER);var vertexShader=_gl.createShader(_gl.VERTEX_SHADER);var prefix="precision "+precision+" float;\n";_gl.shaderSource(fragmentShader,prefix+shader.fragmentShader);_gl.shaderSource(vertexShader,prefix+shader.vertexShader);_gl.compileShader(fragmentShader);_gl.compileShader(vertexShader);_gl.attachShader(program,fragmentShader);_gl.attachShader(program,vertexShader);_gl.linkProgram(program);return program}};THREE.ShadowMapPlugin=function(){var _gl,_renderer,_depthMaterial,_depthMaterialMorph,_depthMaterialSkin,_depthMaterialMorphSkin,_frustum=new THREE.Frustum,_projScreenMatrix=new THREE.Matrix4,_min=new THREE.Vector3,_max=new THREE.Vector3,_matrixPosition=new THREE.Vector3;this.init=function(renderer){_gl=renderer.context;_renderer=renderer;var depthShader=THREE.ShaderLib["depthRGBA"];var depthUniforms=THREE.UniformsUtils.clone(depthShader.uniforms);_depthMaterial=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms});_depthMaterialMorph=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,morphTargets:true});_depthMaterialSkin=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,skinning:true});_depthMaterialMorphSkin=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,morphTargets:true,skinning:true});_depthMaterial._shadowPass=true;_depthMaterialMorph._shadowPass=true;_depthMaterialSkin._shadowPass=true;_depthMaterialMorphSkin._shadowPass=true};this.render=function(scene,camera){if(!(_renderer.shadowMapEnabled&&_renderer.shadowMapAutoUpdate))return;this.update(scene,camera)};this.update=function(scene,camera){var i,il,j,jl,n,shadowMap,shadowMatrix,shadowCamera,program,buffer,material,webglObject,object,light,renderList,lights=[],k=0,fog=null;_gl.clearColor(1,1,1,1);_gl.disable(_gl.BLEND);_gl.enable(_gl.CULL_FACE);_gl.frontFace(_gl.CCW);if(_renderer.shadowMapCullFace===THREE.CullFaceFront){_gl.cullFace(_gl.FRONT)}else{_gl.cullFace(_gl.BACK)}_renderer.setDepthTest(true);for(i=0,il=scene.__lights.length;i<il;i++){light=scene.__lights[i];if(!light.castShadow)continue;if(light instanceof THREE.DirectionalLight&&light.shadowCascade){for(n=0;n<light.shadowCascadeCount;n++){var virtualLight;if(!light.shadowCascadeArray[n]){virtualLight=createVirtualLight(light,n);virtualLight.originalCamera=camera;var gyro=new THREE.Gyroscope;gyro.position=light.shadowCascadeOffset;gyro.add(virtualLight);gyro.add(virtualLight.target);camera.add(gyro);light.shadowCascadeArray[n]=virtualLight;console.log("Created virtualLight",virtualLight)}else{virtualLight=light.shadowCascadeArray[n]}updateVirtualLight(light,n);lights[k]=virtualLight;k++}}else{lights[k]=light;k++}}for(i=0,il=lights.length;i<il;i++){light=lights[i];if(!light.shadowMap){var shadowFilter=THREE.LinearFilter;if(_renderer.shadowMapType===THREE.PCFSoftShadowMap){shadowFilter=THREE.NearestFilter}var pars={minFilter:shadowFilter,magFilter:shadowFilter,format:THREE.RGBAFormat};light.shadowMap=new THREE.WebGLRenderTarget(light.shadowMapWidth,light.shadowMapHeight,pars);light.shadowMapSize=new THREE.Vector2(light.shadowMapWidth,light.shadowMapHeight);light.shadowMatrix=new THREE.Matrix4}if(!light.shadowCamera){if(light instanceof THREE.SpotLight){light.shadowCamera=new THREE.PerspectiveCamera(light.shadowCameraFov,light.shadowMapWidth/light.shadowMapHeight,light.shadowCameraNear,light.shadowCameraFar)}else if(light instanceof THREE.DirectionalLight){light.shadowCamera=new THREE.OrthographicCamera(light.shadowCameraLeft,light.shadowCameraRight,light.shadowCameraTop,light.shadowCameraBottom,light.shadowCameraNear,light.shadowCameraFar)}else{console.error("Unsupported light type for shadow");continue}scene.add(light.shadowCamera);if(scene.autoUpdate===true)scene.updateMatrixWorld()}if(light.shadowCameraVisible&&!light.cameraHelper){light.cameraHelper=new THREE.CameraHelper(light.shadowCamera);light.shadowCamera.add(light.cameraHelper)}if(light.isVirtual&&virtualLight.originalCamera==camera){updateShadowCamera(camera,light)}shadowMap=light.shadowMap;shadowMatrix=light.shadowMatrix;shadowCamera=light.shadowCamera;shadowCamera.position.getPositionFromMatrix(light.matrixWorld);_matrixPosition.getPositionFromMatrix(light.target.matrixWorld);shadowCamera.lookAt(_matrixPosition);shadowCamera.updateMatrixWorld();shadowCamera.matrixWorldInverse.getInverse(shadowCamera.matrixWorld);if(light.cameraHelper)light.cameraHelper.visible=light.shadowCameraVisible;if(light.shadowCameraVisible)light.cameraHelper.update();shadowMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1);shadowMatrix.multiply(shadowCamera.projectionMatrix);shadowMatrix.multiply(shadowCamera.matrixWorldInverse);_projScreenMatrix.multiplyMatrices(shadowCamera.projectionMatrix,shadowCamera.matrixWorldInverse);_frustum.setFromMatrix(_projScreenMatrix);_renderer.setRenderTarget(shadowMap);_renderer.clear();renderList=scene.__webglObjects;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];object=webglObject.object;webglObject.render=false;if(object.visible&&object.castShadow){if(!(object instanceof THREE.Mesh||object instanceof THREE.ParticleSystem)||!object.frustumCulled||_frustum.intersectsObject(object)){object._modelViewMatrix.multiplyMatrices(shadowCamera.matrixWorldInverse,object.matrixWorld);webglObject.render=true}}}var objectMaterial,useMorphing,useSkinning;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];if(webglObject.render){object=webglObject.object;buffer=webglObject.buffer;objectMaterial=getObjectMaterial(object);useMorphing=object.geometry.morphTargets.length>0&&objectMaterial.morphTargets;useSkinning=object instanceof THREE.SkinnedMesh&&objectMaterial.skinning;if(object.customDepthMaterial){material=object.customDepthMaterial}else if(useSkinning){material=useMorphing?_depthMaterialMorphSkin:_depthMaterialSkin}else if(useMorphing){material=_depthMaterialMorph}else{material=_depthMaterial}if(buffer instanceof THREE.BufferGeometry){_renderer.renderBufferDirect(shadowCamera,scene.__lights,fog,material,buffer,object)}else{_renderer.renderBuffer(shadowCamera,scene.__lights,fog,material,buffer,object)}}}renderList=scene.__webglObjectsImmediate;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];object=webglObject.object;if(object.visible&&object.castShadow){object._modelViewMatrix.multiplyMatrices(shadowCamera.matrixWorldInverse,object.matrixWorld);_renderer.renderImmediateObject(shadowCamera,scene.__lights,fog,_depthMaterial,object)}}}var clearColor=_renderer.getClearColor(),clearAlpha=_renderer.getClearAlpha();_gl.clearColor(clearColor.r,clearColor.g,clearColor.b,clearAlpha);_gl.enable(_gl.BLEND);if(_renderer.shadowMapCullFace===THREE.CullFaceFront){_gl.cullFace(_gl.BACK)}};function createVirtualLight(light,cascade){var virtualLight=new THREE.DirectionalLight;virtualLight.isVirtual=true;virtualLight.onlyShadow=true;virtualLight.castShadow=true;virtualLight.shadowCameraNear=light.shadowCameraNear;virtualLight.shadowCameraFar=light.shadowCameraFar;virtualLight.shadowCameraLeft=light.shadowCameraLeft;virtualLight.shadowCameraRight=light.shadowCameraRight;virtualLight.shadowCameraBottom=light.shadowCameraBottom;virtualLight.shadowCameraTop=light.shadowCameraTop;virtualLight.shadowCameraVisible=light.shadowCameraVisible;virtualLight.shadowDarkness=light.shadowDarkness;virtualLight.shadowBias=light.shadowCascadeBias[cascade];virtualLight.shadowMapWidth=light.shadowCascadeWidth[cascade];virtualLight.shadowMapHeight=light.shadowCascadeHeight[cascade];virtualLight.pointsWorld=[];virtualLight.pointsFrustum=[];var pointsWorld=virtualLight.pointsWorld,pointsFrustum=virtualLight.pointsFrustum;for(var i=0;i<8;i++){pointsWorld[i]=new THREE.Vector3;pointsFrustum[i]=new THREE.Vector3}var nearZ=light.shadowCascadeNearZ[cascade];var farZ=light.shadowCascadeFarZ[cascade];pointsFrustum[0].set(-1,-1,nearZ);pointsFrustum[1].set(1,-1,nearZ);pointsFrustum[2].set(-1,1,nearZ);pointsFrustum[3].set(1,1,nearZ);pointsFrustum[4].set(-1,-1,farZ);pointsFrustum[5].set(1,-1,farZ);pointsFrustum[6].set(-1,1,farZ);pointsFrustum[7].set(1,1,farZ);return virtualLight}function updateVirtualLight(light,cascade){var virtualLight=light.shadowCascadeArray[cascade];virtualLight.position.copy(light.position);virtualLight.target.position.copy(light.target.position);virtualLight.lookAt(virtualLight.target);virtualLight.shadowCameraVisible=light.shadowCameraVisible;virtualLight.shadowDarkness=light.shadowDarkness;virtualLight.shadowBias=light.shadowCascadeBias[cascade];var nearZ=light.shadowCascadeNearZ[cascade];var farZ=light.shadowCascadeFarZ[cascade];var pointsFrustum=virtualLight.pointsFrustum;pointsFrustum[0].z=nearZ;pointsFrustum[1].z=nearZ;pointsFrustum[2].z=nearZ;pointsFrustum[3].z=nearZ;pointsFrustum[4].z=farZ;pointsFrustum[5].z=farZ;pointsFrustum[6].z=farZ;pointsFrustum[7].z=farZ}function updateShadowCamera(camera,light){var shadowCamera=light.shadowCamera,pointsFrustum=light.pointsFrustum,pointsWorld=light.pointsWorld;_min.set(Infinity,Infinity,Infinity);_max.set(-Infinity,-Infinity,-Infinity);for(var i=0;i<8;i++){var p=pointsWorld[i];p.copy(pointsFrustum[i]);THREE.ShadowMapPlugin.__projector.unprojectVector(p,camera);p.applyMatrix4(shadowCamera.matrixWorldInverse);if(p.x<_min.x)_min.x=p.x;if(p.x>_max.x)_max.x=p.x;if(p.y<_min.y)_min.y=p.y;if(p.y>_max.y)_max.y=p.y;if(p.z<_min.z)_min.z=p.z;if(p.z>_max.z)_max.z=p.z}shadowCamera.left=_min.x;shadowCamera.right=_max.x;shadowCamera.top=_max.y;shadowCamera.bottom=_min.y;shadowCamera.updateProjectionMatrix()}function getObjectMaterial(object){return object.material instanceof THREE.MeshFaceMaterial?object.material.materials[0]:object.material}};THREE.ShadowMapPlugin.__projector=new THREE.Projector;THREE.SpritePlugin=function(){var _gl,_renderer,_precision,_sprite={};this.init=function(renderer){_gl=renderer.context;_renderer=renderer;_precision=renderer.getPrecision();_sprite.vertices=new Float32Array(8+8);_sprite.faces=new Uint16Array(6);var i=0;_sprite.vertices[i++]=-1;_sprite.vertices[i++]=-1;_sprite.vertices[i++]=0;_sprite.vertices[i++]=0;_sprite.vertices[i++]=1;_sprite.vertices[i++]=-1;_sprite.vertices[i++]=1;_sprite.vertices[i++]=0;_sprite.vertices[i++]=1;_sprite.vertices[i++]=1;_sprite.vertices[i++]=1;_sprite.vertices[i++]=1;_sprite.vertices[i++]=-1;_sprite.vertices[i++]=1;_sprite.vertices[i++]=0;_sprite.vertices[i++]=1;i=0;_sprite.faces[i++]=0;_sprite.faces[i++]=1;_sprite.faces[i++]=2;_sprite.faces[i++]=0;_sprite.faces[i++]=2;_sprite.faces[i++]=3;_sprite.vertexBuffer=_gl.createBuffer();_sprite.elementBuffer=_gl.createBuffer();_gl.bindBuffer(_gl.ARRAY_BUFFER,_sprite.vertexBuffer);_gl.bufferData(_gl.ARRAY_BUFFER,_sprite.vertices,_gl.STATIC_DRAW);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,_sprite.elementBuffer);_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,_sprite.faces,_gl.STATIC_DRAW);_sprite.program=createProgram(THREE.ShaderSprite["sprite"],_precision);_sprite.attributes={};_sprite.uniforms={};_sprite.attributes.position=_gl.getAttribLocation(_sprite.program,"position");_sprite.attributes.uv=_gl.getAttribLocation(_sprite.program,"uv");_sprite.uniforms.uvOffset=_gl.getUniformLocation(_sprite.program,"uvOffset");_sprite.uniforms.uvScale=_gl.getUniformLocation(_sprite.program,"uvScale");_sprite.uniforms.rotation=_gl.getUniformLocation(_sprite.program,"rotation");_sprite.uniforms.scale=_gl.getUniformLocation(_sprite.program,"scale");_sprite.uniforms.alignment=_gl.getUniformLocation(_sprite.program,"alignment");_sprite.uniforms.color=_gl.getUniformLocation(_sprite.program,"color");_sprite.uniforms.map=_gl.getUniformLocation(_sprite.program,"map");_sprite.uniforms.opacity=_gl.getUniformLocation(_sprite.program,"opacity");_sprite.uniforms.useScreenCoordinates=_gl.getUniformLocation(_sprite.program,"useScreenCoordinates");_sprite.uniforms.sizeAttenuation=_gl.getUniformLocation(_sprite.program,"sizeAttenuation");_sprite.uniforms.screenPosition=_gl.getUniformLocation(_sprite.program,"screenPosition");_sprite.uniforms.modelViewMatrix=_gl.getUniformLocation(_sprite.program,"modelViewMatrix");_sprite.uniforms.projectionMatrix=_gl.getUniformLocation(_sprite.program,"projectionMatrix");_sprite.uniforms.fogType=_gl.getUniformLocation(_sprite.program,"fogType");_sprite.uniforms.fogDensity=_gl.getUniformLocation(_sprite.program,"fogDensity");_sprite.uniforms.fogNear=_gl.getUniformLocation(_sprite.program,"fogNear");_sprite.uniforms.fogFar=_gl.getUniformLocation(_sprite.program,"fogFar");_sprite.uniforms.fogColor=_gl.getUniformLocation(_sprite.program,"fogColor");_sprite.uniforms.alphaTest=_gl.getUniformLocation(_sprite.program,"alphaTest")};this.render=function(scene,camera,viewportWidth,viewportHeight){var sprites=scene.__webglSprites,nSprites=sprites.length;if(!nSprites)return;var attributes=_sprite.attributes,uniforms=_sprite.uniforms;var invAspect=viewportHeight/viewportWidth;var halfViewportWidth=viewportWidth*.5,halfViewportHeight=viewportHeight*.5;_gl.useProgram(_sprite.program);_gl.enableVertexAttribArray(attributes.position);_gl.enableVertexAttribArray(attributes.uv);_gl.disable(_gl.CULL_FACE);_gl.enable(_gl.BLEND);_gl.bindBuffer(_gl.ARRAY_BUFFER,_sprite.vertexBuffer);_gl.vertexAttribPointer(attributes.position,2,_gl.FLOAT,false,2*8,0);_gl.vertexAttribPointer(attributes.uv,2,_gl.FLOAT,false,2*8,8);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,_sprite.elementBuffer);_gl.uniformMatrix4fv(uniforms.projectionMatrix,false,camera.projectionMatrix.elements);_gl.activeTexture(_gl.TEXTURE0);_gl.uniform1i(uniforms.map,0);var oldFogType=0;var sceneFogType=0;var fog=scene.fog;if(fog){_gl.uniform3f(uniforms.fogColor,fog.color.r,fog.color.g,fog.color.b);if(fog instanceof THREE.Fog){_gl.uniform1f(uniforms.fogNear,fog.near);_gl.uniform1f(uniforms.fogFar,fog.far);_gl.uniform1i(uniforms.fogType,1);oldFogType=1;sceneFogType=1}else if(fog instanceof THREE.FogExp2){_gl.uniform1f(uniforms.fogDensity,fog.density);_gl.uniform1i(uniforms.fogType,2);oldFogType=2;sceneFogType=2}}else{_gl.uniform1i(uniforms.fogType,0);oldFogType=0;sceneFogType=0}var i,sprite,material,screenPosition,size,fogType,scale=[];for(i=0;i<nSprites;i++){sprite=sprites[i];material=sprite.material;if(!sprite.visible||material.opacity===0)continue;if(!material.useScreenCoordinates){sprite._modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,sprite.matrixWorld);sprite.z=-sprite._modelViewMatrix.elements[14]}else{sprite.z=-sprite.position.z}}sprites.sort(painterSortStable);for(i=0;i<nSprites;i++){sprite=sprites[i];material=sprite.material;if(!sprite.visible||material.opacity===0)continue;if(material.map&&material.map.image&&material.map.image.width){_gl.uniform1f(uniforms.alphaTest,material.alphaTest);if(material.useScreenCoordinates===true){_gl.uniform1i(uniforms.useScreenCoordinates,1);_gl.uniform3f(uniforms.screenPosition,(sprite.position.x*_renderer.devicePixelRatio-halfViewportWidth)/halfViewportWidth,(halfViewportHeight-sprite.position.y*_renderer.devicePixelRatio)/halfViewportHeight,Math.max(0,Math.min(1,sprite.position.z)));scale[0]=_renderer.devicePixelRatio;scale[1]=_renderer.devicePixelRatio}else{_gl.uniform1i(uniforms.useScreenCoordinates,0);_gl.uniform1i(uniforms.sizeAttenuation,material.sizeAttenuation?1:0);_gl.uniformMatrix4fv(uniforms.modelViewMatrix,false,sprite._modelViewMatrix.elements);scale[0]=1;scale[1]=1}if(scene.fog&&material.fog){fogType=sceneFogType}else{fogType=0}if(oldFogType!==fogType){_gl.uniform1i(uniforms.fogType,fogType);oldFogType=fogType}size=1/(material.scaleByViewport?viewportHeight:1);scale[0]*=size*invAspect*sprite.scale.x;scale[1]*=size*sprite.scale.y;_gl.uniform2f(uniforms.uvScale,material.uvScale.x,material.uvScale.y);_gl.uniform2f(uniforms.uvOffset,material.uvOffset.x,material.uvOffset.y);_gl.uniform2f(uniforms.alignment,material.alignment.x,material.alignment.y);_gl.uniform1f(uniforms.opacity,material.opacity);_gl.uniform3f(uniforms.color,material.color.r,material.color.g,material.color.b);_gl.uniform1f(uniforms.rotation,sprite.rotation);_gl.uniform2fv(uniforms.scale,scale);_renderer.setBlending(material.blending,material.blendEquation,material.blendSrc,material.blendDst);_renderer.setDepthTest(material.depthTest);_renderer.setDepthWrite(material.depthWrite);_renderer.setTexture(material.map,0);_gl.drawElements(_gl.TRIANGLES,6,_gl.UNSIGNED_SHORT,0)}}_gl.enable(_gl.CULL_FACE)};function createProgram(shader,precision){var program=_gl.createProgram();var fragmentShader=_gl.createShader(_gl.FRAGMENT_SHADER);var vertexShader=_gl.createShader(_gl.VERTEX_SHADER);var prefix="precision "+precision+" float;\n";_gl.shaderSource(fragmentShader,prefix+shader.fragmentShader);_gl.shaderSource(vertexShader,prefix+shader.vertexShader);_gl.compileShader(fragmentShader);_gl.compileShader(vertexShader);_gl.attachShader(program,fragmentShader);_gl.attachShader(program,vertexShader);_gl.linkProgram(program);return program}function painterSortStable(a,b){if(a.z!==b.z){return b.z-a.z}else{return b.id-a.id}}};THREE.DepthPassPlugin=function(){this.enabled=false;this.renderTarget=null;var _gl,_renderer,_depthMaterial,_depthMaterialMorph,_depthMaterialSkin,_depthMaterialMorphSkin,_frustum=new THREE.Frustum,_projScreenMatrix=new THREE.Matrix4;this.init=function(renderer){_gl=renderer.context;_renderer=renderer;var depthShader=THREE.ShaderLib["depthRGBA"];var depthUniforms=THREE.UniformsUtils.clone(depthShader.uniforms);_depthMaterial=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms});_depthMaterialMorph=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,morphTargets:true});_depthMaterialSkin=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,skinning:true});_depthMaterialMorphSkin=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms,morphTargets:true,skinning:true});_depthMaterial._shadowPass=true;_depthMaterialMorph._shadowPass=true;_depthMaterialSkin._shadowPass=true;_depthMaterialMorphSkin._shadowPass=true};this.render=function(scene,camera){if(!this.enabled)return;this.update(scene,camera)};this.update=function(scene,camera){var i,il,j,jl,n,program,buffer,material,webglObject,object,light,renderList,fog=null;_gl.clearColor(1,1,1,1);_gl.disable(_gl.BLEND);_renderer.setDepthTest(true);if(scene.autoUpdate===true)scene.updateMatrixWorld();camera.matrixWorldInverse.getInverse(camera.matrixWorld);_projScreenMatrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse);_frustum.setFromMatrix(_projScreenMatrix);_renderer.setRenderTarget(this.renderTarget);_renderer.clear();renderList=scene.__webglObjects;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];object=webglObject.object;webglObject.render=false;if(object.visible){if(!(object instanceof THREE.Mesh||object instanceof THREE.ParticleSystem)||!object.frustumCulled||_frustum.intersectsObject(object)){object._modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld);webglObject.render=true}}}var objectMaterial,useMorphing,useSkinning;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];if(webglObject.render){object=webglObject.object;buffer=webglObject.buffer;if(object instanceof THREE.ParticleSystem&&!object.customDepthMaterial)continue;objectMaterial=getObjectMaterial(object);if(objectMaterial)_renderer.setMaterialFaces(object.material);useMorphing=object.geometry.morphTargets.length>0&&objectMaterial.morphTargets;useSkinning=object instanceof THREE.SkinnedMesh&&objectMaterial.skinning;if(object.customDepthMaterial){material=object.customDepthMaterial}else if(useSkinning){material=useMorphing?_depthMaterialMorphSkin:_depthMaterialSkin}else if(useMorphing){material=_depthMaterialMorph}else{material=_depthMaterial}if(buffer instanceof THREE.BufferGeometry){_renderer.renderBufferDirect(camera,scene.__lights,fog,material,buffer,object)}else{_renderer.renderBuffer(camera,scene.__lights,fog,material,buffer,object)}}}renderList=scene.__webglObjectsImmediate;for(j=0,jl=renderList.length;j<jl;j++){webglObject=renderList[j];object=webglObject.object;if(object.visible){object._modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld);_renderer.renderImmediateObject(camera,scene.__lights,fog,_depthMaterial,object)}}var clearColor=_renderer.getClearColor(),clearAlpha=_renderer.getClearAlpha();_gl.clearColor(clearColor.r,clearColor.g,clearColor.b,clearAlpha);_gl.enable(_gl.BLEND)};function getObjectMaterial(object){return object.material instanceof THREE.MeshFaceMaterial?object.material.materials[0]:object.material}};THREE.ShaderFlares={lensFlareVertexTexture:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.5 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.1, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.1, 0.5 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility = (       visibility.r / 9.0 ) *","( 1.0 - visibility.g / 9.0 ) *","(       visibility.b / 9.0 ) *","( 1.0 - visibility.a / 9.0 );","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},lensFlare:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision mediump float;","uniform lowp int renderType;","uniform sampler2D map;","uniform sampler2D occlusionMap;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( texture2D( map, vUV ).rgb, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","float visibility = texture2D( occlusionMap, vec2( 0.5, 0.1 ) ).a +","texture2D( occlusionMap, vec2( 0.9, 0.5 ) ).a +","texture2D( occlusionMap, vec2( 0.5, 0.9 ) ).a +","texture2D( occlusionMap, vec2( 0.1, 0.5 ) ).a;","visibility = ( 1.0 - visibility / 4.0 );","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")}};
THREE.ShaderSprite={sprite:{vertexShader:["uniform int useScreenCoordinates;","uniform int sizeAttenuation;","uniform vec3 screenPosition;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 alignment;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position + alignment;","vec2 rotatedPosition;","rotatedPosition.x = ( cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y ) * scale.x;","rotatedPosition.y = ( sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y ) * scale.y;","vec4 finalPosition;","if( useScreenCoordinates != 0 ) {","finalPosition = vec4( screenPosition.xy + rotatedPosition, screenPosition.z, 1.0 );","} else {","finalPosition = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition * ( sizeAttenuation == 1 ? 1.0 : finalPosition.z );","}","gl_Position = finalPosition;","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")}};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=THREE}exports.THREE=THREE}else{this["THREE"]=THREE}},{__browserify_process:510}],162:[function(require,module,exports){"use strict";function traceRay_impl(voxels,px,py,pz,dx,dy,dz,max_d,hit_pos,hit_norm,EPSILON){var t=0,nx=0,ny=0,nz=0,ix,iy,iz,fx,fy,fz,ox,oy,oz,ex,ey,ez,b,step,min_step,floor=Math.floor;while(t<=max_d){ox=px+t*dx;oy=py+t*dy;oz=pz+t*dz;ix=floor(ox)|0;iy=floor(oy)|0;iz=floor(oz)|0;fx=ox-ix;fy=oy-iy;fz=oz-iz;b=voxels.getBlock(ix,iy,iz);if(b){if(hit_pos){hit_pos[0]=fx<EPSILON?+ix:fx>1-EPSILON?ix+1-EPSILON:ox;hit_pos[1]=fy<EPSILON?+iy:fy>1-EPSILON?iy+1-EPSILON:oy;hit_pos[2]=fz<EPSILON?+iz:fz>1-EPSILON?iz+1-EPSILON:oz}if(hit_norm){hit_norm[0]=nx;hit_norm[1]=ny;hit_norm[2]=nz}return b}min_step=+(EPSILON*(1+t));if(t>min_step){ex=nx<0?fx<=min_step:fx>=1-min_step;ey=ny<0?fy<=min_step:fy>=1-min_step;ez=nz<0?fz<=min_step:fz>=1-min_step;if(ex&&ey&&ez){b=voxels.getBlock(ix+nx,iy+ny,iz)||voxels.getBlock(ix,iy+ny,iz+nz)||voxels.getBlock(ix+nx,iy,iz+nz);if(b){if(hit_pos){hit_pos[0]=nx<0?ix-EPSILON:ix+1-EPSILON;hit_pos[1]=ny<0?iy-EPSILON:iy+1-EPSILON;hit_pos[2]=nz<0?iz-EPSILON:iz+1-EPSILON}if(hit_norm){hit_norm[0]=nx;hit_norm[1]=ny;hit_norm[2]=nz}return b}}if(ex&&(ey||ez)){b=voxels.getBlock(ix+nx,iy,iz);if(b){if(hit_pos){hit_pos[0]=nx<0?ix-EPSILON:ix+1-EPSILON;hit_pos[1]=fy<EPSILON?+iy:oy;hit_pos[2]=fz<EPSILON?+iz:oz}if(hit_norm){hit_norm[0]=nx;hit_norm[1]=ny;hit_norm[2]=nz}return b}}if(ey&&(ex||ez)){b=voxels.getBlock(ix,iy+ny,iz);if(b){if(hit_pos){hit_pos[0]=fx<EPSILON?+ix:ox;hit_pos[1]=ny<0?iy-EPSILON:iy+1-EPSILON;hit_pos[2]=fz<EPSILON?+iz:oz}if(hit_norm){hit_norm[0]=nx;hit_norm[1]=ny;hit_norm[2]=nz}return b}}if(ez&&(ex||ey)){b=voxels.getBlock(ix,iy,iz+nz);if(b){if(hit_pos){hit_pos[0]=fx<EPSILON?+ix:ox;hit_pos[1]=fy<EPSILON?+iy:oy;hit_pos[2]=nz<0?iz-EPSILON:iz+1-EPSILON}if(hit_norm){hit_norm[0]=nx;hit_norm[1]=ny;hit_norm[2]=nz}return b}}}nx=ny=nz=0;step=2;if(dx<-EPSILON){var s=-fx/dx;nx=1;step=s}if(dx>EPSILON){var s=(1-fx)/dx;nx=-1;step=s}if(dy<-EPSILON){var s=-fy/dy;if(s<step-min_step){nx=0;ny=1;step=s}else if(s<step+min_step){ny=1}}if(dy>EPSILON){var s=(1-fy)/dy;if(s<step-min_step){nx=0;ny=-1;step=s}else if(s<step+min_step){ny=-1}}if(dz<-EPSILON){var s=-fz/dz;if(s<step-min_step){nx=ny=0;nz=1;step=s}else if(s<step+min_step){nz=1}}if(dz>EPSILON){var s=(1-fz)/dz;if(s<step-min_step){nx=ny=0;nz=-1;step=s}else if(s<step+min_step){nz=-1}}if(step>max_d-t){step=max_d-t-min_step}if(step<min_step){step=min_step}t+=step}if(hit_pos){hit_pos[0]=ox;hit_pos[1]=oy;hit_pos[2]=oz}if(hit_norm){hit_norm[0]=hit_norm[1]=hit_norm[2]=0}return 0}function traceRay(voxels,origin,direction,max_d,hit_pos,hit_norm,EPSILON){var px=+origin[0],py=+origin[1],pz=+origin[2],dx=+direction[0],dy=+direction[1],dz=+direction[2],ds=Math.sqrt(dx*dx+dy*dy+dz*dz);if(typeof EPSILON==="undefined"){EPSILON=1e-8}if(ds<EPSILON){if(hit_pos){hit_pos[0]=hit_pos[1]=hit_pos[2]}if(hit_norm){hit_norm[0]=hit_norm[1]=hit_norm[2]}return 0}dx/=ds;dy/=ds;dz/=ds;if(typeof max_d==="undefined"){max_d=64}else{max_d=+max_d}return traceRay_impl(voxels,px,py,pz,dx,dy,dz,max_d,hit_pos,hit_norm,EPSILON)}module.exports=traceRay},{}],163:[function(require,module,exports){module.exports=coordinates;var aabb=require("aabb-3d");var events=require("events");function coordinates(spatial,box,regionWidth){var emitter=new events.EventEmitter;var lastRegion=[NaN,NaN,NaN];var thisRegion;if(arguments.length===2){regionWidth=box;box=aabb([-Infinity,-Infinity,-Infinity],[Infinity,Infinity,Infinity])}spatial.on("position",box,updateRegion);function updateRegion(pos){thisRegion=[Math.floor(pos[0]/regionWidth),Math.floor(pos[1]/regionWidth),Math.floor(pos[2]/regionWidth)];if(thisRegion[0]!==lastRegion[0]||thisRegion[1]!==lastRegion[1]||thisRegion[2]!==lastRegion[2]){emitter.emit("change",thisRegion)}lastRegion=thisRegion}return emitter}},{"aabb-3d":132,events:507}],164:[function(require,module,exports){var tic=require("tic")();var createAtlas=require("atlaspack");var isTransparent=require("opaque").transparent;function Texture(opts){if(!(this instanceof Texture))return new Texture(opts||{});var self=this;this.game=opts.game;delete opts.game;this.THREE=this.game.THREE;this.materials=[];this.transparents=[];this.texturePath=opts.texturePath||"/textures/";this.loading=0;this.ao=require("voxel-fakeao")(this.game);var useFlatColors=opts.materialFlatColor===true;delete opts.materialFlatColor;this.options=defaults(opts||{},{crossOrigin:"Anonymous",materialParams:defaults(opts.materialParams||{},{ambient:12303291,transparent:false,side:this.THREE.DoubleSide}),materialTransparentParams:defaults(opts.materialTransparentParams||{},{ambient:12303291,transparent:true,side:this.THREE.DoubleSide}),materialType:this.THREE.MeshLambertMaterial,applyTextureParams:function(map){map.magFilter=self.THREE.NearestFilter;map.minFilter=self.THREE.LinearMipMapLinearFilter}});this.canvas=typeof document!=="undefined"?document.createElement("canvas"):{};this.canvas.width=opts.atlasWidth||512;this.canvas.height=opts.atlasHeight||512;var ctx=this.canvas.getContext("2d");ctx.fillStyle="black";ctx.fillRect(0,0,this.canvas.width,this.canvas.height);this.atlas=createAtlas(this.canvas);this.atlas.tilepad=true;this._atlasuv=false;this._atlaskey=false;this.texture=new this.THREE.Texture(this.canvas);this.options.applyTextureParams(this.texture);if(useFlatColors){this.material=new this.THREE.MeshBasicMaterial({vertexColors:this.THREE.VertexColors})}else{var opaque=new this.options.materialType(this.options.materialParams);opaque.map=this.texture;var transparent=new this.options.materialType(this.options.materialTransparentParams);transparent.map=this.texture;this.material=new this.THREE.MeshFaceMaterial([opaque,transparent])}this._meshQueue=[]}module.exports=Texture;Texture.prototype.load=function(names,done){var self=this;if(!Array.isArray(names))names=[names];done=done||function(){};this.loading++;var materialSlice=names.map(self._expandName);self.materials=self.materials.concat(materialSlice);var load=Object.create(null);materialSlice.forEach(function(mats){mats.forEach(function(mat){if(mat.slice(0,1)==="#")return;load[mat]=true})});if(Object.keys(load).length>0){each(Object.keys(load),self.pack.bind(self),function(){self._afterLoading();done(materialSlice)})}else{self._afterLoading()}};Texture.prototype.pack=function(name,done){var self=this;function pack(img){var node=self.atlas.pack(img);if(node===false){self.atlas=self.atlas.expand(img);self.atlas.tilepad=true}done()}if(typeof name==="string"){var img=new Image;img.id=name;img.crossOrigin=self.options.crossOrigin;img.src=self.texturePath+ext(name);img.onload=function(){if(isTransparent(img)){self.transparents.push(name)}pack(img)};img.onerror=function(){console.error("Couldn't load URL ["+img.src+"]");done()}}else{pack(name)}return self};Texture.prototype.find=function(name){var self=this;var type=0;self.materials.forEach(function(mats,i){mats.forEach(function(mat){if(mat===name){type=i+1;return false}});if(type!==0)return false});return type};Texture.prototype._expandName=function(name){if(name===null)return Array(6);if(name.top)return[name.back,name.front,name.top,name.bottom,name.left,name.right];if(!Array.isArray(name))name=[name];if(name.length===1)name=[name[0],name[0],name[0],name[0],name[0],name[0]];if(name.length===2)name=[name[1],name[1],name[0],name[0],name[1],name[1]];if(name.length===3)name=[name[2],name[2],name[0],name[1],name[2],name[2]];if(name.length===4)name=[name[2],name[2],name[0],name[1],name[3],name[3]];return name};Texture.prototype._afterLoading=function(){var self=this;function alldone(){self.loading--;self._atlasuv=self.atlas.uv(self.canvas.width,self.canvas.height);self._atlaskey=Object.create(null);self.atlas.index().forEach(function(key){self._atlaskey[key.name]=key});self.texture.needsUpdate=true;self.material.needsUpdate=true;if(self._meshQueue.length>0){self._meshQueue.forEach(function(queue,i){self.paint.apply(queue.self,queue.args);delete self._meshQueue[i]})}}self._powerof2(function(){setTimeout(alldone,100)})};Texture.prototype._powerof2=function(done){var w=this.canvas.width;var h=this.canvas.height;function pow2(x){x--;x|=x>>1;x|=x>>2;x|=x>>4;x|=x>>8;x|=x>>16;x++;return x}if(h>w)w=h;var old=this.canvas.getContext("2d").getImageData(0,0,this.canvas.width,this.canvas.height);this.canvas.width=this.canvas.height=pow2(w);this.canvas.getContext("2d").putImageData(old,0,0);done()};Texture.prototype.paint=function(mesh,materials){var self=this;if(self.loading>0){self._meshQueue.push({self:self,args:arguments});return false}var isVoxelMesh=materials?false:true;if(!isVoxelMesh)materials=self._expandName(materials);mesh.geometry.faces.forEach(function(face,i){if(mesh.geometry.faceVertexUvs[0].length<1)return;if(isVoxelMesh){var index=Math.floor(face.color.b*255+face.color.g*255*255+face.color.r*255*255*255);materials=self.materials[index-1];if(!materials)materials=self.materials[0]}var name=materials[0]||"";if(face.normal.z===1)name=materials[1]||"";else if(face.normal.y===1)name=materials[2]||"";else if(face.normal.y===-1)name=materials[3]||"";else if(face.normal.x===-1)name=materials[4]||"";else if(face.normal.x===1)name=materials[5]||"";if(name.slice(0,1)==="#"){self.ao(face,name);return}var atlasuv=self._atlasuv[name];if(!atlasuv)return;face.materialIndex=self.transparents.indexOf(name)!==-1?1:0;if(isVoxelMesh){if(face.normal.z===-1||face.normal.x===1){atlasuv=uvrot(atlasuv,90)}atlasuv=uvinvert(atlasuv)}else{atlasuv=uvrot(atlasuv,-90)}for(var j=0;j<mesh.geometry.faceVertexUvs[0][i].length;j++){mesh.geometry.faceVertexUvs[0][i][j].set(atlasuv[j][0],1-atlasuv[j][1])}});mesh.geometry.uvsNeedUpdate=true};Texture.prototype.sprite=function(name,w,h,cb){var self=this;if(typeof w==="function"){cb=w;w=null}if(typeof h==="function"){cb=h;h=null}w=w||16;h=h||w;self.loading++;var img=new Image;img.src=self.texturePath+ext(name);img.onerror=cb;img.onload=function(){var canvases=[];for(var x=0;x<img.width;x+=w){for(var y=0;y<img.height;y+=h){var canvas=document.createElement("canvas");canvas.width=w;canvas.height=h;canvas.name=name+"_"+x+"_"+y;canvas.getContext("2d").drawImage(img,x,y,w,h,0,0,w,h);canvases.push(canvas)}}var textures=[];each(canvases,function(canvas,next){var tex=new Image;tex.name=canvas.name;tex.src=canvas.toDataURL();tex.onload=function(){self.pack(tex,next)};tex.onerror=next;textures.push([tex.name,tex.name,tex.name,tex.name,tex.name,tex.name])},function(){self._afterLoading();delete canvases;self.materials=self.materials.concat(textures);cb(textures)})};return self};Texture.prototype.animate=function(mesh,names,delay){var self=this;delay=delay||1e3;if(!Array.isArray(names)||names.length<2)return false;var i=0;var mat=new this.options.materialType(this.options.materialParams);mat.map=this.texture;mat.transparent=true;mat.needsUpdate=true;tic.interval(function(){self.paint(mesh,names[i%names.length]);i++},delay);return mat};Texture.prototype.tick=function(dt){tic.tick(dt)};function uvrot(coords,deg){if(deg===0)return coords;var c=[];var i=(4-Math.ceil(deg/90))%4;for(var j=0;j<4;j++){c.push(coords[i]);if(i===3)i=0;else i++}return c}function uvinvert(coords){var c=coords.slice(0);return[c[3],c[2],c[1],c[0]]}function ext(name){return String(name).indexOf(".")!==-1?name:name+".png"}function defaults(obj){[].slice.call(arguments,1).forEach(function(from){if(from)for(var k in from)if(obj[k]==null)obj[k]=from[k]});return obj}function each(arr,it,done){var count=0;arr.forEach(function(a){it(a,function(){count++;if(count>=arr.length)done()})})}},{atlaspack:165,opaque:166,tic:155,"voxel-fakeao":167}],165:[function(require,module,exports){function Rect(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h}Rect.prototype.fitsIn=function(outer){return outer.w>=this.w&&outer.h>=this.h};Rect.prototype.sameSizeAs=function(other){return this.w===other.w&&this.h===other.h};function Atlas(x,y,w,h){if(arguments.length===1){this.canvas=x;x=y=0;w=this.canvas.width;h=this.canvas.height}if(arguments.length===2){w=x;h=y;x=y=0}this.left=this.right=null;this.rect=new Rect(x,y,w,h);this.filled=false;this.tilepad=false;this._cache=[];this._uvcache=Object.create(null)}module.exports=function(){if(arguments.length===1){return new Atlas(arguments[0])}if(arguments.length===2){return new Atlas(arguments[0],arguments[1])}return new Atlas(arguments[0],arguments[1],arguments[2],arguments[3])};module.exports.Atlas=Atlas;module.exports.Rect=Rect;Atlas.prototype.pack=function(rect){this._cache=[];this._uvcache=[];rect=this._toRect(rect);if(this.img&&this.tilepad){rect=this._tilepad(rect)}if(this.left!==null){return this._ontoCanvas(this.left.pack(rect)||this.right.pack(rect))}if(this.filled||!rect.fitsIn(this.rect)){return false}if(rect.sameSizeAs(this.rect)){this.filled=true;return this._ontoCanvas(this)}if(this.rect.w-rect.w>this.rect.h-rect.h){this.left=new Atlas(this.rect.x,this.rect.y,rect.w,this.rect.h);this.right=new Atlas(this.rect.x+rect.w,this.rect.y,this.rect.w-rect.w,this.rect.h)}else{this.left=new Atlas(this.rect.x,this.rect.y,this.rect.w,rect.h);this.right=new Atlas(this.rect.x,this.rect.y+rect.h,this.rect.w,this.rect.h-rect.h)}return this._ontoCanvas(this.left.pack(rect))};Atlas.prototype.expand=function(rect){var self=this;rect=this._toRect(rect);if(this.img&&this.tilepad){rect=this._tilepad(rect)}var atlas;if(this.rect.w<this.rect.h){atlas=new Atlas(0,0,this.rect.w+rect.w,this.rect.h);atlas.right=new Atlas(this.rect.w,0,rect.w,this.rect.h);atlas.left=this}else{atlas=new Atlas(0,0,this.rect.w,this.rect.h+rect.h);atlas.right=new Atlas(0,this.rect.h,this.rect.w,rect.h);atlas.left=this}["canvas","context","img"].forEach(function(p){if(self[p]){atlas[p]=self[p];self[p]=null}});if(atlas.canvas){if(!atlas.context){atlas.context=atlas.canvas.getContext("2d")}var old=atlas.context.getImageData(0,0,atlas.canvas.width,atlas.canvas.height);atlas.canvas.width=atlas.rect.w;atlas.canvas.height=atlas.rect.h;atlas.context.putImageData(old,0,0)}return atlas.pack(rect)===false?atlas.expand(rect):atlas};Atlas.prototype.index=function(){var self=this;if(self._cache.length>0){return self._cache}(function loop(atlas){if(atlas.left!==null){loop(atlas.left);loop(atlas.right)}else if(atlas.rect.name){self._cache.push(atlas.rect)}})(self);return self._cache};Atlas.prototype.uv=function(w,h){var self=this;if(self._uvcache.length>0){return self._uvcache}w=w||self.rect.w;h=h||self.rect.h;var isPad=this.tilepad;(function loop(atlas){if(atlas.left!==null){loop(atlas.left);loop(atlas.right)}else if(typeof atlas.rect.name!=="undefined"){var p=isPad?atlas.rect.w/4:0;self._uvcache[atlas.rect.name]=[[atlas.rect.x+p,atlas.rect.y+p],[atlas.rect.x+p+(atlas.rect.w-p*2),atlas.rect.y+p],[atlas.rect.x+p+(atlas.rect.w-p*2),atlas.rect.y+p+(atlas.rect.h-p*2)],[atlas.rect.x+p,atlas.rect.y+p+(atlas.rect.h-p*2)]].map(function(uv){if(uv[0]!==0){uv[0]=uv[0]/w}if(uv[1]!==0){uv[1]=uv[1]/h}return uv})}})(self);return self._uvcache};Atlas.prototype.json=function(input){var self=this;if(input){if(typeof input==="string")input=JSON.parse(input);return function loop(obj){if(!obj||!obj.rect)return;var atlas=new Atlas(obj.rect.x,obj.rect.y,obj.rect.w,obj.rect.h);if(obj.left)atlas.left=loop(obj.left);if(obj.right)atlas.right=loop(obj.right);return atlas}(input)}else{return JSON.stringify(function loop(atlas){var obj={left:null,right:null,rect:atlas.rect,filled:atlas.filled};if(atlas.left!==null){obj.left=loop(atlas.left);obj.right=loop(atlas.right)}return obj}(self),null,2)}};Atlas.prototype._tilepad=function(rect){var img=this.img;if(!img)return rect;var p=img.width/2;var canvas=document.createElement("canvas");canvas.name=img.name||img.src;canvas.id=img.id||"";canvas.width=img.width+img.width;canvas.height=img.height+img.height;var ctx=canvas.getContext("2d");var pattern=ctx.createPattern(img,"repeat");ctx.fillStyle=pattern;ctx.translate(p,p);ctx.fillRect(-p,-p,canvas.width+p,canvas.height+p);ctx.translate(-p,-p);this.img=canvas;return new Rect(rect.x,rect.y,this.img.width,this.img.height)};Atlas.prototype._ontoCanvas=function(node){if(node&&this.img&&this.canvas){if(!this.context){this.context=this.canvas.getContext("2d")}this.context.clearRect(node.rect.x,node.rect.y,node.rect.w,node.rect.h);this.context.drawImage(this.img,node.rect.x,node.rect.y,node.rect.w,node.rect.h);node.rect.name=this.img.id||this.img.name||this.img.src||null}return node};Atlas.prototype._toRect=function(rect){if(rect.nodeName&&rect.nodeName==="IMG"){this.img=rect;rect=new Rect(rect.x,rect.y,rect.width,rect.height)}if(!(rect instanceof Rect)){rect=new Rect(rect.x||0,rect.y||0,rect.w||rect.width,rect.h||rect.height)}return rect};Atlas.prototype._debug=function(){if(!this.canvas){return}var context=this.canvas.getContext("2d");this.index().forEach(function(rect){context.lineWidth=1;context.strokeStyle="red";context.strokeRect(rect.x,rect.y,rect.w,rect.h)})}},{}],166:[function(require,module,exports){function opaque(image){var canvas,ctx;if(image.nodeName.toLowerCase()==="img"){canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height;ctx=canvas.getContext("2d");ctx.drawImage(image,0,0)}else{canvas=image;ctx=canvas.getContext("2d")}var imageData=ctx.getImageData(0,0,canvas.height,canvas.width),data=imageData.data;for(var i=3,l=data.length;i<l;i+=4)if(data[i]!==255)return false;return true}module.exports=opaque;module.exports.opaque=opaque;module.exports.transparent=function(image){return!opaque(image)}},{}],167:[function(require,module,exports){module.exports=function(game){var THREE=game.THREE;var colorCache=Object.create(null);var ao=function(face,light,dark){if(arguments.length===1){light=face.color;dark=getDark(light)}else if(arguments.length===2){light=convertColor(light);dark=getDark(light)}else{light=convertColor(light);dark=convertColor(dark)}face.color=light;if(face.normal.y===1)face.vertexColors=[light,light,light,light];else if(face.normal.y===-1)face.vertexColors=[dark,dark,dark,dark];else if(face.normal.x===1)face.vertexColors=[dark,light,light,dark];else if(face.normal.x===-1)face.vertexColors=[dark,dark,light,light];else if(face.normal.z===1)face.vertexColors=[dark,dark,light,light];else face.vertexColors=[dark,light,light,dark]};ao.onGeometry=function(geom,light,dark){for(var i=0;i<geom.faces.length;++i){ao(geom.faces[i],light,dark)}};ao.onChunk=function(chunk,light,dark){var pos="position"in chunk?chunk.position:chunk;var mesh=game.voxels.meshes[pos.join("|")];if(mesh){ao.onGeometry(mesh.geometry,light,dark)}};var getDark=function(light){var hex=light.getHexString();if(colorCache[hex])return colorCache[hex];var hsl=light.getHSL();var dark=light.clone();dark.setHSL(hsl.h,hsl.s,hsl.l-.1);return colorCache[hex]=dark};var convertColor=function(color){if(color instanceof THREE.Color)return color;if(colorCache[color])return colorCache[color];return colorCache[color]=new THREE.Color(color)};return ao}},{}],168:[function(require,module,exports){var process=require("__browserify_process");var THREE,temporaryPosition,temporaryVector;module.exports=function(three,opts){temporaryPosition=new three.Vector3;temporaryVector=new three.Vector3;return new View(three,opts)};function View(three,opts){THREE=three;this.fov=opts.fov||60;this.width=opts.width||512;this.height=opts.height||512;this.aspectRatio=opts.aspectRatio||this.width/this.height;this.nearPlane=opts.nearPlane||1;this.farPlane=opts.farPlane||1e4;this.skyColor=opts.skyColor||12571109;this.ortho=opts.ortho;this.camera=this.ortho?new THREE.OrthographicCamera(this.width/-2,this.width/2,this.height/2,this.height/-2,this.nearPlane,this.farPlane):new THREE.PerspectiveCamera(this.fov,this.aspectRatio,this.nearPlane,this.farPlane);this.camera.lookAt(new THREE.Vector3(0,0,0));if(!process.browser)return;this.createRenderer(opts);this.element=this.renderer.domElement}View.prototype.createRenderer=function(opts){opts=opts||{};opts.antialias=opts.antialias||true;this.renderer=new THREE.WebGLRenderer(opts);this.renderer.setSize(this.width,this.height);this.renderer.setClearColor(this.skyColor,1);this.renderer.clear()};View.prototype.bindToScene=function(scene){scene.add(this.camera)};View.prototype.getCamera=function(){return this.camera};View.prototype.cameraPosition=function(){temporaryPosition.multiplyScalar(0);temporaryPosition.applyMatrix4(this.camera.matrixWorld);return[temporaryPosition.x,temporaryPosition.y,temporaryPosition.z]};View.prototype.cameraVector=function(){temporaryVector.multiplyScalar(0);temporaryVector.z=-1;temporaryVector.transformDirection(this.camera.matrixWorld);return[temporaryVector.x,temporaryVector.y,temporaryVector.z]};View.prototype.resizeWindow=function(width,height){if(this.element.parentElement){width=width||this.element.parentElement.clientWidth;height=height||this.element.parentElement.clientHeight}this.camera.aspect=this.aspectRatio=width/height;this.width=width;this.height=height;this.camera.updateProjectionMatrix();this.renderer.setSize(width,height)};View.prototype.render=function(scene){this.renderer.render(scene,this.camera)};View.prototype.appendTo=function(element){if(typeof element==="object"){element.appendChild(this.element)}else{document.querySelector(element).appendChild(this.element)}this.resizeWindow(this.width,this.height)}},{__browserify_process:510}],169:[function(require,module,exports){module.exports=require(107)},{events:507,inherits:176}],170:[function(require,module,exports){arguments[4][108][0].apply(exports,arguments)},{"./chunker":169,"./meshers/culled":171,"./meshers/greedy":172,"./meshers/monotone":173,"./meshers/stupid":174,"./meshers/transgreedy":175}],171:[function(require,module,exports){module.exports=require(109)},{}],172:[function(require,module,exports){module.exports=require(110)},{}],173:[function(require,module,exports){module.exports=require(111)},{}],174:[function(require,module,exports){module.exports=require(112)},{}],175:[function(require,module,exports){module.exports=require(113)},{}],176:[function(require,module,exports){module.exports=require(4)},{}],177:[function(require,module,exports){"use strict";module.exports=function(game,opts){return new FluidPlugin(game,opts)};function FluidPlugin(game,opts){this.registry=game.plugins.get("voxel-registry");if(!this.registry)throw new Error("voxel-fluid requires voxel-registry plugin");this.fluids=[];this.registerFluid("water");this.registerFluid("lava");this.enable()}FluidPlugin.prototype.enable=function(){};FluidPlugin.prototype.disable=function(){};var ucfirst=function(s){return s.substr(0,1).toUpperCase()+s.substring(1)};FluidPlugin.prototype.registerFluid=function(name){var still=this.registry.registerBlock(name,{texture:name+"_still",fluid:name,displayName:"Still "+ucfirst(name)});var flow=this.registry.registerBlock(name+"Flow",{texture:name+"_flow",fluid:name,flowing:true,displayName:"Flowing "+ucfirst(name)});this.fluids[name]={still:still,flow:flow}};FluidPlugin.prototype.getFluidNames=function(){return Object.keys(this.fluids)}},{}],178:[function(require,module,exports){module.exports=function(game,opts){return new Fly(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-player"]};function Fly(game,opts){this.game=game;this.physical=opts.physical;if(!this.game)throw new Error("voxel-fly requires game parameter");if(!this.game.isClient)return;if(!this.game.buttons.down)throw new Error("voxel-fly requires game.buttons as kb-bindings ");this.flySpeed=opts.flySpeed||.8;this.enable()}Fly.prototype.enable=function(){var self=this;var counter=0;var spaceUpAfterFirstDown=false;var first=Date.now();if(!this.physical)this.physical=this.game.controls.target();this.game.buttons.down.on("jump",this.onJumpDown=function(){if(counter===1){if(Date.now()-first>300){spaceUpAfterFirstDown=false;return first=Date.now()}else{if(spaceUpAfterFirstDown){self.toggleFlying()}}spaceUpAfterFirstDown=false;return counter=0}if(counter===0){first=Date.now();counter+=1}});this.game.buttons.up.on("jump",this.onJumpUp=function(){if(counter===1){spaceUpAfterFirstDown=true}})};Fly.prototype.disable=function(){if(this.flying)this.stopFlying();this.game.buttons.down.removeListener("jump",this.onJumpDown);this.game.buttons.up.removeListener("jump",this.onJumpUp)};Fly.prototype.startFlying=function(){var self=this;this.flying=true;var physical=this.physical;physical.removeForce(this.game.gravity);physical.onGameTick=function(dt){if(physical.atRestY()===-1)return self.stopFlying();physical.friction.x=self.flySpeed;physical.friction.z=self.flySpeed;var press=self.game.controls.state;physical.velocity.y=0;if(press["jump"])physical.velocity.y+=.01;if(press["crouch"])physical.velocity.y-=.01};this.game.on("tick",physical.onGameTick)};Fly.prototype.stopFlying=function(){this.flying=false;var physical=this.physical;physical.subjectTo(this.game.gravity);this.game.removeListener("tick",physical.onGameTick)};Fly.prototype.toggleFlying=function(){if(this.flying){this.stopFlying()}else{this.startFlying()}}},{}],179:[function(require,module,exports){"use strict";module.exports=function(game,opts){return new FoodPlugin(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-registry","voxel-health"]};function FoodPlugin(game,opts){this.registry=game.plugins.get("voxel-registry");if(!this.registry)throw new Error("voxel-food requires voxel-registry plugin");this.health=game.plugins.get("voxel-health");if(!this.health)throw new Error("voxel-food requires voxel-health plugin");this.items=opts.items||{apple:{itemTexture:"i/apple",foodAmount:2},bread:{itemTexture:"i/bread",foodAmount:3},cookie:{itemTexture:"i/cookie",foodAmount:.5},spiderEye:{itemTexture:"i/spider_eye",foodAmount:-1}};this.enable()}FoodPlugin.prototype.enable=function(){for(var name in this.items){var props=this.items[name];props.onUse=this.eat.bind(this,props.foodAmount);this.registry.registerItem(name,props)}};FoodPlugin.prototype.disable=function(){};FoodPlugin.prototype.eat=function(amount,item){var effectiveAmount=this.health.heal(amount);if(effectiveAmount===0){return false}else{return true}}},{}],180:[function(require,module,exports){var process=require("__browserify_process");"use strict";var Server=require("voxel-server");var Client=require("voxel-client");var rtcDataStream=require("rtc-data-stream");var quickconnect=require("rtc-quickconnect");var engine=require("voxel-engine");var extend=require("extend");var createPlugins=require("voxel-plugins");var createLocalMessenger=require("rtc-signaller-sw");module.exports=function(opts){return new Fuel(opts)};function Fuel(opts){opts=opts||{};this.rtcDebug=opts.rtcDebug===undefined?true:opts.rtcDebug;this.createRtcMessenger=opts.createRtcMessenger===undefined?function(){return createLocalMessenger()}:opts.createRtcMessenger;this.rtcChannelName=opts.rtcChannelName===undefined?"test":opts.rtcChannelName;this.rtcNamespace=opts.rtcNamespace==undefined?"dctest":opts.rtcNamespace;this.enableClient=process.browser;this.enableServer=this.needServer();console.log("enableServer = ",this.enableServer);if(this.enableClient&&!this.enableServer)this.setupClientWaitingUI();this.pluginOpts=opts.pluginOpts||{};this.require=opts.require||require;this.commonOpts=opts.commonOpts||this.pluginOpts["voxel-engine"]||{};this.serverOpts=extend(extend({engine:engine,avatarInitialPosition:[2,20,2],forwardEvents:["attack","chat"]},opts.serverOpts),this.commonOpts);this.clientOpts=extend(extend({engine:engine},opts.clientOpts),this.commonOpts);this.clientOpts.overrideEngineOpts=this.clientOpts;if(opts.exposeGlobal)window.fuel=this;if(this.enableClient)this.createClient();if(this.enableServer)this.createServer()}Fuel.prototype.setupClientWaitingUI=function(){var button=document.createElement("button");button.style.position="absolute";button.style.margin="auto";button.style.top="0";button.style.right="0";button.style.bottom="0";button.style.left="0";button.style.width="30%";button.style.height="100px";button.style.backgroundColor="#ccc";var message=document.createTextNode("Waiting for server "+window.location.hash+"... (click to host)");button.appendChild(message);var self=this;button.addEventListener("click",function(){if(!self.enableServer){self.createServer();self.enableServer=true;self.removeClientWaitingUI()}});this.hostButton=button;document.body.appendChild(button)};Fuel.prototype.removeClientWaitingUI=function(){console.log("removeClientWaitingUI");if(this.hostButton){this.hostButton.parentElement.removeChild(this.hostButton);delete this.hostButton}};Fuel.prototype.needServer=function(){if(!this.enableClient)return true;return this.getRoomName()===undefined};Fuel.prototype.getRoomName=function(){return window.location.hash||undefined};Fuel.prototype.connectPeer=function(cb){var self=this;if(typeof this.createRtcMessenger!=="function")throw new Error("createRtcMessenger not a function: "+this.createRtcMessenger);var messenger=this.createRtcMessenger();quickconnect(messenger,{ns:this.rtcNamespace,debug:this.rtcDebug}).createDataChannel(this.rtcChannelName).on(this.rtcChannelName+":open",function(channel,peerId){console.log("data channel opened ",channel,peerId);var stream=rtcDataStream(channel);cb(stream,peerId)}).on("error",function(err){console.log("rtc error",err);alert("Fatal RTC error connecting to "+self.createRtcMessenger)})};Fuel.prototype.setupPlugins=function(plugins){for(var name in this.pluginOpts){plugins.add(name,this.pluginOpts[name])}plugins.loadAll()};Fuel.prototype.createClient=function(){var self=this;console.log("creating client");this.connectPeer(function(stream){if(self.client)return;self.clientOpts.serverStream=stream;console.log("client connectPeer stream",stream);self.client=Client(self.clientOpts);self.client.connection.on("settings",function(settings){console.log("** setting up client plugins");self.removeClientWaitingUI();self.client.game.plugins=createPlugins(self.client.game,{require:self.require});self.client.game.plugins.all["voxel-client"]=self.client;self.setupPlugins(self.client.game.plugins);
console.log("** finished setting up client plugins");var game=self.client.game;var registry=game.plugins.get("voxel-registry");var plugins=game.plugins;game.materials.load(registry.getBlockPropsAll("texture"));game.buttons.down.on("pov",function(){plugins.get("voxel-player").toggle()});game.buttons.down.on("vr",function(){plugins.toggle("voxel-oculus")});game.buttons.down.on("home",function(){plugins.get("voxel-player").home()});game.buttons.down.on("inventory",function(){plugins.get("voxel-inventory-crafting").open()})})})};Fuel.prototype.createServer=function(){var self=this;console.log("creating server");this.server=Server(this.serverOpts);this.server.on("missingChunk",function(chunk){console.log("server missingChunk",chunk)});this.server.on("join",function(client){console.log("server client join",client)});this.server.on("leave",function(client){console.log("server client leave",client)});this.server.on("error",function(error){console.log("server error",error)});console.log("** setting up server plugins");this.server.game.plugins=createPlugins(this.server.game,{require:this.require});this.server.game.plugins.all["voxel-server"]=this.server;this.setupPlugins(this.server.game.plugins);console.log("** finished setting up server plugins");this.connectPeer(function(stream,peerId){console.log("server connectPeer stream",stream,peerId);self.server.connectClient(stream,peerId)})}},{__browserify_process:510,extend:181,"rtc-data-stream":182,"rtc-quickconnect":183,"rtc-signaller-sw":222,"voxel-client":231,"voxel-engine":245,"voxel-plugins":293,"voxel-server":296}],181:[function(require,module,exports){var hasOwn=Object.prototype.hasOwnProperty;var toString=Object.prototype.toString;function isPlainObject(obj){if(!obj||toString.call(obj)!=="[object Object]"||obj.nodeType||obj.setInterval)return false;var has_own_constructor=hasOwn.call(obj,"constructor");var has_is_property_of_method=hasOwn.call(obj.constructor.prototype,"isPrototypeOf");if(obj.constructor&&!has_own_constructor&&!has_is_property_of_method)return false;var key;for(key in obj){}return key===undefined||hasOwn.call(obj,key)}module.exports=function extend(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(typeof target!=="object"&&typeof target!=="function"){target={}}for(;i<length;i++){if((options=arguments[i])!=null){for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&(isPlainObject(copy)||(copyIsArray=Array.isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&Array.isArray(src)?src:[]}else{clone=src&&isPlainObject(src)?src:{}}target[name]=extend(deep,clone,copy)}else if(copy!==undefined){target[name]=copy}}}}return target}},{}],182:[function(require,module,exports){var stream=require("stream");var util=require("util");function RtcDataStream(rtcChannel,options){if(!(this instanceof RtcDataStream))return new RtcDataStream(rtcChannel,options);stream.Stream.call(this);this.options=options||{};this.readable=true;this.writable=true;this._buffer=[];this.rtc=rtcChannel;this.rtc.addEventListener("message",this.onMessage.bind(this));this.rtc.onerror=this.onError.bind(this);this.rtc.onclose=this.onClose.bind(this);this.rtc.onopen=this.onOpen.bind(this);if(this.rtc.readyState==="open")this._open=true}util.inherits(RtcDataStream,stream.Stream);module.exports=RtcDataStream;module.exports.RtcDataStream=RtcDataStream;RtcDataStream.prototype.onMessage=function(e,flags){var data=e;if(data.data)data=data.data;var type=this.options.type;if(type&&data instanceof ArrayBuffer)data=new type(data);this.emit("data",data,flags)};RtcDataStream.prototype.onError=function(err){this.emit("error",err)};RtcDataStream.prototype.onClose=function(err){if(this._destroy)return;this.emit("end");this.emit("close")};RtcDataStream.prototype.onOpen=function(err){if(this._destroy)return;this._open=true;for(var i=0;i<this._buffer.length;i++){this._write(this._buffer[i])}this._buffer=undefined;this.emit("open");this.emit("connect");if(this._end)this.rtc.close()};RtcDataStream.prototype.write=function(data){if(!this._open){this._buffer.push(data)}else{this._write(data)}};RtcDataStream.prototype._write=function(data){this.rtc.send(data)};RtcDataStream.prototype.end=function(data){if(data!==undefined)this.write(data);if(this._open)this.rtc.close();this._end=true};RtcDataStream.prototype.destroy=function(){this._destroy=true;this.rtc.close()}},{stream:520,util:529}],183:[function(require,module,exports){"use strict";var EventEmitter=require("events").EventEmitter;var rtc=require("rtc");var debug=rtc.logger("rtc-quickconnect");var signaller=require("rtc-signaller");var defaults=require("cog/defaults");var reTrailingSlash=/\/$/;module.exports=function(signalhost,opts){var hash=location.hash.slice(1);var signaller=require("rtc-signaller")(signalhost);var ns=(opts||{}).ns||"";var room=(opts||{}).room;var debugging=(opts||{}).debug;var localStreams=[];var channels={};function gotPeerChannel(channel,pc,data){var emitChannelOpen=signaller.emit.bind(signaller,channel.label+":open",channel,data.id,data,pc);debug("channel "+channel.label+" discovered for peer: "+data.id,channel);if(channel.readyState==="open"){return emitChannelOpen()}channel.onopen=emitChannelOpen}if(!room){if(!hash){hash=location.hash=""+Math.pow(2,53)*Math.random()}room=ns+"#"+hash}if(debugging){rtc.logger.enable.apply(rtc.logger,Array.isArray(debug)?debugging:["*"])}signaller.on("peer:announce",function(data){var pc;var monitor;if(data.room!==room){return}pc=rtc.createConnection(opts,(opts||{}).constraints);localStreams.forEach(function(stream){pc.addStream(stream)});if(signaller.isMaster(data.id)){debug("is master, creating data channels: ",Object.keys(channels));Object.keys(channels).forEach(function(label){gotPeerChannel(pc.createDataChannel(label,channels[label]),pc,data)})}else{pc.ondatachannel=function(evt){if(evt&&evt.channel&&channels[evt.channel.label]!==undefined){gotPeerChannel(evt.channel,pc,data)}}}monitor=rtc.couple(pc,data.id,signaller,opts);signaller.emit("peer",pc,data.id,data,monitor);monitor.once("active",function(){signaller.emit("peer:connect",pc,data.id,data)});if(signaller.isMaster(data.id)){monitor.createOffer()}});setTimeout(function(){signaller.announce({room:room})},0);signaller.broadcast=function(stream){localStreams.push(stream);return signaller};signaller.createDataChannel=function(label,opts){channels[label]=opts||null;return signaller};return signaller}},{"cog/defaults":184,events:507,rtc:219,"rtc-signaller":192}],184:[function(require,module,exports){"use strict";module.exports=function(target){target=target||{};[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){if(target[prop]===void 0){target[prop]=source[prop]}}});return target}},{}],185:[function(require,module,exports){"use strict";module.exports=function(target){[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){target[prop]=source[prop]}});return target}},{}],186:[function(require,module,exports){"use strict";module.exports=function(input){var isString=typeof input=="string"||input instanceof String;var reNumeric=/^\-?\d+\.?\d*$/;var shouldParse;var firstChar;var lastChar;if(!isString||input.length<2){if(isString&&reNumeric.test(input)){return parseFloat(input)}return input}if(input==="true"||input==="false"){return input==="true"}if(input==="null"){return null}firstChar=input.charAt(0);lastChar=input.charAt(input.length-1);shouldParse=firstChar=="{"&&lastChar=="}"||firstChar=="["&&lastChar=="]";if(shouldParse){try{return JSON.parse(input)}catch(e){}}return reNumeric.test(input)?parseFloat(input):input}},{}],187:[function(require,module,exports){"use strict";var active=[];var unleashListeners=[];var targets=[console];var logger=module.exports=function(name){var enabled=checkActive();function checkActive(){return enabled=active.indexOf("*")>=0||active.indexOf(name)>=0}unleashListeners[unleashListeners.length]=checkActive;return function(){var args=[].slice.call(arguments);if(typeof args[0]=="string"||args[0]instanceof String){args[0]=name+": "+args[0]}if(!enabled){return}targets.forEach(function(target){target.log.apply(target,args)})}};logger.reset=function(){targets=[];active=[];return logger.enable()};logger.to=function(target){targets=targets.concat(target||[]);return logger};logger.enable=function(){active=active.concat([].slice.call(arguments));unleashListeners.forEach(function(listener){listener()});return logger}},{}],188:[function(require,module,exports){"use strict";var browsers={chrome:/Chrom(?:e|ium)\/([0-9]+)\./,firefox:/Firefox\/([0-9]+)\./,opera:/Opera\/([0-9]+)\./};var detect=module.exports=function(target,prefixes){var prefixIdx;var prefix;var testName;var hostObject=this||(typeof window!="undefined"?window:undefined);if(!hostObject){return}prefixes=(prefixes||["ms","o","moz","webkit"]).concat("");for(prefixIdx=prefixes.length;prefixIdx--;){prefix=prefixes[prefixIdx];testName=prefix+(prefix?target.charAt(0).toUpperCase()+target.slice(1):target);if(typeof hostObject[testName]!="undefined"){detect.browser=detect.browser||prefix.toLowerCase();return hostObject[target]=hostObject[testName]}}};detect.moz=typeof navigator!="undefined"&&!!navigator.mozGetUserMedia;if(typeof navigator!="undefined"){Object.keys(browsers).forEach(function(key){var match=browsers[key].exec(navigator.userAgent);if(match){detect.browser=key;detect.browserVersion=detect.version=parseInt(match[1],10)}})}else{detect.browser="node";detect.browserVersion=detect.version="?"}},{}],189:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller");var extend=require("cog/extend");var roles=["a","b"];module.exports=function(signaller){function copyData(target,source){if(target&&source){for(var key in source){target[key]=source[key]}}return target}return function(args,messageType,srcData,srcState,isDM){var data=args[0];var peer;debug("announce handler invoked, received data: ",data);if(data&&data.id&&data.id!==signaller.id){peer=signaller.peers.get(data.id);if(peer){debug("signaller: "+signaller.id+" received update, data: ",data);copyData(peer.data,data);return signaller.emit("peer:update",data,srcData)}peer={id:data.id,roleIdx:[data.id,signaller.id].sort().indexOf(data.id),data:{}};copyData(peer.data,data);signaller.peers.set(data.id,peer);if(signaller.autoreply&&!isDM){signaller.to(data.id).send("/announce",signaller.attributes)}return signaller.emit("peer:announce",data,peer)}}}},{"cog/extend":185,"cog/logger":187}],190:[function(require,module,exports){"use strict";module.exports=function(signaller){return{announce:require("./announce")(signaller),leave:require("./leave")(signaller)}}},{"./announce":189,"./leave":191}],191:[function(require,module,exports){"use strict";module.exports=function(signaller){return function(args){var data=args[0];var peer=signaller.peers.get(data&&data.id);if(peer){peer.inactive=true}signaller.emit("peer:leave",data.id,peer)}}},{}],192:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller");var detect=require("rtc-core/detect");var EventEmitter=require("events").EventEmitter;var uuid=require("uuid");var extend=require("cog/extend");var FastMap=require("collections/fast-map");var sig=module.exports=function(messenger,opts){var autoreply=(opts||{}).autoreply;var signaller=new EventEmitter;var id=signaller.id=uuid.v4();var attributes=signaller.attributes={browser:detect.browser,browserVersion:detect.browserVersion,id:id,agent:"signaller@"+require("./package.json").version};var peers=signaller.peers=new FastMap;var dataEvent=(opts||{}).dataEvent||"data";var openEvent=(opts||{}).openEvent||"open";var writeMethod=(opts||{}).writeMethod||"write";var closeMethod=(opts||{}).closeMethod||"close";var initialized=false;var write;var close;var processor;function connectToPrimus(url){sig.loadPrimus(url,function(err,Primus){if(err){return signaller.emit("error",err)}messenger=Primus.connect(url);init()})}function init(){write=messenger[writeMethod];close=messenger[closeMethod];processor=require("./processor")(signaller);if(typeof write!="function"){throw new Error('provided messenger does not implement a "'+writeMethod+'" write method')}messenger.on(dataEvent,processor);messenger.on(openEvent,function(){signaller.emit("open");signaller.emit("connected")});initialized=true;signaller.emit("init")}signaller.autoreply=autoreply===undefined||autoreply;function prepareArg(arg){if(typeof arg=="object"&&!(arg instanceof String)){return JSON.stringify(arg)}else if(typeof arg=="function"){return null}return arg}var send=signaller.send=function(){var args=[].slice.call(arguments);var dataline;args.splice(1,0,{id:signaller.id});dataline=args.map(prepareArg).filter(Boolean).join("|");if(!initialized){return signaller.once("init",function(){write.call(messenger,dataline)})}return write.call(messenger,dataline)};signaller.announce=function(data,sender){extend(attributes,data,{id:signaller.id});return(sender||send)("/announce",attributes)};signaller.isMaster=function(targetId){var peer=peers.get(targetId);return peer&&peer.roleIdx!==0};signaller.leave=function(){send("/leave",{id:id});if(typeof close=="function"){close.call(messenger)}};signaller.to=function(targetId){var sender=function(){var peer=signaller.peers.get(targetId);var args;if(!peer){throw new Error("Unknown peer: "+targetId)}if(peer.inactive){return}args=["/to",targetId].concat([].slice.call(arguments));args.splice(3,0,{id:signaller.id});setTimeout(function(){var msg=args.map(prepareArg).filter(Boolean).join("|");debug("TX ("+targetId+"): "+msg);write.call(messenger,msg)},0)};return{announce:function(data){return signaller.announce(data,sender)},send:sender}};if(typeof messenger=="string"||messenger instanceof String){connectToPrimus(messenger)}else{init()}return signaller};sig.loadPrimus=require("./primus-loader")},{"./package.json":213,"./primus-loader":214,"./processor":215,"cog/extend":185,"cog/logger":187,"collections/fast-map":194,events:507,"rtc-core/detect":188,uuid:212}],193:[function(require,module,exports){"use strict";var Shim=require("./shim");var GenericCollection=require("./generic-collection");var GenericMap=require("./generic-map");var PropertyChanges=require("./listen/property-changes");module.exports=Dict;function Dict(values,getDefault){if(!(this instanceof Dict)){return new Dict(values,getDefault)}getDefault=getDefault||Function.noop;this.getDefault=getDefault;this.store={};this.length=0;this.addEach(values)}Dict.Dict=Dict;function mangle(key){return"~"+key}function unmangle(mangled){return mangled.slice(1)}Object.addEach(Dict.prototype,GenericCollection.prototype);Object.addEach(Dict.prototype,GenericMap.prototype);Object.addEach(Dict.prototype,PropertyChanges.prototype);Dict.prototype.constructClone=function(values){return new this.constructor(values,this.mangle,this.getDefault)};Dict.prototype.assertString=function(key){if(typeof key!=="string"){throw new TypeError("key must be a string but Got "+key)}};Dict.prototype.get=function(key,defaultValue){this.assertString(key);var mangled=mangle(key);if(mangled in this.store){return this.store[mangled]}else if(arguments.length>1){return defaultValue}else{return this.getDefault(key)}};Dict.prototype.set=function(key,value){this.assertString(key);var mangled=mangle(key);if(mangled in this.store){if(this.dispatchesBeforeMapChanges){this.dispatchBeforeMapChange(key,this.store[mangled])}this.store[mangled]=value;if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}return false}else{if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,undefined)}this.length++;this.store[mangled]=value;if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}return true}};Dict.prototype.has=function(key){this.assertString(key);var mangled=mangle(key);return mangled in this.store};Dict.prototype["delete"]=function(key){this.assertString(key);var mangled=mangle(key);if(mangled in this.store){if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,this.store[mangled])}delete this.store[mangle(key)];this.length--;if(this.dispatchesMapChanges){this.dispatchMapChange(key,undefined)}return true}return false};Dict.prototype.clear=function(){var key,mangled;for(mangled in this.store){key=unmangle(mangled);if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,this.store[mangled])}delete this.store[mangled];if(this.dispatchesMapChanges){this.dispatchMapChange(key,undefined)}}this.length=0};Dict.prototype.reduce=function(callback,basis,thisp){for(var mangled in this.store){basis=callback.call(thisp,basis,this.store[mangled],unmangle(mangled),this)}return basis};Dict.prototype.reduceRight=function(callback,basis,thisp){var self=this;var store=this.store;return Object.keys(this.store).reduceRight(function(basis,mangled){return callback.call(thisp,basis,store[mangled],unmangle(mangled),self)},basis)};Dict.prototype.one=function(){var key;for(key in this.store){return this.store[key]}}},{"./generic-collection":196,"./generic-map":197,"./listen/property-changes":202,"./shim":209}],194:[function(require,module,exports){"use strict";var Shim=require("./shim");var Set=require("./fast-set");var GenericCollection=require("./generic-collection");var GenericMap=require("./generic-map");var PropertyChanges=require("./listen/property-changes");module.exports=FastMap;function FastMap(values,equals,hash,getDefault){if(!(this instanceof FastMap)){return new FastMap(values,equals,hash,getDefault)}equals=equals||Object.equals;hash=hash||Object.hash;getDefault=getDefault||Function.noop;this.contentEquals=equals;this.contentHash=hash;this.getDefault=getDefault;this.store=new Set(undefined,function keysEqual(a,b){return equals(a.key,b.key)},function keyHash(item){return hash(item.key)});this.length=0;this.addEach(values)}FastMap.FastMap=FastMap;Object.addEach(FastMap.prototype,GenericCollection.prototype);Object.addEach(FastMap.prototype,GenericMap.prototype);Object.addEach(FastMap.prototype,PropertyChanges.prototype);FastMap.prototype.constructClone=function(values){return new this.constructor(values,this.contentEquals,this.contentHash,this.getDefault)};FastMap.prototype.log=function(charmap,stringify){stringify=stringify||this.stringify;this.store.log(charmap,stringify)};FastMap.prototype.stringify=function(item,leader){return leader+JSON.stringify(item.key)+": "+JSON.stringify(item.value)}},{"./fast-set":195,"./generic-collection":196,"./generic-map":197,"./listen/property-changes":202,"./shim":209}],195:[function(require,module,exports){"use strict";var Shim=require("./shim");var Dict=require("./dict");var List=require("./list");var GenericCollection=require("./generic-collection");var GenericSet=require("./generic-set");var TreeLog=require("./tree-log");var PropertyChanges=require("./listen/property-changes");var object_has=Object.prototype.hasOwnProperty;module.exports=FastSet;function FastSet(values,equals,hash,getDefault){if(!(this instanceof FastSet)){return new FastSet(values,equals,hash,getDefault)}equals=equals||Object.equals;hash=hash||Object.hash;getDefault=getDefault||Function.noop;this.contentEquals=equals;this.contentHash=hash;this.getDefault=getDefault;this.buckets=new this.Buckets(null,this.Bucket);this.length=0;this.addEach(values)}FastSet.FastSet=FastSet;Object.addEach(FastSet.prototype,GenericCollection.prototype);Object.addEach(FastSet.prototype,GenericSet.prototype);Object.addEach(FastSet.prototype,PropertyChanges.prototype);FastSet.prototype.Buckets=Dict;FastSet.prototype.Bucket=List;FastSet.prototype.constructClone=function(values){return new this.constructor(values,this.contentEquals,this.contentHash,this.getDefault)};FastSet.prototype.has=function(value){var hash=this.contentHash(value);return this.buckets.get(hash).has(value)};FastSet.prototype.get=function(value){var hash=this.contentHash(value);var buckets=this.buckets;if(buckets.has(hash)){return buckets.get(hash).get(value)}else{return this.getDefault(value)}};FastSet.prototype["delete"]=function(value){var hash=this.contentHash(value);var buckets=this.buckets;if(buckets.has(hash)){var bucket=buckets.get(hash);if(bucket["delete"](value)){this.length--;if(bucket.length===0){buckets["delete"](hash)}return true}}return false};FastSet.prototype.clear=function(){this.buckets.clear();this.length=0};FastSet.prototype.add=function(value){var hash=this.contentHash(value);var buckets=this.buckets;if(!buckets.has(hash)){buckets.set(hash,new this.Bucket(null,this.contentEquals))}if(!buckets.get(hash).has(value)){buckets.get(hash).add(value);this.length++;return true}return false};FastSet.prototype.reduce=function(callback,basis){var thisp=arguments[2];var buckets=this.buckets;var index=0;return buckets.reduce(function(basis,bucket){return bucket.reduce(function(basis,value){return callback.call(thisp,basis,value,index++,this)},basis,this)},basis,this)};FastSet.prototype.one=function(){if(this.length>0){return this.buckets.one().one()}};FastSet.prototype.iterate=function(){return this.buckets.values().flatten().iterate()};FastSet.prototype.log=function(charmap,logNode,callback,thisp){charmap=charmap||TreeLog.unicodeSharp;logNode=logNode||this.logNode;if(!callback){callback=console.log;thisp=console}callback=callback.bind(thisp);var buckets=this.buckets;var hashes=buckets.keys();hashes.forEach(function(hash,index){var branch;var leader;if(index===hashes.length-1){branch=charmap.fromAbove;leader=" "}else if(index===0){branch=charmap.branchDown;leader=charmap.strafe}else{branch=charmap.fromBoth;leader=charmap.strafe}var bucket=buckets.get(hash);callback.call(thisp,branch+charmap.through+charmap.branchDown+" "+hash);bucket.forEach(function(value,node){var branch,below;if(node===bucket.head.prev){branch=charmap.fromAbove;below=" "}else{branch=charmap.fromBoth;below=charmap.strafe}var written;logNode(node,function(line){if(!written){callback.call(thisp,leader+" "+branch+charmap.through+charmap.through+line);written=true}else{callback.call(thisp,leader+" "+below+"  "+line)}},function(line){callback.call(thisp,leader+" "+charmap.strafe+"  "+line)})})})};FastSet.prototype.logNode=function(node,write){var value=node.value;if(Object(value)===value){JSON.stringify(value,null,4).split("\n").forEach(function(line){write(" "+line)})}else{write(" "+value)}}},{"./dict":193,"./generic-collection":196,"./generic-set":199,"./list":200,"./listen/property-changes":202,"./shim":209,"./tree-log":210}],196:[function(require,module,exports){"use strict";module.exports=GenericCollection;function GenericCollection(){throw new Error("Can't construct. GenericCollection is a mixin.")}GenericCollection.prototype.addEach=function(values){if(values&&Object(values)===values){if(typeof values.forEach==="function"){values.forEach(this.add,this)}else if(typeof values.length==="number"){for(var i=0;i<values.length;i++){this.add(values[i],i)}}else{Object.keys(values).forEach(function(key){this.add(values[key],key)},this)}}return this};GenericCollection.prototype.deleteEach=function(values,equals){values.forEach(function(value){this["delete"](value,equals)},this);return this};GenericCollection.prototype.forEach=function(callback){var thisp=arguments[1];return this.reduce(function(undefined,value,key,object,depth){callback.call(thisp,value,key,object,depth)},undefined)};GenericCollection.prototype.map=function(callback){var thisp=arguments[1];var result=[];this.reduce(function(undefined,value,key,object,depth){result.push(callback.call(thisp,value,key,object,depth))},undefined);return result};GenericCollection.prototype.enumerate=function(start){if(start==null){start=0}var result=[];this.reduce(function(undefined,value){result.push([start++,value])},undefined);return result};GenericCollection.prototype.group=function(callback,thisp,equals){equals=equals||Object.equals;var groups=[];var keys=[];this.forEach(function(value,key,object){var key=callback.call(thisp,value,key,object);var index=keys.indexOf(key,equals);var group;if(index===-1){group=[];groups.push([key,group]);keys.push(key)}else{group=groups[index][1]}group.push(value)});return groups};GenericCollection.prototype.toArray=function(){return this.map(Function.identity)};GenericCollection.prototype.toObject=function(){var object={};this.reduce(function(undefined,value,key){object[key]=value},undefined);return object};GenericCollection.prototype.filter=function(callback){var thisp=arguments[1];var result=this.constructClone();this.reduce(function(undefined,value,key,object,depth){if(callback.call(thisp,value,key,object,depth)){result.add(value)}},undefined);return result};GenericCollection.prototype.every=function(callback){var thisp=arguments[1];return this.reduce(function(result,value,key,object,depth){return result&&callback.call(thisp,value,key,object,depth)},true)};GenericCollection.prototype.some=function(callback){var thisp=arguments[1];return this.reduce(function(result,value,key,object,depth){return result||callback.call(thisp,value,key,object,depth)},false)};GenericCollection.prototype.all=function(){return this.every(Boolean)};GenericCollection.prototype.any=function(){return this.some(Boolean)};GenericCollection.prototype.min=function(compare){compare=compare||this.contentCompare||Object.compare;var first=true;return this.reduce(function(result,value){if(first){first=false;return value}else{return compare(value,result)<0?value:result}},undefined)};GenericCollection.prototype.max=function(compare){compare=compare||this.contentCompare||Object.compare;var first=true;return this.reduce(function(result,value){if(first){first=false;return value}else{return compare(value,result)>0?value:result}},undefined)};GenericCollection.prototype.sum=function(zero){zero=zero===undefined?0:zero;return this.reduce(function(a,b){return a+b},zero)};GenericCollection.prototype.average=function(zero){var sum=zero===undefined?0:zero;var count=zero===undefined?0:zero;this.reduce(function(undefined,value){sum+=value;count+=1},undefined);return sum/count};GenericCollection.prototype.concat=function(){var result=this.constructClone(this);for(var i=0;i<arguments.length;i++){result.addEach(arguments[i])}return result};GenericCollection.prototype.flatten=function(){var self=this;return this.reduce(function(result,array){array.forEach(function(value){this.push(value)},result,self);return result},[])};GenericCollection.prototype.zip=function(){var table=Array.prototype.slice.call(arguments);table.unshift(this);return Array.unzip(table)};GenericCollection.prototype.join=function(delimiter){return this.reduce(function(result,string){return result+delimiter+string})};GenericCollection.prototype.sorted=function(compare,by,order){compare=compare||this.contentCompare||Object.compare;if(compare.by){by=compare.by;compare=compare.compare||this.contentCompare||Object.compare}else{by=by||Function.identity}if(order===undefined)order=1;return this.map(function(item){return{by:by(item),value:item}}).sort(function(a,b){return compare(a.by,b.by)*order}).map(function(pair){return pair.value})};GenericCollection.prototype.reversed=function(){return this.constructClone(this).reverse()};GenericCollection.prototype.clone=function(depth,memo){if(depth===undefined){depth=Infinity}else if(depth===0){return this}var clone=this.constructClone();this.forEach(function(value,key){clone.add(Object.clone(value,depth-1,memo),key)},this);return clone};GenericCollection.prototype.only=function(){if(this.length===1){return this.one()}};GenericCollection.prototype.iterator=function(){return this.iterate.apply(this,arguments)};require("./shim-array")},{"./shim-array":205}],197:[function(require,module,exports){"use strict";var Object=require("./shim-object");var MapChanges=require("./listen/map-changes");var PropertyChanges=require("./listen/property-changes");module.exports=GenericMap;function GenericMap(){throw new Error("Can't construct. GenericMap is a mixin.")}Object.addEach(GenericMap.prototype,MapChanges.prototype);Object.addEach(GenericMap.prototype,PropertyChanges.prototype);GenericMap.prototype.isMap=true;GenericMap.prototype.addEach=function(values){if(values&&Object(values)===values){if(typeof values.forEach==="function"){if(values.isMap===true){values.forEach(function(value,key){this.set(key,value)},this)}else{values.forEach(function(pair){this.set(pair[0],pair[1])},this)}}else{Object.keys(values).forEach(function(key){this.set(key,values[key])},this)}}return this};GenericMap.prototype.get=function(key,defaultValue){var item=this.store.get(new this.Item(key));if(item){return item.value}else if(arguments.length>1){return defaultValue}else{return this.getDefault(key)}};GenericMap.prototype.set=function(key,value){var item=new this.Item(key,value);var found=this.store.get(item);var grew=false;if(found){if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,found.value)}found.value=value;if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}}else{if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,undefined)}if(this.store.add(item)){this.length++;grew=true}if(this.dispatchesMapChanges){this.dispatchMapChange(key,value)}}return grew};GenericMap.prototype.add=function(value,key){return this.set(key,value)};GenericMap.prototype.has=function(key){return this.store.has(new this.Item(key))};GenericMap.prototype["delete"]=function(key){var item=new this.Item(key);if(this.store.has(item)){var from=this.store.get(item).value;if(this.dispatchesMapChanges){this.dispatchBeforeMapChange(key,from)}this.store["delete"](item);this.length--;if(this.dispatchesMapChanges){this.dispatchMapChange(key,undefined)}return true}return false};GenericMap.prototype.clear=function(){var keys;if(this.dispatchesMapChanges){this.forEach(function(value,key){this.dispatchBeforeMapChange(key,value)},this);keys=this.keys()}this.store.clear();this.length=0;if(this.dispatchesMapChanges){keys.forEach(function(key){this.dispatchMapChange(key)},this)}};GenericMap.prototype.reduce=function(callback,basis,thisp){return this.store.reduce(function(basis,item){return callback.call(thisp,basis,item.value,item.key,this)},basis,this)};GenericMap.prototype.reduceRight=function(callback,basis,thisp){return this.store.reduceRight(function(basis,item){return callback.call(thisp,basis,item.value,item.key,this)},basis,this)};GenericMap.prototype.keys=function(){return this.map(function(value,key){return key})};GenericMap.prototype.values=function(){return this.map(Function.identity)};GenericMap.prototype.entries=function(){return this.map(function(value,key){return[key,value]})};GenericMap.prototype.items=function(){return this.entries()};GenericMap.prototype.equals=function(that,equals){equals=equals||Object.equals;if(this===that){return true}else if(Object.can(that,"every")){return that.length===this.length&&that.every(function(value,key){return equals(this.get(key),value)},this)}else{var keys=Object.keys(that);return keys.length===this.length&&Object.keys(that).every(function(key){return equals(this.get(key),that[key])},this)}};GenericMap.prototype.Item=Item;function Item(key,value){this.key=key;this.value=value}Item.prototype.equals=function(that){return Object.equals(this.key,that.key)&&Object.equals(this.value,that.value)};Item.prototype.compare=function(that){return Object.compare(this.key,that.key)}},{"./listen/map-changes":201,"./listen/property-changes":202,"./shim-object":207}],198:[function(require,module,exports){var Object=require("./shim-object");module.exports=GenericOrder;function GenericOrder(){throw new Error("Can't construct. GenericOrder is a mixin.")}GenericOrder.prototype.equals=function(that,equals){equals=equals||this.contentEquals||Object.equals;if(this===that){return true}if(!that){return false}var self=this;return this.length===that.length&&this.zip(that).every(function(pair){return equals(pair[0],pair[1])})};GenericOrder.prototype.compare=function(that,compare){compare=compare||this.contentCompare||Object.compare;
if(this===that){return 0}if(!that){return 1}var length=Math.min(this.length,that.length);var comparison=this.zip(that).reduce(function(comparison,pair,index){if(comparison===0){if(index>=length){return comparison}else{return compare(pair[0],pair[1])}}else{return comparison}},0);if(comparison===0){return this.length-that.length}return comparison}},{"./shim-object":207}],199:[function(require,module,exports){module.exports=GenericSet;function GenericSet(){throw new Error("Can't construct. GenericSet is a mixin.")}GenericSet.prototype.union=function(that){var union=this.constructClone(this);union.addEach(that);return union};GenericSet.prototype.intersection=function(that){return this.constructClone(this.filter(function(value){return that.has(value)}))};GenericSet.prototype.difference=function(that){var union=this.constructClone(this);union.deleteEach(that);return union};GenericSet.prototype.symmetricDifference=function(that){var union=this.union(that);var intersection=this.intersection(that);return union.difference(intersection)};GenericSet.prototype.equals=function(that,equals){var self=this;return Object.can(that,"reduce")&&this.length===that.length&&that.reduce(function(equal,value){return equal&&self.has(value,equals)},true)};GenericSet.prototype.contains=function(value){return this.has(value)};GenericSet.prototype.remove=function(value){return this["delete"](value)};GenericSet.prototype.toggle=function(value){if(this.has(value)){this["delete"](value)}else{this.add(value)}}},{}],200:[function(require,module,exports){"use strict";module.exports=List;var Shim=require("./shim");var GenericCollection=require("./generic-collection");var GenericOrder=require("./generic-order");var PropertyChanges=require("./listen/property-changes");var RangeChanges=require("./listen/range-changes");function List(values,equals,getDefault){if(!(this instanceof List)){return new List(values,equals,getDefault)}var head=this.head=new this.Node;head.next=head;head.prev=head;this.contentEquals=equals||Object.equals;this.getDefault=getDefault||Function.noop;this.length=0;this.addEach(values)}List.List=List;Object.addEach(List.prototype,GenericCollection.prototype);Object.addEach(List.prototype,GenericOrder.prototype);Object.addEach(List.prototype,PropertyChanges.prototype);Object.addEach(List.prototype,RangeChanges.prototype);List.prototype.constructClone=function(values){return new this.constructor(values,this.contentEquals,this.getDefault)};List.prototype.find=function(value,equals){equals=equals||this.contentEquals;var head=this.head;var at=head.next;while(at!==head){if(equals(at.value,value)){return at}at=at.next}};List.prototype.findLast=function(value,equals){equals=equals||this.contentEquals;var head=this.head;var at=head.prev;while(at!==head){if(equals(at.value,value)){return at}at=at.prev}};List.prototype.has=function(value,equals){return!!this.find(value,equals)};List.prototype.get=function(value,equals){var found=this.find(value,equals);if(found){return found.value}return this.getDefault(value)};List.prototype["delete"]=function(value,equals){var found=this.findLast(value,equals);if(found){if(this.dispatchesRangeChanges){var plus=[];var minus=[value];this.dispatchBeforeRangeChange(plus,minus,found.index)}found["delete"]();this.length--;if(this.dispatchesRangeChanges){this.updateIndexes(found.next,found.index);this.dispatchRangeChange(plus,minus,found.index)}return true}return false};List.prototype.clear=function(){var plus,minus;if(this.dispatchesRangeChanges){minus=this.toArray();plus=[];this.dispatchBeforeRangeChange(plus,minus,0)}this.head.next=this.head.prev=this.head;this.length=0;if(this.dispatchesRangeChanges){this.dispatchRangeChange(plus,minus,0)}};List.prototype.add=function(value){var node=new this.Node(value);if(this.dispatchesRangeChanges){node.index=this.length;this.dispatchBeforeRangeChange([value],[],node.index)}this.head.addBefore(node);this.length++;if(this.dispatchesRangeChanges){this.dispatchRangeChange([value],[],node.index)}return true};List.prototype.push=function(){var head=this.head;if(this.dispatchesRangeChanges){var plus=Array.prototype.slice.call(arguments);var minus=[];var index=this.length;this.dispatchBeforeRangeChange(plus,minus,index);var start=this.head.prev}for(var i=0;i<arguments.length;i++){var value=arguments[i];var node=new this.Node(value);head.addBefore(node)}this.length+=arguments.length;if(this.dispatchesRangeChanges){this.updateIndexes(start.next,start.index===undefined?0:start.index+1);this.dispatchRangeChange(plus,minus,index)}};List.prototype.unshift=function(){if(this.dispatchesRangeChanges){var plus=Array.prototype.slice.call(arguments);var minus=[];this.dispatchBeforeRangeChange(plus,minus,0)}var at=this.head;for(var i=0;i<arguments.length;i++){var value=arguments[i];var node=new this.Node(value);at.addAfter(node);at=node}this.length+=arguments.length;if(this.dispatchesRangeChanges){this.updateIndexes(this.head.next,0);this.dispatchRangeChange(plus,minus,0)}};List.prototype.pop=function(){var value;var head=this.head;if(head.prev!==head){value=head.prev.value;if(this.dispatchesRangeChanges){var plus=[];var minus=[value];var index=this.length-1;this.dispatchBeforeRangeChange(plus,minus,index)}head.prev["delete"]();this.length--;if(this.dispatchesRangeChanges){this.dispatchRangeChange(plus,minus,index)}}return value};List.prototype.shift=function(){var value;var head=this.head;if(head.prev!==head){value=head.next.value;if(this.dispatchesRangeChanges){var plus=[];var minus=[value];this.dispatchBeforeRangeChange(plus,minus,0)}head.next["delete"]();this.length--;if(this.dispatchesRangeChanges){this.updateIndexes(this.head.next,0);this.dispatchRangeChange(plus,minus,0)}}return value};List.prototype.peek=function(){if(this.head!==this.head.next){return this.head.next.value}};List.prototype.poke=function(value){if(this.head!==this.head.next){this.head.next.value=value}else{this.push(value)}};List.prototype.one=function(){return this.peek()};List.prototype.scan=function(at,fallback){var head=this.head;if(typeof at==="number"){var count=at;if(count>=0){at=head.next;while(count){count--;at=at.next;if(at==head){break}}}else{at=head;while(count<0){count++;at=at.prev;if(at==head){break}}}return at}else{return at||fallback}};List.prototype.slice=function(at,end){var sliced=[];var head=this.head;at=this.scan(at,head.next);end=this.scan(end,head);while(at!==end&&at!==head){sliced.push(at.value);at=at.next}return sliced};List.prototype.splice=function(at,length){return this.swap(at,length,Array.prototype.slice.call(arguments,2))};List.prototype.swap=function(start,length,plus){var initial=start;start=this.scan(start,this.head);if(length==null){length=Infinity}plus=Array.from(plus);var minus=[];var at=start;while(length--&&length>=0&&at!==this.head){minus.push(at.value);at=at.next}var index,startNode;if(this.dispatchesRangeChanges){if(start===this.head){index=this.length}else if(start.prev===this.head){index=0}else{index=start.index}startNode=start.prev;this.dispatchBeforeRangeChange(plus,minus,index)}var at=start;for(var i=0,at=start;i<minus.length;i++,at=at.next){at["delete"]()}if(initial==null&&at===this.head){at=this.head.next}for(var i=0;i<plus.length;i++){var node=new this.Node(plus[i]);at.addBefore(node)}this.length+=plus.length-minus.length;if(this.dispatchesRangeChanges){if(start===this.head){this.updateIndexes(this.head.next,0)}else{this.updateIndexes(startNode.next,startNode.index+1)}this.dispatchRangeChange(plus,minus,index)}return minus};List.prototype.reverse=function(){if(this.dispatchesRangeChanges){var minus=this.toArray();var plus=minus.reversed();this.dispatchBeforeRangeChange(plus,minus,0)}var at=this.head;do{var temp=at.next;at.next=at.prev;at.prev=temp;at=at.next}while(at!==this.head);if(this.dispatchesRangeChanges){this.dispatchRangeChange(plus,minus,0)}return this};List.prototype.sort=function(){this.swap(0,this.length,this.sorted())};List.prototype.reduce=function(callback,basis){var thisp=arguments[2];var head=this.head;var at=head.next;while(at!==head){basis=callback.call(thisp,basis,at.value,at,this);at=at.next}return basis};List.prototype.reduceRight=function(callback,basis){var thisp=arguments[2];var head=this.head;var at=head.prev;while(at!==head){basis=callback.call(thisp,basis,at.value,at,this);at=at.prev}return basis};List.prototype.updateIndexes=function(node,index){while(node!==this.head){node.index=index++;node=node.next}};List.prototype.makeObservable=function(){this.head.index=-1;this.updateIndexes(this.head.next,0);this.dispatchesRangeChanges=true};List.prototype.iterate=function(){return new ListIterator(this.head)};function ListIterator(head){this.head=head;this.at=head.next}ListIterator.prototype.next=function(){if(this.at===this.head){throw StopIteration}else{var value=this.at.value;this.at=this.at.next;return value}};List.prototype.Node=Node;function Node(value){this.value=value;this.prev=null;this.next=null}Node.prototype["delete"]=function(){this.prev.next=this.next;this.next.prev=this.prev};Node.prototype.addBefore=function(node){var prev=this.prev;this.prev=node;node.prev=prev;prev.next=node;node.next=this};Node.prototype.addAfter=function(node){var next=this.next;this.next=node;node.next=next;next.prev=node;node.prev=this}},{"./generic-collection":196,"./generic-order":198,"./listen/property-changes":202,"./listen/range-changes":203,"./shim":209}],201:[function(require,module,exports){"use strict";var WeakMap=require("weak-map");var List=require("../list");module.exports=MapChanges;function MapChanges(){throw new Error("Can't construct. MapChanges is a mixin.")}var object_owns=Object.prototype.hasOwnProperty;var mapChangeDescriptors=new WeakMap;MapChanges.prototype.getAllMapChangeDescriptors=function(){var Dict=require("../dict");if(!mapChangeDescriptors.has(this)){mapChangeDescriptors.set(this,Dict())}return mapChangeDescriptors.get(this)};MapChanges.prototype.getMapChangeDescriptor=function(token){var tokenChangeDescriptors=this.getAllMapChangeDescriptors();token=token||"";if(!tokenChangeDescriptors.has(token)){tokenChangeDescriptors.set(token,{willChangeListeners:new List,changeListeners:new List})}return tokenChangeDescriptors.get(token)};MapChanges.prototype.addMapChangeListener=function(listener,token,beforeChange){if(!this.isObservable&&this.makeObservable){this.makeObservable()}var descriptor=this.getMapChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}listeners.push(listener);Object.defineProperty(this,"dispatchesMapChanges",{value:true,writable:true,configurable:true,enumerable:false});var self=this;return function cancelMapChangeListener(){if(!self){return}self.removeMapChangeListener(listener,token,beforeChange);self=null}};MapChanges.prototype.removeMapChangeListener=function(listener,token,beforeChange){var descriptor=this.getMapChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var node=listeners.findLast(listener);if(!node){throw new Error("Can't remove listener: does not exist.")}node["delete"]()};MapChanges.prototype.dispatchMapChange=function(key,value,beforeChange){var descriptors=this.getAllMapChangeDescriptors();var changeName="Map"+(beforeChange?"WillChange":"Change");descriptors.forEach(function(descriptor,token){if(descriptor.isActive){return}else{descriptor.isActive=true}var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var tokenName="handle"+(token.slice(0,1).toUpperCase()+token.slice(1))+changeName;try{listeners.forEach(function(listener){if(listener[tokenName]){listener[tokenName](value,key,this)}else if(listener.call){listener.call(listener,value,key,this)}else{throw new Error("Handler "+listener+" has no method "+tokenName+" and is not callable")}},this)}finally{descriptor.isActive=false}},this)};MapChanges.prototype.addBeforeMapChangeListener=function(listener,token){return this.addMapChangeListener(listener,token,true)};MapChanges.prototype.removeBeforeMapChangeListener=function(listener,token){return this.removeMapChangeListener(listener,token,true)};MapChanges.prototype.dispatchBeforeMapChange=function(key,value){return this.dispatchMapChange(key,value,true)}},{"../dict":193,"../list":200,"weak-map":204}],202:[function(require,module,exports){require("../shim");var WeakMap=require("weak-map");var object_owns=Object.prototype.hasOwnProperty;var propertyChangeDescriptors=new WeakMap;var overriddenObjectDescriptors=new WeakMap;module.exports=PropertyChanges;function PropertyChanges(){throw new Error("This is an abstract interface. Mix it. Don't construct it")}PropertyChanges.debug=true;PropertyChanges.prototype.getOwnPropertyChangeDescriptor=function(key){if(!propertyChangeDescriptors.has(this)){propertyChangeDescriptors.set(this,{})}var objectPropertyChangeDescriptors=propertyChangeDescriptors.get(this);if(!object_owns.call(objectPropertyChangeDescriptors,key)){objectPropertyChangeDescriptors[key]={willChangeListeners:[],changeListeners:[]}}return objectPropertyChangeDescriptors[key]};PropertyChanges.prototype.hasOwnPropertyChangeDescriptor=function(key){if(!propertyChangeDescriptors.has(this)){return false}if(!key){return true}var objectPropertyChangeDescriptors=propertyChangeDescriptors.get(this);if(!object_owns.call(objectPropertyChangeDescriptors,key)){return false}return true};PropertyChanges.prototype.addOwnPropertyChangeListener=function(key,listener,beforeChange){if(this.makeObservable&&!this.isObservable){this.makeObservable()}var descriptor=PropertyChanges.getOwnPropertyChangeDescriptor(this,key);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}PropertyChanges.makePropertyObservable(this,key);listeners.push(listener);var self=this;return function cancelOwnPropertyChangeListener(){PropertyChanges.removeOwnPropertyChangeListener(self,key,listeners,beforeChange);self=null}};PropertyChanges.prototype.addBeforeOwnPropertyChangeListener=function(key,listener){return PropertyChanges.addOwnPropertyChangeListener(this,key,listener,true)};PropertyChanges.prototype.removeOwnPropertyChangeListener=function(key,listener,beforeChange){var descriptor=PropertyChanges.getOwnPropertyChangeDescriptor(this,key);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var index=listeners.lastIndexOf(listener);if(index===-1){throw new Error("Can't remove listener: does not exist.")}listeners.splice(index,1);if(descriptor.changeListeners.length+descriptor.willChangeListeners.length===0){PropertyChanges.makePropertyUnobservable(this,key)}};PropertyChanges.prototype.removeBeforeOwnPropertyChangeListener=function(key,listener){return PropertyChanges.removeOwnPropertyChangeListener(this,key,listener,true)};PropertyChanges.prototype.dispatchOwnPropertyChange=function(key,value,beforeChange){var descriptor=PropertyChanges.getOwnPropertyChangeDescriptor(this,key);if(descriptor.isActive){return}descriptor.isActive=true;var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var changeName=(beforeChange?"Will":"")+"Change";var genericHandlerName="handleProperty"+changeName;var propertyName=String(key);propertyName=propertyName&&propertyName[0].toUpperCase()+propertyName.slice(1);var specificHandlerName="handle"+propertyName+changeName;try{listeners.forEach(function(listener){var thisp=listener;listener=listener[specificHandlerName]||listener[genericHandlerName]||listener;if(!listener.call){throw new Error("No event listener for "+specificHandlerName+" or "+genericHandlerName+" or call on "+listener)}listener.call(thisp,value,key,this)},this)}finally{descriptor.isActive=false}};PropertyChanges.prototype.dispatchBeforeOwnPropertyChange=function(key,listener){return PropertyChanges.dispatchOwnPropertyChange(this,key,listener,true)};PropertyChanges.prototype.makePropertyObservable=function(key){if(Array.isArray(this)){return}if(!Object.isExtensible(this,key)){throw new Error("Can't make property "+JSON.stringify(key)+" observable on "+this+" because object is not extensible")}var state;if(typeof this.__state__==="object"){state=this.__state__}else{state={};if(Object.isExtensible(this,"__state__")){Object.defineProperty(this,"__state__",{value:state,writable:true,enumerable:false})}}state[key]=this[key];if(!overriddenObjectDescriptors.has(this)){overriddenPropertyDescriptors={};overriddenObjectDescriptors.set(this,overriddenPropertyDescriptors)}var overriddenPropertyDescriptors=overriddenObjectDescriptors.get(this);if(object_owns.call(overriddenPropertyDescriptors,key)){return}var overriddenDescriptor;var attached=this;var formerDescriptor=Object.getOwnPropertyDescriptor(attached,key);do{overriddenDescriptor=Object.getOwnPropertyDescriptor(attached,key);if(overriddenDescriptor){break}attached=Object.getPrototypeOf(attached)}while(attached);overriddenDescriptor=overriddenDescriptor||{value:undefined,enumerable:true,writable:true,configurable:true};if(!overriddenDescriptor.configurable){throw new Error("Can't observe non-configurable properties")}overriddenPropertyDescriptors[key]=overriddenDescriptor;if(!overriddenDescriptor.writable&&!overriddenDescriptor.set){return}var propertyListener;if("value"in overriddenDescriptor){propertyListener={get:function(){return overriddenDescriptor.value},set:function(value){if(value===overriddenDescriptor.value){return value}PropertyChanges.dispatchBeforeOwnPropertyChange(this,key,overriddenDescriptor.value);overriddenDescriptor.value=value;state[key]=value;PropertyChanges.dispatchOwnPropertyChange(this,key,value);return value},enumerable:overriddenDescriptor.enumerable,configurable:true}}else{propertyListener={get:function(){if(overriddenDescriptor.get){return overriddenDescriptor.get.apply(this,arguments)}},set:function(value){var formerValue;if(overriddenDescriptor.get){formerValue=overriddenDescriptor.get.apply(this,arguments)}if(overriddenDescriptor.set){overriddenDescriptor.set.apply(this,arguments)}if(overriddenDescriptor.get){value=overriddenDescriptor.get.apply(this,arguments);state[key]=value}if(value===formerValue){return value}PropertyChanges.dispatchBeforeOwnPropertyChange(this,key,formerValue);PropertyChanges.dispatchOwnPropertyChange(this,key,value);return value},enumerable:overriddenDescriptor.enumerable,configurable:true}}Object.defineProperty(this,key,propertyListener)};PropertyChanges.prototype.makePropertyUnobservable=function(key){if(Array.isArray(this)){return}if(!overriddenObjectDescriptors.has(this)){throw new Error("Can't uninstall observer on property")}var overriddenPropertyDescriptors=overriddenObjectDescriptors.get(this);if(!overriddenPropertyDescriptors[key]){throw new Error("Can't uninstall observer on property")}var overriddenDescriptor=overriddenPropertyDescriptors[key];delete overriddenPropertyDescriptors[key];var state;if(typeof this.__state__==="object"){state=this.__state__}else{state={};if(Object.isExtensible(this,"__state__")){Object.defineProperty(this,"__state__",{value:state,writable:true,enumerable:false})}}delete state[key];Object.defineProperty(this,key,overriddenDescriptor)};PropertyChanges.getOwnPropertyChangeDescriptor=function(object,key){if(object.getOwnPropertyChangeDescriptor){return object.getOwnPropertyChangeDescriptor(key)}else{return PropertyChanges.prototype.getOwnPropertyChangeDescriptor.call(object,key)}};PropertyChanges.hasOwnPropertyChangeDescriptor=function(object,key){if(object.hasOwnPropertyChangeDescriptor){return object.hasOwnPropertyChangeDescriptor(key)}else{return PropertyChanges.prototype.hasOwnPropertyChangeDescriptor.call(object,key)}};PropertyChanges.addOwnPropertyChangeListener=function(object,key,listener,beforeChange){if(!Object.isObject(object)){}else if(object.addOwnPropertyChangeListener){return object.addOwnPropertyChangeListener(key,listener,beforeChange)}else{return PropertyChanges.prototype.addOwnPropertyChangeListener.call(object,key,listener,beforeChange)}};PropertyChanges.removeOwnPropertyChangeListener=function(object,key,listener,beforeChange){if(!Object.isObject(object)){}else if(object.removeOwnPropertyChangeListener){return object.removeOwnPropertyChangeListener(key,listener,beforeChange)}else{return PropertyChanges.prototype.removeOwnPropertyChangeListener.call(object,key,listener,beforeChange)}};PropertyChanges.dispatchOwnPropertyChange=function(object,key,value,beforeChange){if(!Object.isObject(object)){}else if(object.dispatchOwnPropertyChange){return object.dispatchOwnPropertyChange(key,value,beforeChange)}else{return PropertyChanges.prototype.dispatchOwnPropertyChange.call(object,key,value,beforeChange)}};PropertyChanges.addBeforeOwnPropertyChangeListener=function(object,key,listener){return PropertyChanges.addOwnPropertyChangeListener(object,key,listener,true)};PropertyChanges.removeBeforeOwnPropertyChangeListener=function(object,key,listener){return PropertyChanges.removeOwnPropertyChangeListener(object,key,listener,true)};PropertyChanges.dispatchBeforeOwnPropertyChange=function(object,key,value){return PropertyChanges.dispatchOwnPropertyChange(object,key,value,true)};PropertyChanges.makePropertyObservable=function(object,key){if(object.makePropertyObservable){return object.makePropertyObservable(key)}else{return PropertyChanges.prototype.makePropertyObservable.call(object,key)}};PropertyChanges.makePropertyUnobservable=function(object,key){if(object.makePropertyUnobservable){return object.makePropertyUnobservable(key)}else{return PropertyChanges.prototype.makePropertyUnobservable.call(object,key)}}},{"../shim":209,"weak-map":204}],203:[function(require,module,exports){"use strict";var WeakMap=require("weak-map");var Dict=require("../dict");var rangeChangeDescriptors=new WeakMap;module.exports=RangeChanges;function RangeChanges(){throw new Error("Can't construct. RangeChanges is a mixin.")}RangeChanges.prototype.getAllRangeChangeDescriptors=function(){if(!rangeChangeDescriptors.has(this)){rangeChangeDescriptors.set(this,Dict())}return rangeChangeDescriptors.get(this)};RangeChanges.prototype.getRangeChangeDescriptor=function(token){var tokenChangeDescriptors=this.getAllRangeChangeDescriptors();token=token||"";if(!tokenChangeDescriptors.has(token)){tokenChangeDescriptors.set(token,{isActive:false,changeListeners:[],willChangeListeners:[]})}return tokenChangeDescriptors.get(token)};RangeChanges.prototype.addRangeChangeListener=function(listener,token,beforeChange){if(!this.isObservable&&this.makeObservable){this.makeObservable()}var descriptor=this.getRangeChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}listeners.push(listener);Object.defineProperty(this,"dispatchesRangeChanges",{value:true,writable:true,configurable:true,enumerable:false});var self=this;return function cancelRangeChangeListener(){if(!self){return}self.removeRangeChangeListener(listener,token,beforeChange);self=null}};RangeChanges.prototype.removeRangeChangeListener=function(listener,token,beforeChange){var descriptor=this.getRangeChangeDescriptor(token);var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var index=listeners.lastIndexOf(listener);if(index===-1){throw new Error("Can't remove listener: does not exist.")}listeners.splice(index,1)};RangeChanges.prototype.dispatchRangeChange=function(plus,minus,index,beforeChange){var descriptors=this.getAllRangeChangeDescriptors();var changeName="Range"+(beforeChange?"WillChange":"Change");descriptors.forEach(function(descriptor,token){if(descriptor.isActive){return}else{descriptor.isActive=true}var listeners;if(beforeChange){listeners=descriptor.willChangeListeners}else{listeners=descriptor.changeListeners}var tokenName="handle"+(token.slice(0,1).toUpperCase()+token.slice(1))+changeName;try{listeners.forEach(function(listener){if(listener[tokenName]){listener[tokenName](plus,minus,index,this,beforeChange)}else if(listener.call){listener.call(this,plus,minus,index,this,beforeChange)}else{throw new Error("Handler "+listener+" has no method "+tokenName+" and is not callable")}},this)}finally{descriptor.isActive=false}},this)};RangeChanges.prototype.addBeforeRangeChangeListener=function(listener,token){return this.addRangeChangeListener(listener,token,true)};RangeChanges.prototype.removeBeforeRangeChangeListener=function(listener,token){return this.removeRangeChangeListener(listener,token,true)};RangeChanges.prototype.dispatchBeforeRangeChange=function(plus,minus,index){return this.dispatchRangeChange(plus,minus,index,true)}},{"../dict":193,"weak-map":204}],204:[function(require,module,exports){(function WeakMapModule(){"use strict";if(typeof ses!=="undefined"&&ses.ok&&!ses.ok()){return}function weakMapPermitHostObjects(map){if(map.permitHostObjects___){map.permitHostObjects___(weakMapPermitHostObjects)}}if(typeof ses!=="undefined"){ses.weakMapPermitHostObjects=weakMapPermitHostObjects}if(typeof WeakMap==="function"){var HostWeakMap=WeakMap;if(typeof navigator!=="undefined"&&/Firefox/.test(navigator.userAgent)){}else{module.exports=WeakMap;return}}var hop=Object.prototype.hasOwnProperty;var gopn=Object.getOwnPropertyNames;var defProp=Object.defineProperty;var isExtensible=Object.isExtensible;var HIDDEN_NAME_PREFIX="weakmap:";var HIDDEN_NAME=HIDDEN_NAME_PREFIX+"ident:"+Math.random()+"___";if(typeof crypto!=="undefined"&&typeof crypto.getRandomValues==="function"&&typeof ArrayBuffer==="function"&&typeof Uint8Array==="function"){var ab=new ArrayBuffer(25);var u8s=new Uint8Array(ab);crypto.getRandomValues(u8s);HIDDEN_NAME=HIDDEN_NAME_PREFIX+"rand:"+Array.prototype.map.call(u8s,function(u8){return(u8%36).toString(36)}).join("")+"___"}function isNotHiddenName(name){return!(name.substr(0,HIDDEN_NAME_PREFIX.length)==HIDDEN_NAME_PREFIX&&name.substr(name.length-3)==="___")}defProp(Object,"getOwnPropertyNames",{value:function fakeGetOwnPropertyNames(obj){return gopn(obj).filter(isNotHiddenName)}});if("getPropertyNames"in Object){var originalGetPropertyNames=Object.getPropertyNames;defProp(Object,"getPropertyNames",{value:function fakeGetPropertyNames(obj){return originalGetPropertyNames(obj).filter(isNotHiddenName)}})}function getHiddenRecord(key){if(key!==Object(key)){throw new TypeError("Not an object: "+key)}var hiddenRecord=key[HIDDEN_NAME];if(hiddenRecord&&hiddenRecord.key===key){return hiddenRecord}if(!isExtensible(key)){return void 0}var gets=[];var vals=[];hiddenRecord={key:key,gets:gets,vals:vals};defProp(key,HIDDEN_NAME,{value:hiddenRecord,writable:false,enumerable:false,configurable:false});return hiddenRecord}(function(){var oldFreeze=Object.freeze;defProp(Object,"freeze",{value:function identifyingFreeze(obj){getHiddenRecord(obj);return oldFreeze(obj)}});var oldSeal=Object.seal;defProp(Object,"seal",{value:function identifyingSeal(obj){getHiddenRecord(obj);return oldSeal(obj)}});var oldPreventExtensions=Object.preventExtensions;defProp(Object,"preventExtensions",{value:function identifyingPreventExtensions(obj){getHiddenRecord(obj);return oldPreventExtensions(obj)}})})();function constFunc(func){func.prototype=null;return Object.freeze(func)}var OurWeakMap=function(){var keys=[];var vals=[];function get___(key,opt_default){var hr=getHiddenRecord(key);var i,vs;if(hr){i=hr.gets.indexOf(get___);vs=hr.vals}else{i=keys.indexOf(key);vs=vals}return i>=0?vs[i]:opt_default}function has___(key){var hr=getHiddenRecord(key);var i;if(hr){i=hr.gets.indexOf(get___)}else{i=keys.indexOf(key)}return i>=0}function set___(key,value){var hr=getHiddenRecord(key);var i;if(hr){i=hr.gets.indexOf(get___);if(i>=0){hr.vals[i]=value}else{hr.gets.push(get___);hr.vals.push(value)}}else{i=keys.indexOf(key);if(i>=0){vals[i]=value}else{keys.push(key);vals.push(value)}}}function delete___(key){var hr=getHiddenRecord(key);var i;if(hr){i=hr.gets.indexOf(get___);if(i>=0){hr.gets.splice(i,1);hr.vals.splice(i,1)}}else{i=keys.indexOf(key);if(i>=0){keys.splice(i,1);vals.splice(i,1)}}return true}return Object.create(OurWeakMap.prototype,{get___:{value:constFunc(get___)},has___:{value:constFunc(has___)},set___:{value:constFunc(set___)},delete___:{value:constFunc(delete___)}})};OurWeakMap.prototype=Object.create(Object.prototype,{get:{value:function get(key,opt_default){return this.get___(key,opt_default)},writable:true,configurable:true},has:{value:function has(key){return this.has___(key)},writable:true,configurable:true},set:{value:function set(key,value){this.set___(key,value)},writable:true,configurable:true},"delete":{value:function remove(key){return this.delete___(key)},writable:true,configurable:true}});if(typeof HostWeakMap==="function"){(function(){function DoubleWeakMap(){var hmap=new HostWeakMap;var omap=undefined;var enableSwitching=false;function dget(key,opt_default){if(omap){return hmap.has(key)?hmap.get(key):omap.get___(key,opt_default)}else{return hmap.get(key,opt_default)}}function dhas(key){return hmap.has(key)||(omap?omap.has___(key):false)}function dset(key,value){if(enableSwitching){try{hmap.set(key,value)}catch(e){if(!omap){omap=new OurWeakMap}omap.set___(key,value)}}else{hmap.set(key,value)}}function ddelete(key){hmap["delete"](key);if(omap){omap.delete___(key)}}return Object.create(OurWeakMap.prototype,{get___:{value:constFunc(dget)},has___:{value:constFunc(dhas)},set___:{value:constFunc(dset)},delete___:{value:constFunc(ddelete)},permitHostObjects___:{value:constFunc(function(token){if(token===weakMapPermitHostObjects){enableSwitching=true}else{throw new Error("bogus call to permitHostObjects___")}})}})}DoubleWeakMap.prototype=OurWeakMap.prototype;module.exports=DoubleWeakMap;Object.defineProperty(WeakMap.prototype,"constructor",{value:WeakMap,enumerable:false,configurable:true,writable:true})})()}else{if(typeof Proxy!=="undefined"){Proxy=undefined}module.exports=OurWeakMap}})()},{}],205:[function(require,module,exports){"use strict";var Function=require("./shim-function");var GenericCollection=require("./generic-collection");var GenericOrder=require("./generic-order");var WeakMap=require("weak-map");module.exports=Array;Array.empty=[];if(Object.freeze){Object.freeze(Array.empty)}Array.from=function(values){var array=[];array.addEach(values);return array};Array.unzip=function(table){var transpose=[];var length=Infinity;for(var i=0;i<table.length;i++){var row=table[i];table[i]=row.toArray();if(row.length<length){length=row.length}}for(var i=0;i<table.length;i++){var row=table[i];for(var j=0;j<row.length;j++){if(j<length&&j in row){transpose[j]=transpose[j]||[];transpose[j][i]=row[j]}}}return transpose};function define(key,value){Object.defineProperty(Array.prototype,key,{value:value,writable:true,configurable:true,enumerable:false})}define("addEach",GenericCollection.prototype.addEach);define("deleteEach",GenericCollection.prototype.deleteEach);define("toArray",GenericCollection.prototype.toArray);define("toObject",GenericCollection.prototype.toObject);define("all",GenericCollection.prototype.all);define("any",GenericCollection.prototype.any);define("min",GenericCollection.prototype.min);define("max",GenericCollection.prototype.max);define("sum",GenericCollection.prototype.sum);define("average",GenericCollection.prototype.average);define("only",GenericCollection.prototype.only);define("flatten",GenericCollection.prototype.flatten);define("zip",GenericCollection.prototype.zip);define("enumerate",GenericCollection.prototype.enumerate);define("group",GenericCollection.prototype.group);define("sorted",GenericCollection.prototype.sorted);define("reversed",GenericCollection.prototype.reversed);define("constructClone",function(values){var clone=new this.constructor;clone.addEach(values);return clone});define("has",function(value,equals){return this.find(value,equals)!==-1});define("get",function(index,defaultValue){if(+index!==index)throw new Error("Indicies must be numbers");
if(!index in this){return defaultValue}else{return this[index]}});define("set",function(index,value){this.splice(index,1,value);return true});define("add",function(value){this.push(value);return true});define("delete",function(value,equals){var index=this.find(value,equals);if(index!==-1){this.splice(index,1);return true}return false});define("find",function(value,equals){equals=equals||this.contentEquals||Object.equals;for(var index=0;index<this.length;index++){if(index in this&&equals(this[index],value)){return index}}return-1});define("findLast",function(value,equals){equals=equals||this.contentEquals||Object.equals;var index=this.length;do{index--;if(index in this&&equals(this[index],value)){return index}}while(index>0);return-1});define("swap",function(index,length,plus){var args=Array.prototype.slice.call(arguments,0,2);if(plus){if(!Array.isArray(plus)){plus=Array.prototype.slice.call(plus)}args.push.apply(args,plus)}return this.splice.apply(this,args)});define("one",function(){for(var i in this){if(Object.owns(this,i)){return this[i]}}});define("clear",function(){this.length=0;return this});define("compare",function(that,compare){compare=compare||Object.compare;var i;var length;var lhs;var rhs;var relative;if(this===that){return 0}if(!that||!Array.isArray(that)){return GenericOrder.prototype.compare.call(this,that,compare)}length=Math.min(this.length,that.length);for(i=0;i<length;i++){if(i in this){if(!(i in that)){return-1}else{lhs=this[i];rhs=that[i];relative=compare(lhs,rhs);if(relative){return relative}}}else if(i in that){return 1}}return this.length-that.length});define("equals",function(that,equals){equals=equals||Object.equals;var i=0;var length=this.length;var left;var right;if(this===that){return true}if(!that||!Array.isArray(that)){return GenericOrder.prototype.equals.call(this,that)}if(length!==that.length){return false}else{for(;i<length;++i){if(i in this){if(!(i in that)){return false}left=this[i];right=that[i];if(!equals(left,right)){return false}}else{if(i in that){return false}}}}return true});define("clone",function(depth,memo){if(depth===undefined){depth=Infinity}else if(depth===0){return this}memo=memo||new WeakMap;var clone=[];for(var i in this){if(Object.owns(this,i)){clone[i]=Object.clone(this[i],depth-1,memo)}}return clone});define("iterate",function(start,end){return new ArrayIterator(this,start,end)});define("Iterator",ArrayIterator);function ArrayIterator(array,start,end){this.array=array;this.start=start==null?0:start;this.end=end}ArrayIterator.prototype.next=function(){if(this.start===(this.end==null?this.array.length:this.end)){throw StopIteration}else{return this.array[this.start++]}}},{"./generic-collection":196,"./generic-order":198,"./shim-function":206,"weak-map":204}],206:[function(require,module,exports){module.exports=Function;Function.noop=function(){};Function.identity=function(value){return value};Function.by=function(by,compare){compare=compare||Object.compare;by=by||Function.identity;var compareBy=function(a,b){return compare(by(a),by(b))};compareBy.compare=compare;compareBy.by=by;return compareBy};Function.get=function(key){return function(object){return Object.get(object,key)}}},{}],207:[function(require,module,exports){"use strict";var WeakMap=require("weak-map");module.exports=Object;Object.empty=Object.freeze(Object.create(null));Object.isObject=function(object){return Object(object)===object};Object.getValueOf=function(value){if(Object.can(value,"valueOf")){value=value.valueOf()}return value};var hashMap=new WeakMap;Object.hash=function(object){if(Object.can(object,"hash")){return""+object.hash()}else if(Object(object)===object){if(!hashMap.has(object)){hashMap.set(object,Math.random().toString(36).slice(2))}return hashMap.get(object)}else{return""+object}};var owns=Object.prototype.hasOwnProperty;Object.owns=function(object,key){return owns.call(object,key)};Object.can=function(object,name){return object!=null&&typeof object[name]==="function"&&!owns.call(object,name)};Object.has=function(object,key){if(typeof object!=="object"){throw new Error("Object.has can't accept non-object: "+typeof object)}if(Object.can(object,"has")){return object.has(key)}else if(typeof key==="string"){return key in object&&object[key]!==Object.prototype[key]}else{throw new Error("Key must be a string for Object.has on plain objects")}};Object.get=function(object,key,value){if(typeof object!=="object"){throw new Error("Object.get can't accept non-object: "+typeof object)}if(Object.can(object,"get")){return object.get(key,value)}else if(Object.has(object,key)){return object[key]}else{return value}};Object.set=function(object,key,value){if(Object.can(object,"set")){object.set(key,value)}else{object[key]=value}};Object.addEach=function(target,source){if(!source){}else if(Object.can(source,"forEach")){if(typeof source.keys==="function"){source.forEach(function(value,key){target[key]=value})}else{source.forEach(function(pair){target[pair[0]]=pair[1]})}}else{Object.keys(source).forEach(function(key){target[key]=source[key]})}return target};Object.forEach=function(object,callback,thisp){Object.keys(object).forEach(function(key){callback.call(thisp,object[key],key,object)})};Object.map=function(object,callback,thisp){return Object.keys(object).map(function(key){return callback.call(thisp,object[key],key,object)})};Object.values=function(object){return Object.map(object,Function.identity)};Object.concat=function(){var object={};for(var i=0;i<arguments.length;i++){Object.addEach(object,arguments[i])}return object};Object.from=Object.concat;Object.is=function(x,y){if(x===y){return x!==0||1/x===1/y}return x!==x&&y!==y};Object.equals=function(a,b,equals){equals=equals||Object.equals;a=Object.getValueOf(a);b=Object.getValueOf(b);if(a===b)return a!==0||1/a===1/b;if(a===null||b===null)return a===b;if(Object.can(a,"equals"))return a.equals(b,equals);if(Object.can(b,"equals"))return b.equals(a,equals);if(typeof a==="object"&&typeof b==="object"){var aPrototype=Object.getPrototypeOf(a);var bPrototype=Object.getPrototypeOf(b);if(aPrototype===bPrototype&&(aPrototype===Object.prototype||aPrototype===null)){for(var key in a){if(!equals(a[key],b[key])){return false}}for(var key in b){if(!equals(a[key],b[key])){return false}}return true}}return a!==a&&b!==b};Object.compare=function(a,b){a=Object.getValueOf(a);b=Object.getValueOf(b);var aType=typeof a;var bType=typeof b;if(a===b)return 0;if(aType!==bType)return 0;if(aType==="number")return a-b;if(aType==="string")return a<b?-1:1;if(Object.can(a,"compare"))return a.compare(b);if(Object.can(b,"compare"))return-b.compare(a);return 0};Object.clone=function(value,depth,memo){value=Object.getValueOf(value);memo=memo||new WeakMap;if(depth===undefined){depth=Infinity}else if(depth===0){return value}if(Object.isObject(value)){if(!memo.has(value)){if(Object.can(value,"clone")){memo.set(value,value.clone(depth,memo))}else{var prototype=Object.getPrototypeOf(value);if(prototype===null||prototype===Object.prototype){var clone=Object.create(prototype);memo.set(value,clone);for(var key in value){clone[key]=Object.clone(value[key],depth-1,memo)}}else{throw new Error("Can't clone "+value)}}}return memo.get(value)}return value};Object.clear=function(object){if(Object.can(object,"clear")){object.clear()}else{var keys=Object.keys(object),i=keys.length;while(i){i--;delete object[keys[i]]}}return object}},{"weak-map":204}],208:[function(require,module,exports){if(!RegExp.escape){var special=/[-[\]{}()*+?.\\^$|,#\s]/g;RegExp.escape=function(string){return string.replace(special,"\\$&")}}},{}],209:[function(require,module,exports){var Array=require("./shim-array");var Object=require("./shim-object");var Function=require("./shim-function");var RegExp=require("./shim-regexp")},{"./shim-array":205,"./shim-function":206,"./shim-object":207,"./shim-regexp":208}],210:[function(require,module,exports){"use strict";module.exports=TreeLog;function TreeLog(){}TreeLog.ascii={intersection:"+",through:"-",branchUp:"+",branchDown:"+",fromBelow:".",fromAbove:"'",fromBoth:"+",strafe:"|"};TreeLog.unicodeRound={intersection:"",through:"",branchUp:"",branchDown:"",fromBelow:"",fromAbove:"",fromBoth:"",strafe:""};TreeLog.unicodeSharp={intersection:"",through:"",branchUp:"",branchDown:"",fromBelow:"",fromAbove:"",fromBoth:"",strafe:""}},{}],211:[function(require,module,exports){var global=typeof self!=="undefined"?self:typeof window!=="undefined"?window:{};var rng;if(global.crypto&&crypto.getRandomValues){var _rnds8=new Uint8Array(16);rng=function whatwgRNG(){crypto.getRandomValues(_rnds8);return _rnds8}}if(!rng){var _rnds=new Array(16);rng=function(){for(var i=0,r;i<16;i++){if((i&3)===0)r=Math.random()*4294967296;_rnds[i]=r>>>((i&3)<<3)&255}return _rnds}}module.exports=rng},{}],212:[function(require,module,exports){var Buffer=require("__browserify_Buffer");var _rng=require("./rng");var BufferClass=typeof Buffer=="function"?Buffer:Array;var _byteToHex=[];var _hexToByte={};for(var i=0;i<256;i++){_byteToHex[i]=(i+256).toString(16).substr(1);_hexToByte[_byteToHex[i]]=i}function parse(s,buf,offset){var i=buf&&offset||0,ii=0;buf=buf||[];s.toLowerCase().replace(/[0-9a-f]{2}/g,function(oct){if(ii<16){buf[i+ii++]=_hexToByte[oct]}});while(ii<16){buf[i+ii++]=0}return buf}function unparse(buf,offset){var i=offset||0,bth=_byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]}var _seedBytes=_rng();var _nodeId=[_seedBytes[0]|1,_seedBytes[1],_seedBytes[2],_seedBytes[3],_seedBytes[4],_seedBytes[5]];var _clockseq=(_seedBytes[6]<<8|_seedBytes[7])&16383;var _lastMSecs=0,_lastNSecs=0;function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var clockseq=options.clockseq!==undefined?options.clockseq:_clockseq;var msecs=options.msecs!==undefined?options.msecs:(new Date).getTime();var nsecs=options.nsecs!==undefined?options.nsecs:_lastNSecs+1;var dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1e4;if(dt<0&&options.clockseq===undefined){clockseq=clockseq+1&16383}if((dt<0||msecs>_lastMSecs)&&options.nsecs===undefined){nsecs=0}if(nsecs>=1e4){throw new Error("uuid.v1(): Can't create more than 10M uuids/sec")}_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;msecs+=122192928e5;var tl=((msecs&268435455)*1e4+nsecs)%4294967296;b[i++]=tl>>>24&255;b[i++]=tl>>>16&255;b[i++]=tl>>>8&255;b[i++]=tl&255;var tmh=msecs/4294967296*1e4&268435455;b[i++]=tmh>>>8&255;b[i++]=tmh&255;b[i++]=tmh>>>24&15|16;b[i++]=tmh>>>16&255;b[i++]=clockseq>>>8|128;b[i++]=clockseq&255;var node=options.node||_nodeId;for(var n=0;n<6;n++){b[i+n]=node[n]}return buf?buf:unparse(b)}function v4(options,buf,offset){var i=buf&&offset||0;if(typeof options=="string"){buf=options=="binary"?new BufferClass(16):null;options=null}options=options||{};var rnds=options.random||(options.rng||_rng)();rnds[6]=rnds[6]&15|64;rnds[8]=rnds[8]&63|128;if(buf){for(var ii=0;ii<16;ii++){buf[i+ii]=rnds[ii]}}return buf||unparse(rnds)}var uuid=v4;uuid.v1=v1;uuid.v4=v4;uuid.parse=parse;uuid.unparse=unparse;uuid.BufferClass=BufferClass;module.exports=uuid},{"./rng":211,__browserify_Buffer:509}],213:[function(require,module,exports){module.exports={name:"rtc-signaller",version:"0.16.0",description:"rtc.io transportless signalling for WebRTC",main:"index.js",directories:{test:"test"},dependencies:{uuid:"~1.4.1",cog:"~0.4.1",collections:"~0.2.2","rtc-core":"~0.7.1"},devDependencies:{tape:"~2.3.0","rtc-switchboard":"~0.5.0","messenger-memory":"~0.3.0",mocha:"~1.17.0",zuul:"~1.3.0",fdom:"~0.6.3",async:"~0.2.9"},scripts:{test:"node test/all.js && zuul -- test/all.js",gendocs:"gendocs > README.md"},repository:{type:"git",url:"https://github.com/rtc-io/rtc-signaller.git"},keywords:["rtc.io","webrtc","signalling"],author:{name:"Damon Oehlman",email:"damon.oehlman@nicta.com.au"},license:"Apache 2.0",bugs:{url:"https://github.com/rtc-io/rtc-signaller/issues"},contributors:[{name:"Damon Oehlman",email:"damon.oehlman@nicta.com.au",url:"https://github.com/DamonOehlman"},{name:"Silvia Pfeiffer",email:"silvia.pfeiffer@nicta.com.au",url:"https://github.com/silviapfeiffer"}],readme:"# rtc-signaller\n\nThe `rtc-signaller` module provides a transportless signalling\nmechanism for WebRTC.\n\n\n[![NPM](https://nodei.co/npm/rtc-signaller.png)](https://nodei.co/npm/rtc-signaller/)\n\n[![Build Status](https://travis-ci.org/rtc-io/rtc-signaller.png?branch=master)](https://travis-ci.org/rtc-io/rtc-signaller)\n[![unstable](http://hughsk.github.io/stability-badges/dist/unstable.svg)](http://github.com/hughsk/stability-badges)\n\n## Purpose\n\nThe signaller provides set of client-side tools that assist with the\nsetting up an `PeerConnection` and helping them communicate. All that is\nrequired for the signaller to operate is a suitable messenger.\n\nA messenger is a simple object that implements node\n[EventEmitter](http://nodejs.org/api/events.html) style `on` events for\n`open`, `close`, `message` events, and also a `send` method by which\ndata will be send \"over-the-wire\".\n\nBy using this approach, we can conduct signalling over any number of\nmechanisms:\n\n- local, in memory message passing\n- via WebSockets and higher level abstractions (such as\n  [primus](https://github.com/primus/primus))\n- also over WebRTC data-channels (very meta, and admittedly a little\n  complicated).\n\n## Getting Started\n\nWhile the signaller is capable of communicating by a number of different\nmessengers (i.e. anything that can send and receive messages over a wire)\nit comes with support for understanding how to connect to an\n[rtc-switchboard](https://github.com/rtc-io/rtc-switchboard) out of the box.\n\nThe following code sample demonstrates how:\n\n```js\n// create a new signaller, connecting to the target switchboard\nvar signaller = require('rtc-signaller')('http://rtc.io/switchboard');\n\n// when a new peer is announced, log it\nsignaller.on('peer:announce', function(data) {\n console.log('new peer found in room: ', data);\n});\n\n// when a peer leaves the switchboard, log it\nsignaller.on('peer:leave', function(id) {\n  console.log('peer ' + id + ' has left the room');\n});\n\n// for our sanity, pop a message once we are connected\nsignaller.once('connected', function() {\n  console.log('we have successfully connected');\n});\n\n// send through an announce message\n// this will occur once the primus socket has been opened and active\nsignaller.announce({ room: 'signaller-getting-started' });\n```\n\n## Signal Flow Diagrams\n\nDisplayed below are some diagrams how the signalling flow between peers\nbehaves.  In each of the diagrams we illustrate three peers (A, B and C)\nparticipating discovery and coordinating RTCPeerConnection handshakes.\n\nIn each case, only the interaction between the clients is represented not\nhow a signalling server\n(such as [rtc-switchboard](https://github.com/rtc-io/rtc-switchboard)) would\npass on broadcast messages, etc.  This is done for two reasons:\n\n1. It is out of scope of this documentation.\n2. The `rtc-signaller` has been designed to work without having to rely on\n   any intelligence in the server side signalling component.  In the\n   instance that a signaller broadcasts all messages to all connected peers\n   then `rtc-signaller` should be smart enough to make sure everything works\n   as expected.\n\n### Peer Discovery / Announcement\n\nThis diagram illustrates the process of how peer `A` announces itself to\npeers `B` and `C`, and in turn they announce themselves.\n\n![](https://raw.github.com/rtc-io/rtc-signaller/master/docs/announce.png)\n\n### Editing / Updating the Diagrams\n\nEach of the diagrams has been generated using\n[mscgen](http://www.mcternan.me.uk/mscgen/index.html) and the source for\nthese documents can be found in the `docs/` folder of this repository.\n\n## Reference\n\nThe `rtc-signaller` module is designed to be used primarily in a functional\nway and when called it creates a new signaller that will enable\nyou to communicate with other peers via your messaging network.\n\n```js\n// create a signaller from something that knows how to send messages\nvar signaller = require('rtc-signaller')(messenger);\n```\n\nAs demonstrated in the getting started guide, you can also pass through\na string value instead of a messenger instance if you simply want to\nconnect to an existing `rtc-switchboard` instance.\n\n### signaller#send(message, data*)\n\nUse the send function to send a message to other peers in the current\nsignalling scope (if announced in a room this will be a room, otherwise\nbroadcast to all peers connected to the signalling server).\n\n### announce(data?)\n\nThe `announce` function of the signaller will pass an `/announce` message\nthrough the messenger network.  When no additional data is supplied to\nthis function then only the id of the signaller is sent to all active\nmembers of the messenging network.\n\n#### Joining Rooms\n\nTo join a room using an announce call you simply provide the name of the\nroom you wish to join as part of the data block that you annouce, for\nexample:\n\n```js\nsignaller.announce({ room: 'testroom' });\n```\n\nSignalling servers (such as\n[rtc-switchboard](https://github.com/rtc-io/rtc-switchboard)) will then\nplace your peer connection into a room with other peers that have also\nannounced in this room.\n\nOnce you have joined a room, the server will only deliver messages that\nyou `send` to other peers within that room.\n\n#### Providing Additional Announce Data\n\nThere may be instances where you wish to send additional data as part of\nyour announce message in your application.  For instance, maybe you want\nto send an alias or nick as part of your announce message rather than just\nuse the signaller's generated id.\n\nIf for instance you were writing a simple chat application you could join\nthe `webrtc` room and tell everyone your name with the following announce\ncall:\n\n```js\nsignaller.announce({\n  room: 'webrtc',\n  nick: 'Damon'\n});\n```\n\n#### Announcing Updates\n\nThe signaller is written to distinguish between initial peer announcements\nand peer data updates (see the docs on the announce handler below). As\nsuch it is ok to provide any data updates using the announce method also.\n\nFor instance, I could send a status update as an announce message to flag\nthat I am going offline:\n\n```js\nsignaller.announce({ status: 'offline' });\n```\n\n### isMaster(targetId)\n\nA simple function that indicates whether the local signaller is the master\nfor it's relationship with peer signaller indicated by `targetId`.  Roles\nare determined at the point at which signalling peers discover each other,\nand are simply worked out by whichever peer has the lowest signaller id\nwhen lexigraphically sorted.\n\nFor example, if we have two signaller peers that have discovered each\nothers with the following ids:\n\n- `b11f4fd0-feb5-447c-80c8-c51d8c3cced2`\n- `8a07f82e-49a5-4b9b-a02e-43d911382be6`\n\nThey would be assigned roles:\n\n- `b11f4fd0-feb5-447c-80c8-c51d8c3cced2`\n- `8a07f82e-49a5-4b9b-a02e-43d911382be6` (master)\n\n### leave()\n\nTell the signalling server we are leaving.  Calling this function is\nusually not required though as the signalling server should issue correct\n`/leave` messages when it detects a disconnect event.\n\n### to(targetId)\n\nUse the `to` function to send a message to the specified target peer.\nA large parge of negotiating a WebRTC peer connection involves direct\ncommunication between two parties which must be done by the signalling\nserver.  The `to` function provides a simple way to provide a logical\ncommunication channel between the two parties:\n\n```js\nvar send = signaller.to('e95fa05b-9062-45c6-bfa2-5055bf6625f4').send;\n\n// create an offer on a local peer connection\npc.createOffer(\n  function(desc) {\n    // set the local description using the offer sdp\n    // if this occurs successfully send this to our peer\n    pc.setLocalDescription(\n      desc,\n      function() {\n        send('/sdp', desc);\n      },\n      handleFail\n    );\n  },\n  handleFail\n);\n```\n\n### loadPrimus(signalhost, callback)\n\nThis is a convenience function that is patched into the signaller to assist\nwith loading the `primus.js` client library from an `rtc-switchboard`\nsignaling server.\n\n### signaller process handling\n\nWhen a signaller's underling messenger emits a `data` event this is\ndelegated to a simple message parser, which applies the following simple\nlogic:\n\n- Is the message a `/to` message. If so, see if the message is for this\n  signaller (checking the target id - 2nd arg).  If so pass the\n  remainder of the message onto the standard processing chain.  If not,\n  discard the message.\n\n- Is the message a command message (prefixed with a forward slash). If so,\n  look for an appropriate message handler and pass the message payload on\n  to it.\n\n- Finally, does the message match any patterns that we are listening for?\n  If so, then pass the entire message contents onto the registered handler.\n\n### signaller message handlers\n\n#### announce\n\n```\n/announce|{\"id\": \"...\", ... }\n```\n\nWhen an announce message is received by the signaller, the attached\nobject data is decoded and the signaller emits an `announce` message.\n\n##### Events Triggered in response to `/announce`\n\nThere are two different types of `peer:` events that can be triggered\nin on peer B to calling the `announce` method on peer A.\n\n- `peer:announce`\n\n  The `peer:announce` event is triggered when a new peer has been\n  discovered.  The data for the new peer (as an JS object) is provided\n  as the first argument of the event handler.\n\n- `peer:update`\n\n  If a peer \"reannounces\" then a `peer:update` event will be triggered\n  rather than a `peer:announce` event.\n\n#### leave\n\n```\n/leave|{\"id\":\"...\"}\n```\n\nWhen a leave message is received from a peer, we check to see if that is\na peer that we are managing state information for and if we are then the\npeer state is removed.\n\n##### Events triggered in response to `/leave` messages\n\nThe following event(s) are triggered when a `/leave` action is received\nfrom a peer signaller:\n\n- `peer:leave`\n\n  The `peer:leave` event is emitted once a `/leave` message is captured\n  from a peer.  Prior to the event being dispatched, the internal peers\n  data in the signaller is removed but can be accessed in 2nd argument\n  of the event handler.\n\n## License(s)\n\n### Apache 2.0\n\nCopyright 2014 National ICT Australia Limited (NICTA)\n\n   Licensed under the Apache License, Version 2.0 (the \"License\");\n   you may not use this file except in compliance with the License.\n   You may obtain a copy of the License at\n\n     http://www.apache.org/licenses/LICENSE-2.0\n\n   Unless required by applicable law or agreed to in writing, software\n   distributed under the License is distributed on an \"AS IS\" BASIS,\n   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   See the License for the specific language governing permissions and\n   limitations under the License.\n",readmeFilename:"README.md",_id:"rtc-signaller@0.16.0",dist:{shasum:"7e749b95248fc17d66d5e2b3a047e2a532e4dae6"},_from:"rtc-signaller@~0.16.0",_resolved:"https://registry.npmjs.org/rtc-signaller/-/rtc-signaller-0.16.0.tgz"}},{}],214:[function(require,module,exports){"use strict";var url=require("url");var reTrailingSlash=/\/$/;module.exports=function(signalhost,callback){var script;var baseUrl;var basePath;var scriptSrc;if(typeof signalhost=="function"){callback=signalhost;signalhost=location.origin}baseUrl=signalhost.replace(reTrailingSlash,"");basePath=url.parse(signalhost).pathname;scriptSrc=baseUrl+"/rtc.io/primus.js";script=document.querySelector('script[src="'+scriptSrc+'"]');if(script&&typeof Primus!="undefined"){return callback(null,Primus)}else if(script){script.addEventListener("load",function(){callback(null,Primus)});return}script=document.createElement("script");script.src=scriptSrc;script.onerror=callback;script.addEventListener("load",function(){if(basePath!=="/"){Primus.prototype.pathname=basePath.replace(reTrailingSlash,"")+Primus.prototype.pathname}callback(null,Primus)});document.body.appendChild(script)}},{url:527}],215:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc-signaller");var jsonparse=require("cog/jsonparse");module.exports=function(signaller){var handlers=require("./handlers")(signaller);function sendEvent(parts,srcState,data){var evtName=parts[0].slice(1);var args=parts.slice(2).map(jsonparse);signaller.emit.apply(signaller,[evtName].concat(args).concat([srcState,data]))}return function(originalData){var id=signaller.id;var data=originalData;var isMatch=true;var parts;var handler;var srcData;var srcState;var isDirectMessage=false;debug("signaller "+signaller.id+" received data: "+originalData);if(data.slice(0,3)==="/to"){isMatch=data.slice(4,id.length+4)===id;if(isMatch){parts=data.slice(5+id.length).split("|").map(jsonparse);isDirectMessage=true;parts=parts.map(jsonparse)}}if(!isMatch){return}parts=parts||data.split("|").map(jsonparse);if(typeof parts[0]=="string"&&parts[0].charAt(0)==="/"){handler=handlers[parts[0].slice(1)];srcData=parts[1];if(srcData&&srcData.id===signaller.id){return console.warn("got data from ourself, discarding")}srcState=signaller.peers.get(srcData&&srcData.id)||srcData;if(typeof handler=="function"){handler(parts.slice(2),parts[0].slice(1),srcData,srcState,isDirectMessage)}else{sendEvent(parts,srcState,originalData)}}}}},{"./handlers":190,"cog/jsonparse":186,"cog/logger":187}],216:[function(require,module,exports){"use strict";var async=require("async");var monitor=require("./monitor");var detect=require("./detect");function couple(conn,targetId,signaller,opts){var debug=require("cog/logger")("couple");var mon=monitor(conn);var blockId;var stages={};var queuedCandidates=[];var sdpFilter=(opts||{}).sdpfilter;var reactive=(opts||{}).reactive;var offerTimeout;if(typeof signaller.isMaster!="function"){throw new Error("rtc-signaller instance >= 0.14.0 required")}var isMaster=signaller.isMaster(targetId);var createOffer=prepNegotiate("createOffer",isMaster,[checkStable,checkNotConnecting]);var createAnswer=prepNegotiate("createAnswer",true,[checkNotConnecting]);var q=async.queue(function(task,cb){if(typeof task.op!="function"){return cb()}task.op(task,cb)},1);var RTCSessionDescription=(opts||{}).RTCSessionDescription||detect("RTCSessionDescription");var RTCIceCandidate=(opts||{}).RTCIceCandidate||detect("RTCIceCandidate");function abort(stage,sdp,cb){var stageHandler=stages[stage];return function(err){console.error("rtc/couple error ("+stage+"): ",err);if(typeof cb=="function"){cb(err)}}}function applyCandidatesWhenStable(){if(conn.signalingState=="stable"&&conn.remoteDescription){debug("signaling state = stable, applying queued candidates");mon.removeListener("change",applyCandidatesWhenStable);queuedCandidates.splice(0).forEach(function(data){debug("applying queued candidate",data);try{conn.addIceCandidate(new RTCIceCandidate(data))}catch(e){debug("invalidate candidate specified: ",data)}})}}function checkNotConnecting(negotiate){if(conn.iceConnectionState!="checking"){return true}debug("connection state is checking, will wait to create a new offer");mon.once("active",function(){q.push({op:negotiate})});return false}function checkStable(negotiate){if(conn.signalingState==="stable"){return true}debug("cannot create offer, signaling state != stable, will retry");mon.on("change",function waitForStable(){if(conn.signalingState==="stable"){q.push({op:negotiate})}mon.removeListener("change",waitForStable)});return false}function prepNegotiate(methodName,allowed,preflightChecks){var hsDebug=require("cog/logger")("handshake-"+methodName);preflightChecks=[].concat(preflightChecks||[]);return function negotiate(task,cb){var checksOK=true;if(!allowed){signaller.to(targetId).send("/negotiate");return cb()}preflightChecks.forEach(function(check){checksOK=checksOK&&check(negotiate)});if(!checksOK){return cb()}debug("calling "+methodName);conn[methodName](function(desc){if(typeof sdpFilter=="function"){desc.sdp=sdpFilter(desc.sdp,conn,methodName)}q.push({op:queueLocalDesc(desc)});cb()},abort(methodName,"",cb))}}function handleLocalCandidate(evt){if(evt.candidate){signaller.to(targetId).send("/candidate",evt.candidate)}else if(conn.iceGatheringState==="complete"){debug("ice gathering state complete")}}function handleRemoteCandidate(data,src){if(!src||src.id!==targetId){return}if(conn.signalingState!="stable"||!conn.remoteDescription){queuedCandidates.push(data);mon.removeListener("change",applyCandidatesWhenStable);mon.on("change",applyCandidatesWhenStable);return}try{conn.addIceCandidate(new RTCIceCandidate(data))}catch(e){debug("invalidate candidate specified: ",data)}}function handleSdp(data,src){if(!src||src.id!==targetId){return}q.push({op:function(task,cb){conn.setRemoteDescription(new RTCSessionDescription(data),function(){if(data.type==="offer"){queue(createAnswer)()}cb()},abort(data.type==="offer"?"createAnswer":"createOffer",data.sdp,cb))}})}function queue(negotiateTask){return function(){q.push([{op:negotiateTask}])}}function queueLocalDesc(desc){return function setLocalDesc(task,cb,retryCount){debug("setting local description");conn.setLocalDescription(desc,function(){signaller.to(targetId).send("/sdp",desc);cb()},function(err){debug("error setting local description",err);debug(desc.sdp);cb(err)})}}if(typeof targetId!="string"&&!(targetId instanceof String)){throw new Error("2nd argument (targetId) should be a string")}if(reactive){conn.addEventListener("negotiationneeded",function(){debug("renegotiation required, will create offer in 50ms");clearTimeout(offerTimeout);offerTimeout=setTimeout(queue(createOffer),50)})}conn.addEventListener("icecandidate",handleLocalCandidate);signaller.on("sdp",handleSdp);signaller.on("candidate",handleRemoteCandidate);if(isMaster){signaller.on("negotiate",function(src){if(src.id===targetId){debug("got negotiate request from "+targetId+", creating offer");q.push({op:createOffer})}})}mon.once("closed",function(){debug("closed");signaller.removeListener("sdp",handleSdp);signaller.removeListener("candidate",handleRemoteCandidate)});mon.createOffer=queue(createOffer);return mon}module.exports=couple},{"./detect":217,"./monitor":220,async:221,"cog/logger":187}],217:[function(require,module,exports){"use strict";module.exports=require("rtc-core/detect")},{"rtc-core/detect":188}],218:[function(require,module,exports){"use strict";var debug=require("cog/logger")("generators");var detect=require("./detect");var defaults=require("cog/defaults");var mappings={create:{data:function(c){},dtls:function(c){if(!detect.moz){c.optional=(c.optional||[]).concat({DtlsSrtpKeyAgreement:true})}}}};var knownFlags=["video","audio","data"];exports.config=function(config){return defaults(config,{iceServers:[]})};exports.connectionConstraints=function(flags,constraints){var generated={};var m=mappings.create;var out;Object.keys(flags||{}).forEach(function(key){if(m[key]){m[key](generated)}});out=defaults({},constraints,generated);debug("generated connection constraints: ",out);return out};var parseFlags=exports.parseFlags=function(options){var opts=options||{};opts.video=opts.video||typeof opts.video=="undefined";opts.audio=opts.audio||typeof opts.audio=="undefined";return Object.keys(opts||{}).filter(function(flag){return opts[flag]}).map(function(flag){return flag.toLowerCase()}).filter(function(flag){return knownFlags.indexOf(flag)>=0})}},{"./detect":217,"cog/defaults":184,"cog/logger":187}],219:[function(require,module,exports){"use strict";var gen=require("./generators");var detect=exports.detect=require("./detect");exports.logger=require("cog/logger");var RTCPeerConnection=exports.RTCPeerConnection=detect("RTCPeerConnection");
exports.couple=require("./couple");exports.createConnection=function(opts,constraints){return new RTCPeerConnection(gen.config(opts),gen.connectionConstraints(opts,constraints))}},{"./couple":216,"./detect":217,"./generators":218,"cog/logger":187}],220:[function(require,module,exports){var process=require("__browserify_process");"use strict";var debug=require("cog/logger")("monitor");var EventEmitter=require("events").EventEmitter;var W3C_STATES={NEW:"new",LOCAL_OFFER:"have-local-offer",LOCAL_PRANSWER:"have-local-pranswer",REMOTE_PRANSWER:"have-remote-pranswer",ACTIVE:"active",CLOSED:"closed"};var monitor=module.exports=function(pc,tag){var mon=new EventEmitter;var currentState=getState(pc);var isActive=mon.active=currentState===W3C_STATES.ACTIVE;function checkState(){var newState=getState(pc,tag);debug("captured state change, new state: "+newState+", current state: "+currentState);mon.active=newState===W3C_STATES.ACTIVE;if(newState!==currentState){mon.emit("change",newState,pc);mon.emit(currentState=newState)}}if(isActive){process.nextTick(mon.emit.bind(mon,W3C_STATES.ACTIVE,pc))}pc.addEventListener("signalingstatechange",checkState);pc.addEventListener("iceconnectionstatechange",checkState);mon.stop=function(){pc.removeEventListener("signalingstatechange",checkState);pc.removeEventListener("iceconnectionstatechange",checkState)};return mon};var getState=monitor.getState=function(pc,tag){var signalingState=pc&&pc.signalingState;var iceGatheringState=pc&&pc.iceGatheringState;var iceConnectionState=pc&&pc.iceConnectionState;var localDesc;var remoteDesc;var state;var isActive;if(!pc){return W3C_STATES.CLOSED}tag=tag||"";localDesc=pc.localDescription;remoteDesc=pc.remoteDescription;state=signalingState;if(state==="stable"){state=W3C_STATES.NEW;if(localDesc&&remoteDesc){state=W3C_STATES.REMOTE_PRANSWER}}isActive=state===W3C_STATES.REMOTE_PRANSWER&&iceConnectionState==="connected";debug(tag+"signaling state: "+signalingState+", iceGatheringState: "+iceGatheringState+", iceConnectionState: "+iceConnectionState);return isActive?W3C_STATES.ACTIVE:state};monitor.isActive=function(pc){var isStable=pc&&pc.signalingState==="stable";return isStable&&getState(pc)===W3C_STATES.ACTIVE}},{__browserify_process:510,"cog/logger":187,events:507}],221:[function(require,module,exports){var process=require("__browserify_process");(function(){var async={};var root,previous_async;root=this;if(root!=null){previous_async=root.async}async.noConflict=function(){root.async=previous_async;return async};function only_once(fn){var called=false;return function(){if(called)throw new Error("Callback was already called.");called=true;fn.apply(root,arguments)}}var _each=function(arr,iterator){if(arr.forEach){return arr.forEach(iterator)}for(var i=0;i<arr.length;i+=1){iterator(arr[i],i,arr)}};var _map=function(arr,iterator){if(arr.map){return arr.map(iterator)}var results=[];_each(arr,function(x,i,a){results.push(iterator(x,i,a))});return results};var _reduce=function(arr,iterator,memo){if(arr.reduce){return arr.reduce(iterator,memo)}_each(arr,function(x,i,a){memo=iterator(memo,x,i,a)});return memo};var _keys=function(obj){if(Object.keys){return Object.keys(obj)}var keys=[];for(var k in obj){if(obj.hasOwnProperty(k)){keys.push(k)}}return keys};if(typeof process==="undefined"||!process.nextTick){if(typeof setImmediate==="function"){async.nextTick=function(fn){setImmediate(fn)};async.setImmediate=async.nextTick}else{async.nextTick=function(fn){setTimeout(fn,0)};async.setImmediate=async.nextTick}}else{async.nextTick=process.nextTick;if(typeof setImmediate!=="undefined"){async.setImmediate=function(fn){setImmediate(fn)}}else{async.setImmediate=async.nextTick}}async.each=function(arr,iterator,callback){callback=callback||function(){};if(!arr.length){return callback()}var completed=0;_each(arr,function(x){iterator(x,only_once(function(err){if(err){callback(err);callback=function(){}}else{completed+=1;if(completed>=arr.length){callback(null)}}}))})};async.forEach=async.each;async.eachSeries=function(arr,iterator,callback){callback=callback||function(){};if(!arr.length){return callback()}var completed=0;var iterate=function(){iterator(arr[completed],function(err){if(err){callback(err);callback=function(){}}else{completed+=1;if(completed>=arr.length){callback(null)}else{iterate()}}})};iterate()};async.forEachSeries=async.eachSeries;async.eachLimit=function(arr,limit,iterator,callback){var fn=_eachLimit(limit);fn.apply(null,[arr,iterator,callback])};async.forEachLimit=async.eachLimit;var _eachLimit=function(limit){return function(arr,iterator,callback){callback=callback||function(){};if(!arr.length||limit<=0){return callback()}var completed=0;var started=0;var running=0;(function replenish(){if(completed>=arr.length){return callback()}while(running<limit&&started<arr.length){started+=1;running+=1;iterator(arr[started-1],function(err){if(err){callback(err);callback=function(){}}else{completed+=1;running-=1;if(completed>=arr.length){callback()}else{replenish()}}})}})()}};var doParallel=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.each].concat(args))}};var doParallelLimit=function(limit,fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[_eachLimit(limit)].concat(args))}};var doSeries=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.eachSeries].concat(args))}};var _asyncMap=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(err,v){results[x.index]=v;callback(err)})},function(err){callback(err,results)})};async.map=doParallel(_asyncMap);async.mapSeries=doSeries(_asyncMap);async.mapLimit=function(arr,limit,iterator,callback){return _mapLimit(limit)(arr,iterator,callback)};var _mapLimit=function(limit){return doParallelLimit(limit,_asyncMap)};async.reduce=function(arr,memo,iterator,callback){async.eachSeries(arr,function(x,callback){iterator(memo,x,function(err,v){memo=v;callback(err)})},function(err){callback(err,memo)})};async.inject=async.reduce;async.foldl=async.reduce;async.reduceRight=function(arr,memo,iterator,callback){var reversed=_map(arr,function(x){return x}).reverse();async.reduce(reversed,memo,iterator,callback)};async.foldr=async.reduceRight;var _filter=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(v){if(v){results.push(x)}callback()})},function(err){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.filter=doParallel(_filter);async.filterSeries=doSeries(_filter);async.select=async.filter;async.selectSeries=async.filterSeries;var _reject=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(v){if(!v){results.push(x)}callback()})},function(err){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.reject=doParallel(_reject);async.rejectSeries=doSeries(_reject);var _detect=function(eachfn,arr,iterator,main_callback){eachfn(arr,function(x,callback){iterator(x,function(result){if(result){main_callback(x);main_callback=function(){}}else{callback()}})},function(err){main_callback()})};async.detect=doParallel(_detect);async.detectSeries=doSeries(_detect);async.some=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){if(v){main_callback(true);main_callback=function(){}}callback()})},function(err){main_callback(false)})};async.any=async.some;async.every=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){if(!v){main_callback(false);main_callback=function(){}}callback()})},function(err){main_callback(true)})};async.all=async.every;async.sortBy=function(arr,iterator,callback){async.map(arr,function(x,callback){iterator(x,function(err,criteria){if(err){callback(err)}else{callback(null,{value:x,criteria:criteria})}})},function(err,results){if(err){return callback(err)}else{var fn=function(left,right){var a=left.criteria,b=right.criteria;return a<b?-1:a>b?1:0};callback(null,_map(results.sort(fn),function(x){return x.value}))}})};async.auto=function(tasks,callback){callback=callback||function(){};var keys=_keys(tasks);if(!keys.length){return callback(null)}var results={};var listeners=[];var addListener=function(fn){listeners.unshift(fn)};var removeListener=function(fn){for(var i=0;i<listeners.length;i+=1){if(listeners[i]===fn){listeners.splice(i,1);return}}};var taskComplete=function(){_each(listeners.slice(0),function(fn){fn()})};addListener(function(){if(_keys(results).length===keys.length){callback(null,results);callback=function(){}}});_each(keys,function(k){var task=tasks[k]instanceof Function?[tasks[k]]:tasks[k];var taskCallback=function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}if(err){var safeResults={};_each(_keys(results),function(rkey){safeResults[rkey]=results[rkey]});safeResults[k]=args;callback(err,safeResults);callback=function(){}}else{results[k]=args;async.setImmediate(taskComplete)}};var requires=task.slice(0,Math.abs(task.length-1))||[];var ready=function(){return _reduce(requires,function(a,x){return a&&results.hasOwnProperty(x)},true)&&!results.hasOwnProperty(k)};if(ready()){task[task.length-1](taskCallback,results)}else{var listener=function(){if(ready()){removeListener(listener);task[task.length-1](taskCallback,results)}};addListener(listener)}})};async.waterfall=function(tasks,callback){callback=callback||function(){};if(tasks.constructor!==Array){var err=new Error("First argument to waterfall must be an array of functions");return callback(err)}if(!tasks.length){return callback()}var wrapIterator=function(iterator){return function(err){if(err){callback.apply(null,arguments);callback=function(){}}else{var args=Array.prototype.slice.call(arguments,1);var next=iterator.next();if(next){args.push(wrapIterator(next))}else{args.push(callback)}async.setImmediate(function(){iterator.apply(null,args)})}}};wrapIterator(async.iterator(tasks))()};var _parallel=function(eachfn,tasks,callback){callback=callback||function(){};if(tasks.constructor===Array){eachfn.map(tasks,function(fn,callback){if(fn){fn(function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}callback.call(null,err,args)})}},callback)}else{var results={};eachfn.each(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}results[k]=args;callback(err)})},function(err){callback(err,results)})}};async.parallel=function(tasks,callback){_parallel({map:async.map,each:async.each},tasks,callback)};async.parallelLimit=function(tasks,limit,callback){_parallel({map:_mapLimit(limit),each:_eachLimit(limit)},tasks,callback)};async.series=function(tasks,callback){callback=callback||function(){};if(tasks.constructor===Array){async.mapSeries(tasks,function(fn,callback){if(fn){fn(function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}callback.call(null,err,args)})}},callback)}else{var results={};async.eachSeries(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1){args=args[0]}results[k]=args;callback(err)})},function(err){callback(err,results)})}};async.iterator=function(tasks){var makeCallback=function(index){var fn=function(){if(tasks.length){tasks[index].apply(null,arguments)}return fn.next()};fn.next=function(){return index<tasks.length-1?makeCallback(index+1):null};return fn};return makeCallback(0)};async.apply=function(fn){var args=Array.prototype.slice.call(arguments,1);return function(){return fn.apply(null,args.concat(Array.prototype.slice.call(arguments)))}};var _concat=function(eachfn,arr,fn,callback){var r=[];eachfn(arr,function(x,cb){fn(x,function(err,y){r=r.concat(y||[]);cb(err)})},function(err){callback(err,r)})};async.concat=doParallel(_concat);async.concatSeries=doSeries(_concat);async.whilst=function(test,iterator,callback){if(test()){iterator(function(err){if(err){return callback(err)}async.whilst(test,iterator,callback)})}else{callback()}};async.doWhilst=function(iterator,test,callback){iterator(function(err){if(err){return callback(err)}if(test()){async.doWhilst(iterator,test,callback)}else{callback()}})};async.until=function(test,iterator,callback){if(!test()){iterator(function(err){if(err){return callback(err)}async.until(test,iterator,callback)})}else{callback()}};async.doUntil=function(iterator,test,callback){iterator(function(err){if(err){return callback(err)}if(!test()){async.doUntil(iterator,test,callback)}else{callback()}})};async.queue=function(worker,concurrency){if(concurrency===undefined){concurrency=1}function _insert(q,data,pos,callback){if(data.constructor!==Array){data=[data]}_each(data,function(task){var item={data:task,callback:typeof callback==="function"?callback:null};if(pos){q.tasks.unshift(item)}else{q.tasks.push(item)}if(q.saturated&&q.tasks.length===concurrency){q.saturated()}async.setImmediate(q.process)})}var workers=0;var q={tasks:[],concurrency:concurrency,saturated:null,empty:null,drain:null,push:function(data,callback){_insert(q,data,false,callback)},unshift:function(data,callback){_insert(q,data,true,callback)},process:function(){if(workers<q.concurrency&&q.tasks.length){var task=q.tasks.shift();if(q.empty&&q.tasks.length===0){q.empty()}workers+=1;var next=function(){workers-=1;if(task.callback){task.callback.apply(task,arguments)}if(q.drain&&q.tasks.length+workers===0){q.drain()}q.process()};var cb=only_once(next);worker(task.data,cb)}},length:function(){return q.tasks.length},running:function(){return workers}};return q};async.cargo=function(worker,payload){var working=false,tasks=[];var cargo={tasks:tasks,payload:payload,saturated:null,empty:null,drain:null,push:function(data,callback){if(data.constructor!==Array){data=[data]}_each(data,function(task){tasks.push({data:task,callback:typeof callback==="function"?callback:null});if(cargo.saturated&&tasks.length===payload){cargo.saturated()}});async.setImmediate(cargo.process)},process:function process(){if(working)return;if(tasks.length===0){if(cargo.drain)cargo.drain();return}var ts=typeof payload==="number"?tasks.splice(0,payload):tasks.splice(0);var ds=_map(ts,function(task){return task.data});if(cargo.empty)cargo.empty();working=true;worker(ds,function(){working=false;var args=arguments;_each(ts,function(data){if(data.callback){data.callback.apply(null,args)}});process()})},length:function(){return tasks.length},running:function(){return working}};return cargo};var _console_fn=function(name){return function(fn){var args=Array.prototype.slice.call(arguments,1);fn.apply(null,args.concat([function(err){var args=Array.prototype.slice.call(arguments,1);if(typeof console!=="undefined"){if(err){if(console.error){console.error(err)}}else if(console[name]){_each(args,function(x){console[name](x)})}}}]))}};async.log=_console_fn("log");async.dir=_console_fn("dir");async.memoize=function(fn,hasher){var memo={};var queues={};hasher=hasher||function(x){return x};var memoized=function(){var args=Array.prototype.slice.call(arguments);var callback=args.pop();var key=hasher.apply(null,args);if(key in memo){callback.apply(null,memo[key])}else if(key in queues){queues[key].push(callback)}else{queues[key]=[callback];fn.apply(null,args.concat([function(){memo[key]=arguments;var q=queues[key];delete queues[key];for(var i=0,l=q.length;i<l;i++){q[i].apply(null,arguments)}}]))}};memoized.memo=memo;memoized.unmemoized=fn;return memoized};async.unmemoize=function(fn){return function(){return(fn.unmemoized||fn).apply(null,arguments)}};async.times=function(count,iterator,callback){var counter=[];for(var i=0;i<count;i++){counter.push(i)}return async.map(counter,iterator,callback)};async.timesSeries=function(count,iterator,callback){var counter=[];for(var i=0;i<count;i++){counter.push(i)}return async.mapSeries(counter,iterator,callback)};async.compose=function(){var fns=Array.prototype.reverse.call(arguments);return function(){var that=this;var args=Array.prototype.slice.call(arguments);var callback=args.pop();async.reduce(fns,args,function(newargs,fn,cb){fn.apply(that,newargs.concat([function(){var err=arguments[0];var nextargs=Array.prototype.slice.call(arguments,1);cb(err,nextargs)}]))},function(err,results){callback.apply(that,[err].concat(results))})}};var _applyEach=function(eachfn,fns){var go=function(){var that=this;var args=Array.prototype.slice.call(arguments);var callback=args.pop();return eachfn(fns,function(fn,cb){fn.apply(that,args.concat([cb]))},callback)};if(arguments.length>2){var args=Array.prototype.slice.call(arguments,2);return go.apply(this,args)}else{return go}};async.applyEach=doParallel(_applyEach);async.applyEachSeries=doSeries(_applyEach);async.forever=function(fn,callback){function next(err){if(err){if(callback){return callback(err)}throw err}fn(next)}next()};if(typeof define!=="undefined"&&define.amd){define([],function(){return async})}else if(typeof module!=="undefined"&&module.exports){module.exports=async}else{root.async=async}})()},{__browserify_process:510}],222:[function(require,module,exports){"use strict";var EventEmitter=require("events").EventEmitter;var inherits=require("inherits");var path=require("path");var xhr=require("xhr");var url4data=require("url4data");var name="rtc-signaller-sw.js";module.exports=function(opts){return new Messenger(opts)};var scriptText=['"use strict";',"var ports = [];","","self.onconnect = function(connectEvent) {",'  connectEvent.ports[0].postMessage("init");',"  var newPort = connectEvent.ports[0]; /* note: always exactly one port */","","  newPort.onmessage = function(messageEvent) {",'    newPort.postMessage("echo "+messageEvent.data);',"    if (messageEvent.data === null) {","      ports.splice(ports.indexOf(newPort), 1);","      return;","    }","","","    for (var i = 0; i < ports.length; ++i) {","      var port = ports[i];","","      if (port !== newPort) /* send to everyone but ourselves */","        port.postMessage(messageEvent.data);","    }","  };","","  ports.push(newPort);","","};"].join("\n");function Messenger(opts){this.buffered=[];this.opts=opts;this.started=false}inherits(Messenger,EventEmitter);Messenger.prototype.start=function(){var self=this;self.started=true;var opts=self.opts;url4data(scriptText,name,{type:"application/javascript",scheme:["filesystem","blob"]},function(url){console.log(url);self.worker=new SharedWorker(url);console.log("[SW] created shared worker",self.worker);window.workers=window.workers||[];window.workers.push(self.worker);self.worker.port.onerror=self.worker.onerror=function(ev){console.log("[SW] worker error: "+ev)};self.worker.port.onmessage=function(ev){console.log("[SW] received data ",ev.data);self.emit("data",ev.data)};self.worker.port.start();self.emit("open");for(var i=0;i<self.buffered.length;++i){console.log("[SW] sending buffered ",self.buffered[i]);self.worker.port.postMessage(self.buffered[i])}self.buffered=[]})};Messenger.prototype.write=function(data){if(!this.started)this.start();console.log("[SW] sending data",data);if(!this.worker){console.log("[SW] (buffering)");this.buffered.push(data)}else{this.worker.port.postMessage(data)}};Messenger.prototype.close=function(){console.log("[SW] closing");this.worker.port.postMessage(null)}},{events:507,inherits:223,path:514,url4data:224,xhr:228}],223:[function(require,module,exports){if(typeof Object.create==="function"){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}},{}],224:[function(require,module,exports){var xhr=require("xhr");var isValidBlobURL=function(url,cb){if(!url)return cb(url,false);try{xhr({uri:url,sync:true},function(err,resp,body){console.log("XHR",url,err,resp,body);var valid=!!body&&body.length!==0;cb(url,valid)})}catch(e){cb(url,false)}};var createNewBlobURL=function(data,name,opts){var blob=new Blob([data],opts);var url=URL.createObjectURL(blob);window.localStorage[name]=url=URL.createObjectURL(blob);console.log("Created new Blob URL",url);return url};var blobURL4data=function(data,name,opts,cb){if(!window.Blob)return false;var url=window.localStorage[name];isValidBlobURL(url,function(url,isValid){if(!isValid){url=createNewBlobURL(data,name,opts)}else{console.log("Using existing valid Blob URL",url)}cb(url,data,name,opts)});return true};var createNewFilesystemURL=function(data,name,opts,cb){if(!window.webkitRequestFileSystem)return false;var size=data.length;window.webkitRequestFileSystem(window.TEMPORARY,size,function(fs){fs.root.getFile(name,{create:true},function(file){console.log("created file",file);file.createWriter(function(writer){writer.onwriteend=function(){console.log("File write completed")};writer.onerror=function(err){console.log("createWriter error:",err)};var blob=new Blob([data],opts);writer.write(blob);var url=file.toURL();cb(url,data,name,opts)})},function(err){console.log("getFile error:",err)})},function(err){console.log("webkitRequestFileSystem error:",err)});return true};var filesystemURL4data=function(data,name,opts,cb){return createNewFilesystemURL(data,name,opts,cb)};var dataURL4data=function(data,name,opts,cb){var type=opts.type||"text/javascript";var encodedData=encodeURIComponent(data);var url="data:"+type+","+encodedData;cb(url,data,name,opts)};var byScheme={blob:blobURL4data,filesystem:filesystemURL4data,data:dataURL4data};var url4data=function(data,name,opts,cb){if(name===undefined)throw new Error("url4data name is required");opts=opts||{};var scheme=opts.scheme||["filesystem","blob"];if(!Array.isArray(scheme))scheme=[scheme];for(var i=0;i<scheme.length;++i){var tryScheme=scheme[i];var f=byScheme[tryScheme];if(!f)throw new Error("url4data invalid scheme: "+tryScheme);var success=f(data,name,opts,cb);if(success)return}};module.exports=url4data},{xhr:225}],225:[function(require,module,exports){var window=require("global/window");var once=require("once");var messages={0:"Internal XMLHttpRequest Error",4:"4xx Client Error",5:"5xx Server Error"};var XHR=window.XMLHttpRequest||noop;var XDR="withCredentials"in new XHR?window.XMLHttpRequest:window.XDomainRequest;module.exports=createXHR;function createXHR(options,callback){if(typeof options==="string"){options={uri:options}}options=options||{};callback=once(callback);var xhr;if(options.cors){xhr=new XDR}else{xhr=new XHR}var uri=xhr.url=options.uri;var method=xhr.method=options.method||"GET";var body=options.body||options.data;var headers=xhr.headers=options.headers||{};var sync=!!options.sync;var isJson=false;if("json"in options){isJson=true;headers["Content-Type"]="application/json";body=JSON.stringify(options.json)}xhr.onreadystatechange=readystatechange;xhr.onload=load;xhr.onerror=error;xhr.onprogress=function(){};xhr.ontimeout=noop;xhr.open(method,uri,!sync);if(options.cors){xhr.withCredentials=true}if(!sync){xhr.timeout="timeout"in options?options.timeout:5e3}if(xhr.setRequestHeader){Object.keys(headers).forEach(function(key){xhr.setRequestHeader(key,headers[key])})}xhr.send(body);return xhr;function readystatechange(){if(xhr.readyState===4){load()}}function load(){var error=null;var status=xhr.statusCode=xhr.status;var body=xhr.body=xhr.response||xhr.responseText||xhr.responseXML;if(status===0||status>=400&&status<600){var message=xhr.responseText||messages[String(xhr.status).charAt(0)];error=new Error(message);error.statusCode=xhr.status}if(isJson){try{body=xhr.body=JSON.parse(body)}catch(e){}}callback(error,xhr,body)}function error(evt){callback(evt,xhr)}}function noop(){}},{"global/window":226,once:227}],226:[function(require,module,exports){var global=typeof self!=="undefined"?self:typeof window!=="undefined"?window:{};if(typeof window!=="undefined"){module.exports=window}else if(typeof global!=="undefined"){module.exports=global}else{module.exports={}}},{}],227:[function(require,module,exports){module.exports=once;once.proto=once(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return once(this)},configurable:true})});function once(fn){var called=false;return function(){if(called)return;called=true;return fn.apply(this,arguments)}}},{}],228:[function(require,module,exports){module.exports=require(225)},{"global/window":229,once:230}],229:[function(require,module,exports){module.exports=require(226)},{}],230:[function(require,module,exports){module.exports=require(227)},{}],231:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var DuplexEmitter=require("duplex-emitter");var extend=require("extend");var skin=require("minecraft-skin");var crunch=require("voxel-crunch");var randomName=require("./randomname.js");module.exports=Client;function Client(opts){if(!(this instanceof Client)){return new Client(opts)}this.initialize(opts)}Client.prototype.initialize=function(opts){var self=this;self.opts=opts;self.playerID;self.game;self.texturePath=opts.texturePath||"/textures/";self.playerTexture=opts.playerTexture||"player.png";self.lerpPercent=.1;self.remoteClients={};self.serverStream=opts.serverStream;self.engine=opts.engine;self.overrideEngineOpts=opts.overrideEngineOpts;if(!self.engine)throw new Error("voxel-client requires engine option set to voxel-engine module");extend(self,new EventEmitter);self.connection=DuplexEmitter(opts.serverStream);self.bindEvents(self.connection)};Client.prototype.bindEvents=function(connection){var self=this;connection.on("id",function(id){self.playerID=id});connection.on("settings",function(settings){settings=self.overrideEngineOpts||settings;settings.isClient=true;settings.texturePath=self.texturePath;settings.generateChunks=false;settings.controlsDisabled=false;self.game=self.createGame(settings);connection.emit("created")});connection.on("chunk",function(encoded,chunk){if(encoded.length===undefined){var lastIndex=Math.max.apply(null,Object.keys(encoded).map(Number));encoded.length=lastIndex+1}var voxels=crunch.decode(encoded,chunk.length);chunk.voxels=voxels;self.game.showChunk(chunk)});connection.on("noMoreChunks",function(){var game=self.game;if(game.notCapable()){try{throw new Error("game not capable")}catch(err){self.emit("error",err)}}self.emit("loadComplete")});connection.on("set",function(pos,val){self.serverSettingBlock=true;self.game.setBlock(pos,val);self.serverSettingBlock=false})};var isInteracting=function(state){for(var control in state){if(state[control]!==0)return true}return false};Client.prototype.disconnect=function(){self.game.controls.removeListener("data",self.onData);self.game=null;window.alert("Disconected from server")};Client.prototype.createGame=function(settings){var self=this;var connection=self.connection;var engine=self.engine;self.game=engine(settings);self.game.settings=settings;var name=localStorage.getItem("name");if(!name){name=randomName();localStorage.setItem("name",name)}self.name=name;self.game.controls.on("data",self.onData=function(state){if(isInteracting(state)){try{sendState()}catch(e){console.log("exception sending state",e);self.disconnect()}}});self.game.on("setBlock",function(pos,val){if(self.serverSettingBlock)return;connection.emit("set",pos,val)});setTimeout(function(){connection.on("update",serverUpdate)},1e3);connection.on("leave",removeClient);return self.game;function sendState(){var player=self.game.controls.target();var state={position:player.yaw.position,rotation:{y:player.yaw.rotation.y,x:player.pitch.rotation.x}};connection.emit("state",state)}function removeClient(id){if(!self.remoteClients[id])return;self.game.scene.remove(self.remoteClients[id].mesh);delete self.remoteClients[id]}function serverUpdate(updates){Object.keys(updates.positions).map(function(player){var update=updates.positions[player];if(player===self.playerID){self.onServerUpdate(update)}else{self.updatePlayerPosition(player,update)}})}};Client.prototype.onServerUpdate=function(update){var self=this};Client.prototype.lerpMe=function(position){var self=this;var to=new this.game.THREE.Vector3;to.copy(position);var from=this.game.controls.target().yaw.position;from.copy(from.lerp(to,this.lerpPercent))};Client.prototype.updatePlayerPosition=function(id,update){var self=this;var pos=update.position;var player=self.remoteClients[id];if(!player){var playerSkin=skin(self.game.THREE,self.playerTexture,{scale:new self.game.THREE.Vector3(.04,.04,.04)});var playerMesh=playerSkin.mesh;self.remoteClients[id]=playerSkin;playerMesh.children[0].position.y=10;self.game.scene.add(playerMesh)}var playerSkin=self.remoteClients[id];var playerMesh=playerSkin.mesh;playerMesh.position.copy(playerMesh.position.lerp(pos,self.lerpPercent));playerMesh.children[0].rotation.y=update.rotation.y+Math.PI/2;playerSkin.head.rotation.z=scale(update.rotation.x,-1.5,1.5,-.75,.75)};function scale(x,fromLow,fromHigh,toLow,toHigh){return(x-fromLow)*(toHigh-toLow)/(fromHigh-fromLow)+toLow}},{"./randomname.js":244,"duplex-emitter":232,events:507,extend:240,"minecraft-skin":241,"voxel-crunch":242}],232:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var inherits=require("util").inherits;var WriteEmitter=require("./write_emitter");var ReadEmitter=require("./read_emitter");module.exports=function createDuplexEmitter(stream){return new DuplexEmitter(stream)};function DuplexEmitter(stream){EventEmitter.call(this);this.read=this.readEmitter=ReadEmitter(stream);this.write=this.writeEmitter=WriteEmitter(stream);this.write.on("error",onError.bind(this))}inherits(DuplexEmitter,EventEmitter);DuplexEmitter.prototype.addListener=DuplexEmitter.prototype.on=function addListener(event,listener){return this.read.on(event,listener)};DuplexEmitter.prototype.once=function once(event,listener){return this.read.once(event,listener)};DuplexEmitter.prototype.removeListener=function removeListener(event,listener){return this.read.removeListener(event,listener)};DuplexEmitter.prototype.removeAllListeners=function removeAllListeners(){return this.read.removeAllListeners.apply(this.read,arguments)};DuplexEmitter.prototype.emit=function emit(){return this.write.emit.apply(this.write,arguments)};function onError(err){this.emit("error",err)}},{"./read_emitter":238,"./write_emitter":239,events:507,util:529}],233:[function(require,module,exports){var through=require("through");var Decoder=require("string_decoder").StringDecoder;module.exports=split;function split(matcher,mapper){var decoder=new Decoder;var soFar="";if("function"===typeof matcher)mapper=matcher,matcher=null;if(!matcher)matcher=/\r?\n/;function emit(stream,piece){if(mapper){try{piece=mapper(piece)}catch(err){return stream.emit("error",err)}if("undefined"!==typeof piece)stream.queue(piece)}else stream.queue(piece)}function next(stream,buffer){var pieces=(soFar+buffer).split(matcher);soFar=pieces.pop();for(var i=0;i<pieces.length;i++){var piece=pieces[i];emit(stream,piece)}}return through(function(b){next(this,decoder.write(b))},function(){if(decoder.end)next(this,decoder.end());if(soFar!=null)emit(this,soFar);this.queue(null)})}},{string_decoder:526,through:236}],234:[function(require,module,exports){var duplexer=require("duplexer");module.exports=function(){var streams=[].slice.call(arguments),first=streams[0],last=streams[streams.length-1],thepipe=duplexer(first,last);if(streams.length==1)return streams[0];else if(!streams.length)throw new Error("connect called with empty args");function recurse(streams){if(streams.length<2)return;
streams[0].pipe(streams[1]);recurse(streams.slice(1))}recurse(streams);function onerror(){var args=[].slice.call(arguments);args.unshift("error");thepipe.emit.apply(thepipe,args)}for(var i=1;i<streams.length-1;i++)streams[i].on("error",onerror);return thepipe}},{duplexer:235}],235:[function(require,module,exports){var Stream=require("stream"),writeMethods=["write","end","destroy"],readMethods=["resume","pause"],readEvents=["data","close"],slice=Array.prototype.slice;module.exports=duplex;function duplex(writer,reader){var stream=new Stream,ended=false;writeMethods.forEach(proxyWriter);readMethods.forEach(proxyReader);readEvents.forEach(proxyStream);reader.on("end",handleEnd);writer.on("drain",function(){stream.emit("drain")});writer.on("error",reemit);reader.on("error",reemit);stream.writable=writer.writable;stream.readable=reader.readable;return stream;function proxyWriter(methodName){stream[methodName]=method;function method(){return writer[methodName].apply(writer,arguments)}}function proxyReader(methodName){stream[methodName]=method;function method(){stream.emit(methodName);var func=reader[methodName];if(func){return func.apply(reader,arguments)}reader.emit(methodName)}}function proxyStream(methodName){reader.on(methodName,reemit);function reemit(){var args=slice.call(arguments);args.unshift(methodName);stream.emit.apply(stream,args)}}function handleEnd(){if(ended){return}ended=true;var args=slice.call(arguments);args.unshift("end");stream.emit.apply(stream,args)}function reemit(err){stream.emit("error",err)}}},{stream:520}],236:[function(require,module,exports){module.exports=require(82)},{__browserify_process:510,stream:520}],237:[function(require,module,exports){var combine=require("stream-combiner");var split=require("split");var through=require("through");module.exports=function createParser(){var JSONParse=through(parseJSON);var s=combine(split("\n"),JSONParse);return s;function parseJSON(d){if(d){try{d=JSON.parse(d)}catch(err){s.emit("error",err);return}this.queue(d)}}}},{split:233,"stream-combiner":234,through:236}],238:[function(require,module,exports){var assert=require("assert");var EventEmitter=require("events").EventEmitter;var inherits=require("util").inherits;var Parser=require("./parser");module.exports=function createReadEmitter(stream){return new ReadEmitter(stream)};function ReadEmitter(stream){EventEmitter.call(this);this._stream=stream;var parser=Parser();parser.on("error",onParserError.bind(this));stream.pipe(parser);parser.on("data",onData.bind(this))}inherits(ReadEmitter,EventEmitter);function onData(d){if(!Array.isArray(d))this.emit("error",new Error("data should be array:"+JSON.stringify(d)));else this.emit.apply(this,d)}function onParserError(err){err.message="Error parsing peer data: "+err.message;this.emit("error",err)}},{"./parser":237,assert:506,events:507,util:529}],239:[function(require,module,exports){var assert=require("assert");var EventEmitter=require("events").EventEmitter;var inherits=require("util").inherits;var slice=Array.prototype.slice;module.exports=function createWriteEmitter(stream){return new WriteEmitter(stream)};function WriteEmitter(stream){EventEmitter.call(this);this._stream=stream}inherits(WriteEmitter,EventEmitter);var localEmit=WriteEmitter.prototype.emit;WriteEmitter.prototype.emit=function emit(){if(!this._stream.writable)return;var message=JSON.stringify(slice.apply(arguments))+"\n";this._stream.write(message);localEmit.apply(this,arguments)}},{assert:506,events:507,util:529}],240:[function(require,module,exports){var hasOwn=Object.prototype.hasOwnProperty;function isPlainObject(obj){if(!obj||toString.call(obj)!=="[object Object]"||obj.nodeType||obj.setInterval)return false;var has_own_constructor=hasOwnProperty.call(obj,"constructor");var has_is_property_of_method=hasOwnProperty.call(obj.constructor.prototype,"isPrototypeOf");if(obj.constructor&&!has_own_constructor&&!has_is_property_of_method)return false;var key;for(key in obj){}return key===undefined||hasOwn.call(obj,key)}module.exports=function extend(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=arguments[1]||{};i=2}if(typeof target!=="object"&&typeof target!=="function"){target={}}for(;i<length;i++){if((options=arguments[i])!=null){for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&(isPlainObject(copy)||(copyIsArray=Array.isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&Array.isArray(src)?src:[]}else{clone=src&&isPlainObject(src)?src:{}}target[name]=extend(deep,clone,copy)}else if(copy!==undefined){target[name]=copy}}}}return target}},{}],241:[function(require,module,exports){var THREE;module.exports=function(three,image,sizeRatio){return new Skin(three,image,sizeRatio)};function Skin(three,image,opts){if(opts)opts.image=opts.image||image;else opts={image:image};if(typeof image==="object"&&!(image instanceof HTMLElement))opts=image;THREE=three;this.sizeRatio=opts.sizeRatio||8;this.scale=opts.scale||new three.Vector3(1,1,1);this.fallbackImage=opts.fallbackImage||"skin.png";this.createCanvases();this.charMaterial=this.getMaterial(this.skin,false);this.charMaterialTrans=this.getMaterial(this.skin,true);if(typeof opts.image==="string")this.fetchImage(opts.image);if(opts.image instanceof HTMLElement)this.setImage(opts.image);this.mesh=this.createPlayerObject()}Skin.prototype.createCanvases=function(){this.skinBig=document.createElement("canvas");this.skinBigContext=this.skinBig.getContext("2d");this.skinBig.width=64*this.sizeRatio;this.skinBig.height=32*this.sizeRatio;this.skin=document.createElement("canvas");this.skinContext=this.skin.getContext("2d");this.skin.width=64;this.skin.height=32};Skin.prototype.fetchImage=function(imageURL){var self=this;this.image=new Image;this.image.crossOrigin="anonymous";this.image.src=imageURL;this.image.onload=function(){self.setImage(self.image)}};Skin.prototype.setImage=function(skin){this.image=skin;this.skinContext.clearRect(0,0,64,32);this.skinContext.drawImage(skin,0,0);var imgdata=this.skinContext.getImageData(0,0,64,32);var pixels=imgdata.data;this.skinBigContext.clearRect(0,0,this.skinBig.width,this.skinBig.height);this.skinBigContext.save();var isOnecolor=true;var colorCheckAgainst=[40,0];var colorIndex=(colorCheckAgainst[0]+colorCheckAgainst[1]*64)*4;var isPixelDifferent=function(x,y){if(pixels[(x+y*64)*4+0]!==pixels[colorIndex+0]||pixels[(x+y*64)*4+1]!==pixels[colorIndex+1]||pixels[(x+y*64)*4+2]!==pixels[colorIndex+2]||pixels[(x+y*64)*4+3]!==pixels[colorIndex+3]){return true}return false};for(var i=32;i<64;i+=1){for(var j=8;j<16;j+=1){if(isPixelDifferent(i,j)){isOnecolor=false;break}}if(!isOnecolor){break}}if(!isOnecolor){for(var i=40;i<56;i+=1){for(var j=0;j<8;j+=1){if(isPixelDifferent(i,j)){isOnecolor=false;break}}if(!isOnecolor){break}}}for(var i=0;i<64;i+=1){for(var j=0;j<32;j+=1){if(isOnecolor&&(i>=32&&i<64&&j>=8&&j<16||i>=40&&i<56&&j>=0&&j<8)){pixels[(i+j*64)*4+3]=0}this.skinBigContext.fillStyle="rgba("+pixels[(i+j*64)*4+0]+", "+pixels[(i+j*64)*4+1]+", "+pixels[(i+j*64)*4+2]+", "+pixels[(i+j*64)*4+3]/255+")";this.skinBigContext.fillRect(i*this.sizeRatio,j*this.sizeRatio,this.sizeRatio,this.sizeRatio)}}this.skinBigContext.restore();this.skinContext.putImageData(imgdata,0,0);this.charMaterial.map.needsUpdate=true;this.charMaterialTrans.map.needsUpdate=true};Skin.prototype.getMaterial=function(img,transparent){var texture=new THREE.Texture(img);texture.magFilter=THREE.NearestFilter;texture.minFilter=THREE.NearestFilter;texture.format=transparent?THREE.RGBAFormat:THREE.RGBFormat;texture.needsUpdate=true;var material=new THREE.MeshBasicMaterial({map:texture,transparent:transparent?true:false});return material};Skin.prototype.UVMap=function(mesh,face,x,y,w,h,rotateBy){if(!rotateBy)rotateBy=0;var uvs=mesh.geometry.faceVertexUvs[0][face];var tileU=x;var tileV=y;var tileUvWidth=1/64;var tileUvHeight=1/32;uvs[(0+rotateBy)%4].x=tileU*tileUvWidth;uvs[(0+rotateBy)%4].y=1-tileV*tileUvHeight;uvs[(1+rotateBy)%4].x=tileU*tileUvWidth;uvs[(1+rotateBy)%4].y=1-(tileV*tileUvHeight+h*tileUvHeight);uvs[(2+rotateBy)%4].x=tileU*tileUvWidth+w*tileUvWidth;uvs[(2+rotateBy)%4].y=1-(tileV*tileUvHeight+h*tileUvHeight);uvs[(3+rotateBy)%4].x=tileU*tileUvWidth+w*tileUvWidth;uvs[(3+rotateBy)%4].y=1-tileV*tileUvHeight};Skin.prototype.cubeFromPlanes=function(size,mat){var cube=new THREE.Object3D;var meshes=[];for(var i=0;i<6;i++){var mesh=new THREE.Mesh(new THREE.PlaneGeometry(size,size),mat);mesh.doubleSided=true;cube.add(mesh);meshes.push(mesh)}meshes[0].rotation.x=Math.PI/2;meshes[0].rotation.z=-Math.PI/2;meshes[0].position.x=size/2;meshes[1].rotation.x=Math.PI/2;meshes[1].rotation.z=Math.PI/2;meshes[1].position.x=-size/2;meshes[2].position.y=size/2;meshes[3].rotation.y=Math.PI;meshes[3].rotation.z=Math.PI;meshes[3].position.y=-size/2;meshes[4].rotation.x=Math.PI/2;meshes[4].position.z=size/2;meshes[5].rotation.x=-Math.PI/2;meshes[5].rotation.y=Math.PI;meshes[5].position.z=-size/2;return cube};Skin.prototype.createPlayerObject=function(scene){var headgroup=new THREE.Object3D;var upperbody=this.upperbody=new THREE.Object3D;var leftleggeo=new THREE.CubeGeometry(4,12,4);for(var i=0;i<8;i+=1){leftleggeo.vertices[i].y-=6}var leftleg=this.leftLeg=new THREE.Mesh(leftleggeo,this.charMaterial);leftleg.position.z=-2;leftleg.position.y=-6;this.UVMap(leftleg,0,8,20,-4,12);this.UVMap(leftleg,1,16,20,-4,12);this.UVMap(leftleg,2,4,16,4,4,3);this.UVMap(leftleg,3,8,20,4,-4,1);this.UVMap(leftleg,4,12,20,-4,12);this.UVMap(leftleg,5,4,20,-4,12);var rightleggeo=new THREE.CubeGeometry(4,12,4);for(var i=0;i<8;i+=1){rightleggeo.vertices[i].y-=6}var rightleg=this.rightLeg=new THREE.Mesh(rightleggeo,this.charMaterial);rightleg.position.z=2;rightleg.position.y=-6;this.UVMap(rightleg,0,4,20,4,12);this.UVMap(rightleg,1,12,20,4,12);this.UVMap(rightleg,2,8,16,-4,4,3);this.UVMap(rightleg,3,12,20,-4,-4,1);this.UVMap(rightleg,4,0,20,4,12);this.UVMap(rightleg,5,8,20,4,12);var bodygeo=new THREE.CubeGeometry(4,12,8);var bodymesh=this.body=new THREE.Mesh(bodygeo,this.charMaterial);this.UVMap(bodymesh,0,20,20,8,12);this.UVMap(bodymesh,1,32,20,8,12);this.UVMap(bodymesh,2,20,16,8,4,1);this.UVMap(bodymesh,3,28,16,8,4,3);this.UVMap(bodymesh,4,16,20,4,12);this.UVMap(bodymesh,5,28,20,4,12);upperbody.add(bodymesh);var leftarmgeo=new THREE.CubeGeometry(4,12,4);for(var i=0;i<8;i+=1){leftarmgeo.vertices[i].y-=4}var leftarm=this.leftArm=new THREE.Mesh(leftarmgeo,this.charMaterial);leftarm.position.z=-6;leftarm.position.y=4;leftarm.rotation.x=Math.PI/32;this.UVMap(leftarm,0,48,20,-4,12);this.UVMap(leftarm,1,56,20,-4,12);this.UVMap(leftarm,2,48,16,-4,4,1);this.UVMap(leftarm,3,52,16,-4,4,3);this.UVMap(leftarm,4,52,20,-4,12);this.UVMap(leftarm,5,44,20,-4,12);upperbody.add(leftarm);var rightarmgeo=new THREE.CubeGeometry(4,12,4);for(var i=0;i<8;i+=1){rightarmgeo.vertices[i].y-=4}var rightarm=this.rightArm=new THREE.Mesh(rightarmgeo,this.charMaterial);rightarm.position.z=6;rightarm.position.y=4;rightarm.rotation.x=-Math.PI/32;this.UVMap(rightarm,0,44,20,4,12);this.UVMap(rightarm,1,52,20,4,12);this.UVMap(rightarm,2,44,16,4,4,1);this.UVMap(rightarm,3,48,16,4,4,3);this.UVMap(rightarm,4,40,20,4,12);this.UVMap(rightarm,5,48,20,4,12);upperbody.add(rightarm);var headgeo=new THREE.CubeGeometry(8,8,8);var headmesh=this.head=new THREE.Mesh(headgeo,this.charMaterial);headmesh.position.y=2;this.UVMap(headmesh,0,8,8,8,8);this.UVMap(headmesh,1,24,8,8,8);this.UVMap(headmesh,2,8,0,8,8,1);this.UVMap(headmesh,3,16,0,8,8,3);this.UVMap(headmesh,4,0,8,8,8);this.UVMap(headmesh,5,16,8,8,8);var unrotatedHeadMesh=new THREE.Object3D;unrotatedHeadMesh.rotation.y=Math.PI/2;unrotatedHeadMesh.add(headmesh);headgroup.add(unrotatedHeadMesh);var helmet=this.cubeFromPlanes(9,this.charMaterialTrans);helmet.position.y=2;this.UVMap(helmet.children[0],0,32+8,8,8,8);this.UVMap(helmet.children[1],0,32+24,8,8,8);this.UVMap(helmet.children[2],0,32+8,0,8,8,1);this.UVMap(helmet.children[3],0,32+16,0,8,8,3);this.UVMap(helmet.children[4],0,32+0,8,8,8);this.UVMap(helmet.children[5],0,32+16,8,8,8);headgroup.add(helmet);var ears=new THREE.Object3D;var eargeo=new THREE.CubeGeometry(1,9/8*6,9/8*6);var leftear=new THREE.Mesh(eargeo,this.charMaterial);var rightear=new THREE.Mesh(eargeo,this.charMaterial);leftear.position.y=2+9/8*5;rightear.position.y=2+9/8*5;leftear.position.z=-(9/8)*5;rightear.position.z=9/8*5;this.UVMap(leftear,0,25,1,6,6);this.UVMap(leftear,1,32,1,6,6);this.UVMap(leftear,2,25,0,6,1,1);this.UVMap(leftear,3,31,0,6,1,1);this.UVMap(leftear,4,24,1,1,6);this.UVMap(leftear,5,31,1,1,6);ears.add(leftear);ears.add(rightear);leftear.visible=rightear.visible=false;headgroup.add(ears);headgroup.position.y=8;var playerModel=this.playerModel=new THREE.Object3D;playerModel.add(leftleg);playerModel.add(rightleg);playerModel.add(upperbody);var playerRotation=new THREE.Object3D;playerRotation.rotation.y=Math.PI/2;playerRotation.position.y=12;playerRotation.add(playerModel);var rotatedHead=new THREE.Object3D;rotatedHead.rotation.y=-Math.PI/2;rotatedHead.add(headgroup);playerModel.add(rotatedHead);playerModel.position.y=6;var playerGroup=new THREE.Object3D;playerGroup.cameraInside=new THREE.Object3D;playerGroup.cameraOutside=new THREE.Object3D;playerGroup.cameraInside.position.x=0;playerGroup.cameraInside.position.y=2;playerGroup.cameraInside.position.z=0;playerGroup.head=headgroup;headgroup.add(playerGroup.cameraInside);playerGroup.cameraInside.add(playerGroup.cameraOutside);playerGroup.cameraOutside.position.z=100;playerGroup.add(playerRotation);playerGroup.scale=this.scale;return playerGroup}},{}],242:[function(require,module,exports){var bits=require("bit-twiddle");function size(chunk){var count=0;var chunk_len=chunk.length;var i=0,v,l;while(i<chunk.length){v=chunk[i];l=0;while(i<chunk_len&&chunk[i]===v){++i;++l}count+=bits.log2(l)/7|0;count+=bits.log2(v>>>0)/7|0;count+=2}return count}exports.size=size;function encode(chunk,runs){if(!runs){runs=new Uint8Array(size(chunk))}var rptr=0,nruns=runs.length;var i=0,v,l;while(i<chunk.length){v=chunk[i];l=0;while(i<chunk.length&&chunk[i]===v){++i;++l}while(rptr<nruns&&l>=128){runs[rptr++]=128+(l&127);l>>>=7}if(rptr>=nruns){throw new Error("RLE buffer overflow")}runs[rptr++]=l;v>>>=0;while(rptr<nruns&&v>=128){runs[rptr++]=128+(v&127);v>>>=7}if(rptr>=nruns){throw new Error("RLE buffer overflow")}runs[rptr++]=v}return runs}exports.encode=encode;function decode(runs,chunk){var buf_len=chunk.length;var nruns=runs.length;var cptr=0;var ptr=0;var l,s,v,i;while(ptr<nruns){l=0;s=0;while(ptr<nruns&&runs[ptr]>=128){l+=(runs[ptr++]&127)<<s;s+=7}l+=runs[ptr++]<<s;if(ptr>=nruns){throw new Error("RLE buffer underrun")}if(cptr+l>buf_len){throw new Error("Chunk buffer overflow")}v=0;s=0;while(ptr<nruns&&runs[ptr]>=128){v+=(runs[ptr++]&127)<<s;s+=7}if(ptr>=nruns){throw new Error("RLE buffer underrun")}v+=runs[ptr++]<<s;for(i=0;i<l;++i){chunk[cptr++]=v}}return chunk}exports.decode=decode},{"bit-twiddle":243}],243:[function(require,module,exports){module.exports=require(73)},{}],244:[function(require,module,exports){var names=["alpha","space","beta","omega","zone","base","bass","centaur","official","free","fresh","freedom","power","synth","lazer","gamma","red","green","ultra","net","cafe","secret","open","track","wisdom","genghis","tron","grid","plus","maximum","pre","post","mid","pyramid","core","fast","dragon","wizard","yak","crystal","electric","rizzle","tiny","pantry","dry","bleeding","fruit","mower","whiskey","marble","cake","meat","donkey","wewo","banana","rooster","bear","bacon","moon","glitter","grandma","walrus","party","junk","crazy","turbo","hyper","mega","boss","dunk","pow","icy","bobo","pile","tater","wiz","gnarl","mix","pop","mustard","bizzler","fog","punch","planar"];module.exports=function(len){len=len||2;var name="";while(len>0){name+=randomName();len--}return name};function randomName(){return names[~~(Math.random()*names.length)]}},{}],245:[function(require,module,exports){arguments[4][129][0].apply(exports,arguments)},{"./lib/detector":246,"./lib/stats":247,__browserify_process:510,"aabb-3d":248,"collide-3d-tilemap":249,events:507,"gl-matrix":250,inherits:251,interact:252,"kb-bindings":261,path:514,"pin-it":266,raf:267,"spatial-events":268,three:270,tic:271,voxel:286,"voxel-control":272,"voxel-mesh":273,"voxel-physical":274,"voxel-raycast":278,"voxel-region-change":279,"voxel-texture":280,"voxel-view":284}],246:[function(require,module,exports){module.exports=require(130)},{}],247:[function(require,module,exports){module.exports=require(131)},{}],248:[function(require,module,exports){module.exports=require(132)},{"gl-matrix":250}],249:[function(require,module,exports){module.exports=require(133)},{}],250:[function(require,module,exports){module.exports=require(134)},{}],251:[function(require,module,exports){module.exports=require(4)},{}],252:[function(require,module,exports){arguments[4][136][0].apply(exports,arguments)},{"drag-stream":253,events:507,fullscreen:259,"pointer-lock":260,stream:520}],253:[function(require,module,exports){arguments[4][137][0].apply(exports,arguments)},{"domnode-dom":254,stream:520,through:258}],254:[function(require,module,exports){arguments[4][138][0].apply(exports,arguments)},{"./lib/index":255}],255:[function(require,module,exports){module.exports=require(139)},{"./readable":256,"./writable":257}],256:[function(require,module,exports){module.exports=require(140)},{stream:520}],257:[function(require,module,exports){module.exports=require(141)},{stream:520}],258:[function(require,module,exports){module.exports=require(142)},{__browserify_process:510,stream:520}],259:[function(require,module,exports){module.exports=require(143)},{events:507}],260:[function(require,module,exports){module.exports=require(144)},{events:507,stream:520}],261:[function(require,module,exports){arguments[4][145][0].apply(exports,arguments)},{events:507,ever:262,vkey:265}],262:[function(require,module,exports){module.exports=require(40)},{"./init.json":263,"./types.json":264,events:507}],263:[function(require,module,exports){module.exports=require(41)},{}],264:[function(require,module,exports){module.exports=require(42)},{}],265:[function(require,module,exports){module.exports=require(25)},{}],266:[function(require,module,exports){module.exports=require(150)},{}],267:[function(require,module,exports){module.exports=require(151)},{events:507}],268:[function(require,module,exports){arguments[4][152][0].apply(exports,arguments)},{"./tree":269,"aabb-3d":248}],269:[function(require,module,exports){arguments[4][153][0].apply(exports,arguments)},{"aabb-3d":248}],270:[function(require,module,exports){module.exports=require(154)},{}],271:[function(require,module,exports){module.exports=require(155)},{}],272:[function(require,module,exports){module.exports=require(156)},{stream:520}],273:[function(require,module,exports){module.exports=require(157)},{three:270}],274:[function(require,module,exports){arguments[4][158][0].apply(exports,arguments)},{"aabb-3d":275,three:277}],275:[function(require,module,exports){module.exports=require(132)},{"gl-matrix":276}],276:[function(require,module,exports){module.exports=require(134)},{}],277:[function(require,module,exports){module.exports=require(161)},{__browserify_process:510}],278:[function(require,module,exports){module.exports=require(162)},{}],279:[function(require,module,exports){arguments[4][163][0].apply(exports,arguments)},{"aabb-3d":248,events:507}],280:[function(require,module,exports){module.exports=require(164)},{atlaspack:281,opaque:282,tic:271,"voxel-fakeao":283}],281:[function(require,module,exports){module.exports=require(165)},{}],282:[function(require,module,exports){module.exports=require(166)},{}],283:[function(require,module,exports){module.exports=require(167)},{}],284:[function(require,module,exports){module.exports=require(168)},{__browserify_process:510}],285:[function(require,module,exports){module.exports=require(107)},{events:507,inherits:292}],286:[function(require,module,exports){arguments[4][108][0].apply(exports,arguments)},{"./chunker":285,"./meshers/culled":287,"./meshers/greedy":288,"./meshers/monotone":289,"./meshers/stupid":290,"./meshers/transgreedy":291}],287:[function(require,module,exports){module.exports=require(109)},{}],288:[function(require,module,exports){module.exports=require(110)},{}],289:[function(require,module,exports){module.exports=require(111)},{}],290:[function(require,module,exports){module.exports=require(112)},{}],291:[function(require,module,exports){module.exports=require(113)},{}],292:[function(require,module,exports){module.exports=require(4)},{}],293:[function(require,module,exports){var process=require("__browserify_process");"use strict";var EventEmitter=require("events").EventEmitter;var inherits=require("inherits");var tsort=require("tsort");module.exports=function(game,opts){return new Plugins(game,opts)};function Plugins(game,opts){this.game=game;if(this.game)this.game.plugins=this;opts=opts||{};this.require=opts.require||require;this.catchExceptions=false;this.masterPluginName=opts.masterPluginName||"voxel-engine";this.all={};this.savedOpts={};this.graph=tsort()}Plugins.prototype.wrapExceptions=function(f){var ret;if(!this.catchExceptions){ret=f();return ret===undefined?true:ret}try{ret=f()}catch(e){console.log("caught exception:",e,"calling",f);console.trace();return false}return ret===undefined?true:ret};Plugins.prototype.scan=function(name){var createPlugin=this.require(name);return createPlugin};Plugins.prototype.scanAndInstantiate=function(name,opts){if(this.get(name)){console.log("plugin already instantiated: ",name);return false}opts=opts||{};var createPlugin=this.scan(name);if(createPlugin.pluginInfo&&createPlugin.pluginInfo.clientOnly){if(!this.game.isClient){console.log("Skipping client-only plugin ("+name+"), in non-client environment");return false}}if(this.game&&this.masterPluginName===name){console.log("Skipping already-loaded master plugin: "+this.masterPluginName);return false}if(!createPlugin){console.log("plugin not found: ",name);return false}var self=this;if(!this.wrapExceptions(function(){return self.instantiate(createPlugin,name,opts)})){console.log("failed to instantiate ",name)}return true};Plugins.prototype.instantiate=function(createPlugin,name,opts){var plugin;if(!this.game&&name===this.masterPluginName){this.game=plugin=createPlugin(opts);this.game.plugins=this;if(process.browser&&this.game.notCapable()){if(window.document)window.document.body.appendChild(this.game.notCapableMessage());throw new Error("[voxel-plugins] fatal error: your system is not capable of running voxel-engine (game.notCapable)")}}else{plugin=createPlugin(this.game,opts);if(!plugin){console.log("create plugin failed:",name,createPlugin,plugin);return false}}plugin.pluginName=name;this.emit("new plugin",name);plugin.pluginEnabled=true;this.emit("plugin enabled",name);this.all[name]=plugin;console.log("Instantiated plugin:",name);return plugin};Plugins.prototype.preconfigure=function(name,opts){this.savedOpts[name]=opts;if(!this.get(name))this.emit("new plugin",name)};Plugins.prototype.add=function(name,opts){if(!opts&&!this.savedOpts[name])throw new Error("voxel-plugins preload("+name+"): missing required options and not preconfigured");if(opts.onDemand)return this.preconfigure(name,opts);var createPlugin=this.scan(name);if(!createPlugin)return false;this.buildGraph(createPlugin,name);this.preconfigure(name,opts)};Plugins.prototype.buildGraph=function(createPlugin,name){var loadAfter=[];if(createPlugin.pluginInfo){loadAfter=createPlugin.pluginInfo.loadAfter;if(!loadAfter)loadAfter=[]}if(name!==this.masterPluginName)loadAfter.unshift(this.masterPluginName);for(var i=0;i<loadAfter.length;++i)this.graph.add(loadAfter[i],name)};Plugins.prototype.loadAll=function(){var sortedPluginNames=this.graph.sort();console.log("sortedPluginNames:"+JSON.stringify(sortedPluginNames));for(var i=0;i<sortedPluginNames.length;++i){var name=sortedPluginNames[i];if(!this.isEnabled(name))this.enable(name)}};Plugins.prototype.get=function(name){if(typeof name==="string")return this.all[name];else return name};Plugins.prototype.isEnabled=function(name){var plugin=this.get(name);return!!(plugin&&plugin.pluginEnabled)};Plugins.prototype.isLoaded=function(name){var plugin=this.get(name);return!!(plugin&&plugin.pluginName&&this.all[plugin.pluginName])};Plugins.prototype.list=function(){return this.listAll().filter(this.isEnabled.bind(this))};Plugins.prototype.listAll=function(){var loaded=Object.keys(this.all);var unloaded=Object.keys(this.savedOpts).filter(function(x){return loaded.indexOf(x)==-1});return loaded.concat(unloaded)};Plugins.prototype.enable=function(name){var plugin=this.get(name);if(!plugin){if(this.savedOpts[name]){return this.scanAndInstantiate(name,this.savedOpts[name])}else{if(name!==this.masterPluginName)console.log("no such plugin loaded to enable: ",plugin,name)}return false}else{if(plugin.pluginEnabled){console.log("already enabled: ",plugin,name);return false}if(plugin.enable){if(!this.wrapExceptions(function(){plugin.enable()})){console.log("failed to enable:",plugin,name);return false}}plugin.pluginEnabled=true;this.emit("plugin enabled",name)}return true};Plugins.prototype.disable=function(name){console.log("disabling plugin ",name);var plugin=this.get(name);if(!plugin){console.log("no such plugin loaded to disable: ",plugin,name);return false}if(!this.isEnabled(plugin)){console.log("already disabled: ",plugin,name);return false}if(plugin.disable){if(!this.wrapExceptions(function(){plugin.disable()})){console.log("failed to disable:",plugin,name);return false}}plugin.pluginEnabled=false;this.emit("plugin disabled",name);return true};Plugins.prototype.toggle=function(name){if(this.isEnabled(name)){return this.disable(name)}else{return this.enable(name)}};Plugins.prototype.destroy=function(name){var plugin=this.get(name);if(!plugin){console.log("no plugin",plugin,name);return false}if(!this.all[plugin.pluginName]){console.log("no such plugin to destroy: ",plugin);return false}if(this.isEnabled(plugin))this.disable(plugin);delete this.all[plugin.pluginName];console.log("destroyed  ",plugin);return true};inherits(Plugins,EventEmitter)},{__browserify_process:510,events:507,inherits:294,tsort:295}],294:[function(require,module,exports){module.exports=require(4)},{}],295:[function(require,module,exports){var util=require("util");module.exports=function tsort(initial){var graph=new Graph;if(initial){initial.forEach(function(entry){Graph.prototype.add.apply(graph,entry)})}return graph};function Graph(){this.nodes={}}Graph.prototype.add=function(){var self=this;var items=[].slice.call(arguments);if(items.length==1&&util.isArray(items[0]))items=items[0];items.forEach(function(item){if(!self.nodes[item])self.nodes[item]=[]});for(var i=1;i<items.length;i++){var from=items[i];var to=items[i-1];self.nodes[from].push(to)}return self};Graph.prototype.sort=function(){var self=this;var nodes=Object.keys(this.nodes);var sorted=[];var marks={};for(var i=0;i<nodes.length;i++){var node=nodes[i];if(!marks[node])visit(node)}return sorted;function visit(node){if(marks[node]==="temp")throw new Error("There is a cycle in the graph. It is not possible to derive a topological sort.");else if(marks[node])return;marks[node]="temp";self.nodes[node].forEach(visit);marks[node]="perm";sorted.push(node)}}},{util:529}],296:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var DuplexEmitter=require("duplex-emitter");var extend=require("extend");var path=require("path");var uuid=require("hat");var crunch=require("voxel-crunch");module.exports=Server;function Server(opts){if(!(this instanceof Server)){return new Server(opts)}this.initialize(opts)}Server.prototype.initialize=function(opts){var self=this;var defaults={isClient:false,chunkDistance:2,materials:[["grass","dirt","grass_dirt"],"obsidian","brick","grass"],worldOrigin:[0,0,0],controls:{discreteFire:true},avatarInitialPosition:[2,20,2],forwardEvents:[]};var settings=self.settings=extend({},defaults,opts);var engine=opts.engine;if(!engine)throw new Error("voxel-server requires engine option set to voxel-engine module");extend(self,new EventEmitter);self.forwardEvents=settings.forwardEvents;var game=self.game=engine(settings);var clients=self.clients={};var chunkCache=self.chunkCache={};setInterval(self.sendUpdate.bind(self),1e3/22);game.voxels.on("missingChunk",function(chunk){self.emit("missingChunk",chunk)})};Server.prototype.connectClient=function(duplexStream,id){var self=this;var settings=self.settings;var game=self.game;var connection=DuplexEmitter(duplexStream);id=id||uuid();connection.id=duplexStream.id=id;self.broadcast(id,"join",id);var client=self.clients[id]={id:id,connection:connection,player:{rotation:new game.THREE.Vector3,position:new game.THREE.Vector3}};self.bindClientEvents(client);connection.emit("id",id);connection.emit("settings",{})};Server.prototype.removeClient=function(id){var self=this;var client=self.clients[id];delete self.clients[id];self.broadcast(id,"leave",id)};Server.prototype.bindClientEvents=function(client){var self=this;var game=self.game;var id=client.id;var connection=client.connection;connection.on("chat",self.handleErrors(function(message){if(!message.text)return;if(message.text.length>140)message.text=message.text.substr(0,140);self.broadcast(null,"chat",message)}));connection.on("created",self.handleErrors(function(){self.sendInitialChunks(connection);self.emit("client.created",client)}));connection.on("state",self.handleErrors(function(state){client.player.rotation.x=state.rotation.x;client.player.rotation.y=state.rotation.y;var pos=client.player.position;var distance=pos.distanceTo(state.position);if(distance>20){var before=pos.clone();pos.lerp(state.position,.1);return}pos.copy(state.position);self.emit("client.state",client,state)}));var chunkCache=self.chunkCache;connection.on("set",self.handleErrors(function(pos,val){game.setBlock(pos,val);var chunkPos=game.voxels.chunkAtPosition(pos);var chunkID=chunkPos.join("|");if(chunkCache[chunkID])delete chunkCache[chunkID];self.broadcast(null,"set",pos,val,client.id)}));self.forwardEvents.map(function(eventName){connection.on(eventName,function(){var args=[].slice.apply(arguments);args.unshift(eventName);args.unshift(id);self.broadcast.apply(self,args)})})};Server.prototype.broadcast=function(id,event){var self=this;var args=[].slice.apply(arguments);args.shift();if(id!=="server")self.emit.apply(self,args);Object.keys(self.clients).map(function(clientId){if(clientId===id)return;try{var connection=self.clients[clientId].connection;connection.emit.apply(connection,args)}catch(err){console.log("removing erroring client",clientId,err);self.removeClient(clientId)}})};Server.prototype.sendUpdate=function(){var self=this;var clientIds=Object.keys(self.clients);if(clientIds.length===0)return;var update={positions:{},date:+new Date};clientIds.map(function(id){var client=self.clients[id];update.positions[id]={position:client.player.position,rotation:{x:client.player.rotation.x,y:client.player.rotation.y}}});self.broadcast(null,"update",update)};Server.prototype.sendInitialChunks=function(connection){var self=this;var chunks=self.game.voxels.chunks;var chunkCache=self.chunkCache;Object.keys(chunks).map(function(chunkID){var chunk=chunks[chunkID];var encoded=chunkCache[chunkID];if(!encoded){encoded=crunch.encode(chunk.voxels);chunkCache[chunkID]=encoded}connection.emit("chunk",encoded,{position:chunk.position,dims:chunk.dims,length:chunk.voxels.length})});connection.emit("noMoreChunks",true)};Server.prototype.handleErrors=function(func){var self=this;return function(){try{return func.apply(this,arguments)}catch(error){self.emit("error",error)}}}},{"duplex-emitter":297,events:507,extend:305,hat:306,path:514,"voxel-crunch":307}],297:[function(require,module,exports){arguments[4][232][0].apply(exports,arguments)},{"./read_emitter":303,"./write_emitter":304,events:507,util:529}],298:[function(require,module,exports){module.exports=require(233)
},{string_decoder:526,through:301}],299:[function(require,module,exports){module.exports=require(234)},{duplexer:300}],300:[function(require,module,exports){module.exports=require(235)},{stream:520}],301:[function(require,module,exports){module.exports=require(82)},{__browserify_process:510,stream:520}],302:[function(require,module,exports){arguments[4][237][0].apply(exports,arguments)},{split:298,"stream-combiner":299,through:301}],303:[function(require,module,exports){arguments[4][238][0].apply(exports,arguments)},{"./parser":302,assert:506,events:507,util:529}],304:[function(require,module,exports){module.exports=require(239)},{assert:506,events:507,util:529}],305:[function(require,module,exports){module.exports=require(181)},{}],306:[function(require,module,exports){var hat=module.exports=function(bits,base){if(!base)base=16;if(bits===undefined)bits=128;if(bits<=0)return"0";var digits=Math.log(Math.pow(2,bits))/Math.log(base);for(var i=2;digits===Infinity;i*=2){digits=Math.log(Math.pow(2,bits/i))/Math.log(base)*i}var rem=digits-Math.floor(digits);var res="";for(var i=0;i<Math.floor(digits);i++){var x=Math.floor(Math.random()*base).toString(base);res=x+res}if(rem){var b=Math.pow(base,rem);var x=Math.floor(Math.random()*b).toString(base);res=x+res}var parsed=parseInt(res,base);if(parsed!==Infinity&&parsed>=Math.pow(2,bits)){return hat(bits,base)}else return res};hat.rack=function(bits,base,expandBy){var fn=function(data){var iters=0;do{if(iters++>10){if(expandBy)bits+=expandBy;else throw new Error("too many ID collisions, use more bits")}var id=hat(bits,base)}while(Object.hasOwnProperty.call(hats,id));hats[id]=data;return id};var hats=fn.hats={};fn.get=function(id){return fn.hats[id]};fn.set=function(id,value){fn.hats[id]=value;return fn};fn.bits=bits||128;fn.base=base||16;return fn}},{}],307:[function(require,module,exports){module.exports=require(242)},{"bit-twiddle":308}],308:[function(require,module,exports){module.exports=require(73)},{}],309:[function(require,module,exports){(function(){var Furnace,FurnaceDialog,Inventory,InventoryDialog,InventoryWindow,ItemPile,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};InventoryDialog=require("voxel-inventory-dialog").InventoryDialog;Inventory=require("inventory");InventoryWindow=require("inventory-window");ItemPile=require("itempile");module.exports=function(game,opts){return new Furnace(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-registry","voxel-recipes","voxel-carry","voxel-blockdata"]};Furnace=function(){function Furnace(game,opts){var _ref,_ref1,_ref2,_ref3;this.game=game;if(opts==null){opts={}}this.playerInventory=function(){var _ref1,_ref2,_ref3;if((_ref=(_ref1=(_ref2=game.plugins)!=null?(_ref3=_ref2.get("voxel-carry"))!=null?_ref3.inventory:void 0:void 0)!=null?_ref1:opts.playerInventory)!=null){return _ref}else{throw new Error('voxel-furnace requires "voxel-carry" plugin or "playerInventory" set to inventory instance')}}();this.registry=function(){var _ref2;if((_ref1=(_ref2=game.plugins)!=null?_ref2.get("voxel-registry"):void 0)!=null){return _ref1}else{throw new Error('voxel-furnace requires "voxel-registry" plugin')}}();this.recipes=function(){var _ref3;if((_ref2=(_ref3=game.plugins)!=null?_ref3.get("voxel-recipes"):void 0)!=null){return _ref2}else{throw new Error('voxel-furnace requires "voxel-recipes" plugin')}}();if(this.recipes.registerSmelting==null){throw new Error("voxel-furnace requires voxel-recipes with smelting recipes")}this.blockdata=function(){var _ref4;if((_ref3=(_ref4=game.plugins)!=null?_ref4.get("voxel-blockdata"):void 0)!=null){return _ref3}else{throw new Error('voxel-furnace requires "voxel-blockdata plugin')}}();if(opts.registerBlock==null){opts.registerBlock=true}if(opts.registerRecipe==null){opts.registerRecipe=true}if(opts.registerItems==null){opts.registerItems=true}if(opts.registerRecipes==null){opts.registerRecipes=true}if(this.game.isClient){this.furnaceDialog=new FurnaceDialog(game,this.playerInventory,this.registry,this.recipes,this.blockdata)}this.opts=opts;this.enable()}Furnace.prototype.enable=function(){if(this.opts.registerBlock){this.registry.registerBlock("furnace",{texture:["furnace_top","cobblestone","furnace_front_on"],onInteract:function(_this){return function(target){_this.furnaceDialog.open(target);return true}}(this)})}if(this.opts.registerRecipe){this.recipes.registerPositional([["cobblestone","cobblestone","cobblestone"],["cobblestone",void 0,"cobblestone"],["cobblestone","cobblestone","cobblestone"]],["furnace"])}if(this.opts.registerItems){this.registry.registerItem("ingotIron",{itemTexture:"i/iron_ingot"})}if(this.opts.registerRecipes){this.recipes.registerSmelting("oreIron",new ItemPile("ingotIron"));this.recipes.registerSmelting("oreCoal",new ItemPile("coal"));return this.recipes.registerSmelting("cobblestone",new ItemPile("stone"))}};Furnace.prototype.disable=function(){};return Furnace}();FurnaceDialog=function(_super){__extends(FurnaceDialog,_super);function FurnaceDialog(game,playerInventory,registry,recipes,blockdata){var allDiv,bfDiv,burnCont,fuelCont,resultCont;this.game=game;this.playerInventory=playerInventory;this.registry=registry;this.recipes=recipes;this.blockdata=blockdata;this.burnInventory=new Inventory(1);this.burnInventory.on("changed",function(_this){return function(){return _this.updateSmelting()}}(this));this.burnIW=new InventoryWindow({width:1,registry:this.registry,inventory:this.burnInventory,linkedInventory:this.playerInventory});this.fuelInventory=new Inventory(1);this.fuelInventory.on("changed",function(_this){return function(){return _this.updateSmelting()}}(this));this.fuelIW=new InventoryWindow({width:1,registry:this.registry,inventory:this.fuelInventory,linkedInventory:this.playerInventory});this.resultInventory=new Inventory(1);this.resultIW=new InventoryWindow({inventory:this.resultInventory,registry:this.registry,allowDrop:false,linkedInventory:this.playerInventory});this.resultIW.on("pickup",function(_this){return function(){return _this.updateSmelting()}}(this));allDiv=document.createElement("div");allDiv.style.display="flex";allDiv.style.justifyContent="center";allDiv.style.width="100%";burnCont=this.burnIW.createContainer();fuelCont=this.fuelIW.createContainer();resultCont=this.resultIW.createContainer();burnCont.style.display="flex";burnCont.style.flex="1";fuelCont.style.display="flex";resultCont.style.display="flex";resultCont.style.flexFlow="column";resultCont.style.justifyContent="center";bfDiv=document.createElement("div");bfDiv.style.display="flex";bfDiv.style.flexFlow="column";bfDiv.style.paddingTop="10px";bfDiv.style.paddingRight="50px";bfDiv.appendChild(burnCont);bfDiv.appendChild(fuelCont);allDiv.appendChild(bfDiv);allDiv.appendChild(resultCont);FurnaceDialog.__super__.constructor.call(this,game,{playerLinkedInventory:this.burnInventory,upper:[allDiv]})}FurnaceDialog.prototype.updateSmelting=function(){var burn,fuel,smeltedOutput;if(this.isSmelting){return}this.isSmelting=true;while(true){if(!this.isFuel(this.fuelInventory.get(0))){break}smeltedOutput=this.recipes.smelt(this.burnInventory.get(0));if(smeltedOutput==null){break}if(this.resultInventory.get(0)&&(this.resultInventory.get(0).item!==smeltedOutput.item||this.resultInventory.get(0).count===64)){break}console.log("smelting: "+this.fuelInventory+" + "+this.burnInventory+" = "+this.resultInventory);fuel=this.fuelInventory.takeAt(0,1);burn=this.burnInventory.takeAt(0,1);this.resultInventory.give(smeltedOutput);console.log("smelted: "+this.fuelInventory+" + "+this.burnInventory+" = "+this.resultInventory)}this.isSmelting=false;return this.updateBlockdata()};FurnaceDialog.prototype.isFuel=function(itemPile){var fuelBurnTime,props;if(!itemPile){return false}props=this.registry.getItemProps(itemPile.item);if(!props){return false}fuelBurnTime=props.fuelBurnTime;if(!fuelBurnTime){return false}return true};FurnaceDialog.prototype.loadBlockdata=function(x,y,z){var bd,_ref,_ref1,_ref2,_ref3,_ref4,_ref5;bd=this.blockdata.get(x,y,z);if(bd!=null){this.burnInventory.set(0,ItemPile.fromString((_ref=bd.burn)!=null?_ref:""));this.fuelInventory.set(0,ItemPile.fromString((_ref1=bd.fuel)!=null?_ref1:""));this.resultInventory.set(0,ItemPile.fromString((_ref2=bd.result)!=null?_ref2:""))}else{bd={burn:(_ref3=this.burnInventory.get(0))!=null?_ref3.toString():void 0,fuel:(_ref4=this.fuelInventory.get(0))!=null?_ref4.toString():void 0,result:(_ref5=this.resultInventory.get(0))!=null?_ref5.toString():void 0};this.blockdata.set(x,y,z,bd)}this.activeBlockdata=bd;return console.log("load bd",x,y,z,JSON.stringify(this.activeBlockdata))};FurnaceDialog.prototype.updateBlockdata=function(){var _ref,_ref1,_ref2;console.log("burn="+this.burnInventory+", fuel="+this.fuelInventory+", result="+this.resultInventory);if(this.activeBlockdata==null){return}this.activeBlockdata.burn=(_ref=this.burnInventory.get(0))!=null?_ref.toString():void 0;this.activeBlockdata.fuel=(_ref1=this.fuelInventory.get(0))!=null?_ref1.toString():void 0;this.activeBlockdata.result=(_ref2=this.resultInventory.get(0))!=null?_ref2.toString():void 0;return console.log("update bd",JSON.stringify(this.activeBlockdata))};FurnaceDialog.prototype.open=function(target){var x,y,z,_ref;_ref=target.voxel,x=_ref[0],y=_ref[1],z=_ref[2];this.loadBlockdata(x,y,z);return FurnaceDialog.__super__.open.call(this)};FurnaceDialog.prototype.close=function(){delete this.activeBlockdata;this.burnInventory.clear();this.fuelInventory.clear();this.resultInventory.clear();return FurnaceDialog.__super__.close.call(this)};return FurnaceDialog}(InventoryDialog)}).call(this)},{inventory:316,"inventory-window":310,itempile:321,"voxel-inventory-dialog":324}],310:[function(require,module,exports){arguments[4][38][0].apply(exports,arguments)},{"cube-icon":311,events:507,ever:312,touchup:315}],311:[function(require,module,exports){module.exports=require(39)},{}],312:[function(require,module,exports){module.exports=require(40)},{"./init.json":313,"./types.json":314,events:507}],313:[function(require,module,exports){module.exports=require(41)},{}],314:[function(require,module,exports){module.exports=require(42)},{}],315:[function(require,module,exports){module.exports=require(43)},{}],316:[function(require,module,exports){arguments[4][32][0].apply(exports,arguments)},{"deep-equal":317,events:507,itempile:318}],317:[function(require,module,exports){module.exports=require(30)},{}],318:[function(require,module,exports){module.exports=require(28)},{clone:319,"deep-equal":320}],319:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],320:[function(require,module,exports){module.exports=require(30)},{}],321:[function(require,module,exports){module.exports=require(28)},{clone:322,"deep-equal":323}],322:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],323:[function(require,module,exports){module.exports=require(30)},{}],324:[function(require,module,exports){arguments[4][52][0].apply(exports,arguments)},{inventory:331,"inventory-window":325,itempile:336,"voxel-modal-dialog":339}],325:[function(require,module,exports){arguments[4][38][0].apply(exports,arguments)},{"cube-icon":326,events:507,ever:327,touchup:330}],326:[function(require,module,exports){module.exports=require(39)},{}],327:[function(require,module,exports){module.exports=require(40)},{"./init.json":328,"./types.json":329,events:507}],328:[function(require,module,exports){module.exports=require(41)},{}],329:[function(require,module,exports){module.exports=require(42)},{}],330:[function(require,module,exports){module.exports=require(43)},{}],331:[function(require,module,exports){arguments[4][32][0].apply(exports,arguments)},{"deep-equal":332,events:507,itempile:333}],332:[function(require,module,exports){module.exports=require(30)},{}],333:[function(require,module,exports){module.exports=require(28)},{clone:334,"deep-equal":335}],334:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],335:[function(require,module,exports){module.exports=require(30)},{}],336:[function(require,module,exports){module.exports=require(28)},{clone:337,"deep-equal":338}],337:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],338:[function(require,module,exports){module.exports=require(30)},{}],339:[function(require,module,exports){arguments[4][67][0].apply(exports,arguments)},{"voxel-modal":340}],340:[function(require,module,exports){arguments[4][68][0].apply(exports,arguments)},{ever:341}],341:[function(require,module,exports){module.exports=require(40)},{"./init.json":342,"./types.json":343,events:507}],342:[function(require,module,exports){module.exports=require(41)},{}],343:[function(require,module,exports){module.exports=require(42)},{}],344:[function(require,module,exports){(function(){var Gamemode,Inventory,ItemPile;ItemPile=require("itempile");Inventory=require("inventory");module.exports=function(game,opts){return new Gamemode(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-mine","voxel-carry","voxel-fly","voxel-registry","voxel-harvest"]};Gamemode=function(){function Gamemode(game,opts){var _ref,_ref1;this.game=game;if(!this.game.isClient){return}if(this.game.buttons.down==null){throw new Error("voxel-gamemode requires game.buttons as kb-bindings (vs kb-controls), cannot add down event listener")}this.mode=(_ref=opts.startMode)!=null?_ref:"survival";this.registry=function(){var _ref2;if((_ref1=(_ref2=this.game.plugins)!=null?_ref2.get("voxel-registry"):void 0)!=null){return _ref1}else{throw new Error('voxel-gamemode requires "voxel-registry" plugin')}}.call(this);this.enable()}Gamemode.prototype.enable=function(){var carry,_ref,_ref1;carry=(_ref=this.game.plugins)!=null?_ref.get("voxel-carry"):void 0;if(carry){this.survivalInventory=new Inventory(carry.inventory.width,carry.inventory.height);this.creativeInventory=new Inventory(carry.inventory.width,carry.inventory.height)}if(((_ref1=this.game.plugins)!=null?_ref1.isEnabled("voxel-fly"):void 0)&&this.mode==="survival"){this.game.plugins.disable("voxel-fly")}return this.game.buttons.down.on("gamemode",this.onDown=function(_this){return function(){var playerInventory,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8;playerInventory=(_ref2=_this.game.plugins.get("voxel-carry"))!=null?_ref2.inventory:void 0;if(_this.mode==="survival"){_this.mode="creative";_this.game.plugins.enable("voxel-fly");if((_ref3=_this.game.plugins.get("voxel-mine"))!=null){_ref3.instaMine=true}if((_ref4=_this.game.plugins.get("voxel-harvest"))!=null){_ref4.enableToolDamage=false}_this.populateCreative();if(_this.survivalInventory!=null){if(playerInventory!=null){playerInventory.transferTo(_this.survivalInventory)}}if(playerInventory!=null){if((_ref5=_this.creativeInventory)!=null){_ref5.transferTo(playerInventory)}}return console.log("creative mode")}else{_this.mode="survival";_this.game.plugins.disable("voxel-fly");if((_ref6=_this.game.plugins.get("voxel-mine"))!=null){_ref6.instaMine=false}if((_ref7=_this.game.plugins.get("voxel-harvest"))!=null){_ref7.enableToolDamage=true}if(_this.creativeInventory!=null){if(playerInventory!=null){playerInventory.transferTo(_this.creativeInventory)}}if(playerInventory!=null){if((_ref8=_this.survivalInventory)!=null){_ref8.transferTo(playerInventory)}}return console.log("survival mode")}}}(this))};Gamemode.prototype.disable=function(){return this.game.buttons.down.removeListener("gamemode",this.onDown)};Gamemode.prototype.populateCreative=function(){var i,name,props,registry,_i,_len,_ref,_ref1,_ref2,_results;registry=(_ref=this.game.plugins)!=null?_ref.get("voxel-registry"):void 0;if(registry!=null){i=0;_ref1=registry.itemProps;for(name in _ref1){props=_ref1[name];this.creativeInventory.set(i,new ItemPile(name,Infinity));i+=1}_ref2=registry.blockProps;_results=[];for(_i=0,_len=_ref2.length;_i<_len;_i++){props=_ref2[_i];if(props.name!=null){this.creativeInventory.set(i,new ItemPile(props.name,Infinity));_results.push(i+=1)}else{_results.push(void 0)}}return _results}};return Gamemode}()}).call(this)},{inventory:345,itempile:350}],345:[function(require,module,exports){arguments[4][32][0].apply(exports,arguments)},{"deep-equal":346,events:507,itempile:347}],346:[function(require,module,exports){module.exports=require(30)},{}],347:[function(require,module,exports){module.exports=require(28)},{clone:348,"deep-equal":349}],348:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],349:[function(require,module,exports){module.exports=require(30)},{}],350:[function(require,module,exports){module.exports=require(28)},{clone:351,"deep-equal":352}],351:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],352:[function(require,module,exports){module.exports=require(30)},{}],353:[function(require,module,exports){(function(){var EventEmitter,Harvest,ItemPile,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};EventEmitter=require("events").EventEmitter;ItemPile=require("itempile");module.exports=function(game,opts){return new Harvest(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-mine","voxel-registry","voxel-carry","voxel-inventory-hotbar"]};Harvest=function(_super){__extends(Harvest,_super);function Harvest(game,opts){var _ref,_ref1,_ref2,_ref3,_ref4;this.game=game;this.enableToolDamage=(_ref=opts.enableToolDamage)!=null?_ref:true;this.mine=function(){var _ref2;if((_ref1=(_ref2=game.plugins)!=null?_ref2.get("voxel-mine"):void 0)!=null){return _ref1}else{throw new Error('voxel-harvest requires "voxel-mine" plugin')}}();this.registry=function(){var _ref3;if((_ref2=(_ref3=game.plugins)!=null?_ref3.get("voxel-registry"):void 0)!=null){return _ref2}else{throw new Error('voxel-harvest requires "voxel-registry" plugin')}}();this.playerInventory=function(){var _ref4,_ref5,_ref6;if((_ref3=(_ref4=(_ref5=game.plugins)!=null?(_ref6=_ref5.get("voxel-carry"))!=null?_ref6.inventory:void 0:void 0)!=null?_ref4:opts.playerInventory)!=null){return _ref3}else{throw new Error('voxel-harvest requires "voxel-carry" plugin or "playerInventory" option set to inventory instance')}}();this.hotbar=(_ref4=game.plugins)!=null?_ref4.get("voxel-inventory-hotbar"):void 0;this.enable()}Harvest.prototype.enable=function(){return this.mine.on("break",this.onBreak=function(_this){return function(target){var blockName,droppedPile,excess;game.setBlock(target.voxel,0);_this.damageToolHeld(1);blockName=_this.registry.getBlockName(target.value);droppedPile=_this.block2ItemPile(blockName);if(droppedPile==null){return}excess=_this.playerInventory.give(droppedPile);if(excess>0){return _this.game.setBlock(target.voxel,target.value)}}}(this))};Harvest.prototype.disable=function(){return this.mine.removeListener("break",this.onBreak)};Harvest.prototype.damageToolHeld=function(n){var maxDamage,props,tool,_base;if(n==null){n=1}if(this.hotbar==null){return}if(!this.enableToolDamage){return}tool=this.hotbar.held();if(tool==null){return}props=this.registry.getItemProps(tool.item);maxDamage=props.maxDamage;if(maxDamage==null){return}if((_base=tool.tags).damage==null){_base.damage=0}tool.tags.damage+=1;if(tool.tags.damage>=maxDamage){tool=void 0}this.hotbar.inventory.set(this.hotbar.inventoryWindow.selectedIndex,tool);return this.hotbar.refresh()};Harvest.prototype.block2ItemPile=function(blockName){var item,itemPile,_ref;item=(_ref=this.registry.getItemProps(blockName))!=null?_ref.itemDrop:void 0;if(item===null){return void 0}if(item===void 0){item=blockName}itemPile=new ItemPile(item,1);return itemPile};return Harvest}(EventEmitter)}).call(this)},{events:507,itempile:354}],354:[function(require,module,exports){module.exports=require(28)},{clone:355,"deep-equal":356}],355:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],356:[function(require,module,exports){module.exports=require(30)},{}],357:[function(require,module,exports){"use strict";module.exports=function(game,opts){return new HealthBarPlugin(game,opts)};module.exports.pluginInfo={clientOnly:true,loadAfter:["voxel-health","voxel-inventory-hotbar"]};var cssPercentWidth=function(value,max){return value/max*100+"%"};function HealthBarPlugin(game,opts){this.opts=opts||{};this.healthPlugin=game.plugins&&game.plugins.get("voxel-health");if(!this.healthPlugin)throw new Error("voxel-health-bar requires voxel-health plugin");this.enable()}HealthBarPlugin.prototype.enable=function(){var opts=this.opts;var bar=document.createElement("div");bar.style.backgroundColor=opts.frontColor||"darkgreen";bar.style.width=cssPercentWidth(this.healthPlugin.startHealth,this.healthPlugin.maxHealth);bar.style.height="100%";var inner=document.createElement("div");inner.style.margin="0 auto";inner.style.width=opts.width||"880px";inner.style.height=opts.height||"20px";inner.style.backgroundColor=opts.backColor||"lightgreen";inner.style.opacity=opts.opacity||"0.8";inner.appendChild(bar);var container=document.createElement("div");container.setAttribute("id","voxel-health-bar");container.style.width="100%";container.style.position="absolute";container.style.bottom=opts.bottom||"100px";container.appendChild(inner);document.body.appendChild(container);this.bar=bar;this.container=container;this.healthPlugin.on("health",this.onHealth=this.update.bind(this))};HealthBarPlugin.prototype.disable=function(){if(this.container)this.container.parentElement.removeChild(this.container);delete this.bar;delete this.container;this.healthPlugin.removeListener("health",this.onHealth)};HealthBarPlugin.prototype.update=function(){if(this.bar)this.bar.style.width=this.healthPlugin.percentage()+"%"}},{}],358:[function(require,module,exports){module.exports=function(game,opts){return new HealthFallPlugin(game,opts)};function HealthFallPlugin(game,opts){this.blocksPerUnitDamage=opts.blocksPerUnitDamage||4;this.damageMultiplier=opts.damageMultiplier||1;this.player=game.plugins.get("voxel-player");if(!this.player)throw new Error("voxel-health-falling requires voxel-player");this.health=game.plugins.get("voxel-health");if(!this.health)throw new Error("voxel-health-falling requires voxel-health");this.enable()}HealthFallPlugin.prototype.enable=function(){var self=this;this.player.fell=function(dy){if(dy>=self.blocksPerUnitDamage){var damage=Math.ceil(dy/self.blocksPerUnitDamage)*self.damageMultiplier;self.health.hurt(damage)}}};HealthFallPlugin.prototype.disable=function(){this.player.fell=undefined}},{}],359:[function(require,module,exports){"use strict";var inherits=require("inherits");var EventEmitter=require("events").EventEmitter;module.exports=function(game,opts){return new Health(game,opts)};function Health(game,opts){this.maxHealth=opts.maxHealth||10;this.minHealth=opts.minHealth||0;this.startHealth=opts.startHealth||this.maxHealth;this.value=this.startHealth}inherits(Health,EventEmitter);Health.prototype.hurt=function(amount){if(amount<0)return this.heal(-amount);var oldValue=this.value;this.value-=amount;if(this.value<this.minHealth)this.value=this.minHealth;var effectiveAmount=this.value-oldValue;this.emit("health",this.value,oldValue);this.emit("hurt",effectiveAmount,amount,this.value,oldValue);if(this.value===this.minHealth){this.emit("die")}return effectiveAmount};Health.prototype.heal=function(amount){if(amount<0)return this.hurt(-amount);var oldValue=this.value;this.value+=amount;if(this.value>this.maxHealth)this.value=this.maxHealth;var effectiveAmount=oldValue-this.value;this.emit("health",this.value,oldValue);this.emit("heal",effectiveAmount,amount,this.value,oldValue);return effectiveAmount};Health.prototype.scaledValue=function(){return this.value/this.maxHealth};Health.prototype.percentage=function(){return this.scaledValue()*100}},{events:507,inherits:360}],360:[function(require,module,exports){module.exports=require(223)},{}],361:[function(require,module,exports){var inherits=require("inherits");var events=require("events");var _=require("underscore");module.exports=Highlighter;function Highlighter(game,opts){if(!(this instanceof Highlighter))return new Highlighter(game,opts);this.game=game;opts=opts||{};var geometry=this.geometry=opts.geometry||new game.THREE.CubeGeometry(1,1,1);var material=opts.material||new game.THREE.MeshBasicMaterial({color:opts.color||0,wireframe:true,wireframeLinewidth:opts.wireframeLinewidth||3,transparent:true,opacity:opts.wireframeOpacity||.5});this.mesh=new game.THREE.Mesh(geometry,material);this.distance=opts.distance||10;this.currVoxelPos;this.currVoxelAdj;this.targetPosition;this.adjacentActive=opts.adjacentActive||function(){return game.controls.state.alt};this.selectActive=opts.selectActive||function(){return game.controls.state.select};this.animate=opts.animate;this.animateFunction=opts.animateFunction||function(position,targetPosition,deltaTime){if(!position||!targetPosition||!deltaTime)return;var rate=10;if(Math.abs(targetPosition[0]-position[0])<.05&&Math.abs(targetPosition[1]-position[1])<.05&&Math.abs(targetPosition[2]-position[2])<.05){return targetPosition}deltaTime=deltaTime/1e3;position[0]+=rate*deltaTime*(targetPosition[0]-position[0]);position[1]+=rate*deltaTime*(targetPosition[1]-position[1]);position[2]+=rate*deltaTime*(targetPosition[2]-position[2]);return position};var self=this;if(this.animate)game.on("tick",function(dt){var position=[self.mesh.position.x,self.mesh.position.y,self.mesh.position.z];position=self.animateFunction(position,self.targetPosition,dt);if(position)self.mesh.position.set(position[0],position[1],position[2])});game.on("tick",_.throttle(this.highlight.bind(this),opts.frequency||100));this.selectStart;this.selectEnd}inherits(Highlighter,events.EventEmitter);Highlighter.prototype.highlight=function(){var cp=this.game.cameraPosition();var cv=this.game.cameraVector();var hit=this.game.raycastVoxels(cp,cv,this.distance);var targetPositionCandidate;var removeAdjacent=function(self){if(!self.currVoxelAdj)return;self.emit("remove-adjacent",self.currVoxelAdj);self.currVoxelAdj=undefined};if(!hit){if(!this.currVoxelPos)return;this.game.scene.remove(this.mesh);this.emit("remove",this.currVoxelPos.slice());this.currVoxelPos=undefined;removeAdjacent(this);return}var newVoxelPos=hit.voxel;if(!this.currVoxelPos||newVoxelPos[0]!==this.currVoxelPos[0]||newVoxelPos[1]!==this.currVoxelPos[1]||newVoxelPos[2]!==this.currVoxelPos[2]){if(this.currVoxelPos){this.emit("remove",this.currVoxelPos.slice())}else{this.game.scene.add(this.mesh)}this.emit("highlight",newVoxelPos.slice());this.currVoxelPos=newVoxelPos.slice()}targetPositionCandidate=[this.currVoxelPos[0]+.5,this.currVoxelPos[1]+.5,this.currVoxelPos[2]+.5];if(this.adjacentActive()){var newVoxelAdj=hit.adjacent;if(!this.currVoxelAdj||newVoxelAdj[0]!==this.currVoxelAdj[0]||newVoxelAdj[1]!==this.currVoxelAdj[1]||newVoxelAdj[2]!==this.currVoxelAdj[2]){if(this.currVoxelAdj){this.emit("remove-adjacent",this.currVoxelAdj.slice())}this.emit("highlight-adjacent",newVoxelAdj.slice());this.currVoxelAdj=newVoxelAdj.slice()}targetPositionCandidate=[this.currVoxelAdj[0]+.5,this.currVoxelAdj[1]+.5,this.currVoxelAdj[2]+.5]}else removeAdjacent(this);if(this.selectActive()){if(!this.selectStart){this.selectStart=this.selectEnd=this.currVoxelAdj||this.currVoxelPos}else{var endCandidate=this.currVoxelAdj||this.currVoxelPos;if(endCandidate[0]!==this.selectEnd[0]||endCandidate[1]!==this.selectEnd[1]||endCandidate[2]!==this.selectEnd[2]){this.selectEnd=endCandidate;this.emit("highlight-select",{start:this.selectStart.slice(),end:this.selectEnd.slice()});var scale=[];scale[0]=Math.abs(this.selectEnd[0]-this.selectStart[0])+1;scale[1]=Math.abs(this.selectEnd[1]-this.selectStart[1])+1;scale[2]=Math.abs(this.selectEnd[2]-this.selectStart[2])+1;this.mesh.scale.set(scale[0],scale[1],scale[2]);var pos=[];pos[0]=this.selectStart[0]+.5+(this.selectEnd[0]-this.selectStart[0])/2;pos[1]=this.selectStart[1]+.5+(this.selectEnd[1]-this.selectStart[1])/2;pos[2]=this.selectStart[2]+.5+(this.selectEnd[2]-this.selectStart[2])/2;this.targetPosition=pos}}}else{if(this.selectStart){this.emit("highlight-deselect",{start:this.selectStart.slice(),end:this.selectEnd.slice()});this.selectStart=null;this.mesh.scale.set(1,1,1)}this.targetPosition=targetPositionCandidate}if(!this.animate)this.mesh.position.set(this.targetPosition[0],this.targetPosition[1],this.targetPosition[2])}},{events:507,inherits:362,underscore:363}],362:[function(require,module,exports){module.exports=require(4)},{}],363:[function(require,module,exports){(function(){var root=this;var previousUnderscore=root._;var breaker={};var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,concat=ArrayProto.concat,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeForEach=ArrayProto.forEach,nativeMap=ArrayProto.map,nativeReduce=ArrayProto.reduce,nativeReduceRight=ArrayProto.reduceRight,nativeFilter=ArrayProto.filter,nativeEvery=ArrayProto.every,nativeSome=ArrayProto.some,nativeIndexOf=ArrayProto.indexOf,nativeLastIndexOf=ArrayProto.lastIndexOf,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind;var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=_}exports._=_}else{root._=_}_.VERSION="1.4.4";var each=_.each=_.forEach=function(obj,iterator,context){if(obj==null)return;if(nativeForEach&&obj.forEach===nativeForEach){obj.forEach(iterator,context)}else if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++){if(iterator.call(context,obj[i],i,obj)===breaker)return}}else{for(var key in obj){if(_.has(obj,key)){if(iterator.call(context,obj[key],key,obj)===breaker)return}}}};_.map=_.collect=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeMap&&obj.map===nativeMap)return obj.map(iterator,context);each(obj,function(value,index,list){results[results.length]=iterator.call(context,value,index,list)});return results};var reduceError="Reduce of empty array with no initial value";_.reduce=_.foldl=_.inject=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduce&&obj.reduce===nativeReduce){if(context)iterator=_.bind(iterator,context);return initial?obj.reduce(iterator,memo):obj.reduce(iterator)}each(obj,function(value,index,list){if(!initial){memo=value;initial=true}else{memo=iterator.call(context,memo,value,index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.reduceRight=_.foldr=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduceRight&&obj.reduceRight===nativeReduceRight){if(context)iterator=_.bind(iterator,context);return initial?obj.reduceRight(iterator,memo):obj.reduceRight(iterator)}var length=obj.length;if(length!==+length){var keys=_.keys(obj);length=keys.length}each(obj,function(value,index,list){index=keys?keys[--length]:--length;if(!initial){memo=obj[index];initial=true}else{memo=iterator.call(context,memo,obj[index],index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.find=_.detect=function(obj,iterator,context){var result;any(obj,function(value,index,list){if(iterator.call(context,value,index,list)){result=value;return true}});return result};_.filter=_.select=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeFilter&&obj.filter===nativeFilter)return obj.filter(iterator,context);each(obj,function(value,index,list){if(iterator.call(context,value,index,list))results[results.length]=value
});return results};_.reject=function(obj,iterator,context){return _.filter(obj,function(value,index,list){return!iterator.call(context,value,index,list)},context)};_.every=_.all=function(obj,iterator,context){iterator||(iterator=_.identity);var result=true;if(obj==null)return result;if(nativeEvery&&obj.every===nativeEvery)return obj.every(iterator,context);each(obj,function(value,index,list){if(!(result=result&&iterator.call(context,value,index,list)))return breaker});return!!result};var any=_.some=_.any=function(obj,iterator,context){iterator||(iterator=_.identity);var result=false;if(obj==null)return result;if(nativeSome&&obj.some===nativeSome)return obj.some(iterator,context);each(obj,function(value,index,list){if(result||(result=iterator.call(context,value,index,list)))return breaker});return!!result};_.contains=_.include=function(obj,target){if(obj==null)return false;if(nativeIndexOf&&obj.indexOf===nativeIndexOf)return obj.indexOf(target)!=-1;return any(obj,function(value){return value===target})};_.invoke=function(obj,method){var args=slice.call(arguments,2);var isFunc=_.isFunction(method);return _.map(obj,function(value){return(isFunc?method:value[method]).apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,function(value){return value[key]})};_.where=function(obj,attrs,first){if(_.isEmpty(attrs))return first?null:[];return _[first?"find":"filter"](obj,function(value){for(var key in attrs){if(attrs[key]!==value[key])return false}return true})};_.findWhere=function(obj,attrs){return _.where(obj,attrs,true)};_.max=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.max.apply(Math,obj)}if(!iterator&&_.isEmpty(obj))return-Infinity;var result={computed:-Infinity,value:-Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed>=result.computed&&(result={value:value,computed:computed})});return result.value};_.min=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.min.apply(Math,obj)}if(!iterator&&_.isEmpty(obj))return Infinity;var result={computed:Infinity,value:Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed<result.computed&&(result={value:value,computed:computed})});return result.value};_.shuffle=function(obj){var rand;var index=0;var shuffled=[];each(obj,function(value){rand=_.random(index++);shuffled[index-1]=shuffled[rand];shuffled[rand]=value});return shuffled};var lookupIterator=function(value){return _.isFunction(value)?value:function(obj){return obj[value]}};_.sortBy=function(obj,value,context){var iterator=lookupIterator(value);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iterator.call(context,value,index,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index<right.index?-1:1}),"value")};var group=function(obj,value,context,behavior){var result={};var iterator=lookupIterator(value||_.identity);each(obj,function(value,index){var key=iterator.call(context,value,index,obj);behavior(result,key,value)});return result};_.groupBy=function(obj,value,context){return group(obj,value,context,function(result,key,value){(_.has(result,key)?result[key]:result[key]=[]).push(value)})};_.countBy=function(obj,value,context){return group(obj,value,context,function(result,key){if(!_.has(result,key))result[key]=0;result[key]++})};_.sortedIndex=function(array,obj,iterator,context){iterator=iterator==null?_.identity:lookupIterator(iterator);var value=iterator.call(context,obj);var low=0,high=array.length;while(low<high){var mid=low+high>>>1;iterator.call(context,array[mid])<value?low=mid+1:high=mid}return low};_.toArray=function(obj){if(!obj)return[];if(_.isArray(obj))return slice.call(obj);if(obj.length===+obj.length)return _.map(obj,_.identity);return _.values(obj)};_.size=function(obj){if(obj==null)return 0;return obj.length===+obj.length?obj.length:_.keys(obj).length};_.first=_.head=_.take=function(array,n,guard){if(array==null)return void 0;return n!=null&&!guard?slice.call(array,0,n):array[0]};_.initial=function(array,n,guard){return slice.call(array,0,array.length-(n==null||guard?1:n))};_.last=function(array,n,guard){if(array==null)return void 0;if(n!=null&&!guard){return slice.call(array,Math.max(array.length-n,0))}else{return array[array.length-1]}};_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,n==null||guard?1:n)};_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,output){each(input,function(value){if(_.isArray(value)){shallow?push.apply(output,value):flatten(value,shallow,output)}else{output.push(value)}});return output};_.flatten=function(array,shallow){return flatten(array,shallow,[])};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.uniq=_.unique=function(array,isSorted,iterator,context){if(_.isFunction(isSorted)){context=iterator;iterator=isSorted;isSorted=false}var initial=iterator?_.map(array,iterator,context):array;var results=[];var seen=[];each(initial,function(value,index){if(isSorted?!index||seen[seen.length-1]!==value:!_.contains(seen,value)){seen.push(value);results.push(array[index])}});return results};_.union=function(){return _.uniq(concat.apply(ArrayProto,arguments))};_.intersection=function(array){var rest=slice.call(arguments,1);return _.filter(_.uniq(array),function(item){return _.every(rest,function(other){return _.indexOf(other,item)>=0})})};_.difference=function(array){var rest=concat.apply(ArrayProto,slice.call(arguments,1));return _.filter(array,function(value){return!_.contains(rest,value)})};_.zip=function(){var args=slice.call(arguments);var length=_.max(_.pluck(args,"length"));var results=new Array(length);for(var i=0;i<length;i++){results[i]=_.pluck(args,""+i)}return results};_.object=function(list,values){if(list==null)return{};var result={};for(var i=0,l=list.length;i<l;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result};_.indexOf=function(array,item,isSorted){if(array==null)return-1;var i=0,l=array.length;if(isSorted){if(typeof isSorted=="number"){i=isSorted<0?Math.max(0,l+isSorted):isSorted}else{i=_.sortedIndex(array,item);return array[i]===item?i:-1}}if(nativeIndexOf&&array.indexOf===nativeIndexOf)return array.indexOf(item,isSorted);for(;i<l;i++)if(array[i]===item)return i;return-1};_.lastIndexOf=function(array,item,from){if(array==null)return-1;var hasIndex=from!=null;if(nativeLastIndexOf&&array.lastIndexOf===nativeLastIndexOf){return hasIndex?array.lastIndexOf(item,from):array.lastIndexOf(item)}var i=hasIndex?from:array.length;while(i--)if(array[i]===item)return i;return-1};_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0}step=arguments[2]||1;var len=Math.max(Math.ceil((stop-start)/step),0);var idx=0;var range=new Array(len);while(idx<len){range[idx++]=start;start+=step}return range};_.bind=function(func,context){if(func.bind===nativeBind&&nativeBind)return nativeBind.apply(func,slice.call(arguments,1));var args=slice.call(arguments,2);return function(){return func.apply(context,args.concat(slice.call(arguments)))}};_.partial=function(func){var args=slice.call(arguments,1);return function(){return func.apply(this,args.concat(slice.call(arguments)))}};_.bindAll=function(obj){var funcs=slice.call(arguments,1);if(funcs.length===0)funcs=_.functions(obj);each(funcs,function(f){obj[f]=_.bind(obj[f],obj)});return obj};_.memoize=function(func,hasher){var memo={};hasher||(hasher=_.identity);return function(){var key=hasher.apply(this,arguments);return _.has(memo,key)?memo[key]:memo[key]=func.apply(this,arguments)}};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)};_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)))};_.throttle=function(func,wait){var context,args,timeout,result;var previous=0;var later=function(){previous=new Date;timeout=null;result=func.apply(context,args)};return function(){var now=new Date;var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args)}else if(!timeout){timeout=setTimeout(later,remaining)}return result}};_.debounce=function(func,wait,immediate){var timeout,result;return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate)result=func.apply(context,args)};var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow)result=func.apply(context,args);return result}};_.once=function(func){var ran=false,memo;return function(){if(ran)return memo;ran=true;memo=func.apply(this,arguments);func=null;return memo}};_.wrap=function(func,wrapper){return function(){var args=[func];push.apply(args,arguments);return wrapper.apply(this,args)}};_.compose=function(){var funcs=arguments;return function(){var args=arguments;for(var i=funcs.length-1;i>=0;i--){args=[funcs[i].apply(this,args)]}return args[0]}};_.after=function(times,func){if(times<=0)return func();return function(){if(--times<1){return func.apply(this,arguments)}}};_.keys=nativeKeys||function(obj){if(obj!==Object(obj))throw new TypeError("Invalid object");var keys=[];for(var key in obj)if(_.has(obj,key))keys[keys.length]=key;return keys};_.values=function(obj){var values=[];for(var key in obj)if(_.has(obj,key))values.push(obj[key]);return values};_.pairs=function(obj){var pairs=[];for(var key in obj)if(_.has(obj,key))pairs.push([key,obj[key]]);return pairs};_.invert=function(obj){var result={};for(var key in obj)if(_.has(obj,key))result[obj[key]]=key;return result};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key)}return names.sort()};_.extend=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){obj[prop]=source[prop]}}});return obj};_.pick=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));each(keys,function(key){if(key in obj)copy[key]=obj[key]});return copy};_.omit=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));for(var key in obj){if(!_.contains(keys,key))copy[key]=obj[key]}return copy};_.defaults=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){if(obj[prop]==null)obj[prop]=source[prop]}}});return obj};_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!=toString.call(b))return false;switch(className){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return false;var length=aStack.length;while(length--){if(aStack[length]==a)return bStack[length]==b}aStack.push(a);bStack.push(b);var size=0,result=true;if(className=="[object Array]"){size=a.length;result=size==b.length;if(result){while(size--){if(!(result=eq(a[size],b[size],aStack,bStack)))break}}}else{var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)){return false}for(var key in a){if(_.has(a,key)){size++;if(!(result=_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))break}}if(result){for(key in b){if(_.has(b,key)&&!size--)break}result=!size}}aStack.pop();bStack.pop();return result};_.isEqual=function(a,b){return eq(a,b,[],[])};_.isEmpty=function(obj){if(obj==null)return true;if(_.isArray(obj)||_.isString(obj))return obj.length===0;for(var key in obj)if(_.has(obj,key))return false;return true};_.isElement=function(obj){return!!(obj&&obj.nodeType===1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)=="[object Array]"};_.isObject=function(obj){return obj===Object(obj)};each(["Arguments","Function","String","Number","Date","RegExp"],function(name){_["is"+name]=function(obj){return toString.call(obj)=="[object "+name+"]"}});if(!_.isArguments(arguments)){_.isArguments=function(obj){return!!(obj&&_.has(obj,"callee"))}}if(typeof/./!=="function"){_.isFunction=function(obj){return typeof obj==="function"}}_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))};_.isNaN=function(obj){return _.isNumber(obj)&&obj!=+obj};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)=="[object Boolean]"};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.has=function(obj,key){return hasOwnProperty.call(obj,key)};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.times=function(n,iterator,context){var accum=Array(n);for(var i=0;i<n;i++)accum[i]=iterator.call(context,i);return accum};_.random=function(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))};var entityMap={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};entityMap.unescape=_.invert(entityMap.escape);var entityRegexes={escape:new RegExp("["+_.keys(entityMap.escape).join("")+"]","g"),unescape:new RegExp("("+_.keys(entityMap.unescape).join("|")+")","g")};_.each(["escape","unescape"],function(method){_[method]=function(string){if(string==null)return"";return(""+string).replace(entityRegexes[method],function(match){return entityMap[method][match]})}});_.result=function(object,property){if(object==null)return null;var value=object[property];return _.isFunction(value)?value.call(object):value};_.mixin=function(obj){each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result.call(this,func.apply(_,args))}})};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"};var escaper=/\\|'|\r|\n|\t|\u2028|\u2029/g;_.template=function(text,data,settings){var render;settings=_.defaults({},settings,_.templateSettings);var matcher=new RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,function(match){return"\\"+escapes[match]});if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}if(evaluate){source+="';\n"+evaluate+"\n__p+='"}index=offset+match.length;return match});source+="';\n";if(!settings.variable)source="with(obj||{}){\n"+source+"}\n";source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{render=new Function(settings.variable||"obj","_",source)}catch(e){e.source=source;throw e}if(data)return render(data,_);var template=function(data){return render.call(this,data,_)};template.source="function("+(settings.variable||"obj")+"){\n"+source+"}";return template};_.chain=function(obj){return _(obj).chain()};var result=function(obj){return this._chain?_(obj).chain():obj};_.mixin(_);each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name=="shift"||name=="splice")&&obj.length===0)delete obj[0];return result.call(this,obj)}});each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result.call(this,method.apply(this._wrapped,arguments))}});_.extend(_.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}})}).call(this)},{}],364:[function(require,module,exports){(function(){var Inventory,InventoryCrafting,InventoryDialog,InventoryWindow,ItemPile,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};Inventory=require("inventory");InventoryWindow=require("inventory-window");ItemPile=require("itempile");InventoryDialog=require("voxel-inventory-dialog").InventoryDialog;module.exports=function(game,opts){return new InventoryCrafting(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-recipes","voxel-carry","voxel-registry"]};InventoryCrafting=function(_super){__extends(InventoryCrafting,_super);function InventoryCrafting(game,opts){var craftCont,craftContOuter,outer,resultCont,_ref,_ref1;this.game=game;this.recipes=function(){var _ref1;if((_ref=(_ref1=game.plugins)!=null?_ref1.get("voxel-recipes"):void 0)!=null){return _ref}else{throw new Error('voxel-inventory-crafting requires "voxel-recipes" plugin')}}();this.registry=function(){var _ref2;if((_ref1=(_ref2=game.plugins)!=null?_ref2.get("voxel-registry"):void 0)!=null){return _ref1}else{throw new Error('voxel-inventory-crafting requires "voxel-registry" plugin')}}();this.craftInventory=new Inventory(2,2);this.craftInventory.on("changed",function(_this){return function(){return _this.updateCraftingRecipe()}}(this));this.craftIW=new InventoryWindow({inventory:this.craftInventory,registry:this.registry,linkedInventory:this.playerInventory});this.resultInventory=new Inventory(1);this.resultIW=new InventoryWindow({inventory:this.resultInventory,registry:this.registry,allowDrop:false,linkedInventory:this.playerInventory});this.resultIW.on("pickup",function(_this){return function(){return _this.tookCraftingOutput()}}(this));craftCont=this.craftIW.createContainer();craftContOuter=document.createElement("div");craftContOuter.appendChild(craftCont);resultCont=this.resultIW.createContainer();resultCont.style.display="flex";resultCont.style.flexFlow="column";resultCont.style.justifyContent="center";resultCont.style.marginLeft="30px";outer=document.createElement("div");outer.style.display="flex";outer.style.float="right";outer.style.margin="30px";outer.appendChild(craftContOuter);outer.appendChild(resultCont);InventoryCrafting.__super__.constructor.call(this,game,{upper:[outer]})}InventoryCrafting.prototype.enable=function(){};InventoryCrafting.prototype.disable=function(){};InventoryCrafting.prototype.updateCraftingRecipe=function(){var recipe;recipe=this.recipes.find(this.craftInventory);console.log("found recipe",recipe);return this.resultInventory.set(0,recipe!=null?recipe.computeOutput(this.craftInventory):void 0)};InventoryCrafting.prototype.tookCraftingOutput=function(){var recipe;recipe=this.recipes.find(this.craftInventory);if(recipe==null){return}recipe.craft(this.craftInventory);return this.craftInventory.changed()};return InventoryCrafting}(InventoryDialog)}).call(this)},{inventory:371,"inventory-window":365,itempile:376,"voxel-inventory-dialog":379}],365:[function(require,module,exports){arguments[4][38][0].apply(exports,arguments)},{"cube-icon":366,events:507,ever:367,touchup:370}],366:[function(require,module,exports){module.exports=require(39)},{}],367:[function(require,module,exports){module.exports=require(40)},{"./init.json":368,"./types.json":369,events:507}],368:[function(require,module,exports){module.exports=require(41)},{}],369:[function(require,module,exports){module.exports=require(42)},{}],370:[function(require,module,exports){module.exports=require(43)},{}],371:[function(require,module,exports){arguments[4][32][0].apply(exports,arguments)},{"deep-equal":372,events:507,itempile:373}],372:[function(require,module,exports){module.exports=require(30)},{}],373:[function(require,module,exports){module.exports=require(28)},{clone:374,"deep-equal":375}],374:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],375:[function(require,module,exports){module.exports=require(30)},{}],376:[function(require,module,exports){module.exports=require(28)},{clone:377,"deep-equal":378}],377:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],378:[function(require,module,exports){module.exports=require(30)},{}],379:[function(require,module,exports){arguments[4][52][0].apply(exports,arguments)},{inventory:386,"inventory-window":380,itempile:391,"voxel-modal-dialog":394}],380:[function(require,module,exports){arguments[4][38][0].apply(exports,arguments)},{"cube-icon":381,events:507,ever:382,touchup:385}],381:[function(require,module,exports){module.exports=require(39)},{}],382:[function(require,module,exports){module.exports=require(40)},{"./init.json":383,"./types.json":384,events:507}],383:[function(require,module,exports){module.exports=require(41)},{}],384:[function(require,module,exports){module.exports=require(42)},{}],385:[function(require,module,exports){module.exports=require(43)},{}],386:[function(require,module,exports){arguments[4][32][0].apply(exports,arguments)},{"deep-equal":387,events:507,itempile:388}],387:[function(require,module,exports){module.exports=require(30)},{}],388:[function(require,module,exports){module.exports=require(28)},{clone:389,"deep-equal":390}],389:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],390:[function(require,module,exports){module.exports=require(30)},{}],391:[function(require,module,exports){module.exports=require(28)},{clone:392,"deep-equal":393}],392:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],393:[function(require,module,exports){module.exports=require(30)},{}],394:[function(require,module,exports){arguments[4][67][0].apply(exports,arguments)},{"voxel-modal":395}],395:[function(require,module,exports){arguments[4][68][0].apply(exports,arguments)},{ever:396}],396:[function(require,module,exports){module.exports=require(40)},{"./init.json":397,"./types.json":398,events:507}],397:[function(require,module,exports){module.exports=require(41)},{}],398:[function(require,module,exports){module.exports=require(42)},{}],399:[function(require,module,exports){(function(){var EventEmitter,InventoryHotbarClient,InventoryHotbarCommon,InventoryWindow,ever,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__modulo=function(a,b){return(a%b+ +b)%b};EventEmitter=require("events").EventEmitter;InventoryWindow=require("inventory-window");ever=require("ever");module.exports=function(game,opts){if(game.isClient){return new InventoryHotbarClient(game,opts)}else{return new InventoryHotbarCommon(game,opts)}};module.exports.pluginInfo={loadAfter:["voxel-carry","voxel-registry"]};InventoryHotbarCommon=function(_super){__extends(InventoryHotbarCommon,_super);function InventoryHotbarCommon(game,opts){var _ref;this.game=game;if(opts==null){opts={}}this.inventory=function(){var _ref1,_ref2,_ref3;if((_ref=(_ref1=(_ref2=game.plugins)!=null?(_ref3=_ref2.get("voxel-carry"))!=null?_ref3.inventory:void 0:void 0)!=null?_ref1:opts.inventory)!=null){return _ref}else{throw new Error('voxel-inventory-hotbar requires "voxel-carry" plugin or "inventory" option set to inventory instance')}}();this.selectedIndex=0}InventoryHotbarCommon.prototype.enable=function(){};InventoryHotbarCommon.prototype.disable=function(){};InventoryHotbarCommon.prototype.give=function(itemPile){return this.inventory.give(itemPile)};InventoryHotbarCommon.prototype.take=function(itemPile){return this.inventory.take(itemPile)};InventoryHotbarCommon.prototype.takeHeld=function(count){if(count==null){count=1}return this.inventory.takeAt(this.selectedIndex,count)};InventoryHotbarCommon.prototype.replaceHeld=function(itemPile){return this.inventory.set(this.selectedIndex,itemPile)};InventoryHotbarCommon.prototype.held=function(){return this.inventory.get(this.selectedIndex)};return InventoryHotbarCommon}(EventEmitter);InventoryHotbarClient=function(_super){__extends(InventoryHotbarClient,_super);function InventoryHotbarClient(game,opts){var container,outerDiv,registry,windowOpts,_ref,_ref1,_ref2,_ref3,_ref4,_ref5;this.game=game;InventoryHotbarClient.__super__.constructor.call(this,this.game,opts);this.wheelEnable=(_ref=opts.wheelEnable)!=null?_ref:false;this.wheelScale=(_ref1=opts.wheelScale)!=null?_ref1:1;registry=(_ref2=game.plugins)!=null?_ref2.get("voxel-registry"):void 0;windowOpts=(_ref3=opts.windowOpts)!=null?_ref3:{};if(registry){if(windowOpts.registry==null){windowOpts.registry=registry}}if(windowOpts.inventory==null){windowOpts.inventory=this.inventory}if(windowOpts.inventorySize==null){windowOpts.inventorySize=(_ref4=opts.inventorySize)!=null?_ref4:this.inventory.size()}if(windowOpts.width==null){windowOpts.width=(_ref5=opts.width)!=null?_ref5:windowOpts.inventorySize}this.inventoryWindow=new InventoryWindow(windowOpts);this.inventoryWindow.selectedIndex=0;container=this.inventoryWindow.createContainer();container.style.bottom="0px";container.style.zIndex=5;container.style.width="100%";container.style.position="fixed";container.style.float="";container.style.border="";outerDiv=document.createElement("div");outerDiv.style.width="100%";outerDiv.style.textAlign="center";outerDiv.appendChild(container);document.body.appendChild(outerDiv);this.enable()}InventoryHotbarClient.prototype.enable=function(){this.inventoryWindow.container.style.visibility="";this.onSlots={};if(this.wheelEnable){ever(document.body).on("mousewheel",this.mousewheel=function(_this){return function(ev){var delta;console.log("mousewheel",ev);delta=ev.wheelDelta;delta/=_this.wheelScale;delta=Math.floor(delta);_this.selectedIndex+=delta;_this.selectedIndex=__modulo(_this.selectedIndex,_this.inventoryWindow.width);console.log(_this.selectedIndex);return _this.inventoryWindow.setSelected(_this.selectedIndex)}}(this))}if(this.game.buttons.bindings!=null){[0,1,2,3,4,5,6,7,8,9].forEach(function(_this){return function(slot){var key,slotName;if(slot===9){key="0"}else{key=""+(slot+1)}slotName="slot"+(slot+1);_this.game.buttons.bindings[key]=slotName;return _this.game.buttons.down.on(slotName,_this.onSlots[key]=function(){_this.selectedIndex=slot;return _this.inventoryWindow.setSelected(_this.selectedIndex)})}}(this))}else{this.keydown=function(_this){return function(ev){var slot,_ref;if("0".charCodeAt(0)<=(_ref=ev.keyCode)&&_ref<="9".charCodeAt(0)){slot=ev.keyCode-"0".charCodeAt(0);if(slot===0){slot=10}slot-=1;_this.selectedIndex=slot;return _this.inventoryWindow.setSelected(_this.selectedIndex)}}}(this);ever(document.body).on("keydown",this.keydown)}return InventoryHotbarClient.__super__.enable.call(this)};InventoryHotbarClient.prototype.disable=function(){var key,_i;this.inventoryWindow.container.style.visibility="hidden";if(this.mousewheel!=null){ever(document.body).removeListener("mousewheel",this.mousewheel)}if(this.game.buttons.bindings!=null){for(key=_i=1;_i<=10;key=++_i){delete this.game.buttons.bindings[key-1];this.game.buttons.down.removeListener("slot"+key,this.onSlots[key-1])}}else{ever(document.body).removeListener("keydown",this.keydown)}return InventoryHotbarClient.__super__.disable.call(this)};InventoryHotbarClient.prototype.refresh=function(){return this.inventoryWindow.refresh()};return InventoryHotbarClient}(InventoryHotbarCommon)}).call(this)},{events:507,ever:400,"inventory-window":403}],400:[function(require,module,exports){module.exports=require(40)},{"./init.json":401,"./types.json":402,events:507}],401:[function(require,module,exports){module.exports=require(41)},{}],402:[function(require,module,exports){module.exports=require(42)},{}],403:[function(require,module,exports){arguments[4][38][0].apply(exports,arguments)},{"cube-icon":404,events:507,ever:405,touchup:408}],404:[function(require,module,exports){module.exports=require(39)},{}],405:[function(require,module,exports){module.exports=require(40)},{"./init.json":406,"./types.json":407,events:507}],406:[function(require,module,exports){module.exports=require(41)},{}],407:[function(require,module,exports){module.exports=require(42)},{}],408:[function(require,module,exports){module.exports=require(43)},{}],409:[function(require,module,exports){var process=require("__browserify_process");var webworkify=require("webworkify");var unworkify=require("unworkify");module.exports=function(game,opts){return new Land(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-registry","voxel-recipes","voxel-food"]};function Land(game,opts){this.game=game;if(!game.plugins||!game.plugins.get("voxel-registry"))throw new Error("voxel-land requires voxel-registry");this.registry=game.plugins.get("voxel-registry");opts=opts||{};opts.seed=opts.seed||"foo";opts.materials=opts.materials||undefined;opts.crustLower=opts.crustLower===undefined?0:opts.crustLower;opts.crustUpper=opts.crustUpper===undefined?2:opts.crustUpper;opts.hillScale=opts.hillScale||20;opts.roughnessScale=opts.roughnessScale||200;opts.populateTrees=opts.populateTrees!==undefined?opts.populateTrees:true;opts.treesScale=opts.treesScale||200;opts.treesMaxDensity=opts.treesMaxDensity!==undefined?opts.treesMaxDensity:5;opts.chunkSize=game.chunkSize||32;opts.registerBlocks=opts.registerBlocks===undefined?true:opts.registerBlocks;opts.registerItems=opts.registerItems===undefined?true:opts.registerItems;opts.registerRecipes=opts.registerRecipes===undefined?true:opts.registerRecipes;if(game.arrayType===Uint8Array||game.arrayType===Uint8ClampedArray)opts.arrayElementSize=1;else if(game.arrayType===Uint16Array)opts.arrayElementSize=2;else if(game.arrayType===Uint32Array)opts.arrayElementSize=4;else throw new Error("voxel-land unknown game.arrayType: "+game.arrayType);this.opts=JSON.parse(JSON.stringify(opts));this.enable()}Land.prototype.enable=function(){this.registerBlocks();if(process.browser){this.worker=webworkify(require("./worker.js"))}else{this.worker=unworkify(require("./worker.js"))}this.bindEvents()};Land.prototype.disable=function(){this.unbindEvents()};Land.prototype.registerBlocks=function(){if(this.opts.materials)return;if(this.opts.registerItems){this.registry.registerItem("coal",{itemTexture:"i/coal",fuelBurnTime:1})}if(this.opts.registerBlocks){this.registry.registerBlock("grass",{texture:["grass_top","dirt","grass_side"],hardness:5,itemDrop:"dirt"});this.registry.registerBlock("dirt",{texture:"dirt",hardness:4});this.registry.registerBlock("stone",{texture:"stone",hardness:90,itemDrop:"cobblestone"});this.registry.registerBlock("logOak",{displayName:"Oak Wood",texture:["log_oak_top","log_oak_top","log_oak"],hardness:8});this.registry.registerBlock("cobblestone",{texture:"cobblestone",hardness:80});this.registry.registerBlock("oreCoal",{displayName:"Coal Ore",texture:"coal_ore",itemDrop:"coal"});this.registry.registerBlock("oreIron",{displayName:"Iron Ore",texture:"iron_ore"});this.registry.registerBlock("brick",{texture:"brick"});this.registry.registerBlock("obsidian",{texture:"obsidian",hardness:900});this.registry.registerBlock("leavesOak",{displayName:"Oak Leaves",texture:"leaves_oak",hardness:2,itemDrop:this.registry.getItemProps("apple")?"apple":null});
this.registry.registerBlock("glass",{texture:"glass"});this.registry.registerBlock("logBirch",{texture:["log_birch_top","log_birch_top","log_birch"],hardness:8})}if(this.opts.registerRecipes){var recipes=this.game.plugins.get("voxel-recipes");if(recipes){recipes.thesaurus.registerName("wood.log","logOak");recipes.thesaurus.registerName("wood.log","logBirch");recipes.thesaurus.registerName("tree.leaves","leavesOak")}}this.opts.materials=this.opts.materials||{grass:this.registry.getBlockID("grass"),dirt:this.registry.getBlockID("dirt"),stone:this.registry.getBlockID("stone"),bark:this.registry.getBlockID("logOak"),leaves:this.registry.getBlockID("leavesOak"),oreCoal:this.registry.getBlockID("oreCoal"),oreIron:this.registry.getBlockID("oreIron")}};Land.prototype.bindEvents=function(){var self=this;self.worker.postMessage({cmd:"configure",opts:self.opts});this.game.voxels.on("missingChunk",this.missingChunk=function(pos){self.worker.postMessage({cmd:"generateChunk",pos:pos})});self.worker.addEventListener("message",function(ev){if(ev.data.cmd==="chunkGenerated"){var voxels=new self.game.arrayType(ev.data.voxelBuffer);var chunk={position:ev.data.position,dims:[self.game.chunkSize,self.game.chunkSize,self.game.chunkSize],voxels:voxels};self.game.showChunk(chunk)}else if(ev.data.cmd==="decorate"){var changes=ev.data.changes;for(var i=0;i<changes.length;++i){var pos=changes[i][0];var value=changes[i][1];self.game.setBlock(pos,value)}}})};Land.prototype.unbindEvents=function(){this.game.voxels.removeListener("missingChunk",this.missingChunk)}},{"./worker.js":419,__browserify_process:510,unworkify:415,webworkify:418}],410:[function(require,module,exports){(function(root,factory){if(typeof exports==="object"){module.exports=factory()}else if(typeof define==="function"&&define.amd){define(factory)}else{root.Alea=factory()}})(this,function(){"use strict";Alea.importState=function(i){var random=new Alea;random.importState(i);return random};return Alea;function Alea(){return function(args){var s0=0;var s1=0;var s2=0;var c=1;if(args.length==0){args=[+new Date]}var mash=Mash();s0=mash(" ");s1=mash(" ");s2=mash(" ");for(var i=0;i<args.length;i++){s0-=mash(args[i]);if(s0<0){s0+=1}s1-=mash(args[i]);if(s1<0){s1+=1}s2-=mash(args[i]);if(s2<0){s2+=1}}mash=null;var random=function(){var t=2091639*s0+c*2.3283064365386963e-10;s0=s1;s1=s2;return s2=t-(c=t|0)};random.uint32=function(){return random()*4294967296};random.fract53=function(){return random()+(random()*2097152|0)*1.1102230246251565e-16};random.version="Alea 0.9";random.args=args;random.exportState=function(){return[s0,s1,s2,c]};random.importState=function(i){s0=+i[0]||0;s1=+i[1]||0;s2=+i[2]||0;c=+i[3]||0};return random}(Array.prototype.slice.call(arguments))}function Mash(){var n=4022871197;var mash=function(data){data=data.toString();for(var i=0;i<data.length;i++){n+=data.charCodeAt(i);var h=.02519603282416938*n;n=h>>>0;h-=n;h*=n;n=h>>>0;h-=n;n+=h*4294967296}return(n>>>0)*2.3283064365386963e-10};mash.version="Mash 0.9";return mash}})},{}],411:[function(require,module,exports){module.exports=require(40)},{"./init.json":412,"./types.json":413,events:507}],412:[function(require,module,exports){module.exports=require(41)},{}],413:[function(require,module,exports){module.exports=require(42)},{}],414:[function(require,module,exports){var global=typeof self!=="undefined"?self:typeof window!=="undefined"?window:{};(function(){function SimplexAsm(stdlib,foreign,heap){"use asm";var bytes=new stdlib.Uint8Array(heap);var _perm=256;var _permMod12=768;var floats=new stdlib.Float32Array(heap);var _grad3=320;var _grad4=356;var sqrt=stdlib.Math.sqrt;var floor=stdlib.Math.floor;var imul=stdlib.Math.imul;function noise2D(xin,yin){xin=+xin;yin=+yin;var n0=0,n1=0,n2=0;var F2=0,G2=0,s=0,x0=0,y0=0,x1=0,y1=0,x2=0,y2=0,t=0,t0=0,t1=0,t2=0,X0=0,Y0=0;var i=0,j=0,i1=0,j1=0,ii=0,jj=0,gi0=0,gi1=0,gi2=0;F2=.5*(+sqrt(3)-1);G2=(3-+sqrt(3))/6;s=0;s=(xin+yin)*F2;i=~~+floor(xin+s);j=~~+floor(yin+s);t=+~~(i+j)*G2;X0=+~~i-t;Y0=+~~j-t;x0=xin-X0;y0=yin-Y0;if(x0>y0){i1=1;j1=0}else{i1=0;j1=1}x1=x0-+~~i1+G2;y1=y0-+~~j1+G2;x2=x0-1+2*G2;y2=y0-1+2*G2;ii=i&255|0;jj=j&255|0;t0=.5-x0*x0-y0*y0;if(t0>=0){gi0=bytes[_permMod12+ii+(bytes[_perm+jj|0]|0)|0|0]|0;gi0=gi0+gi0+gi0|0;t0=t0*t0;n0=t0*t0*(+floats[_grad3+gi0<<2>>2]*x0+ +floats[_grad3+gi0+1<<2>>2]*y0)}t1=.5-x1*x1-y1*y1;if(t1>=0){gi1=bytes[_permMod12+ii+i1+(bytes[_perm+jj+j1|0]|0)|0|0]|0;gi1=gi1+gi1+gi1|0;t1=t1*t1;n1=t1*t1*(+floats[_grad3+gi1<<2>>2]*x1+ +floats[_grad3+gi1+1<<2>>2]*y1)}t2=.5-x2*x2-y2*y2;if(t2>=0){gi2=bytes[_permMod12+ii+1+(bytes[_perm+jj+1|0]|0)|0|0]|0;gi2=gi2+gi2+gi2|0;t2=t2*t2;n2=t2*t2*(+floats[_grad3+gi2<<2>>2]*x2+ +floats[_grad3+gi2+1<<2>>2]*y2)}return+(70*(n0+n1+n2))}return{noise2D:noise2D}}function SimplexNoise(random){if(!random)random=Math.random;this.heap=new ArrayBuffer(4096);this.p=new Uint8Array(this.heap,0,256);this.perm=new Uint8Array(this.heap,256,512);this.permMod12=new Uint8Array(this.heap,256+512,512);for(var i=0;i<256;i++){this.p[i]=random()*256}for(i=0;i<512;i++){this.perm[i]=this.p[i&255];this.permMod12[i]=this.perm[i]%12}this.grad3=new Float32Array(this.heap,256+512+512,36);this.grad3.set([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]);this.grad4=new Float32Array(this.heap,256+512+512+36*4,128);this.grad4.set([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]);var stdlib=typeof window!=="undefined"?window:global;this._asmLinked=SimplexAsm(stdlib,stdlib,this.heap);this.noise2D=this._asmLinked.noise2D}SimplexNoise.prototype={noise3D:function(xin,yin,zin){var permMod12=this.permMod12,perm=this.perm,grad3=this.grad3;var n0=0,n1=0,n2=0,n3=0;var F3=0;F3=1/3;var s=(xin+yin+zin)*F3;var i=Math.floor(xin+s);var j=Math.floor(yin+s);var k=Math.floor(zin+s);var G3=0;G3=1/6;var t=(i+j+k)*G3;var X0=i-t;var Y0=j-t;var Z0=k-t;var x0=xin-X0;var y0=yin-Y0;var z0=zin-Z0;var i1,j1,k1;var i2,j2,k2;if(x0>=y0){if(y0>=z0){i1=1;j1=0;k1=0;i2=1;j2=1;k2=0}else if(x0>=z0){i1=1;j1=0;k1=0;i2=1;j2=0;k2=1}else{i1=0;j1=0;k1=1;i2=1;j2=0;k2=1}}else{if(y0<z0){i1=0;j1=0;k1=1;i2=0;j2=1;k2=1}else if(x0<z0){i1=0;j1=1;k1=0;i2=0;j2=1;k2=1}else{i1=0;j1=1;k1=0;i2=1;j2=1;k2=0}}var x1=x0-i1+G3;var y1=y0-j1+G3;var z1=z0-k1+G3;var x2=x0-i2+2*G3;var y2=y0-j2+2*G3;var z2=z0-k2+2*G3;var x3=x0-1+3*G3;var y3=y0-1+3*G3;var z3=z0-1+3*G3;var ii=i&255;var jj=j&255;var kk=k&255;var t0=.6-x0*x0-y0*y0-z0*z0;if(t0<0)n0=0;else{var gi0=permMod12[ii+perm[jj+perm[kk]]]*3;t0=t0*t0;n0=t0*t0*(grad3[gi0]*x0+grad3[gi0+1]*y0+grad3[gi0+2]*z0)}var t1=.6-x1*x1-y1*y1-z1*z1;if(t1<0)n1=0;else{var gi1=permMod12[ii+i1+perm[jj+j1+perm[kk+k1]]]*3;t1=t1*t1;n1=t1*t1*(grad3[gi1]*x1+grad3[gi1+1]*y1+grad3[gi1+2]*z1)}var t2=.6-x2*x2-y2*y2-z2*z2;if(t2<0)n2=0;else{var gi2=permMod12[ii+i2+perm[jj+j2+perm[kk+k2]]]*3;t2=t2*t2;n2=t2*t2*(grad3[gi2]*x2+grad3[gi2+1]*y2+grad3[gi2+2]*z2)}var t3=.6-x3*x3-y3*y3-z3*z3;if(t3<0)n3=0;else{var gi3=permMod12[ii+1+perm[jj+1+perm[kk+1]]]*3;t3=t3*t3;n3=t3*t3*(grad3[gi3]*x3+grad3[gi3+1]*y3+grad3[gi3+2]*z3)}return 32*(n0+n1+n2+n3)},noise4D:function(x,y,z,w){var permMod12=this.permMod12,perm=this.perm,grad4=this.grad4;var n0=0,n1=0,n2=0,n3=0,n4=0;var F4=0;F4=(Math.sqrt(5)-1)/4;var s=(x+y+z+w)*F4;var i=Math.floor(x+s);var j=Math.floor(y+s);var k=Math.floor(z+s);var l=Math.floor(w+s);var G4=0;G4=(5-Math.sqrt(5))/20;var t=(i+j+k+l)*G4;var X0=i-t;var Y0=j-t;var Z0=k-t;var W0=l-t;var x0=x-X0;var y0=y-Y0;var z0=z-Z0;var w0=w-W0;var rankx=0;var ranky=0;var rankz=0;var rankw=0;if(x0>y0)rankx++;else ranky++;if(x0>z0)rankx++;else rankz++;if(x0>w0)rankx++;else rankw++;if(y0>z0)ranky++;else rankz++;if(y0>w0)ranky++;else rankw++;if(z0>w0)rankz++;else rankw++;var i1,j1,k1,l1;var i2,j2,k2,l2;var i3,j3,k3,l3;i1=rankx>=3?1:0;j1=ranky>=3?1:0;k1=rankz>=3?1:0;l1=rankw>=3?1:0;i2=rankx>=2?1:0;j2=ranky>=2?1:0;k2=rankz>=2?1:0;l2=rankw>=2?1:0;i3=rankx>=1?1:0;j3=ranky>=1?1:0;k3=rankz>=1?1:0;l3=rankw>=1?1:0;var x1=x0-i1+G4;var y1=y0-j1+G4;var z1=z0-k1+G4;var w1=w0-l1+G4;var x2=x0-i2+2*G4;var y2=y0-j2+2*G4;var z2=z0-k2+2*G4;var w2=w0-l2+2*G4;var x3=x0-i3+3*G4;var y3=y0-j3+3*G4;var z3=z0-k3+3*G4;var w3=w0-l3+3*G4;var x4=x0-1+4*G4;var y4=y0-1+4*G4;var z4=z0-1+4*G4;var w4=w0-1+4*G4;var ii=i&255;var jj=j&255;var kk=k&255;var ll=l&255;var t0=.6-x0*x0-y0*y0-z0*z0-w0*w0;if(t0<0)n0=0;else{var gi0=perm[ii+perm[jj+perm[kk+perm[ll]]]]%32*4;t0=t0*t0;n0=t0*t0*(grad4[gi0]*x0+grad4[gi0+1]*y0+grad4[gi0+2]*z0+grad4[gi0+3]*w0)}var t1=.6-x1*x1-y1*y1-z1*z1-w1*w1;if(t1<0)n1=0;else{var gi1=perm[ii+i1+perm[jj+j1+perm[kk+k1+perm[ll+l1]]]]%32*4;t1=t1*t1;n1=t1*t1*(grad4[gi1]*x1+grad4[gi1+1]*y1+grad4[gi1+2]*z1+grad4[gi1+3]*w1)}var t2=.6-x2*x2-y2*y2-z2*z2-w2*w2;if(t2<0)n2=0;else{var gi2=perm[ii+i2+perm[jj+j2+perm[kk+k2+perm[ll+l2]]]]%32*4;t2=t2*t2;n2=t2*t2*(grad4[gi2]*x2+grad4[gi2+1]*y2+grad4[gi2+2]*z2+grad4[gi2+3]*w2)}var t3=.6-x3*x3-y3*y3-z3*z3-w3*w3;if(t3<0)n3=0;else{var gi3=perm[ii+i3+perm[jj+j3+perm[kk+k3+perm[ll+l3]]]]%32*4;t3=t3*t3;n3=t3*t3*(grad4[gi3]*x3+grad4[gi3+1]*y3+grad4[gi3+2]*z3+grad4[gi3+3]*w3)}var t4=.6-x4*x4-y4*y4-z4*z4-w4*w4;if(t4<0)n4=0;else{var gi4=perm[ii+1+perm[jj+1+perm[kk+1+perm[ll+1]]]]%32*4;t4=t4*t4;n4=t4*t4*(grad4[gi4]*x4+grad4[gi4+1]*y4+grad4[gi4+2]*z4+grad4[gi4+3]*w4)}return 27*(n0+n1+n2+n3+n4)}};if(typeof define!=="undefined"&&define.amd)define(function(){return SimplexNoise});if(typeof exports!=="undefined")exports.SimplexNoise=SimplexNoise;else if(typeof navigator!=="undefined")this.SimplexNoise=SimplexNoise;if(typeof module!=="undefined"){module.exports=SimplexNoise}})()},{}],415:[function(require,module,exports){var global=typeof self!=="undefined"?self:typeof window!=="undefined"?window:{};var EventEmitter=require("events").EventEmitter;var inherits=require("inherits");module.exports=function(fn){inherits(fn,EventEmitter);fn.prototype.addEventListener=function(ev,cb){this.on(ev,cb)};var self=new fn;global.postMessage=self.postMessage=function(msg){self.emit("message",{data:msg})};return self}},{events:507,inherits:416}],416:[function(require,module,exports){module.exports=require(4)},{}],417:[function(require,module,exports){module.exports=function(opts){if(!opts)opts={};if(opts.bark===undefined)opts.bark=1;if(opts.leaves===undefined)opts.leaves=2;if(opts.random==undefined)opts.random=function(){return Math.random()};if(!opts.height)opts.height=opts.random()*16+4;if(opts.base===undefined)opts.base=opts.height/3;if(opts.radius===undefined)opts.radius=opts.base;if(opts.treeType===undefined)opts.treeType="subspace";if(opts.position===undefined)throw new Error("voxel-trees requires position option");if(opts.setBlock===undefined)throw new Error("voxel-trees requires setBlock option");var set=opts.setBlock;var generators={subspace:function(){var around=[[0,1],[0,-1],[1,1],[1,0],[1,-1],[-1,1],[-1,0],[-1,-1]];for(var y=0;y<opts.height-1;y++){var pos={x:opts.position.x,y:opts.position.y,z:opts.position.z};pos.y+=y;if(set(pos,opts.bark))break;if(y<opts.base)continue;around.forEach(function(offset){if(opts.random()>.5)return;var x=offset[0];var z=offset[1];pos.x+=x;pos.z+=z;set(pos,opts.leaves);pos.x-=x;pos.z-=z})}},guybrush:function(){var sphere=function(x,y,z,r){return x*x+y*y+z*z<=r*r};for(var y=0;y<opts.height-1;y++){var pos={x:opts.position.x,y:opts.position.y,z:opts.position.z};pos.y+=y;if(set(pos,opts.bark))break}var radius=opts.radius;for(var xstep=-radius;xstep<=radius;xstep++){for(var ystep=-radius;ystep<=radius;ystep++){for(var zstep=-radius;zstep<=radius;zstep++){if(sphere(xstep,ystep,zstep,radius)){var leafpos={x:pos.x+xstep,y:pos.y+ystep,z:pos.z+zstep};set(leafpos,opts.leaves)}}}}},fractal:function(){function drawAxiom(axiom,angle,unitsize,units){var posstack=[];var penangle=0;var pos={x:opts.position.x,y:opts.position.y,z:opts.position.z};pos.y+=unitsize*30;function moveForward(){var ryaw=penangle*Math.PI/180;for(var i=0;i<units;i++){pos.y+=unitsize*Math.cos(ryaw);pos.z+=unitsize*Math.sin(ryaw);set(pos,opts.leaves)}}function setPoint(){set(pos,opts.bark)}function setMaterial(value){mindex=value}function yaw(angle){penangle+=angle}function pitch(angle){}function roll(angle){}function PushState(){posstack.push(pos)}function PopState(){pos=posstack.pop()}for(var i=0;i<axiom.length;i++){var c=axiom.charAt(i);switch(c){case"F":moveForward();setPoint();break;case"+":yaw(+angle);break;case"-":yaw(-angle);break;case"&":pitch(+angle);break;case"^":pitch(-angle);break;case"/":roll(+angle);break;case"*":roll(-angle);break;case"G":moveForward();break;case"[":PushState();break;case"]":PopState();break;case"0":setMaterial(0);break;case"1":setMaterial(1);break;case"2":setMaterial(2);break;case"3":setMaterial(3);break}}}var axiom="FX";var rules=[["X","X+YF+"],["Y","-FX-Y"]];axiom=applyRules(axiom,rules);axiom=applyRules(axiom,rules);axiom=applyRules(axiom,rules);axiom=applyRules(axiom,rules);axiom=applyRules(axiom,rules);axiom=applyRules(axiom,rules);drawAxiom(axiom,90,1,5)}};if(!generators[opts.treeType])throw new Error("voxel-trees invalid treeType: "+opts.treeType);generators[opts.treeType]()};function regexRules(rules){var regexrule="";rules.forEach(function(rule){if(regexrule!=""){regexrule=regexrule+"|"}regexrule=regexrule+rule[0]});return new RegExp(regexrule,"g")}function applyRules(axiom,rules){function matchRule(match){for(var i=0;i<rules.length;i++){if(rules[i][0]==match)return rules[i][1]}return""}return axiom.replace(regexRules(rules),matchRule)}},{}],418:[function(require,module,exports){module.exports=require(84)},{}],419:[function(require,module,exports){var ever=require("ever");var createTree=require("voxel-trees");var SimplexNoise=require("simplex-noise");var Alea=require("alea");function ChunkGenerator(worker,opts){this.worker=worker;this.opts=opts;var random=this.random=new Alea(this.opts.seed);var randomHills=new Alea(random());var randomRoughness=new Alea(random());var randomTrees=new Alea(random());this.noiseHills=new SimplexNoise(function(){return randomHills()});this.noiseRoughness=new SimplexNoise(function(){return randomRoughness()});this.noiseTrees=new SimplexNoise(function(){return randomTrees()});this.populators=[];this.registerPopulator(this.populateCoalOre.bind(this));this.registerPopulator(this.populateIronOre.bind(this));return this}ChunkGenerator.prototype.generateHeightMap=function(position,width){var startX=position[0]*width;var startY=position[1]*width;var startZ=position[2]*width;var heightMap=new Uint8Array(width*width);for(var x=startX;x<startX+width;x++){for(var z=startZ;z<startZ+width;z++){var roughness=this.noiseRoughness.noise2D(x/this.opts.roughnessScale,z/this.opts.roughnessScale);roughnessTerm=Math.floor(Math.pow(scale(roughness,-1,1,0,2),5));var n=this.noiseHills.noise2D(x/this.opts.hillScale,z/this.opts.hillScale);var y=~~scale(n,-1,1,this.opts.crustLower,this.opts.crustUpper+roughnessTerm);if(roughnessTerm<1)y=this.opts.crustLower;if(y===this.crustLower||startY<y&&y<startY+width){var xidx=Math.abs((width+x%width)%width);var yidx=Math.abs((width+y%width)%width);var zidx=Math.abs((width+z%width)%width);var idx=xidx+yidx*width+zidx*width*width;heightMap[xidx+zidx*width]=yidx}}}return heightMap};function scale(x,fromLow,fromHigh,toLow,toHigh){return(x-fromLow)*(toHigh-toLow)/(fromHigh-fromLow)+toLow}ChunkGenerator.prototype.registerPopulator=function(f){this.populators.push(f)};ChunkGenerator.prototype.populateChunk=function(random,chunkX,chunkY,chunkZ,chunkHeightMap,voxels){console.log("populating chunk "+[chunkX,chunkY,chunkZ,voxels].join(" "));for(var i=0;i<this.populators.length;i+=1){var populate=this.populators[i];populate(random,chunkX,chunkY,chunkZ,chunkHeightMap,voxels)}};ChunkGenerator.prototype.populateOreClusters=function(random,chunkX,chunkY,chunkZ,chunkHeightMap,voxels,clustersPerChunk,clusterSize,replaceMaterial,oreMaterial){var width=this.opts.chunkSize;var nextInt=function(max){return Math.round(random()*max)};var getBlock=function(x,y,z){return voxels[x+y*width+z*width*width]};var setBlock=function(x,y,z,value){voxels[x+y*width+z*width*width]=value};var clustersPerChunk=30;var clusterSize=nextInt(100)+50;for(var i=0;i<clustersPerChunk;i+=1){var x=nextInt(width-1);var y=nextInt(width-1);var z=nextInt(width-1);for(var j=0;j<clusterSize;j+=1){if(getBlock(x,y,z)===replaceMaterial){setBlock(x,y,z,oreMaterial)}x+=nextInt(2)-1;y+=nextInt(2)-1;x%=width-1;y%=width-1}}};ChunkGenerator.prototype.populateCoalOre=function(random,chunkX,chunkY,chunkZ,chunkHeightMap,voxels){var nextInt=function(max){return Math.round(random()*max)};var clustersPerChunk=30;var clusterSize=nextInt(100)+50;var replaceMaterial=this.opts.materials.stone;this.populateOreClusters(random,chunkX,chunkY,chunkZ,chunkHeightMap,voxels,clustersPerChunk,clusterSize,replaceMaterial,this.opts.materials.oreCoal)};ChunkGenerator.prototype.populateIronOre=function(random,chunkX,chunkY,chunkZ,chunkHeightMap,voxels){var nextInt=function(max){return Math.round(random()*max)};var clustersPerChunk=20;var clusterSize=nextInt(30)+10;var replaceMaterial=this.opts.materials.stone;this.populateOreClusters(random,chunkX,chunkY,chunkZ,chunkHeightMap,voxels,clustersPerChunk,clusterSize,replaceMaterial,this.opts.materials.oreIron)};ChunkGenerator.prototype.decorate=function(random,chunkX,chunkY,chunkZ,chunkHeightMap){var changes=[];var width=this.opts.chunkSize;var startX=chunkX*width;var startY=chunkY*width;var startZ=chunkZ*width;if(random()<.3){var radius=~~(random()*10);for(var dx=-radius;dx<=radius;++dx){for(var dy=-radius;dy<=radius;++dy){for(var dz=-radius;dz<=radius;++dz){var distance=Math.sqrt(dx*dx+dy*dy+dz*dz);if(distance<radius)changes.push([[startX+dx,startY+dy,startZ+dz],0])}}}return changes}if(!this.opts.populateTrees)return;var treeCount=~~scale(this.noiseTrees.noise2D(chunkX/this.opts.treesScale,chunkZ/this.opts.treesScale),-1,1,0,this.opts.treesMaxDensity);for(var i=0;i<treeCount;++i){var dx=~~scale(random(),0,1,0,width-1);var dz=~~scale(random(),0,1,0,width-1);var dy=chunkHeightMap[dx+dz*width]+1;var n=random();var treeType;if(n<.05)treeType="guybrush";else treeType="subspace";createTree({random:random,bark:this.opts.materials.bark,leaves:this.opts.materials.leaves,position:{x:startX+dx,y:startY+dy,z:startZ+dz},treeType:treeType,setBlock:function(pos,value){changes.push([[pos.x,pos.y,pos.z],value]);return false}})}return changes};ChunkGenerator.prototype.generateChunk=function(pos){var width=this.opts.chunkSize;var arrayType={1:Uint8Array,2:Uint16Array,4:Uint32Array}[this.opts.arrayElementSize];var buffer=new ArrayBuffer(width*width*width*this.opts.arrayElementSize);var voxels=new arrayType(buffer);var changes=undefined;if(pos[1]===0){var heightMap=this.generateHeightMap(pos,width);for(var x=0;x<width;++x){for(var z=0;z<width;++z){var y=heightMap[x+z*width];voxels[x+y*width+z*width*width]=this.opts.materials.grass;while(y-->0)voxels[x+y*width+z*width*width]=this.opts.materials.dirt}}var random=new Alea(pos[0]+pos[1]*width+pos[2]*width*width);this.populateChunk(random,pos[0],pos[1],pos[2],heightMap,voxels);changes=this.decorate(random,pos[0],pos[1],pos[2],heightMap)}else if(pos[1]>0){}else{for(var i=0;i<width*width*width;++i){voxels[i]=this.opts.materials.stone}var random=new Alea(pos[0]+pos[1]*width+pos[2]*width*width);this.populateChunk(random,pos[0],pos[1],pos[2],null,voxels)}this.worker.postMessage({cmd:"chunkGenerated",position:pos,voxelBuffer:buffer},[buffer]);if(changes)this.worker.postMessage({cmd:"decorate",changes:changes})};module.exports=function(){var gen;ever(this).on("message",function(ev){if(ev.data.cmd==="configure"){gen=new ChunkGenerator(this,ev.data.opts)}else if(ev.data.cmd==="generateChunk"){if(gen===undefined)throw new Error('voxel-land web worker error: received "generateChunk" before "configure"');gen.generateChunk(ev.data.pos)}})}},{alea:410,ever:411,"simplex-noise":414,"voxel-trees":417}],420:[function(require,module,exports){(function(){var EventEmitter,Mine,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};EventEmitter=require("events").EventEmitter;module.exports=function(game,opts){return new Mine(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-reach","voxel-registry","voxel-inventory-hotbar"]};Mine=function(_super){__extends(Mine,_super);function Mine(game,opts){var _ref,_ref1,_ref2,_ref3;this.game=game;this.registry=(_ref=game.plugins)!=null?_ref.get("voxel-registry"):void 0;this.hotbar=(_ref1=game.plugins)!=null?_ref1.get("voxel-inventory-hotbar"):void 0;this.reach=function(){var _ref3;if((_ref2=(_ref3=game.plugins)!=null?_ref3.get("voxel-reach"):void 0)!=null){return _ref2}else{throw new Error('voxel-mine requires "voxel-reach" plugin')}}();opts=opts!=null?opts:{};if(opts.instaMine==null){opts.instaMine=false}if(opts.timeToMine==null){opts.timeToMine=void 0}if(opts.progressTexturesPrefix==null){opts.progressTexturesPrefix=void 0}if(opts.progressTexturesCount==null){opts.progressTexturesCount=10}if(opts.applyTextureParams==null){opts.applyTextureParams=function(_this){return function(texture){texture.magFilter=_this.game.THREE.NearestFilter;texture.minFilter=_this.game.THREE.LinearMipMapLinearFilter;texture.wrapT=_this.game.THREE.RepeatWrapping;return texture.wrapS=_this.game.THREE.RepeatWrapping}}(this)}this.defaultTextureURL=(_ref3=opts.defaultTextureURL)!=null?_ref3:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4y62TMQoAMAgD8/9PX7cuhYLmnAQTQZMkCdkXT7Mhb5YwHkwwNOQfkOZJNDI1MncLsO5XFFA8oLhQyYGSxMs9lwAf4Z8BoD8AAAAASUVORK5CYII=";this.opts=opts;this.instaMine=opts.instaMine;this.progress=0;if(this.game.isClient){this.texturesEnabled=this.opts.progressTexturesPrefix!=null;this.overlay=null;this.setupTextures()}this.enable()}return Mine}(EventEmitter);Mine.prototype.timeToMine=function(target){var blockID,blockName,finalTimeToMine,hardness,heldItem,speed,_ref,_ref1,_ref2;if(this.opts.timeToMine!=null){return this.opts.timeToMine(target)}if(!this.registry){return 9}blockID=game.getBlock(target.voxel);blockName=this.registry.getBlockName(blockID);hardness=(_ref=this.registry.getBlockProps(blockName))!=null?_ref.hardness:void 0;if(hardness==null){hardness=9}if(!this.hotbar){return hardness}heldItem=this.hotbar.held();speed=1;speed=(_ref1=(_ref2=this.registry.getItemProps(heldItem!=null?heldItem.item:void 0))!=null?_ref2.speed:void 0)!=null?_ref1:1;finalTimeToMine=Math.max(hardness/speed,0);return finalTimeToMine};Mine.prototype.enable=function(){this.reach.on("mining",this.onMining=function(_this){return function(target){var hardness;if(!target){console.log("no block mined");return}_this.progress+=1;hardness=_this.timeToMine(target);if(_this.instaMine||_this.progress>hardness){_this.progress=0;_this.reach.emit("stop mining",target);_this.emit("break",target)}return _this.updateForStage(_this.progress,hardness)}}(this));this.reach.on("start mining",this.onStartMining=function(_this){return function(target){if(!target){return}return _this.createOverlay(target)}}(this));return this.reach.on("stop mining",this.onStopMining=function(_this){return function(target){if(!target){return}_this.destroyOverlay();return _this.progress=0}}(this))};Mine.prototype.disable=function(){this.reach.removeListener("mining",this.onMining);this.reach.removeListener("start mining",this.onStartMining);return this.reach.removeListener("stop mining",this.onStopMining)};Mine.prototype.setupTextures=function(){if(!this.texturesEnabled){return}this.progressTextures=[];return this.registry.onTexturesReady(function(_this){return function(){var i,path,_i,_ref,_results;_results=[];for(i=_i=0,_ref=_this.opts.progressTexturesCount;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i){path=_this.registry.getTextureURL(_this.opts.progressTexturesPrefix+i);if(path==null){if(_this.defaultTextureURL.indexOf("data:")===0){delete _this.game.THREE.ImageUtils.crossOrigin}path=_this.defaultTextureURL}_results.push(_this.progressTextures.push(_this.game.THREE.ImageUtils.loadTexture(path)))}return _results}}(this))};Mine.prototype.createOverlay=function(target){var geometry,material,mesh,offset;if(this.instaMine||!this.texturesEnabled){return}this.destroyOverlay();geometry=new this.game.THREE.Geometry;if(target.normal[2]===1){geometry.vertices.push(new this.game.THREE.Vector3(0,0,0));geometry.vertices.push(new this.game.THREE.Vector3(1,0,0));geometry.vertices.push(new this.game.THREE.Vector3(1,1,0));geometry.vertices.push(new this.game.THREE.Vector3(0,1,0));offset=[0,0,1]}else if(target.normal[1]===1){geometry.vertices.push(new this.game.THREE.Vector3(0,0,0));geometry.vertices.push(new this.game.THREE.Vector3(0,0,1));geometry.vertices.push(new this.game.THREE.Vector3(1,0,1));geometry.vertices.push(new this.game.THREE.Vector3(1,0,0));offset=[0,1,0]}else if(target.normal[0]===1){geometry.vertices.push(new this.game.THREE.Vector3(0,0,0));geometry.vertices.push(new this.game.THREE.Vector3(0,1,0));geometry.vertices.push(new this.game.THREE.Vector3(0,1,1));geometry.vertices.push(new this.game.THREE.Vector3(0,0,1));offset=[1,0,0]}else if(target.normal[0]===-1){geometry.vertices.push(new this.game.THREE.Vector3(0,0,0));geometry.vertices.push(new this.game.THREE.Vector3(0,0,1));geometry.vertices.push(new this.game.THREE.Vector3(0,1,1));geometry.vertices.push(new this.game.THREE.Vector3(0,1,0));offset=[0,0,0]}else if(target.normal[1]===-1){geometry.vertices.push(new this.game.THREE.Vector3(0,0,0));geometry.vertices.push(new this.game.THREE.Vector3(1,0,0));geometry.vertices.push(new this.game.THREE.Vector3(1,0,1));geometry.vertices.push(new this.game.THREE.Vector3(0,0,1));offset=[0,0,0]}else if(target.normal[2]===-1){geometry.vertices.push(new this.game.THREE.Vector3(0,0,0));geometry.vertices.push(new this.game.THREE.Vector3(0,1,0));geometry.vertices.push(new this.game.THREE.Vector3(1,1,0));geometry.vertices.push(new this.game.THREE.Vector3(1,0,0));offset=[0,0,0]}else{console.log("unknown face",target.normal);return}geometry.faces.push(new this.game.THREE.Face3(0,1,2));geometry.faces.push(new this.game.THREE.Face3(0,2,3));geometry.computeCentroids();geometry.computeFaceNormals();geometry.computeVertexNormals();geometry.faceVertexUvs=[[[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:1}],[{x:0,y:0},{x:1,y:1},{x:0,y:1},{x:0,y:1}]]];material=new this.game.THREE.MeshLambertMaterial;material.map=this.progressTextures[0];this.opts.applyTextureParams(material.map);material.side=this.game.THREE.FrontSide;material.transparent=true;material.polygonOffset=true;material.polygonOffsetFactor=-1;material.polygonOffsetUnits=-1;mesh=new this.game.THREE.Mesh(geometry,material);this.overlay=new this.game.THREE.Object3D;this.overlay.add(mesh);this.overlay.position.set(target.voxel[0]+offset[0],target.voxel[1]+offset[1],target.voxel[2]+offset[2]);this.game.scene.add(this.overlay);return this.overlay};Mine.prototype.updateForStage=function(progress,hardness){var index,texture;if(!this.texturesEnabled){return}index=Math.floor(progress/hardness*(this.progressTextures.length-1));texture=this.progressTextures[index];return this.setOverlayTexture(texture)};Mine.prototype.setOverlayTexture=function(texture){if(!this.overlay||!this.texturesEnabled){return}this.opts.applyTextureParams(texture);this.overlay.children[0].material.map=texture;return this.overlay.children[0].material.needsUpdate=true};Mine.prototype.destroyOverlay=function(){if(!this.overlay||!this.texturesEnabled){return}this.game.scene.remove(this.overlay);return this.overlay=null}}).call(this)},{events:507}],421:[function(require,module,exports){module.exports=function(game,opts){return new Oculus(game,opts)};function Oculus(game,opts){var THREE=game.THREE;var renderer=game.view.renderer;this.separation=10;this.distortion=.1;this.aspectFactor=1;if(opts){if(opts.separation!==undefined)this.separation=opts.separation;if(opts.distortion!==undefined)this.distortion=opts.distortion;if(opts.aspectFactor!==undefined)this.aspectFactor=opts.aspectFactor}var _width,_height;var _pCamera=new THREE.PerspectiveCamera;_pCamera.matrixAutoUpdate=false;_pCamera.target=new THREE.Vector3;var _scene=new THREE.Scene;var _oCamera=new THREE.OrthographicCamera(-1,1,1,-1,1,1e3);_oCamera.position.z=1;_scene.add(_oCamera);renderer.autoClear=false;var _params={minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat};var _renderTarget=new THREE.WebGLRenderTarget(800,600,_params);var _material=new THREE.ShaderMaterial({uniforms:{tex:{type:"t",value:_renderTarget},c:{type:"f",value:this.distortion}},vertexShader:["varying vec2 vUv;","void main() {"," vUv = uv;","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float c;","uniform sampler2D tex;","varying vec2 vUv;","void main()","{","	vec2 uv = vUv;","	vec2 vector = uv * 2.0 - 1.0;","   float factor = 1.0/(1.0+c);","   float vectorLen = length(vector);","   vec2 direction = vector / vectorLen;","   float newLen = vectorLen + c * pow(vectorLen,3.0);","   vec2 newVector = direction * newLen * factor;","	newVector = (newVector + 1.0) / 2.0;","	if (newVector.x < 0.0 || newVector.x > 1.0 || newVector.y < 0.0 || newVector.y > 1.0)","		gl_FragColor = vec4(0.0,0.0,0.0,1.0);","	else","   	gl_FragColor = texture2D(tex, newVector);","}"].join("\n")});var mesh=new THREE.Mesh(new THREE.PlaneGeometry(2,2),_material);_scene.add(mesh);this.setSize=function(width,height){_width=width/2;_height=height;_renderTarget=new THREE.WebGLRenderTarget(width,height,_params);_material.uniforms["tex"].value=_renderTarget;renderer.setSize(width,height)};this.render=function(scene,camera){renderer.clear();_material.uniforms["c"].value=this.distortion;if(camera.matrixAutoUpdate)camera.updateMatrix();_pCamera.fov=camera.fov;_pCamera.aspect=camera.aspect/(2*this.aspectFactor);_pCamera.near=camera.near;_pCamera.far=camera.far;_pCamera.updateProjectionMatrix();_pCamera.matrix.copy(camera.matrixWorld);_pCamera.applyMatrix((new THREE.Matrix4).makeTranslation(-this.separation,0,0));_pCamera.matrixWorldNeedsUpdate=true;renderer.setViewport(0,0,_width,_height);renderer.render(scene,_pCamera,_renderTarget,true);renderer.render(_scene,_oCamera);_pCamera.matrix.copy(camera.matrixWorld);_pCamera.applyMatrix((new THREE.Matrix4).makeTranslation(this.separation,0,0));_pCamera.matrixWorldNeedsUpdate=true;renderer.setViewport(_width,0,_width,_height);renderer.render(scene,_pCamera,_renderTarget,true);renderer.render(_scene,_oCamera)};this.enable=function(){this.originalRenderer=game.view.renderer;this.setSize(game.width,game.height);game.view.renderer=this;this.hideLogo(true)};this.disable=function(){this.setSize(_width*2,_height);game.view.renderer=this.originalRenderer;this.hideLogo(false)};this.hideLogo=function(hide){if(document&&document.getElementById("logo"))document.getElementById("logo").style.visibility=hide?"hidden":""};this.enable()}},{}],422:[function(require,module,exports){(function(){var AmorphousRecipe,CraftingThesaurus,ItemPile,PositionalRecipe,Recipe,RecipeLocator,RepairRecipe,ToolsPlugin,_ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};ItemPile=require("itempile");_ref=require("craftingrecipes"),Recipe=_ref.Recipe,AmorphousRecipe=_ref.AmorphousRecipe,PositionalRecipe=_ref.PositionalRecipe,CraftingThesaurus=_ref.CraftingThesaurus,RecipeLocator=_ref.RecipeLocator;module.exports=function(game,opts){return new ToolsPlugin(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-recipes","voxel-registry"]};ToolsPlugin=function(){function ToolsPlugin(game,opts){var _ref1;
this.game=game;this.registry=function(){var _ref2;if((_ref1=(_ref2=game.plugins)!=null?_ref2.get("voxel-registry"):void 0)!=null){return _ref1}else{throw new Error('voxel-pickaxe requires "voxel-registry" plugin')}}();this.enable()}ToolsPlugin.prototype.enable=function(){var recipes,_ref1;this.registry.registerBlock("plankOak",{displayName:"Oak Planks",texture:"planks_oak"});this.registry.registerItem("stick",{itemTexture:"items/stick"});this.registry.registerItem("pickaxeWood",{displayName:"Wooden Pickaxe",itemTexture:"items/wood_pickaxe",speed:2,maxDamage:10});this.registry.registerItem("pickaxeStone",{displayName:"Stone Pickaxe",itemTexture:"items/stone_pickaxe",speed:10,maxDamage:100});this.registry.registerItem("pickaxeIron",{displayName:"Iron Pickaxe",itemTexture:"items/iron_pickaxe",speed:15,maxDamage:500});this.registry.registerItem("spadeWood",{displayName:"Wooden Spade",itemTexture:"items/wood_shovel",speed:2,maxDamage:5});this.registry.registerItem("spadeStone",{displayName:"Stone Spade",itemTexture:"items/stone_shovel",speed:3,maxDamage:50});this.registry.registerItem("spadeIron",{displayName:"Iron Spade",itemTexture:"items/iron_shovel",speed:4,maxDamage:500});recipes=(_ref1=this.game.plugins)!=null?_ref1.get("voxel-recipes"):void 0;if(recipes!=null){recipes.thesaurus.registerName("wood.plank","plankOak");recipes.register(new AmorphousRecipe(["wood.log"],new ItemPile("plankOak",2)));recipes.register(new AmorphousRecipe(["wood.plank","wood.plank"],new ItemPile("stick",4)));recipes.register(this.pickaxeRecipe("wood.plank","pickaxeWood"));recipes.register(this.pickaxeRecipe("cobblestone","pickaxeStone"));recipes.register(this.pickaxeRecipe("ingotIron","pickaxeIron"));recipes.register(new RepairRecipe("pickaxeWood","plankOak",4));recipes.register(new RepairRecipe("pickaxeStone","cobblestone",20));recipes.register(new RepairRecipe("pickaxeIron","ingotIron",200));recipes.register(this.spadeRecipe("wood.plank","spadeWood"));recipes.register(this.spadeRecipe("cobblestone","spadeStone"));return recipes.register(this.spadeRecipe("ingotIron","spadeIron"))}};ToolsPlugin.prototype.pickaxeRecipe=function(headMaterial,toolMaterial,handleMaterial){if(handleMaterial==null){handleMaterial="stick"}return new PositionalRecipe([[headMaterial,headMaterial,headMaterial],[void 0,handleMaterial,void 0],[void 0,handleMaterial,void 0]],new ItemPile(toolMaterial,1,{damage:0}))};ToolsPlugin.prototype.spadeRecipe=function(headMaterial,toolMaterial,handleMaterial){if(handleMaterial==null){handleMaterial="stick"}return new PositionalRecipe([[void 0,headMaterial,void 0],[void 0,handleMaterial,void 0],[void 0,handleMaterial,void 0]],new ItemPile(toolMaterial,1,{damage:0}))};ToolsPlugin.prototype.disable=function(){};return ToolsPlugin}();RepairRecipe=function(_super){__extends(RepairRecipe,_super);function RepairRecipe(toolItem,repairingItem,repairAmount){this.toolItem=toolItem;this.repairingItem=repairingItem;this.repairAmount=repairAmount}RepairRecipe.prototype.findMatchingSlots=function(inventory){var foundIndices,_ref1,_ref2;foundIndices={};if(((_ref1=inventory.get(0))!=null?_ref1.item:void 0)===this.toolItem){foundIndices.tool=0}else{return void 0}if(((_ref2=inventory.get(1))!=null?_ref2.item:void 0)===this.repairingItem){foundIndices.repairing=1}else{return void 0}return foundIndices};RepairRecipe.prototype.computeOutput=function(inventory){var newDamage,oldDamage,repairedTool,slots,tool,_ref1;slots=this.findMatchingSlots(inventory);if(slots==null){return void 0}tool=inventory.get(slots.tool);repairedTool=tool.clone();oldDamage=(_ref1=repairedTool.tags.damage)!=null?_ref1:0;newDamage=oldDamage-this.repairAmount;if(newDamage<0){newDamage=0}repairedTool.tags.damage=newDamage;return repairedTool};RepairRecipe.prototype.craft=function(inventory){var slots;slots=this.findMatchingSlots(inventory);if(slots==null){return void 0}inventory.takeAt(slots.tool,1);inventory.takeAt(slots.repairing,1);return this.computeOutput(inventory)};return RepairRecipe}(Recipe)}).call(this)},{craftingrecipes:423,itempile:424}],423:[function(require,module,exports){(function(){var AmorphousRecipe,CraftingThesaurus,PositionalRecipe,Recipe,RecipeList,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};CraftingThesaurus=function(){CraftingThesaurus.instance=void 0;function CraftingThesaurus(){this.map={};CraftingThesaurus.instance=this}CraftingThesaurus.prototype.registerName=function(lookupName,item){if(lookupName.indexOf(".")===-1){throw"craftingrecipes registerName("+lookupName+"): name is in invalid format, should be 'shape.material'"}if(this.map[lookupName]==null){this.map[lookupName]=[]}return this.map[lookupName].push(item)};CraftingThesaurus.prototype.matchesName=function(lookupName,itemPile){var a;if(lookupName===void 0&&itemPile===void 0){return true}if(itemPile==null){return false}if(itemPile.item===lookupName){return true}a=this.map[lookupName];if(a==null){return false}return a.indexOf(itemPile.item)!==-1};return CraftingThesaurus}();Recipe=function(){function Recipe(){}Recipe.prototype.computeOutput=function(inventory){return void 0};Recipe.prototype.matches=function(inventory){return this.computeOutput(inventory)!==void 0};Recipe.prototype.craft=function(inventory){return void 0};return Recipe}();AmorphousRecipe=function(_super){__extends(AmorphousRecipe,_super);function AmorphousRecipe(ingredients,output){this.ingredients=ingredients;this.output=output}AmorphousRecipe.prototype.removeIngredient=function(itemPile,pendingIngredients){var i,testIngredient,_i,_len;for(i=_i=0,_len=pendingIngredients.length;_i<_len;i=++_i){testIngredient=pendingIngredients[i];if(CraftingThesaurus.instance.matchesName(testIngredient,itemPile)){pendingIngredients.splice(i,1);return true}}return false};AmorphousRecipe.prototype.findMatchingSlots=function(inventory){var foundIndices,i,itemPile,pendingIngredients,_i,_ref;pendingIngredients=this.ingredients.slice(0);foundIndices=[];for(i=_i=0,_ref=inventory.size();0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){itemPile=inventory.get(i);if(itemPile==null){continue}if(!this.removeIngredient(itemPile,pendingIngredients)){return void 0}foundIndices.push(i)}if(pendingIngredients.length!==0){return void 0}return foundIndices};AmorphousRecipe.prototype.computeOutput=function(inventory){if(this.findMatchingSlots(inventory)!==void 0){return this.output.clone()}return void 0};AmorphousRecipe.prototype.craft=function(inventory){var slot,slots,_i,_len;slots=this.findMatchingSlots(inventory);if(!slots){return void 0}for(_i=0,_len=slots.length;_i<_len;_i++){slot=slots[_i];inventory.takeAt(slot,1)}return this.output.clone()};return AmorphousRecipe}(Recipe);PositionalRecipe=function(_super){__extends(PositionalRecipe,_super);function PositionalRecipe(ingredientMatrix,output){this.ingredientMatrix=ingredientMatrix;this.output=output}PositionalRecipe.prototype.findMatchingSlots=function(inventory){var actualPile,expectedName,foundIndices,i,index,j,row,_i,_j,_len,_len1,_ref;foundIndices=[];_ref=this.ingredientMatrix;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){row=_ref[i];for(j=_j=0,_len1=row.length;_j<_len1;j=++_j){expectedName=row[j];index=j+i*inventory.width;actualPile=inventory.get(index);if(!CraftingThesaurus.instance.matchesName(expectedName,actualPile)){return void 0}foundIndices.push(index)}}return foundIndices};PositionalRecipe.prototype.computeOutput=function(inventory){if(this.findMatchingSlots(inventory)!==void 0){return this.output.clone()}return void 0};PositionalRecipe.prototype.craft=function(inventory){var slot,slots,_i,_len;slots=this.findMatchingSlots(inventory);if(!slots){return void 0}for(_i=0,_len=slots.length;_i<_len;_i++){slot=slots[_i];inventory.takeAt(slot,1)}return this.output.clone()};return PositionalRecipe}(Recipe);RecipeList=function(){function RecipeList(){this.recipes=[]}RecipeList.prototype.register=function(recipe){return this.recipes.push(recipe)};RecipeList.prototype.find=function(inventory){var recipe,_i,_len,_ref;_ref=this.recipes;for(_i=0,_len=_ref.length;_i<_len;_i++){recipe=_ref[_i];if(recipe.computeOutput(inventory)!==void 0){return recipe}}return void 0};RecipeList.prototype.craft=function(inventory){var output,recipe,_i,_len,_ref;_ref=this.recipes;for(_i=0,_len=_ref.length;_i<_len;_i++){recipe=_ref[_i];output=recipe.craft(inventory);if(output){return output}}return void 0};return RecipeList}();module.exports=function(game,opts){throw new Error("craftingrecipes plugin (plugin only) replaced by voxel-recipes")};module.exports.Recipe=Recipe;module.exports.AmorphousRecipe=AmorphousRecipe;module.exports.PositionalRecipe=PositionalRecipe;module.exports.CraftingThesaurus=CraftingThesaurus;module.exports.RecipeList=RecipeList}).call(this)},{}],424:[function(require,module,exports){module.exports=require(28)},{clone:425,"deep-equal":426}],425:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],426:[function(require,module,exports){module.exports=require(30)},{}],427:[function(require,module,exports){var skin=require("minecraft-skin");module.exports=function(game,opts){return new Player(game,opts)};function Player(game,opts){if(!game.isClient)return;var mountPoint;var possessed;opts=opts||{};opts.homePosition=opts.homePosition||[0,0,0];opts.homeRotation=opts.homeRotation||[0,0,0];opts.skinOpts=opts.skinOpts||{};opts.skinOpts.scale=opts.skinOpts.scale||new game.THREE.Vector3(.04,.04,.04);var playerSkin=skin(game.THREE,opts.image,opts.skinOpts);var player=playerSkin.mesh;var physics=this.physics=game.makePhysical(player);physics.playerSkin=playerSkin;player.position.set(0,562,-20);game.scene.add(player);game.addItem(physics);physics.yaw=player;physics.pitch=player.head;physics.subjectTo(game.gravity);physics.blocksCreation=true;game.control(physics);physics.move=function(x,y,z){var xyz=parseXYZ(x,y,z);physics.yaw.position.x+=xyz.x;physics.yaw.position.y+=xyz.y;physics.yaw.position.z+=xyz.z};physics.moveTo=function(x,y,z){var xyz=parseXYZ(x,y,z);physics.yaw.position.x=xyz.x;physics.yaw.position.y=xyz.y;physics.yaw.position.z=xyz.z};var pov=1;physics.pov=function(type){if(type==="first"||type===1){pov=1}else if(type==="third"||type===3){pov=3}physics.possess()};physics.show=function(show){this.playerSkin.rightArm.visible=show;this.playerSkin.leftArm.visible=show;this.playerSkin.body.visible=show;this.playerSkin.rightLeg.visible=show;this.playerSkin.leftLeg.visible=show;this.playerSkin.head.visible=show};physics.toggle=function(){physics.pov(pov===1?3:1)};physics.possess=function(){if(possessed)possessed.remove(game.camera);else this.home();var key=pov===1?"cameraInside":"cameraOutside";player[key].add(game.camera);possessed=player[key];this.show(pov!==1)};physics.home=function(){this.position.set(opts.homePosition[0],opts.homePosition[1],opts.homePosition[2]);this.rotation.set(opts.homeRotation[0],opts.homeRotation[1],opts.homeRotation[2])};physics.enable=function(){physics.possess()};physics.disable=function(){if(possessed)possessed.remove(game.camera)};physics.position=physics.yaw.position;this.enable();return physics}Player.prototype.enable=function(){this.physics.enable()};Player.prototype.disable=function(){this.physics.disable()};function parseXYZ(x,y,z){if(typeof x==="object"&&Array.isArray(x)){return{x:x[0],y:x[1],z:x[2]}}else if(typeof x==="object"){return{x:x.x||0,y:x.y||0,z:x.z||0}}return{x:Number(x),y:Number(y),z:Number(z)}}},{"minecraft-skin":428}],428:[function(require,module,exports){module.exports=require(241)},{}],429:[function(require,module,exports){"use strict";module.exports=function(game,opts){return new PluginsUI(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-debug"],clientOnly:true};function PluginsUI(game,opts){this.game=game;this.plugins=this.game.plugins;opts=opts||{};this.gui=opts.gui||(game.plugins&&game.plugins.get("voxel-debug")?game.plugins.get("voxel-debug").gui:new require("dat-gui").GUI());this.folder=this.gui.addFolder("plugins");this.pluginState={};this.pluginItems={};var list=this.plugins.listAll();for(var i=0;i<list.length;++i){this.addPlugin(list[i])}this.plugins.on("new plugin",function(name){self.addPlugin(name)});var self=this;this.plugins.on("plugin enabled",function(name){self.pluginState[name]=true;self.pluginItems[name].updateDisplay()});this.plugins.on("plugin disabled",function(name){self.pluginState[name]=false;self.pluginItems[name].updateDisplay()})}PluginsUI.prototype.addPlugin=function(name){this.pluginState[name]=this.plugins.isEnabled(name);this.pluginItems[name]=this.folder.add(this.pluginState,name);this.pluginItems[name].onChange(setStateForPlugin(this,name))};function setStateForPlugin(self,name){return function(newState){if(newState)self.plugins.enable(name);else self.plugins.disable(name)}}},{}],430:[function(require,module,exports){"use strict";var ever=require("ever");var inherits=require("inherits");var EventEmitter=require("events").EventEmitter;module.exports=function(game,opts){return new Reach(game,opts)};module.exports.pluginInfo={};function Reach(game,opts){this.game=game;opts=opts||{};opts.reachDistance=opts.reachDistance||8;opts.mouseButton=opts.mouseButton!==undefined?opts.mouseButton:0;this.opts=opts;this.currentTarget=null;this.havePointer=false;this.enable()}Reach.prototype.enable=function(){var self=this;if(this.game.isClient){this.game.interact.on("attain",function(){self.havePointer=true});this.game.interact.on("release",function(){self.havePointer=false})}function fire(fireTarget,state){var action,target;action=self.action(state);if(!action){return}target=self.specifyTarget();if(action==="mining"&&(self.currentTarget||target)){if(!targetsEqual(target,self.currentTarget)){self.emit("stop mining",self.currentTarget);self.emit("start mining",target)}}self.currentTarget=target;self.emit(action,target)}function mousedown(ev){if(!self.havePointer)return;if(ev.button!==self.opts.mouseButton)return;self.emit("start mining",self.specifyTarget())}function mouseup(ev){if(!self.havePointer)return;if(ev.button!==self.opts.mouseButton)return;self.currentTarget=null;self.emit("stop mining",self.specifyTarget())}this.game.on("fire",fire);if(this.game.isClient){ever(document.body).on("mousedown",mousedown);ever(document.body).on("mouseup",mouseup)}this.fire=fire;this.mousedown=mousedown;this.mouseup=mouseup};Reach.prototype.disable=function(){this.game.removeListener("fire",this.fire);if(this.game.isClient){ever(document.body).removeListener("mousedown",this.mousedown);ever(document.body).removeListener("mouseup",this.mouseup)}};function frac(f){return Math.abs(f%1)}function targetsEqual(a,b){var strA=a&&a.voxel?a.voxel.join(","):"none";var strB=b&&b.voxel?b.voxel.join(","):"none";return strA===strB}Reach.prototype.specifyTarget=function(){var sub,side,hit,value;hit=this.game.raycastVoxels(this.game.cameraPosition(),this.game.cameraVector(),this.opts.reachDistance);if(!hit){return false}sub=[frac(hit.position[0]),frac(hit.position[1]),frac(hit.position[2])];var fix=(hit.normal.indexOf(1)+1||hit.normal.indexOf(-1)+1)-1;sub.splice(fix,1);side=this.normalToCardinal(hit.normal);value=this.game.getBlock(hit.voxel);return{voxel:hit.voxel,adjacent:hit.adjacent,side:side,sub:sub,normal:hit.normal,value:value}};Reach.prototype.normalToCardinal=function(normal){return{"1,0,0":"east","-1,0,0":"west","0,1,0":"top","0,-1,0":"bottom","0,0,1":"south","0,0,-1":"north"}[normal]};Reach.prototype.cardinalToNormal=function(direction){return{east:[1,0,0],west:[-1,0,0],top:[0,1,0],bottom:[0,-1,0],south:[0,0,1],north:[0,0,-1]}[direction]};Reach.prototype.action=function(kb_state){if(kb_state.fire){return"mining"}else if(kb_state.firealt){return"use"}else{return undefined}};inherits(Reach,EventEmitter)},{events:507,ever:431,inherits:434}],431:[function(require,module,exports){module.exports=require(40)},{"./init.json":432,"./types.json":433,events:507}],432:[function(require,module,exports){module.exports=require(41)},{}],433:[function(require,module,exports){module.exports=require(42)},{}],434:[function(require,module,exports){module.exports=require(4)},{}],435:[function(require,module,exports){var craftingrecipes=require("craftingrecipes");var ItemPile=require("itempile");module.exports=function(game,opts){return new RecipesPlugin(game,opts)};function RecipesPlugin(game,opts){this.craftList=new craftingrecipes.RecipeList;this.smeltMap={};this.thesaurus=new craftingrecipes.CraftingThesaurus}RecipesPlugin.prototype.register=function(recipe){return this.craftList.register(recipe)};RecipesPlugin.prototype.registerAmorphous=function(ingredients,result){return this.register(new craftingrecipes.AmorphousRecipe(ingredients,ItemPile.fromArrayIfArray(result)))};RecipesPlugin.prototype.registerPositional=function(ingredients,result){return this.register(new craftingrecipes.PositionalRecipe(ingredients,ItemPile.fromArrayIfArray(result)))};RecipesPlugin.prototype.find=function(inventory){return this.craftList.find(inventory)};RecipesPlugin.prototype.craft=function(inventory){return this.craftList.craft(inventory)};RecipesPlugin.prototype.registerSmelting=function(input,output){if(input in this.craftList)console.log("WARNING: voxel-recipes registerSmelting overwriting recipes "+input+" -> "+output);this.craftList[input]=ItemPile.fromArrayIfArray(output)};RecipesPlugin.prototype.smelt=function(input){if(!input||!input.item)return undefined;var output=this.craftList[input.item];return output?output.clone():undefined}},{craftingrecipes:436,itempile:437}],436:[function(require,module,exports){module.exports=require(423)},{}],437:[function(require,module,exports){(function(){var ItemPile,clone,deepEqual;deepEqual=require("deep-equal");clone=require("clone");module.exports=ItemPile=function(){function ItemPile(item,count,tags){this.item=typeof item==="string"?ItemPile.itemFromString(item):item;this.count=count!=null?count:1;this.tags=tags!=null?tags:{}}ItemPile.prototype.clone=function(){return new ItemPile(this.item,this.count,clone(this.tags,false))};ItemPile.maxPileSize=64;ItemPile.itemFromString=function(s){if(s instanceof ItemPile){return s}if(!s){return""}else{return s}};ItemPile.itemToString=function(item){return""+item};ItemPile.prototype.hasTags=function(){return Object.keys(this.tags).length!==0};ItemPile.prototype.matchesType=function(itemPile){return this.item===itemPile.item};ItemPile.prototype.matchesTypeAndCount=function(itemPile){return this.item===itemPile.item&&this.count===itemPile.count};ItemPile.prototype.matchesTypeAndTags=function(itemPile){return this.item===itemPile.item&&deepEqual(this.tags,itemPile.tags,{strict:true})};ItemPile.prototype.matchesAll=function(itemPile){return this.matchesTypeAndCount(itemPile)&&deepEqual(this.tags,itemPile.tags,{strict:true})};ItemPile.prototype.canPileWith=function(itemPile){if(itemPile.item!==this.item){return false}if(itemPile.count===0||this.count===0){return true}if(itemPile.hasTags()||this.hasTags()){return false}return true};ItemPile.prototype.mergePile=function(itemPile){if(!this.canPileWith(itemPile)){return false}return itemPile.count=this.increase(itemPile.count)};ItemPile.prototype.increase=function(n){var excessCount,newCount,_ref;_ref=this.tryAdding(n),newCount=_ref[0],excessCount=_ref[1];this.count=newCount;return excessCount};ItemPile.prototype.decrease=function(n){var remainingCount,removedCount,_ref;_ref=this.trySubtracting(n),removedCount=_ref[0],remainingCount=_ref[1];this.count=remainingCount;return removedCount};ItemPile.prototype.tryAdding=function(n){var sum;sum=this.count+n;if(sum>ItemPile.maxPileSize&&this.count!==Infinity){return[ItemPile.maxPileSize,sum-ItemPile.maxPileSize]}else{return[sum,0]}};ItemPile.prototype.trySubtracting=function(n){var difference;difference=this.count-n;if(difference<0){return[this.count,n-this.count]}else{return[n,this.count-n]}};ItemPile.prototype.splitPile=function(n){if(n<0){n=this.count+n}else if(n<1){n=Math.ceil(this.count*n)}if(n>this.count){return false}if(n!==Infinity){this.count-=n}return new ItemPile(this.item,n,clone(this.tags,false))};ItemPile.prototype.toString=function(){if(this.hasTags()){return""+this.count+":"+this.item+" "+JSON.stringify(this.tags)}else{return""+this.count+":"+this.item}};ItemPile.fromString=function(s){var a,count,countStr,item,itemStr,tags,tagsStr,_;a=s.match(/^([^:]+):([^ ]+) ?(.*)/);if(!a){return void 0}_=a[0],countStr=a[1],itemStr=a[2],tagsStr=a[3];count=parseInt(countStr,10);item=ItemPile.itemFromString(itemStr);if(tagsStr&&tagsStr.length){tags=JSON.parse(tagsStr)}else{tags={}}return new ItemPile(item,count,tags)};ItemPile.fromArray=function(a){var count,item,tags;item=a[0],count=a[1],tags=a[2];return new ItemPile(item,count,tags)};ItemPile.fromArrayIfArray=function(a){if(Array.isArray(a)){return ItemPile.fromArray(a)}else{return a}};return ItemPile}()}).call(this)},{clone:438,"deep-equal":439}],438:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],439:[function(require,module,exports){module.exports=require(91)},{"./lib/is_arguments.js":440,"./lib/keys.js":441}],440:[function(require,module,exports){module.exports=require(92)},{}],441:[function(require,module,exports){module.exports=require(93)},{}],442:[function(require,module,exports){var toArray=require("toarray");module.exports=function(game,opts){return new Registry(game,opts)};function Registry(game,opts){this.game=game;this.blockProps=[{}];this.blockName2Index={air:0};this.itemProps={}}Registry.prototype.registerBlock=function(name,props){var nextIndex=this.blockProps.length;if(this.blockName2Index[name])throw new Error("registerBlock: duplicate block name "+name+", existing index "+this.blockName2Index[name]+" attempted overwrite by "+nextIndex);props.name=props.name||name;this.blockProps.push(props);this.blockName2Index[name]=nextIndex;return nextIndex};Registry.prototype.registerBlocks=function(name,count,props){var startIndex=this.registerBlock(name+"#0",props);var lastIndex=startIndex;props.baseIndex=startIndex;props.getOffsetIndex=function(n){return n-startIndex};for(var i=1;i<count;i+=1){var thisIndex=this.registerBlock(name+"#"+i,props);lastIndex=thisIndex}props.offsetIndexCount=count;props.lastIndex=lastIndex};Registry.prototype.getBlockID=function(name){return this.getBlockIndex(name)};Registry.prototype.getBlockIndex=function(name){return this.blockName2Index[name]};Registry.prototype.getBlockName=function(blockIndex){var props=this.blockProps[blockIndex];return props?props.name:"<index #"+blockIndex+">"};Registry.prototype.getBlockProps=function(name){var blockIndex=this.getBlockIndex(name);return this.blockProps[blockIndex]};Registry.prototype.getBlockPropsAll=function(prop){var props=[];for(var i=1;i<this.blockProps.length;++i){props.push(this.blockProps[i][prop])}return props};Registry.prototype.registerItem=function(name,props){if(this.itemProps[name])throw new Error("registerItem: duplicate item name "+name+", existing properties: "+this.itemProps[name]);if(this.blockName2Index[name])throw new Error("registerItem: item name "+name+" conflicts with existing block name of index"+this.blockName2Index[name]);this.itemProps[name]=props};Registry.prototype.getItemProps=function(name){return this.itemProps[name]||this.getBlockProps(name)};Registry.prototype.getItemTexture=function(name){var props=this.getItemProps(name);textureName="gravel";if(props){var textureName=props.itemTexture;if(textureName===undefined){if(props.texture!==undefined){return toArray(props.texture).map(this.getTextureURL)}}}return this.getTextureURL(textureName)};Registry.prototype.getItemDisplayName=function(name){var props=this.getItemProps(name);if(!props)return"<unknown>";if(props.displayName)return props.displayName;var initialCap=name.substr(0,1).toUpperCase();var rest=name.substr(1);return initialCap+rest};Registry.prototype.getItemPileTexture=function(itemPile){return this.getItemTexture(itemPile.item)};Registry.prototype.isBlock=function(name){return this.blockName2Index[name]!==undefined};Registry.prototype.onTexturesReady=function(cb){if(!this.game.materials.artPacks)return;if(this.game.materials.artPacks.isQuiescent())cb();else this.game.materials.artPacks.on("loadedAll",cb)};Registry.prototype.getTextureURL=function(name){if(!this.game.materials.artPacks)return;return this.game.materials.artPacks.getTexture(name)}},{toarray:443}],443:[function(require,module,exports){module.exports=function(item){if(item===undefined)return[];return Object.prototype.toString.call(item)==="[object Array]"?item:[item]}},{}],444:[function(require,module,exports){"use strict";var play_audio=require("play-audio");module.exports=function(game,opts){return new SfxPlugin(game,opts)};module.exports.pluginInfo={clientOnly:true,loadAfter:["voxel-health"]};function SfxPlugin(game,opts){this.game=game;this.artPacks=this.game.materials.artPacks;if(!this.artPacks)throw new Error("voxel-sfx requires game.materials to support artPacks (try voxel-texture-shader)");this.enable()}SfxPlugin.prototype.enable=function(){var self=this;this.healthPlugin=this.game.plugins.get("voxel-health");if(this.healthPlugin){this.healthPlugin.on("hurt",this.onHurt=function(){self.play("damage/fallsmall")})}};SfxPlugin.prototype.disable=function(){if(this.healthPlugin)this.healthPlugin.removeListener("hurt",this.onHurt)};SfxPlugin.prototype.play=function(name){var url=this.artPacks.getSound(name);if(!url)return false;console.log("Playing sound",name,url);play_audio(url).autoplay()}},{"play-audio":445}],445:[function(require,module,exports){module.exports=require("media").audio},{media:446}],446:[function(require,module,exports){module.exports=require("./lib/player");module.exports.audio=media("audio");module.exports.video=media("video");function media(kind){return function(urls,dom){return module.exports(kind,urls,dom)}}},{"./lib/player":448}],447:[function(require,module,exports){var table={aif:"audio/x-aiff",aiff:"audio/x-aiff",wav:"audio/x-wav",mp3:"audio/mpeg",m3u:"audio/x-mpegurl",mid:"audio/midi",midi:"audio/midi",m4a:"audio/m4a",ogg:"audio/ogg",mp4:"video/mp4",ogv:"video/mp4",webm:"video/webm",mkv:"video/x-matroska",mpg:"video/mpeg"};module.exports=mimeOf;function mimeOf(url){return table[url.split(".").slice(-1)[0]]}},{}],448:[function(require,module,exports){var newChain=require("new-chain"),src=require("./src"),render=require("./render");module.exports=play;function play(media,urls,dom){var el,chain,url;dom||(dom=document.documentElement);el=render(media);dom.appendChild(el);chain=newChain({autoplay:bool("autoplay"),controls:bool("controls"),load:method("load"),loop:bool("loop"),muted:bool("muted"),on:on,pause:method("pause"),play:method("play"),preload:bool("preload")});chain.currentTime=attr("currentTime");chain.element=element;chain.src=src.attr(el);chain.volume=attr("volume");chain.remove=remove;chain.src(urls);return chain;function attr(name){return function(value){if(arguments.length){el[name]=value;return chain}return el[name]}}function bool(name){return function(value){if(value===false){return el[name]=false}return el[name]=true}}function element(){return el}function on(event,callback){el.addEventListener(event,callback,false)}function method(name){return function(){return el[name].apply(el,arguments)}}function remove(){return el.parentNode.removeChild(el)}}},{"./render":449,"./src":450,"new-chain":453}],449:[function(require,module,exports){var domify=require("domify"),templates=require("./templates");module.exports=render;function render(media){return domify(templates[media+".html"])}},{"./templates":451,domify:452}],450:[function(require,module,exports){var mimeOf=require("./mime");module.exports={attr:attr,pick:pick};function attr(el){var value;return function(urls){if(arguments.length){value=urls;el.setAttribute("src",pick(el,value))}return value}}function pick(el,urls){if(!urls)return;if(typeof urls=="string"){return urls}return urls.filter(function(url){return!!el.canPlayType(mimeOf(url))})[0]}},{"./mime":447}],451:[function(require,module,exports){exports["audio.html"]='<audio preload="auto" /></audio>';exports["video.html"]='<video preload="auto" /></video>'},{}],452:[function(require,module,exports){module.exports=parse;var map={option:[1,'<select multiple="multiple">',"</select>"],optgroup:[1,'<select multiple="multiple">',"</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tbody:[1,"<table>","</table>"],tfoot:[1,"<table>","</table>"],colgroup:[1,"<table>","</table>"],caption:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],th:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],_default:[0,"",""]};function parse(html){if("string"!=typeof html)throw new TypeError("String expected");var m=/<([\w:]+)/.exec(html);if(!m)throw new Error("No elements were generated.");var tag=m[1];if(tag=="body"){var el=document.createElement("html");el.innerHTML=html;return el.removeChild(el.lastChild)}var wrap=map[tag]||map._default;var depth=wrap[0];var prefix=wrap[1];var suffix=wrap[2];var el=document.createElement("div");el.innerHTML=prefix+html+suffix;while(depth--)el=el.lastChild;var els=el.children;if(1==els.length){return el.removeChild(els[0])}var fragment=document.createDocumentFragment();while(els.length){fragment.appendChild(el.removeChild(els[0]))}return fragment}},{}],453:[function(require,module,exports){module.exports=newChain;module.exports.from=from;function from(chain){return function(){var m,i;m=methods.apply(undefined,arguments);i=m.length;while(i--){chain[m[i].name]=m[i].fn}m.forEach(function(method){chain[method.name]=function(){method.fn.apply(this,arguments);return chain}});return chain}}function methods(){var all,el,i,len,result,key;all=Array.prototype.slice.call(arguments);result=[];i=all.length;while(i--){el=all[i];if(typeof el=="function"){result.push({name:el.name,fn:el});continue}if(typeof el!="object")continue;for(key in el){result.push({name:key,fn:el[key]})}}return result}function newChain(){return from({}).apply(undefined,arguments)}},{}],454:[function(require,module,exports){"use strict";module.exports=function(game,opts){return new SprintPlugin(game,opts)};module.exports.pluginInfo={clientOnly:true};function SprintPlugin(game,opts){this.game=game;if(!this.game.buttons.down)throw new Error("voxel-sprint requires game.buttons as kb-bindings");this.walkMaxSpeed=opts.walkMaxSpeed||.0056;this.runMaxSpeed=opts.runMaxSpeed||.0112;this.counter=0;this.forwardUpAfterFirstDown=false;this.first=Date.now();this.sprinting=false;this.enable()}SprintPlugin.prototype.enable=function(){var self=this;self.game.buttons.down.on("forward",self.onForwardDown=function(){console.log("forward",self.counter,self.forwardUpAfterFirstDown,self.first);if(self.counter===1){if(Date.now()-self.first>300){self.forwardUpAfterFirstDown=true;self.first=Date.now();return}else{if(self.forwardUpAfterFirstDown){self.startSprint()}}self.forwardUpAfterFirstDown=false;self.counter=0}else if(self.counter===0){self.first=Date.now();self.counter+=1}});self.game.buttons.up.on("forward",self.onForwardUp=function(){if(self.sprinting)self.stopSprint()})};SprintPlugin.prototype.disable=function(){this.game.buttons.down.removeListener("forward",this.onForwardDown);this.game.buttons.up.removeListener("forward",this.onForwardUp)};SprintPlugin.prototype.startSprint=function(){console.log("startSprint");this.game.controls.walk_max_speed=this.runMaxSpeed;this.sprinting=true};SprintPlugin.prototype.stopSprint=function(){console.log("stopSprint");this.game.controls.walk_max_speed=this.walkMaxSpeed;this.sprinting=false}},{}],455:[function(require,module,exports){module.exports=function(game,opts){return new StartPlugin(game,opts)};function StartPlugin(game,opts){if(!game.isClient)return;
this.game=game;this.icon=document.createElement("div");this.icon.textContent="";this.icon.setAttribute("id","playbutton");this.icon.setAttribute("style",["font-size: 200pt;","position: absolute;","top: 40%;","left: 50%;","pointer-events: none;"].join("\n"));document.body.appendChild(this.icon);this.enable()}StartPlugin.prototype.enable=function(){var self=this;this.game.interact.once("attain",function(){if(self.game.plugins)self.game.plugins.disable("voxel-start");else self.disable()})};StartPlugin.prototype.disable=function(){this.icon.parentElement.removeChild(this.icon);delete self.icon}},{}],456:[function(require,module,exports){var tic=require("tic")();var createAtlas=require("atlaspack");var isTransparent=require("opaque").transparent;var touchup=require("touchup");module.exports=Texture;function reconfigure(old){var ret=module.exports(old.opts);ret.load(old.names);return ret}function Texture(opts){if(!(this instanceof Texture))return new Texture(opts||{});var self=this;this.game=opts.game;this.opts=opts;this.THREE=this.game.THREE;this.names=[];this.materials=[];this.transparents=[];this.artPacks=opts.artPacks;if(!this.artPacks)throw new Error("voxel-texture-shader requires artPacks option");this.loading=0;this.ao=require("voxel-fakeao")(this.game);var useFlatColors=opts.materialFlatColor===true;delete opts.materialFlatColor;this.useFourTap=opts.useFourTap=opts.useFourTap===undefined?true:opts.useFourTap;this.useTransparency=opts.useTransparency=opts.useTransparency===undefined?true:opts.useTransparency;this.canvas=typeof document!=="undefined"?document.createElement("canvas"):{};this.canvas.width=opts.atlasWidth||2048;this.canvas.height=opts.atlasHeight||2048;var ctx=this.canvas.getContext("2d");ctx.fillStyle="black";ctx.fillRect(0,0,this.canvas.width,this.canvas.height);this.atlas=createAtlas(this.canvas);this.atlas.tilepad=opts.tilepad=opts.tilepad===undefined?true:opts.tilepad;this._atlasuv=false;this._atlaskey=false;this.texture=new this.THREE.Texture(this.canvas);var THREE=this.game.THREE;var getMaterialParams=function(transparent){var materialParams={ambient:12303291,transparent:transparent,side:THREE.FrontSide,lights:[],uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib["common"],THREE.UniformsLib["fog"],THREE.UniformsLib["lights"],THREE.UniformsLib["shadowmap"],{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)},tileMap:{type:"t",value:null},tileSize:{type:"f",value:16/this.canvas.width}}]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk["map_pars_vertex"],THREE.ShaderChunk["lightmap_pars_vertex"],THREE.ShaderChunk["envmap_pars_vertex"],THREE.ShaderChunk["lights_lambert_pars_vertex"],THREE.ShaderChunk["color_pars_vertex"],THREE.ShaderChunk["morphtarget_pars_vertex"],THREE.ShaderChunk["skinning_pars_vertex"],THREE.ShaderChunk["shadowmap_pars_vertex"],"varying vec3 vNormal;","varying vec3 vPosition;","varying vec2 vUv;","void main() {",THREE.ShaderChunk["map_vertex"],THREE.ShaderChunk["lightmap_vertex"],THREE.ShaderChunk["color_vertex"],THREE.ShaderChunk["morphnormal_vertex"],THREE.ShaderChunk["skinbase_vertex"],THREE.ShaderChunk["skinnormal_vertex"],THREE.ShaderChunk["defaultnormal_vertex"],THREE.ShaderChunk["morphtarget_vertex"],THREE.ShaderChunk["skinning_vertex"],THREE.ShaderChunk["default_vertex"],THREE.ShaderChunk["worldpos_vertex"],THREE.ShaderChunk["envmap_vertex"],THREE.ShaderChunk["lights_lambert_vertex"],THREE.ShaderChunk["shadowmap_vertex"],"   vNormal = normal;","   vPosition = position;","   vUv = uv;","   gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk["color_pars_fragment"],THREE.ShaderChunk["map_pars_fragment"],THREE.ShaderChunk["lightmap_pars_fragment"],THREE.ShaderChunk["envmap_pars_fragment"],THREE.ShaderChunk["fog_pars_fragment"],THREE.ShaderChunk["shadowmap_pars_fragment"],THREE.ShaderChunk["specularmap_pars_fragment"],"uniform sampler2D tileMap;","uniform float tileSize;","","varying vec3 vNormal;","varying vec3 vPosition;","varying vec2 vUv;","vec4 fourTapSample(vec2 tileOffset, //Tile offset in the atlas ","                  vec2 tileUV, //Tile coordinate (as above)","                  sampler2D atlas) {","  //Initialize accumulators","  vec4 color = vec4(0.0, 0.0, 0.0, 0.0);","  float totalWeight = 0.0;","","  for(int dx=0; dx<2; ++dx)","  for(int dy=0; dy<2; ++dy) {","    //Compute coordinate in 2x2 tile patch","    vec2 tileCoord = 2.0 * fract(0.5 * (tileUV + vec2(dx,dy)));","","    //Weight sample based on distance to center","    float w = pow(1.0 - max(abs(tileCoord.x-1.0), abs(tileCoord.y-1.0)), 16.0);","","    //Compute atlas coord","    vec2 atlasUV = tileOffset + tileSize * tileCoord;","","    //Sample and accumulate","    color += w * texture2D(atlas, atlasUV);","    totalWeight += w;","  }","","  //Return weighted color","  return color / totalWeight;","}","","void main() {","   vec2 tileUV = vec2(dot(vNormal.zxy, vPosition),","                      dot(vNormal.yzx, vPosition));","","    // back and bottom: flip 180","    if (vNormal.z < 0.0 || vNormal.y < 0.0) tileUV.t = 1.0 - tileUV.t;","","    // left: rotate 90 ccw","    if (vNormal.x < 0.0) {","        float r = tileUV.s;","        tileUV.s = tileUV.t;","        tileUV.t = 1.0 - r;","    }","","    // right and top: rotate 90 cw","    if (vNormal.x > 0.0 || vNormal.y > 0.0) {","        float r = tileUV.s;","        tileUV.s = tileUV.t;","        tileUV.t = r;","    }","","    // front and back and bottom: flip 180","   if (vNormal.z > 0.0 || vNormal.z < 0.0 || vNormal.y < 0.0) tileUV.s = 1.0 - tileUV.s;","","","   vec2 tileOffset = vUv;","",this.useFourTap?["     gl_FragColor = fourTapSample(tileOffset, //Tile offset in the atlas ","                  tileUV, //Tile coordinate (as above)","                  tileMap);"].join("\n"):["vec2 texCoord = tileOffset + tileSize * fract(tileUV);","gl_FragColor = texture2D(tileMap, texCoord);"].join("\n"),"",THREE.ShaderChunk["alphatest_fragment"],THREE.ShaderChunk["specularmap_fragment"],"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",THREE.ShaderChunk["lightmap_fragment"],THREE.ShaderChunk["color_fragment"],THREE.ShaderChunk["envmap_fragment"],THREE.ShaderChunk["shadowmap_fragment"],THREE.ShaderChunk["linear_to_gamma_fragment"],THREE.ShaderChunk["fog_fragment"],"}"].join("\n")};materialParams.uniforms.tileMap.value=this.texture;return materialParams};this.materialParams=getMaterialParams.call(this,false);this.materialTransparentParams=getMaterialParams.call(this,true);this.texture.magFilter=this.THREE.NearestFilter;this.texture.minFilter=this.THREE.LinearMipMapLinearFilter;if(useFlatColors){this.material=new this.THREE.MeshBasicMaterial({vertexColors:this.THREE.VertexColors})}else{var opaque=new this.THREE.ShaderMaterial(this.materialParams);var transparent=new this.THREE.ShaderMaterial(this.materialTransparentParams);this.material=new this.THREE.MeshFaceMaterial([opaque,transparent])}this._meshQueue=[]}Texture.prototype.reconfigure=function(){return reconfigure(this)};Texture.prototype.load=function(names,done){if(!names||names.length===0)return;this.names=this.names.concat(names);var self=this;if(!Array.isArray(names))names=[names];done=done||function(){};this.loading++;var materialSlice=names.map(self._expandName);self.materials=self.materials.concat(materialSlice);var load=Object.create(null);materialSlice.forEach(function(mats){mats.forEach(function(mat){if(mat.slice(0,1)==="#")return;load[mat]=true})});if(Object.keys(load).length>0){each(Object.keys(load),self.pack.bind(self),function(){self._afterLoading();done(materialSlice)})}else{self._afterLoading()}};Texture.prototype.getTransparentVoxelTypes=function(){var transparentMap={};for(var i=0;i<this.materials.length;i+=1){var blockIndex=i+1;var materialSlice=this.materials[i];var anyTransparent=false;for(var j=0;j<materialSlice.length;j+=1){anyTransparent|=this.transparents.indexOf(materialSlice[j])!==-1}if(anyTransparent)transparentMap[blockIndex]=true}return transparentMap};Texture.prototype.pack=function(name,done){var self=this;function pack(img){var node=self.atlas.pack(img);if(node===false){self.atlas=self.atlas.expand(img);self.atlas.tilepad=true}done()}if(typeof name==="string"){self.artPacks.getTextureImage(name,function(img){if(isTransparent(img)){self.transparents.push(name)}var img2=new Image;img2.id=name;img2.src=touchup.repeat(img,2,2);img2.onload=function(){pack(img2)}},function(err,img){console.error("Couldn't load URL ["+img.src+"]");done()})}else{pack(name)}return self};Texture.prototype.find=function(name){var self=this;var type=0;self.materials.forEach(function(mats,i){mats.forEach(function(mat){if(mat===name){type=i+1;return false}});if(type!==0)return false});return type};Texture.prototype._expandName=function(name){if(name===null)return Array(6);if(name.top)return[name.back,name.front,name.top,name.bottom,name.left,name.right];if(!Array.isArray(name))name=[name];if(name.length===1)name=[name[0],name[0],name[0],name[0],name[0],name[0]];if(name.length===2)name=[name[1],name[1],name[0],name[0],name[1],name[1]];if(name.length===3)name=[name[2],name[2],name[0],name[1],name[2],name[2]];if(name.length===4)name=[name[2],name[2],name[0],name[1],name[3],name[3]];return name};Texture.prototype._afterLoading=function(){var self=this;function alldone(){self.loading--;self._atlasuv=self.atlas.uv(self.canvas.width,self.canvas.height);self._atlaskey=Object.create(null);self.atlas.index().forEach(function(key){self._atlaskey[key.name]=key});self.texture.needsUpdate=true;self.material.needsUpdate=true;if(self._meshQueue.length>0){self._meshQueue.forEach(function(queue,i){self.paint.apply(queue.self,queue.args);delete self._meshQueue[i]})}}self._powerof2(function(){setTimeout(alldone,100)})};Texture.prototype._powerof2=function(done){var w=this.canvas.width;var h=this.canvas.height;function pow2(x){x--;x|=x>>1;x|=x>>2;x|=x>>4;x|=x>>8;x|=x>>16;x++;return x}if(h>w)w=h;var old=this.canvas.getContext("2d").getImageData(0,0,this.canvas.width,this.canvas.height);this.canvas.width=this.canvas.height=pow2(w);this.canvas.getContext("2d").putImageData(old,0,0);done()};Texture.prototype.paint=function(mesh,materials){var self=this;if(self.loading>0){self._meshQueue.push({self:self,args:arguments});return false}var isVoxelMesh=materials?false:true;if(!isVoxelMesh)materials=self._expandName(materials);mesh.geometry.faces.forEach(function(face,i){if(mesh.geometry.faceVertexUvs[0].length<1)return;if(isVoxelMesh){var index=Math.floor(face.color.b*255+face.color.g*255*255+face.color.r*255*255*255);materials=self.materials[index-1];if(!materials)materials=self.materials[0]}var name=materials[0]||"";if(face.normal.z===1)name=materials[1]||"";else if(face.normal.y===1)name=materials[2]||"";else if(face.normal.y===-1)name=materials[3]||"";else if(face.normal.x===-1)name=materials[4]||"";else if(face.normal.x===1)name=materials[5]||"";if(name.slice(0,1)==="#"){self.ao(face,name);return}var atlasuv=self._atlasuv[name];if(!atlasuv)return;face.materialIndex=self.useTransparency&&self.transparents.indexOf(name)!==-1?1:0;if(isVoxelMesh){atlasuv=uvinvert(atlasuv)}else{atlasuv=uvrot(atlasuv,-90)}var topUV=atlasuv[0],rightUV=atlasuv[1],bottomUV=atlasuv[2],leftUV=atlasuv[3];for(var j=0;j<mesh.geometry.faceVertexUvs[0][i].length;j++){mesh.geometry.faceVertexUvs[0][i][j].set(topUV[0],1-topUV[1])}});mesh.geometry.uvsNeedUpdate=true};Texture.prototype.sprite=function(name,w,h,cb){var self=this;if(typeof w==="function"){cb=w;w=null}if(typeof h==="function"){cb=h;h=null}w=w||16;h=h||w;self.loading++;self.artPacks.getTextureImage(name,function(img){var canvases=[];for(var x=0;x<img.width;x+=w){for(var y=0;y<img.height;y+=h){var canvas=document.createElement("canvas");canvas.width=w;canvas.height=h;canvas.name=name+"_"+x+"_"+y;canvas.getContext("2d").drawImage(img,x,y,w,h,0,0,w,h);canvases.push(canvas)}}var textures=[];each(canvases,function(canvas,next){var tex=new Image;tex.name=canvas.name;tex.src=canvas.toDataURL();tex.onload=function(){self.pack(tex,next)};tex.onerror=next;textures.push([tex.name,tex.name,tex.name,tex.name,tex.name,tex.name])},function(){self._afterLoading();delete canvases;self.materials=self.materials.concat(textures);cb(textures)})},function(err,img){cb()});return self};Texture.prototype.animate=function(mesh,names,delay){var self=this;delay=delay||1e3;if(!Array.isArray(names)||names.length<2)return false;var i=0;var mat=new this.THREE.ShaderMaterial(this.materialParams);mat.map=this.texture;mat.transparent=true;mat.needsUpdate=true;tic.interval(function(){self.paint(mesh,names[i%names.length]);i++},delay);return mat};Texture.prototype.tick=function(dt){tic.tick(dt)};function uvrot(coords,deg){if(deg===0)return coords;var c=[];var i=(4-Math.ceil(deg/90))%4;for(var j=0;j<4;j++){c.push(coords[i]);if(i===3)i=0;else i++}return c}function uvinvert(coords){var c=coords.slice(0);return[c[3],c[2],c[1],c[0]]}function each(arr,it,done){var count=0;arr.forEach(function(a){it(a,function(){count++;if(count>=arr.length)done()})})}},{atlaspack:457,opaque:458,tic:459,touchup:460,"voxel-fakeao":461}],457:[function(require,module,exports){module.exports=require(165)},{}],458:[function(require,module,exports){module.exports=require(166)},{}],459:[function(require,module,exports){module.exports=require(155)},{}],460:[function(require,module,exports){(function(){var createCanvas,crop,overallSize,overlay,repeat,scale;createCanvas=function(w,h){var canvas,context;canvas=document.createElement("canvas");canvas.setAttribute("width",w);canvas.setAttribute("height",h);context=canvas.getContext("2d");return[canvas,context]};repeat=function(sourceImage,timesX,timesY){var canvas,context,destH,destW,pattern,_ref;destW=sourceImage.width*timesX;destH=sourceImage.height*timesY;_ref=createCanvas(destW,destH),canvas=_ref[0],context=_ref[1];pattern=context.createPattern(sourceImage,"repeat");context.fillStyle=pattern;context.fillRect(0,0,destW,destH);return canvas.toDataURL()};scale=function(sourceImage,scaleX,scaleY){var canvas,context,destH,destW,_ref;destW=sourceImage.width*scaleX;destH=sourceImage.width*scaleY;_ref=createCanvas(destW,destH),canvas=_ref[0],context=_ref[1];context.drawImage(sourceImage,0,0,destW,destH);return canvas.toDataURL()};crop=function(sourceImage,ox,oy,ow,oh){var canvas,context,destH,destW,sh,sw,sx,sy,_ref;sx=ox||0;sy=oy||0;destW=sourceImage.width-(ow||0)-sx;destH=sourceImage.height-(oh||0)-sy;sw=destW;sh=destH;_ref=createCanvas(destW,destH),canvas=_ref[0],context=_ref[1];console.log(sx,sy,sw,sh,0,0,destW,destH);context.drawImage(sourceImage,sx,sy,sw,sh,0,0,destW,destH);return canvas.toDataURL()};overallSize=function(sourceImages){var destH,destW,sourceImage,_i,_len;destW=destH=0;for(_i=0,_len=sourceImages.length;_i<_len;_i++){sourceImage=sourceImages[_i];if(sourceImage.width>destW){destW=sourceImage.width}if(sourceImage.height>destH){destH=sourceImage.height}}return[destW,destH]};overlay=function(sourceImages,operation,alpha){var canvas,context,destH,destW,sourceImage,_i,_len,_ref,_ref1;_ref=overallSize(sourceImages),destW=_ref[0],destH=_ref[1];_ref1=createCanvas(destW,destH),canvas=_ref1[0],context=_ref1[1];context.globalAlpha=alpha!=null?alpha:1;context.globalCompositeOperation=operation!=null?operation:"source-over";for(_i=0,_len=sourceImages.length;_i<_len;_i++){sourceImage=sourceImages[_i];context.drawImage(sourceImage,0,0)}return canvas.toDataURL()};module.exports={repeat:repeat,scale:scale,crop:crop,overlay:overlay}}).call(this)},{}],461:[function(require,module,exports){module.exports=require(167)},{}],462:[function(require,module,exports){module.exports=require(164)},{atlaspack:463,opaque:464,tic:465,"voxel-fakeao":466}],463:[function(require,module,exports){module.exports=require(165)},{}],464:[function(require,module,exports){module.exports=require(166)},{}],465:[function(require,module,exports){module.exports=require(155)},{}],466:[function(require,module,exports){module.exports=require(167)},{}],467:[function(require,module,exports){(function(){var EventEmitter,Use,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};EventEmitter=require("events").EventEmitter;module.exports=function(game,opts){return new Use(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-reach","voxel-registry","voxel-inventory-hotbar"]};Use=function(_super){__extends(Use,_super);function Use(game,opts){var _ref,_ref1,_ref2;this.game=game;this.reach=function(){var _ref1;if((_ref=(_ref1=game.plugins)!=null?_ref1.get("voxel-reach"):void 0)!=null){return _ref}else{throw new Error('voxel-use requires "voxel-reach" plugin')}}();this.registry=function(){var _ref2;if((_ref1=(_ref2=game.plugins)!=null?_ref2.get("voxel-registry"):void 0)!=null){return _ref1}else{throw new Error('voxel-use requires "voxel-registry" plugin')}}();this.inventoryHotbar=function(){var _ref3;if((_ref2=(_ref3=game.plugins)!=null?_ref3.get("voxel-inventory-hotbar"):void 0)!=null){return _ref2}else{throw new Error('voxel-use requires "voxel-inventory-hotbar" plugin')}}();this.enable()}Use.prototype.enable=function(){return this.reach.on("use",this.onInteract=function(_this){return function(target){var clickedBlock,clickedBlockID,consumeCount,currentBlockID,held,preventDefault,props,ret,taken,_ref;if((target!=null?target.voxel:void 0)!=null&&!_this.game.buttons.crouch){clickedBlockID=_this.game.getBlock(target.voxel);clickedBlock=_this.registry.getBlockName(clickedBlockID);props=_this.registry.getBlockProps(clickedBlock);if(props.onInteract!=null){preventDefault=props.onInteract(target);if(preventDefault){return}}}held=(_ref=_this.inventoryHotbar)!=null?_ref.held():void 0;if(held!=null?held.item:void 0){props=_this.registry.getItemProps(held.item);if(props!=null?props.onUse:void 0){ret=props.onUse(held,target);if(typeof ret==="undefined"){}else if(typeof ret==="number"||typeof ret==="boolean"){consumeCount=ret|0;return _this.inventoryHotbar.takeHeld(consumeCount)}else if(typeof ret==="object"){return _this.inventoryHotbar.replaceHeld(ret)}}else if(_this.registry.isBlock(held.item)){if(!_this.game.canCreateBlock(target!=null?target.adjacent:void 0)){console.log("blocked");return}taken=_this.inventoryHotbar.takeHeld(1);if(taken==null){console.log("nothing in this inventory slot to use");return}currentBlockID=_this.registry.getBlockID(taken.item);return _this.game.setBlock(target.adjacent,currentBlockID)}}else{return console.log("waving")}}}(this))};Use.prototype.disable=function(){return this.reach.removeListener("use",this.onInteract)};return Use}(EventEmitter)}).call(this)},{events:507}],468:[function(require,module,exports){(function(){var VoilaPlugin;module.exports=function(game,opts){return new VoilaPlugin(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-highlight","voxel-registry","voxel-registry","voxel-blockdata"],clientOnly:true};VoilaPlugin=function(){function VoilaPlugin(game,opts){var _ref,_ref1,_ref2;this.game=game;this.hl=function(){var _ref1;if((_ref=(_ref1=this.game.plugins)!=null?_ref1.get("voxel-highlight"):void 0)!=null){return _ref}else{throw new Error("voxel-voila requires voxel-highlight plugin")}}.call(this);this.registry=function(){var _ref2;if((_ref1=(_ref2=this.game.plugins)!=null?_ref2.get("voxel-registry"):void 0)!=null){return _ref1}else{throw new Error("voxel-voila requires voxel-registry plugin")}}.call(this);if(this.registry.getItemDisplayName==null){throw new Error("voxel-voila requires voxel-registry >=0.2.0 with getItemDisplayName")}this.blockdata=(_ref2=this.game.plugins)!=null?_ref2.get("voxel-blockdata"):void 0;this.createNode();this.enable()}VoilaPlugin.prototype.createNode=function(){this.node=document.createElement("div");this.node.setAttribute("id","voxel-voila");this.node.setAttribute("style","border: 1px solid black; background-image: linear-gradient(rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.6) 100%); position: absolute; visibility: hidden; top: 0px; left: 50%; color: white; font-size: 18pt;");this.node.textContent="";return document.body.appendChild(this.node)};VoilaPlugin.prototype.update=function(pos){var bd,displayName,extra,id,name,x,y,z;this.lastPos=pos;if(this.lastPos==null){this.clear();return}id=this.game.getBlock(pos);name=this.registry.getBlockName(id);displayName=this.registry.getItemDisplayName(name);if(this.game.buttons.crouch){if(this.blockdata!=null){x=pos[0],y=pos[1],z=pos[2];bd=this.blockdata.get(x,y,z);if(bd!=null){extra="BD("+x+","+y+","+y+"): "+JSON.stringify(bd);window.status=extra;console.log(extra);extra="+"}else{extra=""}}return this.node.textContent=""+displayName+" ("+name+"/"+id+")"+extra}else{return this.node.textContent=displayName}};VoilaPlugin.prototype.clear=function(){this.lastPos=void 0;return this.node.textContent=""};VoilaPlugin.prototype.enable=function(){this.node.style.visibility="";this.hl.on("highlight",this.onHighlight=function(_this){return function(pos){return _this.update(pos)}}(this));this.hl.on("remove",this.onRemove=function(_this){return function(){return _this.clear()}}(this));if(this.game.buttons.changed!=null){return this.game.buttons.changed.on("crouch",this.onChanged=function(_this){return function(){return _this.update(_this.lastPos)}}(this))}};VoilaPlugin.prototype.disable=function(){this.hl.removeListener("highlight",this.onHighlight);this.hl.removeListener("remove",this.onRemove);if(this.game.buttons.changed!=null){this.game.buttons.changed.removeListener("crouch",this.onChanged)}return this.node.style.visibility="hidden"};return VoilaPlugin}()}).call(this)},{}],469:[function(require,module,exports){module.exports=function(game,opts){return new Walk(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-player"],clientOnly:true};function Walk(game,opts){opts=opts||{};this.game=game;this.controlsTarget=opts.controlsTarget;this.skin=opts.skin;this.walkSpeed=opts.walkSpeed||1;this.startedWalking=0;this.stoppedWalking=0;this.walking=false;this.acceleration=opts.acceleration||1;this.walkThreshold=opts.walkThreshold||.001;if(this.game)this.enable()}Walk.prototype.enable=function(){if(!this.controlsTarget&&this.game&&this.game.controls)this.controlsTarget=this.game.controls.target();if(!this.skin)this.skin=this.controlsTarget.playerSkin;if(!this.skin)throw new Error("voxel-walk could not find controlsTarget or skin");var self=this;function tick(){self.render();if(self.shouldStopWalking()){self.stopWalking()}else{self.startWalking()}}this.game.on("tick",tick);this.tick=tick};Walk.prototype.disable=function(){this.game.removeListener("tick",this.tick)};Walk.prototype.shouldStopWalking=function(){var vx=Math.abs(this.controlsTarget.velocity.x);var vz=Math.abs(this.controlsTarget.velocity.z);return vx>this.walkThreshold||vz>this.walkThreshold};Walk.prototype.render=function(){var time=Date.now()/1e3;if(this.walking&&time<this.startedWalking+this.acceleration){this.walkSpeed=(time-this.startedWalking)/this.acceleration}if(!this.walking&&time<this.stoppedWalking+this.acceleration){this.walkSpeed=-1/this.acceleration*(time-this.stoppedWalking)+1}this.skin.head.rotation.y=Math.sin(time*1.5)/3*this.walkSpeed;this.skin.head.rotation.z=Math.sin(time)/2*this.walkSpeed;this.skin.rightArm.rotation.z=2*Math.cos(.6662*time*10+Math.PI)*this.walkSpeed;this.skin.rightArm.rotation.x=1*(Math.cos(.2812*time*10)-1)*this.walkSpeed;this.skin.leftArm.rotation.z=2*Math.cos(.6662*time*10)*this.walkSpeed;this.skin.leftArm.rotation.x=1*(Math.cos(.2312*time*10)+1)*this.walkSpeed;this.skin.rightLeg.rotation.z=1.4*Math.cos(.6662*time*10)*this.walkSpeed;this.skin.leftLeg.rotation.z=1.4*Math.cos(.6662*time*10+Math.PI)*this.walkSpeed};Walk.prototype.startWalking=function(){var now=Date.now()/1e3;this.walking=true;if(this.stoppedWalking+this.acceleration>now){var progress=now-this.stoppedWalking;this.startedWalking=now-(this.stoppedWalking+this.acceleration-now)}else{this.startedWalking=Date.now()/1e3}};Walk.prototype.stopWalking=function(){var now=Date.now()/1e3;this.walking=false;if(this.startedWalking+this.acceleration>now){this.stoppedWalking=now-(this.startedWalking+this.acceleration-now)}else{this.stoppedWalking=Date.now()/1e3}};Walk.prototype.isWalking=function(){return this.walking};Walk.prototype.setAcceleration=function(newA){this.acceleration=newA}},{}],470:[function(require,module,exports){module.exports=function(THREE){THREE.CSS3DObject=function(element){THREE.Object3D.call(this);this.element=element;this.element.style.position="absolute";this.addEventListener("removed",function(event){if(this.element.parentNode!==null){this.element.parentNode.removeChild(this.element);for(var i=0,l=this.children.length;i<l;i++){this.children[i].dispatchEvent(event)}}})};THREE.CSS3DObject.prototype=Object.create(THREE.Object3D.prototype);THREE.CSS3DSprite=function(element){THREE.CSS3DObject.call(this,element)};THREE.CSS3DSprite.prototype=Object.create(THREE.CSS3DObject.prototype);THREE.CSS3DRenderer=function(){console.log("THREE.CSS3DRenderer",THREE.REVISION);var _width,_height;var _widthHalf,_heightHalf;var matrix=new THREE.Matrix4;var domElement=document.createElement("div");domElement.style.overflow="hidden";domElement.style.WebkitTransformStyle="preserve-3d";domElement.style.MozTransformStyle="preserve-3d";domElement.style.oTransformStyle="preserve-3d";domElement.style.transformStyle="preserve-3d";this.domElement=domElement;var cameraElement=document.createElement("div");cameraElement.style.WebkitTransformStyle="preserve-3d";cameraElement.style.MozTransformStyle="preserve-3d";cameraElement.style.oTransformStyle="preserve-3d";cameraElement.style.transformStyle="preserve-3d";domElement.appendChild(cameraElement);this.setClearColor=function(){};this.setSize=function(width,height){_width=width;_height=height;_widthHalf=_width/2;_heightHalf=_height/2;domElement.style.width=width+"px";domElement.style.height=height+"px";cameraElement.style.width=width+"px";cameraElement.style.height=height+"px"};var epsilon=function(value){return Math.abs(value)<1e-6?0:value};var getCameraCSSMatrix=function(matrix){var elements=matrix.elements;return"matrix3d("+epsilon(elements[0])+","+epsilon(-elements[1])+","+epsilon(elements[2])+","+epsilon(elements[3])+","+epsilon(elements[4])+","+epsilon(-elements[5])+","+epsilon(elements[6])+","+epsilon(elements[7])+","+epsilon(elements[8])+","+epsilon(-elements[9])+","+epsilon(elements[10])+","+epsilon(elements[11])+","+epsilon(elements[12])+","+epsilon(-elements[13])+","+epsilon(elements[14])+","+epsilon(elements[15])+")"};var getObjectCSSMatrix=function(matrix){var elements=matrix.elements;return"translate3d(-50%,-50%,0) matrix3d("+epsilon(elements[0])+","+epsilon(elements[1])+","+epsilon(elements[2])+","+epsilon(elements[3])+","+epsilon(-elements[4])+","+epsilon(-elements[5])+","+epsilon(-elements[6])+","+epsilon(-elements[7])+","+epsilon(elements[8])+","+epsilon(elements[9])+","+epsilon(elements[10])+","+epsilon(elements[11])+","+epsilon(elements[12])+","+epsilon(elements[13])+","+epsilon(elements[14])+","+epsilon(elements[15])+")"};var renderObject=function(object,camera){if(object instanceof THREE.CSS3DObject){var style;if(object instanceof THREE.CSS3DSprite){matrix.copy(camera.matrixWorldInverse);matrix.transpose();matrix.copyPosition(object.matrixWorld);matrix.scale(object.scale);matrix.elements[3]=0;matrix.elements[7]=0;matrix.elements[11]=0;matrix.elements[15]=1;style=getObjectCSSMatrix(matrix)}else{style=getObjectCSSMatrix(object.matrixWorld)}var element=object.element;element.style.WebkitTransform=style;element.style.MozTransform=style;element.style.oTransform=style;element.style.transform=style;if(element.parentNode!==cameraElement){cameraElement.appendChild(element)}}for(var i=0,l=object.children.length;i<l;i++){renderObject(object.children[i],camera)}};this.render=function(scene,camera){var fov=.5/Math.tan(THREE.Math.degToRad(camera.fov*.5))*_height;domElement.style.WebkitPerspective=fov+"px";domElement.style.MozPerspective=fov+"px";domElement.style.oPerspective=fov+"px";domElement.style.perspective=fov+"px";scene.updateMatrixWorld();if(camera.parent===undefined)camera.updateMatrixWorld();camera.matrixWorldInverse.getInverse(camera.matrixWorld);var style="translate3d(0,0,"+fov+"px)"+getCameraCSSMatrix(camera.matrixWorldInverse)+" translate3d("+_widthHalf+"px,"+_heightHalf+"px, 0)";cameraElement.style.WebkitTransform=style;cameraElement.style.MozTransform=style;cameraElement.style.oTransform=style;cameraElement.style.transform=style;renderObject(scene,camera)}}}},{}],471:[function(require,module,exports){"use strict";var loadCSS3DRenderer=require("./CSS3DRenderer.js");module.exports=function(game,opts){return new WebviewPlugin(game,opts)};function WebviewPlugin(game,opts){this.game=game;this.url=opts.url||"http://npmjs.org/";this.planeWidth=opts.planeWidth||10;this.planeHeight=opts.planeHeight||10;this.elementWidth=opts.elementWidth||1024;this.enable()}WebviewPlugin.prototype.enable=function(){var THREE=this.game.THREE;loadCSS3DRenderer(THREE);var planeMaterial=new THREE.MeshBasicMaterial({color:0,opacity:.1,side:THREE.DoubleSide});var planeGeometry=new THREE.PlaneGeometry(this.planeWidth,this.planeHeight);var planeMesh=new THREE.Mesh(planeGeometry,planeMaterial);planeMesh.position.y+=this.planeHeight/2;this.game.scene.add(planeMesh);var sceneCSS=new THREE.Scene;var element=document.createElement("iframe");element.setAttribute("id","voxel-webview");element.src=this.url;var aspectRatio=this.planeHeight/this.planeWidth;var elementHeight=this.elementWidth*aspectRatio;element.style.width=this.elementWidth+"px";element.style.height=elementHeight+"px";var cssObject=new THREE.CSS3DObject(element);cssObject.position=planeMesh.position;cssObject.rotation=planeMesh.rotation;var percentBorder=.05;cssObject.scale.x/=(1+percentBorder)*(this.elementWidth/this.planeWidth);cssObject.scale.y/=(1+percentBorder)*(this.elementWidth/this.planeWidth);sceneCSS.add(cssObject);var rendererCSS=new THREE.CSS3DRenderer;rendererCSS.setSize(window.innerWidth,window.innerHeight);rendererCSS.domElement.style.position="absolute";rendererCSS.domElement.style.top="0";rendererCSS.domElement.style.margin="0";rendererCSS.domElement.style.padding="0";document.body.appendChild(rendererCSS.domElement);var rendererWebGL=this.game.view.renderer;rendererCSS.domElement.style.zIndex=-1;console.log("rendererCSS",rendererCSS);var sceneWebGL=this.game.scene;var camera=this.game.view.camera;var renderWebGL=this.game.view.render.bind(this.game.view);this.game.view.render=function(sceneWebGL){rendererCSS.render(sceneCSS,camera);renderWebGL(sceneWebGL)};this.originalRender=renderWebGL;var self=this;window.addEventListener("click",this.onClick=function(ev){if(document.getElementById("voxel-webview").parentElement.parentElement.style.zIndex==="0"){document.getElementById("voxel-webview").parentElement.parentElement.style.zIndex="-1";self.game.interact.request()}})};WebviewPlugin.prototype.disable=function(){this.game.view.render=this.originalRender;window.removeEventListener("click",this.onClick)}},{"./CSS3DRenderer.js":470}],472:[function(require,module,exports){(function(){var Inventory,InventoryDialog,InventoryWindow,Workbench,WorkbenchDialog,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;
return child};InventoryDialog=require("voxel-inventory-dialog").InventoryDialog;Inventory=require("inventory");InventoryWindow=require("inventory-window");module.exports=function(game,opts){return new Workbench(game,opts)};module.exports.pluginInfo={loadAfter:["voxel-registry","voxel-recipes","voxel-carry"]};Workbench=function(){function Workbench(game,opts){var _ref,_ref1,_ref2;this.game=game;if(opts==null){opts={}}this.playerInventory=function(){var _ref1,_ref2,_ref3;if((_ref=(_ref1=(_ref2=game.plugins)!=null?(_ref3=_ref2.get("voxel-carry"))!=null?_ref3.inventory:void 0:void 0)!=null?_ref1:opts.playerInventory)!=null){return _ref}else{throw new Error('voxel-workbench requires "voxel-carry" plugin or "playerInventory" set to inventory instance')}}();this.registry=function(){var _ref2;if((_ref1=(_ref2=game.plugins)!=null?_ref2.get("voxel-registry"):void 0)!=null){return _ref1}else{throw new Error('voxel-workbench requires "voxel-registry" plugin')}}();this.recipes=function(){var _ref3;if((_ref2=(_ref3=game.plugins)!=null?_ref3.get("voxel-recipes"):void 0)!=null){return _ref2}else{throw new Error('voxel-workbench requires "voxel-recipes" plugin')}}();if(opts.registerBlock==null){opts.registerBlock=true}if(opts.registerRecipe==null){opts.registerRecipe=true}if(this.game.isClient){this.workbenchDialog=new WorkbenchDialog(game,this.playerInventory,this.registry,this.recipes)}this.opts=opts;this.enable()}Workbench.prototype.enable=function(){if(this.opts.registerBlock){this.registry.registerBlock("workbench",{texture:["crafting_table_top","planks_oak","crafting_table_side"],onInteract:function(_this){return function(){_this.workbenchDialog.open();return true}}(this)})}if(this.opts.registerRecipe){return this.recipes.registerAmorphous(["wood.plank","wood.plank","wood.plank","wood.plank"],["workbench"])}};Workbench.prototype.disable=function(){};return Workbench}();WorkbenchDialog=function(_super){__extends(WorkbenchDialog,_super);function WorkbenchDialog(game,playerInventory,registry,recipes){var crDiv,craftCont,craftContOuter,empty,resultCont,resultContOuter;this.game=game;this.playerInventory=playerInventory;this.registry=registry;this.recipes=recipes;this.craftInventory=new Inventory(3,3);this.craftInventory.on("changed",function(_this){return function(){return _this.updateCraftingRecipe()}}(this));this.craftIW=new InventoryWindow({width:3,registry:this.registry,inventory:this.craftInventory,linkedInventory:this.playerInventory});this.resultInventory=new Inventory(1);this.resultIW=new InventoryWindow({inventory:this.resultInventory,registry:this.registry,allowDrop:false,linkedInventory:this.playerInventory});this.resultIW.on("pickup",function(_this){return function(){return _this.tookCraftingOutput()}}(this));crDiv=document.createElement("div");crDiv.style.display="flex";crDiv.style.flexFlow="row";crDiv.style.justifyContent="center";empty=document.createElement("div");empty.style.width="33%";craftCont=this.craftIW.createContainer();craftContOuter=document.createElement("div");craftContOuter.style.width="33%";craftContOuter.style.paddingTop="15px";craftContOuter.appendChild(craftCont);resultCont=this.resultIW.createContainer();resultCont.style.alignSelf="center";resultCont.style.marginLeft="30px";resultContOuter=document.createElement("div");resultContOuter.style.display="flex";resultContOuter.style.width="33%";resultContOuter.style.flexFlow="column";resultContOuter.style.justifyContent="center";resultContOuter.appendChild(resultCont);crDiv.appendChild(empty);crDiv.appendChild(craftContOuter);crDiv.appendChild(resultContOuter);WorkbenchDialog.__super__.constructor.call(this,game,{upper:[crDiv]})}WorkbenchDialog.prototype.updateCraftingRecipe=function(){var recipe;recipe=this.recipes.find(this.craftInventory);console.log("found recipe",recipe);return this.resultInventory.set(0,recipe!=null?recipe.computeOutput(this.craftInventory):void 0)};WorkbenchDialog.prototype.tookCraftingOutput=function(){var recipe;recipe=this.recipes.find(this.craftInventory);if(recipe==null){return}recipe.craft(this.craftInventory);return this.craftInventory.changed()};WorkbenchDialog.prototype.close=function(){var excess,i,_i,_ref;for(i=_i=0,_ref=this.craftInventory.size();0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){if(this.craftInventory.get(i)){excess=this.playerInventory.give(this.craftInventory.get(i))}this.craftInventory.set(i,void 0)}return WorkbenchDialog.__super__.close.call(this)};return WorkbenchDialog}(InventoryDialog)}).call(this)},{inventory:479,"inventory-window":473,"voxel-inventory-dialog":484}],473:[function(require,module,exports){arguments[4][38][0].apply(exports,arguments)},{"cube-icon":474,events:507,ever:475,touchup:478}],474:[function(require,module,exports){module.exports=require(39)},{}],475:[function(require,module,exports){module.exports=require(40)},{"./init.json":476,"./types.json":477,events:507}],476:[function(require,module,exports){module.exports=require(41)},{}],477:[function(require,module,exports){module.exports=require(42)},{}],478:[function(require,module,exports){module.exports=require(43)},{}],479:[function(require,module,exports){arguments[4][32][0].apply(exports,arguments)},{"deep-equal":480,events:507,itempile:481}],480:[function(require,module,exports){module.exports=require(30)},{}],481:[function(require,module,exports){module.exports=require(28)},{clone:482,"deep-equal":483}],482:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],483:[function(require,module,exports){module.exports=require(30)},{}],484:[function(require,module,exports){arguments[4][52][0].apply(exports,arguments)},{inventory:491,"inventory-window":485,itempile:496,"voxel-modal-dialog":499}],485:[function(require,module,exports){arguments[4][38][0].apply(exports,arguments)},{"cube-icon":486,events:507,ever:487,touchup:490}],486:[function(require,module,exports){module.exports=require(39)},{}],487:[function(require,module,exports){module.exports=require(40)},{"./init.json":488,"./types.json":489,events:507}],488:[function(require,module,exports){module.exports=require(41)},{}],489:[function(require,module,exports){module.exports=require(42)},{}],490:[function(require,module,exports){module.exports=require(43)},{}],491:[function(require,module,exports){arguments[4][32][0].apply(exports,arguments)},{"deep-equal":492,events:507,itempile:493}],492:[function(require,module,exports){module.exports=require(30)},{}],493:[function(require,module,exports){module.exports=require(28)},{clone:494,"deep-equal":495}],494:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],495:[function(require,module,exports){module.exports=require(30)},{}],496:[function(require,module,exports){module.exports=require(28)},{clone:497,"deep-equal":498}],497:[function(require,module,exports){module.exports=require(29)},{__browserify_Buffer:509}],498:[function(require,module,exports){module.exports=require(30)},{}],499:[function(require,module,exports){arguments[4][67][0].apply(exports,arguments)},{"voxel-modal":500}],500:[function(require,module,exports){arguments[4][68][0].apply(exports,arguments)},{ever:501}],501:[function(require,module,exports){module.exports=require(40)},{"./init.json":502,"./types.json":503,events:507}],502:[function(require,module,exports){module.exports=require(41)},{}],503:[function(require,module,exports){module.exports=require(42)},{}],504:[function(require,module,exports){(function(){var ZenPlugin;module.exports=function(game,opts){return new ZenPlugin(game,opts)};module.exports.pluginInfo={clientOnly:true};ZenPlugin=function(){function ZenPlugin(game,opts){this.game=game;if(this.game.buttons.down==null){throw new Error('voxel-zen requires "kb-bindings" as game.buttons')}this.zenMode=false;this.enable()}ZenPlugin.prototype.enter=function(){var _ref,_ref1,_ref2,_ref3,_ref4,_ref5;if((_ref=document.getElementById("logo"))!=null){if((_ref1=_ref.style)!=null){_ref1.visibility="hidden"}}if((_ref2=document.getElementById("stats"))!=null){if((_ref3=_ref2.style)!=null){_ref3.visibility="hidden"}}this.game.plugins.disable("voxel-inventory-hotbar");this.game.plugins.disable("voxel-voila");this.game.plugins.disable("voxel-health-bar");if((_ref4=this.getDatgui())!=null){if((_ref5=_ref4.style)!=null){_ref5.visibility="hidden"}}return this.zenMode=true};ZenPlugin.prototype.leave=function(){var _ref,_ref1,_ref2,_ref3,_ref4,_ref5;if((_ref=document.getElementById("logo"))!=null){if((_ref1=_ref.style)!=null){_ref1.visibility=""}}if((_ref2=document.getElementById("stats"))!=null){if((_ref3=_ref2.style)!=null){_ref3.visibility=""}}this.game.plugins.enable("voxel-inventory-hotbar");this.game.plugins.enable("voxel-voila");this.game.plugins.enable("voxel-health-bar");if((_ref4=this.getDatgui())!=null){if((_ref5=_ref4.style)!=null){_ref5.visibility=""}}return this.zenMode=false};ZenPlugin.prototype.getDatgui=function(){var a;a=document.getElementsByClassName("dg");if(a!=null){return a[0]}};ZenPlugin.prototype.toggle=function(){if(this.zenMode){return this.leave()}else{return this.enter()}};ZenPlugin.prototype.enable=function(){return this.game.buttons.down.on("zen",this.down=function(_this){return function(){return _this.toggle()}}(this))};ZenPlugin.prototype.disable=function(){return this.game.buttons.down.remove("zen",this.down)};return ZenPlugin}()}).call(this)},{}],505:[function(require,module,exports){},{}],506:[function(require,module,exports){var util=require("util/");var pSlice=Array.prototype.slice;var hasOwn=Object.prototype.hasOwnProperty;var assert=module.exports=ok;assert.AssertionError=function AssertionError(options){this.name="AssertionError";this.actual=options.actual;this.expected=options.expected;this.operator=options.operator;if(options.message){this.message=options.message;this.generatedMessage=false}else{this.message=getMessage(this);this.generatedMessage=true}var stackStartFunction=options.stackStartFunction||fail;if(Error.captureStackTrace){Error.captureStackTrace(this,stackStartFunction)}else{var err=new Error;if(err.stack){var out=err.stack;var fn_name=stackStartFunction.name;var idx=out.indexOf("\n"+fn_name);if(idx>=0){var next_line=out.indexOf("\n",idx+1);out=out.substring(next_line+1)}this.stack=out}}};util.inherits(assert.AssertionError,Error);function replacer(key,value){if(util.isUndefined(value)){return""+value}if(util.isNumber(value)&&(isNaN(value)||!isFinite(value))){return value.toString()}if(util.isFunction(value)||util.isRegExp(value)){return value.toString()}return value}function truncate(s,n){if(util.isString(s)){return s.length<n?s:s.slice(0,n)}else{return s}}function getMessage(self){return truncate(JSON.stringify(self.actual,replacer),128)+" "+self.operator+" "+truncate(JSON.stringify(self.expected,replacer),128)}function fail(actual,expected,message,operator,stackStartFunction){throw new assert.AssertionError({message:message,actual:actual,expected:expected,operator:operator,stackStartFunction:stackStartFunction})}assert.fail=fail;function ok(value,message){if(!value)fail(value,true,message,"==",assert.ok)}assert.ok=ok;assert.equal=function equal(actual,expected,message){if(actual!=expected)fail(actual,expected,message,"==",assert.equal)};assert.notEqual=function notEqual(actual,expected,message){if(actual==expected){fail(actual,expected,message,"!=",assert.notEqual)}};assert.deepEqual=function deepEqual(actual,expected,message){if(!_deepEqual(actual,expected)){fail(actual,expected,message,"deepEqual",assert.deepEqual)}};function _deepEqual(actual,expected){if(actual===expected){return true}else if(util.isBuffer(actual)&&util.isBuffer(expected)){if(actual.length!=expected.length)return false;for(var i=0;i<actual.length;i++){if(actual[i]!==expected[i])return false}return true}else if(util.isDate(actual)&&util.isDate(expected)){return actual.getTime()===expected.getTime()}else if(util.isRegExp(actual)&&util.isRegExp(expected)){return actual.source===expected.source&&actual.global===expected.global&&actual.multiline===expected.multiline&&actual.lastIndex===expected.lastIndex&&actual.ignoreCase===expected.ignoreCase}else if(!util.isObject(actual)&&!util.isObject(expected)){return actual==expected}else{return objEquiv(actual,expected)}}function isArguments(object){return Object.prototype.toString.call(object)=="[object Arguments]"}function objEquiv(a,b){if(util.isNullOrUndefined(a)||util.isNullOrUndefined(b))return false;if(a.prototype!==b.prototype)return false;if(isArguments(a)){if(!isArguments(b)){return false}a=pSlice.call(a);b=pSlice.call(b);return _deepEqual(a,b)}try{var ka=objectKeys(a),kb=objectKeys(b),key,i}catch(e){return false}if(ka.length!=kb.length)return false;ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!=kb[i])return false}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!_deepEqual(a[key],b[key]))return false}return true}assert.notDeepEqual=function notDeepEqual(actual,expected,message){if(_deepEqual(actual,expected)){fail(actual,expected,message,"notDeepEqual",assert.notDeepEqual)}};assert.strictEqual=function strictEqual(actual,expected,message){if(actual!==expected){fail(actual,expected,message,"===",assert.strictEqual)}};assert.notStrictEqual=function notStrictEqual(actual,expected,message){if(actual===expected){fail(actual,expected,message,"!==",assert.notStrictEqual)}};function expectedException(actual,expected){if(!actual||!expected){return false}if(Object.prototype.toString.call(expected)=="[object RegExp]"){return expected.test(actual)}else if(actual instanceof expected){return true}else if(expected.call({},actual)===true){return true}return false}function _throws(shouldThrow,block,expected,message){var actual;if(util.isString(expected)){message=expected;expected=null}try{block()}catch(e){actual=e}message=(expected&&expected.name?" ("+expected.name+").":".")+(message?" "+message:".");if(shouldThrow&&!actual){fail(actual,expected,"Missing expected exception"+message)}if(!shouldThrow&&expectedException(actual,expected)){fail(actual,expected,"Got unwanted exception"+message)}if(shouldThrow&&actual&&expected&&!expectedException(actual,expected)||!shouldThrow&&actual){throw actual}}assert.throws=function(block,error,message){_throws.apply(this,[true].concat(pSlice.call(arguments)))};assert.doesNotThrow=function(block,message){_throws.apply(this,[false].concat(pSlice.call(arguments)))};assert.ifError=function(err){if(err){throw err}};var objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj){if(hasOwn.call(obj,key))keys.push(key)}return keys}},{"util/":529}],507:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}else{throw TypeError('Uncaught, unspecified "error" event.')}return false}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];handler.apply(this,args)}}else if(isObject(handler)){len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){var m;if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);console.trace()}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else{while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.listenerCount=function(emitter,type){var ret;if(!emitter._events||!emitter._events[type])ret=0;else if(isFunction(emitter._events[type]))ret=1;else ret=emitter._events[type].length;return ret};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],508:[function(require,module,exports){module.exports=require(223)},{}],509:[function(require,module,exports){require=function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({PcZj9L:[function(require,module,exports){var base64=require("base64-js");var ieee754=require("ieee754");exports.Buffer=Buffer;exports.SlowBuffer=Buffer;exports.INSPECT_MAX_BYTES=50;Buffer.poolSize=8192;var browserSupport=function(){if(typeof Uint8Array==="undefined"||typeof ArrayBuffer==="undefined"||typeof DataView==="undefined")return false;try{var arr=new Uint8Array(0);arr.foo=function(){return 42};return 42===arr.foo()}catch(e){return false}}();function Buffer(subject,encoding,noZero){if(!(this instanceof Buffer))return new Buffer(subject,encoding,noZero);var type=typeof subject;if(encoding==="base64"&&type==="string"){subject=stringtrim(subject);while(subject.length%4!==0){subject=subject+"="}}var length;if(type==="number")length=coerce(subject);else if(type==="string")length=Buffer.byteLength(subject,encoding);else if(type==="object")length=coerce(subject.length);else throw new Error("First argument needs to be a number, array or string.");var buf;if(browserSupport){buf=augment(new Uint8Array(length))}else{buf=this;buf.length=length}var i;if(Buffer.isBuffer(subject)){buf.set(subject)}else if(isArrayish(subject)){for(i=0;i<length;i++){if(Buffer.isBuffer(subject))buf[i]=subject.readUInt8(i);else buf[i]=subject[i]}}else if(type==="string"){buf.write(subject,0,encoding)}else if(type==="number"&&!browserSupport&&!noZero){for(i=0;i<length;i++){buf[i]=0}}return buf}Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":return true;default:return false}};Buffer.isBuffer=function(b){return b&&b._isBuffer};Buffer.byteLength=function(str,encoding){switch(encoding||"utf8"){case"hex":return str.length/2;case"utf8":case"utf-8":return utf8ToBytes(str).length;case"ascii":case"binary":return str.length;case"base64":return base64ToBytes(str).length;default:throw new Error("Unknown encoding")}};Buffer.concat=function(list,totalLength){if(!isArray(list)){throw new Error("Usage: Buffer.concat(list, [totalLength])\n"+"list should be an Array.")}if(list.length===0){return new Buffer(0)}else if(list.length===1){return list[0]}var i;if(typeof totalLength!=="number"){totalLength=0;for(i=0;i<list.length;i++){totalLength+=list[i].length}}var buf=new Buffer(totalLength);var pos=0;for(i=0;i<list.length;i++){var item=list[i];item.copy(buf,pos);pos+=item.length}return buf};function _hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}var strLen=string.length;if(strLen%2!==0){throw new Error("Invalid hex string")}if(length>strLen/2){length=strLen/2}for(var i=0;i<length;i++){var byte=parseInt(string.substr(i*2,2),16);if(isNaN(byte))throw new Error("Invalid hex string");buf[offset+i]=byte}Buffer._charsWritten=i*2;return i}function _utf8Write(buf,string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(utf8ToBytes(string),buf,offset,length)}function _asciiWrite(buf,string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(asciiToBytes(string),buf,offset,length)}function _binaryWrite(buf,string,offset,length){return _asciiWrite(buf,string,offset,length)}function _base64Write(buf,string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(base64ToBytes(string),buf,offset,length)}Buffer.prototype.write=function(string,offset,length,encoding){if(isFinite(offset)){if(!isFinite(length)){encoding=length;length=undefined}}else{var swap=encoding;encoding=offset;offset=length;length=swap}offset=Number(offset)||0;var remaining=this.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}encoding=String(encoding||"utf8").toLowerCase();switch(encoding){case"hex":return _hexWrite(this,string,offset,length);case"utf8":case"utf-8":return _utf8Write(this,string,offset,length);case"ascii":return _asciiWrite(this,string,offset,length);case"binary":return _binaryWrite(this,string,offset,length);case"base64":return _base64Write(this,string,offset,length);default:throw new Error("Unknown encoding")}};Buffer.prototype.toString=function(encoding,start,end){var self=this;encoding=String(encoding||"utf8").toLowerCase();start=Number(start)||0;end=end!==undefined?Number(end):end=self.length;if(end===start)return"";switch(encoding){case"hex":return _hexSlice(self,start,end);case"utf8":case"utf-8":return _utf8Slice(self,start,end);case"ascii":return _asciiSlice(self,start,end);case"binary":return _binarySlice(self,start,end);case"base64":return _base64Slice(self,start,end);default:throw new Error("Unknown encoding")}};Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};Buffer.prototype.copy=function(target,target_start,start,end){var source=this;if(!start)start=0;if(!end&&end!==0)end=this.length;if(!target_start)target_start=0;if(end===start)return;if(target.length===0||source.length===0)return;if(end<start)throw new Error("sourceEnd < sourceStart");if(target_start<0||target_start>=target.length)throw new Error("targetStart out of bounds");if(start<0||start>=source.length)throw new Error("sourceStart out of bounds");if(end<0||end>source.length)throw new Error("sourceEnd out of bounds");if(end>this.length)end=this.length;if(target.length-target_start<end-start)end=target.length-target_start+start;for(var i=0;i<end-start;i++)target[i+target_start]=this[i+start]};function _base64Slice(buf,start,end){if(start===0&&end===buf.length){return base64.fromByteArray(buf)}else{return base64.fromByteArray(buf.slice(start,end))}}function _utf8Slice(buf,start,end){var res="";var tmp="";end=Math.min(buf.length,end);for(var i=start;i<end;i++){if(buf[i]<=127){res+=decodeUtf8Char(tmp)+String.fromCharCode(buf[i]);tmp=""}else{tmp+="%"+buf[i].toString(16)}}return res+decodeUtf8Char(tmp)}function _asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;i++)ret+=String.fromCharCode(buf[i]);return ret}function _binarySlice(buf,start,end){return _asciiSlice(buf,start,end)}function _hexSlice(buf,start,end){var len=buf.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out="";for(var i=start;i<end;i++){out+=toHex(buf[i])}return out}Buffer.prototype.slice=function(start,end){var len=this.length;start=clamp(start,len,0);end=clamp(end,len,len);if(browserSupport){return augment(this.subarray(start,end))}else{var sliceLen=end-start;var newBuf=new Buffer(sliceLen,undefined,true);for(var i=0;i<sliceLen;i++){newBuf[i]=this[i+start]}return newBuf}};Buffer.prototype.readUInt8=function(offset,noAssert){var buf=this;if(!noAssert){assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"Trying to read beyond buffer length")}if(offset>=buf.length)return;return buf[offset]};function _readUInt16(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;if(browserSupport){if(offset+1<len){return buf._dataview.getUint16(offset,littleEndian)}else{var dv=new DataView(new ArrayBuffer(2));dv.setUint8(0,buf[len-1]);return dv.getUint16(0,littleEndian)}}else{var val;if(littleEndian){val=buf[offset];if(offset+1<len)val|=buf[offset+1]<<8}else{val=buf[offset]<<8;if(offset+1<len)val|=buf[offset+1]}return val}}Buffer.prototype.readUInt16LE=function(offset,noAssert){return _readUInt16(this,offset,true,noAssert)};Buffer.prototype.readUInt16BE=function(offset,noAssert){return _readUInt16(this,offset,false,noAssert)};function _readUInt32(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;if(browserSupport){if(offset+3<len){return buf._dataview.getUint32(offset,littleEndian)}else{var dv=new DataView(new ArrayBuffer(4));for(var i=0;i+offset<len;i++){dv.setUint8(i,buf[i+offset])}return dv.getUint32(0,littleEndian)}}else{var val;if(littleEndian){if(offset+2<len)val=buf[offset+2]<<16;if(offset+1<len)val|=buf[offset+1]<<8;val|=buf[offset];if(offset+3<len)val=val+(buf[offset+3]<<24>>>0)}else{if(offset+1<len)val=buf[offset+1]<<16;if(offset+2<len)val|=buf[offset+2]<<8;if(offset+3<len)val|=buf[offset+3];val=val+(buf[offset]<<24>>>0)}return val}}Buffer.prototype.readUInt32LE=function(offset,noAssert){return _readUInt32(this,offset,true,noAssert)};Buffer.prototype.readUInt32BE=function(offset,noAssert){return _readUInt32(this,offset,false,noAssert)};Buffer.prototype.readInt8=function(offset,noAssert){var buf=this;if(!noAssert){assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"Trying to read beyond buffer length")}if(offset>=buf.length)return;if(browserSupport){return buf._dataview.getInt8(offset)}else{var neg=buf[offset]&128;if(neg)return(255-buf[offset]+1)*-1;else return buf[offset]}};function _readInt16(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;if(browserSupport){if(offset+1===len){var dv=new DataView(new ArrayBuffer(2));dv.setUint8(0,buf[len-1]);return dv.getInt16(0,littleEndian)}else{return buf._dataview.getInt16(offset,littleEndian)}}else{var val=_readUInt16(buf,offset,littleEndian,true);var neg=val&32768;if(neg)return(65535-val+1)*-1;else return val}}Buffer.prototype.readInt16LE=function(offset,noAssert){return _readInt16(this,offset,true,noAssert)};Buffer.prototype.readInt16BE=function(offset,noAssert){return _readInt16(this,offset,false,noAssert)};function _readInt32(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;if(browserSupport){if(offset+3>=len){var dv=new DataView(new ArrayBuffer(4));for(var i=0;i+offset<len;i++){dv.setUint8(i,buf[i+offset])}return dv.getInt32(0,littleEndian)}else{return buf._dataview.getInt32(offset,littleEndian)}}else{var val=_readUInt32(buf,offset,littleEndian,true);var neg=val&2147483648;if(neg)return(4294967295-val+1)*-1;else return val}}Buffer.prototype.readInt32LE=function(offset,noAssert){return _readInt32(this,offset,true,noAssert)};Buffer.prototype.readInt32BE=function(offset,noAssert){return _readInt32(this,offset,false,noAssert)};function _readFloat(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset+3<buf.length,"Trying to read beyond buffer length")}if(browserSupport){return buf._dataview.getFloat32(offset,littleEndian)}else{return ieee754.read(buf,offset,littleEndian,23,4)}}Buffer.prototype.readFloatLE=function(offset,noAssert){return _readFloat(this,offset,true,noAssert)};Buffer.prototype.readFloatBE=function(offset,noAssert){return _readFloat(this,offset,false,noAssert)};function _readDouble(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset+7<buf.length,"Trying to read beyond buffer length")}if(browserSupport){return buf._dataview.getFloat64(offset,littleEndian)}else{return ieee754.read(buf,offset,littleEndian,52,8)}}Buffer.prototype.readDoubleLE=function(offset,noAssert){return _readDouble(this,offset,true,noAssert)};Buffer.prototype.readDoubleBE=function(offset,noAssert){return _readDouble(this,offset,false,noAssert)};Buffer.prototype.writeUInt8=function(value,offset,noAssert){var buf=this;if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"trying to write beyond buffer length");verifuint(value,255)
}if(offset>=buf.length)return;buf[offset]=value};function _writeUInt16(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"trying to write beyond buffer length");verifuint(value,65535)}var len=buf.length;if(offset>=len)return;if(browserSupport){if(offset+1===len){var dv=new DataView(new ArrayBuffer(2));dv.setUint16(0,value,littleEndian);buf[offset]=dv.getUint8(0)}else{buf._dataview.setUint16(offset,value,littleEndian)}}else{for(var i=0,j=Math.min(len-offset,2);i<j;i++){buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>(littleEndian?i:1-i)*8}}}Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){_writeUInt16(this,value,offset,true,noAssert)};Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){_writeUInt16(this,value,offset,false,noAssert)};function _writeUInt32(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"trying to write beyond buffer length");verifuint(value,4294967295)}var len=buf.length;if(offset>=len)return;var i;if(browserSupport){if(offset+3>=len){var dv=new DataView(new ArrayBuffer(4));dv.setUint32(0,value,littleEndian);for(i=0;i+offset<len;i++){buf[i+offset]=dv.getUint8(i)}}else{buf._dataview.setUint32(offset,value,littleEndian)}}else{for(i=0,j=Math.min(len-offset,4);i<j;i++){buf[offset+i]=value>>>(littleEndian?i:3-i)*8&255}}}Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){_writeUInt32(this,value,offset,true,noAssert)};Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){_writeUInt32(this,value,offset,false,noAssert)};Buffer.prototype.writeInt8=function(value,offset,noAssert){var buf=this;if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"Trying to write beyond buffer length");verifsint(value,127,-128)}if(offset>=buf.length)return;if(browserSupport){buf._dataview.setInt8(offset,value)}else{if(value>=0)buf.writeUInt8(value,offset,noAssert);else buf.writeUInt8(255+value+1,offset,noAssert)}};function _writeInt16(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to write beyond buffer length");verifsint(value,32767,-32768)}var len=buf.length;if(offset>=len)return;if(browserSupport){if(offset+1===len){var dv=new DataView(new ArrayBuffer(2));dv.setInt16(0,value,littleEndian);buf[offset]=dv.getUint8(0)}else{buf._dataview.setInt16(offset,value,littleEndian)}}else{if(value>=0)_writeUInt16(buf,value,offset,littleEndian,noAssert);else _writeUInt16(buf,65535+value+1,offset,littleEndian,noAssert)}}Buffer.prototype.writeInt16LE=function(value,offset,noAssert){_writeInt16(this,value,offset,true,noAssert)};Buffer.prototype.writeInt16BE=function(value,offset,noAssert){_writeInt16(this,value,offset,false,noAssert)};function _writeInt32(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to write beyond buffer length");verifsint(value,2147483647,-2147483648)}var len=buf.length;if(offset>=len)return;if(browserSupport){if(offset+3>=len){var dv=new DataView(new ArrayBuffer(4));dv.setInt32(0,value,littleEndian);for(var i=0;i+offset<len;i++){buf[i+offset]=dv.getUint8(i)}}else{buf._dataview.setInt32(offset,value,littleEndian)}}else{if(value>=0)_writeUInt32(buf,value,offset,littleEndian,noAssert);else _writeUInt32(buf,4294967295+value+1,offset,littleEndian,noAssert)}}Buffer.prototype.writeInt32LE=function(value,offset,noAssert){_writeInt32(this,value,offset,true,noAssert)};Buffer.prototype.writeInt32BE=function(value,offset,noAssert){_writeInt32(this,value,offset,false,noAssert)};function _writeFloat(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to write beyond buffer length");verifIEEE754(value,3.4028234663852886e38,-3.4028234663852886e38)}var len=buf.length;if(offset>=len)return;if(browserSupport){if(offset+3>=len){var dv=new DataView(new ArrayBuffer(4));dv.setFloat32(0,value,littleEndian);for(var i=0;i+offset<len;i++){buf[i+offset]=dv.getUint8(i)}}else{buf._dataview.setFloat32(offset,value,littleEndian)}}else{ieee754.write(buf,value,offset,littleEndian,23,4)}}Buffer.prototype.writeFloatLE=function(value,offset,noAssert){_writeFloat(this,value,offset,true,noAssert)};Buffer.prototype.writeFloatBE=function(value,offset,noAssert){_writeFloat(this,value,offset,false,noAssert)};function _writeDouble(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+7<buf.length,"Trying to write beyond buffer length");verifIEEE754(value,1.7976931348623157e308,-1.7976931348623157e308)}var len=buf.length;if(offset>=len)return;if(browserSupport){if(offset+7>=len){var dv=new DataView(new ArrayBuffer(8));dv.setFloat64(0,value,littleEndian);for(var i=0;i+offset<len;i++){buf[i+offset]=dv.getUint8(i)}}else{buf._dataview.setFloat64(offset,value,littleEndian)}}else{ieee754.write(buf,value,offset,littleEndian,52,8)}}Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){_writeDouble(this,value,offset,true,noAssert)};Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){_writeDouble(this,value,offset,false,noAssert)};Buffer.prototype.fill=function(value,start,end){if(!value)value=0;if(!start)start=0;if(!end)end=this.length;if(typeof value==="string"){value=value.charCodeAt(0)}if(typeof value!=="number"||isNaN(value)){throw new Error("value is not a number")}if(end<start)throw new Error("end < start");if(end===start)return;if(this.length===0)return;if(start<0||start>=this.length){throw new Error("start out of bounds")}if(end<0||end>this.length){throw new Error("end out of bounds")}for(var i=start;i<end;i++){this[i]=value}};Buffer.prototype.inspect=function(){var out=[];var len=this.length;for(var i=0;i<len;i++){out[i]=toHex(this[i]);if(i===exports.INSPECT_MAX_BYTES){out[i+1]="...";break}}return"<Buffer "+out.join(" ")+">"};function BufferToArrayBuffer(){return new Buffer(this).buffer}function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")}var BP=Buffer.prototype;function augment(arr){arr._isBuffer=true;arr.write=BP.write;arr.toString=BP.toString;arr.toLocaleString=BP.toString;arr.toJSON=BP.toJSON;arr.copy=BP.copy;arr.slice=BP.slice;arr.readUInt8=BP.readUInt8;arr.readUInt16LE=BP.readUInt16LE;arr.readUInt16BE=BP.readUInt16BE;arr.readUInt32LE=BP.readUInt32LE;arr.readUInt32BE=BP.readUInt32BE;arr.readInt8=BP.readInt8;arr.readInt16LE=BP.readInt16LE;arr.readInt16BE=BP.readInt16BE;arr.readInt32LE=BP.readInt32LE;arr.readInt32BE=BP.readInt32BE;arr.readFloatLE=BP.readFloatLE;arr.readFloatBE=BP.readFloatBE;arr.readDoubleLE=BP.readDoubleLE;arr.readDoubleBE=BP.readDoubleBE;arr.writeUInt8=BP.writeUInt8;arr.writeUInt16LE=BP.writeUInt16LE;arr.writeUInt16BE=BP.writeUInt16BE;arr.writeUInt32LE=BP.writeUInt32LE;arr.writeUInt32BE=BP.writeUInt32BE;arr.writeInt8=BP.writeInt8;arr.writeInt16LE=BP.writeInt16LE;arr.writeInt16BE=BP.writeInt16BE;arr.writeInt32LE=BP.writeInt32LE;arr.writeInt32BE=BP.writeInt32BE;arr.writeFloatLE=BP.writeFloatLE;arr.writeFloatBE=BP.writeFloatBE;arr.writeDoubleLE=BP.writeDoubleLE;arr.writeDoubleBE=BP.writeDoubleBE;arr.fill=BP.fill;arr.inspect=BP.inspect;arr.toArrayBuffer=BufferToArrayBuffer;if(arr.byteLength!==0)arr._dataview=new DataView(arr.buffer,arr.byteOffset,arr.byteLength);return arr}function clamp(index,len,defaultValue){if(typeof index!=="number")return defaultValue;index=~~index;if(index>=len)return len;if(index>=0)return index;index+=len;if(index>=0)return index;return 0}function coerce(length){length=~~Math.ceil(+length);return length<0?0:length}function isArray(subject){return(Array.isArray||function(subject){return Object.prototype.toString.call(subject)==="[object Array]"})(subject)}function isArrayish(subject){return isArray(subject)||Buffer.isBuffer(subject)||subject&&typeof subject==="object"&&typeof subject.length==="number"}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++)if(str.charCodeAt(i)<=127)byteArray.push(str.charCodeAt(i));else{var h=encodeURIComponent(str.charAt(i)).substr(1).split("%");for(var j=0;j<h.length;j++)byteArray.push(parseInt(h[j],16))}return byteArray}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++){byteArray.push(str.charCodeAt(i)&255)}return byteArray}function base64ToBytes(str){return base64.toByteArray(str)}function blitBuffer(src,dst,offset,length){var pos;for(var i=0;i<length;i++){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i]}return i}function decodeUtf8Char(str){try{return decodeURIComponent(str)}catch(err){return String.fromCharCode(65533)}}function verifuint(value,max){assert(typeof value=="number","cannot write a non-number as a number");assert(value>=0,"specified a negative value for writing an unsigned value");assert(value<=max,"value is larger than maximum value for type");assert(Math.floor(value)===value,"value has a fractional component")}function verifsint(value,max,min){assert(typeof value=="number","cannot write a non-number as a number");assert(value<=max,"value larger than maximum allowed value");assert(value>=min,"value smaller than minimum allowed value");assert(Math.floor(value)===value,"value has a fractional component")}function verifIEEE754(value,max,min){assert(typeof value=="number","cannot write a non-number as a number");assert(value<=max,"value larger than maximum allowed value");assert(value>=min,"value smaller than minimum allowed value")}function assert(test,message){if(!test)throw new Error(message||"Failed assertion")}},{"base64-js":3,ieee754:4}],"native-buffer-browserify":[function(require,module,exports){module.exports=require("PcZj9L")},{}],3:[function(require,module,exports){(function(exports){"use strict";var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function b64ToByteArray(b64){var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0){throw"Invalid string. Length must be a multiple of 4"}placeHolders=indexOf(b64,"=");placeHolders=placeHolders>0?b64.length-placeHolders:0;arr=[];l=placeHolders>0?b64.length-4:b64.length;for(i=0,j=0;i<l;i+=4,j+=3){tmp=indexOf(lookup,b64.charAt(i))<<18|indexOf(lookup,b64.charAt(i+1))<<12|indexOf(lookup,b64.charAt(i+2))<<6|indexOf(lookup,b64.charAt(i+3));arr.push((tmp&16711680)>>16);arr.push((tmp&65280)>>8);arr.push(tmp&255)}if(placeHolders===2){tmp=indexOf(lookup,b64.charAt(i))<<2|indexOf(lookup,b64.charAt(i+1))>>4;arr.push(tmp&255)}else if(placeHolders===1){tmp=indexOf(lookup,b64.charAt(i))<<10|indexOf(lookup,b64.charAt(i+1))<<4|indexOf(lookup,b64.charAt(i+2))>>2;arr.push(tmp>>8&255);arr.push(tmp&255)}return arr}function uint8ToBase64(uint8){var i,extraBytes=uint8.length%3,output="",temp,length;function tripletToBase64(num){return lookup.charAt(num>>18&63)+lookup.charAt(num>>12&63)+lookup.charAt(num>>6&63)+lookup.charAt(num&63)}for(i=0,length=uint8.length-extraBytes;i<length;i+=3){temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2];output+=tripletToBase64(temp)}switch(extraBytes){case 1:temp=uint8[uint8.length-1];output+=lookup.charAt(temp>>2);output+=lookup.charAt(temp<<4&63);output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1];output+=lookup.charAt(temp>>10);output+=lookup.charAt(temp>>4&63);output+=lookup.charAt(temp<<2&63);output+="=";break}return output}module.exports.toByteArray=b64ToByteArray;module.exports.fromByteArray=uint8ToBase64})();function indexOf(arr,elt){var len=arr.length;var from=Number(arguments[1])||0;from=from<0?Math.ceil(from):Math.floor(from);if(from<0)from+=len;for(;from<len;from++){if(typeof arr==="string"&&arr.charAt(from)===elt||typeof arr!=="string"&&arr[from]===elt){return from}}return-1}},{}],4:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8);m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8);if(e===0){e=1-eBias}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity}else{m=m+Math.pow(2,mLen);e=e-eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)};exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2}if(e+eBias>=1){value+=rt/c}else{value+=rt*Math.pow(2,1-eBias)}if(value*c>=2){e++;c/=2}if(e+eBias>=eMax){m=0;e=eMax}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0}}for(;mLen>=8;buffer[offset+i]=m&255,i+=d,m/=256,mLen-=8);e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&255,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=s*128}},{}]},{},[]);module.exports=require("native-buffer-browserify").Buffer},{}],510:[function(require,module,exports){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}if(canPost){var queue=[];window.addEventListener("message",function(ev){var source=ev.source;if((source===window||source===null)&&ev.data==="process-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("process-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}],511:[function(require,module,exports){var base64=require("base64-js");var ieee754=require("ieee754");exports.Buffer=Buffer;exports.SlowBuffer=Buffer;exports.INSPECT_MAX_BYTES=50;Buffer.poolSize=8192;Buffer._useTypedArrays=function(){if(typeof Uint8Array==="undefined"||typeof ArrayBuffer==="undefined")return false;try{var arr=new Uint8Array(0);arr.foo=function(){return 42};return 42===arr.foo()&&typeof arr.subarray==="function"}catch(e){return false}}();function Buffer(subject,encoding,noZero){if(!(this instanceof Buffer))return new Buffer(subject,encoding,noZero);var type=typeof subject;if(encoding==="base64"&&type==="string"){subject=stringtrim(subject);while(subject.length%4!==0){subject=subject+"="}}var length;if(type==="number")length=coerce(subject);else if(type==="string")length=Buffer.byteLength(subject,encoding);else if(type==="object")length=coerce(subject.length);else throw new Error("First argument needs to be a number, array or string.");var buf;if(Buffer._useTypedArrays){buf=augment(new Uint8Array(length))}else{buf=this;buf.length=length}var i;if(Buffer.isBuffer(subject)){buf.set(subject)}else if(isArrayish(subject)){for(i=0;i<length;i++){if(Buffer.isBuffer(subject))buf[i]=subject.readUInt8(i);else buf[i]=subject[i]}}else if(type==="string"){buf.write(subject,0,encoding)}else if(type==="number"&&!Buffer._useTypedArrays&&!noZero){for(i=0;i<length;i++){buf[i]=0}}return buf}Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":return true;default:return false}};Buffer.isBuffer=function(b){return b&&b._isBuffer};Buffer.byteLength=function(str,encoding){switch(encoding||"utf8"){case"hex":return str.length/2;case"utf8":case"utf-8":return utf8ToBytes(str).length;case"ascii":case"binary":return str.length;case"base64":return base64ToBytes(str).length;default:throw new Error("Unknown encoding")}};Buffer.concat=function(list,totalLength){assert(isArray(list),"Usage: Buffer.concat(list, [totalLength])\n"+"list should be an Array.");if(list.length===0){return new Buffer(0)}else if(list.length===1){return list[0]}var i;if(typeof totalLength!=="number"){totalLength=0;for(i=0;i<list.length;i++){totalLength+=list[i].length}}var buf=new Buffer(totalLength);var pos=0;for(i=0;i<list.length;i++){var item=list[i];item.copy(buf,pos);pos+=item.length}return buf};function _hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}var strLen=string.length;assert(strLen%2===0,"Invalid hex string");if(length>strLen/2){length=strLen/2}for(var i=0;i<length;i++){var byte=parseInt(string.substr(i*2,2),16);assert(!isNaN(byte),"Invalid hex string");buf[offset+i]=byte}Buffer._charsWritten=i*2;return i}function _utf8Write(buf,string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(utf8ToBytes(string),buf,offset,length)}function _asciiWrite(buf,string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(asciiToBytes(string),buf,offset,length)}function _binaryWrite(buf,string,offset,length){return _asciiWrite(buf,string,offset,length)}function _base64Write(buf,string,offset,length){var bytes,pos;return Buffer._charsWritten=blitBuffer(base64ToBytes(string),buf,offset,length)}Buffer.prototype.write=function(string,offset,length,encoding){if(isFinite(offset)){if(!isFinite(length)){encoding=length;length=undefined}}else{var swap=encoding;encoding=offset;offset=length;length=swap}offset=Number(offset)||0;var remaining=this.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}encoding=String(encoding||"utf8").toLowerCase();switch(encoding){case"hex":return _hexWrite(this,string,offset,length);case"utf8":case"utf-8":return _utf8Write(this,string,offset,length);case"ascii":return _asciiWrite(this,string,offset,length);case"binary":return _binaryWrite(this,string,offset,length);case"base64":return _base64Write(this,string,offset,length);default:throw new Error("Unknown encoding")}};Buffer.prototype.toString=function(encoding,start,end){var self=this;encoding=String(encoding||"utf8").toLowerCase();start=Number(start)||0;end=end!==undefined?Number(end):end=self.length;if(end===start)return"";switch(encoding){case"hex":return _hexSlice(self,start,end);case"utf8":case"utf-8":return _utf8Slice(self,start,end);case"ascii":return _asciiSlice(self,start,end);case"binary":return _binarySlice(self,start,end);case"base64":return _base64Slice(self,start,end);default:throw new Error("Unknown encoding")}};Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};Buffer.prototype.copy=function(target,target_start,start,end){var source=this;if(!start)start=0;if(!end&&end!==0)end=this.length;if(!target_start)target_start=0;if(end===start)return;if(target.length===0||source.length===0)return;assert(end>=start,"sourceEnd < sourceStart");assert(target_start>=0&&target_start<target.length,"targetStart out of bounds");assert(start>=0&&start<source.length,"sourceStart out of bounds");assert(end>=0&&end<=source.length,"sourceEnd out of bounds");if(end>this.length)end=this.length;if(target.length-target_start<end-start)end=target.length-target_start+start;for(var i=0;i<end-start;i++)target[i+target_start]=this[i+start]};function _base64Slice(buf,start,end){if(start===0&&end===buf.length){return base64.fromByteArray(buf)}else{return base64.fromByteArray(buf.slice(start,end))}}function _utf8Slice(buf,start,end){var res="";var tmp="";end=Math.min(buf.length,end);for(var i=start;i<end;i++){if(buf[i]<=127){res+=decodeUtf8Char(tmp)+String.fromCharCode(buf[i]);tmp=""}else{tmp+="%"+buf[i].toString(16)}}return res+decodeUtf8Char(tmp)}function _asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;i++)ret+=String.fromCharCode(buf[i]);return ret}function _binarySlice(buf,start,end){return _asciiSlice(buf,start,end)}function _hexSlice(buf,start,end){var len=buf.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out="";for(var i=start;i<end;i++){out+=toHex(buf[i])}return out}Buffer.prototype.slice=function(start,end){var len=this.length;start=clamp(start,len,0);end=clamp(end,len,len);if(Buffer._useTypedArrays){return augment(this.subarray(start,end))}else{var sliceLen=end-start;var newBuf=new Buffer(sliceLen,undefined,true);for(var i=0;i<sliceLen;i++){newBuf[i]=this[i+start]}return newBuf}};Buffer.prototype.readUInt8=function(offset,noAssert){var buf=this;if(!noAssert){assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"Trying to read beyond buffer length")}if(offset>=buf.length)return;return buf[offset]};function _readUInt16(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val;if(littleEndian){val=buf[offset];if(offset+1<len)val|=buf[offset+1]<<8}else{val=buf[offset]<<8;if(offset+1<len)val|=buf[offset+1]}return val}Buffer.prototype.readUInt16LE=function(offset,noAssert){return _readUInt16(this,offset,true,noAssert)};Buffer.prototype.readUInt16BE=function(offset,noAssert){return _readUInt16(this,offset,false,noAssert)};function _readUInt32(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val;if(littleEndian){if(offset+2<len)val=buf[offset+2]<<16;if(offset+1<len)val|=buf[offset+1]<<8;val|=buf[offset];if(offset+3<len)val=val+(buf[offset+3]<<24>>>0)}else{if(offset+1<len)val=buf[offset+1]<<16;if(offset+2<len)val|=buf[offset+2]<<8;if(offset+3<len)val|=buf[offset+3];val=val+(buf[offset]<<24>>>0)}return val}Buffer.prototype.readUInt32LE=function(offset,noAssert){return _readUInt32(this,offset,true,noAssert)};Buffer.prototype.readUInt32BE=function(offset,noAssert){return _readUInt32(this,offset,false,noAssert)};Buffer.prototype.readInt8=function(offset,noAssert){var buf=this;if(!noAssert){assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"Trying to read beyond buffer length")}if(offset>=buf.length)return;var neg=buf[offset]&128;if(neg)return(255-buf[offset]+1)*-1;else return buf[offset]};function _readInt16(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val=_readUInt16(buf,offset,littleEndian,true);var neg=val&32768;if(neg)return(65535-val+1)*-1;else return val}Buffer.prototype.readInt16LE=function(offset,noAssert){return _readInt16(this,offset,true,noAssert)};Buffer.prototype.readInt16BE=function(offset,noAssert){return _readInt16(this,offset,false,noAssert)};function _readInt32(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val=_readUInt32(buf,offset,littleEndian,true);var neg=val&2147483648;if(neg)return(4294967295-val+1)*-1;else return val}Buffer.prototype.readInt32LE=function(offset,noAssert){return _readInt32(this,offset,true,noAssert)};Buffer.prototype.readInt32BE=function(offset,noAssert){return _readInt32(this,offset,false,noAssert)};function _readFloat(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset+3<buf.length,"Trying to read beyond buffer length")}return ieee754.read(buf,offset,littleEndian,23,4)}Buffer.prototype.readFloatLE=function(offset,noAssert){return _readFloat(this,offset,true,noAssert)};Buffer.prototype.readFloatBE=function(offset,noAssert){return _readFloat(this,offset,false,noAssert)};function _readDouble(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset+7<buf.length,"Trying to read beyond buffer length")}return ieee754.read(buf,offset,littleEndian,52,8)}Buffer.prototype.readDoubleLE=function(offset,noAssert){return _readDouble(this,offset,true,noAssert)};Buffer.prototype.readDoubleBE=function(offset,noAssert){return _readDouble(this,offset,false,noAssert)};Buffer.prototype.writeUInt8=function(value,offset,noAssert){var buf=this;if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"trying to write beyond buffer length");verifuint(value,255)}if(offset>=buf.length)return;buf[offset]=value};function _writeUInt16(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"trying to write beyond buffer length");verifuint(value,65535)}var len=buf.length;if(offset>=len)return;for(var i=0,j=Math.min(len-offset,2);i<j;i++){buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>(littleEndian?i:1-i)*8}}Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){_writeUInt16(this,value,offset,true,noAssert)};Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){_writeUInt16(this,value,offset,false,noAssert)};function _writeUInt32(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"trying to write beyond buffer length");verifuint(value,4294967295)}var len=buf.length;if(offset>=len)return;for(var i=0,j=Math.min(len-offset,4);i<j;i++){buf[offset+i]=value>>>(littleEndian?i:3-i)*8&255}}Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){_writeUInt32(this,value,offset,true,noAssert)};Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){_writeUInt32(this,value,offset,false,noAssert)};Buffer.prototype.writeInt8=function(value,offset,noAssert){var buf=this;if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<buf.length,"Trying to write beyond buffer length");verifsint(value,127,-128)}if(offset>=buf.length)return;if(value>=0)buf.writeUInt8(value,offset,noAssert);else buf.writeUInt8(255+value+1,offset,noAssert)};function _writeInt16(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to write beyond buffer length");verifsint(value,32767,-32768)}var len=buf.length;if(offset>=len)return;if(value>=0)_writeUInt16(buf,value,offset,littleEndian,noAssert);else _writeUInt16(buf,65535+value+1,offset,littleEndian,noAssert)}Buffer.prototype.writeInt16LE=function(value,offset,noAssert){_writeInt16(this,value,offset,true,noAssert)};Buffer.prototype.writeInt16BE=function(value,offset,noAssert){_writeInt16(this,value,offset,false,noAssert)};function _writeInt32(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to write beyond buffer length");verifsint(value,2147483647,-2147483648)}var len=buf.length;if(offset>=len)return;if(value>=0)_writeUInt32(buf,value,offset,littleEndian,noAssert);else _writeUInt32(buf,4294967295+value+1,offset,littleEndian,noAssert)}Buffer.prototype.writeInt32LE=function(value,offset,noAssert){_writeInt32(this,value,offset,true,noAssert)};Buffer.prototype.writeInt32BE=function(value,offset,noAssert){_writeInt32(this,value,offset,false,noAssert)};function _writeFloat(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to write beyond buffer length");verifIEEE754(value,3.4028234663852886e38,-3.4028234663852886e38)}var len=buf.length;if(offset>=len)return;ieee754.write(buf,value,offset,littleEndian,23,4)}Buffer.prototype.writeFloatLE=function(value,offset,noAssert){_writeFloat(this,value,offset,true,noAssert)};Buffer.prototype.writeFloatBE=function(value,offset,noAssert){_writeFloat(this,value,offset,false,noAssert)};function _writeDouble(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+7<buf.length,"Trying to write beyond buffer length");verifIEEE754(value,1.7976931348623157e308,-1.7976931348623157e308)}var len=buf.length;if(offset>=len)return;ieee754.write(buf,value,offset,littleEndian,52,8)}Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){_writeDouble(this,value,offset,true,noAssert)};Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){_writeDouble(this,value,offset,false,noAssert)};Buffer.prototype.fill=function(value,start,end){if(!value)value=0;if(!start)start=0;if(!end)end=this.length;if(typeof value==="string"){value=value.charCodeAt(0)}assert(typeof value==="number"&&!isNaN(value),"value is not a number");assert(end>=start,"end < start");if(end===start)return;if(this.length===0)return;assert(start>=0&&start<this.length,"start out of bounds");assert(end>=0&&end<=this.length,"end out of bounds");for(var i=start;i<end;i++){this[i]=value}};Buffer.prototype.inspect=function(){var out=[];var len=this.length;for(var i=0;i<len;i++){out[i]=toHex(this[i]);if(i===exports.INSPECT_MAX_BYTES){out[i+1]="...";break}}return"<Buffer "+out.join(" ")+">"};function BufferToArrayBuffer(){return new Buffer(this).buffer}function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")}var BP=Buffer.prototype;function augment(arr){arr._isBuffer=true;arr.write=BP.write;arr.toString=BP.toString;arr.toLocaleString=BP.toString;
arr.toJSON=BP.toJSON;arr.copy=BP.copy;arr.slice=BP.slice;arr.readUInt8=BP.readUInt8;arr.readUInt16LE=BP.readUInt16LE;arr.readUInt16BE=BP.readUInt16BE;arr.readUInt32LE=BP.readUInt32LE;arr.readUInt32BE=BP.readUInt32BE;arr.readInt8=BP.readInt8;arr.readInt16LE=BP.readInt16LE;arr.readInt16BE=BP.readInt16BE;arr.readInt32LE=BP.readInt32LE;arr.readInt32BE=BP.readInt32BE;arr.readFloatLE=BP.readFloatLE;arr.readFloatBE=BP.readFloatBE;arr.readDoubleLE=BP.readDoubleLE;arr.readDoubleBE=BP.readDoubleBE;arr.writeUInt8=BP.writeUInt8;arr.writeUInt16LE=BP.writeUInt16LE;arr.writeUInt16BE=BP.writeUInt16BE;arr.writeUInt32LE=BP.writeUInt32LE;arr.writeUInt32BE=BP.writeUInt32BE;arr.writeInt8=BP.writeInt8;arr.writeInt16LE=BP.writeInt16LE;arr.writeInt16BE=BP.writeInt16BE;arr.writeInt32LE=BP.writeInt32LE;arr.writeInt32BE=BP.writeInt32BE;arr.writeFloatLE=BP.writeFloatLE;arr.writeFloatBE=BP.writeFloatBE;arr.writeDoubleLE=BP.writeDoubleLE;arr.writeDoubleBE=BP.writeDoubleBE;arr.fill=BP.fill;arr.inspect=BP.inspect;arr.toArrayBuffer=BufferToArrayBuffer;return arr}function clamp(index,len,defaultValue){if(typeof index!=="number")return defaultValue;index=~~index;if(index>=len)return len;if(index>=0)return index;index+=len;if(index>=0)return index;return 0}function coerce(length){length=~~Math.ceil(+length);return length<0?0:length}function isArray(subject){return(Array.isArray||function(subject){return Object.prototype.toString.call(subject)==="[object Array]"})(subject)}function isArrayish(subject){return isArray(subject)||Buffer.isBuffer(subject)||subject&&typeof subject==="object"&&typeof subject.length==="number"}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++)if(str.charCodeAt(i)<=127)byteArray.push(str.charCodeAt(i));else{var h=encodeURIComponent(str.charAt(i)).substr(1).split("%");for(var j=0;j<h.length;j++)byteArray.push(parseInt(h[j],16))}return byteArray}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++){byteArray.push(str.charCodeAt(i)&255)}return byteArray}function base64ToBytes(str){return base64.toByteArray(str)}function blitBuffer(src,dst,offset,length){var pos;for(var i=0;i<length;i++){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i]}return i}function decodeUtf8Char(str){try{return decodeURIComponent(str)}catch(err){return String.fromCharCode(65533)}}function verifuint(value,max){assert(typeof value=="number","cannot write a non-number as a number");assert(value>=0,"specified a negative value for writing an unsigned value");assert(value<=max,"value is larger than maximum value for type");assert(Math.floor(value)===value,"value has a fractional component")}function verifsint(value,max,min){assert(typeof value=="number","cannot write a non-number as a number");assert(value<=max,"value larger than maximum allowed value");assert(value>=min,"value smaller than minimum allowed value");assert(Math.floor(value)===value,"value has a fractional component")}function verifIEEE754(value,max,min){assert(typeof value=="number","cannot write a non-number as a number");assert(value<=max,"value larger than maximum allowed value");assert(value>=min,"value smaller than minimum allowed value")}function assert(test,message){if(!test)throw new Error(message||"Failed assertion")}},{"base64-js":512,ieee754:513}],512:[function(require,module,exports){var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";(function(exports){"use strict";var Arr=typeof Uint8Array!=="undefined"?Uint8Array:Array;var ZERO="0".charCodeAt(0);var PLUS="+".charCodeAt(0);var SLASH="/".charCodeAt(0);var NUMBER="0".charCodeAt(0);var LOWER="a".charCodeAt(0);var UPPER="A".charCodeAt(0);function decode(elt){var code=elt.charCodeAt(0);if(code===PLUS)return 62;if(code===SLASH)return 63;if(code<NUMBER)return-1;if(code<NUMBER+10)return code-NUMBER+26+26;if(code<UPPER+26)return code-UPPER;if(code<LOWER+26)return code-LOWER+26}function b64ToByteArray(b64){var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0){throw"Invalid string. Length must be a multiple of 4"}var len=b64.length;placeHolders="="===b64.charAt(len-2)?2:"="===b64.charAt(len-1)?1:0;arr=new Arr(b64.length*3/4-placeHolders);l=placeHolders>0?b64.length-4:b64.length;var L=0;function push(v){arr[L++]=v}for(i=0,j=0;i<l;i+=4,j+=3){tmp=decode(b64.charAt(i))<<18|decode(b64.charAt(i+1))<<12|decode(b64.charAt(i+2))<<6|decode(b64.charAt(i+3));push((tmp&16711680)>>16);push((tmp&65280)>>8);push(tmp&255)}if(placeHolders===2){tmp=decode(b64.charAt(i))<<2|decode(b64.charAt(i+1))>>4;push(tmp&255)}else if(placeHolders===1){tmp=decode(b64.charAt(i))<<10|decode(b64.charAt(i+1))<<4|decode(b64.charAt(i+2))>>2;push(tmp>>8&255);push(tmp&255)}return arr}function uint8ToBase64(uint8){var i,extraBytes=uint8.length%3,output="",temp,length;function encode(num){return lookup.charAt(num)}function tripletToBase64(num){return encode(num>>18&63)+encode(num>>12&63)+encode(num>>6&63)+encode(num&63)}for(i=0,length=uint8.length-extraBytes;i<length;i+=3){temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2];output+=tripletToBase64(temp)}switch(extraBytes){case 1:temp=uint8[uint8.length-1];output+=encode(temp>>2);output+=encode(temp<<4&63);output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1];output+=encode(temp>>10);output+=encode(temp>>4&63);output+=encode(temp<<2&63);output+="=";break}return output}module.exports.toByteArray=b64ToByteArray;module.exports.fromByteArray=uint8ToBase64})()},{}],513:[function(require,module,exports){module.exports=require(7)},{}],514:[function(require,module,exports){var process=require("__browserify_process");function normalizeArray(parts,allowAboveRoot){var up=0;for(var i=parts.length-1;i>=0;i--){var last=parts[i];if(last==="."){parts.splice(i,1)}else if(last===".."){parts.splice(i,1);up++}else if(up){parts.splice(i,1);up--}}if(allowAboveRoot){for(;up--;up){parts.unshift("..")}}return parts}var splitPathRe=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;var splitPath=function(filename){return splitPathRe.exec(filename).slice(1)};exports.resolve=function(){var resolvedPath="",resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1&&!resolvedAbsolute;i--){var path=i>=0?arguments[i]:process.cwd();if(typeof path!=="string"){throw new TypeError("Arguments to path.resolve must be strings")}else if(!path){continue}resolvedPath=path+"/"+resolvedPath;resolvedAbsolute=path.charAt(0)==="/"}resolvedPath=normalizeArray(filter(resolvedPath.split("/"),function(p){return!!p}),!resolvedAbsolute).join("/");return(resolvedAbsolute?"/":"")+resolvedPath||"."};exports.normalize=function(path){var isAbsolute=exports.isAbsolute(path),trailingSlash=substr(path,-1)==="/";path=normalizeArray(filter(path.split("/"),function(p){return!!p}),!isAbsolute).join("/");if(!path&&!isAbsolute){path="."}if(path&&trailingSlash){path+="/"}return(isAbsolute?"/":"")+path};exports.isAbsolute=function(path){return path.charAt(0)==="/"};exports.join=function(){var paths=Array.prototype.slice.call(arguments,0);return exports.normalize(filter(paths,function(p,index){if(typeof p!=="string"){throw new TypeError("Arguments to path.join must be strings")}return p}).join("/"))};exports.relative=function(from,to){from=exports.resolve(from).substr(1);to=exports.resolve(to).substr(1);function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=="")break}var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=="")break}if(start>end)return[];return arr.slice(start,end-start+1)}var fromParts=trim(from.split("/"));var toParts=trim(to.split("/"));var length=Math.min(fromParts.length,toParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(fromParts[i]!==toParts[i]){samePartsLength=i;break}}var outputParts=[];for(var i=samePartsLength;i<fromParts.length;i++){outputParts.push("..")}outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join("/")};exports.sep="/";exports.delimiter=":";exports.dirname=function(path){var result=splitPath(path),root=result[0],dir=result[1];if(!root&&!dir){return"."}if(dir){dir=dir.substr(0,dir.length-1)}return root+dir};exports.basename=function(path,ext){var f=splitPath(path)[2];if(ext&&f.substr(-1*ext.length)===ext){f=f.substr(0,f.length-ext.length)}return f};exports.extname=function(path){return splitPath(path)[3]};function filter(xs,f){if(xs.filter)return xs.filter(f);var res=[];for(var i=0;i<xs.length;i++){if(f(xs[i],i,xs))res.push(xs[i])}return res}var substr="ab".substr(-1)==="b"?function(str,start,len){return str.substr(start,len)}:function(str,start,len){if(start<0)start=str.length+start;return str.substr(start,len)}},{__browserify_process:510}],515:[function(require,module,exports){var global=typeof self!=="undefined"?self:typeof window!=="undefined"?window:{};(function(root){var freeExports=typeof exports=="object"&&exports;var freeModule=typeof module=="object"&&module&&module.exports==freeExports&&module;var freeGlobal=typeof global=="object"&&global;if(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal){root=freeGlobal}var punycode,maxInt=2147483647,base=36,tMin=1,tMax=26,skew=38,damp=700,initialBias=72,initialN=128,delimiter="-",regexPunycode=/^xn--/,regexNonASCII=/[^ -~]/,regexSeparators=/\x2E|\u3002|\uFF0E|\uFF61/g,errors={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},baseMinusTMin=base-tMin,floor=Math.floor,stringFromCharCode=String.fromCharCode,key;function error(type){throw RangeError(errors[type])}function map(array,fn){var length=array.length;while(length--){array[length]=fn(array[length])}return array}function mapDomain(string,fn){return map(string.split(regexSeparators),fn).join(".")}function ucs2decode(string){var output=[],counter=0,length=string.length,value,extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=55296&&value<=56319&&counter<length){extra=string.charCodeAt(counter++);if((extra&64512)==56320){output.push(((value&1023)<<10)+(extra&1023)+65536)}else{output.push(value);counter--}}else{output.push(value)}}return output}function ucs2encode(array){return map(array,function(value){var output="";if(value>65535){value-=65536;output+=stringFromCharCode(value>>>10&1023|55296);value=56320|value&1023}output+=stringFromCharCode(value);return output}).join("")}function basicToDigit(codePoint){if(codePoint-48<10){return codePoint-22}if(codePoint-65<26){return codePoint-65}if(codePoint-97<26){return codePoint-97}return base}function digitToBasic(digit,flag){return digit+22+75*(digit<26)-((flag!=0)<<5)}function adapt(delta,numPoints,firstTime){var k=0;delta=firstTime?floor(delta/damp):delta>>1;delta+=floor(delta/numPoints);for(;delta>baseMinusTMin*tMax>>1;k+=base){delta=floor(delta/baseMinusTMin)}return floor(k+(baseMinusTMin+1)*delta/(delta+skew))}function decode(input){var output=[],inputLength=input.length,out,i=0,n=initialN,bias=initialBias,basic,j,index,oldi,w,k,digit,t,length,baseMinusT;basic=input.lastIndexOf(delimiter);if(basic<0){basic=0}for(j=0;j<basic;++j){if(input.charCodeAt(j)>=128){error("not-basic")}output.push(input.charCodeAt(j))}for(index=basic>0?basic+1:0;index<inputLength;){for(oldi=i,w=1,k=base;;k+=base){if(index>=inputLength){error("invalid-input")}digit=basicToDigit(input.charCodeAt(index++));if(digit>=base||digit>floor((maxInt-i)/w)){error("overflow")}i+=digit*w;t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(digit<t){break}baseMinusT=base-t;if(w>floor(maxInt/baseMinusT)){error("overflow")}w*=baseMinusT}out=output.length+1;bias=adapt(i-oldi,out,oldi==0);if(floor(i/out)>maxInt-n){error("overflow")}n+=floor(i/out);i%=out;output.splice(i++,0,n)}return ucs2encode(output)}function encode(input){var n,delta,handledCPCount,basicLength,bias,j,m,q,k,t,currentValue,output=[],inputLength,handledCPCountPlusOne,baseMinusT,qMinusT;input=ucs2decode(input);inputLength=input.length;n=initialN;delta=0;bias=initialBias;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<128){output.push(stringFromCharCode(currentValue))}}handledCPCount=basicLength=output.length;if(basicLength){output.push(delimiter)}while(handledCPCount<inputLength){for(m=maxInt,j=0;j<inputLength;++j){currentValue=input[j];if(currentValue>=n&&currentValue<m){m=currentValue}}handledCPCountPlusOne=handledCPCount+1;if(m-n>floor((maxInt-delta)/handledCPCountPlusOne)){error("overflow")}delta+=(m-n)*handledCPCountPlusOne;n=m;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<n&&++delta>maxInt){error("overflow")}if(currentValue==n){for(q=delta,k=base;;k+=base){t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(q<t){break}qMinusT=q-t;baseMinusT=base-t;output.push(stringFromCharCode(digitToBasic(t+qMinusT%baseMinusT,0)));q=floor(qMinusT/baseMinusT)}output.push(stringFromCharCode(digitToBasic(q,0)));bias=adapt(delta,handledCPCountPlusOne,handledCPCount==basicLength);delta=0;++handledCPCount}}++delta;++n}return output.join("")}function toUnicode(domain){return mapDomain(domain,function(string){return regexPunycode.test(string)?decode(string.slice(4).toLowerCase()):string})}function toASCII(domain){return mapDomain(domain,function(string){return regexNonASCII.test(string)?"xn--"+encode(string):string})}punycode={version:"1.2.3",ucs2:{decode:ucs2decode,encode:ucs2encode},decode:decode,encode:encode,toASCII:toASCII,toUnicode:toUnicode};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){define(function(){return punycode})}else if(freeExports&&!freeExports.nodeType){if(freeModule){freeModule.exports=punycode}else{for(key in punycode){punycode.hasOwnProperty(key)&&(freeExports[key]=punycode[key])}}}else{root.punycode=punycode}})(this)},{}],516:[function(require,module,exports){"use strict";function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}module.exports=function(qs,sep,eq,options){sep=sep||"&";eq=eq||"=";var obj={};if(typeof qs!=="string"||qs.length===0){return obj}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1e3;if(options&&typeof options.maxKeys==="number"){maxKeys=options.maxKeys}var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,"%20"),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1)}else{kstr=x;vstr=""}k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v}else if(isArray(obj[k])){obj[k].push(v)}else{obj[k]=[obj[k],v]}}return obj};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"}},{}],517:[function(require,module,exports){"use strict";var stringifyPrimitive=function(v){switch(typeof v){case"string":return v;case"boolean":return v?"true":"false";case"number":return isFinite(v)?v:"";default:return""}};module.exports=function(obj,sep,eq,name){sep=sep||"&";eq=eq||"=";if(obj===null){obj=undefined}if(typeof obj==="object"){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return obj[k].map(function(v){return ks+encodeURIComponent(stringifyPrimitive(v))}).join(sep)}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]))}}).join(sep)}if(!name)return"";return encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj))};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i))}return res}var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key)}return res}},{}],518:[function(require,module,exports){"use strict";exports.decode=exports.parse=require("./decode");exports.encode=exports.stringify=require("./encode")},{"./decode":516,"./encode":517}],519:[function(require,module,exports){module.exports=Duplex;var inherits=require("inherits");var setImmediate=require("process/browser.js").nextTick;var Readable=require("./readable.js");var Writable=require("./writable.js");inherits(Duplex,Readable);Duplex.prototype.write=Writable.prototype.write;Duplex.prototype.end=Writable.prototype.end;Duplex.prototype._write=Writable.prototype._write;function Duplex(options){if(!(this instanceof Duplex))return new Duplex(options);Readable.call(this,options);Writable.call(this,options);if(options&&options.readable===false)this.readable=false;if(options&&options.writable===false)this.writable=false;this.allowHalfOpen=true;if(options&&options.allowHalfOpen===false)this.allowHalfOpen=false;this.once("end",onend)}function onend(){if(this.allowHalfOpen||this._writableState.ended)return;var self=this;setImmediate(function(){self.end()})}},{"./readable.js":523,"./writable.js":525,inherits:508,"process/browser.js":521}],520:[function(require,module,exports){module.exports=Stream;var EE=require("events").EventEmitter;var inherits=require("inherits");inherits(Stream,EE);Stream.Readable=require("./readable.js");Stream.Writable=require("./writable.js");Stream.Duplex=require("./duplex.js");Stream.Transform=require("./transform.js");Stream.PassThrough=require("./passthrough.js");Stream.Stream=Stream;function Stream(){EE.call(this)}Stream.prototype.pipe=function(dest,options){var source=this;function ondata(chunk){if(dest.writable){if(false===dest.write(chunk)&&source.pause){source.pause()}}}source.on("data",ondata);function ondrain(){if(source.readable&&source.resume){source.resume()}}dest.on("drain",ondrain);if(!dest._isStdio&&(!options||options.end!==false)){source.on("end",onend);source.on("close",onclose)}var didOnEnd=false;function onend(){if(didOnEnd)return;didOnEnd=true;dest.end()}function onclose(){if(didOnEnd)return;didOnEnd=true;if(typeof dest.destroy==="function")dest.destroy()}function onerror(er){cleanup();if(EE.listenerCount(this,"error")===0){throw er}}source.on("error",onerror);dest.on("error",onerror);function cleanup(){source.removeListener("data",ondata);dest.removeListener("drain",ondrain);source.removeListener("end",onend);source.removeListener("close",onclose);source.removeListener("error",onerror);dest.removeListener("error",onerror);source.removeListener("end",cleanup);source.removeListener("close",cleanup);dest.removeListener("close",cleanup)}source.on("end",cleanup);source.on("close",cleanup);dest.on("close",cleanup);dest.emit("pipe",source);return dest}},{"./duplex.js":519,"./passthrough.js":522,"./readable.js":523,"./transform.js":524,"./writable.js":525,events:507,inherits:508}],521:[function(require,module,exports){module.exports=require(510)},{}],522:[function(require,module,exports){module.exports=PassThrough;var Transform=require("./transform.js");var inherits=require("inherits");inherits(PassThrough,Transform);function PassThrough(options){if(!(this instanceof PassThrough))return new PassThrough(options);Transform.call(this,options)}PassThrough.prototype._transform=function(chunk,encoding,cb){cb(null,chunk)}},{"./transform.js":524,inherits:508}],523:[function(require,module,exports){var process=require("__browserify_process");module.exports=Readable;Readable.ReadableState=ReadableState;var EE=require("events").EventEmitter;var Stream=require("./index.js");var Buffer=require("buffer").Buffer;var setImmediate=require("process/browser.js").nextTick;var StringDecoder;var inherits=require("inherits");inherits(Readable,Stream);function ReadableState(options,stream){options=options||{};var hwm=options.highWaterMark;this.highWaterMark=hwm||hwm===0?hwm:16*1024;this.highWaterMark=~~this.highWaterMark;this.buffer=[];this.length=0;this.pipes=null;this.pipesCount=0;this.flowing=false;this.ended=false;this.endEmitted=false;this.reading=false;this.calledRead=false;this.sync=true;this.needReadable=false;this.emittedReadable=false;this.readableListening=false;this.objectMode=!!options.objectMode;this.defaultEncoding=options.defaultEncoding||"utf8";this.ranOut=false;this.awaitDrain=0;this.readingMore=false;this.decoder=null;this.encoding=null;if(options.encoding){if(!StringDecoder)StringDecoder=require("string_decoder").StringDecoder;this.decoder=new StringDecoder(options.encoding);this.encoding=options.encoding}}function Readable(options){if(!(this instanceof Readable))return new Readable(options);this._readableState=new ReadableState(options,this);this.readable=true;Stream.call(this)}Readable.prototype.push=function(chunk,encoding){var state=this._readableState;if(typeof chunk==="string"&&!state.objectMode){encoding=encoding||state.defaultEncoding;if(encoding!==state.encoding){chunk=new Buffer(chunk,encoding);encoding=""}}return readableAddChunk(this,state,chunk,encoding,false)};Readable.prototype.unshift=function(chunk){var state=this._readableState;return readableAddChunk(this,state,chunk,"",true)};function readableAddChunk(stream,state,chunk,encoding,addToFront){var er=chunkInvalid(state,chunk);if(er){stream.emit("error",er)}else if(chunk===null||chunk===undefined){state.reading=false;if(!state.ended)onEofChunk(stream,state)}else if(state.objectMode||chunk&&chunk.length>0){if(state.ended&&!addToFront){var e=new Error("stream.push() after EOF");stream.emit("error",e)}else if(state.endEmitted&&addToFront){var e=new Error("stream.unshift() after end event");stream.emit("error",e)}else{if(state.decoder&&!addToFront&&!encoding)chunk=state.decoder.write(chunk);state.length+=state.objectMode?1:chunk.length;if(addToFront){state.buffer.unshift(chunk)}else{state.reading=false;state.buffer.push(chunk)}if(state.needReadable)emitReadable(stream);maybeReadMore(stream,state)}}else if(!addToFront){state.reading=false}return needMoreData(state)}function needMoreData(state){return!state.ended&&(state.needReadable||state.length<state.highWaterMark||state.length===0)}Readable.prototype.setEncoding=function(enc){if(!StringDecoder)StringDecoder=require("string_decoder").StringDecoder;this._readableState.decoder=new StringDecoder(enc);this._readableState.encoding=enc};var MAX_HWM=8388608;function roundUpToNextPowerOf2(n){if(n>=MAX_HWM){n=MAX_HWM}else{n--;for(var p=1;p<32;p<<=1)n|=n>>p;n++}return n}function howMuchToRead(n,state){if(state.length===0&&state.ended)return 0;if(state.objectMode)return n===0?0:1;if(isNaN(n)||n===null){if(state.flowing&&state.buffer.length)return state.buffer[0].length;else return state.length}if(n<=0)return 0;if(n>state.highWaterMark)state.highWaterMark=roundUpToNextPowerOf2(n);if(n>state.length){if(!state.ended){state.needReadable=true;return 0}else return state.length}return n}Readable.prototype.read=function(n){var state=this._readableState;state.calledRead=true;var nOrig=n;if(typeof n!=="number"||n>0)state.emittedReadable=false;if(n===0&&state.needReadable&&(state.length>=state.highWaterMark||state.ended)){emitReadable(this);return null}n=howMuchToRead(n,state);if(n===0&&state.ended){if(state.length===0)endReadable(this);return null}var doRead=state.needReadable;if(state.length-n<=state.highWaterMark)doRead=true;if(state.ended||state.reading)doRead=false;if(doRead){state.reading=true;state.sync=true;if(state.length===0)state.needReadable=true;this._read(state.highWaterMark);state.sync=false}if(doRead&&!state.reading)n=howMuchToRead(nOrig,state);var ret;if(n>0)ret=fromList(n,state);else ret=null;if(ret===null){state.needReadable=true;n=0}state.length-=n;if(state.length===0&&!state.ended)state.needReadable=true;if(state.ended&&!state.endEmitted&&state.length===0)endReadable(this);return ret};function chunkInvalid(state,chunk){var er=null;if(!Buffer.isBuffer(chunk)&&"string"!==typeof chunk&&chunk!==null&&chunk!==undefined&&!state.objectMode&&!er){er=new TypeError("Invalid non-string/buffer chunk")}return er}function onEofChunk(stream,state){if(state.decoder&&!state.ended){var chunk=state.decoder.end();if(chunk&&chunk.length){state.buffer.push(chunk);state.length+=state.objectMode?1:chunk.length}}state.ended=true;if(state.length>0)emitReadable(stream);else endReadable(stream)}function emitReadable(stream){var state=stream._readableState;state.needReadable=false;if(state.emittedReadable)return;state.emittedReadable=true;if(state.sync)setImmediate(function(){emitReadable_(stream)});else emitReadable_(stream)}function emitReadable_(stream){stream.emit("readable")}function maybeReadMore(stream,state){if(!state.readingMore){state.readingMore=true;setImmediate(function(){maybeReadMore_(stream,state)})}}function maybeReadMore_(stream,state){var len=state.length;while(!state.reading&&!state.flowing&&!state.ended&&state.length<state.highWaterMark){stream.read(0);if(len===state.length)break;else len=state.length}state.readingMore=false}Readable.prototype._read=function(n){this.emit("error",new Error("not implemented"))};Readable.prototype.pipe=function(dest,pipeOpts){var src=this;var state=this._readableState;switch(state.pipesCount){case 0:state.pipes=dest;break;case 1:state.pipes=[state.pipes,dest];break;default:state.pipes.push(dest);break}state.pipesCount+=1;var doEnd=(!pipeOpts||pipeOpts.end!==false)&&dest!==process.stdout&&dest!==process.stderr;var endFn=doEnd?onend:cleanup;if(state.endEmitted)setImmediate(endFn);else src.once("end",endFn);dest.on("unpipe",onunpipe);function onunpipe(readable){if(readable!==src)return;cleanup()}function onend(){dest.end()}var ondrain=pipeOnDrain(src);dest.on("drain",ondrain);function cleanup(){dest.removeListener("close",onclose);dest.removeListener("finish",onfinish);dest.removeListener("drain",ondrain);dest.removeListener("error",onerror);dest.removeListener("unpipe",onunpipe);src.removeListener("end",onend);src.removeListener("end",cleanup);if(!dest._writableState||dest._writableState.needDrain)ondrain()}var errListeners=EE.listenerCount(dest,"error");function onerror(er){unpipe();if(errListeners===0&&EE.listenerCount(dest,"error")===0)dest.emit("error",er)}dest.once("error",onerror);function onclose(){dest.removeListener("finish",onfinish);unpipe()}dest.once("close",onclose);function onfinish(){dest.removeListener("close",onclose);unpipe()}dest.once("finish",onfinish);function unpipe(){src.unpipe(dest)}dest.emit("pipe",src);if(!state.flowing){this.on("readable",pipeOnReadable);state.flowing=true;setImmediate(function(){flow(src)})}return dest};function pipeOnDrain(src){return function(){var dest=this;var state=src._readableState;state.awaitDrain--;if(state.awaitDrain===0)flow(src)}}function flow(src){var state=src._readableState;var chunk;state.awaitDrain=0;function write(dest,i,list){var written=dest.write(chunk);if(false===written){state.awaitDrain++}}while(state.pipesCount&&null!==(chunk=src.read())){if(state.pipesCount===1)write(state.pipes,0,null);else forEach(state.pipes,write);src.emit("data",chunk);if(state.awaitDrain>0)return}if(state.pipesCount===0){state.flowing=false;if(EE.listenerCount(src,"data")>0)emitDataEvents(src);return}state.ranOut=true}function pipeOnReadable(){if(this._readableState.ranOut){this._readableState.ranOut=false;flow(this)}}Readable.prototype.unpipe=function(dest){var state=this._readableState;if(state.pipesCount===0)return this;if(state.pipesCount===1){if(dest&&dest!==state.pipes)return this;if(!dest)dest=state.pipes;state.pipes=null;state.pipesCount=0;this.removeListener("readable",pipeOnReadable);state.flowing=false;if(dest)dest.emit("unpipe",this);return this}if(!dest){var dests=state.pipes;var len=state.pipesCount;state.pipes=null;state.pipesCount=0;this.removeListener("readable",pipeOnReadable);state.flowing=false;for(var i=0;i<len;i++)dests[i].emit("unpipe",this);return this}var i=indexOf(state.pipes,dest);if(i===-1)return this;state.pipes.splice(i,1);state.pipesCount-=1;if(state.pipesCount===1)state.pipes=state.pipes[0];dest.emit("unpipe",this);return this};Readable.prototype.on=function(ev,fn){var res=Stream.prototype.on.call(this,ev,fn);if(ev==="data"&&!this._readableState.flowing)emitDataEvents(this);if(ev==="readable"&&this.readable){var state=this._readableState;if(!state.readableListening){state.readableListening=true;state.emittedReadable=false;state.needReadable=true;if(!state.reading){this.read(0)}else if(state.length){emitReadable(this,state)}}}return res};Readable.prototype.addListener=Readable.prototype.on;Readable.prototype.resume=function(){emitDataEvents(this);this.read(0);this.emit("resume")};Readable.prototype.pause=function(){emitDataEvents(this,true);this.emit("pause")};function emitDataEvents(stream,startPaused){var state=stream._readableState;if(state.flowing){throw new Error("Cannot switch to old mode now.")}var paused=startPaused||false;var readable=false;stream.readable=true;stream.pipe=Stream.prototype.pipe;stream.on=stream.addListener=Stream.prototype.on;stream.on("readable",function(){readable=true;var c;while(!paused&&null!==(c=stream.read()))stream.emit("data",c);if(c===null){readable=false;stream._readableState.needReadable=true}});stream.pause=function(){paused=true;this.emit("pause")};stream.resume=function(){paused=false;if(readable)setImmediate(function(){stream.emit("readable")});else this.read(0);this.emit("resume")};stream.emit("readable")}Readable.prototype.wrap=function(stream){var state=this._readableState;var paused=false;var self=this;stream.on("end",function(){if(state.decoder&&!state.ended){var chunk=state.decoder.end();if(chunk&&chunk.length)self.push(chunk)}self.push(null)});stream.on("data",function(chunk){if(state.decoder)chunk=state.decoder.write(chunk);if(!chunk||!state.objectMode&&!chunk.length)return;var ret=self.push(chunk);if(!ret){paused=true;stream.pause()}});for(var i in stream){if(typeof stream[i]==="function"&&typeof this[i]==="undefined"){this[i]=function(method){return function(){return stream[method].apply(stream,arguments)}}(i)}}var events=["error","close","destroy","pause","resume"];forEach(events,function(ev){stream.on(ev,function(x){return self.emit.apply(self,ev,x)})});self._read=function(n){if(paused){paused=false;stream.resume()}};return self};Readable._fromList=fromList;function fromList(n,state){var list=state.buffer;var length=state.length;var stringMode=!!state.decoder;var objectMode=!!state.objectMode;var ret;if(list.length===0)return null;if(length===0)ret=null;else if(objectMode)ret=list.shift();else if(!n||n>=length){if(stringMode)ret=list.join("");else ret=Buffer.concat(list,length);list.length=0}else{if(n<list[0].length){var buf=list[0];ret=buf.slice(0,n);list[0]=buf.slice(n)}else if(n===list[0].length){ret=list.shift()}else{if(stringMode)ret="";else ret=new Buffer(n);var c=0;for(var i=0,l=list.length;i<l&&c<n;i++){var buf=list[0];var cpy=Math.min(n-c,buf.length);if(stringMode)ret+=buf.slice(0,cpy);else buf.copy(ret,c,0,cpy);if(cpy<buf.length)list[0]=buf.slice(cpy);else list.shift();c+=cpy}}}return ret}function endReadable(stream){var state=stream._readableState;if(state.length>0)throw new Error("endReadable called on non-empty stream");if(!state.endEmitted&&state.calledRead){state.ended=true;setImmediate(function(){if(!state.endEmitted&&state.length===0){state.endEmitted=true;stream.readable=false;stream.emit("end")}})}}function forEach(xs,f){for(var i=0,l=xs.length;i<l;i++){f(xs[i],i)}}function indexOf(xs,x){for(var i=0,l=xs.length;i<l;i++){if(xs[i]===x)return i}return-1}},{"./index.js":520,__browserify_process:510,buffer:511,events:507,inherits:508,"process/browser.js":521,string_decoder:526}],524:[function(require,module,exports){module.exports=Transform;var Duplex=require("./duplex.js");var inherits=require("inherits");inherits(Transform,Duplex);function TransformState(options,stream){this.afterTransform=function(er,data){return afterTransform(stream,er,data)};this.needTransform=false;this.transforming=false;this.writecb=null;this.writechunk=null}function afterTransform(stream,er,data){var ts=stream._transformState;ts.transforming=false;var cb=ts.writecb;if(!cb)return stream.emit("error",new Error("no writecb in Transform class"));ts.writechunk=null;ts.writecb=null;if(data!==null&&data!==undefined)stream.push(data);if(cb)cb(er);var rs=stream._readableState;rs.reading=false;
if(rs.needReadable||rs.length<rs.highWaterMark){stream._read(rs.highWaterMark)}}function Transform(options){if(!(this instanceof Transform))return new Transform(options);Duplex.call(this,options);var ts=this._transformState=new TransformState(options,this);var stream=this;this._readableState.needReadable=true;this._readableState.sync=false;this.once("finish",function(){if("function"===typeof this._flush)this._flush(function(er){done(stream,er)});else done(stream)})}Transform.prototype.push=function(chunk,encoding){this._transformState.needTransform=false;return Duplex.prototype.push.call(this,chunk,encoding)};Transform.prototype._transform=function(chunk,encoding,cb){throw new Error("not implemented")};Transform.prototype._write=function(chunk,encoding,cb){var ts=this._transformState;ts.writecb=cb;ts.writechunk=chunk;ts.writeencoding=encoding;if(!ts.transforming){var rs=this._readableState;if(ts.needTransform||rs.needReadable||rs.length<rs.highWaterMark)this._read(rs.highWaterMark)}};Transform.prototype._read=function(n){var ts=this._transformState;if(ts.writechunk&&ts.writecb&&!ts.transforming){ts.transforming=true;this._transform(ts.writechunk,ts.writeencoding,ts.afterTransform)}else{ts.needTransform=true}};function done(stream,er){if(er)return stream.emit("error",er);var ws=stream._writableState;var rs=stream._readableState;var ts=stream._transformState;if(ws.length)throw new Error("calling transform done when ws.length != 0");if(ts.transforming)throw new Error("calling transform done when still transforming");return stream.push(null)}},{"./duplex.js":519,inherits:508}],525:[function(require,module,exports){module.exports=Writable;Writable.WritableState=WritableState;var isUint8Array=typeof Uint8Array!=="undefined"?function(x){return x instanceof Uint8Array}:function(x){return x&&x.constructor&&x.constructor.name==="Uint8Array"};var isArrayBuffer=typeof ArrayBuffer!=="undefined"?function(x){return x instanceof ArrayBuffer}:function(x){return x&&x.constructor&&x.constructor.name==="ArrayBuffer"};var inherits=require("inherits");var Stream=require("./index.js");var setImmediate=require("process/browser.js").nextTick;var Buffer=require("buffer").Buffer;inherits(Writable,Stream);function WriteReq(chunk,encoding,cb){this.chunk=chunk;this.encoding=encoding;this.callback=cb}function WritableState(options,stream){options=options||{};var hwm=options.highWaterMark;this.highWaterMark=hwm||hwm===0?hwm:16*1024;this.objectMode=!!options.objectMode;this.highWaterMark=~~this.highWaterMark;this.needDrain=false;this.ending=false;this.ended=false;this.finished=false;var noDecode=options.decodeStrings===false;this.decodeStrings=!noDecode;this.defaultEncoding=options.defaultEncoding||"utf8";this.length=0;this.writing=false;this.sync=true;this.bufferProcessing=false;this.onwrite=function(er){onwrite(stream,er)};this.writecb=null;this.writelen=0;this.buffer=[]}function Writable(options){if(!(this instanceof Writable)&&!(this instanceof Stream.Duplex))return new Writable(options);this._writableState=new WritableState(options,this);this.writable=true;Stream.call(this)}Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe. Not readable."))};function writeAfterEnd(stream,state,cb){var er=new Error("write after end");stream.emit("error",er);setImmediate(function(){cb(er)})}function validChunk(stream,state,chunk,cb){var valid=true;if(!Buffer.isBuffer(chunk)&&"string"!==typeof chunk&&chunk!==null&&chunk!==undefined&&!state.objectMode){var er=new TypeError("Invalid non-string/buffer chunk");stream.emit("error",er);setImmediate(function(){cb(er)});valid=false}return valid}Writable.prototype.write=function(chunk,encoding,cb){var state=this._writableState;var ret=false;if(typeof encoding==="function"){cb=encoding;encoding=null}if(isUint8Array(chunk))chunk=new Buffer(chunk);if(isArrayBuffer(chunk)&&typeof Uint8Array!=="undefined")chunk=new Buffer(new Uint8Array(chunk));if(Buffer.isBuffer(chunk))encoding="buffer";else if(!encoding)encoding=state.defaultEncoding;if(typeof cb!=="function")cb=function(){};if(state.ended)writeAfterEnd(this,state,cb);else if(validChunk(this,state,chunk,cb))ret=writeOrBuffer(this,state,chunk,encoding,cb);return ret};function decodeChunk(state,chunk,encoding){if(!state.objectMode&&state.decodeStrings!==false&&typeof chunk==="string"){chunk=new Buffer(chunk,encoding)}return chunk}function writeOrBuffer(stream,state,chunk,encoding,cb){chunk=decodeChunk(state,chunk,encoding);var len=state.objectMode?1:chunk.length;state.length+=len;var ret=state.length<state.highWaterMark;state.needDrain=!ret;if(state.writing)state.buffer.push(new WriteReq(chunk,encoding,cb));else doWrite(stream,state,len,chunk,encoding,cb);return ret}function doWrite(stream,state,len,chunk,encoding,cb){state.writelen=len;state.writecb=cb;state.writing=true;state.sync=true;stream._write(chunk,encoding,state.onwrite);state.sync=false}function onwriteError(stream,state,sync,er,cb){if(sync)setImmediate(function(){cb(er)});else cb(er);stream.emit("error",er)}function onwriteStateUpdate(state){state.writing=false;state.writecb=null;state.length-=state.writelen;state.writelen=0}function onwrite(stream,er){var state=stream._writableState;var sync=state.sync;var cb=state.writecb;onwriteStateUpdate(state);if(er)onwriteError(stream,state,sync,er,cb);else{var finished=needFinish(stream,state);if(!finished&&!state.bufferProcessing&&state.buffer.length)clearBuffer(stream,state);if(sync){setImmediate(function(){afterWrite(stream,state,finished,cb)})}else{afterWrite(stream,state,finished,cb)}}}function afterWrite(stream,state,finished,cb){if(!finished)onwriteDrain(stream,state);cb();if(finished)finishMaybe(stream,state)}function onwriteDrain(stream,state){if(state.length===0&&state.needDrain){state.needDrain=false;stream.emit("drain")}}function clearBuffer(stream,state){state.bufferProcessing=true;for(var c=0;c<state.buffer.length;c++){var entry=state.buffer[c];var chunk=entry.chunk;var encoding=entry.encoding;var cb=entry.callback;var len=state.objectMode?1:chunk.length;doWrite(stream,state,len,chunk,encoding,cb);if(state.writing){c++;break}}state.bufferProcessing=false;if(c<state.buffer.length)state.buffer=state.buffer.slice(c);else state.buffer.length=0}Writable.prototype._write=function(chunk,encoding,cb){cb(new Error("not implemented"))};Writable.prototype.end=function(chunk,encoding,cb){var state=this._writableState;if(typeof chunk==="function"){cb=chunk;chunk=null;encoding=null}else if(typeof encoding==="function"){cb=encoding;encoding=null}if(typeof chunk!=="undefined"&&chunk!==null)this.write(chunk,encoding);if(!state.ending&&!state.finished)endWritable(this,state,cb)};function needFinish(stream,state){return state.ending&&state.length===0&&!state.finished&&!state.writing}function finishMaybe(stream,state){var need=needFinish(stream,state);if(need){state.finished=true;stream.emit("finish")}return need}function endWritable(stream,state,cb){state.ending=true;finishMaybe(stream,state);if(cb){if(state.finished)setImmediate(cb);else stream.once("finish",cb)}state.ended=true}},{"./index.js":520,buffer:511,inherits:508,"process/browser.js":521}],526:[function(require,module,exports){var Buffer=require("buffer").Buffer;function assertEncoding(encoding){if(encoding&&!Buffer.isEncoding(encoding)){throw new Error("Unknown encoding: "+encoding)}}var StringDecoder=exports.StringDecoder=function(encoding){this.encoding=(encoding||"utf8").toLowerCase().replace(/[-_]/,"");assertEncoding(encoding);switch(this.encoding){case"utf8":this.surrogateSize=3;break;case"ucs2":case"utf16le":this.surrogateSize=2;this.detectIncompleteChar=utf16DetectIncompleteChar;break;case"base64":this.surrogateSize=3;this.detectIncompleteChar=base64DetectIncompleteChar;break;default:this.write=passThroughWrite;return}this.charBuffer=new Buffer(6);this.charReceived=0;this.charLength=0};StringDecoder.prototype.write=function(buffer){var charStr="";var offset=0;while(this.charLength){var i=buffer.length>=this.charLength-this.charReceived?this.charLength-this.charReceived:buffer.length;buffer.copy(this.charBuffer,this.charReceived,offset,i);this.charReceived+=i-offset;offset=i;if(this.charReceived<this.charLength){return""}charStr=this.charBuffer.slice(0,this.charLength).toString(this.encoding);var charCode=charStr.charCodeAt(charStr.length-1);if(charCode>=55296&&charCode<=56319){this.charLength+=this.surrogateSize;charStr="";continue}this.charReceived=this.charLength=0;if(i==buffer.length)return charStr;buffer=buffer.slice(i,buffer.length);break}var lenIncomplete=this.detectIncompleteChar(buffer);var end=buffer.length;if(this.charLength){buffer.copy(this.charBuffer,0,buffer.length-lenIncomplete,end);this.charReceived=lenIncomplete;end-=lenIncomplete}charStr+=buffer.toString(this.encoding,0,end);var end=charStr.length-1;var charCode=charStr.charCodeAt(end);if(charCode>=55296&&charCode<=56319){var size=this.surrogateSize;this.charLength+=size;this.charReceived+=size;this.charBuffer.copy(this.charBuffer,size,0,size);this.charBuffer.write(charStr.charAt(charStr.length-1),this.encoding);return charStr.substring(0,end)}return charStr};StringDecoder.prototype.detectIncompleteChar=function(buffer){var i=buffer.length>=3?3:buffer.length;for(;i>0;i--){var c=buffer[buffer.length-i];if(i==1&&c>>5==6){this.charLength=2;break}if(i<=2&&c>>4==14){this.charLength=3;break}if(i<=3&&c>>3==30){this.charLength=4;break}}return i};StringDecoder.prototype.end=function(buffer){var res="";if(buffer&&buffer.length)res=this.write(buffer);if(this.charReceived){var cr=this.charReceived;var buf=this.charBuffer;var enc=this.encoding;res+=buf.slice(0,cr).toString(enc)}return res};function passThroughWrite(buffer){return buffer.toString(this.encoding)}function utf16DetectIncompleteChar(buffer){var incomplete=this.charReceived=buffer.length%2;this.charLength=incomplete?2:0;return incomplete}function base64DetectIncompleteChar(buffer){var incomplete=this.charReceived=buffer.length%3;this.charLength=incomplete?3:0;return incomplete}},{buffer:511}],527:[function(require,module,exports){(function(){"use strict";var punycode=require("punycode");exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,delims=["<",">",'"',"`"," ","\r","\n","	"],unwise=["{","}","|","\\","^","~","`"].concat(delims),autoEscape=["'"].concat(delims),nonHostChars=["%","/","?",";","#"].concat(unwise).concat(autoEscape),nonAuthChars=["/","@","?","#"].concat(delims),hostnameMaxLen=255,hostnamePartPattern=/^[a-zA-Z0-9][a-z0-9A-Z_-]{0,62}$/,hostnamePartStart=/^([a-zA-Z0-9][a-z0-9A-Z_-]{0,62})(.*)$/,unsafeProtocol={javascript:true,"javascript:":true},hostlessProtocol={javascript:true,"javascript:":true},pathedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"ftp:":true,"gopher:":true,"file:":true},slashedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"https:":true,"ftp:":true,"gopher:":true,"file:":true},querystring=require("querystring");function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&typeof url==="object"&&url.href)return url;if(typeof url!=="string"){throw new TypeError("Parameter 'url' must be a string, not "+typeof url)}var out={},rest=url;rest=rest.trim();var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();out.protocol=lowerProto;rest=rest.substr(proto.length)}if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes=rest.substr(0,2)==="//";if(slashes&&!(proto&&hostlessProtocol[proto])){rest=rest.substr(2);out.slashes=true}}if(!hostlessProtocol[proto]&&(slashes||proto&&!slashedProtocol[proto])){var atSign=rest.indexOf("@");if(atSign!==-1){var auth=rest.slice(0,atSign);var hasAuth=true;for(var i=0,l=nonAuthChars.length;i<l;i++){if(auth.indexOf(nonAuthChars[i])!==-1){hasAuth=false;break}}if(hasAuth){out.auth=decodeURIComponent(auth);rest=rest.substr(atSign+1)}}var firstNonHost=-1;for(var i=0,l=nonHostChars.length;i<l;i++){var index=rest.indexOf(nonHostChars[i]);if(index!==-1&&(firstNonHost<0||index<firstNonHost))firstNonHost=index}if(firstNonHost!==-1){out.host=rest.substr(0,firstNonHost);rest=rest.substr(firstNonHost)}else{out.host=rest;rest=""}var p=parseHost(out.host);var keys=Object.keys(p);for(var i=0,l=keys.length;i<l;i++){var key=keys[i];out[key]=p[key]}out.hostname=out.hostname||"";var ipv6Hostname=out.hostname[0]==="["&&out.hostname[out.hostname.length-1]==="]";if(out.hostname.length>hostnameMaxLen){out.hostname=""}else if(!ipv6Hostname){var hostparts=out.hostname.split(/\./);for(var i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(!part)continue;if(!part.match(hostnamePartPattern)){var newpart="";for(var j=0,k=part.length;j<k;j++){if(part.charCodeAt(j)>127){newpart+="x"}else{newpart+=part[j]}}if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i);var notHost=hostparts.slice(i+1);var bit=part.match(hostnamePartStart);if(bit){validParts.push(bit[1]);notHost.unshift(bit[2])}if(notHost.length){rest="/"+notHost.join(".")+rest}out.hostname=validParts.join(".");break}}}}out.hostname=out.hostname.toLowerCase();if(!ipv6Hostname){var domainArray=out.hostname.split(".");var newOut=[];for(var i=0;i<domainArray.length;++i){var s=domainArray[i];newOut.push(s.match(/[^A-Za-z0-9_-]/)?"xn--"+punycode.encode(s):s)}out.hostname=newOut.join(".")}out.host=(out.hostname||"")+(out.port?":"+out.port:"");out.href+=out.host;if(ipv6Hostname){out.hostname=out.hostname.substr(1,out.hostname.length-2);if(rest[0]!=="/"){rest="/"+rest}}}if(!unsafeProtocol[lowerProto]){for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];var esc=encodeURIComponent(ae);if(esc===ae){esc=escape(ae)}rest=rest.split(ae).join(esc)}}var hash=rest.indexOf("#");if(hash!==-1){out.hash=rest.substr(hash);rest=rest.slice(0,hash)}var qm=rest.indexOf("?");if(qm!==-1){out.search=rest.substr(qm);out.query=rest.substr(qm+1);if(parseQueryString){out.query=querystring.parse(out.query)}rest=rest.slice(0,qm)}else if(parseQueryString){out.search="";out.query={}}if(rest)out.pathname=rest;if(slashedProtocol[proto]&&out.hostname&&!out.pathname){out.pathname="/"}if(out.pathname||out.search){out.path=(out.pathname?out.pathname:"")+(out.search?out.search:"")}out.href=urlFormat(out);return out}function urlFormat(obj){if(typeof obj==="string")obj=urlParse(obj);var auth=obj.auth||"";if(auth){auth=encodeURIComponent(auth);auth=auth.replace(/%3A/i,":");auth+="@"}var protocol=obj.protocol||"",pathname=obj.pathname||"",hash=obj.hash||"",host=false,query="";if(obj.host!==undefined){host=auth+obj.host}else if(obj.hostname!==undefined){host=auth+(obj.hostname.indexOf(":")===-1?obj.hostname:"["+obj.hostname+"]");if(obj.port){host+=":"+obj.port}}if(obj.query&&typeof obj.query==="object"&&Object.keys(obj.query).length){query=querystring.stringify(obj.query)}var search=obj.search||query&&"?"+query||"";if(protocol&&protocol.substr(-1)!==":")protocol+=":";if(obj.slashes||(!protocol||slashedProtocol[protocol])&&host!==false){host="//"+(host||"");if(pathname&&pathname.charAt(0)!=="/")pathname="/"+pathname}else if(!host){host=""}if(hash&&hash.charAt(0)!=="#")hash="#"+hash;if(search&&search.charAt(0)!=="?")search="?"+search;return protocol+host+pathname+search+hash}function urlResolve(source,relative){return urlFormat(urlResolveObject(source,relative))}function urlResolveObject(source,relative){if(!source)return relative;source=urlParse(urlFormat(source),false,true);relative=urlParse(urlFormat(relative),false,true);source.hash=relative.hash;if(relative.href===""){source.href=urlFormat(source);return source}if(relative.slashes&&!relative.protocol){relative.protocol=source.protocol;if(slashedProtocol[relative.protocol]&&relative.hostname&&!relative.pathname){relative.path=relative.pathname="/"}relative.href=urlFormat(relative);return relative}if(relative.protocol&&relative.protocol!==source.protocol){if(!slashedProtocol[relative.protocol]){relative.href=urlFormat(relative);return relative}source.protocol=relative.protocol;if(!relative.host&&!hostlessProtocol[relative.protocol]){var relPath=(relative.pathname||"").split("/");while(relPath.length&&!(relative.host=relPath.shift()));if(!relative.host)relative.host="";if(!relative.hostname)relative.hostname="";if(relPath[0]!=="")relPath.unshift("");if(relPath.length<2)relPath.unshift("");relative.pathname=relPath.join("/")}source.pathname=relative.pathname;source.search=relative.search;source.query=relative.query;source.host=relative.host||"";source.auth=relative.auth;source.hostname=relative.hostname||relative.host;source.port=relative.port;if(source.pathname!==undefined||source.search!==undefined){source.path=(source.pathname?source.pathname:"")+(source.search?source.search:"")}source.slashes=source.slashes||relative.slashes;source.href=urlFormat(source);return source}var isSourceAbs=source.pathname&&source.pathname.charAt(0)==="/",isRelAbs=relative.host!==undefined||relative.pathname&&relative.pathname.charAt(0)==="/",mustEndAbs=isRelAbs||isSourceAbs||source.host&&relative.pathname,removeAllDots=mustEndAbs,srcPath=source.pathname&&source.pathname.split("/")||[],relPath=relative.pathname&&relative.pathname.split("/")||[],psychotic=source.protocol&&!slashedProtocol[source.protocol];if(psychotic){delete source.hostname;delete source.port;if(source.host){if(srcPath[0]==="")srcPath[0]=source.host;else srcPath.unshift(source.host)}delete source.host;if(relative.protocol){delete relative.hostname;delete relative.port;if(relative.host){if(relPath[0]==="")relPath[0]=relative.host;else relPath.unshift(relative.host)}delete relative.host}mustEndAbs=mustEndAbs&&(relPath[0]===""||srcPath[0]==="")}if(isRelAbs){source.host=relative.host||relative.host===""?relative.host:source.host;source.hostname=relative.hostname||relative.hostname===""?relative.hostname:source.hostname;source.search=relative.search;source.query=relative.query;srcPath=relPath}else if(relPath.length){if(!srcPath)srcPath=[];srcPath.pop();srcPath=srcPath.concat(relPath);source.search=relative.search;source.query=relative.query}else if("search"in relative){if(psychotic){source.hostname=source.host=srcPath.shift();var authInHost=source.host&&source.host.indexOf("@")>0?source.host.split("@"):false;if(authInHost){source.auth=authInHost.shift();source.host=source.hostname=authInHost.shift()}}source.search=relative.search;source.query=relative.query;if(source.pathname!==undefined||source.search!==undefined){source.path=(source.pathname?source.pathname:"")+(source.search?source.search:"")}source.href=urlFormat(source);return source}if(!srcPath.length){delete source.pathname;if(!source.search){source.path="/"+source.search}else{delete source.path}source.href=urlFormat(source);return source}var last=srcPath.slice(-1)[0];var hasTrailingSlash=(source.host||relative.host)&&(last==="."||last==="..")||last==="";var up=0;for(var i=srcPath.length;i>=0;i--){last=srcPath[i];if(last=="."){srcPath.splice(i,1)}else if(last===".."){srcPath.splice(i,1);up++}else if(up){srcPath.splice(i,1);up--}}if(!mustEndAbs&&!removeAllDots){for(;up--;up){srcPath.unshift("..")}}if(mustEndAbs&&srcPath[0]!==""&&(!srcPath[0]||srcPath[0].charAt(0)!=="/")){srcPath.unshift("")}if(hasTrailingSlash&&srcPath.join("/").substr(-1)!=="/"){srcPath.push("")}var isAbsolute=srcPath[0]===""||srcPath[0]&&srcPath[0].charAt(0)==="/";if(psychotic){source.hostname=source.host=isAbsolute?"":srcPath.length?srcPath.shift():"";var authInHost=source.host&&source.host.indexOf("@")>0?source.host.split("@"):false;if(authInHost){source.auth=authInHost.shift();source.host=source.hostname=authInHost.shift()}}mustEndAbs=mustEndAbs||source.host&&srcPath.length;if(mustEndAbs&&!isAbsolute){srcPath.unshift("")}source.pathname=srcPath.join("/");if(source.pathname!==undefined||source.search!==undefined){source.path=(source.pathname?source.pathname:"")+(source.search?source.search:"")}source.auth=relative.auth||source.auth;source.slashes=source.slashes||relative.slashes;source.href=urlFormat(source);return source}function parseHost(host){var out={};var port=portPattern.exec(host);if(port){port=port[0];if(port!==":"){out.port=port.substr(1)}host=host.substr(0,host.length-port.length)}if(host)out.hostname=host;return out}})()},{punycode:515,querystring:518}],528:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&typeof arg==="object"&&typeof arg.copy==="function"&&typeof arg.fill==="function"&&typeof arg.readUInt8==="function"}},{}],529:[function(require,module,exports){var process=require("__browserify_process"),global=typeof self!=="undefined"?self:typeof window!=="undefined"?window:{};var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments)}}if(process.noDeprecation===true){return fn}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg)}else if(process.traceDeprecation){console.trace(msg)}else{console.error(msg)}warned=true}return fn.apply(this,arguments)}return deprecated};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||"";set=set.toUpperCase();if(!debugs[set]){if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else{debugs[set]=function(){}}}return debugs[set]};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value)}if(isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0)){return formatError(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg!==null}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==="[object Error]"||e instanceof Error)}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;exports.isBuffer=require("./support/isBuffer");function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=require("inherits");exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}},{"./support/isBuffer":528,__browserify_process:510,inherits:508}],530:[function(require,module,exports){var indexOf=require("indexof");var Object_keys=function(obj){if(Object.keys)return Object.keys(obj);else{var res=[];for(var key in obj)res.push(key);return res}};var forEach=function(xs,fn){if(xs.forEach)return xs.forEach(fn);else for(var i=0;i<xs.length;i++){fn(xs[i],i,xs)}};var Script=exports.Script=function NodeScript(code){if(!(this instanceof Script))return new Script(code);this.code=code};Script.prototype.runInNewContext=function(context){if(!context)context={};var iframe=document.createElement("iframe");if(!iframe.style)iframe.style={};iframe.style.display="none";document.body.appendChild(iframe);var win=iframe.contentWindow;forEach(Object_keys(context),function(key){win[key]=context[key]});if(!win.eval&&win.execScript){win.execScript("null")}var winKeys=Object_keys(win);var res=win.eval(this.code);forEach(Object_keys(win),function(key){if(key in context||indexOf(winKeys,key)===-1){context[key]=win[key]}});document.body.removeChild(iframe);return res};Script.prototype.runInThisContext=function(){return eval(this.code)};Script.prototype.runInContext=function(context){return this.runInNewContext(context)};forEach(Object_keys(Script.prototype),function(name){exports[name]=Script[name]=function(code){var s=Script(code);return s[name].apply(s,[].slice.call(arguments,1))}});exports.createScript=function(code){return exports.Script(code)};exports.createContext=Script.createContext=function(context){var copy={};if(typeof context==="object"){forEach(Object_keys(context),function(key){copy[key]=context[key]})}return copy}},{indexof:531}],531:[function(require,module,exports){var indexOf=[].indexOf;module.exports=function(arr,obj){if(indexOf)return arr.indexOf(obj);for(var i=0;i<arr.length;++i){if(arr[i]===obj)return i}return-1}},{}]},{},[1]);